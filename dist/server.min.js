(()=>{"use strict";var e={375:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Union=t.Undefined=t.Tuple=t.StringLiteral=t.String=t.Reference=t.Record=t.Object=t.NumberLiteral=t.Number=t.Null=t.Intersection=t.BooleanLiteral=t.Boolean=t.Array=t.Any=void 0,t.Any={as:(e,t="")=>e,is(e){try{this.as(e)}catch(e){return!1}return!0}},t.Array={of:e=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Array){for(let n=0;n<t.length;n++)e.as(t[n],r+"["+n+"]");return t}throw"Expected an array at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Boolean={as(e,t=""){if(null!=e&&e.constructor===globalThis.Boolean)return e;throw"Expected a boolean at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.BooleanLiteral={of:e=>({as(t,r=""){if(t===e)return t;throw"Expected "+e+" at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Intersection={of:(...e)=>({as(t,r=""){for(let n of e)n.as(t,r);return t},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Null={as(e,t=""){if(null===e)return e;throw"Expected null at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.Number={as(e,t=""){if(null!=e&&e.constructor===globalThis.Number)return e;throw"Expected a number at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.NumberLiteral={of:e=>({as(t,r=""){if(t===e)return t;throw"Expected "+e+" at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Object={of:e=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Object){for(let n in e)e[n].as(t[n],r+/^([a-z][a-z0-9_]*)$/is.test(n)?"."+n:'["'+n+'"]');return t}throw"Expected an object at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Record={of:e=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Object){for(let n of globalThis.Object.keys(t))e.as(t[n],r+'["'+n+'"]');return t}throw"Expected a record at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Reference={of:e=>({as:(t,r="")=>e().as(t,r),is:t=>e().is(t)})},t.String={as(e,t=""){if(null!=e&&e.constructor===globalThis.String)return e;throw"Expected a string at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.StringLiteral={of:e=>({as(t,r=""){if(t===e)return t;throw'Expected "'+e+'" at '+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Tuple={of:(...e)=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Array){for(let n=0;n<e.length;n++)e[n].as(t[n],r+"["+n+"]");return t}throw"Expected a tuple at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Undefined={as(e,t=""){if(void 0===e)return e;throw"Expected undefined at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.Union={of:(...e)=>({as(t,r=""){for(let n of e)try{return n.as(t,r)}catch(e){}throw"Expected a union at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})}},175:(e,t,r)=>{t.m7=t.l8=void 0;const n=r(375);t.l8=n;r(226);const s=r(129);t.m7=s;r(329)},226:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Schema=t.UnionType=t.UndefinedType=t.TupleType=t.StringLiteralType=t.StringType=t.ReferenceType=t.RecordType=t.ObjectType=t.NumberLiteralType=t.NumberType=t.NullType=t.IntersectionType=t.GroupType=t.BooleanLiteralType=t.BooleanType=t.ArrayType=t.AnyType=t.Type=void 0;const n=r(329);t.Type={parse(e,...t){try{return S.parse(e,...t)}catch(e){}try{return d.parse(e,...t)}catch(e){}try{return i.parse(e,...t)}catch(e){}try{return s.parse(e)}catch(e){}try{return o.parse(e)}catch(e){}try{return a.parse(e)}catch(e){}try{return u.parse(e)}catch(e){}try{return c.parse(e)}catch(e){}try{return f.parse(e)}catch(e){}try{return g.parse(e)}catch(e){}try{return y.parse(e)}catch(e){}try{return b.parse(e)}catch(e){}try{return m.parse(e)}catch(e){}try{return v.parse(e)}catch(e){}try{return p.parse(e)}catch(e){}try{return l.parse(e)}catch(e){}try{return h.parse(e)}catch(e){}return e.newContext(((e,t)=>{let r=e();throw`Unexpected ${r.family} at row ${r.row}, col ${r.col}!`}))}};class s{constructor(){}generateType(e){return"any"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\treturn subject;"),t.push("}")):t.push("autoguard.Any"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"any"),s.INSTANCE)))}}t.AnyType=s,s.INSTANCE=new s;class i{constructor(e){this.type=e}generateType(e){return this.type.generateType(e)+"[]"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Array)) {"),t.push("\t\tfor (let i = 0; i < subject.length; i++) {"),t.push("\t\t\t("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t\t"}))+')(subject[i], path + "[" + i + "]");'),t.push("\t\t}"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected an array at " + path + "!";'),t.push("}")):t.push("autoguard.Array.of("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}getImports(){return this.type.getImports()}static parse(e,...r){if(r.includes("Array"))throw"Recursion prevention!";return e.newContext(((s,o)=>{let a=t.Type.parse(e,...r,"Array");n.expect(s(),"["),n.expect(s(),"]");let l=new i(a);for(;;)try{e.newContext(((e,t)=>{n.expect(e(),"["),n.expect(e(),"]"),l=new i(l)}))}catch(e){break}return l}))}}t.ArrayType=i;class o{constructor(){}generateType(e){return"boolean"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Boolean)) {"),t.push("\t\treturn subject as boolean;"),t.push("\t}"),t.push('\tthrow "Expected a boolean at " + path + "!";'),t.push("}")):t.push("autoguard.Boolean"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"boolean"),o.INSTANCE)))}}t.BooleanType=o,o.INSTANCE=new o;class a{constructor(e){this.value=e}generateType(e){return""+this.value}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+") {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected '+this.value+' at " + path + "!";'),t.push("}")):t.push("autoguard.BooleanLiteral.of("+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>"true"===n.expect(e(),["true","false"]).family?a.INSTANCE_TRUE:a.INSTANCE_FALSE))}}t.BooleanLiteralType=a,a.INSTANCE_TRUE=new a(!0),a.INSTANCE_FALSE=new a(!1);class l{constructor(e){this.type=e}generateType(e){return"("+this.type.generateType(e)+")"}generateTypeGuard(e){return this.type.generateTypeGuard(e)}getImports(){return this.type.getImports()}static parse(e){return e.newContext(((r,s)=>{n.expect(r(),"(");let i=t.Type.parse(e);return n.expect(r(),")"),new l(i)}))}}t.GroupType=l;class d{constructor(){this.types=new Set}add(e){return this.types.add(e),this}generateType(e){let t=new Array;for(let r of this.types)t.push(r.generateType(e));return t.join(" & ")}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {");for(let r of this.types)t.push("\t("+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+")(subject, path);");return t.push("\treturn subject;"),t.push("}"),t.join(e.eol)}for(let r of this.types)t.push("\t"+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"autoguard.Intersection.of("+e.eol+t.join(","+e.eol)+e.eol+")"}getImports(){let e=new Array;for(let t of this.types)e.push(...t.getImports());return e}static parse(e,...r){if(r.includes("Intersection"))throw"Recursion prevention!";return e.newContext(((s,i)=>{var o;let a=t.Type.parse(e,...r,"Intersection"),l=new d;for(l.add(a);"&"===(null===(o=i())||void 0===o?void 0:o.value);){n.expect(s(),"&");let i=t.Type.parse(e,...r,"Intersection");l.add(i)}return 1===l.types.size?a:l}))}}t.IntersectionType=d;class u{constructor(){}generateType(e){return"null"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === null) {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected null at " + path + "!";'),t.push("}")):t.push("autoguard.Null"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"null"),u.INSTANCE)))}}t.NullType=u,u.INSTANCE=new u;class c{constructor(){}generateType(e){return"number"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Number)) {"),t.push("\t\treturn subject as number;"),t.push("\t}"),t.push('\tthrow "Expected a number at " + path + "!";'),t.push("}")):t.push("autoguard.Number"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"number"),c.INSTANCE)))}}t.NumberType=c,c.INSTANCE=new c;class f{constructor(e){this.value=e}generateType(e){return""+this.value}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+") {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected '+this.value+' at " + path + "!";'),t.push("}")):t.push("autoguard.NumberLiteral.of("+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>{let r=n.expect(e(),"NUMBER_LITERAL").value;return new f(Number.parseInt(r))}))}}t.NumberLiteralType=f;class p{constructor(){this.members=new Map}add(e,t){return this.members.set(e,t),this}generateType(e){if(0===this.members.size)return"{}";let t=new Array;for(let[r,n]of this.members)t.push('\t"'+r+'"'+(n.optional?"?":"")+": "+n.type.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"{"+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+"}"}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Object)) {");for(let[r,n]of this.members){let s=n.type;if(n.optional){let e=new S;e.add(b.INSTANCE),e.add(s),s=e}let i=/^([a-z][a-z0-9_]*)$/is.test(r)?'".'+r+'"':'"[\\"'+r+'\\"]"';t.push("\t\t("+s.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+')(subject["'+r+'"], path + '+i+");")}return t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected an object at " + path + "!";'),t.push("}"),t.join(e.eol)}for(let[r,n]of this.members){let s=n.type;if(n.optional){let e=new S;e.add(b.INSTANCE),e.add(s),s=e}t.push('\t"'+r+'": '+s.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})))}return"autoguard.Object.of<"+(null!=this.typename?this.typename:this.generateType(e))+">({"+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+"})"}getImports(){let e=new Array;for(let[t,r]of this.members){let t=r.type;e.push(...t.getImports())}return e}setTypename(e){this.typename=e}static parse(e){return e.newContext(((r,s)=>{var i,o,a;n.expect(r(),"{");let l=new p;if("}"!==(null===(i=s())||void 0===i?void 0:i.value))for(;;){let i=!1,d=n.expect(r(),["any","boolean","false","null","number","string","true","undefined","IDENTIFIER","STRING_LITERAL"]),u="STRING_LITERAL"===d.family?d.value.slice(1,-1):d.value;"?"===(null===(o=s())||void 0===o?void 0:o.value)&&(r(),i=!0),n.expect(r(),":");let c=t.Type.parse(e);if(l.add(u,{type:c,optional:i}),","!==(null===(a=s())||void 0===a?void 0:a.value))break;n.expect(r(),",")}return n.expect(r(),"}"),l}))}}t.ObjectType=p;class h{constructor(e){this.type=e}generateType(e){return"Record<string, undefined | "+this.type.generateType(e)+">"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Object)) {"),t.push("\t\tfor (let key of globalThis.Object.keys(subject)) {"),t.push("\t\t\t("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t\t"}))+')(subject[key], path + "[\\"" + key + "\\"]");'),t.push("\t\t}"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected a record at " + path + "!";'),t.push("}")):t.push("autoguard.Record.of("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}getImports(){return this.type.getImports()}static parse(e){return e.newContext(((r,s)=>{n.expect(r(),"{");let i=t.Type.parse(e);return n.expect(r(),"}"),new h(i)}))}}t.RecordType=h;class m{constructor(e,t){this.path=e,this.typename=t}generateType(e){return this.typename}generateTypeGuard(e){return e.standalone?this.typename+".as":"autoguard.Reference.of<"+this.typename+">(() => "+this.typename+")"}getImports(){return this.path.length>0?[{path:this.path,typename:this.typename}]:[]}static parse(e){return e.newContext(((e,t)=>{var r,s;"@"===(null===(r=t())||void 0===r?void 0:r.family)&&n.expect(e(),"@");let i=new Array;for(;;){let r=e();if(n.expect(r,[".","..","IDENTIFIER"]),i.push(r),"/"!==(null===(s=t())||void 0===s?void 0:s.family))break;n.expect(e(),"/")}let o=i.pop();return n.expect(o,"IDENTIFIER"),new m(i.map((e=>e.value)),o.value)}))}}t.ReferenceType=m;class g{constructor(){}generateType(e){return"string"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.String)) {"),t.push("\t\treturn subject as string;"),t.push("\t}"),t.push('\tthrow "Expected a string at " + path + "!";'),t.push("}")):t.push("autoguard.String"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"string"),g.INSTANCE)))}}t.StringType=g,g.INSTANCE=new g;class y{constructor(e){this.value=e}generateType(e){return'"'+this.value+'"'}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+") {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected \\"'+this.value+'\\" at " + path + "!";'),t.push("}")):t.push('autoguard.StringLiteral.of("'+this.value+'")'),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>{let r=n.expect(e(),"STRING_LITERAL").value;return new y(r.slice(1,-1))}))}}t.StringLiteralType=y;class v{constructor(){this.types=new Array}add(e){return this.types.push(e),this}generateType(e){let t=new Array;for(let r of this.types)t.push("\t"+r.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"["+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+"]"}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Array)) {");for(let r=0;r<this.types.length;r++){let n=this.types[r];t.push("\t\t("+n.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+")(subject["+r+'], path + "['+r+']");')}return t.push("\t\treturn subject as "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+";"),t.push("\t}"),t.push('\tthrow "Expected a tuple at " + path + "!";'),t.push("}"),t.join(e.eol)}for(let r of this.types)t.push("\t"+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"autoguard.Tuple.of("+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+")"}getImports(){let e=new Array;for(let t of this.types)e.push(...t.getImports());return e}static parse(e){return e.newContext(((r,s)=>{var i,o;n.expect(r(),"[");let a=new v;if("]"!==(null===(i=s())||void 0===i?void 0:i.value))for(;;){let i=t.Type.parse(e);if(a.add(i),","!==(null===(o=s())||void 0===o?void 0:o.value))break;n.expect(r(),",")}return n.expect(r(),"]"),a}))}}t.TupleType=v;class b{constructor(){}generateType(e){return"undefined"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === undefined) {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected undefined at " + path + "!";'),t.push("}")):t.push("autoguard.Undefined"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"undefined"),b.INSTANCE)))}}t.UndefinedType=b,b.INSTANCE=new b;class S{constructor(){this.types=new Set}add(e){return this.types.add(e),this}generateType(e){let t=new Array;for(let r of this.types)t.push(r.generateType(e));return t.join(" | ")}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {");for(let r of this.types)t.push("\ttry {"),t.push("\t\treturn ("+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+")(subject, path);"),t.push("\t} catch (error) {}");return t.push('\tthrow "Expected a union at " + path + "!";'),t.push("}"),t.join(e.eol)}for(let r of this.types)t.push("\t"+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"autoguard.Union.of("+e.eol+t.join(","+e.eol)+e.eol+")"}getImports(){let e=new Array;for(let t of this.types)e.push(...t.getImports());return e}static parse(e,...r){if(r.includes("Union"))throw"Recursion prevention!";return e.newContext(((s,i)=>{var o;let a=t.Type.parse(e,...r,"Union"),l=new S;for(l.add(a);"|"===(null===(o=i())||void 0===o?void 0:o.value);){n.expect(s(),"|");let i=t.Type.parse(e,...r,"Union");l.add(i)}return 1===l.types.size?a:l}))}}t.UnionType=S;class _{constructor(){this.types=new Map}getImports(){let e=new Map;for(let[t,r]of this.types){let t=r.getImports();for(let r of t)e.set(r.typename,r.path)}return Array.from(e.entries()).sort(((e,t)=>e[0].localeCompare(t[0]))).map((e=>({path:e[1],typename:e[0]})))}add(e,t){return this.types.set(e,t),this}generateModule(e){let t=new Array;t.push("// This file was auto-generated by @joelek/ts-autoguard. Edit at own risk."),t.push("");let r=this.getImports();for(let e of r)t.push("import { "+e.typename+' } from "'+e.path.join("/")+'";');e.standalone||t.push('import { guards as autoguard } from "@joelek/ts-autoguard";'),t.push("");for(let[r,n]of this.types)t.push("export type "+r+" = "+n.generateType(e)+";"),t.push(""),e.standalone?(t.push("export const "+r+" = {"),t.push('\tas(subject: any, path: string = ""): '+r+" {"),t.push("\t\treturn ("+n.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+")(subject, path);"),t.push("\t},"),t.push("\tis(subject: any): subject is "+r+" {"),t.push("\t\ttry {"),t.push("\t\t\tthis.as(subject);"),t.push("\t\t} catch (error) {"),t.push("\t\t\treturn false;"),t.push("\t\t}"),t.push("\t\treturn true;"),t.push("\t}"),t.push("};"),t.push("")):(t.push("export const "+r+" = "+n.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol}))+";"),t.push(""));let n=new p;for(let[e,t]of this.types)n.add(e,{type:new m([],e),optional:!1});return t.push("export type Autoguard = "+n.generateType(e)+";"),t.push(""),t.push("export const Autoguard = "+n.generateType(e)+";"),t.push(""),t.join(e.eol)}static parse(e){return e.newContext(((r,s)=>{var i,o,a;n.expect(r(),"{");let l=new _;if("}"!==(null===(i=s())||void 0===i?void 0:i.value))for(;;){let i=n.expect(r(),"IDENTIFIER").value;n.expect(r(),":");let d=t.Type.parse(e);if(null===(o=d.setTypename)||void 0===o||o.call(d,i),l.add(i,d),","!==(null===(a=s())||void 0===a?void 0:a.value))break;n.expect(r(),",")}if(n.expect(r(),"}"),null!=s())throw"Expected end of stream!";return l}))}}t.Schema=_},129:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MessageSerializer=void 0,t.MessageSerializer=class{constructor(e){this.guards=e}deserialize(e,t){let r=JSON.parse(e);if(null==r||r.constructor!==Object||null==r.type||r.type.constructor!==String)throw"Invalid message envelope!";{let e=r.type,n=r.data,s=this.guards[e];if(void 0===s)throw'Unknown message type "'+e+'"!';t(e,s.as(n))}}serialize(e,t){return JSON.stringify({type:e,data:t})}}},329:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.expect=t.Tokenizer=t.Families=void 0,t.Families=["WS","(",")","[","]","{","}","?","|",".","..","/","&","@",",",":","any","boolean","false","null","number","string","true","undefined","IDENTIFIER","NUMBER_LITERAL","STRING_LITERAL"],t.Tokenizer=class{constructor(e){let t={WS:/^([\t\r\n ]+)/ius,"(":/^([\(])/ius,")":/^([\)])/ius,"[":/^([\[])/ius,"]":/^([\]])/ius,"{":/^([\{])/ius,"}":/^([\}])/ius,"?":/^([\?])/ius,"|":/^([\|])/ius,".":/^([\.])/ius,"..":/^([\.][\.])/ius,"/":/^([\/])/ius,"&":/^([&])/ius,"@":/^([@])/ius,",":/^([,])/ius,":":/^([:])/ius,any:/^(any)/ius,boolean:/^(boolean)/ius,false:/^(false)/ius,null:/^(null)/ius,number:/^(number)/ius,string:/^(string)/ius,true:/^(true)/ius,undefined:/^(undefined)/ius,IDENTIFIER:/^([a-z][a-z0-9_]*)/ius,NUMBER_LITERAL:/^(([1-9][0-9]+)|([0-9]))/ius,STRING_LITERAL:/^(["][^"]*["])/ius},r=new Array,n=1,s=1;for(;e.length>0;){let i;for(let r in t){let n=r,s=t[n].exec(e);null!=s&&(null==i||s[1].length>i[1].length)&&(i=[n,s[1]])}if(null==i)throw`Unrecognized token at row ${n}, col ${s}!`;r.push({family:i[0],value:i[1],row:n,col:s}),e=e.slice(i[1].length);let o=i[1].split(/\r?\n/);o.length>1&&(n+=o.length-1,s=1),s+=o[o.length-1].length}this.tokens=r.filter((e=>"WS"!==e.family)),this.offset=0}peek(){return this.tokens[this.offset]}read(){if(this.offset>=this.tokens.length)throw"Unexpectedly reached end of stream!";return this.tokens[this.offset++]}newContext(e){let t=this.offset;try{return e((()=>this.read()),(()=>this.peek()))}catch(e){throw this.offset=t,e}}},t.expect=function(e,t){if(!(Array.isArray(t)?t:[t]).includes(e.family))throw`Unexpected ${e.family} at row ${e.row}, col ${e.col}!`;return e}},745:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketClient=void 0;const n=r(417),s=r(605),i=r(211),o=r(835),a=r(978),l=r(410),d=r(93),u=r(611),c=r(302);t.WebSocketClient=class{constructor(e){var t;this.state=u.ReadyState.CONNECTING,this.listeners=new a.routing.MessageRouter,this.pending=new Array,this.socket=void 0;let r=n.randomBytes(16).toString("base64"),d={Connection:"upgrade",Host:null!==(t=o.parse(e).host)&&void 0!==t?t:"","Sec-WebSocket-Key":r,"Sec-WebSocket-Version":"13",Upgrade:"websocket"};(()=>{if(e.startsWith("wss:"))return function(e,t){return new Promise(((r,n)=>{i.get(e,t).on("upgrade",((e,t,n)=>{r({response:e,socket:t,buffer:n})})).on("error",n)}))}("https:"+e.substring(4),{headers:d,rejectUnauthorized:!1});if(e.startsWith("ws:"))return function(e,t){return new Promise(((r,n)=>{s.get(e,t).on("upgrade",((e,t,n)=>{r({response:e,socket:t,buffer:n})})).on("error",n)}))}("http:"+e.substring(3),{headers:d});throw`Expected ${e} to be a WebSocket URL!`})().then((e=>{var t,s;let i=e.response,o=e.socket,a=e.buffer;if(o.on("close",(()=>{this.state=u.ReadyState.CLOSED,this.listeners.route("close",void 0)})),o.on("error",(()=>{this.state=u.ReadyState.CLOSING,this.listeners.route("error",void 0),o.end()})),101!==i.statusCode)return o.emit("error");if("upgrade"!==(null===(t=c.getHeader(i,"Connection"))||void 0===t?void 0:t.toLowerCase()))return o.emit("error");if("websocket"!==(null===(s=c.getHeader(i,"Upgrade"))||void 0===s?void 0:s.toLowerCase()))return o.emit("error");let d=n.createHash("sha1").update(r+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11").digest("base64");if(c.getHeader(i,"Sec-WebSocket-Accept")!==d)return o.emit("error");this.socket=o;let f=()=>{for(;;)try{let e={buffer:a,offset:0},t=l.decodeFrame(e);this.onFrame(o,t),a=a.slice(e.offset)}catch(e){break}};this.socket.on("data",(e=>{a=Buffer.concat([a,e]),f()})),this.state=u.ReadyState.OPEN,this.listeners.route("open",void 0),f()}))}onFrame(e,t){if(0!==t.reserved1||0!==t.reserved2||0!==t.reserved3)return this.close(u.StatusCode.PROTOCOL_ERROR);if(t.opcode<8){if(t.opcode!==l.WebSocketFrameType.CONTINUATION&&t.opcode!==l.WebSocketFrameType.TEXT&&t.opcode!=l.WebSocketFrameType.BINARY)return this.close(u.StatusCode.PROTOCOL_ERROR);if(0===this.pending.length){if(t.opcode===l.WebSocketFrameType.CONTINUATION)return this.close(u.StatusCode.PROTOCOL_ERROR)}else if(t.opcode!==l.WebSocketFrameType.CONTINUATION)return this.close(u.StatusCode.PROTOCOL_ERROR);if(this.pending.push(t.payload),1===t.final){let e=Buffer.concat(this.pending);this.pending.splice(0),this.listeners.route("message",{data:e.toString()})}}else{if(1!==t.final)return this.close(u.StatusCode.PROTOCOL_ERROR);if(t.payload.length>125)return this.close(u.StatusCode.PROTOCOL_ERROR);if(t.opcode===l.WebSocketFrameType.CLOSE){if(this.readyState===u.ReadyState.CLOSING)return e.end();e.write(l.encodeFrame(Object.assign(Object.assign({},t),{masked:1})),(()=>e.end()))}else if(t.opcode===l.WebSocketFrameType.PING)e.write(l.encodeFrame(Object.assign(Object.assign({},t),{opcode:10,masked:1})));else if(t.opcode!==l.WebSocketFrameType.PONG)return this.close(u.StatusCode.PROTOCOL_ERROR)}}addEventListener(e,t){this.listeners.addObserver(e,t)}close(e){if(this.state!==u.ReadyState.OPEN)throw"Expected socket to be open!";const t=this.socket;if(d.absent(t))throw"Expected socket to be open!";let r=Buffer.alloc(0);d.present(e)&&(r=Buffer.concat([Buffer.alloc(2),Buffer.from("Connection closed by client.")]),r.writeUInt16BE(e,0));let n=l.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:l.WebSocketFrameType.CLOSE,masked:1,payload:r});t.write(n),this.state=u.ReadyState.CLOSING}removeEventListener(e,t){this.listeners.removeObserver(e,t)}send(e){if(this.state!==u.ReadyState.OPEN)throw"Expected socket to be open!";let t=this.socket;if(d.absent(t))throw"Expected socket to be open!";let r=l.WebSocketFrameType.BINARY;e instanceof Buffer||(e=Buffer.from(e,"utf8"),r=l.WebSocketFrameType.TEXT);let n=l.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:r,masked:1,payload:e});t.write(n)}get readyState(){return this.state}}},410:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.encodeFrame=t.decodeFrame=t.WebSocketFrameType=void 0;const n=r(417);var s;(s=t.WebSocketFrameType||(t.WebSocketFrameType={}))[s.CONTINUATION=0]="CONTINUATION",s[s.TEXT=1]="TEXT",s[s.BINARY=2]="BINARY",s[s.UNUSED_3=3]="UNUSED_3",s[s.UNUSED_4=4]="UNUSED_4",s[s.UNUSED_5=5]="UNUSED_5",s[s.UNUSED_6=6]="UNUSED_6",s[s.UNUSED_7=7]="UNUSED_7",s[s.CLOSE=8]="CLOSE",s[s.PING=9]="PING",s[s.PONG=10]="PONG",s[s.UNUSED_B=11]="UNUSED_B",s[s.UNUSED_C=12]="UNUSED_C",s[s.UNUSED_D=13]="UNUSED_D",s[s.UNUSED_E=14]="UNUSED_E",s[s.UNUSED_F=15]="UNUSED_F",t.decodeFrame=function(e){let t=e.buffer.readUInt8(e.offset)>>7&1,r=e.buffer.readUInt8(e.offset)>>6&1,n=e.buffer.readUInt8(e.offset)>>5&1,s=e.buffer.readUInt8(e.offset)>>4&1,i=e.buffer.readUInt8(e.offset)>>0&15;e.offset+=1;let o=e.buffer.readUInt8(e.offset)>>7&1,a=e.buffer.readUInt8(e.offset)>>0&127;if(e.offset+=1,126===a){if(a=e.buffer.readUInt16BE(e.offset),e.offset+=2,a<=125)throw"Invalid frame encoding!"}else if(127===a){if(0!==e.buffer.readUInt32BE(e.offset))throw"Invalid frame encoding!";if(e.offset+=4,a=e.buffer.readUInt32BE(e.offset),e.offset+=4,a<=65535)throw"Invalid frame encoding!"}let l=Buffer.alloc(4);if(1===o&&(l=e.buffer.slice(e.offset,e.offset+4),e.offset+=4),e.offset+a>e.buffer.length)throw"Invalid frame encoding!";let d=e.buffer.slice(e.offset,e.offset+a);if(e.offset+=a,1===o)for(let e=0;e<d.length;e++)d[e]=d[e]^l[3&e];return{final:t,reserved1:r,reserved2:n,reserved3:s,opcode:i,masked:o,payload:d}},t.encodeFrame=function(e){let t=new Array,r=e.payload.length,s=Buffer.alloc(2);t.push(s);let i=0;if(i|=(1&e.final)<<7,i|=(1&e.reserved1)<<6,i|=(1&e.reserved2)<<5,i|=(1&e.reserved3)<<4,i|=(15&e.opcode)<<0,s.writeUInt8(i,0),r<=125){let t=0;t|=(1&e.masked)<<7,t|=(127&r)<<0,s.writeUInt8(t,1)}else if(r<=65535){let n=0;n|=(1&e.masked)<<7,n|=126,s.writeUInt8(n,1);let i=Buffer.alloc(2);i.writeUInt16BE(r,0),t.push(i)}else{if(!(r<=4294967295))throw"Invalid frame size!";{let n=0;n|=(1&e.masked)<<7,n|=127,s.writeUInt8(n,1);let i=Buffer.alloc(8);i.writeUInt32BE(r,4),t.push(i)}}if(1===e.masked){let r=n.randomBytes(4),s=Buffer.concat([e.payload]);for(let e=0;e<s.length;e++)s[e]=s[e]^r[3&e];t.push(r,s)}else t.push(e.payload);return Buffer.concat(t)}},545:(e,t,r)=>{r(745),r(410),r(447),r(611);var n=r(745);Object.defineProperty(t,"yU",{enumerable:!0,get:function(){return n.WebSocketClient}});var s=r(447);Object.defineProperty(t,"u9",{enumerable:!0,get:function(){return s.WebSocketServer}})},93:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.present=t.absent=void 0,t.absent=function(e){return null==e},t.present=function(e){return null!=e}},447:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketServer=void 0;const n=r(417),s=r(16),i=r(978),o=r(410),a=r(93),l=r(611),d=r(302);t.WebSocketServer=class{constructor(){this.pending_chunks=new Map,this.states=new Map,this.connections=new d.BiMap,this.router=new i.routing.MessageRouter}onFrame(e,t,r,n){if(0!==n.reserved1||0!==n.reserved2||0!==n.reserved3)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(1!==n.masked)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(n.opcode<8){if(n.opcode!==o.WebSocketFrameType.CONTINUATION&&n.opcode!==o.WebSocketFrameType.TEXT&&n.opcode!=o.WebSocketFrameType.BINARY)return this.close(e,l.StatusCode.PROTOCOL_ERROR);{let r=this.pending_chunks.get(e);if(a.absent(r))r=new Array,this.pending_chunks.set(e,r);else if(n.opcode!==o.WebSocketFrameType.CONTINUATION)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(r.push(n.payload),1===n.final){let n=Buffer.concat(r);this.pending_chunks.delete(e),this.router.route("message",{connection_id:e,connection_url:t,buffer:n})}}}else{if(1!==n.final)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(n.payload.length>125)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(n.opcode===o.WebSocketFrameType.CLOSE){if(this.states.get(e)===l.ReadyState.CLOSING)return r.end();r.write(o.encodeFrame(Object.assign(Object.assign({},n),{masked:0})),(()=>r.end()))}else if(n.opcode===o.WebSocketFrameType.PING)r.write(o.encodeFrame(Object.assign(Object.assign({},n),{opcode:10,masked:0})));else if(n.opcode!==o.WebSocketFrameType.PONG)return this.close(e,l.StatusCode.PROTOCOL_ERROR)}}broadcast(e){for(let[t,r]of this.connections)this.states.get(t)===l.ReadyState.OPEN&&this.send(t,e)}addEventListener(e,t){return this.router.addObserver(e,t)}close(e,t){if(this.states.get(e)!==l.ReadyState.OPEN)throw"Expected socket to be open!";const r=this.connections.value(e);if(a.absent(r))throw'Connection with id "'+e+'" has no socket!';let n=Buffer.alloc(0);a.present(t)&&(n=Buffer.concat([Buffer.alloc(2),Buffer.from("Connection closed by server.")]),n.writeUInt16BE(t,0));let s=o.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:o.WebSocketFrameType.CLOSE,masked:0,payload:n});r.write(s),this.states.set(e,l.ReadyState.CLOSING)}getRequestHandler(){return(e,t)=>{let r=e.socket,i=this.connections.key(r);if(a.present(i))return t.writeHead(400),t.end();let u=e.httpVersionMajor,c=e.httpVersionMinor;if(u<1||1===u&&c<1)return t.writeHead(400),t.end();if("GET"!==e.method)return t.writeHead(400),t.end();let f=d.getHeader(e,"Host");if(a.absent(f))return t.writeHead(400),t.end();let p=d.getHeader(e,"Upgrade");if(a.absent(p)||"websocket"!==p.toLowerCase())return t.writeHead(400),t.end();let h=d.getHeader(e,"Connection");if(a.absent(h)||"upgrade"!==h.toLowerCase())return t.writeHead(400),t.end();let m=d.getHeader(e,"Sec-WebSocket-Key");if(a.absent(m)||16!==Buffer.from(m,"base64").length)return t.writeHead(400),t.end();if("13"!==d.getHeader(e,"Sec-WebSocket-Version"))return t.writeHead(426,{"Sec-WebSocket-Version":"13"}),t.end();let g=n.createHash("sha1").update(m+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11").digest("base64");return t.writeHead(101,{Upgrade:"websocket",Connection:"Upgrade","Sec-WebSocket-Accept":g}),t.end((()=>{let t=n.randomBytes(16).toString("hex"),i=function(e){let t=e.headers.host||"",r=e.url||"/";return`${e.socket instanceof s.TLSSocket?"wss:":"ws:"}//${t}${r}`}(e),a=Buffer.alloc(0);r.on("data",(e=>{for(a=Buffer.concat([a,e]);;)try{let e={buffer:a,offset:0},n=o.decodeFrame(e);this.onFrame(t,i,r,n),a=a.slice(e.offset)}catch(e){break}})),r.on("close",(()=>{this.connections.remove(t),this.states.delete(t),this.router.route("disconnect",{connection_id:t,connection_url:i})})),r.setTimeout(0),this.connections.add(t,r),this.states.set(t,l.ReadyState.OPEN),this.router.route("connect",{connection_id:t,connection_url:i})}))}}removeEventListener(e,t){return this.router.removeObserver(e,t)}send(e,t){if(this.states.get(e)!==l.ReadyState.OPEN)throw"Expected socket to be open!";let r=this.connections.value(e);if(a.absent(r))throw'Connection with id "'+e+'" has no socket!';let n=o.WebSocketFrameType.BINARY;t instanceof Buffer||(t=Buffer.from(t,"utf8"),n=o.WebSocketFrameType.TEXT);let s=o.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:n,masked:0,payload:t});r.write(s)}}},611:(e,t)=>{var r,n;Object.defineProperty(t,"__esModule",{value:!0}),t.StatusCode=t.ReadyState=void 0,(n=t.ReadyState||(t.ReadyState={}))[n.CONNECTING=0]="CONNECTING",n[n.OPEN=1]="OPEN",n[n.CLOSING=2]="CLOSING",n[n.CLOSED=3]="CLOSED",(r=t.StatusCode||(t.StatusCode={}))[r.NORMAL=1e3]="NORMAL",r[r.GOING_AWAY=1001]="GOING_AWAY",r[r.PROTOCOL_ERROR=1002]="PROTOCOL_ERROR",r[r.DATA_TYPE_NOT_ACCEPTED=1003]="DATA_TYPE_NOT_ACCEPTED",r[r.RESERVED_1004=1004]="RESERVED_1004",r[r.RESERVED_1005=1005]="RESERVED_1005",r[r.RESERVED_1006=1006]="RESERVED_1006",r[r.BAD_DATA_TYPE=1007]="BAD_DATA_TYPE",r[r.POLICY_VIOLATION=1008]="POLICY_VIOLATION",r[r.MESSAGE_TOO_BIG=1009]="MESSAGE_TOO_BIG",r[r.CLIENT_EXPECTED_EXTENSION=1010]="CLIENT_EXPECTED_EXTENSION",r[r.SERVER_UNEXPECTED_CONDITION=1011]="SERVER_UNEXPECTED_CONDITION",r[r.RESERVED_1015=1015]="RESERVED_1015"},302:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BiMap=t.getHeader=void 0;const n=r(93);t.getHeader=function(e,t){let r=e.headers[t.toLowerCase()];if(n.present(r)){if(r.constructor===String)return r;if(r.constructor===Array&&1===r.length)return r[0]}return null};class s{constructor(){this.value_to_key=new Map,this.key_to_value=new Map}[Symbol.iterator](){return this.key_to_value[Symbol.iterator]()}add(e,t){this.value_to_key.set(t,e),this.key_to_value.set(e,t)}key(e){return this.value_to_key.get(e)||null}remove(e){let t=this.key_to_value.get(e);n.present(t)&&this.value_to_key.delete(t),this.key_to_value.delete(e)}value(e){return this.key_to_value.get(e)||null}}t.BiMap=s},978:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.routing=r(220)},220:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.NamespacedMessageRouter=t.MessageRouter=void 0;class r{constructor(){this.observers=new Map}addObserver(e,t){let r=this.observers.get(e);void 0===r&&(r=new Set,this.observers.set(e,r)),r.add(t)}removeObserver(e,t){let r=this.observers.get(e);void 0!==r&&r.delete(t)}route(e,t){let r=this.observers.get(e);if(void 0!==r)for(let e of r)e(t)}}t.MessageRouter=r,t.NamespacedMessageRouter=class{constructor(){this.routers=new Map}addObserver(e,t,n){let s=this.routers.get(e);void 0===s&&(s=new r,this.routers.set(e,s)),s.addObserver(t,n)}removeObserver(e,t,r){let n=this.routers.get(e);void 0!==n&&n.removeObserver(t,r)}route(e,t,r){let n=this.routers.get(e);void 0!==n&&n.route(t,r)}}},417:e=>{e.exports=require("crypto")},605:e=>{e.exports=require("http")},211:e=>{e.exports=require("https")},16:e=>{e.exports=require("tls")},835:e=>{e.exports=require("url")}},t={};function r(n){if(t[n])return t[n].exports;var s=t[n]={exports:{}};return e[n](s,s.exports,r),s.exports}(()=>{const e=require("fs");var t=r(605),n=r(211);const s=require("path");var i=r(835),o=r(417),a=r(175);const l=a.l8.Object.of({person_id:a.l8.String,name:a.l8.String}),d=a.l8.Object.of({movie_id:a.l8.String,person_id:a.l8.String}),u=a.l8.Object.of({show_id:a.l8.String,person_id:a.l8.String}),c=a.l8.Object.of({artist_id:a.l8.String,title:a.l8.String}),f=a.l8.Object.of({album_id:a.l8.String,title:a.l8.String,year:a.l8.Number,cover_file_id:a.l8.Union.of(a.l8.String,a.l8.Null)}),p=a.l8.Object.of({disc_id:a.l8.String,album_id:a.l8.String,number:a.l8.Number}),h=a.l8.Object.of({track_id:a.l8.String,disc_id:a.l8.String,file_id:a.l8.String,title:a.l8.String,number:a.l8.Number,duration:a.l8.Number}),m=a.l8.Object.of({album_id:a.l8.String,artist_id:a.l8.String}),g=a.l8.Object.of({track_id:a.l8.String,artist_id:a.l8.String}),y=a.l8.Object.of({video_genre_id:a.l8.String,title:a.l8.String}),v=a.l8.Object.of({movie_id:a.l8.String,title:a.l8.String,year:a.l8.Number,summary:a.l8.Union.of(a.l8.String,a.l8.Null),poster_file_id:a.l8.Union.of(a.l8.String,a.l8.Null)}),b=a.l8.Object.of({movie_id:a.l8.String,video_genre_id:a.l8.String}),S=a.l8.Object.of({movie_part_id:a.l8.String,movie_id:a.l8.String,file_id:a.l8.String,duration:a.l8.Number,number:a.l8.Number}),_=a.l8.Object.of({show_id:a.l8.String,title:a.l8.String,summary:a.l8.Union.of(a.l8.Undefined,a.l8.String),poster_file_id:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),w=a.l8.Object.of({show_id:a.l8.String,video_genre_id:a.l8.String}),O=a.l8.Object.of({season_id:a.l8.String,show_id:a.l8.String,number:a.l8.Number}),E=a.l8.Object.of({episode_id:a.l8.String,season_id:a.l8.String,file_id:a.l8.String,title:a.l8.String,number:a.l8.Number,duration:a.l8.Number,year:a.l8.Union.of(a.l8.Number,a.l8.Null),summary:a.l8.Union.of(a.l8.String,a.l8.Null)}),R=a.l8.Object.of({subtitle_id:a.l8.String,file_id:a.l8.String,video_file_id:a.l8.String,language:a.l8.Union.of(a.l8.String,a.l8.Null)}),k=a.l8.Object.of({subtitle_id:a.l8.String,cues:a.l8.Array.of(a.l8.Tuple.of(a.l8.Number,a.l8.Number,a.l8.String))}),T=a.l8.Object.of({cue_id:a.l8.String,subtitle_id:a.l8.String,start_ms:a.l8.Number,duration_ms:a.l8.Number,lines:a.l8.Array.of(a.l8.String)}),I=a.l8.Object.of({file_id:a.l8.String,path:a.l8.Array.of(a.l8.String),mime:a.l8.String}),N=a.l8.Object.of({audio:a.l8.Object.of({artists:a.l8.Array.of(a.l8.Reference.of((()=>c))),albums:a.l8.Array.of(a.l8.Reference.of((()=>f))),discs:a.l8.Array.of(a.l8.Reference.of((()=>p))),tracks:a.l8.Array.of(a.l8.Reference.of((()=>h))),album_artists:a.l8.Array.of(a.l8.Reference.of((()=>m))),track_artists:a.l8.Array.of(a.l8.Reference.of((()=>g)))}),video:a.l8.Object.of({genres:a.l8.Array.of(a.l8.Reference.of((()=>y))),movie_parts:a.l8.Array.of(a.l8.Reference.of((()=>S))),movies:a.l8.Array.of(a.l8.Reference.of((()=>v))),movie_genres:a.l8.Array.of(a.l8.Reference.of((()=>b))),movie_persons:a.l8.Array.of(a.l8.Reference.of((()=>d))),shows:a.l8.Array.of(a.l8.Reference.of((()=>_))),show_genres:a.l8.Array.of(a.l8.Reference.of((()=>w))),show_persons:a.l8.Array.of(a.l8.Reference.of((()=>u))),seasons:a.l8.Array.of(a.l8.Reference.of((()=>O))),episodes:a.l8.Array.of(a.l8.Reference.of((()=>E))),subtitles:a.l8.Array.of(a.l8.Reference.of((()=>R))),subtitle_contents:a.l8.Array.of(a.l8.Reference.of((()=>k))),cues:a.l8.Array.of(a.l8.Reference.of((()=>T)))}),persons:a.l8.Array.of(a.l8.Reference.of((()=>l))),files:a.l8.Array.of(a.l8.Reference.of((()=>I)))}),j=(a.l8.Record.of(a.l8.Array.of(a.l8.String)),a.l8.Object.of({audiolist_id:a.l8.String,title:a.l8.String,description:a.l8.String,user_id:a.l8.String})),x=a.l8.Object.of({audiolist_id:a.l8.String,track_id:a.l8.String,number:a.l8.Number}),U=a.l8.Object.of({audiolists:a.l8.Array.of(a.l8.Reference.of((()=>j))),audiolist_items:a.l8.Array.of(a.l8.Reference.of((()=>x)))}),A=a.l8.Object.of({user_id:a.l8.String,name:a.l8.String,username:a.l8.String,password:a.l8.String}),C=a.l8.Object.of({username:a.l8.String,selector:a.l8.String,validator_hash:a.l8.String,expires_ms:a.l8.Number}),L=a.l8.Object.of({users:a.l8.Array.of(a.l8.Reference.of((()=>A))),tokens:a.l8.Array.of(a.l8.Reference.of((()=>C)))}),D=a.l8.Object.of({username:a.l8.String,file_id:a.l8.String,timestamp_ms:a.l8.Number}),P=a.l8.Object.of({streams:a.l8.Array.of(a.l8.Reference.of((()=>D)))});function B(...e){return e.map((e=>String(e))).join("")}function H(e){let t=e;return t=t.toLowerCase(),t=t.normalize("NFC"),Array.from(t.match(/(\p{L}+|\p{N}+)/gu)||[]).filter((e=>e.length>=3))}function q(e){let t=Math.floor(e/1e3);e-=1e3*t;let r=Math.floor(t/60);t-=60*r;let n=Math.floor(r/60);r-=60*n;let s=B("00",n).slice(-2),i=B("00",r).slice(-2),o=B("00",t).slice(-2),a=B("000",e).slice(-3);return B(s,":",i,":",o,".",a)}function M(e){return null==e}function G(e){return null!=e}const F=(...e)=>(t,r)=>{for(let n of e){let e=n(t,r);if(0!==e)return e}return 0},$=e=>(t,r)=>{let n=e(t),s=e(r);return M(n)?M(s)?0:1:M(s)?M(n)?0:-1:n.localeCompare(s)},J=e=>(t,r)=>{let n=e(t),s=e(r);return M(n)?M(s)?0:-1:M(s)?M(n)?0:1:s-n},z=e=>(t,r)=>{let n=e(t),s=e(r);return M(n)?M(s)?0:1:M(s)?M(n)?0:-1:n-s};if(e.mkdirSync("./private/db/",{recursive:!0}),!e.existsSync("./private/db/streams.json")){let t={streams:[]};e.writeFileSync("./private/db/streams.json",JSON.stringify(t,null,"\t"))}if(!e.existsSync("./private/db/lists.json")){let t={audiolists:[],audiolist_items:[]};e.writeFileSync("./private/db/lists.json",JSON.stringify(t,null,"\t"))}if(!e.existsSync("./private/db/users.json")){let t={users:[{user_id:o.randomBytes(16).toString("hex"),name:"Test User",username:"test",password:function(e){let t=o.randomBytes(16),r=o.scryptSync("test",t,32,{N:16384,r:8,p:1,maxmem:33554432}),n=Buffer.alloc(4);return n[0]=0,n[1]=14,n[2]=8,n[3]=1,`$s0$${n.toString("hex")}$${t.toString("base64")}$${r.toString("base64")}`}()}],tokens:[]};e.writeFileSync("./private/db/users.json",JSON.stringify(t,null,"\t"))}e.existsSync("./private/db/media.json")||(process.stderr.write("Media database not found! Please run the indexer.\n"),process.exit(1));let W=P.as(JSON.parse(e.readFileSync("./private/db/streams.json","utf8"))),V=U.as(JSON.parse(e.readFileSync("./private/db/lists.json","utf8"))),X=L.as(JSON.parse(e.readFileSync("./private/db/users.json","utf8"))),Y=N.as(JSON.parse(e.readFileSync("./private/db/media.json","utf8")));X.tokens=X.tokens.filter((e=>e.expires_ms>Date.now())),e.writeFileSync("./private/db/users.json",JSON.stringify(X,null,"\t"));for(let e of Y.video.subtitle_contents){let t=e.subtitle_id;for(let r of e.cues){let e=r[0],n=r[1],s=r[2].split("\n"),i=o.createHash("md5").update(t).update(""+e).digest("hex");Y.video.cues.push({cue_id:i,subtitle_id:t,start_ms:e,duration_ms:n,lines:s})}}class K{constructor(){this.map=new Map}insert(e,t){this.map.set(e,t)}lookup(e){let t=this.map.get(e);if(null==t)throw`Expected "${e}" to match a record!`;return t}remove(e){this.map.delete(e)}static from(e,t){let r=new K;for(let n of t)r.insert(n[e],n);return r}}class Q{constructor(){this.map=new Map}insert(e,t){let r=this.map.get(e);r||(r=new Set,this.map.set(e,r)),r.add(t)}lookup(e){let t=this.map.get(e);return t?Array.from(t):new Array}remove(e,t){let r=this.map.get(e);r&&(r.delete(t),0===r.size&&this.map.delete(e))}static from(e,t){let r=new Q;for(let n of t)r.insert(n[e],n);return r}}const Z=Q.from("show_id",Y.video.show_persons),ee=Q.from("person_id",Y.video.show_persons),te=Q.from("movie_id",Y.video.movie_persons),re=Q.from("person_id",Y.video.movie_persons),ne=K.from("person_id",Y.persons),se=K.from("file_id",Y.files),ie=K.from("movie_id",Y.video.movies),oe=K.from("file_id",Y.video.episodes),ae=K.from("file_id",Y.video.movie_parts);let le=Q.from("movie_id",Y.video.movie_parts),de=Q.from("show_id",Y.video.show_genres),ue=Q.from("movie_id",Y.video.movie_genres);const ce=Q.from("video_genre_id",Y.video.movie_genres);let fe=Q.from("video_genre_id",Y.video.show_genres),pe=K.from("video_genre_id",Y.video.genres),he=Q.from("show_id",Y.video.seasons),me=Q.from("season_id",Y.video.episodes),ge=Q.from("file_id",W.streams);function ye(e){return le.lookup(e)}function ve(e){return ue.lookup(e).map((e=>pe.lookup(e.video_genre_id)))}let be=Q.from("album_id",Y.audio.album_artists);const Se=Q.from("artist_id",Y.audio.album_artists);let _e=Q.from("track_id",Y.audio.track_artists),we=Q.from("artist_id",Y.audio.track_artists),Oe=Q.from("video_file_id",Y.video.subtitles);const Ee=Q.from("album_id",Y.audio.discs),Re=Q.from("disc_id",Y.audio.tracks),ke=K.from("album_id",Y.audio.albums),Te=Q.from("audiolist_id",V.audiolist_items),Ie=Q.from("user_id",V.audiolists),Ne=K.from("track_id",Y.audio.tracks),je=K.from("disc_id",Y.audio.discs),xe=K.from("user_id",X.users),Ue=K.from("username",X.users),Ae=K.from("audiolist_id",V.audiolists),Ce=K.from("show_id",Y.video.shows),Le=K.from("artist_id",Y.audio.artists),De=K.from("episode_id",Y.video.episodes),Pe=K.from("season_id",Y.video.seasons),Be=K.from("subtitle_id",Y.video.subtitles),He=K.from("cue_id",Y.video.cues);Q.from("subtitle_id",Y.video.cues);class qe{constructor(){this.map=new Map}insert(e,t){let r=this.map.get(e);r||(r=new Set,this.map.set(e,r)),r.add(t)}lookup(e){let t=this.map.get(e);return t?new Set(t):new Set}remove(e,t){let r=this.map.get(e);r&&(r.delete(t),0===r.size&&this.map.delete(e))}search(e){var t;let r=H(e),n=r.map((e=>this.map.get(e))).filter(G),s=new Map;for(let e of n)for(let n of e){let e=null!==(t=s.get(n))&&void 0!==t?t:0-r.length;s.set(n,e+2)}return Array.from(s.entries()).filter((e=>e[1]>=0)).sort(z((e=>e[1]))).map((e=>({value:e[0],rank:e[1]})))}static from(e,t){let r=new qe;for(let n of e)for(let e of t(n)){let t=H(e);for(let e of t)r.insert(e,n)}return r}}const Me=qe.from(Y.audio.artists,(e=>[e.title])),Ge=qe.from(Y.audio.albums,(e=>[e.title])),Fe=qe.from(Y.audio.tracks,(e=>[e.title])),$e=qe.from(Y.video.shows,(e=>[e.title])),Je=qe.from(Y.video.movies,(e=>[e.title])),ze=qe.from(Y.video.episodes,(e=>[e.title])),We=qe.from(V.audiolists,(e=>[e.title])),Ve=qe.from(X.users,(e=>[e.name,e.username])),Xe=qe.from(Y.video.cues,(e=>e.lines)),Ye=qe.from(Y.persons,(e=>[e.name]));function Ke(e,t){var r;return(null===(r=function(e,t){return ge.lookup(t).filter((t=>t.username===e)).sort(z((e=>e.timestamp_ms)))}(e,t).pop())||void 0===r?void 0:r.timestamp_ms)||null}const Qe=K.from("selector",X.tokens);function Ze(e,t){let r=ke.lookup(e);return{album_id:r.album_id,title:r.title,year:r.year,artists:be.lookup(r.album_id).map((e=>Le.lookup(e.artist_id))),artwork:M(r.cover_file_id)?void 0:{file_id:r.cover_file_id,mime:"image/jpeg",height:1080,width:1080}}}function et(e,t){let r=Ze(e);return Object.assign(Object.assign({},r),{discs:Ee.lookup(e).map((e=>nt(e.disc_id,0,r)))})}function tt(e,t){let r=function(e,t){let r=Le.lookup(e);return{artist_id:r.artist_id,title:r.title}}(e);return Object.assign(Object.assign({},r),{albums:Se.lookup(e).map((e=>ke.lookup(e.album_id))).sort(J((e=>e.year))).map((e=>et(e.album_id)))})}function rt(e,t,r){let n=je.lookup(e);return{disc_id:n.disc_id,album:G(r)?r:Ze(n.album_id),number:n.number}}function nt(e,t,r){let n=rt(e,0,r),s=Re.lookup(e).sort(z((e=>e.number))).map((e=>{let t={track_id:e.track_id,title:e.title,disc:n,artists:_e.lookup(e.track_id).map((e=>Le.lookup(e.artist_id))),number:e.number,last_stream_date:void 0};return Object.assign(Object.assign({},t),{segment:{file:{file_id:e.file_id,mime:"audio/mp4",duration_ms:e.duration}}})}));return Object.assign(Object.assign({},n),{tracks:s})}function st(e,t,r){let n=De.lookup(e),s=function(e,t,r){var n,s,i;let o=De.lookup(e);return{episode_id:o.episode_id,title:o.title,summary:null!==(n=o.summary)&&void 0!==n?n:"",number:o.number,season:G(r)?r:dt(o.season_id,t),year:null!==(s=o.year)&&void 0!==s?s:void 0,last_stream_date:G(t)&&null!==(i=Ke(t,o.file_id))&&void 0!==i?i:void 0}}(e,t,r),i={file:{file_id:n.file_id,mime:"video/mp4",duration_ms:n.duration,height:0,width:0},subtitles:Oe.lookup(n.file_id).map((e=>{var t;return{subtitle_id:e.subtitle_id,file:{file_id:e.file_id,mime:"text/vtt"},language:null!==(t=e.language)&&void 0!==t?t:void 0,cues:[]}}))};return Object.assign(Object.assign({},s),{segment:i})}function it(e,t){let r=function(e,t){let r=pe.lookup(e);return{genre_id:r.video_genre_id,title:r.title}}(e);return Object.assign({},r)}function ot(e,t){let r=function(e,t){var r,n;let s=ie.lookup(e),i=ye(e);return{movie_id:s.movie_id,title:s.title,year:s.year,summary:null!==(r=s.summary)&&void 0!==r?r:"",artwork:M(s.poster_file_id)?void 0:{file_id:s.poster_file_id,mime:"image/jpeg",height:720,width:1080},last_stream_date:G(t)&&null!==(n=Ke(t,i[0].file_id))&&void 0!==n?n:void 0,genres:ue.lookup(e).map((e=>{let t=pe.lookup(e.video_genre_id);return{genre_id:t.video_genre_id,title:t.title}})),actors:te.lookup(e).map((e=>at(e.person_id)))}}(e,t),n=ye(e),s=Oe.lookup(n[0].file_id),i={file:{file_id:n[0].file_id,mime:"video/mp4",duration_ms:n[0].duration,height:0,width:0},subtitles:s.map((e=>{var t;return{subtitle_id:e.subtitle_id,file:{file_id:e.file_id,mime:"text/vtt"},language:null!==(t=e.language)&&void 0!==t?t:void 0,cues:[]}}))};return Object.assign(Object.assign({},r),{segment:i})}function at(e,t){let r=function(e,t){let r=ne.lookup(e);return{person_id:r.person_id,name:r.name}}(e);return Object.assign({},r)}function lt(e,t){let r=function(e,t){let r=Ae.lookup(e);return{playlist_id:r.audiolist_id,title:r.title,description:r.description,user:mt(r.user_id)}}(e),n=Te.lookup(r.playlist_id).sort(z((e=>e.number))).map((e=>({playlist:r,number:e.number,track:ht(e.track_id)})));return Object.assign(Object.assign({},r),{items:n})}function dt(e,t,r){let n=Pe.lookup(e);return{season_id:n.season_id,number:n.number,show:G(r)?r:ct(n.show_id)}}function ut(e,t,r){let n=dt(e,0,r),s=me.lookup(n.season_id).sort(z((e=>e.number))).map((e=>st(e.episode_id,t,n)));return Object.assign(Object.assign({},n),{episodes:s})}function ct(e,t){var r;let n=Ce.lookup(e);return{show_id:n.show_id,title:n.title,summary:null!==(r=n.summary)&&void 0!==r?r:"",artwork:M(n.poster_file_id)?void 0:{file_id:n.poster_file_id,mime:"image/jpeg",height:1080,width:720},genres:(s=e,de.lookup(s).map((e=>pe.lookup(e.video_genre_id)))).map((e=>({genre_id:e.video_genre_id,title:e.title}))),actors:Z.lookup(e).map((e=>at(e.person_id)))};var s}function ft(e,t){let r=ct(e),n=he.lookup(e).sort(z((e=>e.number))).map((e=>ut(e.season_id,t,r)));return Object.assign(Object.assign({},r),{seasons:n})}function pt(e,t){var r;let n=Be.lookup(e);return{subtitle_id:n.subtitle_id,file:{file_id:n.file_id,mime:"text/vtt"},language:null!==(r=n.language)&&void 0!==r?r:void 0}}function ht(e,t,r){let n=Ne.lookup(e),s=function(e,t,r){let n=Ne.lookup(e);return{track_id:n.track_id,title:n.title,disc:G(r)?r:rt(n.disc_id),artists:_e.lookup(n.track_id).map((e=>Le.lookup(e.artist_id))),number:n.number,last_stream_date:void 0}}(e,0,r);return Object.assign(Object.assign({},s),{segment:{file:{file_id:n.file_id,mime:"audio/mp4",duration_ms:n.duration}}})}function mt(e){let t=xe.lookup(e);return{user_id:t.user_id,name:t.name,username:t.username}}function gt(e){let t=mt(e);return Object.assign({},t)}function yt(t,r){if(!function(e,t){let r=/^\$s0\$([0-9a-fA-F]{8})\$([A-Za-z0-9+/]{22}==)\$([A-Za-z0-9+/]{43}=)$/.exec(t);if(null==r)throw"Expected a valid scrypt chunk!";let n=Buffer.from(r[1],"hex"),s=Buffer.from(r[2],"base64"),i=Buffer.from(r[3],"base64"),a=n[0]<<8|n[1]<<0,l=n[2]<<0,d=n[3]<<0,u=o.scryptSync(e,s,32,{N:1<<a,r:l,p:d,maxmem:(256<<a)*l});return o.timingSafeEqual(i,u)}(r,Ue.lookup(t).password))throw"Expected a valid password!";return function(t){let r=o.randomBytes(16),n=o.randomBytes(16),s=o.createHash("sha256");s.update(n);let i=s.digest("hex");var a;return a={username:t,selector:r.toString("hex"),validator_hash:i,expires_ms:Date.now()+6048e5},X.tokens.push(a),Qe.insert(a.selector,a),e.writeFileSync("./private/db/users.json",JSON.stringify(X,null,"\t")),`${r.toString("hex")}${n.toString("hex")}`}(t)}function vt(t){let r=/^([0-9a-f]{32})([0-9a-f]{32})$/.exec(t);if(!r)throw new Error;let n=r[1],s=r[2],i=Qe.lookup(n);if(i.expires_ms<Date.now())throw"Token has expired!";let a=o.createHash("sha256");a.update(Buffer.from(s,"hex"));let l=a.digest();if(!o.timingSafeEqual(Buffer.from(i.validator_hash,"hex"),l))throw new Error;let d=Date.now()+6048e5;return function(t){try{Qe.lookup(t.selector).expires_ms=t.expires_ms,e.writeFileSync("./private/db/users.json",JSON.stringify(X,null,"\t"))}catch(e){}}(Object.assign(Object.assign({},i),{expires_ms:d})),i.username}function bt(e,t){try{return function(e,t){let r=Number.parseInt(function(e,t){let r=function(e,t){var r;let n=null!==(r=e.query[t])&&void 0!==r?r:[];return Array.isArray(n)?n:[n]}(e,t).pop();if(M(r))throw`Expected parameter ${t}!`;return r}(e,t),10);if(!Number.isInteger(r))throw`Expected integer ${t}!`;return r}(e,t)}catch(e){}}function St(e){return vt(i.parse(e.url||"/",!0).query.token)}let _t=(new class{constructor(){this.routes=new Array}registerRoute(e){return this.routes.push(e),this}route(e,t){for(let r of this.routes)if(r.handlesRequest(e))return r.handleRequest(e,t);t.writeHead(400),t.end("{}")}}).registerRoute(new class{constructor(){}handleRequest(e,t){if(void 0===e.url)throw new Error;let r=/^[/]api[/]auth[/][?]token[=]([0-9a-f]{64})/.exec(e.url);if(null===r)throw new Error;let n=r[1],s={};try{return vt(n),t.writeHead(200),t.end(JSON.stringify(s))}catch(e){}return t.writeHead(401),t.end(JSON.stringify(s))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^[/]api[/]auth[/][?]token[=]([0-9a-f]{64})/.test(e.url)}}).registerRoute(new class{constructor(){}handleRequest(e,t){if(void 0===e.url)throw new Error;let r="";e.on("data",(e=>{r+=e})).on("end",(()=>{try{let e=JSON.parse(r);if(null==e||e.constructor!==Object)throw new Error;if(null==e.username||e.username.constructor!==String)throw new Error;if(null==e.password||e.password.constructor!==String)throw new Error;let n=e,s={token:yt(n.username,n.password)};t.writeHead(200),t.end(JSON.stringify(s))}catch(e){t.writeHead(400),t.end(JSON.stringify({error:e.message}))}}))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^[/]api[/]auth[/]/.test(e.url)}}).registerRoute(new class{handleRequest(e,t){var r,n,s,o,a;let l=St(e),d=/^[/]api[/]video[/]movies[/]([0-9a-f]{32})[/]suggestions[/]movies[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),u=i.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),c=null!==(s=bt(u,"offset"))&&void 0!==s?s:0,f=null!==(o=bt(u,"length"))&&void 0!==o?o:24,p=d[1],h=ve(p),m=new Map;for(let e of h){let t=ce.lookup(e.video_genre_id);for(let e of t){let t=null!==(a=m.get(e.movie_id))&&void 0!==a?a:0;m.set(e.movie_id,t+2)}}for(let e of m){let t=ve(e[0]);m.set(e[0],e[1]-t.length)}m.delete(p);let g={movies:Array.from(m.entries()).sort(F(J((e=>e[1])))).slice(c,c+f).map((e=>e[0])).map((e=>ot(e,l)))};t.writeHead(200),t.end(JSON.stringify(g))}handlesRequest(e){var t;return/^[/]api[/]video[/]movies[/]([0-9a-f]{32})[/]suggestions[/]movies[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let n=St(e),s={movie:ot(/^[/]api[/]video[/]movies[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],n)};t.writeHead(200),t.end(JSON.stringify(s))}handlesRequest(e){var t;return/^[/]api[/]video[/]movies[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,s,o;let a=St(e),l=/^[/]api[/]video[/]movies[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=decodeURIComponent(l[1]),u=i.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),c=null!==(s=bt(u,"offset"))&&void 0!==s?s:0,f=null!==(o=bt(u,"length"))&&void 0!==o?o:24,p=[];p=""===d?Y.video.movies.slice().sort($((e=>e.title))):Je.search(d).map((e=>e.value));let h={movies:p.slice(c,c+f).map((e=>ot(e.movie_id,a)))};t.writeHead(200),t.end(JSON.stringify(h))}handlesRequest(e){var t;return/^[/]api[/]video[/]movies[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;St(e);let n=/^[/]api[/]audio[/]artists[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],s={artist:tt(n),appearances:function(e){let t=we.lookup(e).map((e=>Ne.lookup(e.track_id))).map((e=>e.disc_id));t=Array.from(new Set(t));let r=t.map((e=>je.lookup(e))).map((e=>e.album_id));r=Array.from(new Set(r));let n=new Array;for(let t of r)null==be.lookup(t).find((t=>t.artist_id===e))&&n.push(t);return n}(n).map((e=>ke.lookup(e))).sort($((e=>e.title))).map((e=>et(e.album_id)))};t.writeHead(200),t.end(JSON.stringify(s))}handlesRequest(e){var t;return/^[/]api[/]audio[/]artists[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,s,o;St(e);let a=/^[/]api[/]audio[/]artists[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),l=decodeURIComponent(a[1]),d=i.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),u=null!==(s=bt(d,"offset"))&&void 0!==s?s:0,c=null!==(o=bt(d,"length"))&&void 0!==o?o:24,f=[];f=""===l?Y.audio.artists.slice().sort($((e=>e.title))):Me.search(l).map((e=>e.value));let p={artists:f.slice(u,u+c).map((e=>tt(e.artist_id)))};t.writeHead(200),t.end(JSON.stringify(p))}handlesRequest(e){var t;return/^[/]api[/]audio[/]artists[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;St(e);let n={album:et(/^[/]api[/]audio[/]albums[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1])};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]audio[/]albums[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,s,o;St(e);let a=/^[/]api[/]audio[/]albums[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],l=i.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),d=null!==(s=bt(l,"offset"))&&void 0!==s?s:0,u=null!==(o=bt(l,"length"))&&void 0!==o?o:24,c=[];c=""===a?Y.audio.albums.slice().sort($((e=>e.title))):Ge.search(a).map((e=>e.value));let f={albums:c.slice(d,d+u).map((e=>et(e.album_id)))};t.writeHead(200),t.end(JSON.stringify(f))}handlesRequest(e){var t;return/^[/]api[/]audio[/]albums[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let n=St(e),s={episode:st(/^[/]api[/]video[/]episodes[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],n)};t.writeHead(200),t.end(JSON.stringify(s))}handlesRequest(e){var t;return/^[/]api[/]video[/]episodes[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,s,o;let a=St(e),l=/^[/]api[/]video[/]episodes[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=decodeURIComponent(l[1]),u=i.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),c=null!==(s=bt(u,"offset"))&&void 0!==s?s:0,f=null!==(o=bt(u,"length"))&&void 0!==o?o:24,p=[];p=""===d?Y.video.episodes.slice().sort($((e=>e.title))):ze.search(d).map((e=>e.value));let h={episodes:p.slice(c,c+f).map((e=>st(e.episode_id,a)))};t.writeHead(200),t.end(JSON.stringify(h))}handlesRequest(e){var t;return/^[/]api[/]video[/]episodes[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let n=St(e),s={show:ft(/^[/]api[/]video[/]shows[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],n)};t.writeHead(200),t.end(JSON.stringify(s))}handlesRequest(e){var t;return/^[/]api[/]video[/]shows[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,s,o;let a=St(e),l=/^[/]api[/]video[/]shows[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=decodeURIComponent(l[1]),u=i.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),c=null!==(s=bt(u,"offset"))&&void 0!==s?s:0,f=null!==(o=bt(u,"length"))&&void 0!==o?o:24,p=[];p=""===d?Y.video.shows.slice().sort($((e=>e.title))):$e.search(d).map((e=>e.value));let h={shows:p.slice(c,c+f).map((e=>ft(e.show_id,a)))};t.writeHead(200),t.end(JSON.stringify(h))}handlesRequest(e){var t;return/^[/]api[/]video[/]shows[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let n=St(e),s=/^[/]api[/]persons[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],i={person:at(s),shows:function(e,t,r,n){return ee.lookup(e).map((e=>Ce.lookup(e.show_id))).sort($((e=>e.title))).slice(0,24).map((e=>ft(e.show_id,t)))}(s,n),movies:function(e,t,r,n){return re.lookup(e).map((e=>ie.lookup(e.movie_id))).sort($((e=>e.title))).slice(0,24).map((e=>ot(e.movie_id,t)))}(s,n)};t.writeHead(200),t.end(JSON.stringify(i))}handlesRequest(e){var t;return/^[/]api[/]persons[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,s,o;St(e);let a=/^[/]api[/]persons[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),l=decodeURIComponent(a[1]),d=i.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),u=null!==(s=bt(d,"offset"))&&void 0!==s?s:0,c=null!==(o=bt(d,"length"))&&void 0!==o?o:24,f=[];f=""===l?Y.persons.slice().sort($((e=>e.name))):Ye.search(l).map((e=>e.value));let p={persons:f.slice(u,u+c).map((e=>at(e.person_id)))};t.writeHead(200),t.end(JSON.stringify(p))}handlesRequest(e){var t;return/^[/]api[/]persons[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;St(e);let n={playlist:lt(/^[/]api[/]audio[/]playlists[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1])};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]audio[/]playlists[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,s,o;St(e);let a=/^[/]api[/]audio[/]playlists[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),l=decodeURIComponent(a[1]),d=i.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),u=null!==(s=bt(d,"offset"))&&void 0!==s?s:0,c=null!==(o=bt(d,"length"))&&void 0!==o?o:24,f=[];f=""===l?V.audiolists.slice().sort($((e=>e.title))):We.search(l).map((e=>e.value));let p={playlists:f.slice(u,u+c).map((e=>lt(e.audiolist_id)))};t.writeHead(200),t.end(JSON.stringify(p))}handlesRequest(e){var t;return/^[/]api[/]audio[/]playlists[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;St(e);let n={track:ht(/^[/]api[/]audio[/]tracks[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1])};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]audio[/]tracks[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,s,o;St(e);let a=/^[/]api[/]audio[/]tracks[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),l=decodeURIComponent(a[1]),d=i.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),u=null!==(s=bt(d,"offset"))&&void 0!==s?s:0,c=null!==(o=bt(d,"length"))&&void 0!==o?o:24,f=[];f=""===l?Y.audio.tracks.slice().sort($((e=>e.title))):Fe.search(l).map((e=>e.value));let p={tracks:f.slice(u,u+c).map((e=>ht(e.track_id)))};t.writeHead(200),t.end(JSON.stringify(p))}handlesRequest(e){var t;return/^[/]api[/]audio[/]tracks[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let n=St(e),s={season:ut(/^[/]api[/]video[/]seasons[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],n)};t.writeHead(200),t.end(JSON.stringify(s))}handlesRequest(e){var t;return/^[/]api[/]video[/]seasons[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,s,o;let a=St(e),l=/^[/]api[/]video[/]seasons[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=(decodeURIComponent(l[1]),i.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0)),u=null!==(s=bt(d,"offset"))&&void 0!==s?s:0,c=null!==(o=bt(d,"length"))&&void 0!==o?o:24,f={seasons:Y.video.seasons.sort($((e=>e.season_id))).slice(u,u+c).map((e=>ut(e.season_id,a)))};t.writeHead(200),t.end(JSON.stringify(f))}handlesRequest(e){var t;return/^[/]api[/]video[/]seasons[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;St(e);let n={disc:nt(/^[/]api[/]audio[/]discs[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1])};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]audio[/]discs[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,s,o;St(e);let a=/^[/]api[/]audio[/]discs[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),l=(decodeURIComponent(a[1]),i.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0)),d=null!==(s=bt(l,"offset"))&&void 0!==s?s:0,u=null!==(o=bt(l,"length"))&&void 0!==o?o:24,c={discs:Y.audio.discs.sort($((e=>e.disc_id))).slice(d,d+u).map((e=>nt(e.disc_id)))};t.writeHead(200),t.end(JSON.stringify(c))}handlesRequest(e){var t;return/^[/]api[/]audio[/]discs[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;St(e);let n=gt(/^[/]api[/]users[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1]),s={user:n,playlists:Ie.lookup(n.user_id).sort($((e=>e.title))).map((e=>lt(e.audiolist_id)))};t.writeHead(200),t.end(JSON.stringify(s))}handlesRequest(e){var t;return/^[/]api[/]users[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,s,o;St(e);let a=/^[/]api[/]users[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),l=decodeURIComponent(a[1]),d=i.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),u=null!==(s=bt(d,"offset"))&&void 0!==s?s:0,c=null!==(o=bt(d,"length"))&&void 0!==o?o:24,f=[];f=""===l?X.users.slice().sort($((e=>e.name))):Ve.search(l).map((e=>e.value));let p={users:f.slice(u,u+c).map((e=>gt(e.user_id)))};t.writeHead(200),t.end(JSON.stringify(p))}handlesRequest(e){var t;return/^[/]api[/]users[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,s,o;let a=St(e),l=/^[/]api[/]video[/]cues[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=decodeURIComponent(l[1]),u=i.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),c={cues:function(e,t,r,n){return Xe.search(e).sort(J((e=>e.rank))).slice(r,r+n).map((e=>function(e,t,r){let n=function(e,t,r){let n=He.lookup(e);return{cue_id:n.cue_id,subtitle:G(r)?r:pt(n.subtitle_id),start_ms:n.start_ms,duration_ms:n.duration_ms,lines:n.lines}}(e,0,r);return Object.assign({},n)}(e.value.cue_id)))}(d,0,null!==(s=bt(u,"offset"))&&void 0!==s?s:0,null!==(o=bt(u,"length"))&&void 0!==o?o:24).map((e=>{let t=Be.lookup(e.subtitle.subtitle_id);try{let r=oe.lookup(t.video_file_id);return Object.assign(Object.assign({},e),{media:st(r.episode_id,a)})}catch(e){}try{let r=ae.lookup(t.video_file_id);return Object.assign(Object.assign({},e),{media:ot(r.movie_id,a)})}catch(e){}})).filter(G)};t.writeHead(200),t.end(JSON.stringify(c))}handlesRequest(e){var t;return/^[/]api[/]video[/]cues[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,s,o;let a=St(e),l=/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]shows[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=i.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),u=null!==(s=bt(d,"offset"))&&void 0!==s?s:0,c=null!==(o=bt(d,"length"))&&void 0!==o?o:24,f={shows:function(e,t,r,n){return fe.lookup(e).map((e=>Ce.lookup(e.show_id))).sort($((e=>e.title))).slice(r,r+n).map((e=>ft(e.show_id,t)))}(l[1],a,u,c)};t.writeHead(200),t.end(JSON.stringify(f))}handlesRequest(e){var t;return/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]shows[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,s,o;let a=St(e),l=/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]movies[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=i.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),u=null!==(s=bt(d,"offset"))&&void 0!==s?s:0,c=null!==(o=bt(d,"length"))&&void 0!==o?o:24,f={movies:function(e,t,r,n){return ce.lookup(e).map((e=>ie.lookup(e.movie_id))).sort($((e=>e.title))).slice(r,r+n).map((e=>ot(e.movie_id,t)))}(l[1],a,u,c)};t.writeHead(200),t.end(JSON.stringify(f))}handlesRequest(e){var t;return/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]movies[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;St(e);let n={genre:it(/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1])};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;St(e),/^[/]api[/]video[/]genres[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/");let n={genres:Y.video.genres.slice().sort($((e=>e.title))).map((e=>it(e.video_genre_id)))};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]video[/]genres[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,s,o;let a=St(e),d=/^[/]api[/]search[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),u=decodeURIComponent(d[1]),p=i.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),m={entities:function(e,t,r,n){return[...Ge.search(e).map((e=>Object.assign(Object.assign({},e),{type_rank:5}))),...Me.search(e).map((e=>Object.assign(Object.assign({},e),{type_rank:7}))),...ze.search(e).map((e=>Object.assign(Object.assign({},e),{type_rank:2}))),...Je.search(e).map((e=>Object.assign(Object.assign({},e),{type_rank:6}))),...Ye.search(e).map((e=>Object.assign(Object.assign({},e),{type_rank:0}))),...We.search(e).map((e=>Object.assign(Object.assign({},e),{type_rank:4}))),...$e.search(e).map((e=>Object.assign(Object.assign({},e),{type_rank:3}))),...Fe.search(e).map((e=>Object.assign(Object.assign({},e),{type_rank:1}))),...Ve.search(e).map((e=>Object.assign(Object.assign({},e),{type_rank:0})))].sort(F(J((e=>e.rank)),J((e=>e.type_rank)))).slice(r,r+n).map((e=>{let r=e.value;if(f.is(r))return et(r.album_id);if(c.is(r))return tt(r.artist_id);if(E.is(r))return st(r.episode_id,t);if(v.is(r))return ot(r.movie_id,t);if(l.is(r))return at(r.person_id);if(j.is(r))return lt(r.audiolist_id);if(_.is(r))return ft(r.show_id,t);if(h.is(r))return ht(r.track_id);if(A.is(r))return gt(r.user_id);throw"Expected code to be unreachable!"}))}(u,a,null!==(s=bt(p,"offset"))&&void 0!==s?s:0,null!==(o=bt(p,"length"))&&void 0!==o?o:24)};t.writeHead(200),t.end(JSON.stringify(m))}handlesRequest(e){var t;return/^[/]api[/]search[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){let r={tokens:(n=St(e),X.tokens.filter((e=>e.username===n)))};var n;t.writeHead(200),t.end(JSON.stringify(r))}handlesRequest(e){return"POST"===e.method&&/^[/]api[/]tokens[/]/.test(e.url||"/")}});const wt=require("child_process"),Ot=a.l8.Object.of({pkt_pts_time:a.l8.String}),Et=a.l8.Object.of({frames:a.l8.Array.of(a.l8.Reference.of((()=>Ot)))}),Rt=a.l8.Object.of({start_time:a.l8.String,duration:a.l8.String});a.l8.Object.of({streams:a.l8.Array.of(a.l8.Reference.of((()=>Rt)))});function kt(e,t){return r=this,n=void 0,i=function*(){return new Promise(((r,n)=>{let s=wt.spawn("ffprobe",["-hide_banner","-i",e.join("/"),"-select_streams",""+t,"-skip_frame","nokey","-show_frames","-show_entries","frame=pkt_pts_time","-of","json"]),i=new Array;s.stdout.on("data",(e=>{i.push(e)})),s.on("exit",(()=>{let e=Buffer.concat(i).toString(),t=Et.as(JSON.parse(e)).frames.map((e=>Math.round(1e3*Number.parseFloat(e.pkt_pts_time))));r(t)}))}))},new((s=void 0)||(s=Promise))((function(e,t){function o(e){try{l(i.next(e))}catch(e){t(e)}}function a(e){try{l(i.throw(e))}catch(e){t(e)}}function l(t){var r;t.done?e(t.value):(r=t.value,r instanceof s?r:new s((function(e){e(r)}))).then(o,a)}l((i=i.apply(r,n||[])).next())}));var r,n,s,i}var Tt=function(e,t,r,n){return new(r||(r=Promise))((function(s,i){function o(e){try{l(n.next(e))}catch(e){i(e)}}function a(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}l((n=n.apply(e,t||[])).next())}))};function It(t){let r=o.randomBytes(16).toString("hex"),n=[".","private","jobs",r];return e.mkdirSync(n.join("/"),{recursive:!0}),t(n,r)}function Nt(t,r){e.mkdirSync(r.slice(0,-1).join("/"),{recursive:!0}),e.renameSync(t.join("/"),r.join("/"))}function jt(t){let r=e.statSync(t);r.isDirectory()?(e.readdirSync(t).map((e=>t+"/"+e)).forEach(jt),e.rmdirSync(t)):r.isFile()&&e.unlinkSync(t)}const xt=[];for(let t of Y.video.episodes){let r=[".","private","stills",t.file_id];if(!e.existsSync(r.join("/"))){let e=se.lookup(t.file_id);xt.push({target:r,file:e})}}setTimeout((function e(){return Tt(this,void 0,void 0,(function*(){let t=xt.pop();M(t)||(yield function(e,t){return new Promise(((r,n)=>Tt(this,void 0,void 0,(function*(){let s=yield kt([".",...t.path],0),i=s[Math.floor(s.length/2)];It(((s,o)=>{let a=[...s,"still.jpeg"],l=wt.spawn("ffmpeg",["-ss",q(i),"-i",[".",...t.path].join("/"),"-q:v","1","-frames:v","1","-f","singlejpeg","-fflags","+bitexact","-map_metadata","-1",a.join("/"),"-y"]);l.on("error",(()=>(jt(s.join("/")),n()))),l.on("exit",(()=>(Nt(a,e),jt(s.join("/")),r())))}))}))))}(t.target,t.file),setTimeout(e,1e4))}))}));class Ut{constructor(e){this.state=e,this.observers=new Array}addObserver(e){let t=new Ut(e(this.state));return this.observers.push((r=>{t.updateState(e(r))})),t.addObserver.bind(t)}getState(){return this.state}updateState(e){if(e!==this.state){this.state=e;for(let e of this.observers)e(this.state)}}}class At{constructor(e){this.state=e,this.observers=new Array}addObserver(e){var t;this.observers.push(e),null===(t=e.onupdate)||void 0===t||t.call(e,this.state)}compute(e){let t=new Ut(e(this.state));return this.observers.push({onupdate(r){t.updateState(e(r))}}),t.addObserver.bind(t)}getState(){return this.state}append(e){var t,r;this.state.push(e);for(let n of this.observers)null===(t=n.onappend)||void 0===t||t.call(n,e),null===(r=n.onupdate)||void 0===r||r.call(n,this.state)}splice(e){var t,r;if(e<0||e>=this.state.length)throw`Expected an index of at most ${this.state.length}, got ${e}!`;let n=this.state[e];this.state.splice(e,1);for(let s of this.observers)null===(t=s.onsplice)||void 0===t||t.call(s,n,e),null===(r=s.onupdate)||void 0===r||r.call(s,this.state)}update(e){for(let e=this.state.length-1;e>=0;e--)this.splice(e);for(let t of e)this.append(t)}}const Ct=a.l8.Object.of({person_id:a.l8.String,name:a.l8.String}),Lt=a.l8.Intersection.of(a.l8.Reference.of((()=>Ct)),a.l8.Object.of({})),Dt=a.l8.Object.of({artist_id:a.l8.String,title:a.l8.String}),Pt=a.l8.Intersection.of(a.l8.Reference.of((()=>Dt)),a.l8.Object.of({albums:a.l8.Array.of(a.l8.Reference.of((()=>Ht)))})),Bt=a.l8.Object.of({album_id:a.l8.String,title:a.l8.String,year:a.l8.Number,artists:a.l8.Array.of(a.l8.Reference.of((()=>Dt))),artwork:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>hr)))}),Ht=a.l8.Intersection.of(a.l8.Reference.of((()=>Bt)),a.l8.Object.of({discs:a.l8.Array.of(a.l8.Reference.of((()=>Mt)))})),qt=a.l8.Object.of({disc_id:a.l8.String,album:a.l8.Reference.of((()=>Bt)),number:a.l8.Number}),Mt=a.l8.Intersection.of(a.l8.Reference.of((()=>qt)),a.l8.Object.of({tracks:a.l8.Array.of(a.l8.Reference.of((()=>Ft)))})),Gt=a.l8.Object.of({track_id:a.l8.String,title:a.l8.String,disc:a.l8.Reference.of((()=>qt)),artists:a.l8.Array.of(a.l8.Reference.of((()=>Dt))),number:a.l8.Number,last_stream_date:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),Ft=a.l8.Intersection.of(a.l8.Reference.of((()=>Gt)),a.l8.Object.of({segment:a.l8.Object.of({file:a.l8.Reference.of((()=>pr))})})),$t=a.l8.Object.of({user_id:a.l8.String,name:a.l8.String,username:a.l8.String}),Jt=a.l8.Intersection.of(a.l8.Reference.of((()=>$t)),a.l8.Object.of({})),zt=a.l8.Object.of({playlist_id:a.l8.String,title:a.l8.String,description:a.l8.String,user:a.l8.Reference.of((()=>$t))}),Wt=a.l8.Intersection.of(a.l8.Reference.of((()=>zt)),a.l8.Object.of({items:a.l8.Array.of(a.l8.Reference.of((()=>Xt)))})),Vt=a.l8.Object.of({number:a.l8.Number,playlist:a.l8.Reference.of((()=>zt)),track:a.l8.Reference.of((()=>Ft))}),Xt=a.l8.Intersection.of(a.l8.Reference.of((()=>Vt)),a.l8.Object.of({})),Yt=a.l8.Object.of({genre_id:a.l8.String,title:a.l8.String}),Kt=a.l8.Intersection.of(a.l8.Reference.of((()=>Yt)),a.l8.Object.of({})),Qt=a.l8.Object.of({file:a.l8.Reference.of((()=>gr)),subtitles:a.l8.Array.of(a.l8.Reference.of((()=>dr)))}),Zt=a.l8.Intersection.of(a.l8.Reference.of((()=>Qt)),a.l8.Object.of({})),er=a.l8.Object.of({movie_id:a.l8.String,title:a.l8.String,year:a.l8.Number,summary:a.l8.String,artwork:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>hr))),last_stream_date:a.l8.Union.of(a.l8.Undefined,a.l8.Number),genres:a.l8.Array.of(a.l8.Reference.of((()=>Kt))),actors:a.l8.Array.of(a.l8.Reference.of((()=>Lt)))}),tr=a.l8.Intersection.of(a.l8.Reference.of((()=>er)),a.l8.Object.of({segment:a.l8.Reference.of((()=>Zt))})),rr=a.l8.Object.of({show_id:a.l8.String,title:a.l8.String,summary:a.l8.String,artwork:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>hr))),genres:a.l8.Array.of(a.l8.Reference.of((()=>Kt))),actors:a.l8.Array.of(a.l8.Reference.of((()=>Lt)))}),nr=a.l8.Intersection.of(a.l8.Reference.of((()=>rr)),a.l8.Object.of({seasons:a.l8.Array.of(a.l8.Reference.of((()=>ir)))})),sr=a.l8.Object.of({season_id:a.l8.String,number:a.l8.Number,show:a.l8.Reference.of((()=>rr))}),ir=a.l8.Intersection.of(a.l8.Reference.of((()=>sr)),a.l8.Object.of({episodes:a.l8.Array.of(a.l8.Reference.of((()=>ar)))})),or=a.l8.Object.of({episode_id:a.l8.String,title:a.l8.String,summary:a.l8.String,number:a.l8.Number,season:a.l8.Reference.of((()=>sr)),year:a.l8.Union.of(a.l8.Undefined,a.l8.Number),last_stream_date:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),ar=a.l8.Intersection.of(a.l8.Reference.of((()=>or)),a.l8.Object.of({segment:a.l8.Reference.of((()=>Zt))})),lr=a.l8.Object.of({subtitle_id:a.l8.String,file:a.l8.Reference.of((()=>mr)),language:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),dr=a.l8.Intersection.of(a.l8.Reference.of((()=>lr)),a.l8.Object.of({cues:a.l8.Array.of(a.l8.Reference.of((()=>cr)))})),ur=a.l8.Object.of({cue_id:a.l8.String,subtitle:a.l8.Reference.of((()=>lr)),start_ms:a.l8.Number,duration_ms:a.l8.Number,lines:a.l8.Array.of(a.l8.String)}),cr=a.l8.Intersection.of(a.l8.Reference.of((()=>ur)),a.l8.Object.of({})),fr=(a.l8.Union.of(a.l8.Reference.of((()=>Ht)),a.l8.Reference.of((()=>Pt)),a.l8.Reference.of((()=>Mt)),a.l8.Reference.of((()=>ar)),a.l8.Reference.of((()=>Kt)),a.l8.Reference.of((()=>tr)),a.l8.Reference.of((()=>Lt)),a.l8.Reference.of((()=>Wt)),a.l8.Reference.of((()=>ir)),a.l8.Reference.of((()=>nr)),a.l8.Reference.of((()=>Ft)),a.l8.Reference.of((()=>Jt))),a.l8.Object.of({file_id:a.l8.String,mime:a.l8.String})),pr=a.l8.Intersection.of(a.l8.Reference.of((()=>fr)),a.l8.Object.of({duration_ms:a.l8.Number})),hr=a.l8.Intersection.of(a.l8.Reference.of((()=>fr)),a.l8.Object.of({height:a.l8.Number,width:a.l8.Number})),mr=a.l8.Intersection.of(a.l8.Reference.of((()=>fr)),a.l8.Object.of({})),gr=a.l8.Intersection.of(a.l8.Reference.of((()=>fr)),a.l8.Object.of({duration_ms:a.l8.Number,height:a.l8.Number,width:a.l8.Number})),yr=a.l8.Reference.of((()=>Ht)),vr=a.l8.Reference.of((()=>Pt)),br=a.l8.Reference.of((()=>Mt)),Sr=a.l8.Reference.of((()=>Ft)),_r=a.l8.Reference.of((()=>Wt)),wr=a.l8.Reference.of((()=>tr)),Or=a.l8.Reference.of((()=>nr)),Er=a.l8.Reference.of((()=>ir)),Rr=a.l8.Reference.of((()=>ar)),kr=a.l8.Union.of(a.l8.Reference.of((()=>yr)),a.l8.Reference.of((()=>vr)),a.l8.Reference.of((()=>br)),a.l8.Reference.of((()=>Sr)),a.l8.Reference.of((()=>_r)),a.l8.Reference.of((()=>wr)),a.l8.Reference.of((()=>Or)),a.l8.Reference.of((()=>Er)),a.l8.Reference.of((()=>Rr))),Tr=(a.l8.Union.of(a.l8.Reference.of((()=>Sr)),a.l8.Reference.of((()=>wr)),a.l8.Reference.of((()=>Rr))),a.l8.Object.of({id:a.l8.String,type:a.l8.String,name:a.l8.String})),Ir=(a.l8.Object.of({context:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>kr))),device:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>Tr))),index:a.l8.Union.of(a.l8.Undefined,a.l8.Number),playback:a.l8.Boolean,progress:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),{SetContext:a.l8.Object.of({context:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>kr)))}),SetDevice:a.l8.Object.of({device:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>Tr)))}),SetDevices:a.l8.Object.of({devices:a.l8.Array.of(a.l8.Reference.of((()=>Tr)))}),SetIndex:a.l8.Object.of({index:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),SetLocalDevice:a.l8.Object.of({device:a.l8.Reference.of((()=>Tr))}),SetPlayback:a.l8.Object.of({playback:a.l8.Boolean}),SetProgress:a.l8.Object.of({progress:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),SetToken:a.l8.Object.of({token:a.l8.Union.of(a.l8.Undefined,a.l8.String)})});var Nr=r(978),jr=r(611);class xr{constructor(e,t,r){this.nextConnectionAttemptDelayFactor=2+Math.random(),this.nextConnectionAttemptDelay=2e3,this.router=new Nr.routing.NamespacedMessageRouter,this.serializer=new a.m7.MessageSerializer(r),this.url=e,this.factory=t,this.socket=t(e),this.socket.addEventListener("close",this.onClose.bind(this)),this.socket.addEventListener("error",this.onError.bind(this)),this.socket.addEventListener("message",this.onMessage.bind(this)),this.socket.addEventListener("open",this.onOpen.bind(this))}onClose(e){this.router.route("sys","disconnect",{})}onError(e){setTimeout((()=>{this.socket=this.factory(this.url),this.socket.addEventListener("close",this.onClose.bind(this)),this.socket.addEventListener("error",this.onError.bind(this)),this.socket.addEventListener("message",this.onMessage.bind(this)),this.socket.addEventListener("open",this.onOpen.bind(this))}),this.nextConnectionAttemptDelay),this.nextConnectionAttemptDelay=Math.round(this.nextConnectionAttemptDelay*this.nextConnectionAttemptDelayFactor)}onMessage(e){let t=e.data;this.serializer.deserialize(t,((e,t)=>{this.router.route("sys","message",{type:e,data:t}),this.router.route("app",e,t)}))}onOpen(e){this.nextConnectionAttemptDelay=2e3,this.router.route("sys","connect",{})}addEventListener(e,t,r){this.router.addObserver(e,t,r)}close(){this.socket.close()}removeEventListener(e,t,r){this.router.addObserver(e,t,r)}send(e,t){if(this.socket.readyState===jr.ReadyState.OPEN)this.socket.send(this.serializer.serialize(e,t));else{let r=()=>{this.socket.removeEventListener("open",r),this.socket.send(this.serializer.serialize(e,t))};this.socket.addEventListener("open",r)}}}class Ur{constructor(e,t=(e=>new WebSocket(e))){this.estimatedProgress=new Ut(void 0),this.estimatedProgressTimestamp=new Ut(void 0),this.token=new Ut(void 0),this.localDevice=new Ut(void 0),this.devices=new At(new Array),this.device=new Ut(void 0),this.isDeviceLocal=new Ut(!1),this.isDeviceRemote=new Ut(!1),this.context=new Ut(void 0),this.contextPath=new Ut(void 0),this.flattenedContext=new Ut(void 0),this.lastIndex=new Ut(void 0),this.lastEntry=new Ut(void 0),this.lastLocalEntry=new Ut(void 0),this.currentIndex=new Ut(void 0),this.currentEntry=new Ut(void 0),this.currentLocalEntry=new Ut(void 0),this.nextIndex=new Ut(void 0),this.nextEntry=new Ut(void 0),this.nextLocalEntry=new Ut(void 0),this.playback=new Ut(!1),this.progress=new Ut(void 0),this.localPlayback=new Ut(!1),this.canPlayLast=new Ut(!1),this.canPlayCurrent=new Ut(!1),this.canPlayNext=new Ut(!1),this.isCurrentEntryVideo=new Ut(!1),this.isOnline=new Ut(!1),this.tsc=new xr(e,t,Ir),this.tsc.addEventListener("sys","connect",(()=>{this.isOnline.updateState(!0)})),this.tsc.addEventListener("sys","disconnect",(()=>{this.isOnline.updateState(!1)})),this.context.addObserver((e=>{if(G(e))if(yr.is(e)){let t=[],r=e;for(let e of r.discs)t.push(...e.tracks);this.flattenedContext.updateState(t)}else if(vr.is(e)){let t=[],r=e;for(let e of r.albums)for(let r of e.discs)t.push(...r.tracks);this.flattenedContext.updateState(t)}else if(Rr.is(e)){let t=[],r=e;t.push(r),this.flattenedContext.updateState(t)}else if(wr.is(e)){let t=[],r=e;t.push(r),this.flattenedContext.updateState(t)}else if(_r.is(e)){let t=[],r=e;for(let e of r.items)t.push(e.track);this.flattenedContext.updateState(t)}else if(Er.is(e)){let t=[],r=e;t.push(...r.episodes),this.flattenedContext.updateState(t)}else if(Or.is(e)){let t=[],r=e;for(let e of r.seasons)t.push(...e.episodes);this.flattenedContext.updateState(t)}else{if(!Sr.is(e))throw"Expected code to be unreachable!";{let t=[],r=e;t.push(r),this.flattenedContext.updateState(t)}}}));{let e=()=>{let e=this.context.getState(),t=this.currentIndex.getState();if(G(e)&&G(t)){if(yr.is(e)){let r=0,n=t,s=e.discs;for(let e=0;e<s.length;e++){let t=s[e].tracks.length;if(!(n>=t))break;r+=1,n-=t}return this.contextPath.updateState([e.album_id,e.discs[r].disc_id,e.discs[r].tracks[n].track_id])}if(vr.is(e)){let r=0,n=0,s=t,i=e.albums;e:for(let e=0;e<i.length;e++){let t=i[e].discs;for(let e=0;e<t.length;e++){let r=t[e].tracks.length;if(!(s>=r))break e;n+=1,s-=r}r+=1,n=0}return this.contextPath.updateState([e.artist_id,e.albums[r].album_id,e.albums[r].discs[n].disc_id,e.albums[r].discs[n].tracks[s].track_id])}if(Rr.is(e))return this.contextPath.updateState([e.episode_id]);if(wr.is(e))return this.contextPath.updateState([e.movie_id]);if(_r.is(e)){let r=t;return this.contextPath.updateState([e.playlist_id,e.items[r].track.track_id])}if(Or.is(e)){let r=0,n=t,s=e.seasons;for(let e=0;e<s.length;e++){let t=s[e].episodes.length;if(!(n>=t))break;r+=1,n-=t}return this.contextPath.updateState([e.show_id,e.seasons[r].season_id,e.seasons[r].episodes[n].episode_id])}if(Er.is(e)){let r=t;return this.contextPath.updateState([e.season_id,e.episodes[r].episode_id])}if(Sr.is(e))return this.contextPath.updateState([e.track_id]);throw"Expected code to be unreachable!"}this.contextPath.updateState(void 0)};this.context.addObserver(e),this.currentIndex.addObserver(e)}this.lastEntry.addObserver((e=>{this.canPlayLast.updateState(G(e))})),this.currentEntry.addObserver((e=>{this.canPlayCurrent.updateState(G(e))})),this.nextEntry.addObserver((e=>{this.canPlayNext.updateState(G(e))})),this.progress.addObserver((e=>{this.estimatedProgress.updateState(e),this.estimatedProgressTimestamp.updateState(Date.now())})),this.playback.addObserver((e=>{let t=this.estimatedProgress.getState(),r=this.estimatedProgressTimestamp.getState(),n=Date.now();e||G(t)&&G(r)&&this.estimatedProgress.updateState(t+(n-r)/1e3),this.estimatedProgressTimestamp.updateState(n)})),this.estimatedProgress.addObserver((e=>{console.log("Estimated progress to "+(null!=e?e:0))}));{let e=()=>{let e=this.playback.getState(),t=this.isDeviceLocal.getState();this.localPlayback.updateState(t&&e)};this.playback.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.lastEntry.getState(),t=this.isDeviceLocal.getState();this.lastLocalEntry.updateState(t?e:void 0)};this.lastEntry.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.currentEntry.getState(),t=this.isDeviceLocal.getState();this.currentLocalEntry.updateState(t?e:void 0)};this.currentEntry.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.nextEntry.getState(),t=this.isDeviceLocal.getState();this.nextLocalEntry.updateState(t?e:void 0)};this.nextEntry.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.localDevice.getState(),t=this.device.getState();return G(e)&&G(t)&&e.id===t.id?this.isDeviceLocal.updateState(!0):this.isDeviceLocal.updateState(!1)};this.localDevice.addObserver(e),this.device.addObserver(e)}{let e=()=>{let e=this.localDevice.getState(),t=this.device.getState();return G(e)&&G(t)&&e.id!==t.id?this.isDeviceRemote.updateState(!0):this.isDeviceRemote.updateState(!1)};this.localDevice.addObserver(e),this.device.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.currentIndex.getState();if(G(e)&&G(t)){let r=t-1;if(r>=0&&r<e.length)return this.lastIndex.updateState(r)}return this.lastIndex.updateState(void 0)};this.flattenedContext.addObserver(e),this.currentIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.currentIndex.getState();if(G(e)&&G(t)){let r=t+1;if(r>=0&&r<e.length)return this.nextIndex.updateState(r)}return this.nextIndex.updateState(void 0)};this.flattenedContext.addObserver(e),this.currentIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.lastIndex.getState();return G(e)&&G(t)?this.lastEntry.updateState(e[t]):this.lastEntry.updateState(void 0)};this.flattenedContext.addObserver(e),this.lastIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.currentIndex.getState();return G(e)&&G(t)&&t>=0&&t+0<e.length?this.currentEntry.updateState(e[t+0]):this.currentEntry.updateState(void 0)};this.flattenedContext.addObserver(e),this.currentIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.nextIndex.getState();return G(e)&&G(t)?this.nextEntry.updateState(e[t]):this.nextEntry.updateState(void 0)};this.flattenedContext.addObserver(e),this.nextIndex.addObserver(e)}this.token.addObserver((e=>{this.tsc.send("SetToken",{token:e})})),this.tsc.addEventListener("app","SetLocalDevice",(e=>{this.localDevice.updateState(e.device)})),this.tsc.addEventListener("app","SetDevices",(e=>{this.devices.update(e.devices)})),this.tsc.addEventListener("app","SetContext",(e=>{this.context.updateState(e.context)})),this.tsc.addEventListener("app","SetDevice",(e=>{this.device.updateState(e.device)})),this.tsc.addEventListener("app","SetIndex",(e=>{this.currentIndex.updateState(e.index)})),this.tsc.addEventListener("app","SetPlayback",(e=>{this.playback.updateState(e.playback)})),this.tsc.addEventListener("app","SetProgress",(e=>{this.progress.updateState(e.progress)})),this.tsc.addEventListener("app","SetToken",(e=>{this.token.updateState(e.token)}))}play(e,t){this.tsc.send("SetContext",{context:e}),this.tsc.send("SetIndex",{index:t}),this.tsc.send("SetPlayback",{playback:!0})}authenticate(e){this.tsc.send("SetToken",{token:e})}close(){this.tsc.close()}last(){let e=this.lastIndex.getState();G(e)?(this.currentIndex.updateState(e),this.tsc.send("SetIndex",{index:e})):this.pause()}next(){let e=this.nextIndex.getState();G(e)?(this.currentIndex.updateState(e),this.tsc.send("SetIndex",{index:e})):this.pause()}pause(){this.playback.updateState(!1),this.tsc.send("SetPlayback",{playback:!1})}playAlbum(e,t,r){let n=0;if(G(t)){let s=e.discs;if(t<0||t>=s.length)throw`Expected ${t} to be a number between 0 and ${s.length}!`;if(n+=s.slice(0,t).reduce(((e,t)=>e+t.tracks.length),0),G(r)){let e=s[t].tracks;if(r<0||r>=e.length)throw`Expected ${r} to be a number between 0 and ${e.length}!`;n+=r}}return this.play(e,n)}playArtist(e,t,r,n){let s=0;if(G(t)){let i=e.albums;if(t<0||t>=i.length)throw`Expected ${t} to be a number between 0 and ${i.length}!`;if(s+=i.slice(0,t).reduce(((e,t)=>e+t.discs.reduce(((e,t)=>e+t.tracks.length),0)),0),G(r)){let e=i[t].discs;if(r<0||r>=e.length)throw`Expected ${r} to be a number between 0 and ${e.length}!`;if(s+=e.slice(0,r).reduce(((e,t)=>e+t.tracks.length),0),G(n)){let t=e[r].tracks;if(n<0||n>=t.length)throw`Expected ${n} to be a number between 0 and ${t.length}!`;s+=n}}}return this.play(e,s)}playDisc(e,t){let r=0;if(G(t)){let n=e.tracks;if(t<0||t>=n.length)throw`Expected ${t} to be a number between 0 and ${n.length}!`;r+=t}return this.play(e,r)}playEpisode(e){this.play(e,0)}playMovie(e){this.play(e,0)}playPlaylist(e,t){let r=0;if(G(t)){let n=e.items;if(t<0||t>=n.length)throw`Expected ${t} to be a number between 0 and ${n.length}!`;r+=t}return this.play(e,r)}playSeason(e,t){let r=0;if(G(t)){let n=e.episodes;if(t<0||t>=n.length)throw`Expected ${t} to be a number between 0 and ${n.length}!`;r+=t}return this.play(e,r)}playShow(e,t,r){let n=0;if(G(t)){let s=e.seasons;if(t<0||t>=s.length)throw`Expected ${t} to be a number between 0 and ${s.length}!`;if(n+=s.slice(0,t).reduce(((e,t)=>e+t.episodes.length),0),G(r)){let e=s[t].episodes;if(r<0||r>=e.length)throw`Expected ${r} to be a number between 0 and ${e.length}!`;n+=r}}return this.play(e,n)}playTrack(e){this.play(e,0)}resume(){this.canPlayCurrent.getState()&&(this.playback.updateState(!0),this.tsc.send("SetPlayback",{playback:!0}))}seek(e){this.tsc.send("SetProgress",{progress:e})}toggle(){this.playback.getState()?this.pause():this.resume()}transfer(e){this.tsc.send("SetDevice",{device:e})}}var Ar=r(545);class Cr{constructor(e,t=!1){this.router=new Nr.routing.NamespacedMessageRouter,this.serializer=new a.m7.MessageSerializer(e),this.socket=new Ar.u9,this.debug=t,this.socket.addEventListener("connect",(e=>{let t=e.connection_id,r=e.connection_url;this.router.route("sys","connect",{connection_id:t,connection_url:r})})),this.socket.addEventListener("disconnect",(e=>{let t=e.connection_id,r=e.connection_url;this.router.route("sys","disconnect",{connection_id:t,connection_url:r})})),this.socket.addEventListener("message",(e=>{let t=e.connection_id,r=e.connection_url,n=e.buffer.toString();this.serializer.deserialize(n,((e,n)=>{this.debug&&console.log(`${t} -> ${e}`),this.router.route("sys","message",{connection_id:t,connection_url:r,type:e,data:n}),this.router.route("app",e,{connection_id:t,connection_url:r,data:n})}))}))}addEventListener(e,t,r){this.router.addObserver(e,t,r)}broadcast(e,t){let r=this.serializer.serialize(e,t);this.socket.broadcast(r)}close(e){this.socket.close(e)}getRequestHandler(){return this.socket.getRequestHandler()}removeEventListener(e,t,r){this.router.addObserver(e,t,r)}send(e,t,r){let n=this.serializer.serialize(e,r);for(let r of Array.isArray(t)?t:[t]){this.debug&&console.log(`${r} <- ${e}`);try{this.socket.send(r,n)}catch(e){}}}}function Lr(e,t){var r;let n=null!==(r=e.query[t])&&void 0!==r?r:[];return Array.isArray(n)?n:[n]}function Dr(e,t){var r,n;let s=i.parse(t,!0);return{id:e,name:null!==(r=Lr(s,"name").pop())&&void 0!==r?r:"",type:null!==(n=Lr(s,"type").pop())&&void 0!==n?n:""}}var Pr,Br,Hr,qr=r(16);function Mr(e){if(e>Number.MAX_SAFE_INTEGER||e<Number.MIN_SAFE_INTEGER)throw`Expected a safe integer but got ${e}!`;return Number(e)}function Gr(e,t){let r=e.buffer.length-e.offset;if(t>r)throw`Expected to read at most ${r} bytes but attempted to read ${t} bytes!`;let n=e.buffer.slice(e.offset,e.offset+t);return e.offset+=t,n}function Fr(e){let t=Buffer.alloc(10);for(let r=0;r<10;r++){let n=e.buffer.readUInt8(e.offset);if(e.offset+=1,t[r]=n,0==(128&n)){if(r+1===10&&0!=(126&n))throw"Expected a varint of at most 64 bits!";let e=BigInt(0);for(let n=r;n>=0;n--)e=e<<BigInt(7)|BigInt(127&t[n]);let s=Buffer.alloc(8);return s.writeBigUInt64LE(e,0),s}}throw"Expected a varint of at most 10 bytes!"}function $r(e){let t=e.readBigUInt64LE(0),r=Buffer.alloc(10);for(let e=0;e<10;e++){let n=t&BigInt(127);if(t>>=BigInt(7),!(t>0))return r.writeUInt8(0|Mr(n),e),r.slice(0,e+1);r.writeUInt8(128|Mr(n),e)}throw"Expected to serialize at most 10 bytes!"}function Jr(e){let t=BigInt(e.field_number)<<BigInt(3)|BigInt(e.wire_type)&BigInt(7),r=Buffer.alloc(8);return r.writeBigUInt64LE(t,0),$r(r)}function zr(e){let t=function(e){let t=Fr(e).readBigUInt64LE(0);return{field_number:Mr(t>>BigInt(3)),wire_type:Mr(t&BigInt(7))}}(e);if(t.wire_type===Pr.VARINT)return{key:t,data:Fr(e)};if(t.wire_type===Pr.FIXED_64_BIT)return{key:t,data:Gr(e,8)};if(t.wire_type===Pr.LENGTH_DELIMITED)return{key:t,data:Gr(e,Mr(Fr(e).readBigUInt64LE(0)))};if(t.wire_type===Pr.START_GROUP)return{key:t,data:Buffer.alloc(0)};if(t.wire_type===Pr.END_GROUP)return{key:t,data:Buffer.alloc(0)};if(t.wire_type===Pr.FIXED_32_BIT)return{key:t,data:Gr(e,4)};throw"Expected a recognized wire type!"}function Wr(e){if(e.key.wire_type===Pr.VARINT)return Buffer.concat([Jr(e.key),$r(e.data)]);if(e.key.wire_type===Pr.FIXED_64_BIT){if(8!==e.data.length)throw"Expected to serialize exactly 8 bytes!";return Buffer.concat([Jr(e.key),e.data])}if(e.key.wire_type===Pr.LENGTH_DELIMITED){let t=Buffer.alloc(8);return t.writeBigUInt64LE(BigInt(e.data.length)),Buffer.concat([Jr(e.key),$r(t),e.data])}if(e.key.wire_type===Pr.START_GROUP){if(0!==e.data.length)throw"Expected to serialize exactly 0 bytes!";return Buffer.concat([Jr(e.key),e.data])}if(e.key.wire_type===Pr.END_GROUP){if(0!==e.data.length)throw"Expected to serialize exactly 0 bytes!";return Buffer.concat([Jr(e.key),e.data])}if(e.key.wire_type===Pr.FIXED_32_BIT){if(4!==e.data.length)throw"Expected to serialize exactly 4 bytes!";return Buffer.concat([Jr(e.key),e.data])}throw"Expected a recognized wire type!"}function Vr(e,t){let r=t.filter((t=>t.key.field_number===e));if(0===r.length)throw"Expected required field to be present!";return Mr(r[r.length-1].data.readBigUInt64LE(0))}function Xr(e,t){return Wr({key:{field_number:e,wire_type:Pr.VARINT},data:function(e){let t=Buffer.alloc(8);return t.writeBigUInt64LE(BigInt(e)),t}(t)})}function Yr(e,t){let r=t.filter((t=>t.key.field_number===e));if(0===r.length)throw"Expected required field to be present!";return r[r.length-1].data.toString()}function Kr(e,t){return Wr({key:{field_number:e,wire_type:Pr.LENGTH_DELIMITED},data:Buffer.from(t)})}function Qr(e,t){return null==t?Buffer.alloc(0):function(e,t){return Wr({key:{field_number:e,wire_type:Pr.LENGTH_DELIMITED},data:t})}(e,t)}!function(e){e[e.VARINT=0]="VARINT",e[e.FIXED_64_BIT=1]="FIXED_64_BIT",e[e.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",e[e.START_GROUP=3]="START_GROUP",e[e.END_GROUP=4]="END_GROUP",e[e.FIXED_32_BIT=5]="FIXED_32_BIT"}(Pr||(Pr={})),function(e){e[e.CASTV2_1_0=0]="CASTV2_1_0"}(Br||(Br={})),function(e){e[e.STRING=0]="STRING",e[e.BINARY=1]="BINARY"}(Hr||(Hr={}));const Zr=require("dgram");var en=function(e,t,r,n){return new(r||(r=Promise))((function(s,i){function o(e){try{l(n.next(e))}catch(e){i(e)}}function a(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}l((n=n.apply(e,t||[])).next())}))};let tn={},rn={},nn=(e,t)=>{let r=rn[e];if(void 0!==r)for(let e of r)e(t);let n=tn[e];void 0!==n&&nn(n,t)},sn=(e,t,r)=>{tn[t]=e,"A"===r&&nn(e,t)},on=(e,t)=>en(void 0,void 0,void 0,(function*(){let r=new Array;for(;;){let n=e.readUInt8(t);if(0===n){t+=1;break}if(n<64){t+=1;let s=e.slice(t,t+n);t+=n,r.push(s.toString("binary"));continue}if(n<192)throw new Error;let s=yield on(e,16383&e.readUInt16BE(t));r.push(s.value),t+=2;break}return{value:r.join("."),offset:t}})),an=(e,t)=>en(void 0,void 0,void 0,(function*(){let r=yield on(e,t);return t=r.offset,e.readUInt16BE(t),t+=2,e.readUInt16BE(t),t+=2,{value:r.value,offset:t}})),ln=(e,t)=>en(void 0,void 0,void 0,(function*(){let r=yield on(e,t);t=r.offset;let n=e.readUInt16BE(t);t+=2,e.readUInt16BE(t),t+=2,e.readUInt32BE(t),t+=4;let s=e.readUInt16BE(t);t+=2;let i="";if(1===n&&(i=`${e[t+0]}.${e[t+1]}.${e[t+2]}.${e[t+3]}`,t+=4,sn(r.value,i,"A")),12===n){let n=yield on(e,t);t=n.offset,i=n.value,sn(r.value,i,"PTR")}if(16===n){let r=e.slice(t,t+s);t+=s,i=r.toString("binary")}if(33===n){e.readUInt16BE(t),t+=2,e.readUInt16BE(t),t+=2,e.readUInt16BE(t),t+=2;let n=yield on(e,t);t=n.offset,i=n.value,sn(r.value,i,"SRV")}return{name:r.value,data:i,offset:t}}));const dn="224.0.0.251";let un=Zr.createSocket({type:"udp4",reuseAddr:!0});un.on("listening",(()=>{un.setMulticastLoopback(!1),un.addMembership(dn,"0.0.0.0")})),un.on("message",((e,t)=>en(void 0,void 0,void 0,(function*(){try{yield(e=>en(void 0,void 0,void 0,(function*(){let t=0,r=e.slice(t,t+12);t+=12,r.readUInt16BE(0),r.readUInt16BE(2);let n=r.readUInt16BE(4),s=r.readUInt16BE(6),i=r.readUInt16BE(8),o=r.readUInt16BE(10),a=new Array;for(let r=0;r<n;r++){let r=yield an(e,t);a.push(r),t=r.offset}let l=new Array;for(let r=0;r<s;r++){let r=yield ln(e,t);l.push(r),t=r.offset}let d=new Array;for(let r=0;r<i;r++){let r=yield ln(e,t);d.push(r),t=r.offset}let u=new Array;for(let r=0;r<o;r++){let r=yield ln(e,t);u.push(r),t=r.offset}})))(e)}catch(e){}})))),un.bind(5353);const cn={CONNECT:a.l8.Object.of({type:a.l8.StringLiteral.of("CONNECT")}),CLOSE:a.l8.Object.of({type:a.l8.StringLiteral.of("CLOSE")})},fn={PING:a.l8.Object.of({type:a.l8.StringLiteral.of("PING")}),PONG:a.l8.Object.of({type:a.l8.StringLiteral.of("PONG")})},pn=a.l8.Object.of({url:a.l8.String,height:a.l8.Union.of(a.l8.Undefined,a.l8.Number),width:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),hn=a.l8.Object.of({level:a.l8.Union.of(a.l8.Undefined,a.l8.Number),muted:a.l8.Union.of(a.l8.Undefined,a.l8.Boolean)}),mn=a.l8.Object.of({contentId:a.l8.String,streamType:a.l8.Union.of(a.l8.StringLiteral.of("NONE"),a.l8.StringLiteral.of("BUFFERED"),a.l8.StringLiteral.of("LIVE")),contentType:a.l8.String,metadata:a.l8.Union.of(a.l8.Undefined,a.l8.Union.of(a.l8.Reference.of((()=>gn)),a.l8.Reference.of((()=>yn)),a.l8.Reference.of((()=>vn)),a.l8.Reference.of((()=>bn)),a.l8.Reference.of((()=>Sn)))),duration:a.l8.Union.of(a.l8.Undefined,a.l8.Number),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any)),tracks:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Union.of(a.l8.Object.of({trackId:a.l8.Number,type:a.l8.String}),a.l8.Object.of({trackId:a.l8.Number,type:a.l8.StringLiteral.of("TEXT"),trackType:a.l8.StringLiteral.of("TEXT"),trackContentId:a.l8.String,trackContentType:a.l8.String,subtype:a.l8.StringLiteral.of("SUBTITLES"),language:a.l8.String,name:a.l8.Union.of(a.l8.Undefined,a.l8.String),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}))))}),gn=a.l8.Object.of({metadataType:a.l8.NumberLiteral.of(0),title:a.l8.Union.of(a.l8.Undefined,a.l8.String),subtitle:a.l8.Union.of(a.l8.Undefined,a.l8.String),images:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Reference.of((()=>pn)))),releaseDate:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),yn=a.l8.Object.of({metadataType:a.l8.NumberLiteral.of(1),title:a.l8.Union.of(a.l8.Undefined,a.l8.String),subtitle:a.l8.Union.of(a.l8.Undefined,a.l8.String),studio:a.l8.Union.of(a.l8.Undefined,a.l8.String),images:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Reference.of((()=>pn)))),releaseDate:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),vn=a.l8.Object.of({metadataType:a.l8.NumberLiteral.of(2),seriesTitle:a.l8.Union.of(a.l8.Undefined,a.l8.String),subtitle:a.l8.Union.of(a.l8.Undefined,a.l8.String),season:a.l8.Union.of(a.l8.Undefined,a.l8.Number),episode:a.l8.Union.of(a.l8.Undefined,a.l8.Number),images:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Reference.of((()=>pn)))),originalAirDate:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),bn=a.l8.Object.of({metadataType:a.l8.NumberLiteral.of(3),albumName:a.l8.Union.of(a.l8.Undefined,a.l8.String),title:a.l8.Union.of(a.l8.Undefined,a.l8.String),albumArtist:a.l8.Union.of(a.l8.Undefined,a.l8.String),artist:a.l8.Union.of(a.l8.Undefined,a.l8.String),composer:a.l8.Union.of(a.l8.Undefined,a.l8.String),trackNumber:a.l8.Union.of(a.l8.Undefined,a.l8.Number),discNumber:a.l8.Union.of(a.l8.Undefined,a.l8.Number),images:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Reference.of((()=>pn)))),releaseDate:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),Sn=a.l8.Object.of({metadataType:a.l8.NumberLiteral.of(4),title:a.l8.Union.of(a.l8.Undefined,a.l8.String),artist:a.l8.Union.of(a.l8.Undefined,a.l8.String),location:a.l8.Union.of(a.l8.Undefined,a.l8.String),latitude:a.l8.Union.of(a.l8.Undefined,a.l8.Number),longitude:a.l8.Union.of(a.l8.Undefined,a.l8.Number),width:a.l8.Union.of(a.l8.Undefined,a.l8.Number),height:a.l8.Union.of(a.l8.Undefined,a.l8.Number),creationDateTime:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),_n=a.l8.Object.of({mediaSessionId:a.l8.Number,media:a.l8.Union.of(a.l8.Undefined,a.l8.Union.of(a.l8.Reference.of((()=>mn)),a.l8.Object.of({}))),playbackRate:a.l8.Number,playerState:a.l8.Union.of(a.l8.StringLiteral.of("IDLE"),a.l8.StringLiteral.of("PLAYING"),a.l8.StringLiteral.of("BUFFERING"),a.l8.StringLiteral.of("PAUSED")),idleReason:a.l8.Union.of(a.l8.Undefined,a.l8.Union.of(a.l8.StringLiteral.of("CANCELLED"),a.l8.StringLiteral.of("INTERRUPTED"),a.l8.StringLiteral.of("FINISHED"),a.l8.StringLiteral.of("ERROR"))),currentTime:a.l8.Number,supportedMediaCommands:a.l8.Number,volume:a.l8.Reference.of((()=>hn)),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),wn=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("LOAD"),media:a.l8.Reference.of((()=>mn)),autoplay:a.l8.Union.of(a.l8.Undefined,a.l8.Boolean),currentTime:a.l8.Union.of(a.l8.Undefined,a.l8.Number),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any)),activeTrackIds:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Number))}),On=a.l8.Object.of({mediaSessionId:a.l8.Number,requestId:a.l8.Number,type:a.l8.StringLiteral.of("PAUSE"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),En=a.l8.Object.of({mediaSessionId:a.l8.Number,requestId:a.l8.Number,type:a.l8.StringLiteral.of("SEEK"),resumeState:a.l8.Union.of(a.l8.Undefined,a.l8.Union.of(a.l8.StringLiteral.of("PLAYBACK_START"),a.l8.StringLiteral.of("PLAYBACK_PAUSE"))),currentTime:a.l8.Union.of(a.l8.Undefined,a.l8.Number),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),Rn=a.l8.Object.of({mediaSessionId:a.l8.Number,requestId:a.l8.Number,type:a.l8.StringLiteral.of("STOP"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),kn=a.l8.Object.of({mediaSessionId:a.l8.Number,requestId:a.l8.Number,type:a.l8.StringLiteral.of("PLAY"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),Tn=a.l8.Object.of({mediaSessionId:a.l8.Union.of(a.l8.Undefined,a.l8.Number),requestId:a.l8.Number,type:a.l8.StringLiteral.of("GET_STATUS"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),In=a.l8.Object.of({mediaSessionId:a.l8.Number,requestId:a.l8.Number,type:a.l8.StringLiteral.of("VOLUME"),volume:a.l8.Reference.of((()=>hn)),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),Nn=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("INVALID_PLAYER_STATE"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),jn=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("LOAD_FAILED"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),xn=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("LOAD_CANCELLED"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),Un=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("INVALID_REQUEST"),reason:a.l8.Union.of(a.l8.StringLiteral.of("INVALID_COMMAND"),a.l8.StringLiteral.of("DUPLICATE_REQUESTID")),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),An=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("MEDIA_STATUS"),status:a.l8.Array.of(a.l8.Reference.of((()=>_n))),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),Cn={LOAD:wn,PAUSE:On,SEEK:En,STOP:Rn,PLAY:kn,GET_STATUS:Tn,VOLUME:In,INVALID_PLAYER_STATE:Nn,LOAD_FAILED:jn,LOAD_CANCELLED:xn,INVALID_REQUEST:Un,MEDIA_STATUS:An},Ln={LAUNCH:a.l8.Object.of({type:a.l8.StringLiteral.of("LAUNCH"),requestId:a.l8.Number,appId:a.l8.String}),STOP:a.l8.Object.of({type:a.l8.StringLiteral.of("STOP"),requestId:a.l8.Number,sessionId:a.l8.String}),GET_STATUS:a.l8.Object.of({type:a.l8.StringLiteral.of("GET_STATUS"),requestId:a.l8.Number}),GET_APP_AVAILABILITY:a.l8.Object.of({type:a.l8.StringLiteral.of("GET_APP_AVAILABILITY"),requestId:a.l8.Number,appId:a.l8.Array.of(a.l8.String)}),SET_VOLUME:a.l8.Object.of({type:a.l8.StringLiteral.of("SET_VOLUME"),requestId:a.l8.Number,volume:a.l8.Union.of(a.l8.Object.of({level:a.l8.Number}),a.l8.Object.of({muted:a.l8.Boolean}))}),RECEIVER_STATUS:a.l8.Object.of({type:a.l8.StringLiteral.of("RECEIVER_STATUS"),requestId:a.l8.Number,status:a.l8.Object.of({applications:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Object.of({appId:a.l8.String,displayName:a.l8.String,iconUrl:a.l8.String,isIdleScreen:a.l8.Boolean,launchedFromCloud:a.l8.Boolean,namespaces:a.l8.Array.of(a.l8.Object.of({name:a.l8.String})),sessionId:a.l8.String,statusText:a.l8.String,transportId:a.l8.String}))),userEq:a.l8.Object.of({}),volume:a.l8.Object.of({controlType:a.l8.String,level:a.l8.Number,muted:a.l8.Boolean,stepInterval:a.l8.Number})})})},Dn={eng:{title:"English",iso639_1:"en",iso3166_1:"US"},swe:{title:"Swedish",iso639_1:"sv",iso3166_1:"SE"},jpn:{title:"Japanese",iso639_1:"ja",iso3166_1:"JP"}};const Pn="https://ap.joelek.se";function Bn(e){var t;let r=null!==(t=Dn[null!=e?e:"eng"])&&void 0!==t?t:Dn.eng;return{language:[r.iso639_1,r.iso3166_1].join("-"),name:r.title}}const Hn=new Set,qn=new Set;function Mn(e){!function(e){if(!qn.has(e)){qn.add(e);for(let t of Hn)try{e(t)}catch(e){}}}((r=>{return n=this,s=void 0,o=function*(){let n=yield function(e){return new Promise(((t,r)=>{let n=qr.connect({host:e,port:8009,rejectUnauthorized:!1});n.on("secureConnect",(()=>{console.log(`Connected to chromecast at ${e}.`),t(n)})),n.on("close",(()=>{console.log(`Disconnected from chromecast at ${e}.`)})),n.on("error",(e=>{n.end()}))}))}(r);n.on("close",(()=>{Hn.delete(r)}));let s=yield function(e){return new Promise(((r,n)=>{t.get(`http://${e}:8008/ssdp/device-desc.xml`,(e=>{let t=[];e.on("data",(e=>{t.push(e)})),e.on("end",(()=>{let e=Buffer.concat(t).toString(),n=/<friendlyName>([^<]+)<\/friendlyName>/.exec(e);G(n)?r(n[1]):r(void 0)})),e.on("error",(()=>{n()}))}))}))}(r);new Vn(n,null!=s?s:"Chromecast",e)},new((i=void 0)||(i=Promise))((function(e,t){function r(e){try{l(o.next(e))}catch(e){t(e)}}function a(e){try{l(o.throw(e))}catch(e){t(e)}}function l(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i((function(e){e(n)}))).then(r,a)}l((o=o.apply(n,s||[])).next())}));var n,s,i,o}))}((e,t)=>{let r=rn[e];void 0===r&&(r=new Array,rn[e]=r),r.push((e=>{if(!Hn.has(e)){Hn.add(e);for(let t of qn)try{t(e)}catch(e){}}})),(e=>{let t=Buffer.alloc(12);t.writeUInt16BE(1,4);let r=Buffer.alloc(1e3),n=0;e.split(".").forEach((e=>{if(e.length>=64)throw new Error;r.writeUInt8(e.length,n),n+=1,r.write(e,n),n+=e.length})),r.writeUInt8(0,n),n+=1,r.writeUInt16BE(12,n),n+=2,r.writeUInt16BE(1,n),n+=2,r=r.slice(0,0+n),un.send(Buffer.concat([t,r]),5353,dn)})(e)})("_googlecast._tcp.local");class Gn{constructor(e,t){this.socket=e,function(e,t){let r=Buffer.alloc(0),n=!0,s=4;e.on("data",(e=>{for(r=Buffer.concat([r,e]);r.length>=s;){let e=r.slice(0,s);r=r.slice(s),n?(n=!1,s=e.readUInt32BE(0)):(n=!0,s=4,t(e))}}))}(e,(e=>{try{let r=function(e){let t=function(e){let t=new Array;for(;e.offset<e.buffer.length;){let r=zr(e);t.push(r)}return t}({buffer:e,offset:0});return{protocol_version:Vr(1,t),source_id:Yr(2,t),destination_id:Yr(3,t),namespace:Yr(4,t),payload_type:Vr(5,t),payload_utf8:function(e,t){try{return Yr(6,t)}catch(e){return}}(0,t),payload_binary:function(e,t){try{return function(e,t){let r=t.filter((e=>7===e.key.field_number));if(0===r.length)throw"Expected required field to be present!";return r[r.length-1].data}(0,t)}catch(e){return}}(0,t)}}(e);t(r)}catch(e){console.log(e)}}))}getRequestId(){return Math.floor(65536*Math.random())}send(e){var t,r,n,s;let i=function(e){return Buffer.concat([Xr(1,e.protocol_version),Kr(2,e.source_id),Kr(3,e.destination_id),Kr(4,e.namespace),Xr(5,e.payload_type),(6,t=e.payload_utf8,null==t?Buffer.alloc(0):Kr(6,t)),Qr(7,e.payload_binary)]);var t}({protocol_version:null!==(t=e.protocol_version)&&void 0!==t?t:Br.CASTV2_1_0,source_id:null!==(r=e.source_id)&&void 0!==r?r:"sender-0",destination_id:null!==(n=e.destination_id)&&void 0!==n?n:"receiver-0",namespace:e.namespace,payload_type:null!==(s=e.payload_type)&&void 0!==s?s:Hr.STRING,payload_utf8:e.payload_utf8,payload_binary:e.payload_binary}),o=Buffer.alloc(4);o.writeUInt32BE(i.length,0),this.socket.write(o),this.socket.write(i)}}class Fn{constructor(e){this.messageHandler=e,this.serializer=new a.m7.MessageSerializer(cn),this.listeners=new Nr.routing.MessageRouter}handle(e){var t;let r=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),n=a.l8.String.as(r.type);this.serializer.deserialize(JSON.stringify({type:n,data:r}),((e,t)=>{this.listeners.route(e,t)}))}send(e,t,r){this.messageHandler.send({namespace:Fn.NAMESPACE,destination_id:r,payload_utf8:JSON.stringify(t)})}}Fn.NAMESPACE="urn:x-cast:com.google.cast.tp.connection";class $n{constructor(e){this.messageHandler=e,this.serializer=new a.m7.MessageSerializer(fn),this.listeners=new Nr.routing.MessageRouter}handle(e){var t;let r=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),n=a.l8.String.as(r.type);this.serializer.deserialize(JSON.stringify({type:n,data:r}),((e,t)=>{this.listeners.route(e,t)}))}send(e,t){this.messageHandler.send({namespace:$n.NAMESPACE,payload_utf8:JSON.stringify(t)})}}$n.NAMESPACE="urn:x-cast:com.google.cast.tp.heartbeat";class Jn{constructor(e){this.transportId=new Ut(void 0),this.mediaSessionId=new Ut(void 0),this.messageHandler=e,this.serializer=new a.m7.MessageSerializer(Cn),this.callbacks=new Map,this.listeners=new Nr.routing.MessageRouter}handle(e){var t;let r=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),n=a.l8.String.as(r.type);try{this.serializer.deserialize(JSON.stringify({type:n,data:r}),((e,t)=>{let r=this.callbacks.get(t.requestId);G(r)&&(this.callbacks.delete(t.requestId),r(t)),this.listeners.route(e,t)}))}catch(e){console.log(JSON.stringify(r,null,2))}}send(e,t,r){t.requestId=this.messageHandler.getRequestId(),G(r)&&this.callbacks.set(t.requestId,r),this.messageHandler.send({namespace:Jn.NAMESPACE,destination_id:this.transportId.getState(),payload_utf8:JSON.stringify(t)})}}Jn.NAMESPACE="urn:x-cast:com.google.cast.media";class zn{constructor(e){this.messageHandler=e,this.serializer=new a.m7.MessageSerializer(Ln),this.callbacks=new Map,this.listeners=new Nr.routing.MessageRouter}handle(e){var t;let r=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),n=a.l8.String.as(r.type);this.serializer.deserialize(JSON.stringify({type:n,data:r}),((e,t)=>{let r=this.callbacks.get(t.requestId);G(r)&&(this.callbacks.delete(t.requestId),r(t)),this.listeners.route(e,t)}))}send(e,t,r){t.requestId=this.messageHandler.getRequestId(),G(r)&&this.callbacks.set(t.requestId,r),this.messageHandler.send({namespace:zn.NAMESPACE,payload_utf8:JSON.stringify(t)})}}zn.NAMESPACE="urn:x-cast:com.google.cast.receiver";const Wn="CC1AD845";class Vn{constructor(e,t,r){let n=new Gn(e,(e=>{let t=e.namespace;t===Fn.NAMESPACE?this.connectionHandler.handle(e):t===$n.NAMESPACE?this.heartbeatHandler.handle(e):t===Jn.NAMESPACE?this.mediaHandler.handle(e):t===zn.NAMESPACE&&this.receiverHandler.handle(e)}));this.socket=e,this.heartbeatHandler=new $n(n),this.connectionHandler=new Fn(n),this.mediaHandler=new Jn(n),this.receiverHandler=new zn(n);let s=`${r?"wss:":"ws:"}//127.0.0.1/sockets/context/?type=chromecast&name=${t}`;this.context=new Ur(s,(e=>new Ar.yU(e))),this.timer=void 0,e.on("close",(()=>{G(this.timer)&&clearTimeout(this.timer),this.context.close()})),this.connectionHandler.send("CONNECT",{type:"CONNECT"}),this.connectionHandler.listeners.addObserver("CLOSE",(e=>{this.mediaHandler.transportId.updateState(void 0)})),this.heartbeatHandler.listeners.addObserver("PING",(e=>{this.heartbeatHandler.send("PONG",{type:"PONG"})})),this.heartbeatHandler.listeners.addObserver("PONG",(e=>{this.setTimer()})),this.receiverHandler.listeners.addObserver("RECEIVER_STATUS",(e=>{var t;let r=(null!==(t=e.status.applications)&&void 0!==t?t:[]).find((e=>e.appId===Wn));G(r)?this.mediaHandler.transportId.updateState(r.transportId):this.mediaHandler.transportId.updateState(void 0)})),this.mediaHandler.listeners.addObserver("MEDIA_STATUS",(e=>{let t=e.status[e.status.length-1];if(G(t)){let e=this.mediaHandler.mediaSessionId.getState();G(e)&&(t.mediaSessionId===e?this.context.isDeviceLocal.getState()&&"IDLE"===t.playerState&&"FINISHED"===t.idleReason&&this.context.next():this.mediaHandler.mediaSessionId.updateState(void 0))}})),this.setTimer(),this.mediaHandler.transportId.addObserver((e=>{G(e)&&this.connectionHandler.send("CONNECT",{type:"CONNECT"},e)})),this.context.isDeviceLocal.addObserver((e=>{if(e)M(this.mediaHandler.transportId.getState())&&this.receiverHandler.send("LAUNCH",{type:"LAUNCH",requestId:-1,appId:Wn});else{let e=this.mediaHandler.mediaSessionId.getState();G(e)&&this.mediaHandler.send("STOP",{type:"STOP",requestId:-1,mediaSessionId:e})}}));{let e=()=>{let e=this.mediaHandler.transportId.getState(),t=this.context.currentLocalEntry.getState(),r=this.context.token.getState();if(G(e)&&G(t)&&G(r)){let e,n=function(e,t){if(ar.is(e)){let r=e,n=r.season.show;return{contentId:`${Pn}/files/${e.segment.file.file_id}/?token=${t}`,contentType:r.segment.file.mime,streamType:"BUFFERED",metadata:{metadataType:0,title:r.title,subtitle:n.title},tracks:r.segment.subtitles.map(((e,r)=>Object.assign(Object.assign({},Bn(e.language)),{trackId:r,type:"TEXT",trackType:"TEXT",trackContentId:`${Pn}/files/${e.file.file_id}/?token=${t}`,trackContentType:e.file.mime,subtype:"SUBTITLES"})))}}if(tr.is(e)){let r=e;return{contentId:`${Pn}/files/${e.segment.file.file_id}/?token=${t}`,contentType:r.segment.file.mime,streamType:"BUFFERED",metadata:{metadataType:0,title:r.title,images:M(r.artwork)?void 0:[{url:`${Pn}/files/${r.artwork.file_id}/?token=${t}`}]},tracks:r.segment.subtitles.map(((e,r)=>Object.assign(Object.assign({},Bn(e.language)),{trackId:r,type:"TEXT",trackType:"TEXT",trackContentId:`${Pn}/files/${e.file.file_id}/?token=${t}`,trackContentType:e.file.mime,subtype:"SUBTITLES"})))}}if(Ft.is(e)){let r=e,n=r.disc.album;return{contentId:`${Pn}/files/${e.segment.file.file_id}/?token=${t}`,contentType:e.segment.file.mime,streamType:"BUFFERED",metadata:{metadataType:0,title:r.title,subtitle:r.artists.map((e=>e.title)).join("  "),images:M(n.artwork)?void 0:[{url:`${Pn}/files/${n.artwork.file_id}/?token=${t}`}]}}}throw"Expected code to be unreachable!"}(t,r);if(G(n.tracks)){let t=n.tracks.find((e=>"sv-SE"===e.language));if(G(t))e=[t.trackId];else{let t=n.tracks.find((e=>"en-US"===e.language));if(G(t))e=[t.trackId];else{let t=n.tracks.find((e=>"ja-JP"===e.language));G(t)&&(e=[t.trackId])}}}this.mediaHandler.send("LOAD",{type:"LOAD",requestId:-1,media:n,autoplay:!1,activeTrackIds:e},(e=>{if(An.is(e)){let t=e.status[e.status.length-1];G(t)&&this.mediaHandler.mediaSessionId.updateState(t.mediaSessionId)}}))}};this.mediaHandler.transportId.addObserver(e),this.context.currentLocalEntry.addObserver(e),this.context.token.addObserver(e)}this.mediaHandler.transportId.addObserver((e=>{M(e)&&this.context.isDeviceLocal.getState()&&this.context.transfer(void 0)})),this.mediaHandler.transportId.addObserver((e=>{M(e)&&this.mediaHandler.mediaSessionId.updateState(void 0)}));{let e=()=>{let e=this.mediaHandler.mediaSessionId.getState();G(e)&&(this.context.playback.getState()?this.mediaHandler.send("PLAY",{type:"PLAY",requestId:-1,mediaSessionId:e}):this.mediaHandler.send("PAUSE",{type:"PAUSE",requestId:-1,mediaSessionId:e}))};this.mediaHandler.mediaSessionId.addObserver(e),this.context.playback.addObserver(e)}{let e=()=>{var e;let t=this.mediaHandler.mediaSessionId.getState();if(G(t)){let r=null!==(e=this.context.progress.getState())&&void 0!==e?e:0;this.mediaHandler.send("SEEK",{type:"SEEK",requestId:-1,mediaSessionId:t,currentTime:r})}};this.mediaHandler.mediaSessionId.addObserver(e),this.context.progress.addObserver(e)}}setTimer(){G(this.timer)&&(clearTimeout(this.timer),this.timer=void 0),this.timer=setTimeout((()=>{this.timer=void 0,this.heartbeatHandler.send("PING",{type:"PING"}),this.timer=setTimeout((()=>{this.socket.destroy()}),5e3)}),5e3)}}const Xn=new class{constructor(){this.tokens=new Map,this.sessions=new Map,this.chromecasts=new Ut([]),this.tss=new Cr(Ir),this.tss.addEventListener("sys","connect",(e=>{console.log("connect: "+e.connection_url);let t=Dr(e.connection_id,e.connection_url);this.tss.send("SetLocalDevice",e.connection_id,{device:t}),"chromecast"===t.type&&this.chromecasts.updateState([...this.chromecasts.getState(),t])})),this.tss.addEventListener("sys","disconnect",(e=>{console.log("disconnect: "+e.connection_url);let t=Dr(e.connection_id,e.connection_url);this.revokeAuthentication(e.connection_id),"chromecast"===t.type&&this.chromecasts.updateState(this.chromecasts.getState().filter((e=>e.id!==t.id)))})),this.tss.addEventListener("app","SetToken",(e=>{this.revokeAuthentication(e.connection_id);let t=e.data.token;if(G(t)){let r=vt(t);this.tokens.set(e.connection_id,t);let n=this.getSession(r),s=Dr(e.connection_id,e.connection_url);n.devices.updateState([...n.devices.getState(),s]),this.tss.send("SetContext",e.connection_id,{context:n.context}),this.tss.send("SetDevice",e.connection_id,{device:n.device}),this.tss.send("SetIndex",e.connection_id,{index:n.index}),this.tss.send("SetPlayback",e.connection_id,{playback:n.playback}),this.tss.send("SetProgress",e.connection_id,{progress:n.progress}),this.tss.send("SetToken",e.connection_id,{token:t})}})),this.tss.addEventListener("app","SetContext",(e=>{this.getExistingSession(e.connection_id,(t=>{M(t.device)&&(t.device=Dr(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),t.index=void 0,this.tss.send("SetIndex",t.devices.getState().map((e=>e.id)),{index:t.index}),t.context=e.data.context,this.tss.send("SetContext",t.devices.getState().map((e=>e.id)),e.data)}))})),this.tss.addEventListener("app","SetDevice",(e=>{this.getExistingSession(e.connection_id,(t=>{this.updateProgress(t),this.tss.send("SetProgress",t.devices.getState().map((e=>e.id)),{progress:t.progress}),t.device=e.data.device,this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),e.data),G(t.device)&&this.tss.send("SetToken",t.device.id,{token:this.tokens.get(e.connection_id)})}))})),this.tss.addEventListener("app","SetIndex",(e=>{this.getExistingSession(e.connection_id,(t=>{M(t.device)&&(t.device=Dr(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),t.progress=G(e.data.index)?0:void 0,t.progressTimestamp=Date.now(),this.tss.send("SetProgress",t.devices.getState().map((e=>e.id)),{progress:t.progress}),t.index=e.data.index,this.tss.send("SetIndex",t.devices.getState().map((e=>e.id)),e.data)}))})),this.tss.addEventListener("app","SetPlayback",(e=>{this.getExistingSession(e.connection_id,(t=>{M(t.device)&&(t.device=Dr(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),this.updateProgress(t),t.playback=e.data.playback,this.tss.send("SetPlayback",t.devices.getState().map((e=>e.id)),e.data)}))})),this.tss.addEventListener("app","SetProgress",(e=>{this.getExistingSession(e.connection_id,(t=>{M(t.device)&&(t.device=Dr(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),t.progress=e.data.progress,t.progressTimestamp=Date.now(),this.tss.send("SetProgress",t.devices.getState().map((e=>e.id)),e.data)}))}))}getExistingSession(e,t){let r=this.tokens.get(e);if(G(r)){let e=vt(r),n=this.sessions.get(e);G(n)&&t(n)}}getSession(e){let t=this.sessions.get(e);if(G(t))return t;const r={playback:!1,devices:new Ut(new Array)};let n=new Ut([]);{let e=()=>{let e=r.devices.getState(),t=this.chromecasts.getState().filter((t=>M(e.find((e=>e.id===t.id)))));n.updateState([...e,...t])};r.devices.addObserver(e),this.chromecasts.addObserver(e)}return n.addObserver((e=>{this.tss.send("SetDevices",r.devices.getState().map((e=>e.id)),{devices:e})})),r.devices.addObserver((e=>{this.updateProgress(r)})),r.devices.addObserver((e=>{M(e.find((e=>{var t;return e.id===(null===(t=r.device)||void 0===t?void 0:t.id)})))&&(this.updateProgress(r),r.playback=!1,this.tss.send("SetPlayback",e.map((e=>e.id)),{playback:r.playback}),r.device=void 0,this.tss.send("SetDevice",e.map((e=>e.id)),{device:r.device}))})),this.sessions.set(e,r),r}revokeAuthentication(e){let t=this.tokens.get(e);if(this.tokens.delete(e),G(t)){let r=vt(t),n=this.sessions.get(r);if(G(n)){let t=n.devices;t.updateState(t.getState().filter((t=>t.id!==e)))}}}updateProgress(e){let t=Date.now();e.playback&&G(e.progress)&&G(e.progressTimestamp)&&(e.progress+=(t-e.progressTimestamp)/1e3),e.progressTimestamp=t}getRequestHandler(){return this.tss.getRequestHandler()}};function Yn(t,r){t.headers.host;let n=t.method||"",o=t.url||"";if(/^[/]sockets[/]/.test(o))return Xn.getRequestHandler()(t,r);let a,l=Date.now();if(r.on("finish",(()=>{let e=Date.now()-l;process.stderr.write(`${r.statusCode} ${n}:${o} (${e} ms)\n`)})),"GET"===n&&"/favicon.ico"===o)return r.writeHead(404),void r.end();if("GET"===n&&null!==(a=/^[/]files[/]([0-9a-f]{32})[/]/.exec(o))){return((t,r,n)=>{if(void 0===r.url)throw new Error;let o="";try{var a=i.parse(r.url,!0);o=vt(a.query.token)}catch(e){return n.writeHead(401,{}),n.end()}let l,d=se.lookup(t),u=d.path,c=d.mime,f=u.join(s.sep),p=e.openSync(f,"r"),h=e.fstatSync(p).size;e.closeSync(p);let m=r.headers.range;if(void 0!==m&&null!=(l=/^bytes\=((?:[0-9])|(?:[1-9][0-9]+))\-((?:[0-9])|(?:[1-9][0-9]+))?$/.exec(m))){let r=parseInt(l[1]),s=l[2]?parseInt(l[2]):null;if(null===s&&(s=h-1),r>=h||s>=h||s<r)return n.writeHead(416),void n.end();let i=s-r+1;n.writeHead(206,{"Access-Control-Allow-Origin":"*","Accept-Ranges":"bytes","Cache-Control":"private, max-age=86400","Content-Range":`bytes ${r}-${s}/${h}`,"Content-Type":c,"Content-Length":""+i}),(g=e.createReadStream(f,{start:r,end:s})).addListener("close",(()=>{r+g.bytesRead===h&&function(t,r){let n=Date.now();W.streams.push({username:t,file_id:r,timestamp_ms:n}),ge.insert(r,{file_id:r,username:t,timestamp_ms:n}),e.writeFileSync("./private/db/streams.json",JSON.stringify(W,null,"\t"))}(o,t)})),g.on("open",(function(){g.pipe(n)})),g.on("error",(function(e){n.end()}))}else{var g;(g=e.createReadStream(f)).on("open",(function(){n.writeHead(200,{"Access-Control-Allow-Origin":"*","Accept-Ranges":"bytes","Cache-Control":"private, max-age=86400","Content-Type":c,"Content-Length":""+h}),g.pipe(n)})),g.on("error",(function(e){n.writeHead(404),n.end()}))}})(a[1],t,r)}if(/^[/]media[/]/.test(o)){if(null!=(a=/^[/]media[/]stills[/]([0-9a-f]{32})[/]/.exec(o))){let t=a[1],n=[".","private","stills",se.lookup(t).file_id];if(!e.existsSync(n.join("/")))return r.writeHead(404),r.end();{let t=e.createReadStream(n.join("/"));t.on("open",(()=>{r.writeHead(200,{"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=86400","Content-Type":"image/jpeg"}),t.pipe(r)}))}return}if(null!=(a=/^[/]media[/]gifs[/]([0-9a-f]{32})[/]/.exec(o))){let t=a[1],n=He.lookup(t),s=[".","private","memes",n.cue_id];if(e.existsSync(s.join("/"))){let t=e.createReadStream(s.join("/"));t.on("open",(()=>{r.writeHead(200,{"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=86400","Content-Type":"image/gif"}),t.pipe(r)}))}else!function(e,t,r){let n=Y.video.subtitles.find((e=>e.subtitle_id===t.subtitle_id)),s=Y.files.find((e=>e.file_id===n.file_id));const i=function(e){return se.lookup(e.video_file_id)}(n);if(null==i)return r();It(((n,o)=>{let a=[...n,"subtitle.vtt"],l=[...n,"palette.png"],d=[...n,"meme.gif"],u=wt.spawn("ffmpeg",["-ss",q(t.start_ms),"-t",q(Math.min(t.duration_ms,5e3)),"-i",[".",...s.path].join("/"),a.join("/"),"-y"]);u.on("error",(()=>(console.log("ffmpeg command failed!"),jt(n.join("/")),r()))),u.on("exit",(()=>{wt.spawn("ffmpeg",["-ss",q(t.start_ms),"-t",q(Math.min(t.duration_ms,5e3)),"-i",[".",...i.path].join("/"),"-vf","fps=15,scale=w=384:h=216:force_original_aspect_ratio=decrease,pad=384:216:-1:-1,subtitles="+a.join("/")+":force_style='Bold=1,Fontsize=24,Outline=2',palettegen",l.join("/"),"-y"]).on("exit",(()=>{wt.spawn("ffmpeg",["-ss",q(t.start_ms),"-t",q(Math.min(t.duration_ms,5e3)),"-i",[".",...i.path].join("/"),"-i",l.join("/"),"-filter_complex","fps=15,scale=w=384:h=216:force_original_aspect_ratio=decrease,pad=384:216:-1:-1,subtitles="+a.join("/")+":force_style='Bold=1,Fontsize=24,Outline=2'[x];[x][1:v]paletteuse","-map_metadata","-1",d.join("/"),"-y"]).on("exit",(()=>(Nt(d,e),jt(n.join("/")),r())))}))}))}))}(s,n,(()=>{if(!e.existsSync(s.join("/")))return r.writeHead(500),r.end();let t=e.createReadStream(s.join("/"));t.on("open",(()=>{r.writeHead(200,{"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=86400","Content-Type":"image/gif"}),t.pipe(r)}))}));return}}return/^[/]api[/]/.test(o)?((e,t)=>{try{_t.route(e,t)}catch(e){t.writeHead(500),t.end(JSON.stringify({error:""+e}))}})(t,r):"/manifest.json"===o?(r.writeHead(200,{"Content-Type":"application/json; charset=utf-8"}),r.end(JSON.stringify({name:"Orbit",start_url:"/",display:"standalone",theme_color:"#df4f7f",background_color:"#1f1f1f",icons:[]}))):"/logo.png"===o?(r.writeHead(200,{"Content-Type":"image/png"}),void e.createReadStream("./public/logo.png").pipe(r)):"GET"===n?(r.writeHead(200),void r.end(`<!doctype html><html><head><base href="/"/><meta charset="utf-8"/><meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0" name="viewport"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" /><link rel="apple-touch-icon" href="logo.png" /><link rel="manifest" href="/manifest.json"/><link href="https://fonts.googleapis.com/css2?family=Nunito&family=Pacifico&family=Space+Mono&display=swap" rel="stylesheet"/><title>Orbit</title></head><body><script>${e.readFileSync("./dist/client.min.js")}<\/script></body></html>`)):(console.log("unhandled",JSON.stringify(t.headers,null,"\t")),r.writeHead(400),void r.end())}function Kn(t){if(e.existsSync(t))return e.readFileSync(t)}e.existsSync("./private/certs/")||e.mkdirSync("./private/certs/",{recursive:!0});let Qn=Kn("./private/certs/full_chain.pem"),Zn=Kn("./private/certs/dhparam.pem"),es=Kn("./private/certs/certificate_key.pem");if(Qn&&es){let e=n.createServer({cert:Qn,dhparam:Zn,key:es},Yn);e.listen(443,(()=>{console.log("https://localhost:443")})),e.keepAliveTimeout=6e4,t.createServer({},((e,t)=>{let r=e.headers.host||"",n=e.url||"",s=r.split(":").shift();t.writeHead(307,{Location:"https://"+s+":443"+n}),t.end()})).listen(80,(()=>{console.log("http://localhost:80")})),Mn(!0)}else{let e=t.createServer({},Yn);e.listen(80,(()=>{console.log("http://localhost:80")})),e.keepAliveTimeout=6e4,Mn(!1)}})()})();