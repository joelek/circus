(()=>{"use strict";var e={375:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Union=t.Undefined=t.Tuple=t.StringLiteral=t.String=t.Reference=t.Record=t.Object=t.NumberLiteral=t.Number=t.Null=t.Intersection=t.BooleanLiteral=t.Boolean=t.Array=t.Any=void 0,t.Any={as:(e,t="")=>e,is(e){try{this.as(e)}catch(e){return!1}return!0}},t.Array={of:e=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Array){for(let n=0;n<t.length;n++)e.as(t[n],r+"["+n+"]");return t}throw"Expected an array at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Boolean={as(e,t=""){if(null!=e&&e.constructor===globalThis.Boolean)return e;throw"Expected a boolean at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.BooleanLiteral={of:e=>({as(t,r=""){if(t===e)return t;throw"Expected "+e+" at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Intersection={of:(...e)=>({as(t,r=""){for(let n of e)n.as(t,r);return t},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Null={as(e,t=""){if(null===e)return e;throw"Expected null at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.Number={as(e,t=""){if(null!=e&&e.constructor===globalThis.Number)return e;throw"Expected a number at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.NumberLiteral={of:e=>({as(t,r=""){if(t===e)return t;throw"Expected "+e+" at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Object={of:e=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Object){for(let n in e)e[n].as(t[n],r+/^([a-z][a-z0-9_]*)$/is.test(n)?"."+n:'["'+n+'"]');return t}throw"Expected an object at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Record={of:e=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Object){for(let n of globalThis.Object.keys(t))e.as(t[n],r+'["'+n+'"]');return t}throw"Expected a record at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Reference={of:e=>({as:(t,r="")=>e().as(t,r),is:t=>e().is(t)})},t.String={as(e,t=""){if(null!=e&&e.constructor===globalThis.String)return e;throw"Expected a string at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.StringLiteral={of:e=>({as(t,r=""){if(t===e)return t;throw'Expected "'+e+'" at '+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Tuple={of:(...e)=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Array){for(let n=0;n<e.length;n++)e[n].as(t[n],r+"["+n+"]");return t}throw"Expected a tuple at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Undefined={as(e,t=""){if(void 0===e)return e;throw"Expected undefined at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.Union={of:(...e)=>({as(t,r=""){for(let n of e)try{return n.as(t,r)}catch(e){}throw"Expected a union at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})}},175:(e,t,r)=>{t.m7=t.l8=void 0;const n=r(375);t.l8=n;r(226);const i=r(129);t.m7=i;r(329)},226:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Schema=t.UnionType=t.UndefinedType=t.TupleType=t.StringLiteralType=t.StringType=t.ReferenceType=t.RecordType=t.ObjectType=t.NumberLiteralType=t.NumberType=t.NullType=t.IntersectionType=t.GroupType=t.BooleanLiteralType=t.BooleanType=t.ArrayType=t.AnyType=t.Type=void 0;const n=r(329);t.Type={parse(e,...t){try{return S.parse(e,...t)}catch(e){}try{return d.parse(e,...t)}catch(e){}try{return s.parse(e,...t)}catch(e){}try{return i.parse(e)}catch(e){}try{return o.parse(e)}catch(e){}try{return a.parse(e)}catch(e){}try{return u.parse(e)}catch(e){}try{return c.parse(e)}catch(e){}try{return f.parse(e)}catch(e){}try{return m.parse(e)}catch(e){}try{return v.parse(e)}catch(e){}try{return b.parse(e)}catch(e){}try{return g.parse(e)}catch(e){}try{return y.parse(e)}catch(e){}try{return p.parse(e)}catch(e){}try{return l.parse(e)}catch(e){}try{return h.parse(e)}catch(e){}return e.newContext(((e,t)=>{let r=e();throw`Unexpected ${r.family} at row ${r.row}, col ${r.col}!`}))}};class i{constructor(){}generateType(e){return"any"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\treturn subject;"),t.push("}")):t.push("autoguard.Any"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"any"),i.INSTANCE)))}}t.AnyType=i,i.INSTANCE=new i;class s{constructor(e){this.type=e}generateType(e){return this.type.generateType(e)+"[]"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Array)) {"),t.push("\t\tfor (let i = 0; i < subject.length; i++) {"),t.push("\t\t\t("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t\t"}))+')(subject[i], path + "[" + i + "]");'),t.push("\t\t}"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected an array at " + path + "!";'),t.push("}")):t.push("autoguard.Array.of("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}static parse(e,...r){if(r.includes("Array"))throw"Recursion prevention!";return e.newContext(((i,o)=>{let a=t.Type.parse(e,...r,"Array");n.expect(i(),"["),n.expect(i(),"]");let l=new s(a);for(;;)try{e.newContext(((e,t)=>{n.expect(e(),"["),n.expect(e(),"]"),l=new s(l)}))}catch(e){break}return l}))}}t.ArrayType=s;class o{constructor(){}generateType(e){return"boolean"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Boolean)) {"),t.push("\t\treturn subject as boolean;"),t.push("\t}"),t.push('\tthrow "Expected a boolean at " + path + "!";'),t.push("}")):t.push("autoguard.Boolean"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"boolean"),o.INSTANCE)))}}t.BooleanType=o,o.INSTANCE=new o;class a{constructor(e){this.value=e}generateType(e){return""+this.value}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+") {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected '+this.value+' at " + path + "!";'),t.push("}")):t.push("autoguard.BooleanLiteral.of("+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>"true"===n.expect(e(),["true","false"]).family?a.INSTANCE_TRUE:a.INSTANCE_FALSE))}}t.BooleanLiteralType=a,a.INSTANCE_TRUE=new a(!0),a.INSTANCE_FALSE=new a(!1);class l{constructor(e){this.type=e}generateType(e){return"("+this.type.generateType(e)+")"}generateTypeGuard(e){return this.type.generateTypeGuard(e)}static parse(e){return e.newContext(((r,i)=>{n.expect(r(),"(");let s=t.Type.parse(e);return n.expect(r(),")"),new l(s)}))}}t.GroupType=l;class d{constructor(){this.types=new Set}add(e){return this.types.add(e),this}generateType(e){let t=new Array;for(let r of this.types)t.push(r.generateType(e));return t.join(" & ")}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {");for(let r of this.types)t.push("\t("+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+")(subject, path);");return t.push("\treturn subject;"),t.push("}"),t.join(e.eol)}for(let r of this.types)t.push("\t"+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"autoguard.Intersection.of("+e.eol+t.join(","+e.eol)+e.eol+")"}static parse(e,...r){if(r.includes("Intersection"))throw"Recursion prevention!";return e.newContext(((i,s)=>{var o;let a=t.Type.parse(e,...r,"Intersection"),l=new d;for(l.add(a);"&"===(null===(o=s())||void 0===o?void 0:o.value);){n.expect(i(),"&");let s=t.Type.parse(e,...r,"Intersection");l.add(s)}return 1===l.types.size?a:l}))}}t.IntersectionType=d;class u{constructor(){}generateType(e){return"null"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === null) {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected null at " + path + "!";'),t.push("}")):t.push("autoguard.Null"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"null"),u.INSTANCE)))}}t.NullType=u,u.INSTANCE=new u;class c{constructor(){}generateType(e){return"number"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Number)) {"),t.push("\t\treturn subject as number;"),t.push("\t}"),t.push('\tthrow "Expected a number at " + path + "!";'),t.push("}")):t.push("autoguard.Number"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"number"),c.INSTANCE)))}}t.NumberType=c,c.INSTANCE=new c;class f{constructor(e){this.value=e}generateType(e){return""+this.value}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+") {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected '+this.value+' at " + path + "!";'),t.push("}")):t.push("autoguard.NumberLiteral.of("+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>{let r=n.expect(e(),"NUMBER_LITERAL").value;return new f(Number.parseInt(r))}))}}t.NumberLiteralType=f;class p{constructor(){this.members=new Map}add(e,t){return this.members.set(e,t),this}generateType(e){if(0===this.members.size)return"{}";let t=new Array;for(let[r,n]of this.members)t.push('\t"'+r+'"'+(n.optional?"?":"")+": "+n.type.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"{"+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+"}"}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Object)) {");for(let[r,n]of this.members){let i=n.type;if(n.optional){let e=new S;e.add(b.INSTANCE),e.add(i),i=e}let s=/^([a-z][a-z0-9_]*)$/is.test(r)?'".'+r+'"':'"[\\"'+r+'\\"]"';t.push("\t\t("+i.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+')(subject["'+r+'"], path + '+s+");")}return t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected an object at " + path + "!";'),t.push("}"),t.join(e.eol)}for(let[r,n]of this.members){let i=n.type;if(n.optional){let e=new S;e.add(b.INSTANCE),e.add(i),i=e}t.push('\t"'+r+'": '+i.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})))}return"autoguard.Object.of<"+(null!=this.typename?this.typename:this.generateType(e))+">({"+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+"})"}setTypename(e){this.typename=e}static parse(e){return e.newContext(((r,i)=>{var s,o,a;n.expect(r(),"{");let l=new p;if("}"!==(null===(s=i())||void 0===s?void 0:s.value))for(;;){let s=!1,d=n.expect(r(),["any","boolean","false","null","number","string","true","undefined","IDENTIFIER","STRING_LITERAL"]),u="STRING_LITERAL"===d.family?d.value.slice(1,-1):d.value;"?"===(null===(o=i())||void 0===o?void 0:o.value)&&(r(),s=!0),n.expect(r(),":");let c=t.Type.parse(e);if(l.add(u,{type:c,optional:s}),","!==(null===(a=i())||void 0===a?void 0:a.value))break;n.expect(r(),",")}return n.expect(r(),"}"),l}))}}t.ObjectType=p;class h{constructor(e){this.type=e}generateType(e){return"Record<string, undefined | "+this.type.generateType(e)+">"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Object)) {"),t.push("\t\tfor (let key of globalThis.Object.keys(subject)) {"),t.push("\t\t\t("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t\t"}))+')(subject[key], path + "[\\"" + key + "\\"]");'),t.push("\t\t}"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected a record at " + path + "!";'),t.push("}")):t.push("autoguard.Record.of("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}static parse(e){return e.newContext(((r,i)=>{n.expect(r(),"{");let s=t.Type.parse(e);return n.expect(r(),"}"),new h(s)}))}}t.RecordType=h;class g{constructor(e){this.typename=e}generateType(e){return this.typename}generateTypeGuard(e){return e.standalone?this.typename+".as":"autoguard.Reference.of<"+this.typename+">(() => "+this.typename+")"}static parse(e){return e.newContext(((e,t)=>{var r;"@"===(null===(r=t())||void 0===r?void 0:r.family)&&n.expect(e(),"@");let i=n.expect(e(),"IDENTIFIER").value;return new g(i)}))}}t.ReferenceType=g;class m{constructor(){}generateType(e){return"string"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.String)) {"),t.push("\t\treturn subject as string;"),t.push("\t}"),t.push('\tthrow "Expected a string at " + path + "!";'),t.push("}")):t.push("autoguard.String"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"string"),m.INSTANCE)))}}t.StringType=m,m.INSTANCE=new m;class v{constructor(e){this.value=e}generateType(e){return'"'+this.value+'"'}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+") {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected \\"'+this.value+'\\" at " + path + "!";'),t.push("}")):t.push('autoguard.StringLiteral.of("'+this.value+'")'),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>{let r=n.expect(e(),"STRING_LITERAL").value;return new v(r.slice(1,-1))}))}}t.StringLiteralType=v;class y{constructor(){this.types=new Array}add(e){return this.types.push(e),this}generateType(e){let t=new Array;for(let r of this.types)t.push("\t"+r.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"["+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+"]"}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Array)) {");for(let r=0;r<this.types.length;r++){let n=this.types[r];t.push("\t\t("+n.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+")(subject["+r+'], path + "['+r+']");')}return t.push("\t\treturn subject as "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+";"),t.push("\t}"),t.push('\tthrow "Expected a tuple at " + path + "!";'),t.push("}"),t.join(e.eol)}for(let r of this.types)t.push("\t"+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"autoguard.Tuple.of("+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+")"}static parse(e){return e.newContext(((r,i)=>{var s,o;n.expect(r(),"[");let a=new y;if("]"!==(null===(s=i())||void 0===s?void 0:s.value))for(;;){let s=t.Type.parse(e);if(a.add(s),","!==(null===(o=i())||void 0===o?void 0:o.value))break;n.expect(r(),",")}return n.expect(r(),"]"),a}))}}t.TupleType=y;class b{constructor(){}generateType(e){return"undefined"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === undefined) {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected undefined at " + path + "!";'),t.push("}")):t.push("autoguard.Undefined"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"undefined"),b.INSTANCE)))}}t.UndefinedType=b,b.INSTANCE=new b;class S{constructor(){this.types=new Set}add(e){return this.types.add(e),this}generateType(e){let t=new Array;for(let r of this.types)t.push(r.generateType(e));return t.join(" | ")}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {");for(let r of this.types)t.push("\ttry {"),t.push("\t\treturn ("+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+")(subject, path);"),t.push("\t} catch (error) {}");return t.push('\tthrow "Expected a union at " + path + "!";'),t.push("}"),t.join(e.eol)}for(let r of this.types)t.push("\t"+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"autoguard.Union.of("+e.eol+t.join(","+e.eol)+e.eol+")"}static parse(e,...r){if(r.includes("Union"))throw"Recursion prevention!";return e.newContext(((i,s)=>{var o;let a=t.Type.parse(e,...r,"Union"),l=new S;for(l.add(a);"|"===(null===(o=s())||void 0===o?void 0:o.value);){n.expect(i(),"|");let s=t.Type.parse(e,...r,"Union");l.add(s)}return 1===l.types.size?a:l}))}}t.UnionType=S;class _{constructor(){this.types=new Map}add(e,t){return this.types.set(e,t),this}generateModule(e){let t=new Array;t.push("// This file was auto-generated by @joelek/ts-autoguard. Edit at own risk."),t.push(""),e.standalone||(t.push('import { guards as autoguard } from "@joelek/ts-autoguard";'),t.push(""));for(let[r,n]of this.types)t.push("export type "+r+" = "+n.generateType(e)+";"),t.push(""),e.standalone?(t.push("export const "+r+" = {"),t.push('\tas(subject: any, path: string = ""): '+r+" {"),t.push("\t\treturn ("+n.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+")(subject, path);"),t.push("\t},"),t.push("\tis(subject: any): subject is "+r+" {"),t.push("\t\ttry {"),t.push("\t\t\tthis.as(subject);"),t.push("\t\t} catch (error) {"),t.push("\t\t\treturn false;"),t.push("\t\t}"),t.push("\t\treturn true;"),t.push("\t}"),t.push("};"),t.push("")):(t.push("export const "+r+" = "+n.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol}))+";"),t.push(""));let r=new p;for(let[e,t]of this.types)r.add(e,{type:new g(e),optional:!1});return t.push("export type Autoguard = "+r.generateType(e)+";"),t.push(""),t.push("export const Autoguard = "+r.generateType(e)+";"),t.push(""),t.join(e.eol)}static parse(e){return e.newContext(((r,i)=>{var s,o,a;n.expect(r(),"{");let l=new _;if("}"!==(null===(s=i())||void 0===s?void 0:s.value))for(;;){let s=n.expect(r(),"IDENTIFIER").value;n.expect(r(),":");let d=t.Type.parse(e);if(null===(o=d.setTypename)||void 0===o||o.call(d,s),l.add(s,d),","!==(null===(a=i())||void 0===a?void 0:a.value))break;n.expect(r(),",")}if(n.expect(r(),"}"),null!=i())throw"Expected end of stream!";return l}))}}t.Schema=_},129:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MessageSerializer=void 0,t.MessageSerializer=class{constructor(e){this.guards=e}deserialize(e,t){let r=JSON.parse(e);if(null==r||r.constructor!==Object||null==r.type||r.type.constructor!==String)throw"Invalid message envelope!";{let e=r.type,n=r.data,i=this.guards[e];if(void 0===i)throw'Unknown message type "'+e+'"!';t(e,i.as(n))}}serialize(e,t){return JSON.stringify({type:e,data:t})}}},329:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.expect=t.Tokenizer=t.Families=void 0,t.Families=["WS","(",")","[","]","{","}","?","|","&","@",",",":","any","boolean","false","null","number","string","true","undefined","IDENTIFIER","NUMBER_LITERAL","STRING_LITERAL"],t.Tokenizer=class{constructor(e){let t={WS:/^([\t\r\n ]+)/ius,"(":/^([\(])/ius,")":/^([\)])/ius,"[":/^([\[])/ius,"]":/^([\]])/ius,"{":/^([\{])/ius,"}":/^([\}])/ius,"?":/^([\?])/ius,"|":/^([\|])/ius,"&":/^([&])/ius,"@":/^([@])/ius,",":/^([,])/ius,":":/^([:])/ius,any:/^(any)/ius,boolean:/^(boolean)/ius,false:/^(false)/ius,null:/^(null)/ius,number:/^(number)/ius,string:/^(string)/ius,true:/^(true)/ius,undefined:/^(undefined)/ius,IDENTIFIER:/^([a-z][a-z0-9_]*)/ius,NUMBER_LITERAL:/^(([1-9][0-9]+)|([0-9]))/ius,STRING_LITERAL:/^(["][^"]*["])/ius},r=new Array,n=1,i=1;for(;e.length>0;){let s;for(let r in t){let n=r,i=t[n].exec(e);null!=i&&(null==s||i[1].length>s[1].length)&&(s=[n,i[1]])}if(null==s)throw`Unrecognized token at row ${n}, col ${i}!`;r.push({family:s[0],value:s[1],row:n,col:i}),e=e.slice(s[1].length);let o=s[1].split(/\r?\n/);o.length>1&&(n+=o.length-1,i=1),i+=o[o.length-1].length}this.tokens=r.filter((e=>"WS"!==e.family)),this.offset=0}peek(){return this.tokens[this.offset]}read(){if(this.offset>=this.tokens.length)throw"Unexpectedly reached end of stream!";return this.tokens[this.offset++]}newContext(e){let t=this.offset;try{return e((()=>this.read()),(()=>this.peek()))}catch(e){throw this.offset=t,e}}},t.expect=function(e,t){if(!(Array.isArray(t)?t:[t]).includes(e.family))throw`Unexpected ${e.family} at row ${e.row}, col ${e.col}!`;return e}},745:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketClient=void 0;const n=r(417),i=r(605),s=r(211),o=r(835),a=r(978),l=r(410),d=r(93),u=r(611),c=r(302);t.WebSocketClient=class{constructor(e){var t;this.state=u.ReadyState.CONNECTING,this.listeners=new a.routing.MessageRouter,this.pending=new Array,this.socket=void 0;let r=n.randomBytes(16).toString("base64"),d={Connection:"upgrade",Host:null!==(t=o.parse(e).host)&&void 0!==t?t:"","Sec-WebSocket-Key":r,"Sec-WebSocket-Version":"13",Upgrade:"websocket"};(()=>{if(e.startsWith("wss:"))return function(e,t){return new Promise(((r,n)=>{s.get(e,t).on("upgrade",((e,t,n)=>{r({response:e,socket:t,buffer:n})})).on("error",n)}))}("https:"+e.substring(4),{headers:d,rejectUnauthorized:!1});if(e.startsWith("ws:"))return function(e,t){return new Promise(((r,n)=>{i.get(e,t).on("upgrade",((e,t,n)=>{r({response:e,socket:t,buffer:n})})).on("error",n)}))}("http:"+e.substring(3),{headers:d});throw`Expected ${e} to be a WebSocket URL!`})().then((e=>{var t,i;let s=e.response,o=e.socket,a=e.buffer;if(o.on("close",(()=>{this.state=u.ReadyState.CLOSED,this.listeners.route("close",void 0)})),o.on("error",(()=>{this.state=u.ReadyState.CLOSING,this.listeners.route("error",void 0),o.end()})),101!==s.statusCode)return o.emit("error");if("upgrade"!==(null===(t=c.getHeader(s,"Connection"))||void 0===t?void 0:t.toLowerCase()))return o.emit("error");if("websocket"!==(null===(i=c.getHeader(s,"Upgrade"))||void 0===i?void 0:i.toLowerCase()))return o.emit("error");let d=n.createHash("sha1").update(r+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11").digest("base64");if(c.getHeader(s,"Sec-WebSocket-Accept")!==d)return o.emit("error");this.socket=o;let f=()=>{for(;;)try{let e={buffer:a,offset:0},t=l.decodeFrame(e);this.onFrame(o,t),a=a.slice(e.offset)}catch(e){break}};this.socket.on("data",(e=>{a=Buffer.concat([a,e]),f()})),this.state=u.ReadyState.OPEN,this.listeners.route("open",void 0),f()}))}onFrame(e,t){if(0!==t.reserved1||0!==t.reserved2||0!==t.reserved3)return this.close(u.StatusCode.PROTOCOL_ERROR);if(t.opcode<8){if(t.opcode!==l.WebSocketFrameType.CONTINUATION&&t.opcode!==l.WebSocketFrameType.TEXT&&t.opcode!=l.WebSocketFrameType.BINARY)return this.close(u.StatusCode.PROTOCOL_ERROR);if(0===this.pending.length){if(t.opcode===l.WebSocketFrameType.CONTINUATION)return this.close(u.StatusCode.PROTOCOL_ERROR)}else if(t.opcode!==l.WebSocketFrameType.CONTINUATION)return this.close(u.StatusCode.PROTOCOL_ERROR);if(this.pending.push(t.payload),1===t.final){let e=Buffer.concat(this.pending);this.pending.splice(0),this.listeners.route("message",{data:e.toString()})}}else{if(1!==t.final)return this.close(u.StatusCode.PROTOCOL_ERROR);if(t.payload.length>125)return this.close(u.StatusCode.PROTOCOL_ERROR);if(t.opcode===l.WebSocketFrameType.CLOSE){if(this.readyState===u.ReadyState.CLOSING)return e.end();e.write(l.encodeFrame(Object.assign(Object.assign({},t),{masked:1})),(()=>e.end()))}else if(t.opcode===l.WebSocketFrameType.PING)e.write(l.encodeFrame(Object.assign(Object.assign({},t),{opcode:10,masked:1})));else if(t.opcode!==l.WebSocketFrameType.PONG)return this.close(u.StatusCode.PROTOCOL_ERROR)}}addEventListener(e,t){this.listeners.addObserver(e,t)}close(e){if(this.state!==u.ReadyState.OPEN)throw"Expected socket to be open!";const t=this.socket;if(d.absent(t))throw"Expected socket to be open!";let r=Buffer.alloc(0);d.present(e)&&(r=Buffer.concat([Buffer.alloc(2),Buffer.from("Connection closed by client.")]),r.writeUInt16BE(e,0));let n=l.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:l.WebSocketFrameType.CLOSE,masked:1,payload:r});t.write(n),this.state=u.ReadyState.CLOSING}removeEventListener(e,t){this.listeners.removeObserver(e,t)}send(e){if(this.state!==u.ReadyState.OPEN)throw"Expected socket to be open!";let t=this.socket;if(d.absent(t))throw"Expected socket to be open!";let r=l.WebSocketFrameType.BINARY;e instanceof Buffer||(e=Buffer.from(e,"utf8"),r=l.WebSocketFrameType.TEXT);let n=l.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:r,masked:1,payload:e});t.write(n)}get readyState(){return this.state}}},410:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.encodeFrame=t.decodeFrame=t.WebSocketFrameType=void 0;const n=r(417);var i;(i=t.WebSocketFrameType||(t.WebSocketFrameType={}))[i.CONTINUATION=0]="CONTINUATION",i[i.TEXT=1]="TEXT",i[i.BINARY=2]="BINARY",i[i.UNUSED_3=3]="UNUSED_3",i[i.UNUSED_4=4]="UNUSED_4",i[i.UNUSED_5=5]="UNUSED_5",i[i.UNUSED_6=6]="UNUSED_6",i[i.UNUSED_7=7]="UNUSED_7",i[i.CLOSE=8]="CLOSE",i[i.PING=9]="PING",i[i.PONG=10]="PONG",i[i.UNUSED_B=11]="UNUSED_B",i[i.UNUSED_C=12]="UNUSED_C",i[i.UNUSED_D=13]="UNUSED_D",i[i.UNUSED_E=14]="UNUSED_E",i[i.UNUSED_F=15]="UNUSED_F",t.decodeFrame=function(e){let t=e.buffer.readUInt8(e.offset)>>7&1,r=e.buffer.readUInt8(e.offset)>>6&1,n=e.buffer.readUInt8(e.offset)>>5&1,i=e.buffer.readUInt8(e.offset)>>4&1,s=e.buffer.readUInt8(e.offset)>>0&15;e.offset+=1;let o=e.buffer.readUInt8(e.offset)>>7&1,a=e.buffer.readUInt8(e.offset)>>0&127;if(e.offset+=1,126===a){if(a=e.buffer.readUInt16BE(e.offset),e.offset+=2,a<=125)throw"Invalid frame encoding!"}else if(127===a){if(0!==e.buffer.readUInt32BE(e.offset))throw"Invalid frame encoding!";if(e.offset+=4,a=e.buffer.readUInt32BE(e.offset),e.offset+=4,a<=65535)throw"Invalid frame encoding!"}let l=Buffer.alloc(4);if(1===o&&(l=e.buffer.slice(e.offset,e.offset+4),e.offset+=4),e.offset+a>e.buffer.length)throw"Invalid frame encoding!";let d=e.buffer.slice(e.offset,e.offset+a);if(e.offset+=a,1===o)for(let e=0;e<d.length;e++)d[e]=d[e]^l[3&e];return{final:t,reserved1:r,reserved2:n,reserved3:i,opcode:s,masked:o,payload:d}},t.encodeFrame=function(e){let t=new Array,r=e.payload.length,i=Buffer.alloc(2);t.push(i);let s=0;if(s|=(1&e.final)<<7,s|=(1&e.reserved1)<<6,s|=(1&e.reserved2)<<5,s|=(1&e.reserved3)<<4,s|=(15&e.opcode)<<0,i.writeUInt8(s,0),r<=125){let t=0;t|=(1&e.masked)<<7,t|=(127&r)<<0,i.writeUInt8(t,1)}else if(r<=65535){let n=0;n|=(1&e.masked)<<7,n|=126,i.writeUInt8(n,1);let s=Buffer.alloc(2);s.writeUInt16BE(r,0),t.push(s)}else{if(!(r<=4294967295))throw"Invalid frame size!";{let n=0;n|=(1&e.masked)<<7,n|=127,i.writeUInt8(n,1);let s=Buffer.alloc(8);s.writeUInt32BE(r,4),t.push(s)}}if(1===e.masked){let r=n.randomBytes(4),i=Buffer.concat([e.payload]);for(let e=0;e<i.length;e++)i[e]=i[e]^r[3&e];t.push(r,i)}else t.push(e.payload);return Buffer.concat(t)}},545:(e,t,r)=>{r(745),r(410),r(447),r(611);var n=r(745);Object.defineProperty(t,"yU",{enumerable:!0,get:function(){return n.WebSocketClient}});var i=r(447);Object.defineProperty(t,"u9",{enumerable:!0,get:function(){return i.WebSocketServer}})},93:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.present=t.absent=void 0,t.absent=function(e){return null==e},t.present=function(e){return null!=e}},447:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketServer=void 0;const n=r(417),i=r(16),s=r(978),o=r(410),a=r(93),l=r(611),d=r(302);t.WebSocketServer=class{constructor(){this.pending_chunks=new Map,this.states=new Map,this.connections=new d.BiMap,this.router=new s.routing.MessageRouter}onFrame(e,t,r,n){if(0!==n.reserved1||0!==n.reserved2||0!==n.reserved3)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(1!==n.masked)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(n.opcode<8){if(n.opcode!==o.WebSocketFrameType.CONTINUATION&&n.opcode!==o.WebSocketFrameType.TEXT&&n.opcode!=o.WebSocketFrameType.BINARY)return this.close(e,l.StatusCode.PROTOCOL_ERROR);{let r=this.pending_chunks.get(e);if(a.absent(r))r=new Array,this.pending_chunks.set(e,r);else if(n.opcode!==o.WebSocketFrameType.CONTINUATION)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(r.push(n.payload),1===n.final){let n=Buffer.concat(r);this.pending_chunks.delete(e),this.router.route("message",{connection_id:e,connection_url:t,buffer:n})}}}else{if(1!==n.final)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(n.payload.length>125)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(n.opcode===o.WebSocketFrameType.CLOSE){if(this.states.get(e)===l.ReadyState.CLOSING)return r.end();r.write(o.encodeFrame(Object.assign(Object.assign({},n),{masked:0})),(()=>r.end()))}else if(n.opcode===o.WebSocketFrameType.PING)r.write(o.encodeFrame(Object.assign(Object.assign({},n),{opcode:10,masked:0})));else if(n.opcode!==o.WebSocketFrameType.PONG)return this.close(e,l.StatusCode.PROTOCOL_ERROR)}}broadcast(e){for(let[t,r]of this.connections)this.states.get(t)===l.ReadyState.OPEN&&this.send(t,e)}addEventListener(e,t){return this.router.addObserver(e,t)}close(e,t){if(this.states.get(e)!==l.ReadyState.OPEN)throw"Expected socket to be open!";const r=this.connections.value(e);if(a.absent(r))throw'Connection with id "'+e+'" has no socket!';let n=Buffer.alloc(0);a.present(t)&&(n=Buffer.concat([Buffer.alloc(2),Buffer.from("Connection closed by server.")]),n.writeUInt16BE(t,0));let i=o.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:o.WebSocketFrameType.CLOSE,masked:0,payload:n});r.write(i),this.states.set(e,l.ReadyState.CLOSING)}getRequestHandler(){return(e,t)=>{let r=e.socket,s=this.connections.key(r);if(a.present(s))return t.writeHead(400),t.end();let u=e.httpVersionMajor,c=e.httpVersionMinor;if(u<1||1===u&&c<1)return t.writeHead(400),t.end();if("GET"!==e.method)return t.writeHead(400),t.end();let f=d.getHeader(e,"Host");if(a.absent(f))return t.writeHead(400),t.end();let p=d.getHeader(e,"Upgrade");if(a.absent(p)||"websocket"!==p.toLowerCase())return t.writeHead(400),t.end();let h=d.getHeader(e,"Connection");if(a.absent(h)||"upgrade"!==h.toLowerCase())return t.writeHead(400),t.end();let g=d.getHeader(e,"Sec-WebSocket-Key");if(a.absent(g)||16!==Buffer.from(g,"base64").length)return t.writeHead(400),t.end();if("13"!==d.getHeader(e,"Sec-WebSocket-Version"))return t.writeHead(426,{"Sec-WebSocket-Version":"13"}),t.end();let m=n.createHash("sha1").update(g+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11").digest("base64");return t.writeHead(101,{Upgrade:"websocket",Connection:"Upgrade","Sec-WebSocket-Accept":m}),t.end((()=>{let t=n.randomBytes(16).toString("hex"),s=function(e){let t=e.headers.host||"",r=e.url||"/";return`${e.socket instanceof i.TLSSocket?"wss:":"ws:"}//${t}${r}`}(e),a=Buffer.alloc(0);r.on("data",(e=>{for(a=Buffer.concat([a,e]);;)try{let e={buffer:a,offset:0},n=o.decodeFrame(e);this.onFrame(t,s,r,n),a=a.slice(e.offset)}catch(e){break}})),r.on("close",(()=>{this.connections.remove(t),this.states.delete(t),this.router.route("disconnect",{connection_id:t,connection_url:s})})),r.setTimeout(0),this.connections.add(t,r),this.states.set(t,l.ReadyState.OPEN),this.router.route("connect",{connection_id:t,connection_url:s})}))}}removeEventListener(e,t){return this.router.removeObserver(e,t)}send(e,t){if(this.states.get(e)!==l.ReadyState.OPEN)throw"Expected socket to be open!";let r=this.connections.value(e);if(a.absent(r))throw'Connection with id "'+e+'" has no socket!';let n=o.WebSocketFrameType.BINARY;t instanceof Buffer||(t=Buffer.from(t,"utf8"),n=o.WebSocketFrameType.TEXT);let i=o.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:n,masked:0,payload:t});r.write(i)}}},611:(e,t)=>{var r,n;Object.defineProperty(t,"__esModule",{value:!0}),t.StatusCode=t.ReadyState=void 0,(n=t.ReadyState||(t.ReadyState={}))[n.CONNECTING=0]="CONNECTING",n[n.OPEN=1]="OPEN",n[n.CLOSING=2]="CLOSING",n[n.CLOSED=3]="CLOSED",(r=t.StatusCode||(t.StatusCode={}))[r.NORMAL=1e3]="NORMAL",r[r.GOING_AWAY=1001]="GOING_AWAY",r[r.PROTOCOL_ERROR=1002]="PROTOCOL_ERROR",r[r.DATA_TYPE_NOT_ACCEPTED=1003]="DATA_TYPE_NOT_ACCEPTED",r[r.RESERVED_1004=1004]="RESERVED_1004",r[r.RESERVED_1005=1005]="RESERVED_1005",r[r.RESERVED_1006=1006]="RESERVED_1006",r[r.BAD_DATA_TYPE=1007]="BAD_DATA_TYPE",r[r.POLICY_VIOLATION=1008]="POLICY_VIOLATION",r[r.MESSAGE_TOO_BIG=1009]="MESSAGE_TOO_BIG",r[r.CLIENT_EXPECTED_EXTENSION=1010]="CLIENT_EXPECTED_EXTENSION",r[r.SERVER_UNEXPECTED_CONDITION=1011]="SERVER_UNEXPECTED_CONDITION",r[r.RESERVED_1015=1015]="RESERVED_1015"},302:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BiMap=t.getHeader=void 0;const n=r(93);t.getHeader=function(e,t){let r=e.headers[t.toLowerCase()];if(n.present(r)){if(r.constructor===String)return r;if(r.constructor===Array&&1===r.length)return r[0]}return null};class i{constructor(){this.value_to_key=new Map,this.key_to_value=new Map}[Symbol.iterator](){return this.key_to_value[Symbol.iterator]()}add(e,t){this.value_to_key.set(t,e),this.key_to_value.set(e,t)}key(e){return this.value_to_key.get(e)||null}remove(e){let t=this.key_to_value.get(e);n.present(t)&&this.value_to_key.delete(t),this.key_to_value.delete(e)}value(e){return this.key_to_value.get(e)||null}}t.BiMap=i},978:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.routing=r(220)},220:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.NamespacedMessageRouter=t.MessageRouter=void 0;class r{constructor(){this.observers=new Map}addObserver(e,t){let r=this.observers.get(e);void 0===r&&(r=new Set,this.observers.set(e,r)),r.add(t)}removeObserver(e,t){let r=this.observers.get(e);void 0!==r&&r.delete(t)}route(e,t){let r=this.observers.get(e);if(void 0!==r)for(let e of r)e(t)}}t.MessageRouter=r,t.NamespacedMessageRouter=class{constructor(){this.routers=new Map}addObserver(e,t,n){let i=this.routers.get(e);void 0===i&&(i=new r,this.routers.set(e,i)),i.addObserver(t,n)}removeObserver(e,t,r){let n=this.routers.get(e);void 0!==n&&n.removeObserver(t,r)}route(e,t,r){let n=this.routers.get(e);void 0!==n&&n.route(t,r)}}},417:e=>{e.exports=require("crypto")},605:e=>{e.exports=require("http")},211:e=>{e.exports=require("https")},16:e=>{e.exports=require("tls")},835:e=>{e.exports=require("url")}},t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={exports:{}};return e[n](i,i.exports,r),i.exports}(()=>{const e=require("fs");var t=r(605),n=r(211);const i=require("path");var s=r(835),o=r(417),a=r(175);const l=a.l8.Object.of({person_id:a.l8.String,name:a.l8.String}),d=a.l8.Object.of({movie_id:a.l8.String,person_id:a.l8.String}),u=a.l8.Object.of({show_id:a.l8.String,person_id:a.l8.String}),c=a.l8.Object.of({artist_id:a.l8.String,title:a.l8.String}),f=a.l8.Object.of({album_id:a.l8.String,title:a.l8.String,year:a.l8.Number,cover_file_id:a.l8.Union.of(a.l8.String,a.l8.Null)}),p=a.l8.Object.of({disc_id:a.l8.String,album_id:a.l8.String,number:a.l8.Number}),h=a.l8.Object.of({track_id:a.l8.String,disc_id:a.l8.String,file_id:a.l8.String,title:a.l8.String,number:a.l8.Number,duration:a.l8.Number}),g=a.l8.Object.of({album_id:a.l8.String,artist_id:a.l8.String}),m=a.l8.Object.of({track_id:a.l8.String,artist_id:a.l8.String}),v=a.l8.Object.of({video_genre_id:a.l8.String,title:a.l8.String}),y=a.l8.Object.of({movie_id:a.l8.String,title:a.l8.String,year:a.l8.Number,summary:a.l8.Union.of(a.l8.String,a.l8.Null),poster_file_id:a.l8.Union.of(a.l8.String,a.l8.Null)}),b=a.l8.Object.of({movie_id:a.l8.String,video_genre_id:a.l8.String}),S=a.l8.Object.of({movie_part_id:a.l8.String,movie_id:a.l8.String,file_id:a.l8.String,duration:a.l8.Number,number:a.l8.Number}),_=a.l8.Object.of({show_id:a.l8.String,title:a.l8.String,summary:a.l8.Union.of(a.l8.Undefined,a.l8.String),poster_file_id:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),w=a.l8.Object.of({show_id:a.l8.String,video_genre_id:a.l8.String}),O=a.l8.Object.of({season_id:a.l8.String,show_id:a.l8.String,number:a.l8.Number}),E=a.l8.Object.of({episode_id:a.l8.String,season_id:a.l8.String,file_id:a.l8.String,title:a.l8.String,number:a.l8.Number,duration:a.l8.Number,year:a.l8.Union.of(a.l8.Number,a.l8.Null),summary:a.l8.Union.of(a.l8.String,a.l8.Null)}),R=a.l8.Object.of({subtitle_id:a.l8.String,file_id:a.l8.String,video_file_id:a.l8.String,language:a.l8.Union.of(a.l8.String,a.l8.Null)}),T=a.l8.Object.of({subtitle_id:a.l8.String,cues:a.l8.Array.of(a.l8.Tuple.of(a.l8.Number,a.l8.Number,a.l8.String))}),k=a.l8.Object.of({cue_id:a.l8.String,subtitle_id:a.l8.String,start_ms:a.l8.Number,duration_ms:a.l8.Number,lines:a.l8.Array.of(a.l8.String)}),N=a.l8.Object.of({file_id:a.l8.String,path:a.l8.Array.of(a.l8.String),mime:a.l8.String}),I=a.l8.Object.of({audio:a.l8.Object.of({artists:a.l8.Array.of(a.l8.Reference.of((()=>c))),albums:a.l8.Array.of(a.l8.Reference.of((()=>f))),discs:a.l8.Array.of(a.l8.Reference.of((()=>p))),tracks:a.l8.Array.of(a.l8.Reference.of((()=>h))),album_artists:a.l8.Array.of(a.l8.Reference.of((()=>g))),track_artists:a.l8.Array.of(a.l8.Reference.of((()=>m)))}),video:a.l8.Object.of({genres:a.l8.Array.of(a.l8.Reference.of((()=>v))),movie_parts:a.l8.Array.of(a.l8.Reference.of((()=>S))),movies:a.l8.Array.of(a.l8.Reference.of((()=>y))),movie_genres:a.l8.Array.of(a.l8.Reference.of((()=>b))),movie_persons:a.l8.Array.of(a.l8.Reference.of((()=>d))),shows:a.l8.Array.of(a.l8.Reference.of((()=>_))),show_genres:a.l8.Array.of(a.l8.Reference.of((()=>w))),show_persons:a.l8.Array.of(a.l8.Reference.of((()=>u))),seasons:a.l8.Array.of(a.l8.Reference.of((()=>O))),episodes:a.l8.Array.of(a.l8.Reference.of((()=>E))),subtitles:a.l8.Array.of(a.l8.Reference.of((()=>R))),subtitle_contents:a.l8.Array.of(a.l8.Reference.of((()=>T))),cues:a.l8.Array.of(a.l8.Reference.of((()=>k)))}),persons:a.l8.Array.of(a.l8.Reference.of((()=>l))),files:a.l8.Array.of(a.l8.Reference.of((()=>N)))}),j=(a.l8.Record.of(a.l8.Array.of(a.l8.String)),a.l8.Object.of({audiolist_id:a.l8.String,title:a.l8.String,description:a.l8.String,user_id:a.l8.String})),x=a.l8.Object.of({audiolist_id:a.l8.String,track_id:a.l8.String,number:a.l8.Number}),U=a.l8.Object.of({audiolists:a.l8.Array.of(a.l8.Reference.of((()=>j))),audiolist_items:a.l8.Array.of(a.l8.Reference.of((()=>x)))}),A=a.l8.Object.of({user_id:a.l8.String,name:a.l8.String,username:a.l8.String,password:a.l8.String}),C=a.l8.Object.of({username:a.l8.String,selector:a.l8.String,validator_hash:a.l8.String,expires_ms:a.l8.Number}),L=a.l8.Object.of({users:a.l8.Array.of(a.l8.Reference.of((()=>A))),tokens:a.l8.Array.of(a.l8.Reference.of((()=>C)))}),D=a.l8.Object.of({username:a.l8.String,file_id:a.l8.String,timestamp_ms:a.l8.Number}),P=a.l8.Object.of({streams:a.l8.Array.of(a.l8.Reference.of((()=>D)))});function B(...e){return e.map((e=>String(e))).join("")}function H(e){let t=e;return t=t.toLowerCase(),t=t.normalize("NFC"),Array.from(t.match(/(\p{L}+|\p{N}+)/gu)||[]).filter((e=>e.length>=3))}function q(e){let t=Math.floor(e/1e3);e-=1e3*t;let r=Math.floor(t/60);t-=60*r;let n=Math.floor(r/60);r-=60*n;let i=B("00",n).slice(-2),s=B("00",r).slice(-2),o=B("00",t).slice(-2),a=B("000",e).slice(-3);return B(i,":",s,":",o,".",a)}const M=(...e)=>(t,r)=>{for(let n of e){let e=n(t,r);if(0!==e)return e}return 0},G=e=>(t,r)=>{let n=e(t),i=e(r);return null==n?null==i?0:1:null==i?null==n?0:-1:n.localeCompare(i)},F=e=>(t,r)=>{let n=e(t),i=e(r);return null==n?null==i?0:-1:null==i?null==n?0:1:i-n},$=e=>(t,r)=>{let n=e(t),i=e(r);return null==n?null==i?0:1:null==i?null==n?0:-1:n-i};function J(e){return null==e}function z(e){return null!=e}if(e.mkdirSync("./private/db/",{recursive:!0}),!e.existsSync("./private/db/streams.json")){let t={streams:[]};e.writeFileSync("./private/db/streams.json",JSON.stringify(t,null,"\t"))}if(!e.existsSync("./private/db/lists.json")){let t={audiolists:[],audiolist_items:[]};e.writeFileSync("./private/db/lists.json",JSON.stringify(t,null,"\t"))}if(!e.existsSync("./private/db/users.json")){let t={users:[{user_id:o.randomBytes(16).toString("hex"),name:"Test User",username:"test",password:function(e){let t=o.randomBytes(16),r=o.scryptSync("test",t,32,{N:16384,r:8,p:1,maxmem:33554432}),n=Buffer.alloc(4);return n[0]=0,n[1]=14,n[2]=8,n[3]=1,`$s0$${n.toString("hex")}$${t.toString("base64")}$${r.toString("base64")}`}()}],tokens:[]};e.writeFileSync("./private/db/users.json",JSON.stringify(t,null,"\t"))}e.existsSync("./private/db/media.json")||(process.stderr.write("Media database not found! Please run the indexer.\n"),process.exit(1));let W=P.as(JSON.parse(e.readFileSync("./private/db/streams.json","utf8"))),V=U.as(JSON.parse(e.readFileSync("./private/db/lists.json","utf8"))),X=L.as(JSON.parse(e.readFileSync("./private/db/users.json","utf8"))),Y=I.as(JSON.parse(e.readFileSync("./private/db/media.json","utf8")));X.tokens=X.tokens.filter((e=>e.expires_ms>Date.now())),e.writeFileSync("./private/db/users.json",JSON.stringify(X,null,"\t"));for(let e of Y.video.subtitle_contents){let t=e.subtitle_id;for(let r of e.cues){let e=r[0],n=r[1],i=r[2].split("\n"),s=o.createHash("md5").update(t).update(""+e).digest("hex");Y.video.cues.push({cue_id:s,subtitle_id:t,start_ms:e,duration_ms:n,lines:i})}}class K{constructor(){this.map=new Map}insert(e,t){this.map.set(e,t)}lookup(e){let t=this.map.get(e);if(null==t)throw`Expected "${e}" to match a record!`;return t}remove(e){this.map.delete(e)}static from(e,t){let r=new K;for(let n of t)r.insert(n[e],n);return r}}class Q{constructor(){this.map=new Map}insert(e,t){let r=this.map.get(e);r||(r=new Set,this.map.set(e,r)),r.add(t)}lookup(e){let t=this.map.get(e);return t?Array.from(t):new Array}remove(e,t){let r=this.map.get(e);r&&(r.delete(t),0===r.size&&this.map.delete(e))}static from(e,t){let r=new Q;for(let n of t)r.insert(n[e],n);return r}}const Z=Q.from("show_id",Y.video.show_persons),ee=Q.from("person_id",Y.video.show_persons),te=Q.from("movie_id",Y.video.movie_persons),re=Q.from("person_id",Y.video.movie_persons),ne=K.from("person_id",Y.persons),ie=K.from("file_id",Y.files),se=K.from("movie_id",Y.video.movies),oe=K.from("file_id",Y.video.episodes),ae=K.from("file_id",Y.video.movie_parts);let le=Q.from("movie_id",Y.video.movie_parts),de=Q.from("show_id",Y.video.show_genres),ue=Q.from("movie_id",Y.video.movie_genres);const ce=Q.from("video_genre_id",Y.video.movie_genres);let fe=Q.from("video_genre_id",Y.video.show_genres),pe=K.from("video_genre_id",Y.video.genres),he=Q.from("show_id",Y.video.seasons),ge=Q.from("season_id",Y.video.episodes),me=Q.from("file_id",W.streams);function ve(e){return le.lookup(e)}function ye(e){return ue.lookup(e).map((e=>pe.lookup(e.video_genre_id)))}let be=Q.from("album_id",Y.audio.album_artists);const Se=Q.from("artist_id",Y.audio.album_artists);let _e=Q.from("track_id",Y.audio.track_artists),we=Q.from("artist_id",Y.audio.track_artists),Oe=Q.from("video_file_id",Y.video.subtitles);const Ee=Q.from("album_id",Y.audio.discs),Re=Q.from("disc_id",Y.audio.tracks),Te=K.from("album_id",Y.audio.albums),ke=Q.from("audiolist_id",V.audiolist_items),Ne=K.from("track_id",Y.audio.tracks),Ie=K.from("disc_id",Y.audio.discs),je=K.from("user_id",X.users),xe=K.from("username",X.users),Ue=K.from("audiolist_id",V.audiolists),Ae=K.from("show_id",Y.video.shows),Ce=K.from("artist_id",Y.audio.artists),Le=K.from("episode_id",Y.video.episodes),De=K.from("season_id",Y.video.seasons),Pe=K.from("subtitle_id",Y.video.subtitles),Be=K.from("cue_id",Y.video.cues);Q.from("subtitle_id",Y.video.cues);class He{constructor(){this.map=new Map}insert(e,t){let r=this.map.get(e);r||(r=new Set,this.map.set(e,r)),r.add(t)}lookup(e){let t=this.map.get(e);return t?new Set(t):new Set}remove(e,t){let r=this.map.get(e);r&&(r.delete(t),0===r.size&&this.map.delete(e))}search(e){var t;let r=H(e),n=r.map((e=>this.map.get(e))).filter(z),i=new Map;for(let e of n)for(let n of e){let e=null!==(t=i.get(n))&&void 0!==t?t:0-r.length;i.set(n,e+2)}return Array.from(i.entries()).filter((e=>e[1]>=0)).sort($((e=>e[1]))).map((e=>({value:e[0],rank:e[1]})))}static from(e,t){let r=new He;for(let n of e)for(let e of t(n)){let t=H(e);for(let e of t)r.insert(e,n)}return r}}const qe=He.from(Y.audio.artists,(e=>[e.title])),Me=He.from(Y.audio.albums,(e=>[e.title])),Ge=He.from(Y.audio.tracks,(e=>[e.title])),Fe=He.from(Y.video.shows,(e=>[e.title])),$e=He.from(Y.video.movies,(e=>[e.title])),Je=He.from(Y.video.episodes,(e=>[e.title])),ze=He.from(V.audiolists,(e=>[e.title])),We=He.from(X.users,(e=>[e.name,e.username])),Ve=He.from(Y.video.cues,(e=>e.lines)),Xe=He.from(Y.persons,(e=>[e.name]));function Ye(e,t){var r;return(null===(r=function(e,t){return me.lookup(t).filter((t=>t.username===e)).sort($((e=>e.timestamp_ms)))}(e,t).pop())||void 0===r?void 0:r.timestamp_ms)||null}const Ke=K.from("selector",X.tokens);function Qe(e,t){let r=Te.lookup(e);return{album_id:r.album_id,title:r.title,year:r.year,artists:be.lookup(r.album_id).map((e=>Ce.lookup(e.artist_id))),artwork:J(r.cover_file_id)?void 0:{file_id:r.cover_file_id,mime:"image/jpeg",height:1080,width:1080}}}function Ze(e,t){let r=Qe(e);return Object.assign(Object.assign({},r),{discs:Ee.lookup(e).map((e=>rt(e.disc_id,0,r)))})}function et(e,t){let r=function(e,t){let r=Ce.lookup(e);return{artist_id:r.artist_id,title:r.title}}(e);return Object.assign(Object.assign({},r),{albums:Se.lookup(e).map((e=>Ze(e.album_id)))})}function tt(e,t,r){let n=Ie.lookup(e);return{disc_id:n.disc_id,album:z(r)?r:Qe(n.album_id),number:n.number}}function rt(e,t,r){let n=tt(e,0,r),i=Re.lookup(e).map((e=>{let t={track_id:e.track_id,title:e.title,disc:n,artists:_e.lookup(e.track_id).map((e=>Ce.lookup(e.artist_id))),number:e.number,last_stream_date:void 0};return Object.assign(Object.assign({},t),{segment:{file:{file_id:e.file_id,mime:"audio/mp4",duration_ms:e.duration}}})}));return Object.assign(Object.assign({},n),{tracks:i})}function nt(e,t,r){let n=Le.lookup(e),i=function(e,t,r){var n,i,s;let o=Le.lookup(e);return{episode_id:o.episode_id,title:o.title,summary:null!==(n=o.summary)&&void 0!==n?n:"",number:o.number,season:z(r)?r:lt(o.season_id,t),year:null!==(i=o.year)&&void 0!==i?i:void 0,last_stream_date:z(t)&&null!==(s=Ye(t,o.file_id))&&void 0!==s?s:void 0}}(e,t,r),s={file:{file_id:n.file_id,mime:"video/mp4",duration_ms:n.duration,height:0,width:0},subtitles:Oe.lookup(n.file_id).map((e=>{var t;return{subtitle_id:e.subtitle_id,file:{file_id:e.file_id,mime:"text/vtt"},language:null!==(t=e.language)&&void 0!==t?t:void 0,cues:[]}}))};return Object.assign(Object.assign({},i),{segment:s})}function it(e,t){let r=function(e,t){let r=pe.lookup(e);return{genre_id:r.video_genre_id,title:r.title}}(e);return Object.assign({},r)}function st(e,t){let r=function(e,t){var r,n;let i=se.lookup(e),s=ve(e);return{movie_id:i.movie_id,title:i.title,year:i.year,summary:null!==(r=i.summary)&&void 0!==r?r:"",artwork:J(i.poster_file_id)?void 0:{file_id:i.poster_file_id,mime:"image/jpeg",height:720,width:1080},last_stream_date:z(t)&&null!==(n=Ye(t,s[0].file_id))&&void 0!==n?n:void 0,genres:ue.lookup(e).map((e=>{let t=pe.lookup(e.video_genre_id);return{genre_id:t.video_genre_id,title:t.title}})),actors:te.lookup(e).map((e=>ot(e.person_id)))}}(e,t),n=ve(e),i=Oe.lookup(n[0].file_id),s={file:{file_id:n[0].file_id,mime:"video/mp4",duration_ms:n[0].duration,height:0,width:0},subtitles:i.map((e=>{var t;return{subtitle_id:e.subtitle_id,file:{file_id:e.file_id,mime:"text/vtt"},language:null!==(t=e.language)&&void 0!==t?t:void 0,cues:[]}}))};return Object.assign(Object.assign({},r),{segment:s})}function ot(e,t){let r=function(e,t){let r=ne.lookup(e);return{person_id:r.person_id,name:r.name}}(e);return Object.assign({},r)}function at(e,t){let r=function(e,t){let r=Ue.lookup(e);return{playlist_id:r.audiolist_id,title:r.title,description:r.description,user:ht(r.user_id)}}(e),n=ke.lookup(r.playlist_id).map((e=>({playlist:r,number:e.number,track:pt(e.track_id)})));return Object.assign(Object.assign({},r),{items:n})}function lt(e,t,r){let n=De.lookup(e);return{season_id:n.season_id,number:n.number,show:z(r)?r:ut(n.show_id)}}function dt(e,t,r){let n=lt(e,0,r),i=ge.lookup(n.season_id).map((e=>nt(e.episode_id,t,n)));return Object.assign(Object.assign({},n),{episodes:i})}function ut(e,t){var r;let n=Ae.lookup(e);return{show_id:n.show_id,title:n.title,summary:null!==(r=n.summary)&&void 0!==r?r:"",artwork:J(n.poster_file_id)?void 0:{file_id:n.poster_file_id,mime:"image/jpeg",height:1080,width:720},genres:(i=e,de.lookup(i).map((e=>pe.lookup(e.video_genre_id)))).map((e=>({genre_id:e.video_genre_id,title:e.title}))),actors:Z.lookup(e).map((e=>ot(e.person_id)))};var i}function ct(e,t){let r=ut(e),n=he.lookup(e).map((e=>dt(e.season_id,t,r)));return Object.assign(Object.assign({},r),{seasons:n})}function ft(e,t){var r;let n=Pe.lookup(e);return{subtitle_id:n.subtitle_id,file:{file_id:n.file_id,mime:"text/vtt"},language:null!==(r=n.language)&&void 0!==r?r:void 0}}function pt(e,t,r){let n=Ne.lookup(e),i=function(e,t,r){let n=Ne.lookup(e);return{track_id:n.track_id,title:n.title,disc:z(r)?r:tt(n.disc_id),artists:_e.lookup(n.track_id).map((e=>Ce.lookup(e.artist_id))),number:n.number,last_stream_date:void 0}}(e,0,r);return Object.assign(Object.assign({},i),{segment:{file:{file_id:n.file_id,mime:"audio/mp4",duration_ms:n.duration}}})}function ht(e){let t=je.lookup(e);return{user_id:t.user_id,name:t.name,username:t.username}}function gt(e){let t=ht(e);return Object.assign({},t)}function mt(t,r){if(!function(e,t){let r=/^\$s0\$([0-9a-fA-F]{8})\$([A-Za-z0-9+/]{22}==)\$([A-Za-z0-9+/]{43}=)$/.exec(t);if(null==r)throw"Expected a valid scrypt chunk!";let n=Buffer.from(r[1],"hex"),i=Buffer.from(r[2],"base64"),s=Buffer.from(r[3],"base64"),a=n[0]<<8|n[1]<<0,l=n[2]<<0,d=n[3]<<0,u=o.scryptSync(e,i,32,{N:1<<a,r:l,p:d,maxmem:(256<<a)*l});return o.timingSafeEqual(s,u)}(r,xe.lookup(t).password))throw"Expected a valid password!";return function(t){let r=o.randomBytes(16),n=o.randomBytes(16),i=o.createHash("sha256");i.update(n);let s=i.digest("hex");var a;return a={username:t,selector:r.toString("hex"),validator_hash:s,expires_ms:Date.now()+6048e5},X.tokens.push(a),Ke.insert(a.selector,a),e.writeFileSync("./private/db/users.json",JSON.stringify(X,null,"\t")),`${r.toString("hex")}${n.toString("hex")}`}(t)}function vt(t){let r=/^([0-9a-f]{32})([0-9a-f]{32})$/.exec(t);if(!r)throw new Error;let n=r[1],i=r[2],s=Ke.lookup(n);if(s.expires_ms<Date.now())throw"Token has expired!";let a=o.createHash("sha256");a.update(Buffer.from(i,"hex"));let l=a.digest();if(!o.timingSafeEqual(Buffer.from(s.validator_hash,"hex"),l))throw new Error;let d=Date.now()+6048e5;return function(t){try{Ke.lookup(t.selector).expires_ms=t.expires_ms,e.writeFileSync("./private/db/users.json",JSON.stringify(X,null,"\t"))}catch(e){}}(Object.assign(Object.assign({},s),{expires_ms:d})),s.username}function yt(e,t){try{return function(e,t){let r=Number.parseInt(function(e,t){let r=function(e,t){var r;let n=null!==(r=e.query[t])&&void 0!==r?r:[];return Array.isArray(n)?n:[n]}(e,t).pop();if(J(r))throw`Expected parameter ${t}!`;return r}(e,t),10);if(!Number.isInteger(r))throw`Expected integer ${t}!`;return r}(e,t)}catch(e){}}function bt(e){return vt(s.parse(e.url||"/",!0).query.token)}let St=(new class{constructor(){this.routes=new Array}registerRoute(e){return this.routes.push(e),this}route(e,t){for(let r of this.routes)if(r.handlesRequest(e))return r.handleRequest(e,t);t.writeHead(400),t.end("{}")}}).registerRoute(new class{constructor(){}handleRequest(e,t){if(void 0===e.url)throw new Error;let r=/^[/]api[/]auth[/][?]token[=]([0-9a-f]{64})/.exec(e.url);if(null===r)throw new Error;let n=r[1],i={};try{return vt(n),t.writeHead(200),t.end(JSON.stringify(i))}catch(e){}return t.writeHead(401),t.end(JSON.stringify(i))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^[/]api[/]auth[/][?]token[=]([0-9a-f]{64})/.test(e.url)}}).registerRoute(new class{constructor(){}handleRequest(e,t){if(void 0===e.url)throw new Error;let r="";e.on("data",(e=>{r+=e})).on("end",(()=>{try{let e=JSON.parse(r);if(null==e||e.constructor!==Object)throw new Error;if(null==e.username||e.username.constructor!==String)throw new Error;if(null==e.password||e.password.constructor!==String)throw new Error;let n=e,i={token:mt(n.username,n.password)};t.writeHead(200),t.end(JSON.stringify(i))}catch(e){t.writeHead(400),t.end(JSON.stringify({error:e.message}))}}))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^[/]api[/]auth[/]/.test(e.url)}}).registerRoute(new class{handleRequest(e,t){var r,n,i,o,a;let l=bt(e),d=/^[/]api[/]video[/]movies[/]([0-9a-f]{32})[/]suggestions[/]movies[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),u=s.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),c=null!==(i=yt(u,"offset"))&&void 0!==i?i:0,f=null!==(o=yt(u,"length"))&&void 0!==o?o:24,p=d[1],h=ye(p),g=new Map;for(let e of h){let t=ce.lookup(e.video_genre_id);for(let e of t){let t=null!==(a=g.get(e.movie_id))&&void 0!==a?a:0;g.set(e.movie_id,t+2)}}for(let e of g){let t=ye(e[0]);g.set(e[0],e[1]-t.length)}g.delete(p);let m={movies:Array.from(g.entries()).sort(M(F((e=>e[1])))).slice(c,c+f).map((e=>e[0])).map((e=>st(e,l)))};t.writeHead(200),t.end(JSON.stringify(m))}handlesRequest(e){var t;return/^[/]api[/]video[/]movies[/]([0-9a-f]{32})[/]suggestions[/]movies[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let n=bt(e),i={movie:st(/^[/]api[/]video[/]movies[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],n)};t.writeHead(200),t.end(JSON.stringify(i))}handlesRequest(e){var t;return/^[/]api[/]video[/]movies[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,i,o;let a=bt(e),l=/^[/]api[/]video[/]movies[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=decodeURIComponent(l[1]),u=s.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),c=null!==(i=yt(u,"offset"))&&void 0!==i?i:0,f=null!==(o=yt(u,"length"))&&void 0!==o?o:24,p=[];p=""===d?Y.video.movies.slice().sort(G((e=>e.title))):$e.search(d).map((e=>e.value));let h={movies:p.slice(c,c+f).map((e=>st(e.movie_id,a)))};t.writeHead(200),t.end(JSON.stringify(h))}handlesRequest(e){var t;return/^[/]api[/]video[/]movies[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;bt(e);let n=/^[/]api[/]audio[/]artists[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],i={artist:et(n),appearances:function(e){let t=we.lookup(e).map((e=>Ne.lookup(e.track_id))).map((e=>e.disc_id));t=Array.from(new Set(t));let r=t.map((e=>Ie.lookup(e))).map((e=>e.album_id));r=Array.from(new Set(r));let n=new Array;for(let t of r)null==be.lookup(t).find((t=>t.artist_id===e))&&n.push(t);return n}(n).map((e=>Ze(e)))};t.writeHead(200),t.end(JSON.stringify(i))}handlesRequest(e){var t;return/^[/]api[/]audio[/]artists[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,i,o;bt(e);let a=/^[/]api[/]audio[/]artists[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),l=decodeURIComponent(a[1]),d=s.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),u=null!==(i=yt(d,"offset"))&&void 0!==i?i:0,c=null!==(o=yt(d,"length"))&&void 0!==o?o:24,f=[];f=""===l?Y.audio.artists.slice().sort(G((e=>e.title))):qe.search(l).map((e=>e.value));let p={artists:f.slice(u,u+c).map((e=>et(e.artist_id)))};t.writeHead(200),t.end(JSON.stringify(p))}handlesRequest(e){var t;return/^[/]api[/]audio[/]artists[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;bt(e);let n={album:Ze(/^[/]api[/]audio[/]albums[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1])};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]audio[/]albums[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,i,o;bt(e);let a=/^[/]api[/]audio[/]albums[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],l=s.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),d=null!==(i=yt(l,"offset"))&&void 0!==i?i:0,u=null!==(o=yt(l,"length"))&&void 0!==o?o:24,c=[];c=""===a?Y.audio.albums.slice().sort(G((e=>e.title))):Me.search(a).map((e=>e.value));let f={albums:c.slice(d,d+u).map((e=>Ze(e.album_id)))};t.writeHead(200),t.end(JSON.stringify(f))}handlesRequest(e){var t;return/^[/]api[/]audio[/]albums[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let n=bt(e),i={episode:nt(/^[/]api[/]video[/]episodes[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],n)};t.writeHead(200),t.end(JSON.stringify(i))}handlesRequest(e){var t;return/^[/]api[/]video[/]episodes[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,i,o;let a=bt(e),l=/^[/]api[/]video[/]episodes[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=decodeURIComponent(l[1]),u=s.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),c=null!==(i=yt(u,"offset"))&&void 0!==i?i:0,f=null!==(o=yt(u,"length"))&&void 0!==o?o:24,p=[];p=""===d?Y.video.episodes.slice().sort(G((e=>e.title))):Je.search(d).map((e=>e.value));let h={episodes:p.slice(c,c+f).map((e=>nt(e.episode_id,a)))};t.writeHead(200),t.end(JSON.stringify(h))}handlesRequest(e){var t;return/^[/]api[/]video[/]episodes[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let n=bt(e),i={show:ct(/^[/]api[/]video[/]shows[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],n)};t.writeHead(200),t.end(JSON.stringify(i))}handlesRequest(e){var t;return/^[/]api[/]video[/]shows[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,i,o;let a=bt(e),l=/^[/]api[/]video[/]shows[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=decodeURIComponent(l[1]),u=s.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),c=null!==(i=yt(u,"offset"))&&void 0!==i?i:0,f=null!==(o=yt(u,"length"))&&void 0!==o?o:24,p=[];p=""===d?Y.video.shows.slice().sort(G((e=>e.title))):Fe.search(d).map((e=>e.value));let h={shows:p.slice(c,c+f).map((e=>ct(e.show_id,a)))};t.writeHead(200),t.end(JSON.stringify(h))}handlesRequest(e){var t;return/^[/]api[/]video[/]shows[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let n=bt(e),i=/^[/]api[/]persons[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],s={person:ot(i),shows:function(e,t,r,n){return ee.lookup(e).sort(G((e=>e.show_id))).slice(0,24).map((e=>ct(e.show_id,t)))}(i,n),movies:function(e,t,r,n){return re.lookup(e).sort(G((e=>e.movie_id))).slice(0,24).map((e=>st(e.movie_id,t)))}(i,n)};t.writeHead(200),t.end(JSON.stringify(s))}handlesRequest(e){var t;return/^[/]api[/]persons[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,i,o;bt(e);let a=/^[/]api[/]persons[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),l=decodeURIComponent(a[1]),d=s.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),u=null!==(i=yt(d,"offset"))&&void 0!==i?i:0,c=null!==(o=yt(d,"length"))&&void 0!==o?o:24,f=[];f=""===l?Y.persons.slice().sort(G((e=>e.name))):Xe.search(l).map((e=>e.value));let p={persons:f.slice(u,u+c).map((e=>ot(e.person_id)))};t.writeHead(200),t.end(JSON.stringify(p))}handlesRequest(e){var t;return/^[/]api[/]persons[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;bt(e);let n={playlist:at(/^[/]api[/]audio[/]playlists[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1])};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]audio[/]playlists[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,i,o;bt(e);let a=/^[/]api[/]audio[/]playlists[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),l=decodeURIComponent(a[1]),d=s.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),u=null!==(i=yt(d,"offset"))&&void 0!==i?i:0,c=null!==(o=yt(d,"length"))&&void 0!==o?o:24,f=[];f=""===l?V.audiolists.slice().sort(G((e=>e.title))):ze.search(l).map((e=>e.value));let p={playlists:f.slice(u,u+c).map((e=>at(e.audiolist_id)))};t.writeHead(200),t.end(JSON.stringify(p))}handlesRequest(e){var t;return/^[/]api[/]audio[/]playlists[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;bt(e);let n={track:pt(/^[/]api[/]audio[/]tracks[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1])};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]audio[/]tracks[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,i,o;bt(e);let a=/^[/]api[/]audio[/]tracks[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),l=decodeURIComponent(a[1]),d=s.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),u=null!==(i=yt(d,"offset"))&&void 0!==i?i:0,c=null!==(o=yt(d,"length"))&&void 0!==o?o:24,f=[];f=""===l?Y.audio.tracks.slice().sort(G((e=>e.title))):Ge.search(l).map((e=>e.value));let p={tracks:f.slice(u,u+c).map((e=>pt(e.track_id)))};t.writeHead(200),t.end(JSON.stringify(p))}handlesRequest(e){var t;return/^[/]api[/]audio[/]tracks[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let n=bt(e),i={season:dt(/^[/]api[/]video[/]seasons[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],n)};t.writeHead(200),t.end(JSON.stringify(i))}handlesRequest(e){var t;return/^[/]api[/]video[/]seasons[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,i,o;let a=bt(e),l=/^[/]api[/]video[/]seasons[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=(decodeURIComponent(l[1]),s.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0)),u=null!==(i=yt(d,"offset"))&&void 0!==i?i:0,c=null!==(o=yt(d,"length"))&&void 0!==o?o:24,f={seasons:Y.video.seasons.slice(u,u+c).map((e=>dt(e.season_id,a)))};t.writeHead(200),t.end(JSON.stringify(f))}handlesRequest(e){var t;return/^[/]api[/]video[/]seasons[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;bt(e);let n={disc:rt(/^[/]api[/]audio[/]discs[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1])};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]audio[/]discs[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,i,o;bt(e);let a=/^[/]api[/]audio[/]discs[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),l=(decodeURIComponent(a[1]),s.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0)),d=null!==(i=yt(l,"offset"))&&void 0!==i?i:0,u=null!==(o=yt(l,"length"))&&void 0!==o?o:24,c={discs:Y.audio.discs.slice(d,d+u).map((e=>rt(e.disc_id)))};t.writeHead(200),t.end(JSON.stringify(c))}handlesRequest(e){var t;return/^[/]api[/]audio[/]discs[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;bt(e);let n={user:gt(/^[/]api[/]users[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1])};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]users[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,i,o;bt(e);let a=/^[/]api[/]users[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),l=decodeURIComponent(a[1]),d=s.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),u=null!==(i=yt(d,"offset"))&&void 0!==i?i:0,c=null!==(o=yt(d,"length"))&&void 0!==o?o:24,f=[];f=""===l?X.users.slice().sort(G((e=>e.name))):We.search(l).map((e=>e.value));let p={users:f.slice(u,u+c).map((e=>gt(e.user_id)))};t.writeHead(200),t.end(JSON.stringify(p))}handlesRequest(e){var t;return/^[/]api[/]users[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,i,o;let a=bt(e),l=/^[/]api[/]video[/]cues[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=decodeURIComponent(l[1]),u=s.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),c={cues:function(e,t,r,n){return Ve.search(e).sort(F((e=>e.rank))).slice(r,r+n).map((e=>function(e,t){let r=function(e,t){let r=Be.lookup(e);return{cue_id:r.cue_id,subtitle:ft(r.subtitle_id),start_ms:r.start_ms,duration_ms:r.duration_ms,lines:r.lines}}(e);return Object.assign({},r)}(e.value.cue_id)))}(d,0,null!==(i=yt(u,"offset"))&&void 0!==i?i:0,null!==(o=yt(u,"length"))&&void 0!==o?o:24).map((e=>{let t=Pe.lookup(e.subtitle.subtitle_id);try{let r=oe.lookup(t.video_file_id);return Object.assign(Object.assign({},e),{media:nt(r.episode_id,a)})}catch(e){}try{let r=ae.lookup(t.video_file_id);return Object.assign(Object.assign({},e),{media:st(r.movie_id,a)})}catch(e){}})).filter(z)};t.writeHead(200),t.end(JSON.stringify(c))}handlesRequest(e){var t;return/^[/]api[/]video[/]cues[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,i,o;let a=bt(e),l=/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]shows[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=s.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),u=null!==(i=yt(d,"offset"))&&void 0!==i?i:0,c=null!==(o=yt(d,"length"))&&void 0!==o?o:24,f={shows:function(e,t,r,n){return fe.lookup(e).sort(G((e=>e.show_id))).slice(r,r+n).map((e=>ct(e.show_id,t)))}(l[1],a,u,c)};t.writeHead(200),t.end(JSON.stringify(f))}handlesRequest(e){var t;return/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]shows[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,i,o;let a=bt(e),l=/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]movies[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=s.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),u=null!==(i=yt(d,"offset"))&&void 0!==i?i:0,c=null!==(o=yt(d,"length"))&&void 0!==o?o:24,f={movies:function(e,t,r,n){return ce.lookup(e).sort(G((e=>e.movie_id))).slice(r,r+n).map((e=>st(e.movie_id,t)))}(l[1],a,u,c)};t.writeHead(200),t.end(JSON.stringify(f))}handlesRequest(e){var t;return/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]movies[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;bt(e);let n={genre:it(/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1])};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;bt(e),/^[/]api[/]video[/]genres[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/");let n={genres:Y.video.genres.map((e=>it(e.video_genre_id)))};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]video[/]genres[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,i,o;let a=bt(e),d=/^[/]api[/]search[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),u=decodeURIComponent(d[1]),p=s.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0),g={entities:function(e,t,r,n){return[...Me.search(e).map((e=>Object.assign(Object.assign({},e),{type_rank:5}))),...qe.search(e).map((e=>Object.assign(Object.assign({},e),{type_rank:7}))),...Je.search(e).map((e=>Object.assign(Object.assign({},e),{type_rank:2}))),...$e.search(e).map((e=>Object.assign(Object.assign({},e),{type_rank:6}))),...Xe.search(e).map((e=>Object.assign(Object.assign({},e),{type_rank:0}))),...ze.search(e).map((e=>Object.assign(Object.assign({},e),{type_rank:4}))),...Fe.search(e).map((e=>Object.assign(Object.assign({},e),{type_rank:3}))),...Ge.search(e).map((e=>Object.assign(Object.assign({},e),{type_rank:1}))),...We.search(e).map((e=>Object.assign(Object.assign({},e),{type_rank:0})))].sort(M(F((e=>e.rank)),F((e=>e.type_rank)))).slice(r,r+n).map((e=>{let r=e.value;if(f.is(r))return Ze(r.album_id);if(c.is(r))return et(r.artist_id);if(E.is(r))return nt(r.episode_id,t);if(y.is(r))return st(r.movie_id,t);if(l.is(r))return ot(r.person_id);if(j.is(r))return at(r.audiolist_id);if(_.is(r))return ct(r.show_id,t);if(h.is(r))return pt(r.track_id);if(A.is(r))return gt(r.user_id);throw"Expected code to be unreachable!"}))}(u,a,null!==(i=yt(p,"offset"))&&void 0!==i?i:0,null!==(o=yt(p,"length"))&&void 0!==o?o:24)};t.writeHead(200),t.end(JSON.stringify(g))}handlesRequest(e){var t;return/^[/]api[/]search[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){let r={tokens:(n=bt(e),X.tokens.filter((e=>e.username===n)))};var n;t.writeHead(200),t.end(JSON.stringify(r))}handlesRequest(e){return"POST"===e.method&&/^[/]api[/]tokens[/]/.test(e.url||"/")}});const _t=require("child_process"),wt=a.l8.Object.of({pkt_pts_time:a.l8.String}),Ot=a.l8.Object.of({frames:a.l8.Array.of(a.l8.Reference.of((()=>wt)))}),Et=a.l8.Object.of({start_time:a.l8.String,duration:a.l8.String});a.l8.Object.of({streams:a.l8.Array.of(a.l8.Reference.of((()=>Et)))});function Rt(e,t){return r=this,n=void 0,s=function*(){return new Promise(((r,n)=>{let i=_t.spawn("ffprobe",["-hide_banner","-i",e.join("/"),"-select_streams",""+t,"-skip_frame","nokey","-show_frames","-show_entries","frame=pkt_pts_time","-of","json"]),s=new Array;i.stdout.on("data",(e=>{s.push(e)})),i.on("exit",(()=>{let e=Buffer.concat(s).toString(),t=Ot.as(JSON.parse(e)).frames.map((e=>Math.round(1e3*Number.parseFloat(e.pkt_pts_time))));r(t)}))}))},new((i=void 0)||(i=Promise))((function(e,t){function o(e){try{l(s.next(e))}catch(e){t(e)}}function a(e){try{l(s.throw(e))}catch(e){t(e)}}function l(t){var r;t.done?e(t.value):(r=t.value,r instanceof i?r:new i((function(e){e(r)}))).then(o,a)}l((s=s.apply(r,n||[])).next())}));var r,n,i,s}var Tt=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}l((n=n.apply(e,t||[])).next())}))};function kt(t){let r=o.randomBytes(16).toString("hex"),n=[".","private","jobs",r];return e.mkdirSync(n.join("/"),{recursive:!0}),t(n,r)}function Nt(t,r){e.mkdirSync(r.slice(0,-1).join("/"),{recursive:!0}),e.renameSync(t.join("/"),r.join("/"))}function It(t){let r=e.statSync(t);r.isDirectory()?(e.readdirSync(t).map((e=>t+"/"+e)).forEach(It),e.rmdirSync(t)):r.isFile()&&e.unlinkSync(t)}const jt=[];for(let t of Y.video.episodes){let r=[".","private","stills",t.file_id];if(!e.existsSync(r.join("/"))){let e=ie.lookup(t.file_id);jt.push({target:r,file:e})}}setTimeout((function e(){return Tt(this,void 0,void 0,(function*(){let t=jt.pop();J(t)||(yield function(e,t){return new Promise(((r,n)=>Tt(this,void 0,void 0,(function*(){let i=yield Rt([".",...t.path],0),s=i[Math.floor(i.length/2)];kt(((i,o)=>{let a=[...i,"still.jpeg"],l=_t.spawn("ffmpeg",["-ss",q(s),"-i",[".",...t.path].join("/"),"-q:v","1","-frames:v","1","-f","singlejpeg","-fflags","+bitexact","-map_metadata","-1",a.join("/"),"-y"]);l.on("error",(()=>(It(i.join("/")),n()))),l.on("exit",(()=>(Nt(a,e),It(i.join("/")),r())))}))}))))}(t.target,t.file),setTimeout(e,1e4))}))}));class xt{constructor(e){this.state=e,this.observers=new Array}addObserver(e){let t=new xt(e(this.state));return this.observers.push((r=>{t.updateState(e(r))})),t.addObserver.bind(t)}getState(){return this.state}updateState(e){if(e!==this.state){this.state=e;for(let e of this.observers)e(this.state)}}}class Ut{constructor(e){this.state=e,this.observers=new Array}addObserver(e){var t;this.observers.push(e),null===(t=e.onupdate)||void 0===t||t.call(e,this.state)}compute(e){let t=new xt(e(this.state));return this.observers.push({onupdate(r){t.updateState(e(r))}}),t.addObserver.bind(t)}getState(){return this.state}append(e){var t,r;this.state.push(e);for(let n of this.observers)null===(t=n.onappend)||void 0===t||t.call(n,e),null===(r=n.onupdate)||void 0===r||r.call(n,this.state)}splice(e){var t,r;if(e<0||e>=this.state.length)throw`Expected an index of at most ${this.state.length}, got ${e}!`;let n=this.state[e];this.state.splice(e,1);for(let i of this.observers)null===(t=i.onsplice)||void 0===t||t.call(i,n,e),null===(r=i.onupdate)||void 0===r||r.call(i,this.state)}update(e){for(let e=this.state.length-1;e>=0;e--)this.splice(e);for(let t of e)this.append(t)}}const At=a.l8.Object.of({person_id:a.l8.String,name:a.l8.String}),Ct=a.l8.Intersection.of(a.l8.Reference.of((()=>At)),a.l8.Object.of({})),Lt=a.l8.Object.of({artist_id:a.l8.String,title:a.l8.String}),Dt=a.l8.Intersection.of(a.l8.Reference.of((()=>Lt)),a.l8.Object.of({albums:a.l8.Array.of(a.l8.Reference.of((()=>Bt)))})),Pt=a.l8.Object.of({album_id:a.l8.String,title:a.l8.String,year:a.l8.Number,artists:a.l8.Array.of(a.l8.Reference.of((()=>Lt))),artwork:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>pr)))}),Bt=a.l8.Intersection.of(a.l8.Reference.of((()=>Pt)),a.l8.Object.of({discs:a.l8.Array.of(a.l8.Reference.of((()=>qt)))})),Ht=a.l8.Object.of({disc_id:a.l8.String,album:a.l8.Reference.of((()=>Pt)),number:a.l8.Number}),qt=a.l8.Intersection.of(a.l8.Reference.of((()=>Ht)),a.l8.Object.of({tracks:a.l8.Array.of(a.l8.Reference.of((()=>Gt)))})),Mt=a.l8.Object.of({track_id:a.l8.String,title:a.l8.String,disc:a.l8.Reference.of((()=>Ht)),artists:a.l8.Array.of(a.l8.Reference.of((()=>Lt))),number:a.l8.Number,last_stream_date:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),Gt=a.l8.Intersection.of(a.l8.Reference.of((()=>Mt)),a.l8.Object.of({segment:a.l8.Object.of({file:a.l8.Reference.of((()=>fr))})})),Ft=a.l8.Object.of({user_id:a.l8.String,name:a.l8.String,username:a.l8.String}),$t=a.l8.Intersection.of(a.l8.Reference.of((()=>Ft)),a.l8.Object.of({})),Jt=a.l8.Object.of({playlist_id:a.l8.String,title:a.l8.String,description:a.l8.String,user:a.l8.Reference.of((()=>Ft))}),zt=a.l8.Intersection.of(a.l8.Reference.of((()=>Jt)),a.l8.Object.of({items:a.l8.Array.of(a.l8.Reference.of((()=>Vt)))})),Wt=a.l8.Object.of({number:a.l8.Number,playlist:a.l8.Reference.of((()=>Jt)),track:a.l8.Reference.of((()=>Gt))}),Vt=a.l8.Intersection.of(a.l8.Reference.of((()=>Wt)),a.l8.Object.of({})),Xt=a.l8.Object.of({genre_id:a.l8.String,title:a.l8.String}),Yt=a.l8.Intersection.of(a.l8.Reference.of((()=>Xt)),a.l8.Object.of({})),Kt=a.l8.Object.of({file:a.l8.Reference.of((()=>gr)),subtitles:a.l8.Array.of(a.l8.Reference.of((()=>lr)))}),Qt=a.l8.Intersection.of(a.l8.Reference.of((()=>Kt)),a.l8.Object.of({})),Zt=a.l8.Object.of({movie_id:a.l8.String,title:a.l8.String,year:a.l8.Number,summary:a.l8.String,artwork:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>pr))),last_stream_date:a.l8.Union.of(a.l8.Undefined,a.l8.Number),genres:a.l8.Array.of(a.l8.Reference.of((()=>Yt))),actors:a.l8.Array.of(a.l8.Reference.of((()=>Ct)))}),er=a.l8.Intersection.of(a.l8.Reference.of((()=>Zt)),a.l8.Object.of({segment:a.l8.Reference.of((()=>Qt))})),tr=a.l8.Object.of({show_id:a.l8.String,title:a.l8.String,summary:a.l8.String,artwork:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>pr))),genres:a.l8.Array.of(a.l8.Reference.of((()=>Yt))),actors:a.l8.Array.of(a.l8.Reference.of((()=>Ct)))}),rr=a.l8.Intersection.of(a.l8.Reference.of((()=>tr)),a.l8.Object.of({seasons:a.l8.Array.of(a.l8.Reference.of((()=>ir)))})),nr=a.l8.Object.of({season_id:a.l8.String,number:a.l8.Number,show:a.l8.Reference.of((()=>tr))}),ir=a.l8.Intersection.of(a.l8.Reference.of((()=>nr)),a.l8.Object.of({episodes:a.l8.Array.of(a.l8.Reference.of((()=>or)))})),sr=a.l8.Object.of({episode_id:a.l8.String,title:a.l8.String,summary:a.l8.String,number:a.l8.Number,season:a.l8.Reference.of((()=>nr)),year:a.l8.Union.of(a.l8.Undefined,a.l8.Number),last_stream_date:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),or=a.l8.Intersection.of(a.l8.Reference.of((()=>sr)),a.l8.Object.of({segment:a.l8.Reference.of((()=>Qt))})),ar=a.l8.Object.of({subtitle_id:a.l8.String,file:a.l8.Reference.of((()=>hr)),language:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),lr=a.l8.Intersection.of(a.l8.Reference.of((()=>ar)),a.l8.Object.of({cues:a.l8.Array.of(a.l8.Reference.of((()=>ur)))})),dr=a.l8.Object.of({cue_id:a.l8.String,subtitle:a.l8.Reference.of((()=>ar)),start_ms:a.l8.Number,duration_ms:a.l8.Number,lines:a.l8.Array.of(a.l8.String)}),ur=a.l8.Intersection.of(a.l8.Reference.of((()=>dr)),a.l8.Object.of({})),cr=(a.l8.Union.of(a.l8.Reference.of((()=>Bt)),a.l8.Reference.of((()=>Dt)),a.l8.Reference.of((()=>qt)),a.l8.Reference.of((()=>or)),a.l8.Reference.of((()=>Yt)),a.l8.Reference.of((()=>er)),a.l8.Reference.of((()=>Ct)),a.l8.Reference.of((()=>zt)),a.l8.Reference.of((()=>ir)),a.l8.Reference.of((()=>rr)),a.l8.Reference.of((()=>Gt)),a.l8.Reference.of((()=>$t))),a.l8.Object.of({file_id:a.l8.String,mime:a.l8.String})),fr=a.l8.Intersection.of(a.l8.Reference.of((()=>cr)),a.l8.Object.of({duration_ms:a.l8.Number})),pr=a.l8.Intersection.of(a.l8.Reference.of((()=>cr)),a.l8.Object.of({height:a.l8.Number,width:a.l8.Number})),hr=a.l8.Intersection.of(a.l8.Reference.of((()=>cr)),a.l8.Object.of({})),gr=a.l8.Intersection.of(a.l8.Reference.of((()=>cr)),a.l8.Object.of({duration_ms:a.l8.Number,height:a.l8.Number,width:a.l8.Number})),mr=a.l8.Reference.of((()=>Bt)),vr=a.l8.Reference.of((()=>Dt)),yr=a.l8.Reference.of((()=>qt)),br=a.l8.Reference.of((()=>Gt)),Sr=a.l8.Reference.of((()=>zt)),_r=a.l8.Reference.of((()=>er)),wr=a.l8.Reference.of((()=>rr)),Or=a.l8.Reference.of((()=>ir)),Er=a.l8.Reference.of((()=>or)),Rr=a.l8.Union.of(a.l8.Reference.of((()=>mr)),a.l8.Reference.of((()=>vr)),a.l8.Reference.of((()=>yr)),a.l8.Reference.of((()=>br)),a.l8.Reference.of((()=>Sr)),a.l8.Reference.of((()=>_r)),a.l8.Reference.of((()=>wr)),a.l8.Reference.of((()=>Or)),a.l8.Reference.of((()=>Er))),Tr=(a.l8.Union.of(a.l8.Reference.of((()=>br)),a.l8.Reference.of((()=>_r)),a.l8.Reference.of((()=>Er))),a.l8.Object.of({id:a.l8.String,type:a.l8.String,name:a.l8.String})),kr=(a.l8.Object.of({context:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>Rr))),device:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>Tr))),index:a.l8.Union.of(a.l8.Undefined,a.l8.Number),playback:a.l8.Boolean,progress:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),{SetContext:a.l8.Object.of({context:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>Rr)))}),SetDevice:a.l8.Object.of({device:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>Tr)))}),SetDevices:a.l8.Object.of({devices:a.l8.Array.of(a.l8.Reference.of((()=>Tr)))}),SetIndex:a.l8.Object.of({index:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),SetLocalDevice:a.l8.Object.of({device:a.l8.Reference.of((()=>Tr))}),SetPlayback:a.l8.Object.of({playback:a.l8.Boolean}),SetProgress:a.l8.Object.of({progress:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),SetToken:a.l8.Object.of({token:a.l8.Union.of(a.l8.Undefined,a.l8.String)})});var Nr=r(978),Ir=r(611);class jr{constructor(e,t,r){this.nextConnectionAttemptDelayFactor=2+Math.random(),this.nextConnectionAttemptDelay=2e3,this.router=new Nr.routing.NamespacedMessageRouter,this.serializer=new a.m7.MessageSerializer(r),this.url=e,this.factory=t,this.socket=t(e),this.socket.addEventListener("close",this.onClose.bind(this)),this.socket.addEventListener("error",this.onError.bind(this)),this.socket.addEventListener("message",this.onMessage.bind(this)),this.socket.addEventListener("open",this.onOpen.bind(this))}onClose(e){this.router.route("sys","disconnect",{})}onError(e){setTimeout((()=>{this.socket=this.factory(this.url),this.socket.addEventListener("close",this.onClose.bind(this)),this.socket.addEventListener("error",this.onError.bind(this)),this.socket.addEventListener("message",this.onMessage.bind(this)),this.socket.addEventListener("open",this.onOpen.bind(this))}),this.nextConnectionAttemptDelay),this.nextConnectionAttemptDelay=Math.round(this.nextConnectionAttemptDelay*this.nextConnectionAttemptDelayFactor)}onMessage(e){let t=e.data;this.serializer.deserialize(t,((e,t)=>{this.router.route("sys","message",{type:e,data:t}),this.router.route("app",e,t)}))}onOpen(e){this.nextConnectionAttemptDelay=2e3,this.router.route("sys","connect",{})}addEventListener(e,t,r){this.router.addObserver(e,t,r)}close(){this.socket.close()}removeEventListener(e,t,r){this.router.addObserver(e,t,r)}send(e,t){if(this.socket.readyState===Ir.ReadyState.OPEN)this.socket.send(this.serializer.serialize(e,t));else{let r=()=>{this.socket.removeEventListener("open",r),this.socket.send(this.serializer.serialize(e,t))};this.socket.addEventListener("open",r)}}}class xr{constructor(e,t=(e=>new WebSocket(e))){this.estimatedProgress=new xt(void 0),this.estimatedProgressTimestamp=new xt(void 0),this.token=new xt(void 0),this.localDevice=new xt(void 0),this.devices=new Ut(new Array),this.device=new xt(void 0),this.isDeviceLocal=new xt(!1),this.isDeviceRemote=new xt(!1),this.context=new xt(void 0),this.contextPath=new xt(void 0),this.flattenedContext=new xt(void 0),this.lastIndex=new xt(void 0),this.lastEntry=new xt(void 0),this.lastLocalEntry=new xt(void 0),this.currentIndex=new xt(void 0),this.currentEntry=new xt(void 0),this.currentLocalEntry=new xt(void 0),this.nextIndex=new xt(void 0),this.nextEntry=new xt(void 0),this.nextLocalEntry=new xt(void 0),this.playback=new xt(!1),this.progress=new xt(void 0),this.localPlayback=new xt(!1),this.canPlayLast=new xt(!1),this.canPlayCurrent=new xt(!1),this.canPlayNext=new xt(!1),this.isCurrentEntryVideo=new xt(!1),this.tsc=new jr(e,t,kr),this.context.addObserver((e=>{if(z(e))if(mr.is(e)){let t=[],r=e;for(let e of r.discs)t.push(...e.tracks);this.flattenedContext.updateState(t)}else if(vr.is(e)){let t=[],r=e;for(let e of r.albums)for(let r of e.discs)t.push(...r.tracks);this.flattenedContext.updateState(t)}else if(Er.is(e)){let t=[],r=e;t.push(r),this.flattenedContext.updateState(t)}else if(_r.is(e)){let t=[],r=e;t.push(r),this.flattenedContext.updateState(t)}else if(Sr.is(e)){let t=[],r=e;for(let e of r.items)t.push(e.track);this.flattenedContext.updateState(t)}else if(Or.is(e)){let t=[],r=e;t.push(...r.episodes),this.flattenedContext.updateState(t)}else if(wr.is(e)){let t=[],r=e;for(let e of r.seasons)t.push(...e.episodes);this.flattenedContext.updateState(t)}else{if(!br.is(e))throw"Expected code to be unreachable!";{let t=[],r=e;t.push(r),this.flattenedContext.updateState(t)}}}));{let e=()=>{let e=this.context.getState(),t=this.currentIndex.getState();if(z(e)&&z(t)){if(mr.is(e)){let r=0,n=t,i=e.discs;for(let e=0;e<i.length;e++){let t=i[e].tracks.length;if(!(n>=t))break;r+=1,n-=t}return this.contextPath.updateState([e.album_id,e.discs[r].disc_id,e.discs[r].tracks[n].track_id])}if(vr.is(e)){let r=0,n=0,i=t,s=e.albums;e:for(let e=0;e<s.length;e++){let t=s[e].discs;for(let e=0;e<t.length;e++){let r=t[e].tracks.length;if(!(i>=r))break e;n+=1,i-=r}r+=1,n=0}return this.contextPath.updateState([e.artist_id,e.albums[r].album_id,e.albums[r].discs[n].disc_id,e.albums[r].discs[n].tracks[i].track_id])}if(Er.is(e))return this.contextPath.updateState([e.episode_id]);if(_r.is(e))return this.contextPath.updateState([e.movie_id]);if(Sr.is(e)){let r=t;return this.contextPath.updateState([e.playlist_id,e.items[r].track.track_id])}if(wr.is(e)){let r=0,n=t,i=e.seasons;for(let e=0;e<i.length;e++){let t=i[e].episodes.length;if(!(n>=t))break;r+=1,n-=t}return this.contextPath.updateState([e.show_id,e.seasons[r].season_id,e.seasons[r].episodes[n].episode_id])}if(Or.is(e)){let r=t;return this.contextPath.updateState([e.season_id,e.episodes[r].episode_id])}if(br.is(e))return this.contextPath.updateState([e.track_id]);throw"Expected code to be unreachable!"}this.contextPath.updateState(void 0)};this.context.addObserver(e),this.currentIndex.addObserver(e)}this.lastEntry.addObserver((e=>{this.canPlayLast.updateState(z(e))})),this.currentEntry.addObserver((e=>{this.canPlayCurrent.updateState(z(e))})),this.nextEntry.addObserver((e=>{this.canPlayNext.updateState(z(e))})),this.progress.addObserver((e=>{this.estimatedProgress.updateState(e),this.estimatedProgressTimestamp.updateState(Date.now())})),this.playback.addObserver((e=>{let t=this.estimatedProgress.getState(),r=this.estimatedProgressTimestamp.getState(),n=Date.now();e||z(t)&&z(r)&&this.estimatedProgress.updateState(t+(n-r)/1e3),this.estimatedProgressTimestamp.updateState(n)})),this.estimatedProgress.addObserver((e=>{console.log("Estimated progress to "+(null!=e?e:0))}));{let e=()=>{let e=this.playback.getState(),t=this.isDeviceLocal.getState();this.localPlayback.updateState(t&&e)};this.playback.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.lastEntry.getState(),t=this.isDeviceLocal.getState();this.lastLocalEntry.updateState(t?e:void 0)};this.lastEntry.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.currentEntry.getState(),t=this.isDeviceLocal.getState();this.currentLocalEntry.updateState(t?e:void 0)};this.currentEntry.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.nextEntry.getState(),t=this.isDeviceLocal.getState();this.nextLocalEntry.updateState(t?e:void 0)};this.nextEntry.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.localDevice.getState(),t=this.device.getState();return z(e)&&z(t)&&e.id===t.id?this.isDeviceLocal.updateState(!0):this.isDeviceLocal.updateState(!1)};this.localDevice.addObserver(e),this.device.addObserver(e)}{let e=()=>{let e=this.localDevice.getState(),t=this.device.getState();return z(e)&&z(t)&&e.id!==t.id?this.isDeviceRemote.updateState(!0):this.isDeviceRemote.updateState(!1)};this.localDevice.addObserver(e),this.device.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.currentIndex.getState();if(z(e)&&z(t)){let r=t-1;if(r>=0&&r<e.length)return this.lastIndex.updateState(r)}return this.lastIndex.updateState(void 0)};this.flattenedContext.addObserver(e),this.currentIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.currentIndex.getState();if(z(e)&&z(t)){let r=t+1;if(r>=0&&r<e.length)return this.nextIndex.updateState(r)}return this.nextIndex.updateState(void 0)};this.flattenedContext.addObserver(e),this.currentIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.lastIndex.getState();return z(e)&&z(t)?this.lastEntry.updateState(e[t]):this.lastEntry.updateState(void 0)};this.flattenedContext.addObserver(e),this.lastIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.currentIndex.getState();return z(e)&&z(t)&&t>=0&&t+0<e.length?this.currentEntry.updateState(e[t+0]):this.currentEntry.updateState(void 0)};this.flattenedContext.addObserver(e),this.currentIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.nextIndex.getState();return z(e)&&z(t)?this.nextEntry.updateState(e[t]):this.nextEntry.updateState(void 0)};this.flattenedContext.addObserver(e),this.nextIndex.addObserver(e)}this.token.addObserver((e=>{this.tsc.send("SetToken",{token:e})})),this.tsc.addEventListener("app","SetLocalDevice",(e=>{this.localDevice.updateState(e.device)})),this.tsc.addEventListener("app","SetDevices",(e=>{this.devices.update(e.devices)})),this.tsc.addEventListener("app","SetContext",(e=>{this.context.updateState(e.context)})),this.tsc.addEventListener("app","SetDevice",(e=>{this.device.updateState(e.device)})),this.tsc.addEventListener("app","SetIndex",(e=>{this.currentIndex.updateState(e.index)})),this.tsc.addEventListener("app","SetPlayback",(e=>{this.playback.updateState(e.playback)})),this.tsc.addEventListener("app","SetProgress",(e=>{this.progress.updateState(e.progress)})),this.tsc.addEventListener("app","SetToken",(e=>{this.token.updateState(e.token)}))}play(e,t){this.tsc.send("SetContext",{context:e}),this.tsc.send("SetIndex",{index:t}),this.resume()}authenticate(e){this.tsc.send("SetToken",{token:e})}close(){this.tsc.close()}last(){let e=this.lastIndex.getState();z(e)&&(this.currentIndex.updateState(e),this.tsc.send("SetIndex",{index:e}))}next(){let e=this.nextIndex.getState();z(e)?(this.currentIndex.updateState(e),this.tsc.send("SetIndex",{index:e})):this.pause()}pause(){this.playback.updateState(!1),this.tsc.send("SetPlayback",{playback:!1})}playAlbum(e,t,r){let n=0;if(z(t)){let i=e.discs;if(t<0||t>=i.length)throw`Expected ${t} to be a number between 0 and ${i.length}!`;if(n+=i.slice(0,t).reduce(((e,t)=>e+t.tracks.length),0),z(r)){let e=i[t].tracks;if(r<0||r>=e.length)throw`Expected ${r} to be a number between 0 and ${e.length}!`;n+=r}}return this.play(e,n)}playArtist(e,t,r,n){let i=0;if(z(t)){let s=e.albums;if(t<0||t>=s.length)throw`Expected ${t} to be a number between 0 and ${s.length}!`;if(i+=s.slice(0,t).reduce(((e,t)=>e+t.discs.reduce(((e,t)=>e+t.tracks.length),0)),0),z(r)){let e=s[t].discs;if(r<0||r>=e.length)throw`Expected ${r} to be a number between 0 and ${e.length}!`;if(i+=e.slice(0,r).reduce(((e,t)=>e+t.tracks.length),0),z(n)){let t=e[r].tracks;if(n<0||n>=t.length)throw`Expected ${n} to be a number between 0 and ${t.length}!`;i+=n}}}return this.play(e,i)}playDisc(e,t){let r=0;if(z(t)){let n=e.tracks;if(t<0||t>=n.length)throw`Expected ${t} to be a number between 0 and ${n.length}!`;r+=t}return this.play(e,r)}playEpisode(e){this.play(e,0)}playMovie(e){this.play(e,0)}playPlaylist(e,t){let r=0;if(z(t)){let n=e.items;if(t<0||t>=n.length)throw`Expected ${t} to be a number between 0 and ${n.length}!`;r+=t}return this.play(e,r)}playSeason(e,t){let r=0;if(z(t)){let n=e.episodes;if(t<0||t>=n.length)throw`Expected ${t} to be a number between 0 and ${n.length}!`;r+=t}return this.play(e,r)}playShow(e,t,r){let n=0;if(z(t)){let i=e.seasons;if(t<0||t>=i.length)throw`Expected ${t} to be a number between 0 and ${i.length}!`;if(n+=i.slice(0,t).reduce(((e,t)=>e+t.episodes.length),0),z(r)){let e=i[t].episodes;if(r<0||r>=e.length)throw`Expected ${r} to be a number between 0 and ${e.length}!`;n+=r}}return this.play(e,n)}playTrack(e){this.play(e,0)}resume(){this.playback.updateState(!0),this.tsc.send("SetPlayback",{playback:!0})}seek(e){this.tsc.send("SetProgress",{progress:e})}toggle(){this.playback.getState()?this.pause():this.resume()}transfer(e){this.tsc.send("SetDevice",{device:e})}}var Ur=r(545);class Ar{constructor(e,t=!1){this.router=new Nr.routing.NamespacedMessageRouter,this.serializer=new a.m7.MessageSerializer(e),this.socket=new Ur.u9,this.debug=t,this.socket.addEventListener("connect",(e=>{let t=e.connection_id,r=e.connection_url;this.router.route("sys","connect",{connection_id:t,connection_url:r})})),this.socket.addEventListener("disconnect",(e=>{let t=e.connection_id,r=e.connection_url;this.router.route("sys","disconnect",{connection_id:t,connection_url:r})})),this.socket.addEventListener("message",(e=>{let t=e.connection_id,r=e.connection_url,n=e.buffer.toString();this.serializer.deserialize(n,((e,n)=>{this.debug&&console.log(`${t} -> ${e}`),this.router.route("sys","message",{connection_id:t,connection_url:r,type:e,data:n}),this.router.route("app",e,{connection_id:t,connection_url:r,data:n})}))}))}addEventListener(e,t,r){this.router.addObserver(e,t,r)}broadcast(e,t){let r=this.serializer.serialize(e,t);this.socket.broadcast(r)}close(e){this.socket.close(e)}getRequestHandler(){return this.socket.getRequestHandler()}removeEventListener(e,t,r){this.router.addObserver(e,t,r)}send(e,t,r){let n=this.serializer.serialize(e,r);for(let r of Array.isArray(t)?t:[t]){this.debug&&console.log(`${r} <- ${e}`);try{this.socket.send(r,n)}catch(e){}}}}function Cr(e,t){var r;let n=null!==(r=e.query[t])&&void 0!==r?r:[];return Array.isArray(n)?n:[n]}function Lr(e,t){var r,n;let i=s.parse(t,!0);return{id:e,name:null!==(r=Cr(i,"name").pop())&&void 0!==r?r:"",type:null!==(n=Cr(i,"type").pop())&&void 0!==n?n:""}}var Dr,Pr,Br,Hr=r(16);function qr(e){if(e>Number.MAX_SAFE_INTEGER||e<Number.MIN_SAFE_INTEGER)throw`Expected a safe integer but got ${e}!`;return Number(e)}function Mr(e,t){let r=e.buffer.length-e.offset;if(t>r)throw`Expected to read at most ${r} bytes but attempted to read ${t} bytes!`;let n=e.buffer.slice(e.offset,e.offset+t);return e.offset+=t,n}function Gr(e){let t=Buffer.alloc(10);for(let r=0;r<10;r++){let n=e.buffer.readUInt8(e.offset);if(e.offset+=1,t[r]=n,0==(128&n)){if(r+1===10&&0!=(126&n))throw"Expected a varint of at most 64 bits!";let e=BigInt(0);for(let n=r;n>=0;n--)e=e<<BigInt(7)|BigInt(127&t[n]);let i=Buffer.alloc(8);return i.writeBigUInt64LE(e,0),i}}throw"Expected a varint of at most 10 bytes!"}function Fr(e){let t=e.readBigUInt64LE(0),r=Buffer.alloc(10);for(let e=0;e<10;e++){let n=t&BigInt(127);if(t>>=BigInt(7),!(t>0))return r.writeUInt8(0|qr(n),e),r.slice(0,e+1);r.writeUInt8(128|qr(n),e)}throw"Expected to serialize at most 10 bytes!"}function $r(e){let t=BigInt(e.field_number)<<BigInt(3)|BigInt(e.wire_type)&BigInt(7),r=Buffer.alloc(8);return r.writeBigUInt64LE(t,0),Fr(r)}function Jr(e){let t=function(e){let t=Gr(e).readBigUInt64LE(0);return{field_number:qr(t>>BigInt(3)),wire_type:qr(t&BigInt(7))}}(e);if(t.wire_type===Dr.VARINT)return{key:t,data:Gr(e)};if(t.wire_type===Dr.FIXED_64_BIT)return{key:t,data:Mr(e,8)};if(t.wire_type===Dr.LENGTH_DELIMITED)return{key:t,data:Mr(e,qr(Gr(e).readBigUInt64LE(0)))};if(t.wire_type===Dr.START_GROUP)return{key:t,data:Buffer.alloc(0)};if(t.wire_type===Dr.END_GROUP)return{key:t,data:Buffer.alloc(0)};if(t.wire_type===Dr.FIXED_32_BIT)return{key:t,data:Mr(e,4)};throw"Expected a recognized wire type!"}function zr(e){if(e.key.wire_type===Dr.VARINT)return Buffer.concat([$r(e.key),Fr(e.data)]);if(e.key.wire_type===Dr.FIXED_64_BIT){if(8!==e.data.length)throw"Expected to serialize exactly 8 bytes!";return Buffer.concat([$r(e.key),e.data])}if(e.key.wire_type===Dr.LENGTH_DELIMITED){let t=Buffer.alloc(8);return t.writeBigUInt64LE(BigInt(e.data.length)),Buffer.concat([$r(e.key),Fr(t),e.data])}if(e.key.wire_type===Dr.START_GROUP){if(0!==e.data.length)throw"Expected to serialize exactly 0 bytes!";return Buffer.concat([$r(e.key),e.data])}if(e.key.wire_type===Dr.END_GROUP){if(0!==e.data.length)throw"Expected to serialize exactly 0 bytes!";return Buffer.concat([$r(e.key),e.data])}if(e.key.wire_type===Dr.FIXED_32_BIT){if(4!==e.data.length)throw"Expected to serialize exactly 4 bytes!";return Buffer.concat([$r(e.key),e.data])}throw"Expected a recognized wire type!"}function Wr(e,t){let r=t.filter((t=>t.key.field_number===e));if(0===r.length)throw"Expected required field to be present!";return qr(r[r.length-1].data.readBigUInt64LE(0))}function Vr(e,t){return zr({key:{field_number:e,wire_type:Dr.VARINT},data:function(e){let t=Buffer.alloc(8);return t.writeBigUInt64LE(BigInt(e)),t}(t)})}function Xr(e,t){let r=t.filter((t=>t.key.field_number===e));if(0===r.length)throw"Expected required field to be present!";return r[r.length-1].data.toString()}function Yr(e,t){return zr({key:{field_number:e,wire_type:Dr.LENGTH_DELIMITED},data:Buffer.from(t)})}function Kr(e,t){return null==t?Buffer.alloc(0):function(e,t){return zr({key:{field_number:e,wire_type:Dr.LENGTH_DELIMITED},data:t})}(e,t)}!function(e){e[e.VARINT=0]="VARINT",e[e.FIXED_64_BIT=1]="FIXED_64_BIT",e[e.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",e[e.START_GROUP=3]="START_GROUP",e[e.END_GROUP=4]="END_GROUP",e[e.FIXED_32_BIT=5]="FIXED_32_BIT"}(Dr||(Dr={})),function(e){e[e.CASTV2_1_0=0]="CASTV2_1_0"}(Pr||(Pr={})),function(e){e[e.STRING=0]="STRING",e[e.BINARY=1]="BINARY"}(Br||(Br={}));const Qr=require("dgram");var Zr=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}l((n=n.apply(e,t||[])).next())}))};let en={},tn={},rn=(e,t)=>{let r=tn[e];if(void 0!==r)for(let e of r)e(t);let n=en[e];void 0!==n&&rn(n,t)},nn=(e,t,r)=>{en[t]=e,"A"===r&&rn(e,t)},sn=(e,t)=>Zr(void 0,void 0,void 0,(function*(){let r=new Array;for(;;){let n=e.readUInt8(t);if(0===n){t+=1;break}if(n<64){t+=1;let i=e.slice(t,t+n);t+=n,r.push(i.toString("binary"));continue}if(n<192)throw new Error;let i=yield sn(e,16383&e.readUInt16BE(t));r.push(i.value),t+=2;break}return{value:r.join("."),offset:t}})),on=(e,t)=>Zr(void 0,void 0,void 0,(function*(){let r=yield sn(e,t);return t=r.offset,e.readUInt16BE(t),t+=2,e.readUInt16BE(t),t+=2,{value:r.value,offset:t}})),an=(e,t)=>Zr(void 0,void 0,void 0,(function*(){let r=yield sn(e,t);t=r.offset;let n=e.readUInt16BE(t);t+=2,e.readUInt16BE(t),t+=2,e.readUInt32BE(t),t+=4;let i=e.readUInt16BE(t);t+=2;let s="";if(1===n&&(s=`${e[t+0]}.${e[t+1]}.${e[t+2]}.${e[t+3]}`,t+=4,nn(r.value,s,"A")),12===n){let n=yield sn(e,t);t=n.offset,s=n.value,nn(r.value,s,"PTR")}if(16===n){let r=e.slice(t,t+i);t+=i,s=r.toString("binary")}if(33===n){e.readUInt16BE(t),t+=2,e.readUInt16BE(t),t+=2,e.readUInt16BE(t),t+=2;let n=yield sn(e,t);t=n.offset,s=n.value,nn(r.value,s,"SRV")}return{name:r.value,data:s,offset:t}}));const ln="224.0.0.251";let dn=Qr.createSocket({type:"udp4",reuseAddr:!0});dn.on("listening",(()=>{dn.setMulticastLoopback(!1),dn.addMembership(ln,"0.0.0.0")})),dn.on("message",((e,t)=>Zr(void 0,void 0,void 0,(function*(){try{yield(e=>Zr(void 0,void 0,void 0,(function*(){let t=0,r=e.slice(t,t+12);t+=12,r.readUInt16BE(0),r.readUInt16BE(2);let n=r.readUInt16BE(4),i=r.readUInt16BE(6),s=r.readUInt16BE(8),o=r.readUInt16BE(10),a=new Array;for(let r=0;r<n;r++){let r=yield on(e,t);a.push(r),t=r.offset}let l=new Array;for(let r=0;r<i;r++){let r=yield an(e,t);l.push(r),t=r.offset}let d=new Array;for(let r=0;r<s;r++){let r=yield an(e,t);d.push(r),t=r.offset}let u=new Array;for(let r=0;r<o;r++){let r=yield an(e,t);u.push(r),t=r.offset}})))(e)}catch(e){}})))),dn.bind(5353);const un={CONNECT:a.l8.Object.of({type:a.l8.StringLiteral.of("CONNECT")}),CLOSE:a.l8.Object.of({type:a.l8.StringLiteral.of("CLOSE")})},cn={PING:a.l8.Object.of({type:a.l8.StringLiteral.of("PING")}),PONG:a.l8.Object.of({type:a.l8.StringLiteral.of("PONG")})},fn=a.l8.Object.of({url:a.l8.String,height:a.l8.Union.of(a.l8.Undefined,a.l8.Number),width:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),pn=a.l8.Object.of({level:a.l8.Union.of(a.l8.Undefined,a.l8.Number),muted:a.l8.Union.of(a.l8.Undefined,a.l8.Boolean)}),hn=a.l8.Object.of({contentId:a.l8.String,streamType:a.l8.Union.of(a.l8.StringLiteral.of("NONE"),a.l8.StringLiteral.of("BUFFERED"),a.l8.StringLiteral.of("LIVE")),contentType:a.l8.String,metadata:a.l8.Union.of(a.l8.Undefined,a.l8.Union.of(a.l8.Reference.of((()=>gn)),a.l8.Reference.of((()=>mn)),a.l8.Reference.of((()=>vn)),a.l8.Reference.of((()=>yn)),a.l8.Reference.of((()=>bn)))),duration:a.l8.Union.of(a.l8.Undefined,a.l8.Number),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any)),tracks:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Union.of(a.l8.Object.of({trackId:a.l8.Number,type:a.l8.String}),a.l8.Object.of({trackId:a.l8.Number,type:a.l8.StringLiteral.of("TEXT"),trackType:a.l8.StringLiteral.of("TEXT"),trackContentId:a.l8.String,trackContentType:a.l8.String,subtype:a.l8.StringLiteral.of("SUBTITLES"),language:a.l8.String,name:a.l8.Union.of(a.l8.Undefined,a.l8.String),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}))))}),gn=a.l8.Object.of({metadataType:a.l8.NumberLiteral.of(0),title:a.l8.Union.of(a.l8.Undefined,a.l8.String),subtitle:a.l8.Union.of(a.l8.Undefined,a.l8.String),images:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Reference.of((()=>fn)))),releaseDate:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),mn=a.l8.Object.of({metadataType:a.l8.NumberLiteral.of(1),title:a.l8.Union.of(a.l8.Undefined,a.l8.String),subtitle:a.l8.Union.of(a.l8.Undefined,a.l8.String),studio:a.l8.Union.of(a.l8.Undefined,a.l8.String),images:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Reference.of((()=>fn)))),releaseDate:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),vn=a.l8.Object.of({metadataType:a.l8.NumberLiteral.of(2),seriesTitle:a.l8.Union.of(a.l8.Undefined,a.l8.String),subtitle:a.l8.Union.of(a.l8.Undefined,a.l8.String),season:a.l8.Union.of(a.l8.Undefined,a.l8.Number),episode:a.l8.Union.of(a.l8.Undefined,a.l8.Number),images:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Reference.of((()=>fn)))),originalAirDate:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),yn=a.l8.Object.of({metadataType:a.l8.NumberLiteral.of(3),albumName:a.l8.Union.of(a.l8.Undefined,a.l8.String),title:a.l8.Union.of(a.l8.Undefined,a.l8.String),albumArtist:a.l8.Union.of(a.l8.Undefined,a.l8.String),artist:a.l8.Union.of(a.l8.Undefined,a.l8.String),composer:a.l8.Union.of(a.l8.Undefined,a.l8.String),trackNumber:a.l8.Union.of(a.l8.Undefined,a.l8.Number),discNumber:a.l8.Union.of(a.l8.Undefined,a.l8.Number),images:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Reference.of((()=>fn)))),releaseDate:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),bn=a.l8.Object.of({metadataType:a.l8.NumberLiteral.of(4),title:a.l8.Union.of(a.l8.Undefined,a.l8.String),artist:a.l8.Union.of(a.l8.Undefined,a.l8.String),location:a.l8.Union.of(a.l8.Undefined,a.l8.String),latitude:a.l8.Union.of(a.l8.Undefined,a.l8.Number),longitude:a.l8.Union.of(a.l8.Undefined,a.l8.Number),width:a.l8.Union.of(a.l8.Undefined,a.l8.Number),height:a.l8.Union.of(a.l8.Undefined,a.l8.Number),creationDateTime:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),Sn=a.l8.Object.of({mediaSessionId:a.l8.Number,media:a.l8.Union.of(a.l8.Undefined,a.l8.Union.of(a.l8.Reference.of((()=>hn)),a.l8.Object.of({}))),playbackRate:a.l8.Number,playerState:a.l8.Union.of(a.l8.StringLiteral.of("IDLE"),a.l8.StringLiteral.of("PLAYING"),a.l8.StringLiteral.of("BUFFERING"),a.l8.StringLiteral.of("PAUSED")),idleReason:a.l8.Union.of(a.l8.Undefined,a.l8.Union.of(a.l8.StringLiteral.of("CANCELLED"),a.l8.StringLiteral.of("INTERRUPTED"),a.l8.StringLiteral.of("FINISHED"),a.l8.StringLiteral.of("ERROR"))),currentTime:a.l8.Number,supportedMediaCommands:a.l8.Number,volume:a.l8.Reference.of((()=>pn)),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),_n=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("LOAD"),media:a.l8.Reference.of((()=>hn)),autoplay:a.l8.Union.of(a.l8.Undefined,a.l8.Boolean),currentTime:a.l8.Union.of(a.l8.Undefined,a.l8.Number),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any)),activeTrackIds:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Number))}),wn=a.l8.Object.of({mediaSessionId:a.l8.Number,requestId:a.l8.Number,type:a.l8.StringLiteral.of("PAUSE"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),On=a.l8.Object.of({mediaSessionId:a.l8.Number,requestId:a.l8.Number,type:a.l8.StringLiteral.of("SEEK"),resumeState:a.l8.Union.of(a.l8.Undefined,a.l8.Union.of(a.l8.StringLiteral.of("PLAYBACK_START"),a.l8.StringLiteral.of("PLAYBACK_PAUSE"))),currentTime:a.l8.Union.of(a.l8.Undefined,a.l8.Number),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),En=a.l8.Object.of({mediaSessionId:a.l8.Number,requestId:a.l8.Number,type:a.l8.StringLiteral.of("STOP"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),Rn=a.l8.Object.of({mediaSessionId:a.l8.Number,requestId:a.l8.Number,type:a.l8.StringLiteral.of("PLAY"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),Tn=a.l8.Object.of({mediaSessionId:a.l8.Union.of(a.l8.Undefined,a.l8.Number),requestId:a.l8.Number,type:a.l8.StringLiteral.of("GET_STATUS"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),kn=a.l8.Object.of({mediaSessionId:a.l8.Number,requestId:a.l8.Number,type:a.l8.StringLiteral.of("VOLUME"),volume:a.l8.Reference.of((()=>pn)),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),Nn=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("INVALID_PLAYER_STATE"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),In=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("LOAD_FAILED"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),jn=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("LOAD_CANCELLED"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),xn=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("INVALID_REQUEST"),reason:a.l8.Union.of(a.l8.StringLiteral.of("INVALID_COMMAND"),a.l8.StringLiteral.of("DUPLICATE_REQUESTID")),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),Un=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("MEDIA_STATUS"),status:a.l8.Array.of(a.l8.Reference.of((()=>Sn))),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),An={LOAD:_n,PAUSE:wn,SEEK:On,STOP:En,PLAY:Rn,GET_STATUS:Tn,VOLUME:kn,INVALID_PLAYER_STATE:Nn,LOAD_FAILED:In,LOAD_CANCELLED:jn,INVALID_REQUEST:xn,MEDIA_STATUS:Un},Cn={LAUNCH:a.l8.Object.of({type:a.l8.StringLiteral.of("LAUNCH"),requestId:a.l8.Number,appId:a.l8.String}),STOP:a.l8.Object.of({type:a.l8.StringLiteral.of("STOP"),requestId:a.l8.Number,sessionId:a.l8.String}),GET_STATUS:a.l8.Object.of({type:a.l8.StringLiteral.of("GET_STATUS"),requestId:a.l8.Number}),GET_APP_AVAILABILITY:a.l8.Object.of({type:a.l8.StringLiteral.of("GET_APP_AVAILABILITY"),requestId:a.l8.Number,appId:a.l8.Array.of(a.l8.String)}),SET_VOLUME:a.l8.Object.of({type:a.l8.StringLiteral.of("SET_VOLUME"),requestId:a.l8.Number,volume:a.l8.Union.of(a.l8.Object.of({level:a.l8.Number}),a.l8.Object.of({muted:a.l8.Boolean}))}),RECEIVER_STATUS:a.l8.Object.of({type:a.l8.StringLiteral.of("RECEIVER_STATUS"),requestId:a.l8.Number,status:a.l8.Object.of({applications:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Object.of({appId:a.l8.String,displayName:a.l8.String,iconUrl:a.l8.String,isIdleScreen:a.l8.Boolean,launchedFromCloud:a.l8.Boolean,namespaces:a.l8.Array.of(a.l8.Object.of({name:a.l8.String})),sessionId:a.l8.String,statusText:a.l8.String,transportId:a.l8.String}))),userEq:a.l8.Object.of({}),volume:a.l8.Object.of({controlType:a.l8.String,level:a.l8.Number,muted:a.l8.Boolean,stepInterval:a.l8.Number})})})},Ln={eng:{title:"English",iso639_1:"en",iso3166_1:"US"},swe:{title:"Swedish",iso639_1:"sv",iso3166_1:"SE"},jpn:{title:"Japanese",iso639_1:"ja",iso3166_1:"JP"}};const Dn="https://ap.joelek.se";function Pn(e){var t;let r=null!==(t=Ln[null!=e?e:"eng"])&&void 0!==t?t:Ln.eng;return{language:[r.iso639_1,r.iso3166_1].join("-"),name:r.title}}const Bn=new Set,Hn=new Set;function qn(e){!function(e){if(!Hn.has(e)){Hn.add(e);for(let t of Bn)try{e(t)}catch(e){}}}((r=>{return n=this,i=void 0,o=function*(){let n=yield function(e){return new Promise(((t,r)=>{let n=Hr.connect({host:e,port:8009,rejectUnauthorized:!1});n.on("secureConnect",(()=>{console.log(`Connected to chromecast at ${e}.`),t(n)})),n.on("close",(()=>{console.log(`Disconnected from chromecast at ${e}.`)})),n.on("error",(e=>{n.end()}))}))}(r);n.on("close",(()=>{Bn.delete(r)}));let i=yield function(e){return new Promise(((r,n)=>{t.get(`http://${e}:8008/ssdp/device-desc.xml`,(e=>{let t=[];e.on("data",(e=>{t.push(e)})),e.on("end",(()=>{let e=Buffer.concat(t).toString(),n=/<friendlyName>([^<]+)<\/friendlyName>/.exec(e);z(n)?r(n[1]):r(void 0)})),e.on("error",(()=>{n()}))}))}))}(r);new Wn(n,null!=i?i:"Chromecast",e)},new((s=void 0)||(s=Promise))((function(e,t){function r(e){try{l(o.next(e))}catch(e){t(e)}}function a(e){try{l(o.throw(e))}catch(e){t(e)}}function l(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(r,a)}l((o=o.apply(n,i||[])).next())}));var n,i,s,o}))}((e,t)=>{let r=tn[e];void 0===r&&(r=new Array,tn[e]=r),r.push((e=>{if(!Bn.has(e)){Bn.add(e);for(let t of Hn)try{t(e)}catch(e){}}})),(e=>{let t=Buffer.alloc(12);t.writeUInt16BE(1,4);let r=Buffer.alloc(1e3),n=0;e.split(".").forEach((e=>{if(e.length>=64)throw new Error;r.writeUInt8(e.length,n),n+=1,r.write(e,n),n+=e.length})),r.writeUInt8(0,n),n+=1,r.writeUInt16BE(12,n),n+=2,r.writeUInt16BE(1,n),n+=2,r=r.slice(0,0+n),dn.send(Buffer.concat([t,r]),5353,ln)})(e)})("_googlecast._tcp.local");class Mn{constructor(e,t){this.socket=e,function(e,t){let r=Buffer.alloc(0),n=!0,i=4;e.on("data",(e=>{for(r=Buffer.concat([r,e]);r.length>=i;){let e=r.slice(0,i);r=r.slice(i),n?(n=!1,i=e.readUInt32BE(0)):(n=!0,i=4,t(e))}}))}(e,(e=>{try{let r=function(e){let t=function(e){let t=new Array;for(;e.offset<e.buffer.length;){let r=Jr(e);t.push(r)}return t}({buffer:e,offset:0});return{protocol_version:Wr(1,t),source_id:Xr(2,t),destination_id:Xr(3,t),namespace:Xr(4,t),payload_type:Wr(5,t),payload_utf8:function(e,t){try{return Xr(6,t)}catch(e){return}}(0,t),payload_binary:function(e,t){try{return function(e,t){let r=t.filter((e=>7===e.key.field_number));if(0===r.length)throw"Expected required field to be present!";return r[r.length-1].data}(0,t)}catch(e){return}}(0,t)}}(e);t(r)}catch(e){console.log(e)}}))}getRequestId(){return Math.floor(65536*Math.random())}send(e){var t,r,n,i;let s=function(e){return Buffer.concat([Vr(1,e.protocol_version),Yr(2,e.source_id),Yr(3,e.destination_id),Yr(4,e.namespace),Vr(5,e.payload_type),(6,t=e.payload_utf8,null==t?Buffer.alloc(0):Yr(6,t)),Kr(7,e.payload_binary)]);var t}({protocol_version:null!==(t=e.protocol_version)&&void 0!==t?t:Pr.CASTV2_1_0,source_id:null!==(r=e.source_id)&&void 0!==r?r:"sender-0",destination_id:null!==(n=e.destination_id)&&void 0!==n?n:"receiver-0",namespace:e.namespace,payload_type:null!==(i=e.payload_type)&&void 0!==i?i:Br.STRING,payload_utf8:e.payload_utf8,payload_binary:e.payload_binary}),o=Buffer.alloc(4);o.writeUInt32BE(s.length,0),this.socket.write(o),this.socket.write(s)}}class Gn{constructor(e){this.messageHandler=e,this.serializer=new a.m7.MessageSerializer(un),this.listeners=new Nr.routing.MessageRouter}handle(e){var t;let r=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),n=a.l8.String.as(r.type);this.serializer.deserialize(JSON.stringify({type:n,data:r}),((e,t)=>{this.listeners.route(e,t)}))}send(e,t,r){this.messageHandler.send({namespace:Gn.NAMESPACE,destination_id:r,payload_utf8:JSON.stringify(t)})}}Gn.NAMESPACE="urn:x-cast:com.google.cast.tp.connection";class Fn{constructor(e){this.messageHandler=e,this.serializer=new a.m7.MessageSerializer(cn),this.listeners=new Nr.routing.MessageRouter}handle(e){var t;let r=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),n=a.l8.String.as(r.type);this.serializer.deserialize(JSON.stringify({type:n,data:r}),((e,t)=>{this.listeners.route(e,t)}))}send(e,t){this.messageHandler.send({namespace:Fn.NAMESPACE,payload_utf8:JSON.stringify(t)})}}Fn.NAMESPACE="urn:x-cast:com.google.cast.tp.heartbeat";class $n{constructor(e){this.transportId=new xt(void 0),this.mediaSessionId=new xt(void 0),this.messageHandler=e,this.serializer=new a.m7.MessageSerializer(An),this.callbacks=new Map,this.listeners=new Nr.routing.MessageRouter}handle(e){var t;let r=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),n=a.l8.String.as(r.type);try{this.serializer.deserialize(JSON.stringify({type:n,data:r}),((e,t)=>{let r=this.callbacks.get(t.requestId);z(r)&&(this.callbacks.delete(t.requestId),r(t)),this.listeners.route(e,t)}))}catch(e){console.log(JSON.stringify(r,null,2))}}send(e,t,r){t.requestId=this.messageHandler.getRequestId(),z(r)&&this.callbacks.set(t.requestId,r),this.messageHandler.send({namespace:$n.NAMESPACE,destination_id:this.transportId.getState(),payload_utf8:JSON.stringify(t)})}}$n.NAMESPACE="urn:x-cast:com.google.cast.media";class Jn{constructor(e){this.messageHandler=e,this.serializer=new a.m7.MessageSerializer(Cn),this.callbacks=new Map,this.listeners=new Nr.routing.MessageRouter}handle(e){var t;let r=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),n=a.l8.String.as(r.type);this.serializer.deserialize(JSON.stringify({type:n,data:r}),((e,t)=>{let r=this.callbacks.get(t.requestId);z(r)&&(this.callbacks.delete(t.requestId),r(t)),this.listeners.route(e,t)}))}send(e,t,r){t.requestId=this.messageHandler.getRequestId(),z(r)&&this.callbacks.set(t.requestId,r),this.messageHandler.send({namespace:Jn.NAMESPACE,payload_utf8:JSON.stringify(t)})}}Jn.NAMESPACE="urn:x-cast:com.google.cast.receiver";const zn="CC1AD845";class Wn{constructor(e,t,r){let n=new Mn(e,(e=>{let t=e.namespace;t===Gn.NAMESPACE?this.connectionHandler.handle(e):t===Fn.NAMESPACE?this.heartbeatHandler.handle(e):t===$n.NAMESPACE?this.mediaHandler.handle(e):t===Jn.NAMESPACE&&this.receiverHandler.handle(e)}));this.socket=e,this.heartbeatHandler=new Fn(n),this.connectionHandler=new Gn(n),this.mediaHandler=new $n(n),this.receiverHandler=new Jn(n);let i=`${r?"wss:":"ws:"}//127.0.0.1/sockets/context/?type=chromecast&name=${t}`;this.context=new xr(i,(e=>new Ur.yU(e))),this.timer=void 0,e.on("close",(()=>{z(this.timer)&&clearTimeout(this.timer),this.context.close()})),this.connectionHandler.send("CONNECT",{type:"CONNECT"}),this.connectionHandler.listeners.addObserver("CLOSE",(e=>{this.mediaHandler.transportId.updateState(void 0)})),this.heartbeatHandler.listeners.addObserver("PING",(e=>{this.heartbeatHandler.send("PONG",{type:"PONG"})})),this.heartbeatHandler.listeners.addObserver("PONG",(e=>{this.setTimer()})),this.receiverHandler.listeners.addObserver("RECEIVER_STATUS",(e=>{var t;let r=(null!==(t=e.status.applications)&&void 0!==t?t:[]).find((e=>e.appId===zn));z(r)?this.mediaHandler.transportId.updateState(r.transportId):this.mediaHandler.transportId.updateState(void 0)})),this.mediaHandler.listeners.addObserver("MEDIA_STATUS",(e=>{let t=e.status[e.status.length-1];if(z(t)){let e=this.mediaHandler.mediaSessionId.getState();z(e)&&(t.mediaSessionId===e?this.context.isDeviceLocal.getState()&&"IDLE"===t.playerState&&"FINISHED"===t.idleReason&&this.context.next():this.mediaHandler.mediaSessionId.updateState(void 0))}})),this.setTimer(),this.mediaHandler.transportId.addObserver((e=>{z(e)&&this.connectionHandler.send("CONNECT",{type:"CONNECT"},e)})),this.context.isDeviceLocal.addObserver((e=>{if(e)J(this.mediaHandler.transportId.getState())&&this.receiverHandler.send("LAUNCH",{type:"LAUNCH",requestId:-1,appId:zn});else{let e=this.mediaHandler.mediaSessionId.getState();z(e)&&this.mediaHandler.send("STOP",{type:"STOP",requestId:-1,mediaSessionId:e})}}));{let e=()=>{let e=this.mediaHandler.transportId.getState(),t=this.context.currentLocalEntry.getState(),r=this.context.token.getState();if(z(e)&&z(t)&&z(r)){let e,n=function(e,t){if(or.is(e)){let r=e,n=r.season.show;return{contentId:`${Dn}/files/${e.segment.file.file_id}/?token=${t}`,contentType:r.segment.file.mime,streamType:"BUFFERED",metadata:{metadataType:0,title:r.title,subtitle:n.title},tracks:r.segment.subtitles.map(((e,r)=>Object.assign(Object.assign({},Pn(e.language)),{trackId:r,type:"TEXT",trackType:"TEXT",trackContentId:`${Dn}/files/${e.file.file_id}/?token=${t}`,trackContentType:e.file.mime,subtype:"SUBTITLES"})))}}if(er.is(e)){let r=e;return{contentId:`${Dn}/files/${e.segment.file.file_id}/?token=${t}`,contentType:r.segment.file.mime,streamType:"BUFFERED",metadata:{metadataType:0,title:r.title,images:J(r.artwork)?void 0:[{url:`${Dn}/files/${r.artwork.file_id}/?token=${t}`}]},tracks:r.segment.subtitles.map(((e,r)=>Object.assign(Object.assign({},Pn(e.language)),{trackId:r,type:"TEXT",trackType:"TEXT",trackContentId:`${Dn}/files/${e.file.file_id}/?token=${t}`,trackContentType:e.file.mime,subtype:"SUBTITLES"})))}}if(Gt.is(e)){let r=e,n=r.disc.album;return{contentId:`${Dn}/files/${e.segment.file.file_id}/?token=${t}`,contentType:e.segment.file.mime,streamType:"BUFFERED",metadata:{metadataType:0,title:r.title,subtitle:r.artists.map((e=>e.title)).join("  "),images:J(n.artwork)?void 0:[{url:`${Dn}/files/${n.artwork.file_id}/?token=${t}`}]}}}throw"Expected code to be unreachable!"}(t,r);if(z(n.tracks)){let t=n.tracks.find((e=>"sv-SE"===e.language));if(z(t))e=[t.trackId];else{let t=n.tracks.find((e=>"en-US"===e.language));if(z(t))e=[t.trackId];else{let t=n.tracks.find((e=>"ja-JP"===e.language));z(t)&&(e=[t.trackId])}}}this.mediaHandler.send("LOAD",{type:"LOAD",requestId:-1,media:n,autoplay:!1,activeTrackIds:e},(e=>{if(Un.is(e)){let t=e.status[e.status.length-1];z(t)&&this.mediaHandler.mediaSessionId.updateState(t.mediaSessionId)}}))}};this.mediaHandler.transportId.addObserver(e),this.context.currentLocalEntry.addObserver(e),this.context.token.addObserver(e)}this.mediaHandler.transportId.addObserver((e=>{J(e)&&this.context.isDeviceLocal.getState()&&this.context.transfer(void 0)})),this.mediaHandler.transportId.addObserver((e=>{J(e)&&this.mediaHandler.mediaSessionId.updateState(void 0)}));{let e=()=>{let e=this.mediaHandler.mediaSessionId.getState();z(e)&&(this.context.playback.getState()?this.mediaHandler.send("PLAY",{type:"PLAY",requestId:-1,mediaSessionId:e}):this.mediaHandler.send("PAUSE",{type:"PAUSE",requestId:-1,mediaSessionId:e}))};this.mediaHandler.mediaSessionId.addObserver(e),this.context.playback.addObserver(e)}{let e=()=>{var e;let t=this.mediaHandler.mediaSessionId.getState();if(z(t)){let r=null!==(e=this.context.progress.getState())&&void 0!==e?e:0;this.mediaHandler.send("SEEK",{type:"SEEK",requestId:-1,mediaSessionId:t,currentTime:r})}};this.mediaHandler.mediaSessionId.addObserver(e),this.context.progress.addObserver(e)}}setTimer(){z(this.timer)&&(clearTimeout(this.timer),this.timer=void 0),this.timer=setTimeout((()=>{this.timer=void 0,this.heartbeatHandler.send("PING",{type:"PING"}),this.timer=setTimeout((()=>{this.socket.destroy()}),5e3)}),5e3)}}const Vn=new class{constructor(){this.tokens=new Map,this.sessions=new Map,this.chromecasts=new xt([]),this.tss=new Ar(kr),this.tss.addEventListener("sys","connect",(e=>{console.log("connect: "+e.connection_url);let t=Lr(e.connection_id,e.connection_url);this.tss.send("SetLocalDevice",e.connection_id,{device:t}),"chromecast"===t.type&&this.chromecasts.updateState([...this.chromecasts.getState(),t])})),this.tss.addEventListener("sys","disconnect",(e=>{console.log("disconnect: "+e.connection_url);let t=Lr(e.connection_id,e.connection_url);this.revokeAuthentication(e.connection_id),"chromecast"===t.type&&this.chromecasts.updateState(this.chromecasts.getState().filter((e=>e.id!==t.id)))})),this.tss.addEventListener("app","SetToken",(e=>{this.revokeAuthentication(e.connection_id);let t=e.data.token;if(z(t)){let r=vt(t);this.tokens.set(e.connection_id,t);let n=this.getSession(r),i=Lr(e.connection_id,e.connection_url);n.devices.updateState([...n.devices.getState(),i]),this.tss.send("SetContext",e.connection_id,{context:n.context}),this.tss.send("SetDevice",e.connection_id,{device:n.device}),this.tss.send("SetIndex",e.connection_id,{index:n.index}),this.tss.send("SetPlayback",e.connection_id,{playback:n.playback}),this.tss.send("SetProgress",e.connection_id,{progress:n.progress}),this.tss.send("SetToken",e.connection_id,{token:t})}})),this.tss.addEventListener("app","SetContext",(e=>{this.getExistingSession(e.connection_id,(t=>{J(t.device)&&(t.device=Lr(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),t.index=void 0,this.tss.send("SetIndex",t.devices.getState().map((e=>e.id)),{index:t.index}),t.context=e.data.context,this.tss.send("SetContext",t.devices.getState().map((e=>e.id)),e.data)}))})),this.tss.addEventListener("app","SetDevice",(e=>{this.getExistingSession(e.connection_id,(t=>{this.updateProgress(t),this.tss.send("SetProgress",t.devices.getState().map((e=>e.id)),{progress:t.progress}),t.device=e.data.device,this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),e.data),z(t.device)&&this.tss.send("SetToken",t.device.id,{token:this.tokens.get(e.connection_id)})}))})),this.tss.addEventListener("app","SetIndex",(e=>{this.getExistingSession(e.connection_id,(t=>{J(t.device)&&(t.device=Lr(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),t.progress=z(e.data.index)?0:void 0,t.progressTimestamp=Date.now(),this.tss.send("SetProgress",t.devices.getState().map((e=>e.id)),{progress:t.progress}),t.index=e.data.index,this.tss.send("SetIndex",t.devices.getState().map((e=>e.id)),e.data)}))})),this.tss.addEventListener("app","SetPlayback",(e=>{this.getExistingSession(e.connection_id,(t=>{J(t.device)&&(t.device=Lr(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),this.updateProgress(t),t.playback=e.data.playback,this.tss.send("SetPlayback",t.devices.getState().map((e=>e.id)),e.data)}))})),this.tss.addEventListener("app","SetProgress",(e=>{this.getExistingSession(e.connection_id,(t=>{J(t.device)&&(t.device=Lr(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),t.progress=e.data.progress,t.progressTimestamp=Date.now(),this.tss.send("SetProgress",t.devices.getState().map((e=>e.id)),e.data)}))}))}getExistingSession(e,t){let r=this.tokens.get(e);if(z(r)){let e=vt(r),n=this.sessions.get(e);z(n)&&t(n)}}getSession(e){let t=this.sessions.get(e);if(z(t))return t;const r={playback:!1,devices:new xt(new Array)};let n=new xt([]);{let e=()=>{let e=r.devices.getState(),t=this.chromecasts.getState().filter((t=>J(e.find((e=>e.id===t.id)))));n.updateState([...e,...t])};r.devices.addObserver(e),this.chromecasts.addObserver(e)}return n.addObserver((e=>{this.tss.send("SetDevices",r.devices.getState().map((e=>e.id)),{devices:e})})),r.devices.addObserver((e=>{this.updateProgress(r)})),r.devices.addObserver((e=>{J(e.find((e=>{var t;return e.id===(null===(t=r.device)||void 0===t?void 0:t.id)})))&&(this.updateProgress(r),r.playback=!1,this.tss.send("SetPlayback",e.map((e=>e.id)),{playback:r.playback}),r.device=void 0,this.tss.send("SetDevice",e.map((e=>e.id)),{device:r.device}))})),this.sessions.set(e,r),r}revokeAuthentication(e){let t=this.tokens.get(e);if(this.tokens.delete(e),z(t)){let r=vt(t),n=this.sessions.get(r);if(z(n)){let t=n.devices;t.updateState(t.getState().filter((t=>t.id!==e)))}}}updateProgress(e){let t=Date.now();e.playback&&z(e.progress)&&z(e.progressTimestamp)&&(e.progress+=(t-e.progressTimestamp)/1e3),e.progressTimestamp=t}getRequestHandler(){return this.tss.getRequestHandler()}};function Xn(t,r){t.headers.host;let n=t.method||"",o=t.url||"";if(/^[/]sockets[/]/.test(o))return Vn.getRequestHandler()(t,r);let a,l=Date.now();if(r.on("finish",(()=>{let e=Date.now()-l;process.stderr.write(`${r.statusCode} ${n}:${o} (${e} ms)\n`)})),"GET"===n&&"/favicon.ico"===o)return r.writeHead(404),void r.end();if("GET"===n&&null!==(a=/^[/]files[/]([0-9a-f]{32})[/]/.exec(o))){return((t,r,n)=>{if(void 0===r.url)throw new Error;let o="";try{var a=s.parse(r.url,!0);o=vt(a.query.token)}catch(e){return n.writeHead(401,{}),n.end()}let l,d=ie.lookup(t),u=d.path,c=d.mime,f=u.join(i.sep),p=e.openSync(f,"r"),h=e.fstatSync(p).size;e.closeSync(p);let g=r.headers.range;if(void 0!==g&&null!=(l=/^bytes\=((?:[0-9])|(?:[1-9][0-9]+))\-((?:[0-9])|(?:[1-9][0-9]+))?$/.exec(g))){let r=parseInt(l[1]),i=l[2]?parseInt(l[2]):null;if(null===i&&(i=h-1),r>=h||i>=h||i<r)return n.writeHead(416),void n.end();let s=i-r+1;n.writeHead(206,{"Access-Control-Allow-Origin":"*","Accept-Ranges":"bytes","Cache-Control":"private, max-age=86400","Content-Range":`bytes ${r}-${i}/${h}`,"Content-Type":c,"Content-Length":""+s}),(m=e.createReadStream(f,{start:r,end:i})).addListener("close",(()=>{r+m.bytesRead===h&&function(t,r){let n=Date.now();W.streams.push({username:t,file_id:r,timestamp_ms:n}),me.insert(r,{file_id:r,username:t,timestamp_ms:n}),e.writeFileSync("./private/db/streams.json",JSON.stringify(W,null,"\t"))}(o,t)})),m.on("open",(function(){m.pipe(n)})),m.on("error",(function(e){n.end()}))}else{var m;(m=e.createReadStream(f)).on("open",(function(){n.writeHead(200,{"Access-Control-Allow-Origin":"*","Accept-Ranges":"bytes","Cache-Control":"private, max-age=86400","Content-Type":c,"Content-Length":""+h}),m.pipe(n)})),m.on("error",(function(e){n.writeHead(404),n.end()}))}})(a[1],t,r)}if(/^[/]media[/]/.test(o)){if(null!=(a=/^[/]media[/]stills[/]([0-9a-f]{32})[/]/.exec(o))){let t=a[1],n=[".","private","stills",ie.lookup(t).file_id];if(!e.existsSync(n.join("/")))return r.writeHead(404),r.end();{let t=e.createReadStream(n.join("/"));t.on("open",(()=>{r.writeHead(200,{"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=86400","Content-Type":"image/jpeg"}),t.pipe(r)}))}return}if(null!=(a=/^[/]media[/]gifs[/]([0-9a-f]{32})[/]/.exec(o))){let t=a[1],n=Be.lookup(t),i=[".","private","memes",n.cue_id];if(e.existsSync(i.join("/"))){let t=e.createReadStream(i.join("/"));t.on("open",(()=>{r.writeHead(200,{"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=86400","Content-Type":"image/gif"}),t.pipe(r)}))}else!function(e,t,r){let n=Y.video.subtitles.find((e=>e.subtitle_id===t.subtitle_id)),i=Y.files.find((e=>e.file_id===n.file_id));const s=function(e){return ie.lookup(e.video_file_id)}(n);if(null==s)return r();kt(((n,o)=>{let a=[...n,"subtitle.vtt"],l=[...n,"palette.png"],d=[...n,"meme.gif"],u=_t.spawn("ffmpeg",["-ss",q(t.start_ms),"-t",q(Math.min(t.duration_ms,5e3)),"-i",[".",...i.path].join("/"),a.join("/"),"-y"]);u.on("error",(()=>(console.log("ffmpeg command failed!"),It(n.join("/")),r()))),u.on("exit",(()=>{_t.spawn("ffmpeg",["-ss",q(t.start_ms),"-t",q(Math.min(t.duration_ms,5e3)),"-i",[".",...s.path].join("/"),"-vf","fps=15,scale=w=384:h=216:force_original_aspect_ratio=decrease,pad=384:216:-1:-1,subtitles="+a.join("/")+":force_style='Bold=1,Fontsize=24,Outline=2',palettegen",l.join("/"),"-y"]).on("exit",(()=>{_t.spawn("ffmpeg",["-ss",q(t.start_ms),"-t",q(Math.min(t.duration_ms,5e3)),"-i",[".",...s.path].join("/"),"-i",l.join("/"),"-filter_complex","fps=15,scale=w=384:h=216:force_original_aspect_ratio=decrease,pad=384:216:-1:-1,subtitles="+a.join("/")+":force_style='Bold=1,Fontsize=24,Outline=2'[x];[x][1:v]paletteuse","-map_metadata","-1",d.join("/"),"-y"]).on("exit",(()=>(Nt(d,e),It(n.join("/")),r())))}))}))}))}(i,n,(()=>{if(!e.existsSync(i.join("/")))return r.writeHead(500),r.end();let t=e.createReadStream(i.join("/"));t.on("open",(()=>{r.writeHead(200,{"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=86400","Content-Type":"image/gif"}),t.pipe(r)}))}));return}}return/^[/]api[/]/.test(o)?((e,t)=>{try{St.route(e,t)}catch(e){t.writeHead(500),t.end(JSON.stringify({error:""+e}))}})(t,r):"GET"===n?(r.writeHead(200),void r.end(`<!doctype html><html><head><base href="/"/><meta charset="utf-8"/><meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0" name="viewport"/><link href="https://fonts.googleapis.com/css2?family=Nunito&family=Pacifico&family=Space+Mono&display=swap" rel="stylesheet"/><title>Orbit</title></head><body><script>${e.readFileSync("./dist/client.min.js")}<\/script></body></html>`)):(console.log("unhandled",JSON.stringify(t.headers,null,"\t")),r.writeHead(400),void r.end())}function Yn(t){if(e.existsSync(t))return e.readFileSync(t)}e.existsSync("./private/certs/")||e.mkdirSync("./private/certs/",{recursive:!0});let Kn=Yn("./private/certs/full_chain.pem"),Qn=Yn("./private/certs/dhparam.pem"),Zn=Yn("./private/certs/certificate_key.pem");if(Kn&&Zn){let e=n.createServer({cert:Kn,dhparam:Qn,key:Zn},Xn);e.listen(443,(()=>{console.log("https://localhost:443")})),e.keepAliveTimeout=6e4,t.createServer({},((e,t)=>{let r=e.headers.host||"",n=e.url||"",i=r.split(":").shift();t.writeHead(307,{Location:"https://"+i+":443"+n}),t.end()})).listen(80,(()=>{console.log("http://localhost:80")})),qn(!0)}else{let e=t.createServer({},Xn);e.listen(80,(()=>{console.log("http://localhost:80")})),e.keepAliveTimeout=6e4,qn(!1)}})()})();