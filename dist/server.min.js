(()=>{"use strict";var e={375:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Union=t.Undefined=t.Tuple=t.StringLiteral=t.String=t.Reference=t.Record=t.Object=t.NumberLiteral=t.Number=t.Null=t.Intersection=t.BooleanLiteral=t.Boolean=t.Array=t.Any=void 0,t.Any={as:(e,t="")=>e,is(e){try{this.as(e)}catch(e){return!1}return!0}},t.Array={of:e=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Array){for(let n=0;n<t.length;n++)e.as(t[n],r+"["+n+"]");return t}throw"Expected an array at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Boolean={as(e,t=""){if(null!=e&&e.constructor===globalThis.Boolean)return e;throw"Expected a boolean at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.BooleanLiteral={of:e=>({as(t,r=""){if(t===e)return t;throw"Expected "+e+" at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Intersection={of:(...e)=>({as(t,r=""){for(let n of e)n.as(t,r);return t},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Null={as(e,t=""){if(null===e)return e;throw"Expected null at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.Number={as(e,t=""){if(null!=e&&e.constructor===globalThis.Number)return e;throw"Expected a number at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.NumberLiteral={of:e=>({as(t,r=""){if(t===e)return t;throw"Expected "+e+" at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Object={of:e=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Object){for(let n in e)e[n].as(t[n],r+/^([a-z][a-z0-9_]*)$/is.test(n)?"."+n:'["'+n+'"]');return t}throw"Expected an object at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Record={of:e=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Object){for(let n of globalThis.Object.keys(t))e.as(t[n],r+'["'+n+'"]');return t}throw"Expected a record at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Reference={of:e=>({as:(t,r="")=>e().as(t,r),is:t=>e().is(t)})},t.String={as(e,t=""){if(null!=e&&e.constructor===globalThis.String)return e;throw"Expected a string at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.StringLiteral={of:e=>({as(t,r=""){if(t===e)return t;throw'Expected "'+e+'" at '+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Tuple={of:(...e)=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Array){for(let n=0;n<e.length;n++)e[n].as(t[n],r+"["+n+"]");return t}throw"Expected a tuple at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Undefined={as(e,t=""){if(void 0===e)return e;throw"Expected undefined at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.Union={of:(...e)=>({as(t,r=""){for(let n of e)try{return n.as(t,r)}catch(e){}throw"Expected a union at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})}},175:(e,t,r)=>{t.m7=t.l8=void 0;const n=r(375);t.l8=n;r(226);const i=r(129);t.m7=i;r(329)},226:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Schema=t.UnionType=t.UndefinedType=t.TupleType=t.StringLiteralType=t.StringType=t.ReferenceType=t.RecordType=t.ObjectType=t.NumberLiteralType=t.NumberType=t.NullType=t.IntersectionType=t.GroupType=t.BooleanLiteralType=t.BooleanType=t.ArrayType=t.AnyType=t.Type=void 0;const n=r(329);t.Type={parse(e,...t){try{return S.parse(e,...t)}catch(e){}try{return d.parse(e,...t)}catch(e){}try{return s.parse(e,...t)}catch(e){}try{return i.parse(e)}catch(e){}try{return o.parse(e)}catch(e){}try{return a.parse(e)}catch(e){}try{return c.parse(e)}catch(e){}try{return u.parse(e)}catch(e){}try{return f.parse(e)}catch(e){}try{return m.parse(e)}catch(e){}try{return y.parse(e)}catch(e){}try{return v.parse(e)}catch(e){}try{return g.parse(e)}catch(e){}try{return b.parse(e)}catch(e){}try{return p.parse(e)}catch(e){}try{return l.parse(e)}catch(e){}try{return h.parse(e)}catch(e){}return e.newContext(((e,t)=>{let r=e();throw`Unexpected ${r.family} at row ${r.row}, col ${r.col}!`}))}};class i{constructor(){}generateType(e){return"any"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\treturn subject;"),t.push("}")):t.push("autoguard.Any"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"any"),i.INSTANCE)))}}t.AnyType=i,i.INSTANCE=new i;class s{constructor(e){this.type=e}generateType(e){return this.type.generateType(e)+"[]"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Array)) {"),t.push("\t\tfor (let i = 0; i < subject.length; i++) {"),t.push("\t\t\t("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t\t"}))+')(subject[i], path + "[" + i + "]");'),t.push("\t\t}"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected an array at " + path + "!";'),t.push("}")):t.push("autoguard.Array.of("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}static parse(e,...r){if(r.includes("Array"))throw"Recursion prevention!";return e.newContext(((i,o)=>{let a=t.Type.parse(e,...r,"Array");n.expect(i(),"["),n.expect(i(),"]");let l=new s(a);for(;;)try{e.newContext(((e,t)=>{n.expect(e(),"["),n.expect(e(),"]"),l=new s(l)}))}catch(e){break}return l}))}}t.ArrayType=s;class o{constructor(){}generateType(e){return"boolean"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Boolean)) {"),t.push("\t\treturn subject as boolean;"),t.push("\t}"),t.push('\tthrow "Expected a boolean at " + path + "!";'),t.push("}")):t.push("autoguard.Boolean"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"boolean"),o.INSTANCE)))}}t.BooleanType=o,o.INSTANCE=new o;class a{constructor(e){this.value=e}generateType(e){return""+this.value}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+") {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected '+this.value+' at " + path + "!";'),t.push("}")):t.push("autoguard.BooleanLiteral.of("+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>"true"===n.expect(e(),["true","false"]).family?a.INSTANCE_TRUE:a.INSTANCE_FALSE))}}t.BooleanLiteralType=a,a.INSTANCE_TRUE=new a(!0),a.INSTANCE_FALSE=new a(!1);class l{constructor(e){this.type=e}generateType(e){return"("+this.type.generateType(e)+")"}generateTypeGuard(e){return this.type.generateTypeGuard(e)}static parse(e){return e.newContext(((r,i)=>{n.expect(r(),"(");let s=t.Type.parse(e);return n.expect(r(),")"),new l(s)}))}}t.GroupType=l;class d{constructor(){this.types=new Set}add(e){return this.types.add(e),this}generateType(e){let t=new Array;for(let r of this.types)t.push(r.generateType(e));return t.join(" & ")}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {");for(let r of this.types)t.push("\t("+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+")(subject, path);");return t.push("\treturn subject;"),t.push("}"),t.join(e.eol)}for(let r of this.types)t.push("\t"+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"autoguard.Intersection.of("+e.eol+t.join(","+e.eol)+e.eol+")"}static parse(e,...r){if(r.includes("Intersection"))throw"Recursion prevention!";return e.newContext(((i,s)=>{var o;let a=t.Type.parse(e,...r,"Intersection"),l=new d;for(l.add(a);"&"===(null===(o=s())||void 0===o?void 0:o.value);){n.expect(i(),"&");let s=t.Type.parse(e,...r,"Intersection");l.add(s)}return 1===l.types.size?a:l}))}}t.IntersectionType=d;class c{constructor(){}generateType(e){return"null"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === null) {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected null at " + path + "!";'),t.push("}")):t.push("autoguard.Null"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"null"),c.INSTANCE)))}}t.NullType=c,c.INSTANCE=new c;class u{constructor(){}generateType(e){return"number"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Number)) {"),t.push("\t\treturn subject as number;"),t.push("\t}"),t.push('\tthrow "Expected a number at " + path + "!";'),t.push("}")):t.push("autoguard.Number"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"number"),u.INSTANCE)))}}t.NumberType=u,u.INSTANCE=new u;class f{constructor(e){this.value=e}generateType(e){return""+this.value}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+") {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected '+this.value+' at " + path + "!";'),t.push("}")):t.push("autoguard.NumberLiteral.of("+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>{let r=n.expect(e(),"NUMBER_LITERAL").value;return new f(Number.parseInt(r))}))}}t.NumberLiteralType=f;class p{constructor(){this.members=new Map}add(e,t){return this.members.set(e,t),this}generateType(e){if(0===this.members.size)return"{}";let t=new Array;for(let[r,n]of this.members)t.push('\t"'+r+'"'+(n.optional?"?":"")+": "+n.type.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"{"+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+"}"}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Object)) {");for(let[r,n]of this.members){let i=n.type;if(n.optional){let e=new S;e.add(v.INSTANCE),e.add(i),i=e}let s=/^([a-z][a-z0-9_]*)$/is.test(r)?'".'+r+'"':'"[\\"'+r+'\\"]"';t.push("\t\t("+i.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+')(subject["'+r+'"], path + '+s+");")}return t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected an object at " + path + "!";'),t.push("}"),t.join(e.eol)}for(let[r,n]of this.members){let i=n.type;if(n.optional){let e=new S;e.add(v.INSTANCE),e.add(i),i=e}t.push('\t"'+r+'": '+i.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})))}return"autoguard.Object.of<"+(null!=this.typename?this.typename:this.generateType(e))+">({"+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+"})"}setTypename(e){this.typename=e}static parse(e){return e.newContext(((r,i)=>{var s,o,a;n.expect(r(),"{");let l=new p;if("}"!==(null===(s=i())||void 0===s?void 0:s.value))for(;;){let s=!1,d=n.expect(r(),["any","boolean","false","null","number","string","true","undefined","IDENTIFIER","STRING_LITERAL"]),c="STRING_LITERAL"===d.family?d.value.slice(1,-1):d.value;"?"===(null===(o=i())||void 0===o?void 0:o.value)&&(r(),s=!0),n.expect(r(),":");let u=t.Type.parse(e);if(l.add(c,{type:u,optional:s}),","!==(null===(a=i())||void 0===a?void 0:a.value))break;n.expect(r(),",")}return n.expect(r(),"}"),l}))}}t.ObjectType=p;class h{constructor(e){this.type=e}generateType(e){return"Record<string, undefined | "+this.type.generateType(e)+">"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Object)) {"),t.push("\t\tfor (let key of globalThis.Object.keys(subject)) {"),t.push("\t\t\t("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t\t"}))+')(subject[key], path + "[\\"" + key + "\\"]");'),t.push("\t\t}"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected a record at " + path + "!";'),t.push("}")):t.push("autoguard.Record.of("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}static parse(e){return e.newContext(((r,i)=>{n.expect(r(),"{");let s=t.Type.parse(e);return n.expect(r(),"}"),new h(s)}))}}t.RecordType=h;class g{constructor(e){this.typename=e}generateType(e){return this.typename}generateTypeGuard(e){return e.standalone?this.typename+".as":"autoguard.Reference.of<"+this.typename+">(() => "+this.typename+")"}static parse(e){return e.newContext(((e,t)=>{var r;"@"===(null===(r=t())||void 0===r?void 0:r.family)&&n.expect(e(),"@");let i=n.expect(e(),"IDENTIFIER").value;return new g(i)}))}}t.ReferenceType=g;class m{constructor(){}generateType(e){return"string"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.String)) {"),t.push("\t\treturn subject as string;"),t.push("\t}"),t.push('\tthrow "Expected a string at " + path + "!";'),t.push("}")):t.push("autoguard.String"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"string"),m.INSTANCE)))}}t.StringType=m,m.INSTANCE=new m;class y{constructor(e){this.value=e}generateType(e){return'"'+this.value+'"'}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+") {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected \\"'+this.value+'\\" at " + path + "!";'),t.push("}")):t.push('autoguard.StringLiteral.of("'+this.value+'")'),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>{let r=n.expect(e(),"STRING_LITERAL").value;return new y(r.slice(1,-1))}))}}t.StringLiteralType=y;class b{constructor(){this.types=new Array}add(e){return this.types.push(e),this}generateType(e){let t=new Array;for(let r of this.types)t.push("\t"+r.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"["+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+"]"}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Array)) {");for(let r=0;r<this.types.length;r++){let n=this.types[r];t.push("\t\t("+n.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+")(subject["+r+'], path + "['+r+']");')}return t.push("\t\treturn subject as "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+";"),t.push("\t}"),t.push('\tthrow "Expected a tuple at " + path + "!";'),t.push("}"),t.join(e.eol)}for(let r of this.types)t.push("\t"+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"autoguard.Tuple.of("+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+")"}static parse(e){return e.newContext(((r,i)=>{var s,o;n.expect(r(),"[");let a=new b;if("]"!==(null===(s=i())||void 0===s?void 0:s.value))for(;;){let s=t.Type.parse(e);if(a.add(s),","!==(null===(o=i())||void 0===o?void 0:o.value))break;n.expect(r(),",")}return n.expect(r(),"]"),a}))}}t.TupleType=b;class v{constructor(){}generateType(e){return"undefined"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === undefined) {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected undefined at " + path + "!";'),t.push("}")):t.push("autoguard.Undefined"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"undefined"),v.INSTANCE)))}}t.UndefinedType=v,v.INSTANCE=new v;class S{constructor(){this.types=new Set}add(e){return this.types.add(e),this}generateType(e){let t=new Array;for(let r of this.types)t.push(r.generateType(e));return t.join(" | ")}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {");for(let r of this.types)t.push("\ttry {"),t.push("\t\treturn ("+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+")(subject, path);"),t.push("\t} catch (error) {}");return t.push('\tthrow "Expected a union at " + path + "!";'),t.push("}"),t.join(e.eol)}for(let r of this.types)t.push("\t"+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"autoguard.Union.of("+e.eol+t.join(","+e.eol)+e.eol+")"}static parse(e,...r){if(r.includes("Union"))throw"Recursion prevention!";return e.newContext(((i,s)=>{var o;let a=t.Type.parse(e,...r,"Union"),l=new S;for(l.add(a);"|"===(null===(o=s())||void 0===o?void 0:o.value);){n.expect(i(),"|");let s=t.Type.parse(e,...r,"Union");l.add(s)}return 1===l.types.size?a:l}))}}t.UnionType=S;class _{constructor(){this.types=new Map}add(e,t){return this.types.set(e,t),this}generateModule(e){let t=new Array;t.push("// This file was auto-generated by @joelek/ts-autoguard. Edit at own risk."),t.push(""),e.standalone||(t.push('import { guards as autoguard } from "@joelek/ts-autoguard";'),t.push(""));for(let[r,n]of this.types)t.push("export type "+r+" = "+n.generateType(e)+";"),t.push(""),e.standalone?(t.push("export const "+r+" = {"),t.push('\tas(subject: any, path: string = ""): '+r+" {"),t.push("\t\treturn ("+n.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+")(subject, path);"),t.push("\t},"),t.push("\tis(subject: any): subject is "+r+" {"),t.push("\t\ttry {"),t.push("\t\t\tthis.as(subject);"),t.push("\t\t} catch (error) {"),t.push("\t\t\treturn false;"),t.push("\t\t}"),t.push("\t\treturn true;"),t.push("\t}"),t.push("};"),t.push("")):(t.push("export const "+r+" = "+n.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol}))+";"),t.push(""));let r=new p;for(let[e,t]of this.types)r.add(e,{type:new g(e),optional:!1});return t.push("export type Autoguard = "+r.generateType(e)+";"),t.push(""),t.push("export const Autoguard = "+r.generateType(e)+";"),t.push(""),t.join(e.eol)}static parse(e){return e.newContext(((r,i)=>{var s,o,a;n.expect(r(),"{");let l=new _;if("}"!==(null===(s=i())||void 0===s?void 0:s.value))for(;;){let s=n.expect(r(),"IDENTIFIER").value;n.expect(r(),":");let d=t.Type.parse(e);if(null===(o=d.setTypename)||void 0===o||o.call(d,s),l.add(s,d),","!==(null===(a=i())||void 0===a?void 0:a.value))break;n.expect(r(),",")}if(n.expect(r(),"}"),null!=i())throw"Expected end of stream!";return l}))}}t.Schema=_},129:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MessageSerializer=void 0,t.MessageSerializer=class{constructor(e){this.guards=e}deserialize(e,t){let r=JSON.parse(e);if(null==r||r.constructor!==Object||null==r.type||r.type.constructor!==String)throw"Invalid message envelope!";{let e=r.type,n=r.data,i=this.guards[e];if(void 0===i)throw'Unknown message type "'+e+'"!';t(e,i.as(n))}}serialize(e,t){return JSON.stringify({type:e,data:t})}}},329:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.expect=t.Tokenizer=t.Families=void 0,t.Families=["WS","(",")","[","]","{","}","?","|","&","@",",",":","any","boolean","false","null","number","string","true","undefined","IDENTIFIER","NUMBER_LITERAL","STRING_LITERAL"],t.Tokenizer=class{constructor(e){let t={WS:/^([\t\r\n ]+)/ius,"(":/^([\(])/ius,")":/^([\)])/ius,"[":/^([\[])/ius,"]":/^([\]])/ius,"{":/^([\{])/ius,"}":/^([\}])/ius,"?":/^([\?])/ius,"|":/^([\|])/ius,"&":/^([&])/ius,"@":/^([@])/ius,",":/^([,])/ius,":":/^([:])/ius,any:/^(any)/ius,boolean:/^(boolean)/ius,false:/^(false)/ius,null:/^(null)/ius,number:/^(number)/ius,string:/^(string)/ius,true:/^(true)/ius,undefined:/^(undefined)/ius,IDENTIFIER:/^([a-z][a-z0-9_]*)/ius,NUMBER_LITERAL:/^(([1-9][0-9]+)|([0-9]))/ius,STRING_LITERAL:/^(["][^"]*["])/ius},r=new Array,n=1,i=1;for(;e.length>0;){let s;for(let r in t){let n=r,i=t[n].exec(e);null!=i&&(null==s||i[1].length>s[1].length)&&(s=[n,i[1]])}if(null==s)throw`Unrecognized token at row ${n}, col ${i}!`;r.push({family:s[0],value:s[1],row:n,col:i}),e=e.slice(s[1].length);let o=s[1].split(/\r?\n/);o.length>1&&(n+=o.length-1,i=1),i+=o[o.length-1].length}this.tokens=r.filter((e=>"WS"!==e.family)),this.offset=0}peek(){return this.tokens[this.offset]}read(){if(this.offset>=this.tokens.length)throw"Unexpectedly reached end of stream!";return this.tokens[this.offset++]}newContext(e){let t=this.offset;try{return e((()=>this.read()),(()=>this.peek()))}catch(e){throw this.offset=t,e}}},t.expect=function(e,t){if(!(Array.isArray(t)?t:[t]).includes(e.family))throw`Unexpected ${e.family} at row ${e.row}, col ${e.col}!`;return e}},745:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketClient=void 0;const n=r(417),i=r(605),s=r(211),o=r(835),a=r(978),l=r(410),d=r(93),c=r(611),u=r(302);t.WebSocketClient=class{constructor(e){var t;this.state=c.ReadyState.CONNECTING,this.listeners=new a.routing.MessageRouter,this.pending=new Array,this.socket=void 0;let r=n.randomBytes(16).toString("base64"),d={Connection:"upgrade",Host:null!==(t=o.parse(e).host)&&void 0!==t?t:"","Sec-WebSocket-Key":r,"Sec-WebSocket-Version":"13",Upgrade:"websocket"};(()=>{if(e.startsWith("wss:"))return function(e,t){return new Promise(((r,n)=>{s.get(e,t).on("upgrade",((e,t,n)=>{r({response:e,socket:t,buffer:n})})).on("error",n)}))}("https:"+e.substring(4),{headers:d,rejectUnauthorized:!1});if(e.startsWith("ws:"))return function(e,t){return new Promise(((r,n)=>{i.get(e,t).on("upgrade",((e,t,n)=>{r({response:e,socket:t,buffer:n})})).on("error",n)}))}("http:"+e.substring(3),{headers:d});throw`Expected ${e} to be a WebSocket URL!`})().then((e=>{var t,i;let s=e.response,o=e.socket,a=e.buffer;if(o.on("close",(()=>{this.state=c.ReadyState.CLOSED,this.listeners.route("close",void 0)})),o.on("error",(()=>{this.state=c.ReadyState.CLOSING,this.listeners.route("error",void 0),o.end()})),101!==s.statusCode)return o.emit("error");if("upgrade"!==(null===(t=u.getHeader(s,"Connection"))||void 0===t?void 0:t.toLowerCase()))return o.emit("error");if("websocket"!==(null===(i=u.getHeader(s,"Upgrade"))||void 0===i?void 0:i.toLowerCase()))return o.emit("error");let d=n.createHash("sha1").update(r+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11").digest("base64");if(u.getHeader(s,"Sec-WebSocket-Accept")!==d)return o.emit("error");this.socket=o;let f=()=>{for(;;)try{let e={buffer:a,offset:0},t=l.decodeFrame(e);this.onFrame(o,t),a=a.slice(e.offset)}catch(e){break}};this.socket.on("data",(e=>{a=Buffer.concat([a,e]),f()})),this.state=c.ReadyState.OPEN,this.listeners.route("open",void 0),f()}))}onFrame(e,t){if(0!==t.reserved1||0!==t.reserved2||0!==t.reserved3)return this.close(c.StatusCode.PROTOCOL_ERROR);if(t.opcode<8){if(t.opcode!==l.WebSocketFrameType.CONTINUATION&&t.opcode!==l.WebSocketFrameType.TEXT&&t.opcode!=l.WebSocketFrameType.BINARY)return this.close(c.StatusCode.PROTOCOL_ERROR);if(0===this.pending.length){if(t.opcode===l.WebSocketFrameType.CONTINUATION)return this.close(c.StatusCode.PROTOCOL_ERROR)}else if(t.opcode!==l.WebSocketFrameType.CONTINUATION)return this.close(c.StatusCode.PROTOCOL_ERROR);if(this.pending.push(t.payload),1===t.final){let e=Buffer.concat(this.pending);this.pending.splice(0),this.listeners.route("message",{data:e.toString()})}}else{if(1!==t.final)return this.close(c.StatusCode.PROTOCOL_ERROR);if(t.payload.length>125)return this.close(c.StatusCode.PROTOCOL_ERROR);if(t.opcode===l.WebSocketFrameType.CLOSE){if(this.readyState===c.ReadyState.CLOSING)return e.end();e.write(l.encodeFrame(Object.assign(Object.assign({},t),{masked:1})),(()=>e.end()))}else if(t.opcode===l.WebSocketFrameType.PING)e.write(l.encodeFrame(Object.assign(Object.assign({},t),{opcode:10,masked:1})));else if(t.opcode!==l.WebSocketFrameType.PONG)return this.close(c.StatusCode.PROTOCOL_ERROR)}}addEventListener(e,t){this.listeners.addObserver(e,t)}close(e){if(this.state!==c.ReadyState.OPEN)throw"Expected socket to be open!";const t=this.socket;if(d.absent(t))throw"Expected socket to be open!";let r=Buffer.alloc(0);d.present(e)&&(r=Buffer.concat([Buffer.alloc(2),Buffer.from("Connection closed by client.")]),r.writeUInt16BE(e,0));let n=l.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:l.WebSocketFrameType.CLOSE,masked:1,payload:r});t.write(n),this.state=c.ReadyState.CLOSING}removeEventListener(e,t){this.listeners.removeObserver(e,t)}send(e){if(this.state!==c.ReadyState.OPEN)throw"Expected socket to be open!";let t=this.socket;if(d.absent(t))throw"Expected socket to be open!";let r=l.WebSocketFrameType.BINARY;e instanceof Buffer||(e=Buffer.from(e,"utf8"),r=l.WebSocketFrameType.TEXT);let n=l.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:r,masked:1,payload:e});t.write(n)}get readyState(){return this.state}}},410:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.encodeFrame=t.decodeFrame=t.WebSocketFrameType=void 0;const n=r(417);var i;(i=t.WebSocketFrameType||(t.WebSocketFrameType={}))[i.CONTINUATION=0]="CONTINUATION",i[i.TEXT=1]="TEXT",i[i.BINARY=2]="BINARY",i[i.UNUSED_3=3]="UNUSED_3",i[i.UNUSED_4=4]="UNUSED_4",i[i.UNUSED_5=5]="UNUSED_5",i[i.UNUSED_6=6]="UNUSED_6",i[i.UNUSED_7=7]="UNUSED_7",i[i.CLOSE=8]="CLOSE",i[i.PING=9]="PING",i[i.PONG=10]="PONG",i[i.UNUSED_B=11]="UNUSED_B",i[i.UNUSED_C=12]="UNUSED_C",i[i.UNUSED_D=13]="UNUSED_D",i[i.UNUSED_E=14]="UNUSED_E",i[i.UNUSED_F=15]="UNUSED_F",t.decodeFrame=function(e){let t=e.buffer.readUInt8(e.offset)>>7&1,r=e.buffer.readUInt8(e.offset)>>6&1,n=e.buffer.readUInt8(e.offset)>>5&1,i=e.buffer.readUInt8(e.offset)>>4&1,s=e.buffer.readUInt8(e.offset)>>0&15;e.offset+=1;let o=e.buffer.readUInt8(e.offset)>>7&1,a=e.buffer.readUInt8(e.offset)>>0&127;if(e.offset+=1,126===a){if(a=e.buffer.readUInt16BE(e.offset),e.offset+=2,a<=125)throw"Invalid frame encoding!"}else if(127===a){if(0!==e.buffer.readUInt32BE(e.offset))throw"Invalid frame encoding!";if(e.offset+=4,a=e.buffer.readUInt32BE(e.offset),e.offset+=4,a<=65535)throw"Invalid frame encoding!"}let l=Buffer.alloc(4);if(1===o&&(l=e.buffer.slice(e.offset,e.offset+4),e.offset+=4),e.offset+a>e.buffer.length)throw"Invalid frame encoding!";let d=e.buffer.slice(e.offset,e.offset+a);if(e.offset+=a,1===o)for(let e=0;e<d.length;e++)d[e]=d[e]^l[3&e];return{final:t,reserved1:r,reserved2:n,reserved3:i,opcode:s,masked:o,payload:d}},t.encodeFrame=function(e){let t=new Array,r=e.payload.length,i=Buffer.alloc(2);t.push(i);let s=0;if(s|=(1&e.final)<<7,s|=(1&e.reserved1)<<6,s|=(1&e.reserved2)<<5,s|=(1&e.reserved3)<<4,s|=(15&e.opcode)<<0,i.writeUInt8(s,0),r<=125){let t=0;t|=(1&e.masked)<<7,t|=(127&r)<<0,i.writeUInt8(t,1)}else if(r<=65535){let n=0;n|=(1&e.masked)<<7,n|=126,i.writeUInt8(n,1);let s=Buffer.alloc(2);s.writeUInt16BE(r,0),t.push(s)}else{if(!(r<=4294967295))throw"Invalid frame size!";{let n=0;n|=(1&e.masked)<<7,n|=127,i.writeUInt8(n,1);let s=Buffer.alloc(8);s.writeUInt32BE(r,4),t.push(s)}}if(1===e.masked){let r=n.randomBytes(4),i=Buffer.concat([e.payload]);for(let e=0;e<i.length;e++)i[e]=i[e]^r[3&e];t.push(r,i)}else t.push(e.payload);return Buffer.concat(t)}},545:(e,t,r)=>{r(745),r(410),r(447),r(611);var n=r(745);Object.defineProperty(t,"yU",{enumerable:!0,get:function(){return n.WebSocketClient}});var i=r(447);Object.defineProperty(t,"u9",{enumerable:!0,get:function(){return i.WebSocketServer}})},93:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.present=t.absent=void 0,t.absent=function(e){return null==e},t.present=function(e){return null!=e}},447:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketServer=void 0;const n=r(417),i=r(16),s=r(978),o=r(410),a=r(93),l=r(611),d=r(302);t.WebSocketServer=class{constructor(){this.pending_chunks=new Map,this.states=new Map,this.connections=new d.BiMap,this.router=new s.routing.MessageRouter}onFrame(e,t,r,n){if(0!==n.reserved1||0!==n.reserved2||0!==n.reserved3)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(1!==n.masked)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(n.opcode<8){if(n.opcode!==o.WebSocketFrameType.CONTINUATION&&n.opcode!==o.WebSocketFrameType.TEXT&&n.opcode!=o.WebSocketFrameType.BINARY)return this.close(e,l.StatusCode.PROTOCOL_ERROR);{let r=this.pending_chunks.get(e);if(a.absent(r))r=new Array,this.pending_chunks.set(e,r);else if(n.opcode!==o.WebSocketFrameType.CONTINUATION)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(r.push(n.payload),1===n.final){let n=Buffer.concat(r);this.pending_chunks.delete(e),this.router.route("message",{connection_id:e,connection_url:t,buffer:n})}}}else{if(1!==n.final)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(n.payload.length>125)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(n.opcode===o.WebSocketFrameType.CLOSE){if(this.states.get(e)===l.ReadyState.CLOSING)return r.end();r.write(o.encodeFrame(Object.assign(Object.assign({},n),{masked:0})),(()=>r.end()))}else if(n.opcode===o.WebSocketFrameType.PING)r.write(o.encodeFrame(Object.assign(Object.assign({},n),{opcode:10,masked:0})));else if(n.opcode!==o.WebSocketFrameType.PONG)return this.close(e,l.StatusCode.PROTOCOL_ERROR)}}broadcast(e){for(let[t,r]of this.connections)this.states.get(t)===l.ReadyState.OPEN&&this.send(t,e)}addEventListener(e,t){return this.router.addObserver(e,t)}close(e,t){if(this.states.get(e)!==l.ReadyState.OPEN)throw"Expected socket to be open!";const r=this.connections.value(e);if(a.absent(r))throw'Connection with id "'+e+'" has no socket!';let n=Buffer.alloc(0);a.present(t)&&(n=Buffer.concat([Buffer.alloc(2),Buffer.from("Connection closed by server.")]),n.writeUInt16BE(t,0));let i=o.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:o.WebSocketFrameType.CLOSE,masked:0,payload:n});r.write(i),this.states.set(e,l.ReadyState.CLOSING)}getRequestHandler(){return(e,t)=>{let r=e.socket,s=this.connections.key(r);if(a.present(s))return t.writeHead(400),t.end();let c=e.httpVersionMajor,u=e.httpVersionMinor;if(c<1||1===c&&u<1)return t.writeHead(400),t.end();if("GET"!==e.method)return t.writeHead(400),t.end();let f=d.getHeader(e,"Host");if(a.absent(f))return t.writeHead(400),t.end();let p=d.getHeader(e,"Upgrade");if(a.absent(p)||"websocket"!==p.toLowerCase())return t.writeHead(400),t.end();let h=d.getHeader(e,"Connection");if(a.absent(h)||"upgrade"!==h.toLowerCase())return t.writeHead(400),t.end();let g=d.getHeader(e,"Sec-WebSocket-Key");if(a.absent(g)||16!==Buffer.from(g,"base64").length)return t.writeHead(400),t.end();if("13"!==d.getHeader(e,"Sec-WebSocket-Version"))return t.writeHead(426,{"Sec-WebSocket-Version":"13"}),t.end();let m=n.createHash("sha1").update(g+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11").digest("base64");return t.writeHead(101,{Upgrade:"websocket",Connection:"Upgrade","Sec-WebSocket-Accept":m}),t.end((()=>{let t=n.randomBytes(16).toString("hex"),s=function(e){let t=e.headers.host||"",r=e.url||"/";return`${e.socket instanceof i.TLSSocket?"wss:":"ws:"}//${t}${r}`}(e),a=Buffer.alloc(0);r.on("data",(e=>{for(a=Buffer.concat([a,e]);;)try{let e={buffer:a,offset:0},n=o.decodeFrame(e);this.onFrame(t,s,r,n),a=a.slice(e.offset)}catch(e){break}})),r.on("close",(()=>{this.connections.remove(t),this.states.delete(t),this.router.route("disconnect",{connection_id:t,connection_url:s})})),r.setTimeout(0),this.connections.add(t,r),this.states.set(t,l.ReadyState.OPEN),this.router.route("connect",{connection_id:t,connection_url:s})}))}}removeEventListener(e,t){return this.router.removeObserver(e,t)}send(e,t){if(this.states.get(e)!==l.ReadyState.OPEN)throw"Expected socket to be open!";let r=this.connections.value(e);if(a.absent(r))throw'Connection with id "'+e+'" has no socket!';let n=o.WebSocketFrameType.BINARY;t instanceof Buffer||(t=Buffer.from(t,"utf8"),n=o.WebSocketFrameType.TEXT);let i=o.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:n,masked:0,payload:t});r.write(i)}}},611:(e,t)=>{var r,n;Object.defineProperty(t,"__esModule",{value:!0}),t.StatusCode=t.ReadyState=void 0,(n=t.ReadyState||(t.ReadyState={}))[n.CONNECTING=0]="CONNECTING",n[n.OPEN=1]="OPEN",n[n.CLOSING=2]="CLOSING",n[n.CLOSED=3]="CLOSED",(r=t.StatusCode||(t.StatusCode={}))[r.NORMAL=1e3]="NORMAL",r[r.GOING_AWAY=1001]="GOING_AWAY",r[r.PROTOCOL_ERROR=1002]="PROTOCOL_ERROR",r[r.DATA_TYPE_NOT_ACCEPTED=1003]="DATA_TYPE_NOT_ACCEPTED",r[r.RESERVED_1004=1004]="RESERVED_1004",r[r.RESERVED_1005=1005]="RESERVED_1005",r[r.RESERVED_1006=1006]="RESERVED_1006",r[r.BAD_DATA_TYPE=1007]="BAD_DATA_TYPE",r[r.POLICY_VIOLATION=1008]="POLICY_VIOLATION",r[r.MESSAGE_TOO_BIG=1009]="MESSAGE_TOO_BIG",r[r.CLIENT_EXPECTED_EXTENSION=1010]="CLIENT_EXPECTED_EXTENSION",r[r.SERVER_UNEXPECTED_CONDITION=1011]="SERVER_UNEXPECTED_CONDITION",r[r.RESERVED_1015=1015]="RESERVED_1015"},302:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BiMap=t.getHeader=void 0;const n=r(93);t.getHeader=function(e,t){let r=e.headers[t.toLowerCase()];if(n.present(r)){if(r.constructor===String)return r;if(r.constructor===Array&&1===r.length)return r[0]}return null};class i{constructor(){this.value_to_key=new Map,this.key_to_value=new Map}[Symbol.iterator](){return this.key_to_value[Symbol.iterator]()}add(e,t){this.value_to_key.set(t,e),this.key_to_value.set(e,t)}key(e){return this.value_to_key.get(e)||null}remove(e){let t=this.key_to_value.get(e);n.present(t)&&this.value_to_key.delete(t),this.key_to_value.delete(e)}value(e){return this.key_to_value.get(e)||null}}t.BiMap=i},978:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.routing=r(220)},220:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.NamespacedMessageRouter=t.MessageRouter=void 0;class r{constructor(){this.observers=new Map}addObserver(e,t){let r=this.observers.get(e);void 0===r&&(r=new Set,this.observers.set(e,r)),r.add(t)}removeObserver(e,t){let r=this.observers.get(e);void 0!==r&&r.delete(t)}route(e,t){let r=this.observers.get(e);if(void 0!==r)for(let e of r)e(t)}}t.MessageRouter=r,t.NamespacedMessageRouter=class{constructor(){this.routers=new Map}addObserver(e,t,n){let i=this.routers.get(e);void 0===i&&(i=new r,this.routers.set(e,i)),i.addObserver(t,n)}removeObserver(e,t,r){let n=this.routers.get(e);void 0!==n&&n.removeObserver(t,r)}route(e,t,r){let n=this.routers.get(e);void 0!==n&&n.route(t,r)}}},417:e=>{e.exports=require("crypto")},605:e=>{e.exports=require("http")},211:e=>{e.exports=require("https")},16:e=>{e.exports=require("tls")},835:e=>{e.exports=require("url")}},t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={exports:{}};return e[n](i,i.exports,r),i.exports}(()=>{const e=require("fs");var t=r(605),n=r(211);const i=require("path");var s=r(835),o=r(417),a=r(175);const l=a.l8.Object.of({artist_id:a.l8.String,title:a.l8.String}),d=a.l8.Object.of({album_id:a.l8.String,title:a.l8.String,year:a.l8.Number,cover_file_id:a.l8.Union.of(a.l8.String,a.l8.Null)}),c=a.l8.Object.of({disc_id:a.l8.String,album_id:a.l8.String,number:a.l8.Number}),u=a.l8.Object.of({track_id:a.l8.String,disc_id:a.l8.String,file_id:a.l8.String,title:a.l8.String,number:a.l8.Number,duration:a.l8.Number}),f=a.l8.Object.of({album_id:a.l8.String,artist_id:a.l8.String}),p=a.l8.Object.of({track_id:a.l8.String,artist_id:a.l8.String}),h=a.l8.Object.of({video_genre_id:a.l8.String,title:a.l8.String}),g=a.l8.Object.of({movie_id:a.l8.String,title:a.l8.String,year:a.l8.Number,summary:a.l8.Union.of(a.l8.String,a.l8.Null),poster_file_id:a.l8.Union.of(a.l8.String,a.l8.Null)}),m=a.l8.Object.of({movie_id:a.l8.String,video_genre_id:a.l8.String}),y=a.l8.Object.of({movie_part_id:a.l8.String,movie_id:a.l8.String,file_id:a.l8.String,duration:a.l8.Number,number:a.l8.Number}),b=a.l8.Object.of({show_id:a.l8.String,title:a.l8.String}),v=a.l8.Object.of({show_id:a.l8.String,video_genre_id:a.l8.String}),S=a.l8.Object.of({season_id:a.l8.String,show_id:a.l8.String,number:a.l8.Number}),_=a.l8.Object.of({episode_id:a.l8.String,season_id:a.l8.String,file_id:a.l8.String,title:a.l8.String,number:a.l8.Number,duration:a.l8.Number,year:a.l8.Union.of(a.l8.Number,a.l8.Null),summary:a.l8.Union.of(a.l8.String,a.l8.Null)}),w=a.l8.Object.of({subtitle_id:a.l8.String,file_id:a.l8.String,video_file_id:a.l8.String,language:a.l8.Union.of(a.l8.String,a.l8.Null)}),O=a.l8.Object.of({subtitle_id:a.l8.String,cues:a.l8.Array.of(a.l8.Tuple.of(a.l8.Number,a.l8.Number,a.l8.String))}),E=(a.l8.Object.of({cue_id:a.l8.String,subtitle_id:a.l8.String,start_ms:a.l8.Number,duration_ms:a.l8.Number,lines:a.l8.Array.of(a.l8.String)}),a.l8.Object.of({file_id:a.l8.String,path:a.l8.Array.of(a.l8.String),mime:a.l8.String})),T=a.l8.Object.of({audio:a.l8.Object.of({artists:a.l8.Array.of(a.l8.Reference.of((()=>l))),albums:a.l8.Array.of(a.l8.Reference.of((()=>d))),discs:a.l8.Array.of(a.l8.Reference.of((()=>c))),tracks:a.l8.Array.of(a.l8.Reference.of((()=>u))),album_artists:a.l8.Array.of(a.l8.Reference.of((()=>f))),track_artists:a.l8.Array.of(a.l8.Reference.of((()=>p)))}),video:a.l8.Object.of({genres:a.l8.Array.of(a.l8.Reference.of((()=>h))),movie_parts:a.l8.Array.of(a.l8.Reference.of((()=>y))),movies:a.l8.Array.of(a.l8.Reference.of((()=>g))),movie_genres:a.l8.Array.of(a.l8.Reference.of((()=>m))),shows:a.l8.Array.of(a.l8.Reference.of((()=>b))),show_genres:a.l8.Array.of(a.l8.Reference.of((()=>v))),seasons:a.l8.Array.of(a.l8.Reference.of((()=>S))),episodes:a.l8.Array.of(a.l8.Reference.of((()=>_))),subtitles:a.l8.Array.of(a.l8.Reference.of((()=>w))),subtitle_contents:a.l8.Array.of(a.l8.Reference.of((()=>O)))}),files:a.l8.Array.of(a.l8.Reference.of((()=>E)))}),I=(a.l8.Record.of(a.l8.Array.of(a.l8.String)),a.l8.Object.of({audiolist_id:a.l8.String,title:a.l8.String,description:a.l8.String,user_id:a.l8.String})),N=a.l8.Object.of({audiolist_id:a.l8.String,track_id:a.l8.String,number:a.l8.Number}),k=a.l8.Object.of({audiolists:a.l8.Array.of(a.l8.Reference.of((()=>I))),audiolist_items:a.l8.Array.of(a.l8.Reference.of((()=>N)))}),R=a.l8.Object.of({user_id:a.l8.String,username:a.l8.String,password:a.l8.String}),j=a.l8.Object.of({username:a.l8.String,selector:a.l8.String,validator_hash:a.l8.String,expires_ms:a.l8.Number}),x=a.l8.Object.of({users:a.l8.Array.of(a.l8.Reference.of((()=>R))),tokens:a.l8.Array.of(a.l8.Reference.of((()=>j)))}),U=a.l8.Object.of({username:a.l8.String,file_id:a.l8.String,timestamp_ms:a.l8.Number}),A=a.l8.Object.of({streams:a.l8.Array.of(a.l8.Reference.of((()=>U)))}),C=a.l8.Object.of({channel_id:a.l8.String}),L=a.l8.Object.of({program_id:a.l8.String,channel_id:a.l8.String,file_id:a.l8.String,start_time_ms:a.l8.Number}),D=a.l8.Object.of({channels:a.l8.Array.of(a.l8.Reference.of((()=>C))),programs:a.l8.Array.of(a.l8.Reference.of((()=>L)))});function P(...e){return e.map((e=>String(e))).join("")}function B(e){let t=e;return t=t.toLowerCase(),t=t.normalize("NFC"),Array.from(t.match(/(\p{L}+|\p{N}+)/gu)||[])}function H(e){let t=Math.floor(e/1e3);e-=1e3*t;let r=Math.floor(t/60);t-=60*r;let n=Math.floor(r/60);r-=60*n;let i=P("00",n).slice(-2),s=P("00",r).slice(-2),o=P("00",t).slice(-2),a=P("000",e).slice(-3);return P(i,":",s,":",o,".",a)}const M=(...e)=>(t,r)=>{for(let n of e){let e=n(t,r);if(0!==e)return e}return 0},G=e=>(t,r)=>{let n=e(t),i=e(r);return null==n?null==i?0:1:null==i?null==n?0:-1:n.localeCompare(i)},F=e=>(t,r)=>{let n=e(t),i=e(r);return null==n?null==i?0:-1:null==i?null==n?0:1:i-n},q=e=>(t,r)=>{let n=e(t),i=e(r);return null==n?null==i?0:1:null==i?null==n?0:-1:n-i};function $(e){return null==e}function z(e){return null!=e}if(e.mkdirSync("./private/db/",{recursive:!0}),!e.existsSync("./private/db/streams.json")){let t={streams:[]};e.writeFileSync("./private/db/streams.json",JSON.stringify(t,null,"\t"))}if(!e.existsSync("./private/db/lists.json")){let t={audiolists:[],audiolist_items:[]};e.writeFileSync("./private/db/lists.json",JSON.stringify(t,null,"\t"))}if(!e.existsSync("./private/db/users.json")){let t={users:[{user_id:"",username:"test",password:function(e){let t=o.randomBytes(16),r=o.scryptSync("test",t,32,{N:16384,r:8,p:1,maxmem:33554432}),n=Buffer.alloc(4);return n[0]=0,n[1]=14,n[2]=8,n[3]=1,`$s0$${n.toString("hex")}$${t.toString("base64")}$${r.toString("base64")}`}()}],tokens:[]};e.writeFileSync("./private/db/users.json",JSON.stringify(t,null,"\t"))}if(e.existsSync("./private/db/media.json")||(process.stderr.write("Media database not found! Please run the indexer.\n"),process.exit(1)),!e.existsSync("./private/db/channels.json")){let t={channels:[],programs:[]};e.writeFileSync("./private/db/channels.json",JSON.stringify(t,null,"\t"))}let J=A.as(JSON.parse(e.readFileSync("./private/db/streams.json","utf8"))),W=k.as(JSON.parse(e.readFileSync("./private/db/lists.json","utf8"))),V=x.as(JSON.parse(e.readFileSync("./private/db/users.json","utf8"))),X=T.as(JSON.parse(e.readFileSync("./private/db/media.json","utf8"))),Y=D.as(JSON.parse(e.readFileSync("./private/db/channels.json","utf8"))),K={};for(let e=0;e<V.users.length;e++){let t=V.users[e];K[t.username]=t}let Q={};for(let e=0;e<V.tokens.length;e++){let t=V.tokens[e];Q[t.selector]=t}let Z={};for(let e=0;e<X.audio.tracks.length;e++){let t=X.audio.tracks[e];Z[t.track_id]=t}let ee={};for(let e=0;e<X.audio.discs.length;e++){let t=X.audio.discs[e];ee[t.disc_id]=t}let te={};for(let e=0;e<X.audio.albums.length;e++){let t=X.audio.albums[e];te[t.album_id]=t}let re={};for(let e=0;e<X.audio.artists.length;e++){let t=X.audio.artists[e];re[t.artist_id]=t}let ne={};for(let e=0;e<X.video.shows.length;e++){let t=X.video.shows[e];ne[t.show_id]=t}let ie={};for(let e=0;e<X.video.episodes.length;e++){let t=X.video.episodes[e];ie[t.episode_id]=t}let se={};for(let e=0;e<X.video.seasons.length;e++){let t=X.video.seasons[e];se[t.season_id]=t}let oe={};for(let e=0;e<X.video.movie_parts.length;e++){let t=X.video.movie_parts[e];oe[t.movie_part_id]=t}let ae={};for(let e=0;e<X.video.movies.length;e++){let t=X.video.movies[e];ae[t.movie_id]=t}let le={};for(let e=0;e<X.video.genres.length;e++){let t=X.video.genres[e];le[t.video_genre_id]=t}let de={};for(let e=0;e<X.video.subtitles.length;e++){let t=X.video.subtitles[e];de[t.subtitle_id]=t}let ce={};for(let e of X.video.subtitle_contents)for(let t of e.cues){let r=pe(e.subtitle_id,t),n=e.subtitle_id,i=t[0],s=t[1],o=t[2].split("\n");ce[r]={cue_id:r,subtitle_id:n,start_ms:i,duration_ms:s,lines:o}}let ue={};for(let e=0;e<X.files.length;e++){let t=X.files[e];ue[t.file_id]=t}let fe={};for(let e=0;e<W.audiolists.length;e++){let t=W.audiolists[e];fe[t.audiolist_id]=t}function pe(e,t){let r=o.createHash("md5");return r.update(e),r.update(""+t[0]),r.digest("hex")}const he=new Map;for(let e of X.video.subtitle_contents)for(let t of e.cues){let r=pe(e.subtitle_id,t);for(let e of t[2].split("\n")){let t=B(e).filter((e=>e.length>=4));for(let e of t){let t=he.get(e);void 0===t&&(t=new Set,he.set(e,t)),t.add(r)}}}setInterval((()=>{V.tokens=V.tokens.filter((e=>e.expires_ms>Date.now())),Q={};for(let e of V.tokens)Q[e.selector]=e;e.writeFileSync("./private/db/users.json",JSON.stringify(V,null,"\t"))}),36e5);class ge{constructor(){this.map=new Map}insert(e,t){this.map.set(e,t)}lookup(e){let t=this.map.get(e);if(null==t)throw`Expected "${e}" to match a record!`;return t}remove(e){this.map.delete(e)}static from(e,t){let r=new ge;for(let n of t)r.insert(n[e],n);return r}}class me{constructor(){this.map=new Map}insert(e,t){let r=this.map.get(e);r||(r=new Set,this.map.set(e,r)),r.add(t)}lookup(e){let t=this.map.get(e);return t?Array.from(t):new Array}remove(e,t){let r=this.map.get(e);r&&(r.delete(t),0===r.size&&this.map.delete(e))}static from(e,t){let r=new me;for(let n of t)r.insert(n[e],n);return r}}function ye(e,t){let r=e[t];if(null==r)throw`Expected "${t}" to match a record!`;return r}let be=ge.from("file_id",X.video.episodes),ve=ge.from("file_id",X.video.movie_parts),Se=me.from("movie_id",X.video.movie_parts),_e=me.from("show_id",X.video.show_genres),we=me.from("movie_id",X.video.movie_genres);const Oe=me.from("video_genre_id",X.video.movie_genres);let Ee=me.from("video_genre_id",X.video.show_genres),Te=ge.from("video_genre_id",X.video.genres),Ie=me.from("show_id",X.video.seasons),Ne=me.from("season_id",X.video.episodes),ke=me.from("file_id",J.streams),Re=ge.from("channel_id",Y.channels),je=me.from("channel_id",Y.programs);function xe(e){return Oe.lookup(e).map((e=>function(e){let t=ye(ae,e);return Object.assign({},t)}(e.movie_id)))}function Ue(t){return Y.programs.push(t),e.writeFileSync("./private/db/channels.json",JSON.stringify(Y,null,"\t")),je.insert(t.channel_id,t),t}function Ae(e){try{return be.lookup(e)}catch(e){}try{return ve.lookup(e)}catch(e){}throw`Expected "${e}" to match a metadata record!`}let Ce=me.from("album_id",X.audio.album_artists);const Le=me.from("artist_id",X.audio.album_artists);let De=me.from("track_id",X.audio.track_artists),Pe=me.from("artist_id",X.audio.track_artists),Be=me.from("video_file_id",X.video.subtitles);const He=me.from("album_id",X.audio.discs),Me=me.from("disc_id",X.audio.tracks),Ge=ge.from("album_id",X.audio.albums),Fe=me.from("audiolist_id",W.audiolist_items),qe=ge.from("track_id",X.audio.tracks),$e=ge.from("disc_id",X.audio.discs),ze=ge.from("user_id",V.users),Je=ge.from("audiolist_id",W.audiolists),We=ge.from("show_id",X.video.shows),Ve=ge.from("artist_id",X.audio.artists),Xe=ge.from("episode_id",X.video.episodes),Ye=ge.from("season_id",X.video.seasons);function Ke(e){return Be.lookup(e).map((e=>Object.assign({},e)))}function Qe(e){let t=ye(ne,e);return Object.assign({},t)}class Ze{constructor(){this.map=new Map}insert(e,t){let r=this.map.get(e);r||(r=new Set,this.map.set(e,r)),r.add(t)}lookup(e){let t=this.map.get(e);return t?new Set(t):new Set}remove(e,t){let r=this.map.get(e);r&&(r.delete(t),0===r.size&&this.map.delete(e))}search(e,t){let r=B(e).map((e=>this.map.get(e)||new Set));r=r.filter((e=>e.size>0)),r=r.sort(((e,t)=>e.size-t.size));let n=new Array;if(r.length>0)e:for(let e of r[0]){for(let t=1;t<r.length;t++)if(!r[t].has(e))continue e;if(n.push(e),null!=t&&n.length>=t)break e}return n}static from(e,t,r){let n=new Ze;for(let i of r){let r=B(i[t]);for(let t of r)n.insert(t,i[e])}return n}}let et=Ze.from("artist_id","title",X.audio.artists),tt=Ze.from("album_id","title",X.audio.albums),rt=Ze.from("track_id","title",X.audio.tracks),nt=Ze.from("show_id","title",X.video.shows),it=Ze.from("movie_id","title",X.video.movies),st=Ze.from("episode_id","title",X.video.episodes);function ot(e,t){var r;return(null===(r=function(e,t){return ke.lookup(t).filter((t=>t.username===e)).sort(q((e=>e.timestamp_ms)))}(e,t).pop())||void 0===r?void 0:r.timestamp_ms)||null}function at(e,t){let r=function(e,t){let r=Ge.lookup(e);return{album_id:r.album_id,title:r.title,year:r.year,artists:Ce.lookup(r.album_id).map((e=>Ve.lookup(e.artist_id))),artwork:$(r.cover_file_id)?void 0:{file_id:r.cover_file_id,mime:"image/jpeg",height:1080,width:1080}}}(e);return Object.assign(Object.assign({},r),{discs:He.lookup(e).map((e=>function(e,t,r){let n=dt(e,t,r),i=Me.lookup(e).map((e=>({track_id:e.track_id,title:e.title,disc:n,artists:De.lookup(e.track_id).map((e=>Ve.lookup(e.artist_id))),file:{file_id:e.file_id,mime:"audio/mp4",duration_ms:e.duration},number:e.number,last_stream_date:void 0})));return Object.assign(Object.assign({},n),{tracks:i})}(e.disc_id,t,r)))})}function lt(e,t){let r=function(e,t){let r=Ve.lookup(e);return{artist_id:r.artist_id,title:r.title}}(e);return Object.assign(Object.assign({},r),{albums:Le.lookup(e).map((e=>at(e.album_id,t)))})}function dt(e,t,r){let n=$e.lookup(e);return{disc_id:n.disc_id,album:z(r)?r:at(n.album_id,t),number:n.number}}function ct(e,t,r){let n=function(e,t,r){var n,i;let s=Xe.lookup(e);return{episode_id:s.episode_id,title:s.title,summary:null!==(n=s.summary)&&void 0!==n?n:"",number:s.number,file:{file_id:s.file_id,mime:"video/mp4",duration_ms:s.duration},subtitles:Ke(s.file_id).map((e=>{var t;return{file_id:e.file_id,mime:"text/vtt",language:null!==(t=e.language)&&void 0!==t?t:void 0}})),season:z(r)?r:ht(s.season_id,t),year:null!==(i=s.year)&&void 0!==i?i:void 0,last_stream_date:void 0}}(e,t,r);return Object.assign({},n)}function ut(e,t){let r=function(e,t){let r=Te.lookup(e);return{genre_id:r.video_genre_id,title:r.title}}(e);return Object.assign({},r)}function ft(e,t){let r=function(e,t){var r,n;let i=ye(ae,e),s=(o=e,Se.lookup(o).map((e=>{let t=Be.lookup(e.file_id);return Object.assign(Object.assign({},e),{subtitles:t})})));var o;return{movie_id:i.movie_id,title:i.title,year:i.year,summary:null!==(r=i.summary)&&void 0!==r?r:"",artwork:$(i.poster_file_id)?void 0:{file_id:i.poster_file_id,mime:"image/jpeg",height:720,width:1080},file:{file_id:s[0].file_id,mime:"video/mp4",duration_ms:s[0].duration},subtitles:s[0].subtitles.map((e=>{var t;return{file_id:e.file_id,mime:"text/vtt",language:null!==(t=e.language)&&void 0!==t?t:void 0}})),last_stream_date:z(t)&&null!==(n=ot(t,s[0].file_id))&&void 0!==n?n:void 0}}(e,t),n=we.lookup(e).map((e=>{let t=Te.lookup(e.video_genre_id);return{genre_id:t.video_genre_id,title:t.title}})).sort(G((e=>e.title)));return Object.assign(Object.assign({},r),{genres:n})}function pt(e,t){let r=function(e,t){let r=Je.lookup(e);return{playlist_id:r.audiolist_id,title:r.title,description:r.description,user:bt(r.user_id)}}(e),n=Fe.lookup(r.playlist_id).map((e=>({playlist:r,number:e.number,track:yt(e.track_id,t)})));return Object.assign(Object.assign({},r),{items:n})}function ht(e,t,r){let n=Ye.lookup(e);return{season_id:n.season_id,number:n.number,show:z(r)?r:gt(n.show_id)}}function gt(e,t){let r=We.lookup(e);return{show_id:r.show_id,title:r.title,artwork:void 0}}function mt(e,t){let r=gt(e),n=Ie.lookup(e).map((e=>function(e,t,r){let n=ht(e,0,r),i=Ne.lookup(n.season_id).map((e=>ct(e.episode_id,t,n)));return Object.assign(Object.assign({},n),{episodes:i})}(e.season_id,t,r))),i=(s=e,_e.lookup(s).map((e=>Te.lookup(e.video_genre_id)))).map((e=>({genre_id:e.video_genre_id,title:e.title})));var s;return Object.assign(Object.assign({},r),{seasons:n,genres:i})}function yt(e,t,r){let n=function(e,t,r){let n=qe.lookup(e);return{track_id:n.track_id,title:n.title,disc:z(r)?r:dt(n.disc_id,t),artists:De.lookup(n.track_id).map((e=>Ve.lookup(e.artist_id))),file:{file_id:n.file_id,mime:"audio/mp4",duration_ms:n.duration},number:n.number,last_stream_date:void 0}}(e,t,r);return Object.assign({},n)}function bt(e){let t=ze.lookup(e);return{user_id:t.user_id,username:t.username}}function vt(t,r){let n=K[t];if(!n)throw new Error;if(!function(e,t){let r=/^\$s0\$([0-9a-fA-F]{8})\$([A-Za-z0-9+/]{22}==)\$([A-Za-z0-9+/]{43}=)$/.exec(t);if(null==r)throw"Expected a valid scrypt chunk!";let n=Buffer.from(r[1],"hex"),i=Buffer.from(r[2],"base64"),s=Buffer.from(r[3],"base64"),a=n[0]<<8|n[1]<<0,l=n[2]<<0,d=n[3]<<0,c=o.scryptSync(e,i,32,{N:1<<a,r:l,p:d,maxmem:(256<<a)*l});return o.timingSafeEqual(s,c)}(r,n.password))throw new Error("Fak u dolan.");return function(t){let r=o.randomBytes(16),n=o.randomBytes(16),i=o.createHash("sha256");i.update(n);let s=i.digest("hex");var a;return a={username:t,selector:r.toString("hex"),validator_hash:s,expires_ms:Date.now()+6048e5},V.tokens.push(a),Q[a.selector]=a,e.writeFileSync("./private/db/users.json",JSON.stringify(V,null,"\t")),`${r.toString("hex")}${n.toString("hex")}`}(t)}function St(t){let r=/^([0-9a-f]{32})([0-9a-f]{32})$/.exec(t);if(!r)throw new Error;let n=r[1],i=r[2],s=Q[n];if(!s)throw new Error;let a=o.createHash("sha256");a.update(Buffer.from(i,"hex"));let l=a.digest();if(!o.timingSafeEqual(Buffer.from(s.validator_hash,"hex"),l))throw new Error;let d=Date.now()+6048e5;return function(t){let r=Q[t.selector];r&&(r.expires_ms=t.expires_ms),e.writeFileSync("./private/db/users.json",JSON.stringify(V,null,"\t"))}(Object.assign(Object.assign({},s),{expires_ms:d})),s.username}const _t=require("child_process"),wt=a.l8.Object.of({pkt_pts_time:a.l8.String}),Ot=a.l8.Object.of({frames:a.l8.Array.of(a.l8.Reference.of((()=>wt)))}),Et=a.l8.Object.of({start_time:a.l8.String,duration:a.l8.String}),Tt=a.l8.Object.of({streams:a.l8.Array.of(a.l8.Reference.of((()=>Et)))});var It=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}l((n=n.apply(e,t||[])).next())}))};function Nt(e,t){return It(this,void 0,void 0,(function*(){return new Promise(((r,n)=>{let i=_t.spawn("ffprobe",["-hide_banner","-i",e.join("/"),"-select_streams",""+t,"-skip_frame","nokey","-show_frames","-show_entries","frame=pkt_pts_time","-of","json"]),s=new Array;i.stdout.on("data",(e=>{s.push(e)})),i.on("exit",(()=>{let e=Buffer.concat(s).toString(),t=Ot.as(JSON.parse(e)).frames.map((e=>Math.round(1e3*Number.parseFloat(e.pkt_pts_time))));r(t)}))}))}))}var kt=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}l((n=n.apply(e,t||[])).next())}))};function Rt(e){(e%=2147483647)<=0&&(e+=2147483646);const t=()=>((e=16807*e%2147483647)-1)/2147483646;return t(),t}function jt(e){const t=Rt(e)()<.5?"Movies":"Shows",r=function(e){const t=Rt(e);return X.video.genres.map((e=>({genre:e,weight:t()})))}(e).sort(((e,t)=>t.weight-e.weight));return{channel_id:e,title:r[0].genre.title+" & "+r[1].genre.title+" "+t}}function xt(t){let r;try{n=""+t,r=Re.lookup(n)}catch(e){}var n;r||(r=function(t){return Y.channels.push(t),e.writeFileSync("./private/db/channels.json",JSON.stringify(Y,null,"\t")),Re.insert(t.channel_id,t),t}({channel_id:""+t}));let i=function(e){return je.lookup(e).sort(q((e=>e.start_time_ms)))}(""+t),s=new Date;s.setUTCHours(0),s.setUTCMinutes(0),s.setUTCSeconds(0),s.setUTCMilliseconds(0);let a=s.valueOf(),l=Date.now();if(i.length>0){let e=i[i.length-1],t=Ae(e.file_id);a=e.start_time_ms+t.duration}let d=l+216e5;if(a>=d)return i;for(;a<d;){let e=Math.floor(Math.random()*X.video.episodes.length),r=X.video.episodes[e],n=Ue({program_id:o.createHash("md5").update(""+t).update("\0").update(""+a).digest("hex"),channel_id:""+t,file_id:r.file_id,start_time_ms:a});i.push(n),a+=r.duration}return i}let Ut={};function At(e){return kt(this,void 0,void 0,(function*(){let t=Ut[e];if(!t){let r=ue[e];t=yield function(e,t,r){return It(this,void 0,void 0,(function*(){let n=yield function(e){return It(this,void 0,void 0,(function*(){return new Promise(((t,r)=>{let n=_t.spawn("ffprobe",["-hide_banner","-i",e.join("/"),"-show_streams","-show_entries","stream=start_time,duration","-of","json"]),i=new Array;n.stdout.on("data",(e=>{i.push(e)})),n.on("exit",(()=>{let e=Buffer.concat(i).toString(),r=Tt.as(JSON.parse(e)).streams.map((e=>({offset_ms:Math.round(1e3*Number.parseFloat(e.start_time)),duration_ms:Math.round(1e3*Number.parseFloat(e.duration))})));t(r)}))}))}))}(e),i=yield Nt(e,t),s=n[t];return function(e){let t=new Array;for(let r=0;r+1<e.length;r++)t.push({offset_ms:e[r],duration_ms:e[r+1]-e[r]});return t}([...function(e,t){let r=-1/0,n=new Array;for(let i=1;i<e.length;i++)e[i]-r>t&&(r=e[i-1],n.push(r));return n}([...i,s.duration_ms],r),s.duration_ms])}))}(r.path,0,1e4),Ut[e]=t}return t}))}function Ct(e,t){try{return function(e,t){let r=Number.parseInt(function(e,t){let r=function(e,t){var r;let n=null!==(r=e.query[t])&&void 0!==r?r:[];return Array.isArray(n)?n:[n]}(e,t).pop();if($(r))throw`Expected parameter ${t}!`;return r}(e,t),10);if(!Number.isInteger(r))throw`Expected integer ${t}!`;return r}(e,t)}catch(e){}}function Lt(e){return St(s.parse(e.url||"/",!0).query.token)}let Dt=(new class{constructor(){this.routes=new Array}registerRoute(e){return this.routes.push(e),this}route(e,t){for(let r of this.routes)if(r.handlesRequest(e))return r.handleRequest(e,t);t.writeHead(400),t.end("{}")}}).registerRoute(new class{constructor(){}handleRequest(e,t){if(void 0===e.url)throw new Error;let r=/^[/]api[/]auth[/][?]token[=]([0-9a-f]{64})/.exec(e.url);if(null===r)throw new Error;let n=r[1],i={};try{return St(n),t.writeHead(200),t.end(JSON.stringify(i))}catch(e){}return t.writeHead(401),t.end(JSON.stringify(i))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^[/]api[/]auth[/][?]token[=]([0-9a-f]{64})/.test(e.url)}}).registerRoute(new class{constructor(){}handleRequest(e,t){if(void 0===e.url)throw new Error;let r="";e.on("data",(e=>{r+=e})).on("end",(()=>{try{let e=JSON.parse(r);if(null==e||e.constructor!==Object)throw new Error;if(null==e.username||e.username.constructor!==String)throw new Error;if(null==e.password||e.password.constructor!==String)throw new Error;let n=e,i={token:vt(n.username,n.password)};t.writeHead(200),t.end(JSON.stringify(i))}catch(e){t.writeHead(400),t.end(JSON.stringify({error:e.message}))}}))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^[/]api[/]auth[/]/.test(e.url)}}).registerRoute(new class{handleRequest(e,t){var r,n;let i=Lt(e),s=ft(/^[/]api[/]video[/]movies[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],i),o=new Map;for(let e of s.genres){let t=Oe.lookup(e.genre_id);for(let e of t){let t=null!==(n=o.get(e.movie_id))&&void 0!==n?n:0;o.set(e.movie_id,t+2)}}for(let e of o){let t=(a=e[0],we.lookup(a).map((e=>Te.lookup(e.video_genre_id))));o.set(e[0],e[1]-t.length)}var a;o.delete(s.movie_id);let l={movie:s,suggestions:Array.from(o.entries()).sort(M(F((e=>e[1])))).slice(0,6).map((e=>e[0])).map((e=>ft(e,i)))};t.writeHead(200),t.end(JSON.stringify(l))}handlesRequest(e){var t;return/^[/]api[/]video[/]movies[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,i,o;let a=Lt(e),l=(/^[/]api[/]video[/]movies[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),s.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0)),d=null!==(i=Ct(l,"offset"))&&void 0!==i?i:0,c=null!==(o=Ct(l,"length"))&&void 0!==o?o:24,u={movies:X.video.movies.slice().sort(G((e=>e.title))).slice(d,d+c).map((e=>ft(e.movie_id,a)))};t.writeHead(200),t.end(JSON.stringify(u))}handlesRequest(e){var t;return/^[/]api[/]video[/]movies[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let n=Lt(e),i=/^[/]api[/]audio[/]artists[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],s={artist:lt(i,n),appearances:function(e){let t=Pe.lookup(e).map((e=>ye(Z,e.track_id))).map((e=>e.disc_id));t=Array.from(new Set(t));let r=t.map((e=>ye(ee,e))).map((e=>e.album_id));r=Array.from(new Set(r));let n=new Array;for(let t of r)null==Ce.lookup(t).find((t=>t.artist_id===e))&&n.push(t);return n}(i).map((e=>at(e,n)))};t.writeHead(200),t.end(JSON.stringify(s))}handlesRequest(e){var t;return/^[/]api[/]audio[/]artists[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,i,o;let a=Lt(e),l=(/^[/]api[/]audio[/]artists[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),s.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0)),d=null!==(i=Ct(l,"offset"))&&void 0!==i?i:0,c=null!==(o=Ct(l,"length"))&&void 0!==o?o:24,u={artists:X.audio.artists.slice().sort(G((e=>e.title))).slice(d,d+c).map((e=>lt(e.artist_id,a)))};t.writeHead(200),t.end(JSON.stringify(u))}handlesRequest(e){var t;return/^[/]api[/]audio[/]artists[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let n=Lt(e),i={album:at(/^[/]api[/]audio[/]albums[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],n)};t.writeHead(200),t.end(JSON.stringify(i))}handlesRequest(e){var t;return/^[/]api[/]audio[/]albums[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,n,i,o;let a=Lt(e),l=(/^[/]api[/]audio[/]albums[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),s.parse(null!==(n=e.url)&&void 0!==n?n:"/",!0)),d=null!==(i=Ct(l,"offset"))&&void 0!==i?i:0,c=null!==(o=Ct(l,"length"))&&void 0!==o?o:24,u={albums:X.audio.albums.slice().sort(G((e=>e.title))).slice(d,d+c).map((e=>at(e.album_id,a)))};t.writeHead(200),t.end(JSON.stringify(u))}handlesRequest(e){var t;return/^[/]api[/]audio[/]albums[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let n=Lt(e),i={episode:ct(/^[/]api[/]video[/]episodes[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],n)};t.writeHead(200),t.end(JSON.stringify(i))}handlesRequest(e){var t;return/^[/]api[/]video[/]episodes[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let n=Lt(e),i={show:mt(/^[/]api[/]video[/]shows[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],n)};t.writeHead(200),t.end(JSON.stringify(i))}handlesRequest(e){var t;return/^[/]api[/]video[/]shows[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let n=Lt(e),i=(/^[/]api[/]video[/]shows[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),{shows:X.video.shows.map((e=>mt(e.show_id,n)))});t.writeHead(200),t.end(JSON.stringify(i))}handlesRequest(e){var t;return/^[/]api[/]video[/]shows[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let n=Lt(e),i={playlist:pt(/^[/]api[/]audio[/]playlists[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],n)};t.writeHead(200),t.end(JSON.stringify(i))}handlesRequest(e){var t;return/^[/]api[/]audio[/]playlists[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let n=Lt(e),i=(/^[/]api[/]audio[/]playlists[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),{playlists:W.audiolists.map((e=>pt(e.audiolist_id,n)))});t.writeHead(200),t.end(JSON.stringify(i))}handlesRequest(e){var t;return/^[/]api[/]audio[/]playlists[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{constructor(){}handleRequest(e,t){if(void 0===e.url)throw new Error;let r="";e.on("data",(e=>{r+=e})).on("end",(()=>{try{let e=JSON.parse(r);if(null==e||e.constructor!==Object)throw new Error;let n=e.query;if(null==n||n.constructor!==String)throw new Error;let i={cues:function(e){let t=B(e).map((e=>{let t=he.get(e);return void 0!==t?t:new Set})).filter((e=>e.size>0)),r=new Array;if(t.length>0)e:for(let e of t[0]){for(let r=1;r<t.length;r++)if(!t[r].has(e))continue e;if(!(r.length<10))break e;r.push(e)}return r}(n).map((e=>ce[e])).map((e=>{let t=de[e.subtitle_id],r=Ae(t.video_file_id);if(y.is(r)){let n=r,i=ae[n.movie_id];return Object.assign(Object.assign({},e),{subtitle:Object.assign(Object.assign({},t),{episode:void 0,movie_part:Object.assign(Object.assign({},n),{movie:i})})})}if(_.is(r)){let n=r,i=se[n.season_id],s=ne[i.show_id];return Object.assign(Object.assign({},e),{subtitle:Object.assign(Object.assign({},t),{episode:Object.assign(Object.assign({},n),{season:Object.assign(Object.assign({},i),{show:s})}),movie_part:void 0})})}throw""}))};t.writeHead(200),t.end(JSON.stringify(i))}catch(e){t.writeHead(400),t.end(JSON.stringify({error:e.message}))}}))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^[/]api[/]cues[/]/.test(e.url)}}).registerRoute(new class{handleRequest(e,t){let r=/^[/]api[/]video[/]channels[/]([0-9]+)[/]/.exec(e.url||"/");if(null==r)throw"";Lt(e);let n={segments:(i=Number.parseInt(r[1]),xt(i).map((e=>{let t=Ae(e.file_id);if(_.is(t)){let e=function(e){let t=ye(ie,e),r=function(e){let t=ye(se,e),r=Qe(t.show_id);return Object.assign(Object.assign({},t),{show:r})}(t.season_id);return Object.assign(Object.assign({},t),{season:r})}(t.episode_id),r=Ke(e.file_id);return{episode:Object.assign(Object.assign({},e),{subtitles:r})}}throw"Unreachable!"})))};var i;t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){return"POST"===e.method&&/^[/]api[/]video[/]channels[/]([0-9]+)[/]/.test(e.url||"/")}}).registerRoute(new class{handleRequest(e,t){let r=new Array;for(let e=0;e<100;e++)r.push(jt(e));let n={channels:r};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){return"POST"===e.method&&/^[/]api[/]video[/]channels[/]/.test(e.url||"/")}}).registerRoute(new class{handleRequest(e,t){var r;let n=Lt(e),i=/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1];var s;let o={genre:ut(i),shows:(s=i,Ee.lookup(s).map((e=>Qe(e.show_id)))).map((e=>mt(e.show_id,n))),movies:xe(i).map((e=>ft(e.movie_id,n)))};t.writeHead(200),t.end(JSON.stringify(o))}handlesRequest(e){var t;return/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;Lt(e),/^[/]api[/]video[/]genres[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/");let n={genres:X.video.genres.map((e=>ut(e.video_genre_id)))};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]video[/]genres[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let n=Lt(e),i=/^[/]api[/]search[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),s=(a=decodeURIComponent(i[1]),{artistIds:et.search(a,2),albumIds:tt.search(a,2),trackIds:rt.search(a,2),showIds:nt.search(a,2),movieIds:it.search(a,2),episodeIds:st.search(a,2)}),o={entities:[...s.artistIds.map((e=>lt(e,n))),...s.albumIds.map((e=>at(e,n))),...s.trackIds.map((e=>yt(e,n))),...s.showIds.map((e=>mt(e,n))),...s.movieIds.map((e=>ft(e,n))),...s.episodeIds.map((e=>ct(e,n)))]};var a;t.writeHead(200),t.end(JSON.stringify(o))}handlesRequest(e){var t;return/^[/]api[/]search[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){let r={tokens:(n=Lt(e),V.tokens.filter((e=>e.username===n)))};var n;t.writeHead(200),t.end(JSON.stringify(r))}handlesRequest(e){return"POST"===e.method&&/^[/]api[/]tokens[/]/.test(e.url||"/")}});function Pt(t){let r=o.randomBytes(16).toString("hex"),n=[".","private","jobs",r];return e.mkdirSync(n.join("/"),{recursive:!0}),t(n,r)}function Bt(t,r){e.mkdirSync(r.slice(0,-1).join("/"),{recursive:!0}),e.renameSync(t.join("/"),r.join("/"))}function Ht(t){let r=e.statSync(t);r.isDirectory()?(e.readdirSync(t).map((e=>t+"/"+e)).forEach(Ht),e.rmdirSync(t)):r.isFile()&&e.unlinkSync(t)}class Mt{constructor(e){this.state=e,this.observers=new Array}addObserver(e){let t=new Mt(e(this.state));return this.observers.push((r=>{t.updateState(e(r))})),t.addObserver.bind(t)}getState(){return this.state}updateState(e){if(e!==this.state){this.state=e;for(let e of this.observers)e(this.state)}}}class Gt{constructor(e){this.state=e,this.observers=new Array}addObserver(e){var t;this.observers.push(e),null===(t=e.onupdate)||void 0===t||t.call(e,this.state)}compute(e){let t=new Mt(e(this.state));return this.observers.push({onupdate(r){t.updateState(e(r))}}),t.addObserver.bind(t)}getState(){return this.state}append(e){var t,r;this.state.push(e);for(let n of this.observers)null===(t=n.onappend)||void 0===t||t.call(n,e),null===(r=n.onupdate)||void 0===r||r.call(n,this.state)}splice(e){var t,r;if(e<0||e>=this.state.length)throw`Expected an index of at most ${this.state.length}, got ${e}!`;let n=this.state[e];this.state.splice(e,1);for(let i of this.observers)null===(t=i.onsplice)||void 0===t||t.call(i,n,e),null===(r=i.onupdate)||void 0===r||r.call(i,this.state)}update(e){for(let e=this.state.length-1;e>=0;e--)this.splice(e);for(let t of e)this.append(t)}}const Ft=a.l8.Object.of({artist_id:a.l8.String,title:a.l8.String}),qt=a.l8.Intersection.of(a.l8.Reference.of((()=>Ft)),a.l8.Object.of({albums:a.l8.Array.of(a.l8.Reference.of((()=>zt)))})),$t=a.l8.Object.of({album_id:a.l8.String,title:a.l8.String,year:a.l8.Number,artists:a.l8.Array.of(a.l8.Reference.of((()=>Ft))),artwork:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>pr)))}),zt=a.l8.Intersection.of(a.l8.Reference.of((()=>$t)),a.l8.Object.of({discs:a.l8.Array.of(a.l8.Reference.of((()=>Wt)))})),Jt=a.l8.Object.of({disc_id:a.l8.String,album:a.l8.Reference.of((()=>$t)),number:a.l8.Number}),Wt=a.l8.Intersection.of(a.l8.Reference.of((()=>Jt)),a.l8.Object.of({tracks:a.l8.Array.of(a.l8.Reference.of((()=>Xt)))})),Vt=a.l8.Object.of({track_id:a.l8.String,title:a.l8.String,disc:a.l8.Reference.of((()=>Jt)),artists:a.l8.Array.of(a.l8.Reference.of((()=>Ft))),file:a.l8.Reference.of((()=>fr)),number:a.l8.Number,last_stream_date:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),Xt=a.l8.Intersection.of(a.l8.Reference.of((()=>Vt)),a.l8.Object.of({})),Yt=a.l8.Object.of({user_id:a.l8.String,username:a.l8.String}),Kt=(a.l8.Intersection.of(a.l8.Reference.of((()=>Yt)),a.l8.Object.of({})),a.l8.Object.of({playlist_id:a.l8.String,title:a.l8.String,description:a.l8.String,user:a.l8.Reference.of((()=>Yt))})),Qt=a.l8.Intersection.of(a.l8.Reference.of((()=>Kt)),a.l8.Object.of({items:a.l8.Array.of(a.l8.Reference.of((()=>er)))})),Zt=a.l8.Object.of({number:a.l8.Number,playlist:a.l8.Reference.of((()=>Kt)),track:a.l8.Reference.of((()=>Xt))}),er=a.l8.Intersection.of(a.l8.Reference.of((()=>Zt)),a.l8.Object.of({})),tr=a.l8.Object.of({genre_id:a.l8.String,title:a.l8.String}),rr=a.l8.Intersection.of(a.l8.Reference.of((()=>tr)),a.l8.Object.of({})),nr=a.l8.Object.of({movie_id:a.l8.String,title:a.l8.String,year:a.l8.Number,summary:a.l8.String,artwork:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>pr))),file:a.l8.Reference.of((()=>gr)),subtitles:a.l8.Array.of(a.l8.Reference.of((()=>hr))),last_stream_date:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),ir=a.l8.Intersection.of(a.l8.Reference.of((()=>nr)),a.l8.Object.of({genres:a.l8.Array.of(a.l8.Reference.of((()=>rr)))})),sr=a.l8.Object.of({show_id:a.l8.String,title:a.l8.String,artwork:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>pr)))}),or=a.l8.Intersection.of(a.l8.Reference.of((()=>sr)),a.l8.Object.of({seasons:a.l8.Array.of(a.l8.Reference.of((()=>lr))),genres:a.l8.Array.of(a.l8.Reference.of((()=>rr)))})),ar=a.l8.Object.of({season_id:a.l8.String,number:a.l8.Number,show:a.l8.Reference.of((()=>sr))}),lr=a.l8.Intersection.of(a.l8.Reference.of((()=>ar)),a.l8.Object.of({episodes:a.l8.Array.of(a.l8.Reference.of((()=>cr)))})),dr=a.l8.Object.of({episode_id:a.l8.String,title:a.l8.String,summary:a.l8.String,number:a.l8.Number,file:a.l8.Reference.of((()=>gr)),subtitles:a.l8.Array.of(a.l8.Reference.of((()=>hr))),season:a.l8.Reference.of((()=>ar)),year:a.l8.Union.of(a.l8.Undefined,a.l8.Number),last_stream_date:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),cr=a.l8.Intersection.of(a.l8.Reference.of((()=>dr)),a.l8.Object.of({})),ur=a.l8.Object.of({file_id:a.l8.String,mime:a.l8.String}),fr=a.l8.Intersection.of(a.l8.Reference.of((()=>ur)),a.l8.Object.of({duration_ms:a.l8.Number})),pr=a.l8.Intersection.of(a.l8.Reference.of((()=>ur)),a.l8.Object.of({height:a.l8.Number,width:a.l8.Number})),hr=a.l8.Intersection.of(a.l8.Reference.of((()=>ur)),a.l8.Object.of({language:a.l8.Union.of(a.l8.Undefined,a.l8.String)})),gr=a.l8.Intersection.of(a.l8.Reference.of((()=>ur)),a.l8.Object.of({duration_ms:a.l8.Number})),mr=a.l8.Reference.of((()=>zt)),yr=a.l8.Reference.of((()=>qt)),br=a.l8.Reference.of((()=>Xt)),vr=a.l8.Reference.of((()=>Qt)),Sr=a.l8.Reference.of((()=>ir)),_r=a.l8.Reference.of((()=>or)),wr=a.l8.Reference.of((()=>lr)),Or=a.l8.Reference.of((()=>cr)),Er=a.l8.Union.of(a.l8.Reference.of((()=>mr)),a.l8.Reference.of((()=>yr)),a.l8.Reference.of((()=>br)),a.l8.Reference.of((()=>vr)),a.l8.Reference.of((()=>Sr)),a.l8.Reference.of((()=>_r)),a.l8.Reference.of((()=>wr)),a.l8.Reference.of((()=>Or))),Tr=(a.l8.Union.of(a.l8.Reference.of((()=>br)),a.l8.Reference.of((()=>Sr)),a.l8.Reference.of((()=>Or))),a.l8.Object.of({id:a.l8.String,type:a.l8.String,name:a.l8.String})),Ir=(a.l8.Object.of({context:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>Er))),device:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>Tr))),index:a.l8.Union.of(a.l8.Undefined,a.l8.Number),playback:a.l8.Boolean,progress:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),{SetContext:a.l8.Object.of({context:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>Er)))}),SetDevice:a.l8.Object.of({device:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>Tr)))}),SetDevices:a.l8.Object.of({devices:a.l8.Array.of(a.l8.Reference.of((()=>Tr)))}),SetIndex:a.l8.Object.of({index:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),SetLocalDevice:a.l8.Object.of({device:a.l8.Reference.of((()=>Tr))}),SetPlayback:a.l8.Object.of({playback:a.l8.Boolean}),SetProgress:a.l8.Object.of({progress:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),SetToken:a.l8.Object.of({token:a.l8.Union.of(a.l8.Undefined,a.l8.String)})});var Nr=r(978),kr=r(611);class Rr{constructor(e,t,r){this.nextConnectionAttemptDelayFactor=2+Math.random(),this.nextConnectionAttemptDelay=2e3,this.router=new Nr.routing.NamespacedMessageRouter,this.serializer=new a.m7.MessageSerializer(r),this.url=e,this.factory=t,this.socket=t(e),this.socket.addEventListener("close",this.onClose.bind(this)),this.socket.addEventListener("error",this.onError.bind(this)),this.socket.addEventListener("message",this.onMessage.bind(this)),this.socket.addEventListener("open",this.onOpen.bind(this))}onClose(e){this.router.route("sys","disconnect",{})}onError(e){setTimeout((()=>{this.socket=this.factory(this.url),this.socket.addEventListener("close",this.onClose.bind(this)),this.socket.addEventListener("error",this.onError.bind(this)),this.socket.addEventListener("message",this.onMessage.bind(this)),this.socket.addEventListener("open",this.onOpen.bind(this))}),this.nextConnectionAttemptDelay),this.nextConnectionAttemptDelay=Math.round(this.nextConnectionAttemptDelay*this.nextConnectionAttemptDelayFactor)}onMessage(e){let t=e.data;this.serializer.deserialize(t,((e,t)=>{this.router.route("sys","message",{type:e,data:t}),this.router.route("app",e,t)}))}onOpen(e){this.nextConnectionAttemptDelay=2e3,this.router.route("sys","connect",{})}addEventListener(e,t,r){this.router.addObserver(e,t,r)}close(){this.socket.close()}removeEventListener(e,t,r){this.router.addObserver(e,t,r)}send(e,t){if(this.socket.readyState===kr.ReadyState.OPEN)this.socket.send(this.serializer.serialize(e,t));else{let r=()=>{this.socket.removeEventListener("open",r),this.socket.send(this.serializer.serialize(e,t))};this.socket.addEventListener("open",r)}}}class jr{constructor(e,t=(e=>new WebSocket(e))){this.estimatedProgress=new Mt(void 0),this.estimatedProgressTimestamp=new Mt(void 0),this.token=new Mt(void 0),this.localDevice=new Mt(void 0),this.devices=new Gt(new Array),this.device=new Mt(void 0),this.isDeviceLocal=new Mt(!1),this.isDeviceRemote=new Mt(!1),this.context=new Mt(void 0),this.contextPath=new Mt(void 0),this.flattenedContext=new Mt(void 0),this.lastIndex=new Mt(void 0),this.lastEntry=new Mt(void 0),this.lastLocalEntry=new Mt(void 0),this.currentIndex=new Mt(void 0),this.currentEntry=new Mt(void 0),this.currentLocalEntry=new Mt(void 0),this.nextIndex=new Mt(void 0),this.nextEntry=new Mt(void 0),this.nextLocalEntry=new Mt(void 0),this.playback=new Mt(!1),this.progress=new Mt(void 0),this.localPlayback=new Mt(!1),this.canPlayLast=new Mt(!1),this.canPlayCurrent=new Mt(!1),this.canPlayNext=new Mt(!1),this.isCurrentEntryVideo=new Mt(!1),this.tsc=new Rr(e,t,Ir),this.context.addObserver((e=>{if(z(e))if(mr.is(e)){let t=[],r=e;for(let e of r.discs)t.push(...e.tracks);this.flattenedContext.updateState(t)}else if(yr.is(e)){let t=[],r=e;for(let e of r.albums)for(let r of e.discs)t.push(...r.tracks);this.flattenedContext.updateState(t)}else if(Or.is(e)){let t=[],r=e;t.push(r),this.flattenedContext.updateState(t)}else if(Sr.is(e)){let t=[],r=e;t.push(r),this.flattenedContext.updateState(t)}else if(vr.is(e)){let t=[],r=e;for(let e of r.items)t.push(e.track);this.flattenedContext.updateState(t)}else if(wr.is(e)){let t=[],r=e;t.push(...r.episodes),this.flattenedContext.updateState(t)}else if(_r.is(e)){let t=[],r=e;for(let e of r.seasons)t.push(...e.episodes);this.flattenedContext.updateState(t)}else{if(!br.is(e))throw"Expected code to be unreachable!";{let t=[],r=e;t.push(r),this.flattenedContext.updateState(t)}}}));{let e=()=>{let e=this.context.getState(),t=this.currentIndex.getState();if(z(e)&&z(t)){if(mr.is(e)){let r=0,n=t,i=e.discs;for(let e=0;e<i.length;e++){let t=i[e].tracks.length;if(!(n>=t))break;r+=1,n-=t}return this.contextPath.updateState([e.album_id,e.discs[r].disc_id,e.discs[r].tracks[n].track_id])}if(yr.is(e)){let r=0,n=0,i=t,s=e.albums;e:for(let e=0;e<s.length;e++){let t=s[e].discs;for(let e=0;e<t.length;e++){let r=t[e].tracks.length;if(!(i>=r))break e;n+=1,i-=r}r+=1,n=0}return this.contextPath.updateState([e.artist_id,e.albums[r].album_id,e.albums[r].discs[n].disc_id,e.albums[r].discs[n].tracks[i].track_id])}if(Or.is(e))return this.contextPath.updateState([e.episode_id]);if(Sr.is(e))return this.contextPath.updateState([e.movie_id]);if(vr.is(e)){let r=t;return this.contextPath.updateState([e.playlist_id,e.items[r].track.track_id])}if(_r.is(e)){let r=0,n=t,i=e.seasons;for(let e=0;e<i.length;e++){let t=i[e].episodes.length;if(!(n>=t))break;r+=1,n-=t}return this.contextPath.updateState([e.show_id,e.seasons[r].season_id,e.seasons[r].episodes[n].episode_id])}if(wr.is(e)){let r=t;return this.contextPath.updateState([e.season_id,e.episodes[r].episode_id])}if(br.is(e))return this.contextPath.updateState([e.track_id]);throw"Expected code to be unreachable!"}this.contextPath.updateState(void 0)};this.context.addObserver(e),this.currentIndex.addObserver(e)}this.lastEntry.addObserver((e=>{this.canPlayLast.updateState(z(e))})),this.currentEntry.addObserver((e=>{this.canPlayCurrent.updateState(z(e))})),this.nextEntry.addObserver((e=>{this.canPlayNext.updateState(z(e))})),this.progress.addObserver((e=>{this.estimatedProgress.updateState(e),this.estimatedProgressTimestamp.updateState(Date.now())})),this.playback.addObserver((e=>{let t=this.estimatedProgress.getState(),r=this.estimatedProgressTimestamp.getState(),n=Date.now();e||z(t)&&z(r)&&this.estimatedProgress.updateState(t+(n-r)/1e3),this.estimatedProgressTimestamp.updateState(n)})),this.estimatedProgress.addObserver((e=>{console.log("Estimated progress to "+(null!=e?e:0))}));{let e=()=>{let e=this.playback.getState(),t=this.isDeviceLocal.getState();this.localPlayback.updateState(t&&e)};this.playback.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.lastEntry.getState(),t=this.isDeviceLocal.getState();this.lastLocalEntry.updateState(t?e:void 0)};this.lastEntry.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.currentEntry.getState(),t=this.isDeviceLocal.getState();this.currentLocalEntry.updateState(t?e:void 0)};this.currentEntry.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.nextEntry.getState(),t=this.isDeviceLocal.getState();this.nextLocalEntry.updateState(t?e:void 0)};this.nextEntry.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.localDevice.getState(),t=this.device.getState();return z(e)&&z(t)&&e.id===t.id?this.isDeviceLocal.updateState(!0):this.isDeviceLocal.updateState(!1)};this.localDevice.addObserver(e),this.device.addObserver(e)}{let e=()=>{let e=this.localDevice.getState(),t=this.device.getState();return z(e)&&z(t)&&e.id!==t.id?this.isDeviceRemote.updateState(!0):this.isDeviceRemote.updateState(!1)};this.localDevice.addObserver(e),this.device.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.currentIndex.getState();if(z(e)&&z(t)){let r=t-1;if(r>=0&&r<e.length)return this.lastIndex.updateState(r)}return this.lastIndex.updateState(void 0)};this.flattenedContext.addObserver(e),this.currentIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.currentIndex.getState();if(z(e)&&z(t)){let r=t+1;if(r>=0&&r<e.length)return this.nextIndex.updateState(r)}return this.nextIndex.updateState(void 0)};this.flattenedContext.addObserver(e),this.currentIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.lastIndex.getState();return z(e)&&z(t)?this.lastEntry.updateState(e[t]):this.lastEntry.updateState(void 0)};this.flattenedContext.addObserver(e),this.lastIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.currentIndex.getState();return z(e)&&z(t)&&t>=0&&t+0<e.length?this.currentEntry.updateState(e[t+0]):this.currentEntry.updateState(void 0)};this.flattenedContext.addObserver(e),this.currentIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.nextIndex.getState();return z(e)&&z(t)?this.nextEntry.updateState(e[t]):this.nextEntry.updateState(void 0)};this.flattenedContext.addObserver(e),this.nextIndex.addObserver(e)}this.token.addObserver((e=>{this.tsc.send("SetToken",{token:e})})),this.tsc.addEventListener("app","SetLocalDevice",(e=>{this.localDevice.updateState(e.device)})),this.tsc.addEventListener("app","SetDevices",(e=>{this.devices.update(e.devices)})),this.tsc.addEventListener("app","SetContext",(e=>{this.context.updateState(e.context)})),this.tsc.addEventListener("app","SetDevice",(e=>{this.device.updateState(e.device)})),this.tsc.addEventListener("app","SetIndex",(e=>{this.currentIndex.updateState(e.index)})),this.tsc.addEventListener("app","SetPlayback",(e=>{this.playback.updateState(e.playback)})),this.tsc.addEventListener("app","SetProgress",(e=>{this.progress.updateState(e.progress)})),this.tsc.addEventListener("app","SetToken",(e=>{this.token.updateState(e.token)}))}play(e,t){this.tsc.send("SetContext",{context:e}),this.tsc.send("SetIndex",{index:t}),this.resume()}authenticate(e){this.tsc.send("SetToken",{token:e})}close(){this.tsc.close()}last(){let e=this.lastIndex.getState();z(e)&&(this.currentIndex.updateState(e),this.tsc.send("SetIndex",{index:e}))}next(){let e=this.nextIndex.getState();z(e)&&(this.currentIndex.updateState(e),this.tsc.send("SetIndex",{index:e}))}pause(){this.playback.updateState(!1),this.tsc.send("SetPlayback",{playback:!1})}playAlbum(e,t,r){let n=0;if(z(t)){let i=e.discs;if(t<0||t>=i.length)throw`Expected ${t} to be a number between 0 and ${i.length}!`;if(n+=i.slice(0,t).reduce(((e,t)=>e+t.tracks.length),0),z(r)){let e=i[t].tracks;if(r<0||r>=e.length)throw`Expected ${r} to be a number between 0 and ${e.length}!`;n+=r}}return this.play(e,n)}playArtist(e,t,r,n){let i=0;if(z(t)){let s=e.albums;if(t<0||t>=s.length)throw`Expected ${t} to be a number between 0 and ${s.length}!`;if(i+=s.slice(0,t).reduce(((e,t)=>e+t.discs.reduce(((e,t)=>e+t.tracks.length),0)),0),z(r)){let e=s[t].discs;if(r<0||r>=e.length)throw`Expected ${r} to be a number between 0 and ${e.length}!`;if(i+=e.slice(0,r).reduce(((e,t)=>e+t.tracks.length),0),z(n)){let t=e[r].tracks;if(n<0||n>=t.length)throw`Expected ${n} to be a number between 0 and ${t.length}!`;i+=n}}}return this.play(e,i)}playEpisode(e){this.play(e,0)}playMovie(e){this.play(e,0)}playPlaylist(e,t){let r=0;if(z(t)){let n=e.items;if(t<0||t>=n.length)throw`Expected ${t} to be a number between 0 and ${n.length}!`;r+=t}return this.play(e,r)}playSeason(e,t){let r=0;if(z(t)){let n=e.episodes;if(t<0||t>=n.length)throw`Expected ${t} to be a number between 0 and ${n.length}!`;r+=t}return this.play(e,r)}playShow(e,t,r){let n=0;if(z(t)){let i=e.seasons;if(t<0||t>=i.length)throw`Expected ${t} to be a number between 0 and ${i.length}!`;if(n+=i.slice(0,t).reduce(((e,t)=>e+t.episodes.length),0),z(r)){let e=i[t].episodes;if(r<0||r>=e.length)throw`Expected ${r} to be a number between 0 and ${e.length}!`;n+=r}}return this.play(e,n)}playTrack(e){this.play(e,0)}resume(){this.playback.updateState(!0),this.tsc.send("SetPlayback",{playback:!0})}seek(e){this.tsc.send("SetProgress",{progress:e})}toggle(){this.playback.getState()?this.pause():this.resume()}transfer(e){this.tsc.send("SetDevice",{device:e})}}var xr=r(545);class Ur{constructor(e){this.router=new Nr.routing.NamespacedMessageRouter,this.serializer=new a.m7.MessageSerializer(e),this.socket=new xr.u9,this.socket.addEventListener("connect",(e=>{let t=e.connection_id,r=e.connection_url;this.router.route("sys","connect",{connection_id:t,connection_url:r})})),this.socket.addEventListener("disconnect",(e=>{let t=e.connection_id,r=e.connection_url;this.router.route("sys","disconnect",{connection_id:t,connection_url:r})})),this.socket.addEventListener("message",(e=>{let t=e.connection_id,r=e.connection_url,n=e.buffer.toString();this.serializer.deserialize(n,((e,n)=>{this.router.route("sys","message",{connection_id:t,connection_url:r,type:e,data:n}),this.router.route("app",e,{connection_id:t,connection_url:r,data:n})}))}))}addEventListener(e,t,r){this.router.addObserver(e,t,r)}broadcast(e,t){let r=this.serializer.serialize(e,t);this.socket.broadcast(r)}close(e){this.socket.close(e)}getRequestHandler(){return this.socket.getRequestHandler()}removeEventListener(e,t,r){this.router.addObserver(e,t,r)}send(e,t,r){let n=this.serializer.serialize(e,r);for(let e of Array.isArray(t)?t:[t])try{this.socket.send(e,n)}catch(e){}}}function Ar(e,t){var r;let n=null!==(r=e.query[t])&&void 0!==r?r:[];return Array.isArray(n)?n:[n]}function Cr(e,t){var r,n;let i=s.parse(t,!0);return{id:e,name:null!==(r=Ar(i,"name").pop())&&void 0!==r?r:"",type:null!==(n=Ar(i,"type").pop())&&void 0!==n?n:""}}var Lr,Dr,Pr,Br=r(16);function Hr(e){if(e>Number.MAX_SAFE_INTEGER||e<Number.MIN_SAFE_INTEGER)throw`Expected a safe integer but got ${e}!`;return Number(e)}function Mr(e,t){let r=e.buffer.length-e.offset;if(t>r)throw`Expected to read at most ${r} bytes but attempted to read ${t} bytes!`;let n=e.buffer.slice(e.offset,e.offset+t);return e.offset+=t,n}function Gr(e){let t=Buffer.alloc(10);for(let r=0;r<10;r++){let n=e.buffer.readUInt8(e.offset);if(e.offset+=1,t[r]=n,0==(128&n)){if(r+1===10&&0!=(126&n))throw"Expected a varint of at most 64 bits!";let e=BigInt(0);for(let n=r;n>=0;n--)e=e<<BigInt(7)|BigInt(127&t[n]);let i=Buffer.alloc(8);return i.writeBigUInt64LE(e,0),i}}throw"Expected a varint of at most 10 bytes!"}function Fr(e){let t=e.readBigUInt64LE(0),r=Buffer.alloc(10);for(let e=0;e<10;e++){let n=t&BigInt(127);if(t>>=BigInt(7),!(t>0))return r.writeUInt8(0|Hr(n),e),r.slice(0,e+1);r.writeUInt8(128|Hr(n),e)}throw"Expected to serialize at most 10 bytes!"}function qr(e){let t=BigInt(e.field_number)<<BigInt(3)|BigInt(e.wire_type)&BigInt(7),r=Buffer.alloc(8);return r.writeBigUInt64LE(t,0),Fr(r)}function $r(e){let t=function(e){let t=Gr(e).readBigUInt64LE(0);return{field_number:Hr(t>>BigInt(3)),wire_type:Hr(t&BigInt(7))}}(e);if(t.wire_type===Lr.VARINT)return{key:t,data:Gr(e)};if(t.wire_type===Lr.FIXED_64_BIT)return{key:t,data:Mr(e,8)};if(t.wire_type===Lr.LENGTH_DELIMITED)return{key:t,data:Mr(e,Hr(Gr(e).readBigUInt64LE(0)))};if(t.wire_type===Lr.START_GROUP)return{key:t,data:Buffer.alloc(0)};if(t.wire_type===Lr.END_GROUP)return{key:t,data:Buffer.alloc(0)};if(t.wire_type===Lr.FIXED_32_BIT)return{key:t,data:Mr(e,4)};throw"Expected a recognized wire type!"}function zr(e){if(e.key.wire_type===Lr.VARINT)return Buffer.concat([qr(e.key),Fr(e.data)]);if(e.key.wire_type===Lr.FIXED_64_BIT){if(8!==e.data.length)throw"Expected to serialize exactly 8 bytes!";return Buffer.concat([qr(e.key),e.data])}if(e.key.wire_type===Lr.LENGTH_DELIMITED){let t=Buffer.alloc(8);return t.writeBigUInt64LE(BigInt(e.data.length)),Buffer.concat([qr(e.key),Fr(t),e.data])}if(e.key.wire_type===Lr.START_GROUP){if(0!==e.data.length)throw"Expected to serialize exactly 0 bytes!";return Buffer.concat([qr(e.key),e.data])}if(e.key.wire_type===Lr.END_GROUP){if(0!==e.data.length)throw"Expected to serialize exactly 0 bytes!";return Buffer.concat([qr(e.key),e.data])}if(e.key.wire_type===Lr.FIXED_32_BIT){if(4!==e.data.length)throw"Expected to serialize exactly 4 bytes!";return Buffer.concat([qr(e.key),e.data])}throw"Expected a recognized wire type!"}function Jr(e,t){let r=t.filter((t=>t.key.field_number===e));if(0===r.length)throw"Expected required field to be present!";return Hr(r[r.length-1].data.readBigUInt64LE(0))}function Wr(e,t){return zr({key:{field_number:e,wire_type:Lr.VARINT},data:function(e){let t=Buffer.alloc(8);return t.writeBigUInt64LE(BigInt(e)),t}(t)})}function Vr(e,t){let r=t.filter((t=>t.key.field_number===e));if(0===r.length)throw"Expected required field to be present!";return r[r.length-1].data.toString()}function Xr(e,t){return zr({key:{field_number:e,wire_type:Lr.LENGTH_DELIMITED},data:Buffer.from(t)})}function Yr(e,t){return null==t?Buffer.alloc(0):function(e,t){return zr({key:{field_number:e,wire_type:Lr.LENGTH_DELIMITED},data:t})}(e,t)}!function(e){e[e.VARINT=0]="VARINT",e[e.FIXED_64_BIT=1]="FIXED_64_BIT",e[e.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",e[e.START_GROUP=3]="START_GROUP",e[e.END_GROUP=4]="END_GROUP",e[e.FIXED_32_BIT=5]="FIXED_32_BIT"}(Lr||(Lr={})),function(e){e[e.CASTV2_1_0=0]="CASTV2_1_0"}(Dr||(Dr={})),function(e){e[e.STRING=0]="STRING",e[e.BINARY=1]="BINARY"}(Pr||(Pr={}));const Kr=require("dgram");var Qr=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}l((n=n.apply(e,t||[])).next())}))};let Zr={},en={},tn=(e,t)=>{let r=en[e];if(void 0!==r)for(let e of r)e(t);let n=Zr[e];void 0!==n&&tn(n,t)},rn=(e,t,r)=>{Zr[t]=e,"A"===r&&tn(e,t)},nn=(e,t)=>Qr(void 0,void 0,void 0,(function*(){let r=new Array;for(;;){let n=e.readUInt8(t);if(0===n){t+=1;break}if(n<64){t+=1;let i=e.slice(t,t+n);t+=n,r.push(i.toString("binary"));continue}if(n<192)throw new Error;let i=yield nn(e,16383&e.readUInt16BE(t));r.push(i.value),t+=2;break}return{value:r.join("."),offset:t}})),sn=(e,t)=>Qr(void 0,void 0,void 0,(function*(){let r=yield nn(e,t);return t=r.offset,e.readUInt16BE(t),t+=2,e.readUInt16BE(t),t+=2,{value:r.value,offset:t}})),on=(e,t)=>Qr(void 0,void 0,void 0,(function*(){let r=yield nn(e,t);t=r.offset;let n=e.readUInt16BE(t);t+=2,e.readUInt16BE(t),t+=2,e.readUInt32BE(t),t+=4;let i=e.readUInt16BE(t);t+=2;let s="";if(1===n&&(s=`${e[t+0]}.${e[t+1]}.${e[t+2]}.${e[t+3]}`,t+=4,rn(r.value,s,"A")),12===n){let n=yield nn(e,t);t=n.offset,s=n.value,rn(r.value,s,"PTR")}if(16===n){let r=e.slice(t,t+i);t+=i,s=r.toString("binary")}if(33===n){e.readUInt16BE(t),t+=2,e.readUInt16BE(t),t+=2,e.readUInt16BE(t),t+=2;let n=yield nn(e,t);t=n.offset,s=n.value,rn(r.value,s,"SRV")}return{name:r.value,data:s,offset:t}}));const an="224.0.0.251";let ln=Kr.createSocket({type:"udp4",reuseAddr:!0});ln.on("listening",(()=>{ln.setMulticastLoopback(!1),ln.addMembership(an,"0.0.0.0")})),ln.on("message",((e,t)=>Qr(void 0,void 0,void 0,(function*(){try{yield(e=>Qr(void 0,void 0,void 0,(function*(){let t=0,r=e.slice(t,t+12);t+=12,r.readUInt16BE(0),r.readUInt16BE(2);let n=r.readUInt16BE(4),i=r.readUInt16BE(6),s=r.readUInt16BE(8),o=r.readUInt16BE(10),a=new Array;for(let r=0;r<n;r++){let r=yield sn(e,t);a.push(r),t=r.offset}let l=new Array;for(let r=0;r<i;r++){let r=yield on(e,t);l.push(r),t=r.offset}let d=new Array;for(let r=0;r<s;r++){let r=yield on(e,t);d.push(r),t=r.offset}let c=new Array;for(let r=0;r<o;r++){let r=yield on(e,t);c.push(r),t=r.offset}})))(e)}catch(e){}})))),ln.bind(5353);const dn={CONNECT:a.l8.Object.of({type:a.l8.StringLiteral.of("CONNECT")}),CLOSE:a.l8.Object.of({type:a.l8.StringLiteral.of("CLOSE")})},cn={PING:a.l8.Object.of({type:a.l8.StringLiteral.of("PING")}),PONG:a.l8.Object.of({type:a.l8.StringLiteral.of("PONG")})},un=a.l8.Object.of({url:a.l8.String,height:a.l8.Union.of(a.l8.Undefined,a.l8.Number),width:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),fn=a.l8.Object.of({level:a.l8.Union.of(a.l8.Undefined,a.l8.Number),muted:a.l8.Union.of(a.l8.Undefined,a.l8.Boolean)}),pn=a.l8.Object.of({contentId:a.l8.String,streamType:a.l8.Union.of(a.l8.StringLiteral.of("NONE"),a.l8.StringLiteral.of("BUFFERED"),a.l8.StringLiteral.of("LIVE")),contentType:a.l8.String,metadata:a.l8.Union.of(a.l8.Undefined,a.l8.Union.of(a.l8.Reference.of((()=>hn)),a.l8.Reference.of((()=>gn)),a.l8.Reference.of((()=>mn)),a.l8.Reference.of((()=>yn)),a.l8.Reference.of((()=>bn)))),duration:a.l8.Union.of(a.l8.Undefined,a.l8.Number),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any)),tracks:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Union.of(a.l8.Object.of({trackId:a.l8.Number,type:a.l8.String}),a.l8.Object.of({trackId:a.l8.Number,type:a.l8.StringLiteral.of("TEXT"),trackType:a.l8.StringLiteral.of("TEXT"),trackContentId:a.l8.String,trackContentType:a.l8.String,subtype:a.l8.StringLiteral.of("SUBTITLES"),language:a.l8.String,name:a.l8.Union.of(a.l8.Undefined,a.l8.String),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}))))}),hn=a.l8.Object.of({metadataType:a.l8.NumberLiteral.of(0),title:a.l8.Union.of(a.l8.Undefined,a.l8.String),subtitle:a.l8.Union.of(a.l8.Undefined,a.l8.String),images:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Reference.of((()=>un)))),releaseDate:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),gn=a.l8.Object.of({metadataType:a.l8.NumberLiteral.of(1),title:a.l8.Union.of(a.l8.Undefined,a.l8.String),subtitle:a.l8.Union.of(a.l8.Undefined,a.l8.String),studio:a.l8.Union.of(a.l8.Undefined,a.l8.String),images:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Reference.of((()=>un)))),releaseDate:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),mn=a.l8.Object.of({metadataType:a.l8.NumberLiteral.of(2),seriesTitle:a.l8.Union.of(a.l8.Undefined,a.l8.String),subtitle:a.l8.Union.of(a.l8.Undefined,a.l8.String),season:a.l8.Union.of(a.l8.Undefined,a.l8.Number),episode:a.l8.Union.of(a.l8.Undefined,a.l8.Number),images:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Reference.of((()=>un)))),originalAirDate:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),yn=a.l8.Object.of({metadataType:a.l8.NumberLiteral.of(3),albumName:a.l8.Union.of(a.l8.Undefined,a.l8.String),title:a.l8.Union.of(a.l8.Undefined,a.l8.String),albumArtist:a.l8.Union.of(a.l8.Undefined,a.l8.String),artist:a.l8.Union.of(a.l8.Undefined,a.l8.String),composer:a.l8.Union.of(a.l8.Undefined,a.l8.String),trackNumber:a.l8.Union.of(a.l8.Undefined,a.l8.Number),discNumber:a.l8.Union.of(a.l8.Undefined,a.l8.Number),images:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Reference.of((()=>un)))),releaseDate:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),bn=a.l8.Object.of({metadataType:a.l8.NumberLiteral.of(4),title:a.l8.Union.of(a.l8.Undefined,a.l8.String),artist:a.l8.Union.of(a.l8.Undefined,a.l8.String),location:a.l8.Union.of(a.l8.Undefined,a.l8.String),latitude:a.l8.Union.of(a.l8.Undefined,a.l8.Number),longitude:a.l8.Union.of(a.l8.Undefined,a.l8.Number),width:a.l8.Union.of(a.l8.Undefined,a.l8.Number),height:a.l8.Union.of(a.l8.Undefined,a.l8.Number),creationDateTime:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),vn=a.l8.Object.of({mediaSessionId:a.l8.Number,media:a.l8.Union.of(a.l8.Undefined,a.l8.Union.of(a.l8.Reference.of((()=>pn)),a.l8.Object.of({}))),playbackRate:a.l8.Number,playerState:a.l8.Union.of(a.l8.StringLiteral.of("IDLE"),a.l8.StringLiteral.of("PLAYING"),a.l8.StringLiteral.of("BUFFERING"),a.l8.StringLiteral.of("PAUSED")),idleReason:a.l8.Union.of(a.l8.Undefined,a.l8.Union.of(a.l8.StringLiteral.of("CANCELLED"),a.l8.StringLiteral.of("INTERRUPTED"),a.l8.StringLiteral.of("FINISHED"),a.l8.StringLiteral.of("ERROR"))),currentTime:a.l8.Number,supportedMediaCommands:a.l8.Number,volume:a.l8.Reference.of((()=>fn)),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),Sn=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("LOAD"),media:a.l8.Reference.of((()=>pn)),autoplay:a.l8.Union.of(a.l8.Undefined,a.l8.Boolean),currentTime:a.l8.Union.of(a.l8.Undefined,a.l8.Number),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any)),activeTrackIds:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Number))}),_n=a.l8.Object.of({mediaSessionId:a.l8.Number,requestId:a.l8.Number,type:a.l8.StringLiteral.of("PAUSE"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),wn=a.l8.Object.of({mediaSessionId:a.l8.Number,requestId:a.l8.Number,type:a.l8.StringLiteral.of("SEEK"),resumeState:a.l8.Union.of(a.l8.Undefined,a.l8.Union.of(a.l8.StringLiteral.of("PLAYBACK_START"),a.l8.StringLiteral.of("PLAYBACK_PAUSE"))),currentTime:a.l8.Union.of(a.l8.Undefined,a.l8.Number),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),On=a.l8.Object.of({mediaSessionId:a.l8.Number,requestId:a.l8.Number,type:a.l8.StringLiteral.of("STOP"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),En=a.l8.Object.of({mediaSessionId:a.l8.Number,requestId:a.l8.Number,type:a.l8.StringLiteral.of("PLAY"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),Tn=a.l8.Object.of({mediaSessionId:a.l8.Union.of(a.l8.Undefined,a.l8.Number),requestId:a.l8.Number,type:a.l8.StringLiteral.of("GET_STATUS"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),In=a.l8.Object.of({mediaSessionId:a.l8.Number,requestId:a.l8.Number,type:a.l8.StringLiteral.of("VOLUME"),volume:a.l8.Reference.of((()=>fn)),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),Nn=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("INVALID_PLAYER_STATE"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),kn=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("LOAD_FAILED"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),Rn=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("LOAD_CANCELLED"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),jn=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("INVALID_REQUEST"),reason:a.l8.Union.of(a.l8.StringLiteral.of("INVALID_COMMAND"),a.l8.StringLiteral.of("DUPLICATE_REQUESTID")),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),xn=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("MEDIA_STATUS"),status:a.l8.Array.of(a.l8.Reference.of((()=>vn))),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),Un={LOAD:Sn,PAUSE:_n,SEEK:wn,STOP:On,PLAY:En,GET_STATUS:Tn,VOLUME:In,INVALID_PLAYER_STATE:Nn,LOAD_FAILED:kn,LOAD_CANCELLED:Rn,INVALID_REQUEST:jn,MEDIA_STATUS:xn},An={LAUNCH:a.l8.Object.of({type:a.l8.StringLiteral.of("LAUNCH"),requestId:a.l8.Number,appId:a.l8.String}),STOP:a.l8.Object.of({type:a.l8.StringLiteral.of("STOP"),requestId:a.l8.Number,sessionId:a.l8.String}),GET_STATUS:a.l8.Object.of({type:a.l8.StringLiteral.of("GET_STATUS"),requestId:a.l8.Number}),GET_APP_AVAILABILITY:a.l8.Object.of({type:a.l8.StringLiteral.of("GET_APP_AVAILABILITY"),requestId:a.l8.Number,appId:a.l8.Array.of(a.l8.String)}),SET_VOLUME:a.l8.Object.of({type:a.l8.StringLiteral.of("SET_VOLUME"),requestId:a.l8.Number,volume:a.l8.Union.of(a.l8.Object.of({level:a.l8.Number}),a.l8.Object.of({muted:a.l8.Boolean}))}),RECEIVER_STATUS:a.l8.Object.of({type:a.l8.StringLiteral.of("RECEIVER_STATUS"),requestId:a.l8.Number,status:a.l8.Object.of({applications:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Object.of({appId:a.l8.String,displayName:a.l8.String,iconUrl:a.l8.String,isIdleScreen:a.l8.Boolean,launchedFromCloud:a.l8.Boolean,namespaces:a.l8.Array.of(a.l8.Object.of({name:a.l8.String})),sessionId:a.l8.String,statusText:a.l8.String,transportId:a.l8.String}))),userEq:a.l8.Object.of({}),volume:a.l8.Object.of({controlType:a.l8.String,level:a.l8.Number,muted:a.l8.Boolean,stepInterval:a.l8.Number})})})},Cn={eng:{title:"English",iso639_1:"en",iso3166_1:"US"},swe:{title:"Swedish",iso639_1:"sv",iso3166_1:"SE"},jpn:{title:"Japanese",iso639_1:"ja",iso3166_1:"JP"}};const Ln="https://ap.joelek.se";function Dn(e){var t;let r=null!==(t=Cn[null!=e?e:"eng"])&&void 0!==t?t:Cn.eng;return{language:[r.iso639_1,r.iso3166_1].join("-"),name:r.title}}const Pn=new Set,Bn=new Set;function Hn(e){!function(e){if(!Bn.has(e)){Bn.add(e);for(let t of Pn)try{e(t)}catch(e){}}}((r=>{return n=this,i=void 0,o=function*(){let n=yield function(e){return new Promise(((t,r)=>{let n=Br.connect({host:e,port:8009,rejectUnauthorized:!1});n.on("secureConnect",(()=>{console.log(`Connected to chromecast at ${e}.`),t(n)})),n.on("close",(()=>{console.log(`Disconnected from chromecast at ${e}.`)})),n.on("error",(e=>{n.end()}))}))}(r);n.on("close",(()=>{Pn.delete(r)}));let i=yield function(e){return new Promise(((r,n)=>{t.get(`http://${e}:8008/ssdp/device-desc.xml`,(e=>{let t=[];e.on("data",(e=>{t.push(e)})),e.on("end",(()=>{let e=Buffer.concat(t).toString(),n=/<friendlyName>([^<]+)<\/friendlyName>/.exec(e);z(n)?r(n[1]):r(void 0)})),e.on("error",(()=>{n()}))}))}))}(r);new Jn(n,null!=i?i:"Chromecast",e)},new((s=void 0)||(s=Promise))((function(e,t){function r(e){try{l(o.next(e))}catch(e){t(e)}}function a(e){try{l(o.throw(e))}catch(e){t(e)}}function l(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(r,a)}l((o=o.apply(n,i||[])).next())}));var n,i,s,o}))}((e,t)=>{let r=en[e];void 0===r&&(r=new Array,en[e]=r),r.push((e=>{if(!Pn.has(e)){Pn.add(e);for(let t of Bn)try{t(e)}catch(e){}}})),(e=>{let t=Buffer.alloc(12);t.writeUInt16BE(1,4);let r=Buffer.alloc(1e3),n=0;e.split(".").forEach((e=>{if(e.length>=64)throw new Error;r.writeUInt8(e.length,n),n+=1,r.write(e,n),n+=e.length})),r.writeUInt8(0,n),n+=1,r.writeUInt16BE(12,n),n+=2,r.writeUInt16BE(1,n),n+=2,r=r.slice(0,0+n),ln.send(Buffer.concat([t,r]),5353,an)})(e)})("_googlecast._tcp.local");class Mn{constructor(e,t){this.socket=e,this.requestId=1,function(e,t){let r=Buffer.alloc(0),n=!0,i=4;e.on("data",(e=>{for(r=Buffer.concat([r,e]);r.length>=i;){let e=r.slice(0,i);r=r.slice(i),n?(n=!1,i=e.readUInt32BE(0)):(n=!0,i=4,t(e))}}))}(e,(e=>{try{let r=function(e){let t=function(e){let t=new Array;for(;e.offset<e.buffer.length;){let r=$r(e);t.push(r)}return t}({buffer:e,offset:0});return{protocol_version:Jr(1,t),source_id:Vr(2,t),destination_id:Vr(3,t),namespace:Vr(4,t),payload_type:Jr(5,t),payload_utf8:function(e,t){try{return Vr(6,t)}catch(e){return}}(0,t),payload_binary:function(e,t){try{return function(e,t){let r=t.filter((e=>7===e.key.field_number));if(0===r.length)throw"Expected required field to be present!";return r[r.length-1].data}(0,t)}catch(e){return}}(0,t)}}(e);t(r)}catch(e){console.log(e)}}))}getRequestId(){return Math.floor(65536*Math.random())}send(e){var t,r,n,i;let s=function(e){return Buffer.concat([Wr(1,e.protocol_version),Xr(2,e.source_id),Xr(3,e.destination_id),Xr(4,e.namespace),Wr(5,e.payload_type),(6,t=e.payload_utf8,null==t?Buffer.alloc(0):Xr(6,t)),Yr(7,e.payload_binary)]);var t}({protocol_version:null!==(t=e.protocol_version)&&void 0!==t?t:Dr.CASTV2_1_0,source_id:null!==(r=e.source_id)&&void 0!==r?r:"sender-0",destination_id:null!==(n=e.destination_id)&&void 0!==n?n:"receiver-0",namespace:e.namespace,payload_type:null!==(i=e.payload_type)&&void 0!==i?i:Pr.STRING,payload_utf8:e.payload_utf8,payload_binary:e.payload_binary}),o=Buffer.alloc(4);o.writeUInt32BE(s.length,0),this.socket.write(o),this.socket.write(s)}}class Gn{constructor(e){this.messageHandler=e,this.serializer=new a.m7.MessageSerializer(dn),this.listeners=new Nr.routing.MessageRouter}handle(e){var t;let r=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),n=a.l8.String.as(r.type);this.serializer.deserialize(JSON.stringify({type:n,data:r}),((e,t)=>{this.listeners.route(e,t)}))}send(e,t,r){this.messageHandler.send({namespace:Gn.NAMESPACE,destination_id:r,payload_utf8:JSON.stringify(t)})}}Gn.NAMESPACE="urn:x-cast:com.google.cast.tp.connection";class Fn{constructor(e){this.messageHandler=e,this.serializer=new a.m7.MessageSerializer(cn),this.listeners=new Nr.routing.MessageRouter}handle(e){var t;let r=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),n=a.l8.String.as(r.type);this.serializer.deserialize(JSON.stringify({type:n,data:r}),((e,t)=>{this.listeners.route(e,t)}))}send(e,t){this.messageHandler.send({namespace:Fn.NAMESPACE,payload_utf8:JSON.stringify(t)})}}Fn.NAMESPACE="urn:x-cast:com.google.cast.tp.heartbeat";class qn{constructor(e){this.transportId=new Mt(void 0),this.mediaSessionId=new Mt(void 0),this.messageHandler=e,this.serializer=new a.m7.MessageSerializer(Un),this.callbacks=new Map,this.requestId=1,this.listeners=new Nr.routing.MessageRouter}handle(e){var t;let r=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),n=a.l8.String.as(r.type);try{this.serializer.deserialize(JSON.stringify({type:n,data:r}),((e,t)=>{let r=this.callbacks.get(t.requestId);z(r)&&(this.callbacks.delete(t.requestId),r(t)),this.listeners.route(e,t)}))}catch(e){console.log(JSON.stringify(r,null,2))}}send(e,t,r){t.requestId=this.messageHandler.getRequestId(),z(r)&&this.callbacks.set(t.requestId,r),this.messageHandler.send({namespace:qn.NAMESPACE,destination_id:this.transportId.getState(),payload_utf8:JSON.stringify(t)})}}qn.NAMESPACE="urn:x-cast:com.google.cast.media";class $n{constructor(e){this.messageHandler=e,this.serializer=new a.m7.MessageSerializer(An),this.callbacks=new Map,this.requestId=1,this.listeners=new Nr.routing.MessageRouter}handle(e){var t;let r=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),n=a.l8.String.as(r.type);this.serializer.deserialize(JSON.stringify({type:n,data:r}),((e,t)=>{let r=this.callbacks.get(t.requestId);z(r)&&(this.callbacks.delete(t.requestId),r(t)),this.listeners.route(e,t)}))}send(e,t,r){t.requestId=this.messageHandler.getRequestId(),z(r)&&this.callbacks.set(t.requestId,r),this.messageHandler.send({namespace:$n.NAMESPACE,payload_utf8:JSON.stringify(t)})}}$n.NAMESPACE="urn:x-cast:com.google.cast.receiver";const zn="CC1AD845";class Jn{constructor(e,t,r){let n=new Mn(e,(e=>{let t=e.namespace;t===Gn.NAMESPACE?this.connectionHandler.handle(e):t===Fn.NAMESPACE?this.heartbeatHandler.handle(e):t===qn.NAMESPACE?this.mediaHandler.handle(e):t===$n.NAMESPACE&&this.receiverHandler.handle(e)}));this.socket=e,this.heartbeatHandler=new Fn(n),this.connectionHandler=new Gn(n),this.mediaHandler=new qn(n),this.receiverHandler=new $n(n);let i=`${r?"wss:":"ws:"}//127.0.0.1/sockets/context/?type=chromecast&name=${t}`;this.context=new jr(i,(e=>new xr.yU(e))),this.timer=void 0,e.on("close",(()=>{z(this.timer)&&clearTimeout(this.timer),this.context.close()})),this.connectionHandler.send("CONNECT",{type:"CONNECT"}),this.connectionHandler.listeners.addObserver("CLOSE",(e=>{this.mediaHandler.transportId.updateState(void 0)})),this.heartbeatHandler.listeners.addObserver("PING",(e=>{this.heartbeatHandler.send("PONG",{type:"PONG"})})),this.heartbeatHandler.listeners.addObserver("PONG",(e=>{this.setTimer()})),this.receiverHandler.listeners.addObserver("RECEIVER_STATUS",(e=>{var t;let r=(null!==(t=e.status.applications)&&void 0!==t?t:[]).find((e=>e.appId===zn));z(r)?this.mediaHandler.transportId.updateState(r.transportId):this.mediaHandler.transportId.updateState(void 0)})),this.mediaHandler.listeners.addObserver("MEDIA_STATUS",(e=>{let t=e.status[e.status.length-1];if(z(t)){let e=this.mediaHandler.mediaSessionId.getState();z(e)&&(t.mediaSessionId===e?this.context.isDeviceLocal.getState()&&"IDLE"===t.playerState&&"FINISHED"===t.idleReason&&this.context.next():this.mediaHandler.mediaSessionId.updateState(void 0))}})),this.setTimer(),this.mediaHandler.transportId.addObserver((e=>{z(e)&&this.connectionHandler.send("CONNECT",{type:"CONNECT"},e)})),this.context.isDeviceLocal.addObserver((e=>{if(e)$(this.mediaHandler.transportId.getState())&&this.receiverHandler.send("LAUNCH",{type:"LAUNCH",requestId:-1,appId:zn});else{let e=this.mediaHandler.mediaSessionId.getState();z(e)&&this.mediaHandler.send("STOP",{type:"STOP",requestId:-1,mediaSessionId:e})}}));{let e=()=>{let e=this.mediaHandler.transportId.getState(),t=this.context.currentLocalEntry.getState(),r=this.context.token.getState();if(z(e)&&z(t)&&z(r)){let e,n=function(e,t){let r=`${Ln}/files/${e.file.file_id}/?token=${t}`;if(cr.is(e)){let n=e,i=n.season.show;return{contentId:r,contentType:e.file.mime,streamType:"BUFFERED",metadata:{metadataType:0,title:n.title,subtitle:i.title},tracks:n.subtitles.map(((e,r)=>Object.assign(Object.assign({},Dn(e.language)),{trackId:r,type:"TEXT",trackType:"TEXT",trackContentId:`${Ln}/files/${e.file_id}/?token=${t}`,trackContentType:e.mime,subtype:"SUBTITLES"})))}}if(ir.is(e)){let n=e;return{contentId:r,contentType:e.file.mime,streamType:"BUFFERED",metadata:{metadataType:0,title:n.title,images:$(n.artwork)?void 0:[{url:`${Ln}/files/${n.artwork.file_id}/?token=${t}`}]},tracks:n.subtitles.map(((e,r)=>Object.assign(Object.assign({},Dn(e.language)),{trackId:r,type:"TEXT",trackType:"TEXT",trackContentId:`${Ln}/files/${e.file_id}/?token=${t}`,trackContentType:e.mime,subtype:"SUBTITLES"})))}}if(Xt.is(e)){let n=e,i=n.disc.album;return{contentId:r,contentType:e.file.mime,streamType:"BUFFERED",metadata:{metadataType:0,title:n.title,subtitle:n.artists.map((e=>e.title)).join("  "),images:$(i.artwork)?void 0:[{url:`${Ln}/files/${i.artwork.file_id}/?token=${t}`}]}}}throw"Expected code to be unreachable!"}(t,r);if(z(n.tracks)){let t=n.tracks.find((e=>"sv-SE"===e.language));if(z(t))e=[t.trackId];else{let t=n.tracks.find((e=>"en-US"===e.language));if(z(t))e=[t.trackId];else{let t=n.tracks.find((e=>"ja-JP"===e.language));z(t)&&(e=[t.trackId])}}}this.mediaHandler.send("LOAD",{type:"LOAD",requestId:-1,media:n,autoplay:!1,activeTrackIds:e},(e=>{if(xn.is(e)){let t=e.status[e.status.length-1];z(t)&&this.mediaHandler.mediaSessionId.updateState(t.mediaSessionId)}}))}};this.mediaHandler.transportId.addObserver(e),this.context.currentLocalEntry.addObserver(e),this.context.token.addObserver(e)}this.mediaHandler.transportId.addObserver((e=>{$(e)&&this.context.isDeviceLocal.getState()&&this.context.transfer(void 0)})),this.mediaHandler.transportId.addObserver((e=>{$(e)&&this.mediaHandler.mediaSessionId.updateState(void 0)}));{let e=()=>{let e=this.mediaHandler.mediaSessionId.getState();z(e)&&(this.context.playback.getState()?this.mediaHandler.send("PLAY",{type:"PLAY",requestId:-1,mediaSessionId:e}):this.mediaHandler.send("PAUSE",{type:"PAUSE",requestId:-1,mediaSessionId:e}))};this.mediaHandler.mediaSessionId.addObserver(e),this.context.playback.addObserver(e)}{let e=()=>{var e;let t=this.mediaHandler.mediaSessionId.getState();if(z(t)){let r=null!==(e=this.context.progress.getState())&&void 0!==e?e:0;this.mediaHandler.send("SEEK",{type:"SEEK",requestId:-1,mediaSessionId:t,currentTime:r})}};this.mediaHandler.mediaSessionId.addObserver(e),this.context.progress.addObserver(e)}}setTimer(){z(this.timer)&&(clearTimeout(this.timer),this.timer=void 0),this.timer=setTimeout((()=>{this.timer=void 0,this.heartbeatHandler.send("PING",{type:"PING"}),this.timer=setTimeout((()=>{this.socket.destroy()}),5e3)}),5e3)}}const Wn=new class{constructor(){this.tokens=new Map,this.sessions=new Map,this.chromecasts=new Mt([]),this.tss=new Ur(Ir),this.tss.addEventListener("sys","connect",(e=>{console.log("connect: "+e.connection_url);let t=Cr(e.connection_id,e.connection_url);this.tss.send("SetLocalDevice",e.connection_id,{device:t}),"chromecast"===t.type&&this.chromecasts.updateState([...this.chromecasts.getState(),t])})),this.tss.addEventListener("sys","disconnect",(e=>{console.log("disconnect: "+e.connection_url);let t=Cr(e.connection_id,e.connection_url);this.revokeAuthentication(e.connection_id),"chromecast"===t.type&&this.chromecasts.updateState(this.chromecasts.getState().filter((e=>e.id!==t.id)))})),this.tss.addEventListener("app","SetToken",(e=>{this.revokeAuthentication(e.connection_id);let t=e.data.token;if(z(t)){let r=St(t);this.tokens.set(e.connection_id,t);let n=this.getSession(r),i=Cr(e.connection_id,e.connection_url);n.devices.updateState([...n.devices.getState(),i]),this.tss.send("SetContext",e.connection_id,{context:n.context}),this.tss.send("SetDevice",e.connection_id,{device:n.device}),this.tss.send("SetIndex",e.connection_id,{index:n.index}),this.tss.send("SetPlayback",e.connection_id,{playback:n.playback}),this.tss.send("SetProgress",e.connection_id,{progress:n.progress}),this.tss.send("SetToken",e.connection_id,{token:t})}})),this.tss.addEventListener("app","SetContext",(e=>{this.getExistingSession(e.connection_id,(t=>{$(t.device)&&(t.device=Cr(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),t.index=void 0,this.tss.send("SetIndex",t.devices.getState().map((e=>e.id)),{index:t.index}),t.context=e.data.context,this.tss.send("SetContext",t.devices.getState().map((e=>e.id)),e.data)}))})),this.tss.addEventListener("app","SetDevice",(e=>{this.getExistingSession(e.connection_id,(t=>{this.updateProgress(t),this.tss.send("SetProgress",t.devices.getState().map((e=>e.id)),{progress:t.progress}),t.device=e.data.device,this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),e.data),z(t.device)&&this.tss.send("SetToken",t.device.id,{token:this.tokens.get(e.connection_id)})}))})),this.tss.addEventListener("app","SetIndex",(e=>{this.getExistingSession(e.connection_id,(t=>{$(t.device)&&(t.device=Cr(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),t.progress=z(e.data.index)?0:void 0,t.progressTimestamp=Date.now(),this.tss.send("SetProgress",t.devices.getState().map((e=>e.id)),{progress:t.progress}),t.index=e.data.index,this.tss.send("SetIndex",t.devices.getState().map((e=>e.id)),e.data)}))})),this.tss.addEventListener("app","SetPlayback",(e=>{this.getExistingSession(e.connection_id,(t=>{$(t.device)&&(t.device=Cr(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),this.updateProgress(t),t.playback=e.data.playback,this.tss.send("SetPlayback",t.devices.getState().map((e=>e.id)),e.data)}))})),this.tss.addEventListener("app","SetProgress",(e=>{this.getExistingSession(e.connection_id,(t=>{$(t.device)&&(t.device=Cr(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),t.progress=e.data.progress,t.progressTimestamp=Date.now(),this.tss.send("SetProgress",t.devices.getState().map((e=>e.id)),e.data)}))}))}getExistingSession(e,t){let r=this.tokens.get(e);if(z(r)){let e=St(r),n=this.sessions.get(e);z(n)&&t(n)}}getSession(e){let t=this.sessions.get(e);if(z(t))return t;const r={playback:!1,devices:new Mt(new Array)};let n=new Mt([]);{let e=()=>{let e=r.devices.getState(),t=this.chromecasts.getState().filter((t=>$(e.find((e=>e.id===t.id)))));n.updateState([...e,...t])};r.devices.addObserver(e),this.chromecasts.addObserver(e)}return n.addObserver((e=>{this.tss.send("SetDevices",r.devices.getState().map((e=>e.id)),{devices:e})})),r.devices.addObserver((e=>{this.updateProgress(r)})),r.devices.addObserver((e=>{$(e.find((e=>{var t;return e.id===(null===(t=r.device)||void 0===t?void 0:t.id)})))&&(this.updateProgress(r),r.playback=!1,this.tss.send("SetPlayback",e.map((e=>e.id)),{playback:r.playback}),r.device=void 0,this.tss.send("SetDevice",e.map((e=>e.id)),{device:r.device}))})),this.sessions.set(e,r),r}revokeAuthentication(e){let t=this.tokens.get(e);if(this.tokens.delete(e),z(t)){let r=St(t),n=this.sessions.get(r);if(z(n)){let t=n.devices;t.updateState(t.getState().filter((t=>t.id!==e)))}}}updateProgress(e){let t=Date.now();e.playback&&z(e.progress)&&z(e.progressTimestamp)&&(e.progress+=(t-e.progressTimestamp)/1e3),e.progressTimestamp=t}getRequestHandler(){return this.tss.getRequestHandler()}};function Vn(t,r){t.headers.host;let n=t.method||"",o=t.url||"";if(/^[/]sockets[/]/.test(o))return Wn.getRequestHandler()(t,r);let a,l=Date.now();if(r.on("finish",(()=>{let e=Date.now()-l;process.stderr.write(`${r.statusCode} ${n}:${o} (${e} ms)\n`)})),"GET"===n&&"/favicon.ico"===o)return r.writeHead(404),void r.end();if("GET"===n&&null!==(a=/^[/]files[/]([0-9a-f]{32})[/]/.exec(o))){return((t,r,n)=>{if(void 0===r.url)throw new Error;let o="";try{var a=s.parse(r.url,!0);o=St(a.query.token)}catch(e){return n.writeHead(401,{}),n.end()}let l,d=ue[t],c=d.path,u=d.mime,f=c.join(i.sep),p=e.openSync(f,"r"),h=e.fstatSync(p).size;e.closeSync(p);let g=r.headers.range;if(void 0!==g&&null!=(l=/^bytes\=((?:[0-9])|(?:[1-9][0-9]+))\-((?:[0-9])|(?:[1-9][0-9]+))?$/.exec(g))){let r=parseInt(l[1]),i=l[2]?parseInt(l[2]):null;if(null===i&&(i=h-1),r>=h||i>=h||i<r)return n.writeHead(416),void n.end();let s=i-r+1;n.writeHead(206,{"Access-Control-Allow-Origin":"*","Accept-Ranges":"bytes","Cache-Control":"private, max-age=86400","Content-Range":`bytes ${r}-${i}/${h}`,"Content-Type":u,"Content-Length":""+s}),(m=e.createReadStream(f,{start:r,end:i})).addListener("close",(()=>{r+m.bytesRead===h&&function(t,r){let n=Date.now();J.streams.push({username:t,file_id:r,timestamp_ms:n}),ke.insert(r,{file_id:r,username:t,timestamp_ms:n}),e.writeFileSync("./private/db/streams.json",JSON.stringify(J,null,"\t"))}(o,t)})),m.on("open",(function(){m.pipe(n)})),m.on("error",(function(e){n.end()}))}else{var m;(m=e.createReadStream(f)).on("open",(function(){n.writeHead(200,{"Access-Control-Allow-Origin":"*","Accept-Ranges":"bytes","Cache-Control":"private, max-age=86400","Content-Type":u,"Content-Length":""+h}),m.pipe(n)})),m.on("error",(function(e){n.writeHead(404),n.end()}))}})(a[1],t,r)}if(/^[/]media[/]/.test(o)){if(null!=(a=/^[/]media[/]stills[/]([0-9a-f]{32})[/]/.exec(o))){let t=a[1],n=ue[t],i=[".","private","stills",n.file_id];if(e.existsSync(i.join("/"))){let t=e.createReadStream(i.join("/"));t.on("open",(()=>{r.writeHead(200,{"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=86400","Content-Type":"image/jpeg"}),t.pipe(r)}))}else((t,s)=>{var o,a,l,d;o=this,a=void 0,d=function*(){if(yield function(e,t){return new Promise(((r,n)=>{return i=this,s=void 0,a=function*(){let i=yield Nt([".",...t.path],0),s=i[Math.floor(i.length/2)];Pt(((i,o)=>{let a=[...i,"still.jpeg"],l=_t.spawn("ffmpeg",["-ss",H(s),"-i",[".",...t.path].join("/"),"-vf","scale=w=960:h=540:force_original_aspect_ratio=decrease,pad=960:540:-1:-1","-map_metadata","-1",a.join("/"),"-y"]);l.on("error",(()=>(Ht(i.join("/")),n()))),l.on("exit",(()=>(Bt(a,e),Ht(i.join("/")),r())))}))},new((o=void 0)||(o=Promise))((function(e,t){function r(e){try{l(a.next(e))}catch(e){t(e)}}function n(e){try{l(a.throw(e))}catch(e){t(e)}}function l(t){var i;t.done?e(t.value):(i=t.value,i instanceof o?i:new o((function(e){e(i)}))).then(r,n)}l((a=a.apply(i,s||[])).next())}));var i,s,o,a}))}(i,n),!e.existsSync(i.join("/")))return r.writeHead(500),r.end();let t=e.createReadStream(i.join("/"));t.on("open",(()=>{r.writeHead(200,{"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=86400","Content-Type":"image/jpeg"}),t.pipe(r)}))},new((l=void 0)||(l=Promise))((function(e,t){function r(e){try{i(d.next(e))}catch(e){t(e)}}function n(e){try{i(d.throw(e))}catch(e){t(e)}}function i(t){var i;t.done?e(t.value):(i=t.value,i instanceof l?i:new l((function(e){e(i)}))).then(r,n)}i((d=d.apply(o,a||[])).next())}))})();return}if(null!=(a=/^[/]media[/]gifs[/]([0-9a-f]{32})[/]/.exec(o))){let t=a[1],n=ce[t],i=[".","private","memes",n.cue_id];if(e.existsSync(i.join("/"))){let t=e.createReadStream(i.join("/"));t.on("open",(()=>{r.writeHead(200,{"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=86400","Content-Type":"image/gif"}),t.pipe(r)}))}else!function(e,t,r){let n=X.video.subtitles.find((e=>e.subtitle_id===t.subtitle_id)),i=X.files.find((e=>e.file_id===n.file_id));const s=function(e){return ue[e.video_file_id]||null}(n);if(null==s)return r();Pt(((n,o)=>{let a=[...n,"subtitle.vtt"],l=[...n,"palette.png"],d=[...n,"meme.gif"],c=_t.spawn("ffmpeg",["-ss",H(t.start_ms),"-t",H(Math.min(t.duration_ms,5e3)),"-i",[".",...i.path].join("/"),a.join("/"),"-y"]);c.on("error",(()=>(console.log("ffmpeg command failed!"),Ht(n.join("/")),r()))),c.on("exit",(()=>{_t.spawn("ffmpeg",["-ss",H(t.start_ms),"-t",H(Math.min(t.duration_ms,5e3)),"-i",[".",...s.path].join("/"),"-vf","fps=15,scale=w=384:h=216:force_original_aspect_ratio=decrease,pad=384:216:-1:-1,subtitles="+a.join("/")+":force_style='Bold=1,Fontsize=24,Outline=2',palettegen",l.join("/"),"-y"]).on("exit",(()=>{_t.spawn("ffmpeg",["-ss",H(t.start_ms),"-t",H(Math.min(t.duration_ms,5e3)),"-i",[".",...s.path].join("/"),"-i",l.join("/"),"-filter_complex","fps=15,scale=w=384:h=216:force_original_aspect_ratio=decrease,pad=384:216:-1:-1,subtitles="+a.join("/")+":force_style='Bold=1,Fontsize=24,Outline=2'[x];[x][1:v]paletteuse","-map_metadata","-1",d.join("/"),"-y"]).on("exit",(()=>(Bt(d,e),Ht(n.join("/")),r())))}))}))}))}(i,n,(()=>{if(!e.existsSync(i.join("/")))return r.writeHead(500),r.end();let t=e.createReadStream(i.join("/"));t.on("open",(()=>{r.writeHead(200,{"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=86400","Content-Type":"image/gif"}),t.pipe(r)}))}));return}if(/^[/]media[/]channels[/]/.test(o))return void function(e,t,r){const n=t.method||"GET",i=t.url||"/";let s=null;"GET"===n&&null!=(s=/^[/]media[/]channels[/]([0-9]+)[/]([0-9]+)[/]([0-9]+)_([0-9a-f]+)[_]([0-9]+)(?:[_]([0-9]+)?)[.]ts/.exec(i))?(()=>{kt(this,void 0,void 0,(function*(){Number.parseInt(s[1]),Number.parseInt(s[2]),Number.parseInt(s[3]);const e=s[4],n=Number.parseInt(s[5]),i=s[6]?Number.parseInt(s[6]):null;let o=ue[e];if(!o)throw"Expected a valid file id!";const a=_t.spawn("ffmpeg",["-hide_banner","-ss",""+n/1e3,...null!=i?["-t",""+(i-80)/1e3]:[],"-i",o.path.join("/"),"-c","copy","-f","mpegts","-muxdelay","0","-avoid_negative_ts","disabled","-output_ts_offset","0","-copyts","pipe:"]);let l=t.headers.connection||"close";r.writeHead(200,{Connection:l}),a.stdout.pipe(r)}))})():"GET"===n&&null!=(s=/^[/]media[/]channels[/]([0-9]+)[/]([0-9]+)[/]/.exec(i))?(()=>{kt(this,void 0,void 0,(function*(){const n=Number.parseInt(s[1]),i=(Number.parseInt(s[2]),Date.now()),o=function(e){return xt(e).map((e=>{let t=Ae(e.file_id),r=t.duration,n=e.start_time_ms+t.duration;return Object.assign(Object.assign({},e),{duration_ms:r,end_time_ms:n})}))}(n);let a=0;for(;a<o.length;a++){let e=o[a];if(e.start_time_ms<=i&&i<e.end_time_ms)break}let l=o[a],d=yield At(l.file_id),c=0;for(;;){let e=d[c];if(l.start_time_ms+e.offset_ms+e.duration_ms>=i)break;c+=1}let u=c;const f=new Array;let p=0,h=0;for(;p<6&&h<3e4;){c>=d.length&&(f.push(""),f.push("#EXT-X-DISCONTINUITY"),a+=1,c=0,l=o[a],d=yield At(l.file_id));let t=d[c];f.push(""),f.push("#EXT-X-PROGRAM-DATE-TIME:"+new Date(l.start_time_ms+t.offset_ms).toISOString()),f.push(`#EXTINF:${(t.duration_ms/1e3).toFixed(3)},`),f.push(`${c}_${l.file_id}_${t.offset_ms}_${t.duration_ms}.ts?token=${e}`),c+=1,p+=1,h+=t.duration_ms}let g=["#EXTM3U","#EXT-X-VERSION:3","#EXT-X-TARGETDURATION:10","#EXT-X-DISCONTINUITY-SEQUENCE:"+a,"#EXT-X-MEDIA-SEQUENCE:"+u,...f].join("\n"),m=t.headers.connection||"close";r.writeHead(200,{Connection:m}),r.end(g)}))})():(r.writeHead(404),r.end())}(s.parse(t.url||"/",!0).query.token,t,r)}return/^[/]api[/]/.test(o)?((e,t)=>{try{Dt.route(e,t)}catch(e){t.writeHead(500),t.end(JSON.stringify({error:""+e}))}})(t,r):"GET"===n?(r.writeHead(200),void r.end(`<!doctype html><html><head><base href="/"/><meta charset="utf-8"/><meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0" name="viewport"/><link href="https://fonts.googleapis.com/css2?family=Nunito&family=Pacifico&family=Space+Mono&display=swap" rel="stylesheet"/><title>Orbit</title></head><body><script>${e.readFileSync("./dist/client.min.js")}<\/script></body></html>`)):(console.log("unhandled",JSON.stringify(t.headers,null,"\t")),r.writeHead(400),void r.end())}function Xn(t){if(e.existsSync(t))return e.readFileSync(t)}e.existsSync("./private/certs/")||e.mkdirSync("./private/certs/",{recursive:!0});let Yn=Xn("./private/certs/full_chain.pem"),Kn=Xn("./private/certs/dhparam.pem"),Qn=Xn("./private/certs/certificate_key.pem");if(Yn&&Qn){let e=n.createServer({cert:Yn,dhparam:Kn,key:Qn},Vn);e.listen(443,(()=>{console.log("https://localhost:443")})),e.keepAliveTimeout=6e4,t.createServer({},((e,t)=>{let r=e.headers.host||"",n=e.url||"",i=r.split(":").shift();t.writeHead(307,{Location:"https://"+i+":443"+n}),t.end()})).listen(80,(()=>{console.log("http://localhost:80")})),Hn(!0)}else{let e=t.createServer({},Vn);e.listen(80,(()=>{console.log("http://localhost:80")})),e.keepAliveTimeout=6e4,Hn(!1)}})()})();