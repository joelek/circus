(()=>{"use strict";var e={124:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getServerInfo=t.stop=t.scrub=t.rate=t.play=void 0,t.play=function(e,t,s,r){return e.request({method:"POST",path:"/play",headers:[{key:"Content-Type",value:"text/parameters"},{key:"X-Apple-Session-ID",value:t}],body:Buffer.from(["Content-Location: "+s,"Start-Position: "+r,""].join("\n"))})},t.rate=function(e,t,s){return e.request({method:"POST",path:"/rate?value="+s,headers:[{key:"X-Apple-Session-ID",value:t}]})},t.scrub=function(e,t,s){return e.request({method:"POST",path:"/scrub?position="+s,headers:[{key:"X-Apple-Session-ID",value:t}]})},t.stop=function(e,t){return e.request({method:"POST",path:"/stop",headers:[{key:"X-Apple-Session-ID",value:t}]})},t.getServerInfo=function(e,t){return e.request({method:"GET",path:"/server-info",headers:[{key:"X-Apple-Session-ID",value:t}]})}},7895:function(e,t,s){var r=this&&this.__awaiter||function(e,t,s,r){return new(s||(s=Promise))((function(i,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Device=void 0;const i=s(6417),a=s(4545),n=s(7978),o=s(4676),l=s(1565),d=s(6440),u=s(9762),c=s(124),f=s(9549),g=s(5235);class p extends n.routing.MessageRouter{constructor(e,t,s,n){super();let p=[i.randomBytes(4).toString("hex"),i.randomBytes(2).toString("hex"),i.randomBytes(2).toString("hex"),i.randomBytes(2).toString("hex"),i.randomBytes(6).toString("hex")].join("-"),h=new f.OutboundSocket({host:e,port:7e3});h.addObserver("close",(()=>{this.route("close",{})})),c.getServerInfo(h,p).then((()=>{let i=new f.InboundSocket({host:e,port:7e3},{method:"POST",path:"/reverse",headers:[{key:"X-Apple-Purpose",value:"event"},{key:"X-Apple-Session-ID",value:p}]},(e=>r(this,void 0,void 0,(function*(){let t=e.body.toString(),s=g.parseFromString(t);return u.messages.PlayingEvent.is(s)?y.resume():u.messages.PausedEvent.is(s)?y.pause():u.messages.StoppedEvent.is(s)&&"ended"===s.reason&&y.next(),{status:200,reason:"OK"}}))));i.addObserver("close",(()=>{this.route("close",{})}));let m=`${t?"wss:":"ws:"}//127.0.0.1/sockets/context/?protocol=airplay&name=${encodeURIComponent(s)}&type=${encodeURIComponent(n)}`,y=new o.ContextClient(m,(e=>new a.WebSocketClient(e)));d.computed(((e,t)=>r(this,void 0,void 0,(function*(){if(l.present(e)&&l.present(t)){let s=`https://ap.joelek.se/files/${e.media.file_id}/?token=${t}`;yield c.play(h,p,s,0)}else yield c.stop(h,p)}))),y.currentLocalEntry,y.token),d.computed(((e,t)=>r(this,void 0,void 0,(function*(){l.present(e)&&l.present(t)&&(yield c.scrub(h,p,t))}))),y.currentLocalEntry,y.progress),d.computed((e=>r(this,void 0,void 0,(function*(){yield c.rate(h,p,e?1:0)}))),y.playback),this.addObserver("close",(()=>{y.close(),h.close(),i.close()}))}))}}t.Device=p},9549:function(e,t,s){var r=this&&this.__awaiter||function(e,t,s,r){return new(s||(s=Promise))((function(i,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.InboundSocket=t.OutboundSocket=t.serializeResponse=t.parseResponse=t.serializeRequest=t.parseRequest=t.serializeMessage=t.parseMessage=void 0;const i=s(1631),a=s(7978),n=s(1565);function o(e){let t=e.toString("binary").split("\r\n"),s=0,r=t[s++],i=new Array;for(;s<t.length;){let e=t[s++];if(""===e)break;let r=e.split(": "),a=r[0],n=r.slice(1).join(": ");i.push({key:Buffer.from(a,"binary").toString(),value:Buffer.from(n,"binary").toString()})}let a=Buffer.from(t.slice(s).join("\r\n"),"binary");return{line:Buffer.from(r,"binary").toString(),headers:i,body:a}}function l(e){var t,s;let r=null!==(t=e.body)&&void 0!==t?t:Buffer.alloc(0),i=[{key:"Content-Length",value:""+r.length},...null!==(s=e.headers)&&void 0!==s?s:[]],a=Buffer.from([e.line,...i.map((e=>`${e.key}: ${e.value}`)),"",""].join("\r\n"));return Buffer.concat([a,r])}function d(e){let t=o(e),s=t.line.split(" ");if(3!==s.length)throw"Expected three parts in request line!";return{method:s[0],path:s[1],version:s[2],headers:t.headers,body:t.body}}function u(e){var t,s,r;return l({line:`${null!==(t=e.method)&&void 0!==t?t:"GET"} ${null!==(s=e.path)&&void 0!==s?s:"/"} ${null!==(r=e.version)&&void 0!==r?r:"HTTP/1.1"}`,headers:e.headers,body:e.body})}function c(e){let t=o(e),s=t.line.split(" ");if(s.length<3)throw"Expected at least three parts in response line!";if(!/^[1-9][0-9][0-9]$/.test(s[1]))throw"Expected a three-digit status!";return{version:s[0],status:Number.parseInt(s[1]),reason:s.slice(2).join(" "),headers:t.headers,body:t.body}}function f(e){var t,s,r;return l({line:`${null!==(t=e.version)&&void 0!==t?t:"HTTP/1.1"} ${null!==(s=e.status)&&void 0!==s?s:200} ${null!==(r=e.reason)&&void 0!==r?r:"OK"}`,headers:e.headers,body:e.body})}t.parseMessage=o,t.serializeMessage=l,t.parseRequest=d,t.serializeRequest=u,t.parseResponse=c,t.serializeResponse=f;class g extends a.routing.MessageRouter{constructor(e){super();let t=i.createConnection(e);t.on("connect",(()=>{})),t.on("close",(()=>{this.route("close",{})})),t.on("error",(()=>{t.destroy()})),this.socket=t}close(){this.socket.destroy()}request(e){return r(this,void 0,void 0,(function*(){return new Promise(((t,s)=>{this.socket.write(u(e));let i=e=>r(this,void 0,void 0,(function*(){this.socket.off("data",i);let s=c(e);t(s)}));this.socket.on("data",i)}))}))}}t.OutboundSocket=g;class p extends a.routing.MessageRouter{constructor(e,t,s){super();let a=i.createConnection(e),o=e=>{let t=c(e);if(101!==t.status)return a.emit("error","Expected status 101!");let i=t.headers.find((e=>"connection"===e.key.toLowerCase()));if(n.absent(i)||"Upgrade"!==i.value)return a.emit("error","Expected a valid connection header!");let l=t.headers.find((e=>"upgrade"===e.key.toLowerCase()));if(n.absent(l)||"PTTH/1.0"!==l.value)return a.emit("error","Expected a valid upgrade header!");a.off("data",o),a.on("data",(e=>r(this,void 0,void 0,(function*(){try{let t=d(e),r=yield s(t);a.write(f(r))}catch(e){a.emit("error",e)}}))))};a.on("data",o),a.on("connect",(()=>{var e;a.write(u(Object.assign(Object.assign({},t),{headers:[{key:"Connection",value:"Upgrade"},{key:"Upgrade",value:"PTTH/1.0"},...null!==(e=t.headers)&&void 0!==e?e:[]]})))})),a.on("close",(()=>{this.route("close",{})})),a.on("error",(()=>{a.destroy()})),this.socket=a}close(){this.socket.destroy()}}t.InboundSocket=p},7244:function(e,t,s){var r=this&&this.__awaiter||function(e,t,s,r){return new(s||(s=Promise))((function(i,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.discover=t.observe=void 0;const i=s(1687),a=s(1565),n=s(7895),o=new Map;t.observe=function(e){i.observe("_airplay._tcp.local",(t=>r(this,void 0,void 0,(function*(){try{let{hostname:s,service_info:r}=Object.assign({},t),i=o.get(s);if(a.absent(i)){let t=function(e){let t=e[e.length-1];if(a.present(t)){let e=/^([^.]+)[.]_airplay[.]_tcp[.]local$/.exec(t);if(a.present(e))return e[1]}return"AirPlay"}(null!=r?r:[]),i=function(e){for(let t of e){let e=t.split("=");if(e.length>=2&&"model"===e[0])return e.slice(1).join("=")}return"Generic AirPlay Device"}(null!=r?r:[]),l=new n.Device(s,e,t,i);o.set(s,l),l.addObserver("close",(function e(){l.removeObserver("close",e),o.delete(s)}))}}catch(e){console.log(e)}}))))},t.discover=function(){i.sendDiscoveryPacket("_airplay._tcp.local")}},5235:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.parseFromString=void 0;const r=s(8161);function i(e){e.tag("key");let t=e.children();if(1!==t.length())throw"Expected exactly one child!";return t.get(0).asText().value()}function a(e){try{return function(e){e.tag("array");let t=e.children(),s=[];for(let e=0;e<t.length();e+=1){let r=t.get(e+0).asElement();s.push(a(r))}return s}(e)}catch(e){}try{return function(e){try{return function(e){if(e.tag("false"),0!==e.children().length())throw"Expected exactly zero children!";return!1}(e)}catch(e){}try{return function(e){if(e.tag("true"),0!==e.children().length())throw"Expected exactly zero children!";return!0}(e)}catch(e){}throw"Expected a boolean!"}(e)}catch(e){}try{return function(e){try{return function(e){e.tag("integer");let t=e.children();if(1!==t.length())throw"Expected exactly one child!";let s=t.get(0).asText().value(),r=Number.parseInt(s);if(Number.isNaN(r))throw"Expected an integer number!";return r}(e)}catch(e){}try{return function(e){e.tag("real");let t=e.children();if(1!==t.length())throw"Expected exactly one child!";let s=t.get(0).asText().value(),r=Number.parseFloat(s);if(Number.isNaN(r))throw"Expected a real-valued number!";return r}(e)}catch(e){}throw"Expected a number!"}(e)}catch(e){}try{return function(e){e.tag("dict");let t=e.children(),s={};for(let e=0;e<t.length();e+=2){let r=t.get(e+0).asElement(),n=t.get(e+1).asElement();s[i(r)]=a(n)}return s}(e)}catch(e){}try{return function(e){e.tag("string");let t=e.children();if(1!==t.length())throw"Expected exactly one child!";return t.get(0).asText().value()}(e)}catch(e){}throw"Expected a type!"}t.parseFromString=function(e){let t=r.parse(e).root;t.tag("plist");let s=t.children();if(1!==s.length())throw"Expected exactly one child!";return a(s.get(0).asElement())}},9762:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.messages=void 0,t.messages=s(5293)},5293:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Autoguard=t.StoppedEvent=t.PausedEvent=t.PlayingEvent=t.LoadingEvent=void 0;const r=s(9175);t.LoadingEvent=r.guards.Object.of({sessionID:r.guards.Number,state:r.guards.StringLiteral.of("loading")}),t.PlayingEvent=r.guards.Object.of({sessionID:r.guards.Number,state:r.guards.StringLiteral.of("playing")}),t.PausedEvent=r.guards.Object.of({sessionID:r.guards.Number,state:r.guards.StringLiteral.of("paused")}),t.StoppedEvent=r.guards.Object.of({sessionID:r.guards.Number,state:r.guards.StringLiteral.of("stopped"),reason:r.guards.String}),t.Autoguard={LoadingEvent:t.LoadingEvent,PlayingEvent:t.PlayingEvent,PausedEvent:t.PausedEvent,StoppedEvent:t.StoppedEvent}},4181:function(e,t,s){var r=this&&this.__awaiter||function(e,t,s,r){return new(s||(s=Promise))((function(i,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.handleRequest=void 0;const i=s(8835),a=s(3601),n=s(3601),o=s(3579),l=s(2640),d=s(1565);function u(e,t){try{return function(e,t){let s=Number.parseInt(function(e,t){let s=function(e,t){var s;let r=null!==(s=e.query[t])&&void 0!==s?s:[];return Array.isArray(r)?r:[r]}(e,t).pop();if(d.absent(s))throw`Expected parameter ${t}!`;return s}(e,t),10);if(!Number.isInteger(s))throw`Expected integer ${t}!`;return s}(e,t)}catch(e){}}function c(e){var t=i.parse(e.url||"/",!0);return n.getUserId(t.query.token)}let f=(new class{constructor(){this.routes=new Array}registerRoute(e){return this.routes.push(e),this}route(e,t){for(let s of this.routes)if(s.handlesRequest(e))return s.handleRequest(e,t);t.writeHead(400),t.end("{}")}}).registerRoute(new class{constructor(){}handleRequest(e,t){if(void 0===e.url)throw new Error;let s=/^[/]api[/]auth[/][?]token[=]([0-9a-f]{64})/.exec(e.url);if(null===s)throw new Error;let r=s[1],i={};try{return a.getUserId(r),t.writeHead(200),i.token=r,t.end(JSON.stringify(i))}catch(e){}return t.writeHead(401),t.end(JSON.stringify({}))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^[/]api[/]auth[/][?]token[=]([0-9a-f]{64})/.test(e.url)}}).registerRoute(new class{constructor(){}handleRequest(e,t){if(void 0===e.url)throw new Error;let s="";e.on("data",(e=>{s+=e})).on("end",(()=>{try{let e=JSON.parse(s);if(null==e||e.constructor!==Object)throw new Error;if(null==e.username||e.username.constructor!==String)throw new Error;if(null==e.password||e.password.constructor!==String)throw new Error;let r=e,i=r.username,n=r.password,o={token:a.createToken(i,n)};t.writeHead(200),t.end(JSON.stringify(o))}catch(e){console.log(e),t.writeHead(400),t.end(JSON.stringify({error:e.message}))}}))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^[/]api[/]auth[/]/.test(e.url)}}).registerRoute(new class{handleRequest(e,t){(function(e){return new Promise(((t,s)=>{let r=new Array;e.on("data",(e=>{r.push(e)})),e.on("end",(()=>{let e=Buffer.concat(r);t(e)})),e.on("error",(e=>{s(e)}))}))})(e).then((e=>{let s=l.messages.RegisterRequest.as(JSON.parse(e.toString()));this.handleAsyncRequest(s).then((e=>{t.writeHead(200),t.end(JSON.stringify(e))}))}))}handleAsyncRequest(e){return r(this,void 0,void 0,(function*(){return o.createUser(e)}))}handlesRequest(e){var t;return/^[/]api[/]register[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s,r,a,n;let l=c(e),d=/^[/]api[/]video[/]movies[/]([0-9a-f]{32})[/]suggestions[/]movies[/]/.exec(null!==(s=e.url)&&void 0!==s?s:"/"),f=i.parse(null!==(r=e.url)&&void 0!==r?r:"/",!0),g=null!==(a=u(f,"offset"))&&void 0!==a?a:0,p=null!==(n=u(f,"length"))&&void 0!==n?n:24,h=d[1],m={movies:o.getMovieSuggestions(h,g,p,l)};t.writeHead(200),t.end(JSON.stringify(m))}handlesRequest(e){var t;return/^[/]api[/]video[/]movies[/]([0-9a-f]{32})[/]suggestions[/]movies[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s;let r=c(e),i=/^[/]api[/]video[/]movies[/]([0-9a-f]{32})[/]/.exec(null!==(s=e.url)&&void 0!==s?s:"/")[1],a={movie:o.lookupMovie(i,r)};t.writeHead(200),t.end(JSON.stringify(a))}handlesRequest(e){var t;return/^[/]api[/]video[/]movies[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s,r,a,n;let l=c(e),d=/^[/]api[/]video[/]movies[/]([^/?]*)/.exec(null!==(s=e.url)&&void 0!==s?s:"/"),f=decodeURIComponent(d[1]),g=i.parse(null!==(r=e.url)&&void 0!==r?r:"/",!0),p=null!==(a=u(g,"offset"))&&void 0!==a?a:0,h=null!==(n=u(g,"length"))&&void 0!==n?n:24,m={movies:o.searchForMovies(f,p,h,l)};t.writeHead(200),t.end(JSON.stringify(m))}handlesRequest(e){var t;return/^[/]api[/]video[/]movies[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s;let r=c(e),i=/^[/]api[/]audio[/]artists[/]([0-9a-f]{32})[/]/.exec(null!==(s=e.url)&&void 0!==s?s:"/")[1],a={artist:o.lookupArtist(i,r),tracks:o.getArtistTracks(i,0,3,r),appearances:o.getArtistAppearances(i,r)};t.writeHead(200),t.end(JSON.stringify(a))}handlesRequest(e){var t;return/^[/]api[/]audio[/]artists[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s,r,a,n;let l=c(e),d=/^[/]api[/]audio[/]artists[/]([^/?]*)/.exec(null!==(s=e.url)&&void 0!==s?s:"/"),f=decodeURIComponent(d[1]),g=i.parse(null!==(r=e.url)&&void 0!==r?r:"/",!0),p=null!==(a=u(g,"offset"))&&void 0!==a?a:0,h=null!==(n=u(g,"length"))&&void 0!==n?n:24,m={artists:o.searchForArtists(f,p,h,l)};t.writeHead(200),t.end(JSON.stringify(m))}handlesRequest(e){var t;return/^[/]api[/]audio[/]artists[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s;let r=c(e),i=/^[/]api[/]audio[/]albums[/]([0-9a-f]{32})[/]/.exec(null!==(s=e.url)&&void 0!==s?s:"/")[1],a={album:o.lookupAlbum(i,r)};t.writeHead(200),t.end(JSON.stringify(a))}handlesRequest(e){var t;return/^[/]api[/]audio[/]albums[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s,r,a,n;let l=c(e),d=/^[/]api[/]audio[/]albums[/]([^/?]*)/.exec(null!==(s=e.url)&&void 0!==s?s:"/")[1],f=i.parse(null!==(r=e.url)&&void 0!==r?r:"/",!0),g=null!==(a=u(f,"offset"))&&void 0!==a?a:0,p=null!==(n=u(f,"length"))&&void 0!==n?n:24,h={albums:o.searchForAlbums(d,g,p,l)};t.writeHead(200),t.end(JSON.stringify(h))}handlesRequest(e){var t;return/^[/]api[/]audio[/]albums[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s;let r=c(e),i=/^[/]api[/]video[/]episodes[/]([0-9a-f]{32})[/]/.exec(null!==(s=e.url)&&void 0!==s?s:"/")[1],a=o.lookupEpisode(i,r),n=o.lookupSeason(a.season.season_id,r).episodes,l=n.findIndex((e=>e.episode_id===a.episode_id)),d=n[l-1],u=n[l+1],f={episode:a,last:d,next:u};t.writeHead(200),t.end(JSON.stringify(f))}handlesRequest(e){var t;return/^[/]api[/]video[/]episodes[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s,r,a,n;let l=c(e),d=/^[/]api[/]video[/]episodes[/]([^/?]*)/.exec(null!==(s=e.url)&&void 0!==s?s:"/"),f=decodeURIComponent(d[1]),g=i.parse(null!==(r=e.url)&&void 0!==r?r:"/",!0),p=null!==(a=u(g,"offset"))&&void 0!==a?a:0,h=null!==(n=u(g,"length"))&&void 0!==n?n:24,m={episodes:o.searchForEpisodes(f,p,h,l)};t.writeHead(200),t.end(JSON.stringify(m))}handlesRequest(e){var t;return/^[/]api[/]video[/]episodes[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s;let r=c(e),i=/^[/]api[/]video[/]shows[/]([0-9a-f]{32})[/]/.exec(null!==(s=e.url)&&void 0!==s?s:"/")[1],a={show:o.lookupShow(i,r)};t.writeHead(200),t.end(JSON.stringify(a))}handlesRequest(e){var t;return/^[/]api[/]video[/]shows[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s,r,a,n;let l=c(e),d=/^[/]api[/]video[/]shows[/]([^/?]*)/.exec(null!==(s=e.url)&&void 0!==s?s:"/"),f=decodeURIComponent(d[1]),g=i.parse(null!==(r=e.url)&&void 0!==r?r:"/",!0),p=null!==(a=u(g,"offset"))&&void 0!==a?a:0,h=null!==(n=u(g,"length"))&&void 0!==n?n:24,m={shows:o.searchForShows(f,p,h,l)};t.writeHead(200),t.end(JSON.stringify(m))}handlesRequest(e){var t;return/^[/]api[/]video[/]shows[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s,r,a,n;let l=c(e),d=/^[/]api[/]persons[/]([0-9a-f]{32})[/]shows[/]/.exec(null!==(s=e.url)&&void 0!==s?s:"/")[1],f=i.parse(null!==(r=e.url)&&void 0!==r?r:"/",!0),g=null!==(a=u(f,"offset"))&&void 0!==a?a:0,p=null!==(n=u(f,"length"))&&void 0!==n?n:24,h={shows:o.getShowsFromPerson(d,l,g,p)};t.writeHead(200),t.end(JSON.stringify(h))}handlesRequest(e){var t;return/^[/]api[/]persons[/]([0-9a-f]{32})[/]shows[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s,r,a,n;let l=c(e),d=/^[/]api[/]persons[/]([0-9a-f]{32})[/]movies[/]/.exec(null!==(s=e.url)&&void 0!==s?s:"/")[1],f=i.parse(null!==(r=e.url)&&void 0!==r?r:"/",!0),g=null!==(a=u(f,"offset"))&&void 0!==a?a:0,p=null!==(n=u(f,"length"))&&void 0!==n?n:24,h={movies:o.getMoviesFromPerson(d,l,g,p)};t.writeHead(200),t.end(JSON.stringify(h))}handlesRequest(e){var t;return/^[/]api[/]persons[/]([0-9a-f]{32})[/]movies[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s;let r=c(e),i=/^[/]api[/]persons[/]([0-9a-f]{32})[/]/.exec(null!==(s=e.url)&&void 0!==s?s:"/")[1],a={person:o.lookupPerson(i,r)};t.writeHead(200),t.end(JSON.stringify(a))}handlesRequest(e){var t;return/^[/]api[/]persons[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s,r,a,n;let l=c(e),d=/^[/]api[/]persons[/]([^/?]*)/.exec(null!==(s=e.url)&&void 0!==s?s:"/"),f=decodeURIComponent(d[1]),g=i.parse(null!==(r=e.url)&&void 0!==r?r:"/",!0),p=null!==(a=u(g,"offset"))&&void 0!==a?a:0,h=null!==(n=u(g,"length"))&&void 0!==n?n:24,m={persons:o.searchForPersons(f,p,h,l)};t.writeHead(200),t.end(JSON.stringify(m))}handlesRequest(e){var t;return/^[/]api[/]persons[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s;let r=c(e),i=/^[/]api[/]audio[/]playlists[/]([0-9a-f]{32})[/]/.exec(null!==(s=e.url)&&void 0!==s?s:"/")[1],a={playlist:o.lookupPlaylist(i,r)};t.writeHead(200),t.end(JSON.stringify(a))}handlesRequest(e){var t;return/^[/]api[/]audio[/]playlists[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s,r,a,n;let l=c(e),d=/^[/]api[/]audio[/]playlists[/]([^/?]*)/.exec(null!==(s=e.url)&&void 0!==s?s:"/"),f=decodeURIComponent(d[1]),g=i.parse(null!==(r=e.url)&&void 0!==r?r:"/",!0),p=null!==(a=u(g,"offset"))&&void 0!==a?a:0,h=null!==(n=u(g,"length"))&&void 0!==n?n:24,m={playlists:o.searchForPlaylists(f,p,h,l)};t.writeHead(200),t.end(JSON.stringify(m))}handlesRequest(e){var t;return/^[/]api[/]audio[/]playlists[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s,r,a,n;let l=c(e),d=/^[/]api[/]audio[/]tracks[/]([0-9a-f]{32})[/]playlists[/]/.exec(null!==(s=e.url)&&void 0!==s?s:"/"),f=decodeURIComponent(d[1]),g=i.parse(null!==(r=e.url)&&void 0!==r?r:"/",!0),p=null!==(a=u(g,"offset"))&&void 0!==a?a:0,h=null!==(n=u(g,"length"))&&void 0!==n?n:24,m={playlists:o.getPlaylistAppearances(f,p,h,l)};t.writeHead(200),t.end(JSON.stringify(m))}handlesRequest(e){var t;return/^[/]api[/]audio[/]tracks[/]([0-9a-f]{32})[/]playlists[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s;let r=c(e),i=/^[/]api[/]audio[/]tracks[/]([0-9a-f]{32})[/]/.exec(null!==(s=e.url)&&void 0!==s?s:"/")[1],a=o.lookupTrack(i,r),n=o.lookupDisc(a.disc.disc_id,r).tracks,l=n.findIndex((e=>e.track_id===a.track_id)),d=n[l-1],u=n[l+1],f={track:a,last:d,next:u};t.writeHead(200),t.end(JSON.stringify(f))}handlesRequest(e){var t;return/^[/]api[/]audio[/]tracks[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s,r,a,n;let l=c(e),d=/^[/]api[/]audio[/]tracks[/]([^/?]*)/.exec(null!==(s=e.url)&&void 0!==s?s:"/"),f=decodeURIComponent(d[1]),g=i.parse(null!==(r=e.url)&&void 0!==r?r:"/",!0),p=null!==(a=u(g,"offset"))&&void 0!==a?a:0,h=null!==(n=u(g,"length"))&&void 0!==n?n:24,m={tracks:o.searchForTracks(f,p,h,l)};t.writeHead(200),t.end(JSON.stringify(m))}handlesRequest(e){var t;return/^[/]api[/]audio[/]tracks[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s;let r=c(e),i=/^[/]api[/]video[/]seasons[/]([0-9a-f]{32})[/]/.exec(null!==(s=e.url)&&void 0!==s?s:"/")[1],a=o.lookupSeason(i,r),n=o.lookupShow(a.show.show_id,r).seasons,l=n.findIndex((e=>e.season_id===a.season_id)),d=n[l-1],u=n[l+1],f={season:a,last:d,next:u};t.writeHead(200),t.end(JSON.stringify(f))}handlesRequest(e){var t;return/^[/]api[/]video[/]seasons[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s,r,a,n;let l=c(e),d=/^[/]api[/]video[/]seasons[/]([^/?]*)/.exec(null!==(s=e.url)&&void 0!==s?s:"/"),f=decodeURIComponent(d[1]),g=i.parse(null!==(r=e.url)&&void 0!==r?r:"/",!0),p=null!==(a=u(g,"offset"))&&void 0!==a?a:0,h=null!==(n=u(g,"length"))&&void 0!==n?n:24,m={seasons:o.searchForSeasons(f,p,h,l)};t.writeHead(200),t.end(JSON.stringify(m))}handlesRequest(e){var t;return/^[/]api[/]video[/]seasons[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s;let r=c(e),i=/^[/]api[/]audio[/]discs[/]([0-9a-f]{32})[/]/.exec(null!==(s=e.url)&&void 0!==s?s:"/")[1],a=o.lookupDisc(i,r),n=o.lookupAlbum(a.album.album_id,r).discs,l=n.findIndex((e=>e.disc_id===a.disc_id)),d=n[l-1],u=n[l+1],f={disc:a,last:d,next:u};t.writeHead(200),t.end(JSON.stringify(f))}handlesRequest(e){var t;return/^[/]api[/]audio[/]discs[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s,r,a,n;let l=c(e),d=/^[/]api[/]audio[/]discs[/]([^/?]*)/.exec(null!==(s=e.url)&&void 0!==s?s:"/"),f=decodeURIComponent(d[1]),g=i.parse(null!==(r=e.url)&&void 0!==r?r:"/",!0),p=null!==(a=u(g,"offset"))&&void 0!==a?a:0,h=null!==(n=u(g,"length"))&&void 0!==n?n:24,m={discs:o.searchForDiscs(f,p,h,l)};t.writeHead(200),t.end(JSON.stringify(m))}handlesRequest(e){var t;return/^[/]api[/]audio[/]discs[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s;let r=c(e),i=/^[/]api[/]users[/]([0-9a-f]{32})[/]/.exec(null!==(s=e.url)&&void 0!==s?s:"/"),a=o.lookupUser(i[1]),n={user:a,playlists:o.getUserPlaylists(a.user_id,r)};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]users[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s,r,a,n;let l=c(e),d=/^[/]api[/]users[/]([^/?]*)/.exec(null!==(s=e.url)&&void 0!==s?s:"/"),f=decodeURIComponent(d[1]),g=i.parse(null!==(r=e.url)&&void 0!==r?r:"/",!0),p=null!==(a=u(g,"offset"))&&void 0!==a?a:0,h=null!==(n=u(g,"length"))&&void 0!==n?n:24,m={users:o.searchForUsers(f,p,h,l)};t.writeHead(200),t.end(JSON.stringify(m))}handlesRequest(e){var t;return/^[/]api[/]users[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s,r,a,n;let l=c(e),d=/^[/]api[/]video[/]cues[/]([^/?]*)/.exec(null!==(s=e.url)&&void 0!==s?s:"/"),f=decodeURIComponent(d[1]),g=i.parse(null!==(r=e.url)&&void 0!==r?r:"/",!0),p=null!==(a=u(g,"offset"))&&void 0!==a?a:0,h=null!==(n=u(g,"length"))&&void 0!==n?n:24,m={cues:o.searchForCues(f,p,h,l)};t.writeHead(200),t.end(JSON.stringify(m))}handlesRequest(e){var t;return/^[/]api[/]video[/]cues[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s,r,a,n;let l=c(e),d=/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]shows[/]/.exec(null!==(s=e.url)&&void 0!==s?s:"/"),f=i.parse(null!==(r=e.url)&&void 0!==r?r:"/",!0),g=null!==(a=u(f,"offset"))&&void 0!==a?a:0,p=null!==(n=u(f,"length"))&&void 0!==n?n:24,h=d[1],m={shows:o.getShowsFromGenre(h,l,g,p)};t.writeHead(200),t.end(JSON.stringify(m))}handlesRequest(e){var t;return/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]shows[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s,r,a,n;let l=c(e),d=/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]movies[/]/.exec(null!==(s=e.url)&&void 0!==s?s:"/"),f=i.parse(null!==(r=e.url)&&void 0!==r?r:"/",!0),g=null!==(a=u(f,"offset"))&&void 0!==a?a:0,p=null!==(n=u(f,"length"))&&void 0!==n?n:24,h=d[1],m={movies:o.getMoviesFromGenre(h,l,g,p)};t.writeHead(200),t.end(JSON.stringify(m))}handlesRequest(e){var t;return/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]movies[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s;let r=c(e),i=/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]/.exec(null!==(s=e.url)&&void 0!==s?s:"/")[1],a={genre:o.lookupGenre(i,r)};t.writeHead(200),t.end(JSON.stringify(a))}handlesRequest(e){var t;return/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s,r,a,n;let l=c(e),d=/^[/]api[/]video[/]genres[/]([^/?]*)/.exec(null!==(s=e.url)&&void 0!==s?s:"/"),f=decodeURIComponent(d[1]),g=i.parse(null!==(r=e.url)&&void 0!==r?r:"/",!0),p=null!==(a=u(g,"offset"))&&void 0!==a?a:0,h=null!==(n=u(g,"length"))&&void 0!==n?n:24,m={genres:o.searchForGenres(f,p,h,l)};t.writeHead(200),t.end(JSON.stringify(m))}handlesRequest(e){var t;return/^[/]api[/]video[/]genres[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var s,r,a,n;let l=c(e),d=/^[/]api[/]search[/]([^/?]*)/.exec(null!==(s=e.url)&&void 0!==s?s:"/"),f=decodeURIComponent(d[1]),g=i.parse(null!==(r=e.url)&&void 0!==r?r:"/",!0),p=null!==(a=u(g,"offset"))&&void 0!==a?a:0,h=null!==(n=u(g,"length"))&&void 0!==n?n:24,m={entities:o.searchForEntities(f,l,p,h)};t.writeHead(200),t.end(JSON.stringify(m))}handlesRequest(e){var t;return/^[/]api[/]search[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}});t.handleRequest=(e,t)=>{try{f.route(e,t)}catch(e){t.writeHead(500),t.end(JSON.stringify({error:""+e}))}}},3579:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getUserPlaylists=t.getShowsFromPerson=t.getShowsFromGenre=t.getMoviesFromPerson=t.getMoviesFromGenre=t.getMovieSuggestions=t.getPlaylistAppearances=t.getArtistTracks=t.getArtistAppearances=t.searchForEntities=t.searchForUsers=t.searchForTracks=t.searchForShows=t.searchForSeasons=t.searchForPlaylists=t.searchForPersons=t.searchForMovies=t.searchForGenres=t.searchForEpisodes=t.searchForDiscs=t.searchForCues=t.searchForArtists=t.searchForAlbums=t.lookupUser=t.lookupUserBase=t.lookupTrack=t.lookupTrackBase=t.lookupSubtitle=t.lookupSubtitleBase=t.lookupShow=t.lookupShowBase=t.lookupSeason=t.lookupSeasonBase=t.lookupPlaylistItem=t.lookupPlaylistItemBase=t.lookupPlaylist=t.lookupPlaylistBase=t.lookupPerson=t.lookupPersonBase=t.lookupMovie=t.lookupMovieBase=t.lookupGenre=t.lookupGenreBase=t.lookupEpisode=t.lookupEpisodeBase=t.lookupDisc=t.lookupDiscBase=t.lookupCue=t.lookupCueBase=t.lookupArtist=t.lookupArtistBase=t.lookupAlbum=t.lookupAlbumBase=t.createUser=void 0;const r=s(6417),i=s(3601),a=s(8575),n=s(6321),o=s(298),l=s(1565),d=s(3302);function u(e,t){let s=n.albums.lookup(e);return{album_id:s.album_id,title:s.title,artwork:n.getFilesFromAlbum.lookup(e).map((e=>{try{return n.image_files.lookup(e.file_id)}catch(e){}})).filter(l.present)}}function c(e,t){let s=n.albums.lookup(e),r=u(e);return Object.assign(Object.assign({},r),{artists:n.getArtistsFromAlbum.lookup(e).sort(o.NumericSort.increasing((e=>e.order))).map((e=>f(e.artist_id))),year:s.year,discs:n.getDiscsFromAlbum.lookup(e).sort(o.NumericSort.increasing((e=>e.number))).map((e=>y(e.disc_id,t,r)))})}function f(e,t){let s=n.artists.lookup(e);return{artist_id:s.artist_id,title:s.name}}function g(e,t){let s=f(e);return Object.assign(Object.assign({},s),{albums:n.getAlbumsFromArtist.lookup(e).map((e=>n.albums.lookup(e.album_id))).sort(o.NumericSort.decreasing((e=>e.year))).map((e=>c(e.album_id,t)))})}function p(e,t,s){let r=n.cues.lookup(e);return{cue_id:r.cue_id,subtitle:l.present(s)?s:U(r.subtitle_id),start_ms:r.start_ms,duration_ms:r.duration_ms,lines:r.lines.split("\n")}}function h(e,t,s){let r=p(e,0,s);return Object.assign({},r)}function m(e,t,s){let r=n.discs.lookup(e);return{disc_id:r.disc_id,album:l.present(s)?s:u(r.album_id),number:r.number}}function y(e,t,s){let r=m(e,0,s);return Object.assign(Object.assign({},r),{tracks:n.getTracksFromDisc.lookup(e).sort(o.NumericSort.increasing((e=>e.number))).map((e=>F(e.track_id,t,r)))})}function b(e,t,s){let r=n.episodes.lookup(e);return{episode_id:r.episode_id,title:r.title,number:r.number,season:l.present(s)?s:A(r.season_id,t)}}function _(e,t,s){var r;let i=b(e,t,s),a=n.episodes.lookup(e),d=n.getFilesFromEpisode.lookup(e).map((e=>{try{return n.video_files.lookup(e.file_id)}catch(e){}})).filter(l.present).sort(o.NumericSort.decreasing((e=>e.height))).shift();if(l.absent(d))throw"Expected a valid video file!";let u=n.getSubtitleFilesFromVideoFile.lookup(d.file_id).map((e=>n.subtitle_files.lookup(e.subtitle_file_id))),c=n.getStreamsFromFile.lookup(d.file_id).filter((e=>e.user_id===t)).sort(o.NumericSort.increasing((e=>e.timestamp_ms)));return Object.assign(Object.assign({},i),{year:a.year,summary:a.summary,last_stream_date:null===(r=c.pop())||void 0===r?void 0:r.timestamp_ms,media:d,subtitles:u})}function S(e,t){let s=n.genres.lookup(e);return{genre_id:s.genre_id,title:s.name}}function v(e,t){let s=S(e);return Object.assign({},s)}function k(e,t){let s=n.movies.lookup(e);return{movie_id:s.movie_id,title:s.title,artwork:n.getFilesFromMovie.lookup(e).map((e=>{try{return n.image_files.lookup(e.file_id)}catch(e){}})).filter(l.present)}}function w(e,t){var s;let r=k(e),i=n.movies.lookup(e),a=n.getFilesFromMovie.lookup(e).map((e=>{try{return n.video_files.lookup(e.file_id)}catch(e){}})).filter(l.present).sort(o.NumericSort.decreasing((e=>e.height))).shift();if(l.absent(a))throw"Expected a valid video file!";let d=n.getSubtitleFilesFromVideoFile.lookup(a.file_id).map((e=>n.subtitle_files.lookup(e.subtitle_file_id))),u=n.getStreamsFromFile.lookup(a.file_id).filter((e=>e.user_id===t)).sort(o.NumericSort.increasing((e=>e.timestamp_ms)));return Object.assign(Object.assign({},r),{year:i.year,summary:i.summary,genres:n.getGenresFromMovie.lookup(e).sort(o.NumericSort.increasing((e=>e.order))).map((e=>S(e.genre_id))),actors:n.getPersonsFromMovie.lookup(e).sort(o.NumericSort.increasing((e=>e.order))).map((e=>O(e.person_id))),last_stream_date:null===(s=u.pop())||void 0===s?void 0:s.timestamp_ms,media:a,subtitles:d})}function I(e,t){let s=n.persons.lookup(e);return{person_id:s.person_id,name:s.name}}function O(e,t){let s=I(e);return Object.assign({},s)}function E(e,t,s){let r=n.playlists.lookup(e);return{playlist_id:r.playlist_id,title:r.title,description:r.description,user:l.present(s)?s:M(r.user_id)}}function x(e,t,s){let r=E(e,0,s);return Object.assign(Object.assign({},r),{items:n.getPlaylistsItemsFromPlaylist.lookup(e).sort(o.NumericSort.increasing((e=>e.number))).map((e=>R(e.playlist_item_id,t,r)))})}function T(e,t,s){let r=n.playlist_items.lookup(e);return{playlist_item_id:r.playlist_item_id,number:r.number,playlist:l.present(s)?s:E(r.playlist_id),track:F(r.track_id,t)}}function R(e,t,s){let r=T(e,t,s);return Object.assign({},r)}function A(e,t,s){let r=n.seasons.lookup(e);return{season_id:r.season_id,number:r.number,show:l.present(s)?s:j(r.show_id)}}function C(e,t,s){let r=A(e,0,s);return Object.assign(Object.assign({},r),{episodes:n.getEpisodesFromSeason.lookup(e).sort(o.NumericSort.increasing((e=>e.number))).map((e=>_(e.episode_id,t,r)))})}function j(e,t){let s=n.shows.lookup(e);return{show_id:s.show_id,title:s.name,artwork:n.getFilesFromShow.lookup(e).map((e=>{try{return n.image_files.lookup(e.file_id)}catch(e){}})).filter(l.present).slice(0,1)}}function P(e,t){let s=j(e),r=n.shows.lookup(e);return Object.assign(Object.assign({},s),{summary:r.summary,genres:n.getGenresFromShow.lookup(e).sort(o.NumericSort.increasing((e=>e.order))).map((e=>S(e.genre_id))),actors:n.getPersonsFromShow.lookup(e).sort(o.NumericSort.increasing((e=>e.order))).map((e=>I(e.person_id))),seasons:n.getSeasonsFromShow.lookup(e).sort(o.NumericSort.increasing((e=>e.number))).map((e=>C(e.season_id,t,s)))})}function U(e,t){let s=n.subtitles.lookup(e);return{subtitle_id:s.subtitle_id,subtitle:n.subtitle_files.lookup(s.file_id)}}function N(e,t,s){let r=n.tracks.lookup(e);return{track_id:r.track_id,title:r.title,disc:l.present(s)?s:m(r.disc_id),number:r.number}}function F(e,t,s){var r;let i=N(e,0,s),a=n.getFilesFromTrack.lookup(e).map((e=>{try{return n.audio_files.lookup(e.file_id)}catch(e){}})).filter(l.present).shift();if(l.absent(a))throw"Expected a valid audio file!";let d=n.getStreamsFromFile.lookup(a.file_id).filter((e=>e.user_id===t)).sort(o.NumericSort.increasing((e=>e.timestamp_ms)));return Object.assign(Object.assign({},i),{artists:n.getArtistsFromTrack.lookup(e).sort(o.NumericSort.increasing((e=>e.order))).map((e=>f(e.artist_id))),last_stream_date:null===(r=d.pop())||void 0===r?void 0:r.timestamp_ms,media:a})}function M(e){let t=n.users.lookup(e);return{user_id:t.user_id,name:t.name,username:t.username}}function L(e){let t=M(e);return Object.assign({},t)}t.createUser=function(e){let{username:t,password:s,name:o,key_id:d}=Object.assign({},e),u=new Array;n.getUsersFromUsername.lookup(t).length>0&&u.push("The requested username is not available.");try{let e=n.keys.lookup(d);l.present(e.user_id)&&u.push("The registration key has already been used.")}catch(e){u.push("The registration key is not valid.")}if(Buffer.from(t).length>=256&&u.push("The username is too long!"),Buffer.from(o).length>=256&&u.push("The name is too long!"),u.length>0)return{errors:u};let c=r.randomBytes(16).toString("hex");n.users.insert({user_id:c,username:t,name:o,password:a.generate(s)});let f=n.keys.lookup(d);return n.keys.update(Object.assign(Object.assign({},f),{user_id:c})),{token:i.createToken(t,s)}},t.lookupAlbumBase=u,t.lookupAlbum=c,t.lookupArtistBase=f,t.lookupArtist=g,t.lookupCueBase=p,t.lookupCue=h,t.lookupDiscBase=m,t.lookupDisc=y,t.lookupEpisodeBase=b,t.lookupEpisode=_,t.lookupGenreBase=S,t.lookupGenre=v,t.lookupMovieBase=k,t.lookupMovie=w,t.lookupPersonBase=I,t.lookupPerson=O,t.lookupPlaylistBase=E,t.lookupPlaylist=x,t.lookupPlaylistItemBase=T,t.lookupPlaylistItem=R,t.lookupSeasonBase=A,t.lookupSeason=C,t.lookupShowBase=j,t.lookupShow=P,t.lookupSubtitleBase=U,t.lookupSubtitle=function(e,t){let s=U(e);return Object.assign(Object.assign({},s),{cues:n.getCuesFromSubtitle.lookup(e).map((e=>h(e.cue_id))).sort(o.NumericSort.increasing((e=>e.start_ms)))})},t.lookupTrackBase=N,t.lookupTrack=F,t.lookupUserBase=M,t.lookupUser=L,t.searchForAlbums=function(e,t,s,r){return""===e?Array.from(n.albums).sort(o.LexicalSort.increasing((e=>e.title))).slice(t,t+s).map((e=>c(e.album_id,r))):n.album_search.lookup(e).map((e=>e.record)).slice(t,t+s).map((e=>c(e.album_id,r)))},t.searchForArtists=function(e,t,s,r){return""===e?Array.from(n.artists).map((e=>({artist:e,albums:n.getAlbumsFromArtist.lookup(e.artist_id)}))).sort(o.CombinedSort.of(o.CustomSort.increasing((e=>0===e.albums.length)),o.LexicalSort.increasing((e=>e.artist.name)))).map((e=>e.artist)).slice(t,t+s).map((e=>g(e.artist_id,r))):n.artist_search.lookup(e).map((e=>e.record)).slice(t,t+s).map((e=>g(e.artist_id,r)))},t.searchForCues=function(e,t,s,r){return n.cue_search.lookup(e).sort(o.NumericSort.decreasing((e=>e.rank))).slice(t,t+s).map((e=>h(e.record.cue_id))).map((e=>{let t=n.getVideoFilesFromSubtitleFile.lookup(e.subtitle.subtitle.file_id);for(let s of t){try{let t=n.getEpisodesFromFile.lookup(s.video_file_id);for(let s of t)return Object.assign(Object.assign({},e),{media:_(s.episode_id,r)})}catch(e){}try{let t=n.getMoviesFromFile.lookup(s.video_file_id);for(let s of t)return Object.assign(Object.assign({},e),{media:w(s.movie_id,r)})}catch(e){}}})).filter(l.present)},t.searchForDiscs=function(e,t,s,r){return Array.from(n.discs).sort(o.LexicalSort.increasing((e=>e.disc_id))).slice(t,t+s).map((e=>y(e.disc_id,r)))},t.searchForEpisodes=function(e,t,s,r){return""===e?Array.from(n.episodes).sort(o.LexicalSort.increasing((e=>e.title))).slice(t,t+s).map((e=>_(e.episode_id,r))):n.episode_search.lookup(e).map((e=>e.record)).slice(t,t+s).map((e=>_(e.episode_id,r)))},t.searchForGenres=function(e,t,s,r){return""===e?Array.from(n.genres).sort(o.LexicalSort.increasing((e=>e.name))).map((e=>v(e.genre_id))):n.genre_search.lookup(e).map((e=>e.record)).slice(t,t+s).map((e=>v(e.genre_id)))},t.searchForMovies=function(e,t,s,r){return""===e?Array.from(n.movies).sort(o.LexicalSort.increasing((e=>e.title))).slice(t,t+s).map((e=>w(e.movie_id,r))):n.movie_search.lookup(e).map((e=>e.record)).slice(t,t+s).map((e=>w(e.movie_id,r)))},t.searchForPersons=function(e,t,s,r){return""===e?Array.from(n.persons).sort(o.LexicalSort.increasing((e=>e.name))).slice(t,t+s).map((e=>O(e.person_id))):n.person_search.lookup(e).map((e=>e.record)).slice(t,t+s).map((e=>O(e.person_id)))},t.searchForPlaylists=function(e,t,s,r){return""===e?Array.from(n.playlists).sort(o.LexicalSort.increasing((e=>e.title))).slice(t,t+s).map((e=>x(e.playlist_id,r))):n.playlist_search.lookup(e).map((e=>e.record)).slice(t,t+s).map((e=>x(e.playlist_id,r)))},t.searchForSeasons=function(e,t,s,r){return Array.from(n.seasons).sort(o.LexicalSort.increasing((e=>e.season_id))).slice(t,t+s).map((e=>C(e.season_id,r)))},t.searchForShows=function(e,t,s,r){return""===e?Array.from(n.shows).sort(o.LexicalSort.increasing((e=>e.name))).slice(t,t+s).map((e=>P(e.show_id,r))):n.shows_search.lookup(e).map((e=>e.record)).slice(t,t+s).map((e=>P(e.show_id,r)))},t.searchForTracks=function(e,t,s,r){return""===e?Array.from(n.tracks).sort(o.LexicalSort.increasing((e=>e.title))).slice(t,t+s).map((e=>F(e.track_id,r))):n.track_search.lookup(e).map((e=>e.record)).slice(t,t+s).map((e=>F(e.track_id,r)))},t.searchForUsers=function(e,t,s,r){return""===e?Array.from(n.users).sort(o.LexicalSort.increasing((e=>e.name))).slice(t,t+s).map((e=>L(e.user_id))):n.user_search.lookup(e).map((e=>e.record)).slice(t,t+s).map((e=>L(e.user_id)))},t.searchForEntities=function(e,t,s,r){return[...n.album_search.lookup(e).map((e=>Object.assign(Object.assign({},e),{type_rank:9}))),...n.artist_search.lookup(e).map((e=>Object.assign(Object.assign({},e),{type_rank:6}))),...n.episode_search.lookup(e).map((e=>Object.assign(Object.assign({},e),{type_rank:4}))),...n.genre_search.lookup(e).map((e=>Object.assign(Object.assign({},e),{type_rank:2}))),...n.movie_search.lookup(e).map((e=>Object.assign(Object.assign({},e),{type_rank:8}))),...n.person_search.lookup(e).map((e=>Object.assign(Object.assign({},e),{type_rank:1}))),...n.playlist_search.lookup(e).map((e=>Object.assign(Object.assign({},e),{type_rank:3}))),...n.shows_search.lookup(e).map((e=>Object.assign(Object.assign({},e),{type_rank:7}))),...n.track_search.lookup(e).map((e=>Object.assign(Object.assign({},e),{type_rank:5}))),...n.user_search.lookup(e).map((e=>Object.assign(Object.assign({},e),{type_rank:0})))].sort(o.CombinedSort.of(o.NumericSort.decreasing((e=>e.rank)),o.NumericSort.decreasing((e=>e.type_rank)))).slice(s,s+r).map((e=>{let s=e.record;if(d.Album.is(s))return c(s.album_id,t);if(d.Artist.is(s))return g(s.artist_id,t);if(d.Episode.is(s))return _(s.episode_id,t);if(d.Genre.is(s))return v(s.genre_id);if(d.Movie.is(s))return w(s.movie_id,t);if(d.Person.is(s))return O(s.person_id);if(d.Playlist.is(s))return x(s.playlist_id,t);if(d.Show.is(s))return P(s.show_id,t);if(d.Track.is(s))return F(s.track_id,t);if(d.User.is(s))return L(s.user_id);throw"Expected code to be unreachable!"}))},t.getArtistAppearances=function(e,t){let s=n.getTracksFromArtist.lookup(e).map((e=>n.tracks.lookup(e.track_id))).map((e=>e.disc_id));s=Array.from(new Set(s));let r=s.map((e=>n.discs.lookup(e))).map((e=>e.album_id));r=Array.from(new Set(r));let i=new Array;for(let t of r)null==n.getArtistsFromAlbum.lookup(t).find((t=>t.artist_id===e))&&i.push(t);return i.map((e=>n.albums.lookup(e))).sort(o.LexicalSort.increasing((e=>e.title))).map((e=>c(e.album_id,t)))},t.getArtistTracks=function(e,t,s,r){let i=new Map;for(let t of n.getTracksFromArtist.lookup(e))for(let e of n.getFilesFromTrack.lookup(t.track_id)){let s=n.getStreamsFromFile.lookup(e.file_id);i.set(t.track_id,s.length)}return Array.from(i.entries()).sort(o.NumericSort.decreasing((e=>e[1]))).slice(t,t+s).map((e=>e[0])).map((e=>F(e,r)))},t.getPlaylistAppearances=function(e,t,s,r){let i=new Set;for(let t of n.getPlaylistItemsFromTrack.lookup(e))i.add(t.playlist_id);return Array.from(i).map((e=>n.playlists.lookup(e))).sort(o.LexicalSort.increasing((e=>e.title))).slice(t,t+s).map((e=>x(e.playlist_id,r)))},t.getMovieSuggestions=function(e,t,s,r){var i;let a=n.getGenresFromMovie.lookup(e),l=new Map;for(let e of a){let t=n.getMoviesFromGenre.lookup(e.genre_id);for(let e of t){let t=null!==(i=l.get(e.movie_id))&&void 0!==i?i:0;l.set(e.movie_id,t+2)}}for(let e of l){let t=n.getGenresFromMovie.lookup(e[0]);l.set(e[0],e[1]-t.length)}return l.delete(e),Array.from(l.entries()).sort(o.NumericSort.decreasing((e=>e[1]))).slice(t,t+s).map((e=>e[0])).map((e=>w(e,r)))},t.getMoviesFromGenre=function(e,t,s,r){return n.getMoviesFromGenre.lookup(e).map((e=>n.movies.lookup(e.movie_id))).sort(o.LexicalSort.increasing((e=>e.title))).slice(s,s+r).map((e=>w(e.movie_id,t)))},t.getMoviesFromPerson=function(e,t,s,r){return n.getMoviesFromPerson.lookup(e).map((e=>n.movies.lookup(e.movie_id))).sort(o.LexicalSort.increasing((e=>e.title))).slice(s,s+r).map((e=>w(e.movie_id,t)))},t.getShowsFromGenre=function(e,t,s,r){return n.getShowsFromGenre.lookup(e).map((e=>n.shows.lookup(e.show_id))).sort(o.LexicalSort.increasing((e=>e.name))).slice(s,s+r).map((e=>P(e.show_id,t)))},t.getShowsFromPerson=function(e,t,s,r){return n.getShowsFromPerson.lookup(e).map((e=>n.shows.lookup(e.show_id))).sort(o.LexicalSort.increasing((e=>e.name))).slice(s,s+r).map((e=>P(e.show_id,t)))},t.getUserPlaylists=function(e,t){return n.getPlaylistsFromUser.lookup(e).sort(o.LexicalSort.increasing((e=>e.title))).map((e=>x(e.playlist_id,t)))}},3834:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.schema=t.handler=void 0,t.handler=s(3579),t.schema=s(2640)},2640:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.objects=t.messages=void 0,t.messages=s(2156),t.objects=s(5447)},2156:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Autoguard=t.RegisterResponse=t.RegisterRequest=t.ErrorMessage=void 0;const r=s(9175);t.ErrorMessage=r.guards.Object.of({errors:r.guards.Array.of(r.guards.String)}),t.RegisterRequest=r.guards.Object.of({username:r.guards.String,password:r.guards.String,name:r.guards.String,key_id:r.guards.String}),t.RegisterResponse=r.guards.Object.of({token:r.guards.String}),t.Autoguard={ErrorMessage:t.ErrorMessage,RegisterRequest:t.RegisterRequest,RegisterResponse:t.RegisterResponse}},5447:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Autoguard=t.Entity=t.EntityBase=t.Cue=t.CueBase=t.Subtitle=t.SubtitleBase=t.Episode=t.EpisodeBase=t.Season=t.SeasonBase=t.Show=t.ShowBase=t.Movie=t.MovieBase=t.Genre=t.GenreBase=t.PlaylistItem=t.PlaylistItemBase=t.Playlist=t.PlaylistBase=t.User=t.UserBase=t.Track=t.TrackBase=t.Disc=t.DiscBase=t.Album=t.AlbumBase=t.Artist=t.ArtistBase=t.Person=t.PersonBase=void 0;const r=s(3302),i=s(3302),a=s(3302),n=s(3302),o=s(9175);t.PersonBase=o.guards.Object.of({person_id:o.guards.String,name:o.guards.String}),t.Person=o.guards.Intersection.of(o.guards.Reference.of((()=>t.PersonBase)),o.guards.Object.of({})),t.ArtistBase=o.guards.Object.of({artist_id:o.guards.String,title:o.guards.String}),t.Artist=o.guards.Intersection.of(o.guards.Reference.of((()=>t.ArtistBase)),o.guards.Object.of({albums:o.guards.Array.of(o.guards.Reference.of((()=>t.Album)))})),t.AlbumBase=o.guards.Object.of({album_id:o.guards.String,title:o.guards.String,artwork:o.guards.Array.of(o.guards.Reference.of((()=>i.ImageFile)))}),t.Album=o.guards.Intersection.of(o.guards.Reference.of((()=>t.AlbumBase)),o.guards.Object.of({artists:o.guards.Array.of(o.guards.Reference.of((()=>t.ArtistBase))),discs:o.guards.Array.of(o.guards.Reference.of((()=>t.Disc))),year:o.guards.Union.of(o.guards.Undefined,o.guards.Number)})),t.DiscBase=o.guards.Object.of({disc_id:o.guards.String,album:o.guards.Reference.of((()=>t.AlbumBase)),number:o.guards.Number}),t.Disc=o.guards.Intersection.of(o.guards.Reference.of((()=>t.DiscBase)),o.guards.Object.of({tracks:o.guards.Array.of(o.guards.Reference.of((()=>t.Track)))})),t.TrackBase=o.guards.Object.of({track_id:o.guards.String,title:o.guards.String,disc:o.guards.Reference.of((()=>t.DiscBase)),number:o.guards.Number}),t.Track=o.guards.Intersection.of(o.guards.Reference.of((()=>t.TrackBase)),o.guards.Object.of({artists:o.guards.Array.of(o.guards.Reference.of((()=>t.ArtistBase))),last_stream_date:o.guards.Union.of(o.guards.Undefined,o.guards.Number),media:o.guards.Reference.of((()=>r.AudioFile))})),t.UserBase=o.guards.Object.of({user_id:o.guards.String,name:o.guards.String,username:o.guards.String}),t.User=o.guards.Intersection.of(o.guards.Reference.of((()=>t.UserBase)),o.guards.Object.of({})),t.PlaylistBase=o.guards.Object.of({playlist_id:o.guards.String,title:o.guards.String,description:o.guards.String,user:o.guards.Reference.of((()=>t.UserBase))}),t.Playlist=o.guards.Intersection.of(o.guards.Reference.of((()=>t.PlaylistBase)),o.guards.Object.of({items:o.guards.Array.of(o.guards.Reference.of((()=>t.PlaylistItem)))})),t.PlaylistItemBase=o.guards.Object.of({playlist_item_id:o.guards.String,number:o.guards.Number,playlist:o.guards.Reference.of((()=>t.PlaylistBase)),track:o.guards.Reference.of((()=>t.Track))}),t.PlaylistItem=o.guards.Intersection.of(o.guards.Reference.of((()=>t.PlaylistItemBase)),o.guards.Object.of({})),t.GenreBase=o.guards.Object.of({genre_id:o.guards.String,title:o.guards.String}),t.Genre=o.guards.Intersection.of(o.guards.Reference.of((()=>t.GenreBase)),o.guards.Object.of({})),t.MovieBase=o.guards.Object.of({movie_id:o.guards.String,title:o.guards.String,artwork:o.guards.Array.of(o.guards.Reference.of((()=>i.ImageFile)))}),t.Movie=o.guards.Intersection.of(o.guards.Reference.of((()=>t.MovieBase)),o.guards.Object.of({year:o.guards.Union.of(o.guards.Undefined,o.guards.Number),summary:o.guards.Union.of(o.guards.Undefined,o.guards.String),genres:o.guards.Array.of(o.guards.Reference.of((()=>t.Genre))),actors:o.guards.Array.of(o.guards.Reference.of((()=>t.Person))),last_stream_date:o.guards.Union.of(o.guards.Undefined,o.guards.Number),media:o.guards.Reference.of((()=>n.VideoFile)),subtitles:o.guards.Array.of(o.guards.Reference.of((()=>a.SubtitleFile)))})),t.ShowBase=o.guards.Object.of({show_id:o.guards.String,title:o.guards.String,artwork:o.guards.Array.of(o.guards.Reference.of((()=>i.ImageFile)))}),t.Show=o.guards.Intersection.of(o.guards.Reference.of((()=>t.ShowBase)),o.guards.Object.of({summary:o.guards.Union.of(o.guards.Undefined,o.guards.String),genres:o.guards.Array.of(o.guards.Reference.of((()=>t.Genre))),actors:o.guards.Array.of(o.guards.Reference.of((()=>t.Person))),seasons:o.guards.Array.of(o.guards.Reference.of((()=>t.Season)))})),t.SeasonBase=o.guards.Object.of({season_id:o.guards.String,number:o.guards.Number,show:o.guards.Reference.of((()=>t.ShowBase))}),t.Season=o.guards.Intersection.of(o.guards.Reference.of((()=>t.SeasonBase)),o.guards.Object.of({episodes:o.guards.Array.of(o.guards.Reference.of((()=>t.Episode)))})),t.EpisodeBase=o.guards.Object.of({episode_id:o.guards.String,title:o.guards.String,number:o.guards.Number,season:o.guards.Reference.of((()=>t.SeasonBase))}),t.Episode=o.guards.Intersection.of(o.guards.Reference.of((()=>t.EpisodeBase)),o.guards.Object.of({year:o.guards.Union.of(o.guards.Undefined,o.guards.Number),summary:o.guards.Union.of(o.guards.Undefined,o.guards.String),last_stream_date:o.guards.Union.of(o.guards.Undefined,o.guards.Number),media:o.guards.Reference.of((()=>n.VideoFile)),subtitles:o.guards.Array.of(o.guards.Reference.of((()=>a.SubtitleFile)))})),t.SubtitleBase=o.guards.Object.of({subtitle_id:o.guards.String,subtitle:o.guards.Reference.of((()=>a.SubtitleFile))}),t.Subtitle=o.guards.Intersection.of(o.guards.Reference.of((()=>t.SubtitleBase)),o.guards.Object.of({cues:o.guards.Array.of(o.guards.Reference.of((()=>t.Cue)))})),t.CueBase=o.guards.Object.of({cue_id:o.guards.String,subtitle:o.guards.Reference.of((()=>t.SubtitleBase)),start_ms:o.guards.Number,duration_ms:o.guards.Number,lines:o.guards.Array.of(o.guards.String)}),t.Cue=o.guards.Intersection.of(o.guards.Reference.of((()=>t.CueBase)),o.guards.Object.of({})),t.EntityBase=o.guards.Union.of(o.guards.Reference.of((()=>t.AlbumBase)),o.guards.Reference.of((()=>t.ArtistBase)),o.guards.Reference.of((()=>t.DiscBase)),o.guards.Reference.of((()=>t.EpisodeBase)),o.guards.Reference.of((()=>t.GenreBase)),o.guards.Reference.of((()=>t.MovieBase)),o.guards.Reference.of((()=>t.PersonBase)),o.guards.Reference.of((()=>t.PlaylistBase)),o.guards.Reference.of((()=>t.SeasonBase)),o.guards.Reference.of((()=>t.ShowBase)),o.guards.Reference.of((()=>t.TrackBase)),o.guards.Reference.of((()=>t.UserBase))),t.Entity=o.guards.Union.of(o.guards.Reference.of((()=>t.Album)),o.guards.Reference.of((()=>t.Artist)),o.guards.Reference.of((()=>t.Disc)),o.guards.Reference.of((()=>t.Episode)),o.guards.Reference.of((()=>t.Genre)),o.guards.Reference.of((()=>t.Movie)),o.guards.Reference.of((()=>t.Person)),o.guards.Reference.of((()=>t.Playlist)),o.guards.Reference.of((()=>t.Season)),o.guards.Reference.of((()=>t.Show)),o.guards.Reference.of((()=>t.Track)),o.guards.Reference.of((()=>t.User))),t.Autoguard={PersonBase:t.PersonBase,Person:t.Person,ArtistBase:t.ArtistBase,Artist:t.Artist,AlbumBase:t.AlbumBase,Album:t.Album,DiscBase:t.DiscBase,Disc:t.Disc,TrackBase:t.TrackBase,Track:t.Track,UserBase:t.UserBase,User:t.User,PlaylistBase:t.PlaylistBase,Playlist:t.Playlist,PlaylistItemBase:t.PlaylistItemBase,PlaylistItem:t.PlaylistItem,GenreBase:t.GenreBase,Genre:t.Genre,MovieBase:t.MovieBase,Movie:t.Movie,ShowBase:t.ShowBase,Show:t.Show,SeasonBase:t.SeasonBase,Season:t.Season,EpisodeBase:t.EpisodeBase,Episode:t.Episode,SubtitleBase:t.SubtitleBase,Subtitle:t.Subtitle,CueBase:t.CueBase,Cue:t.Cue,EntityBase:t.EntityBase,Entity:t.Entity}},5357:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.serializeCastMessage=t.parseCastMessage=t.PayloadType=t.ProtocolVersion=void 0;const r=s(3629);var i,a;(a=t.ProtocolVersion||(t.ProtocolVersion={}))[a.CASTV2_1_0=0]="CASTV2_1_0",(i=t.PayloadType||(t.PayloadType={}))[i.STRING=0]="STRING",i[i.BINARY=1]="BINARY",t.parseCastMessage=function(e){let t=r.parseFields({buffer:e,offset:0});return{protocol_version:r.parseRequiredEnum(1,t),source_id:r.parseRequiredString(2,t),destination_id:r.parseRequiredString(3,t),namespace:r.parseRequiredString(4,t),payload_type:r.parseRequiredEnum(5,t),payload_utf8:r.parseOptionalString(6,t),payload_binary:r.parseOptionalBuffer(7,t)}},t.serializeCastMessage=function(e){return Buffer.concat([r.serializeRequiredEnum(1,e.protocol_version),r.serializeRequiredString(2,e.source_id),r.serializeRequiredString(3,e.destination_id),r.serializeRequiredString(4,e.namespace),r.serializeRequiredEnum(5,e.payload_type),r.serializeOptionalString(6,e.payload_utf8),r.serializeOptionalBuffer(7,e.payload_binary)])}},7471:function(e,t,s){var r=this&&this.__awaiter||function(e,t,s,r){return new(s||(s=Promise))((function(i,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.observe=t.discover=void 0;const i=s(4016),a=s(5357),n=s(1687),o=s(3597),l=s(1565),d=s(6618),u=s(6440),c=s(4676),f=s(9175),g=s(4545),p=s(7978),h=s(5447),m="https://ap.joelek.se";function y(e){var t;let s=null!==(t=d.db[null!=e?e:"eng"])&&void 0!==t?t:d.db.eng;return{language:[s.iso639_1,s.iso3166_1].join("-"),name:s.title}}const b=new Set,_=new Set;n.observe("_googlecast._tcp.local",(e=>{let{hostname:t,service_info:s}=Object.assign({},e);if(!b.has(t)){b.add(t);for(let e of _)try{e(t,s)}catch(e){}}})),t.discover=function(){n.sendDiscoveryPacket("_googlecast._tcp.local")},t.observe=function(e){!function(e){if(!_.has(e)){_.add(e);for(let t of b)try{e(t)}catch(e){}}}(((t,s)=>r(this,void 0,void 0,(function*(){let r=yield function(e){return new Promise(((t,s)=>{let r=i.connect({host:e,port:8009,rejectUnauthorized:!1});r.on("secureConnect",(()=>{console.log(`Connected to Cast device at ${e}.`),t(r)})),r.on("close",(()=>{console.log(`Disconnected from Cast device at ${e}.`)})),r.on("error",(e=>{r.destroy()}))}))}(t);r.on("close",(()=>{b.delete(t)}));let a=function(e){for(let t of e){let e=t.split("=");if(e.length>=2&&"fn"===e[0])return e.slice(1).join("=")}return"Chromecast"}(null!=s?s:[]),n=function(e){for(let t of e){let e=t.split("=");if(e.length>=2&&"md"===e[0])return e.slice(1).join("=")}return"Generic Cast Device"}(null!=s?s:[]);new E(r,e,a,n)}))))};class S{constructor(e,t){this.socket=e,function(e,t){let s=Buffer.alloc(0),r=!0,i=4;e.on("data",(e=>{for(s=Buffer.concat([s,e]);s.length>=i;){let e=s.slice(0,i);s=s.slice(i),r?(r=!1,i=e.readUInt32BE(0)):(r=!0,i=4,t(e))}}))}(e,(e=>{try{let s=a.parseCastMessage(e);t(s)}catch(e){console.log(e)}}))}getRequestId(){return Math.floor(65536*Math.random())}send(e){var t,s,r,i;let n=a.serializeCastMessage({protocol_version:null!==(t=e.protocol_version)&&void 0!==t?t:a.ProtocolVersion.CASTV2_1_0,source_id:null!==(s=e.source_id)&&void 0!==s?s:"sender-0",destination_id:null!==(r=e.destination_id)&&void 0!==r?r:"receiver-0",namespace:e.namespace,payload_type:null!==(i=e.payload_type)&&void 0!==i?i:a.PayloadType.STRING,payload_utf8:e.payload_utf8,payload_binary:e.payload_binary}),o=Buffer.alloc(4);o.writeUInt32BE(n.length,0),this.socket.write(o),this.socket.write(n)}}class v{constructor(e){this.messageHandler=e,this.serializer=new f.serialization.MessageSerializer(o.connection.Autoguard),this.listeners=new p.routing.MessageRouter}handle(e){var t;let s=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),r=f.guards.String.as(s.type);this.serializer.deserialize(JSON.stringify({type:r,data:s}),((e,t)=>{this.listeners.route(e,t)}))}send(e,t,s){this.messageHandler.send({namespace:v.NAMESPACE,destination_id:s,payload_utf8:JSON.stringify(t)})}}v.NAMESPACE="urn:x-cast:com.google.cast.tp.connection";class k{constructor(e){this.messageHandler=e,this.serializer=new f.serialization.MessageSerializer(o.heartbeat.Autoguard),this.listeners=new p.routing.MessageRouter}handle(e){var t;let s=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),r=f.guards.String.as(s.type);this.serializer.deserialize(JSON.stringify({type:r,data:s}),((e,t)=>{this.listeners.route(e,t)}))}send(e,t){this.messageHandler.send({namespace:k.NAMESPACE,payload_utf8:JSON.stringify(t)})}}k.NAMESPACE="urn:x-cast:com.google.cast.tp.heartbeat";class w{constructor(e){this.transportId=new u.ObservableClass(void 0),this.mediaSessionId=new u.ObservableClass(void 0),this.messageHandler=e,this.serializer=new f.serialization.MessageSerializer(o.media.Autoguard),this.callbacks=new Map,this.listeners=new p.routing.MessageRouter}handle(e){var t;let s=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),r=f.guards.String.as(s.type);try{this.serializer.deserialize(JSON.stringify({type:r,data:s}),((e,t)=>{let s=this.callbacks.get(t.requestId);l.present(s)&&(this.callbacks.delete(t.requestId),s(t)),this.listeners.route(e,t)}))}catch(e){console.log(JSON.stringify(s,null,2))}}send(e,t,s){t.requestId=this.messageHandler.getRequestId(),l.present(s)&&this.callbacks.set(t.requestId,s),this.messageHandler.send({namespace:w.NAMESPACE,destination_id:this.transportId.getState(),payload_utf8:JSON.stringify(t)})}}w.NAMESPACE="urn:x-cast:com.google.cast.media";class I{constructor(e){this.messageHandler=e,this.serializer=new f.serialization.MessageSerializer(o.receiver.Autoguard),this.callbacks=new Map,this.listeners=new p.routing.MessageRouter}handle(e){var t;let s=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),r=f.guards.String.as(s.type);this.serializer.deserialize(JSON.stringify({type:r,data:s}),((e,t)=>{let s=this.callbacks.get(t.requestId);l.present(s)&&(this.callbacks.delete(t.requestId),s(t)),this.listeners.route(e,t)}))}send(e,t,s){t.requestId=this.messageHandler.getRequestId(),l.present(s)&&this.callbacks.set(t.requestId,s),this.messageHandler.send({namespace:I.NAMESPACE,payload_utf8:JSON.stringify(t)})}}I.NAMESPACE="urn:x-cast:com.google.cast.receiver";const O="CC1AD845";class E{constructor(e,t,s,r){let i=new S(e,(e=>{let t=e.namespace;t===v.NAMESPACE?this.connectionHandler.handle(e):t===k.NAMESPACE?this.heartbeatHandler.handle(e):t===w.NAMESPACE?this.mediaHandler.handle(e):t===I.NAMESPACE&&this.receiverHandler.handle(e)}));this.socket=e,this.heartbeatHandler=new k(i),this.connectionHandler=new v(i),this.mediaHandler=new w(i),this.receiverHandler=new I(i);let a=`${t?"wss:":"ws:"}//127.0.0.1/sockets/context/?protocol=cast&name=${encodeURIComponent(s)}&type=${encodeURIComponent(r)}`;this.context=new c.ContextClient(a,(e=>new g.WebSocketClient(e))),this.timer=void 0,e.on("close",(()=>{l.present(this.timer)&&clearTimeout(this.timer),this.context.close()})),this.connectionHandler.send("CONNECT",{type:"CONNECT"}),this.connectionHandler.listeners.addObserver("CLOSE",(e=>{this.mediaHandler.transportId.updateState(void 0)})),this.heartbeatHandler.listeners.addObserver("PING",(e=>{this.heartbeatHandler.send("PONG",{type:"PONG"})})),this.heartbeatHandler.listeners.addObserver("PONG",(e=>{this.setTimer()})),this.receiverHandler.listeners.addObserver("RECEIVER_STATUS",(e=>{var t;let s=(null!==(t=e.status.applications)&&void 0!==t?t:[]).find((e=>e.appId===O));l.present(s)?this.mediaHandler.transportId.updateState(s.transportId):this.mediaHandler.transportId.updateState(void 0)})),this.mediaHandler.listeners.addObserver("MEDIA_STATUS",(e=>{let t=e.status[e.status.length-1];if(l.present(t)){let e=this.mediaHandler.mediaSessionId.getState();l.present(e)&&(t.mediaSessionId===e?this.context.isDeviceLocal.getState()&&"IDLE"===t.playerState&&"FINISHED"===t.idleReason&&this.context.next():this.mediaHandler.mediaSessionId.updateState(void 0))}})),this.setTimer(),this.mediaHandler.transportId.addObserver((e=>{l.present(e)&&this.connectionHandler.send("CONNECT",{type:"CONNECT"},e)})),this.context.isDeviceLocal.addObserver((e=>{if(e){let e=this.mediaHandler.transportId.getState();l.absent(e)&&this.receiverHandler.send("LAUNCH",{type:"LAUNCH",requestId:-1,appId:O})}else{let e=this.mediaHandler.mediaSessionId.getState();l.present(e)&&this.mediaHandler.send("STOP",{type:"STOP",requestId:-1,mediaSessionId:e})}}));{let e=()=>{let e=this.mediaHandler.transportId.getState(),t=this.context.currentLocalEntry.getState(),s=this.context.token.getState();if(l.present(e)&&l.present(t)&&l.present(s)){let e,r=function(e,t){if(h.Episode.is(e)){let s=e,r=s.season.show;return{contentId:`${m}/files/${e.media.file_id}/?token=${t}`,contentType:s.media.mime,streamType:"BUFFERED",metadata:{metadataType:0,title:s.title,subtitle:r.title},tracks:s.subtitles.map(((e,s)=>Object.assign(Object.assign({},y(e.language)),{trackId:s,type:"TEXT",trackType:"TEXT",trackContentId:`${m}/files/${e.file_id}/?token=${t}`,trackContentType:e.mime,subtype:"SUBTITLES"})))}}if(h.Movie.is(e)){let s=e;return{contentId:`${m}/files/${e.media.file_id}/?token=${t}`,contentType:s.media.mime,streamType:"BUFFERED",metadata:{metadataType:0,title:s.title,images:s.artwork.map((e=>({url:`${m}/files/${e.file_id}/?token=${t}`})))},tracks:s.subtitles.map(((e,s)=>Object.assign(Object.assign({},y(e.language)),{trackId:s,type:"TEXT",trackType:"TEXT",trackContentId:`${m}/files/${e.file_id}/?token=${t}`,trackContentType:e.mime,subtype:"SUBTITLES"})))}}if(h.Track.is(e)){let s=e,r=s.disc.album;return{contentId:`${m}/files/${e.media.file_id}/?token=${t}`,contentType:e.media.mime,streamType:"BUFFERED",metadata:{metadataType:0,title:s.title,subtitle:s.artists.map((e=>e.title)).join("  "),images:r.artwork.map((e=>({url:`${m}/files/${e.file_id}/?token=${t}`})))}}}throw"Expected code to be unreachable!"}(t,s);if(l.present(r.tracks)){let t=r.tracks.find((e=>"sv-SE"===e.language));if(l.present(t))e=[t.trackId];else{let t=r.tracks.find((e=>"en-US"===e.language));if(l.present(t))e=[t.trackId];else{let t=r.tracks.find((e=>"ja-JP"===e.language));l.present(t)?e=[t.trackId]:r.tracks.length>0&&(e=[0])}}}this.mediaHandler.send("LOAD",{type:"LOAD",requestId:-1,media:r,autoplay:!1,activeTrackIds:e},(e=>{if(o.media.MEDIA_STATUS.is(e)){let t=e.status[e.status.length-1];l.present(t)&&this.mediaHandler.mediaSessionId.updateState(t.mediaSessionId)}}))}};this.mediaHandler.transportId.addObserver(e),this.context.currentLocalEntry.addObserver(e),this.context.token.addObserver(e)}this.mediaHandler.transportId.addObserver((e=>{l.absent(e)&&this.context.isDeviceLocal.getState()&&this.context.transfer(void 0)})),this.mediaHandler.transportId.addObserver((e=>{l.absent(e)&&this.mediaHandler.mediaSessionId.updateState(void 0)}));{let e=()=>{let e=this.mediaHandler.mediaSessionId.getState();l.present(e)&&(this.context.playback.getState()?this.mediaHandler.send("PLAY",{type:"PLAY",requestId:-1,mediaSessionId:e}):this.mediaHandler.send("PAUSE",{type:"PAUSE",requestId:-1,mediaSessionId:e}))};this.mediaHandler.mediaSessionId.addObserver(e),this.context.playback.addObserver(e)}{let e=()=>{var e;let t=this.mediaHandler.mediaSessionId.getState();if(l.present(t)){let s=null!==(e=this.context.progress.getState())&&void 0!==e?e:0;this.mediaHandler.send("SEEK",{type:"SEEK",requestId:-1,mediaSessionId:t,currentTime:s})}};this.mediaHandler.mediaSessionId.addObserver(e),this.context.progress.addObserver(e)}}setTimer(){l.present(this.timer)&&(clearTimeout(this.timer),this.timer=void 0),this.timer=setTimeout((()=>{this.timer=void 0,this.heartbeatHandler.send("PING",{type:"PING"}),this.timer=setTimeout((()=>{this.socket.destroy()}),5e3)}),5e3)}}},3629:(e,t)=>{function s(e){if(e>Number.MAX_SAFE_INTEGER||e<Number.MIN_SAFE_INTEGER)throw`Expected a safe integer but got ${e}!`;return Number(e)}function r(e,t){let s=e.buffer.length-e.offset;if(t>s)throw`Expected to read at most ${s} bytes but attempted to read ${t} bytes!`;let r=e.buffer.slice(e.offset,e.offset+t);return e.offset+=t,r}var i;function a(e){let t=Buffer.alloc(10);for(let s=0;s<10;s++){let r=e.buffer.readUInt8(e.offset);if(e.offset+=1,t[s]=r,0==(128&r)){if(s+1===10&&0!=(126&r))throw"Expected a varint of at most 64 bits!";let e=BigInt(0);for(let r=s;r>=0;r--)e=e<<BigInt(7)|BigInt(127&t[r]);let i=Buffer.alloc(8);return i.writeBigUInt64LE(e,0),i}}throw"Expected a varint of at most 10 bytes!"}function n(e){let t=e.readBigUInt64LE(0),r=Buffer.alloc(10);for(let e=0;e<10;e++){let i=t&BigInt(127);if(t>>=BigInt(7),!(t>0))return r.writeUInt8(0|s(i),e),r.slice(0,e+1);r.writeUInt8(128|s(i),e)}throw"Expected to serialize at most 10 bytes!"}function o(e){let t=Buffer.alloc(8);return t.writeBigUInt64LE(BigInt(e)),t}function l(e){let t=a(e).readBigUInt64LE(0);return{field_number:s(t>>BigInt(3)),wire_type:s(t&BigInt(7))}}function d(e){let t=BigInt(e.field_number)<<BigInt(3)|BigInt(e.wire_type)&BigInt(7),s=Buffer.alloc(8);return s.writeBigUInt64LE(t,0),n(s)}function u(e){let t=l(e);if(t.wire_type===i.VARINT)return{key:t,data:a(e)};if(t.wire_type===i.FIXED_64_BIT)return{key:t,data:r(e,8)};if(t.wire_type===i.LENGTH_DELIMITED)return{key:t,data:r(e,s(a(e).readBigUInt64LE(0)))};if(t.wire_type===i.START_GROUP)return{key:t,data:Buffer.alloc(0)};if(t.wire_type===i.END_GROUP)return{key:t,data:Buffer.alloc(0)};if(t.wire_type===i.FIXED_32_BIT)return{key:t,data:r(e,4)};throw"Expected a recognized wire type!"}function c(e){if(e.key.wire_type===i.VARINT)return Buffer.concat([d(e.key),n(e.data)]);if(e.key.wire_type===i.FIXED_64_BIT){if(8!==e.data.length)throw"Expected to serialize exactly 8 bytes!";return Buffer.concat([d(e.key),e.data])}if(e.key.wire_type===i.LENGTH_DELIMITED){let t=Buffer.alloc(8);return t.writeBigUInt64LE(BigInt(e.data.length)),Buffer.concat([d(e.key),n(t),e.data])}if(e.key.wire_type===i.START_GROUP){if(0!==e.data.length)throw"Expected to serialize exactly 0 bytes!";return Buffer.concat([d(e.key),e.data])}if(e.key.wire_type===i.END_GROUP){if(0!==e.data.length)throw"Expected to serialize exactly 0 bytes!";return Buffer.concat([d(e.key),e.data])}if(e.key.wire_type===i.FIXED_32_BIT){if(4!==e.data.length)throw"Expected to serialize exactly 4 bytes!";return Buffer.concat([d(e.key),e.data])}throw"Expected a recognized wire type!"}function f(e,t){let s=t.filter((t=>t.key.field_number===e));if(0===s.length)throw"Expected required field to be present!";return s[s.length-1].data.toString()}function g(e,t){return c({key:{field_number:e,wire_type:i.LENGTH_DELIMITED},data:Buffer.from(t)})}function p(e,t){let s=t.filter((t=>t.key.field_number===e));if(0===s.length)throw"Expected required field to be present!";return s[s.length-1].data}function h(e,t){return c({key:{field_number:e,wire_type:i.LENGTH_DELIMITED},data:t})}Object.defineProperty(t,"__esModule",{value:!0}),t.serializeOptionalBuffer=t.parseOptionalBuffer=t.serializeRequiredBuffer=t.parseRequiredBuffer=t.serializeOptionalString=t.parseOptionalString=t.serializeRequiredString=t.parseRequiredString=t.serializeRequiredEnum=t.parseRequiredEnum=t.parseFields=t.serializeField=t.parseField=t.serializeKey=t.parseKey=t.makeUInt64LE=t.serializeVarint=t.parseVarint=t.WireType=t.readBytes=t.numberFromBigInt=void 0,t.numberFromBigInt=s,t.readBytes=r,function(e){e[e.VARINT=0]="VARINT",e[e.FIXED_64_BIT=1]="FIXED_64_BIT",e[e.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",e[e.START_GROUP=3]="START_GROUP",e[e.END_GROUP=4]="END_GROUP",e[e.FIXED_32_BIT=5]="FIXED_32_BIT"}(i=t.WireType||(t.WireType={})),t.parseVarint=a,t.serializeVarint=n,t.makeUInt64LE=o,t.parseKey=l,t.serializeKey=d,t.parseField=u,t.serializeField=c,t.parseFields=function(e){let t=new Array;for(;e.offset<e.buffer.length;){let s=u(e);t.push(s)}return t},t.parseRequiredEnum=function(e,t){let r=t.filter((t=>t.key.field_number===e));if(0===r.length)throw"Expected required field to be present!";return s(r[r.length-1].data.readBigUInt64LE(0))},t.serializeRequiredEnum=function(e,t){return c({key:{field_number:e,wire_type:i.VARINT},data:o(t)})},t.parseRequiredString=f,t.serializeRequiredString=g,t.parseOptionalString=function(e,t){try{return f(e,t)}catch(e){return}},t.serializeOptionalString=function(e,t){return null==t?Buffer.alloc(0):g(e,t)},t.parseRequiredBuffer=p,t.serializeRequiredBuffer=h,t.parseOptionalBuffer=function(e,t){try{return p(e,t)}catch(e){return}},t.serializeOptionalBuffer=function(e,t){return null==t?Buffer.alloc(0):h(e,t)}},7585:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Autoguard=t.CLOSE=t.CONNECT=void 0;const r=s(9175);t.CONNECT=r.guards.Object.of({type:r.guards.StringLiteral.of("CONNECT")}),t.CLOSE=r.guards.Object.of({type:r.guards.StringLiteral.of("CLOSE")}),t.Autoguard={CONNECT:t.CONNECT,CLOSE:t.CLOSE}},2051:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Autoguard=t.PONG=t.PING=void 0;const r=s(9175);t.PING=r.guards.Object.of({type:r.guards.StringLiteral.of("PING")}),t.PONG=r.guards.Object.of({type:r.guards.StringLiteral.of("PONG")}),t.Autoguard={PING:t.PING,PONG:t.PONG}},3597:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.receiver=t.objects=t.media=t.heartbeat=t.connection=void 0,t.connection=s(7585),t.heartbeat=s(2051),t.media=s(2487),t.objects=s(437),t.receiver=s(8363)},2487:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Autoguard=t.MEDIA_STATUS=t.INVALID_REQUEST=t.LOAD_CANCELLED=t.LOAD_FAILED=t.INVALID_PLAYER_STATE=t.VOLUME=t.GET_STATUS=t.PLAY=t.STOP=t.SEEK=t.PAUSE=t.LOAD=void 0;const r=s(437),i=s(437),a=s(437),n=s(9175);t.LOAD=n.guards.Object.of({requestId:n.guards.Number,type:n.guards.StringLiteral.of("LOAD"),media:n.guards.Reference.of((()=>r.MediaInformation)),autoplay:n.guards.Union.of(n.guards.Undefined,n.guards.Boolean),currentTime:n.guards.Union.of(n.guards.Undefined,n.guards.Number),customData:n.guards.Union.of(n.guards.Undefined,n.guards.Record.of(n.guards.Any)),activeTrackIds:n.guards.Union.of(n.guards.Undefined,n.guards.Array.of(n.guards.Number))}),t.PAUSE=n.guards.Object.of({mediaSessionId:n.guards.Number,requestId:n.guards.Number,type:n.guards.StringLiteral.of("PAUSE"),customData:n.guards.Union.of(n.guards.Undefined,n.guards.Record.of(n.guards.Any))}),t.SEEK=n.guards.Object.of({mediaSessionId:n.guards.Number,requestId:n.guards.Number,type:n.guards.StringLiteral.of("SEEK"),resumeState:n.guards.Union.of(n.guards.Undefined,n.guards.Union.of(n.guards.StringLiteral.of("PLAYBACK_START"),n.guards.StringLiteral.of("PLAYBACK_PAUSE"))),currentTime:n.guards.Union.of(n.guards.Undefined,n.guards.Number),customData:n.guards.Union.of(n.guards.Undefined,n.guards.Record.of(n.guards.Any))}),t.STOP=n.guards.Object.of({mediaSessionId:n.guards.Number,requestId:n.guards.Number,type:n.guards.StringLiteral.of("STOP"),customData:n.guards.Union.of(n.guards.Undefined,n.guards.Record.of(n.guards.Any))}),t.PLAY=n.guards.Object.of({mediaSessionId:n.guards.Number,requestId:n.guards.Number,type:n.guards.StringLiteral.of("PLAY"),customData:n.guards.Union.of(n.guards.Undefined,n.guards.Record.of(n.guards.Any))}),t.GET_STATUS=n.guards.Object.of({mediaSessionId:n.guards.Union.of(n.guards.Undefined,n.guards.Number),requestId:n.guards.Number,type:n.guards.StringLiteral.of("GET_STATUS"),customData:n.guards.Union.of(n.guards.Undefined,n.guards.Record.of(n.guards.Any))}),t.VOLUME=n.guards.Object.of({mediaSessionId:n.guards.Number,requestId:n.guards.Number,type:n.guards.StringLiteral.of("VOLUME"),volume:n.guards.Reference.of((()=>a.Volume)),customData:n.guards.Union.of(n.guards.Undefined,n.guards.Record.of(n.guards.Any))}),t.INVALID_PLAYER_STATE=n.guards.Object.of({requestId:n.guards.Number,type:n.guards.StringLiteral.of("INVALID_PLAYER_STATE"),customData:n.guards.Union.of(n.guards.Undefined,n.guards.Record.of(n.guards.Any))}),t.LOAD_FAILED=n.guards.Object.of({requestId:n.guards.Number,type:n.guards.StringLiteral.of("LOAD_FAILED"),customData:n.guards.Union.of(n.guards.Undefined,n.guards.Record.of(n.guards.Any))}),t.LOAD_CANCELLED=n.guards.Object.of({requestId:n.guards.Number,type:n.guards.StringLiteral.of("LOAD_CANCELLED"),customData:n.guards.Union.of(n.guards.Undefined,n.guards.Record.of(n.guards.Any))}),t.INVALID_REQUEST=n.guards.Object.of({requestId:n.guards.Number,type:n.guards.StringLiteral.of("INVALID_REQUEST"),reason:n.guards.Union.of(n.guards.StringLiteral.of("INVALID_COMMAND"),n.guards.StringLiteral.of("DUPLICATE_REQUESTID")),customData:n.guards.Union.of(n.guards.Undefined,n.guards.Record.of(n.guards.Any))}),t.MEDIA_STATUS=n.guards.Object.of({requestId:n.guards.Number,type:n.guards.StringLiteral.of("MEDIA_STATUS"),status:n.guards.Array.of(n.guards.Reference.of((()=>i.MediaStatus))),customData:n.guards.Union.of(n.guards.Undefined,n.guards.Record.of(n.guards.Any))}),t.Autoguard={LOAD:t.LOAD,PAUSE:t.PAUSE,SEEK:t.SEEK,STOP:t.STOP,PLAY:t.PLAY,GET_STATUS:t.GET_STATUS,VOLUME:t.VOLUME,INVALID_PLAYER_STATE:t.INVALID_PLAYER_STATE,LOAD_FAILED:t.LOAD_FAILED,LOAD_CANCELLED:t.LOAD_CANCELLED,INVALID_REQUEST:t.INVALID_REQUEST,MEDIA_STATUS:t.MEDIA_STATUS}},437:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Autoguard=t.MediaStatus=t.PhotoMediaMetadata=t.MusicTrackMediaMetadata=t.TvShowMediaMetadata=t.MovieMediaMetadata=t.GenericMediaMetadata=t.MediaInformation=t.Volume=t.Image=void 0;const r=s(9175);t.Image=r.guards.Object.of({url:r.guards.String,height:r.guards.Union.of(r.guards.Undefined,r.guards.Number),width:r.guards.Union.of(r.guards.Undefined,r.guards.Number)}),t.Volume=r.guards.Object.of({level:r.guards.Union.of(r.guards.Undefined,r.guards.Number),muted:r.guards.Union.of(r.guards.Undefined,r.guards.Boolean)}),t.MediaInformation=r.guards.Object.of({contentId:r.guards.String,streamType:r.guards.Union.of(r.guards.StringLiteral.of("NONE"),r.guards.StringLiteral.of("BUFFERED"),r.guards.StringLiteral.of("LIVE")),contentType:r.guards.String,metadata:r.guards.Union.of(r.guards.Undefined,r.guards.Union.of(r.guards.Reference.of((()=>t.GenericMediaMetadata)),r.guards.Reference.of((()=>t.MovieMediaMetadata)),r.guards.Reference.of((()=>t.TvShowMediaMetadata)),r.guards.Reference.of((()=>t.MusicTrackMediaMetadata)),r.guards.Reference.of((()=>t.PhotoMediaMetadata)))),duration:r.guards.Union.of(r.guards.Undefined,r.guards.Number),customData:r.guards.Union.of(r.guards.Undefined,r.guards.Record.of(r.guards.Any)),tracks:r.guards.Union.of(r.guards.Undefined,r.guards.Array.of(r.guards.Union.of(r.guards.Object.of({trackId:r.guards.Number,type:r.guards.String}),r.guards.Object.of({trackId:r.guards.Number,type:r.guards.StringLiteral.of("TEXT"),trackType:r.guards.StringLiteral.of("TEXT"),trackContentId:r.guards.String,trackContentType:r.guards.String,subtype:r.guards.StringLiteral.of("SUBTITLES"),language:r.guards.String,name:r.guards.Union.of(r.guards.Undefined,r.guards.String),customData:r.guards.Union.of(r.guards.Undefined,r.guards.Record.of(r.guards.Any))}))))}),t.GenericMediaMetadata=r.guards.Object.of({metadataType:r.guards.NumberLiteral.of(0),title:r.guards.Union.of(r.guards.Undefined,r.guards.String),subtitle:r.guards.Union.of(r.guards.Undefined,r.guards.String),images:r.guards.Union.of(r.guards.Undefined,r.guards.Array.of(r.guards.Reference.of((()=>t.Image)))),releaseDate:r.guards.Union.of(r.guards.Undefined,r.guards.String)}),t.MovieMediaMetadata=r.guards.Object.of({metadataType:r.guards.NumberLiteral.of(1),title:r.guards.Union.of(r.guards.Undefined,r.guards.String),subtitle:r.guards.Union.of(r.guards.Undefined,r.guards.String),studio:r.guards.Union.of(r.guards.Undefined,r.guards.String),images:r.guards.Union.of(r.guards.Undefined,r.guards.Array.of(r.guards.Reference.of((()=>t.Image)))),releaseDate:r.guards.Union.of(r.guards.Undefined,r.guards.String)}),t.TvShowMediaMetadata=r.guards.Object.of({metadataType:r.guards.NumberLiteral.of(2),seriesTitle:r.guards.Union.of(r.guards.Undefined,r.guards.String),subtitle:r.guards.Union.of(r.guards.Undefined,r.guards.String),season:r.guards.Union.of(r.guards.Undefined,r.guards.Number),episode:r.guards.Union.of(r.guards.Undefined,r.guards.Number),images:r.guards.Union.of(r.guards.Undefined,r.guards.Array.of(r.guards.Reference.of((()=>t.Image)))),originalAirDate:r.guards.Union.of(r.guards.Undefined,r.guards.String)}),t.MusicTrackMediaMetadata=r.guards.Object.of({metadataType:r.guards.NumberLiteral.of(3),albumName:r.guards.Union.of(r.guards.Undefined,r.guards.String),title:r.guards.Union.of(r.guards.Undefined,r.guards.String),albumArtist:r.guards.Union.of(r.guards.Undefined,r.guards.String),artist:r.guards.Union.of(r.guards.Undefined,r.guards.String),composer:r.guards.Union.of(r.guards.Undefined,r.guards.String),trackNumber:r.guards.Union.of(r.guards.Undefined,r.guards.Number),discNumber:r.guards.Union.of(r.guards.Undefined,r.guards.Number),images:r.guards.Union.of(r.guards.Undefined,r.guards.Array.of(r.guards.Reference.of((()=>t.Image)))),releaseDate:r.guards.Union.of(r.guards.Undefined,r.guards.String)}),t.PhotoMediaMetadata=r.guards.Object.of({metadataType:r.guards.NumberLiteral.of(4),title:r.guards.Union.of(r.guards.Undefined,r.guards.String),artist:r.guards.Union.of(r.guards.Undefined,r.guards.String),location:r.guards.Union.of(r.guards.Undefined,r.guards.String),latitude:r.guards.Union.of(r.guards.Undefined,r.guards.Number),longitude:r.guards.Union.of(r.guards.Undefined,r.guards.Number),width:r.guards.Union.of(r.guards.Undefined,r.guards.Number),height:r.guards.Union.of(r.guards.Undefined,r.guards.Number),creationDateTime:r.guards.Union.of(r.guards.Undefined,r.guards.String)}),t.MediaStatus=r.guards.Object.of({mediaSessionId:r.guards.Number,media:r.guards.Union.of(r.guards.Undefined,r.guards.Union.of(r.guards.Reference.of((()=>t.MediaInformation)),r.guards.Object.of({}))),playbackRate:r.guards.Number,playerState:r.guards.Union.of(r.guards.StringLiteral.of("IDLE"),r.guards.StringLiteral.of("PLAYING"),r.guards.StringLiteral.of("BUFFERING"),r.guards.StringLiteral.of("PAUSED")),idleReason:r.guards.Union.of(r.guards.Undefined,r.guards.Union.of(r.guards.StringLiteral.of("CANCELLED"),r.guards.StringLiteral.of("INTERRUPTED"),r.guards.StringLiteral.of("FINISHED"),r.guards.StringLiteral.of("ERROR"))),currentTime:r.guards.Number,supportedMediaCommands:r.guards.Number,volume:r.guards.Reference.of((()=>t.Volume)),customData:r.guards.Union.of(r.guards.Undefined,r.guards.Record.of(r.guards.Any))}),t.Autoguard={Image:t.Image,Volume:t.Volume,MediaInformation:t.MediaInformation,GenericMediaMetadata:t.GenericMediaMetadata,MovieMediaMetadata:t.MovieMediaMetadata,TvShowMediaMetadata:t.TvShowMediaMetadata,MusicTrackMediaMetadata:t.MusicTrackMediaMetadata,PhotoMediaMetadata:t.PhotoMediaMetadata,MediaStatus:t.MediaStatus}},8363:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Autoguard=t.RECEIVER_STATUS=t.SET_VOLUME=t.GET_APP_AVAILABILITY=t.GET_STATUS=t.STOP=t.LAUNCH=void 0;const r=s(9175);t.LAUNCH=r.guards.Object.of({type:r.guards.StringLiteral.of("LAUNCH"),requestId:r.guards.Number,appId:r.guards.String}),t.STOP=r.guards.Object.of({type:r.guards.StringLiteral.of("STOP"),requestId:r.guards.Number,sessionId:r.guards.String}),t.GET_STATUS=r.guards.Object.of({type:r.guards.StringLiteral.of("GET_STATUS"),requestId:r.guards.Number}),t.GET_APP_AVAILABILITY=r.guards.Object.of({type:r.guards.StringLiteral.of("GET_APP_AVAILABILITY"),requestId:r.guards.Number,appId:r.guards.Array.of(r.guards.String)}),t.SET_VOLUME=r.guards.Object.of({type:r.guards.StringLiteral.of("SET_VOLUME"),requestId:r.guards.Number,volume:r.guards.Union.of(r.guards.Object.of({level:r.guards.Number}),r.guards.Object.of({muted:r.guards.Boolean}))}),t.RECEIVER_STATUS=r.guards.Object.of({type:r.guards.StringLiteral.of("RECEIVER_STATUS"),requestId:r.guards.Number,status:r.guards.Object.of({applications:r.guards.Union.of(r.guards.Undefined,r.guards.Array.of(r.guards.Object.of({appId:r.guards.String,displayName:r.guards.String,iconUrl:r.guards.String,isIdleScreen:r.guards.Boolean,launchedFromCloud:r.guards.Boolean,namespaces:r.guards.Array.of(r.guards.Object.of({name:r.guards.String})),sessionId:r.guards.String,statusText:r.guards.String,transportId:r.guards.String}))),userEq:r.guards.Object.of({}),volume:r.guards.Object.of({controlType:r.guards.String,level:r.guards.Number,muted:r.guards.Boolean,stepInterval:r.guards.Number})})}),t.Autoguard={LAUNCH:t.LAUNCH,STOP:t.STOP,GET_STATUS:t.GET_STATUS,GET_APP_AVAILABILITY:t.GET_APP_AVAILABILITY,SET_VOLUME:t.SET_VOLUME,RECEIVER_STATUS:t.RECEIVER_STATUS}},692:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0});const r=s(5747),i=s(2058),a=[".","private","config"];r.existsSync(a.join("/"))||r.mkdirSync(a.join("/"));const n=[...a,"config.json"].join("/");if(!r.existsSync(n)){let e={};r.writeFileSync(n,JSON.stringify(e,null,"\t"))}let o=r.readFileSync(n,"utf-8"),l=JSON.parse(o),d=i.Config.as(l);t.default=d},2058:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Autoguard=t.Config=void 0;const r=s(9175);t.Config=r.guards.Object.of({use_cue_index:r.guards.Union.of(r.guards.Undefined,r.guards.Boolean)}),t.Autoguard={Config:t.Config}},6321:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.runIndexer=t.getPath=t.user_search=t.track_search=t.shows_search=t.playlist_search=t.person_search=t.movie_search=t.genre_search=t.episode_search=t.cue_search=t.artist_search=t.album_search=t.getPlaylistItemsFromTrack=t.getPlaylistsItemsFromPlaylist=t.playlist_items=t.getPlaylistsFromUser=t.playlists=t.getStreamsFromFile=t.getStreamsFromUser=t.streams=t.getTokensFromUser=t.tokens=t.getKeysFromUser=t.keys=t.getUsersFromUsername=t.users=t.getCuesFromSubtitle=t.cues=t.subtitles=t.getGenresFromShow=t.getShowsFromGenre=t.show_genres=t.getGenresFromMovie=t.getMoviesFromGenre=t.movie_genres=t.genres=t.getPersonsFromShow=t.getShowsFromPerson=t.show_persons=t.getPersonsFromMovie=t.getMoviesFromPerson=t.movie_persons=t.persons=t.getFilesFromMovie=t.getMoviesFromFile=t.movie_files=t.movies=t.getFilesFromEpisode=t.getEpisodesFromFile=t.episode_files=t.getEpisodesFromSeason=t.episodes=t.getSeasonsFromShow=t.seasons=t.getFilesFromShow=t.getShowsFromFile=t.show_files=t.shows=t.getTracksFromArtist=t.getArtistsFromTrack=t.track_artists=t.getAlbumsFromArtist=t.getArtistsFromAlbum=t.album_artists=t.getFilesFromTrack=t.getTracksFromFile=t.track_files=t.getTracksFromDisc=t.tracks=t.getDiscsFromAlbum=t.discs=t.getFilesFromAlbum=t.getAlbumsFromFile=t.album_files=t.albums=t.artists=t.getVideoFilesFromSubtitleFile=t.getSubtitleFilesFromVideoFile=t.video_subtitles=t.getVideoFilesFromFile=t.video_files=t.getSubtitleFilesFromFile=t.subtitle_files=t.getMetadataFilesFromFile=t.metadata_files=t.getImageFilesFromFile=t.image_files=t.getAudioFiles=t.audio_files=t.getFilesFromDirectory=t.files=t.getDirectoriesFromDirectory=t.directories=void 0;const r=s(6417),i=s(5747),a=s(3302),n=s(298),o=s(1565),l=s(8555),d=s(692);function u(...e){return e=e.map((e=>String(null!=e?e:"").toLowerCase().normalize("NFKD").replace(/[\|\/\\\_\-]/g," ").replace(/[^a-z0-9 ]/g,"").trim().split(/[ ]+/g))).map((e=>e.join(" "))),r.createHash("sha256").update(e.join("\0")).digest("hex").slice(0,32)}const c=[".","private","media"];i.existsSync(c.join("/"))||i.mkdirSync(c.join("/"));const f=[".","private","tables"];function g(e,t,s){let r=[...f,e+".jsondb"].join("/");i.existsSync(r)||i.writeFileSync(r,"");let a=i.readFileSync(r,"utf-8").split(/\r?\n/),o=new Array;for(let e of a)if(""!==e){let s=JSON.parse(e),r=t.as(s);o.push(r)}return n.RecordIndex.from(o,s)}function p(e,t){let s=Array.from(t),r=[...f,e+".jsondb"].join("/"),a=i.openSync(r,"w");for(let e of s){let t=JSON.stringify(e)+"\n";i.writeSync(a,t)}i.closeSync(a)}i.existsSync(f.join("/"))||i.mkdirSync(f.join("/")),t.directories=g("directories",a.Directory,(e=>e.directory_id)),t.getDirectoriesFromDirectory=n.CollectionIndex.fromIndex(t.directories,t.directories,(e=>e.directory_id),(e=>e.parent_directory_id)),t.files=g("files",a.File,(e=>e.file_id)),t.getFilesFromDirectory=n.CollectionIndex.fromIndex(t.directories,t.files,(e=>e.directory_id),(e=>e.parent_directory_id)),t.audio_files=g("audio_files",a.AudioFile,(e=>e.file_id)),t.getAudioFiles=n.CollectionIndex.fromIndex(t.files,t.audio_files,(e=>e.file_id),(e=>e.file_id)),t.image_files=g("image_files",a.ImageFile,(e=>e.file_id)),t.getImageFilesFromFile=n.CollectionIndex.fromIndex(t.files,t.image_files,(e=>e.file_id),(e=>e.file_id)),t.metadata_files=g("metadata_files",a.MetadataFile,(e=>e.file_id)),t.getMetadataFilesFromFile=n.CollectionIndex.fromIndex(t.files,t.metadata_files,(e=>e.file_id),(e=>e.file_id)),t.subtitle_files=g("subtitle_files",a.SubtitleFile,(e=>e.file_id)),t.getSubtitleFilesFromFile=n.CollectionIndex.fromIndex(t.files,t.subtitle_files,(e=>e.file_id),(e=>e.file_id)),t.video_files=g("video_files",a.VideoFile,(e=>e.file_id)),t.getVideoFilesFromFile=n.CollectionIndex.fromIndex(t.files,t.video_files,(e=>e.file_id),(e=>e.file_id)),t.video_subtitles=g("video_subtitles",a.VideoSubtitle,(e=>[e.video_file_id,e.subtitle_file_id].join("\0"))),t.getSubtitleFilesFromVideoFile=n.CollectionIndex.fromIndex(t.video_files,t.video_subtitles,(e=>e.file_id),(e=>e.video_file_id)),t.getVideoFilesFromSubtitleFile=n.CollectionIndex.fromIndex(t.subtitle_files,t.video_subtitles,(e=>e.file_id),(e=>e.subtitle_file_id)),t.artists=g("artists",a.Artist,(e=>e.artist_id)),t.albums=g("albums",a.Album,(e=>e.album_id)),t.album_files=g("album_files",a.AlbumFile,(e=>[e.album_id,e.file_id].join("\0"))),t.getAlbumsFromFile=n.CollectionIndex.fromIndex(t.files,t.album_files,(e=>e.file_id),(e=>e.file_id)),t.getFilesFromAlbum=n.CollectionIndex.fromIndex(t.albums,t.album_files,(e=>e.album_id),(e=>e.album_id)),t.discs=g("discs",a.Disc,(e=>e.disc_id)),t.getDiscsFromAlbum=n.CollectionIndex.fromIndex(t.albums,t.discs,(e=>e.album_id),(e=>e.album_id)),t.tracks=g("tracks",a.Track,(e=>e.track_id)),t.getTracksFromDisc=n.CollectionIndex.fromIndex(t.discs,t.tracks,(e=>e.disc_id),(e=>e.disc_id)),t.track_files=g("track_files",a.TrackFile,(e=>[e.track_id,e.file_id].join("\0"))),t.getTracksFromFile=n.CollectionIndex.fromIndex(t.files,t.track_files,(e=>e.file_id),(e=>e.file_id)),t.getFilesFromTrack=n.CollectionIndex.fromIndex(t.tracks,t.track_files,(e=>e.track_id),(e=>e.track_id)),t.album_artists=g("album_artists",a.AlbumArtist,(e=>[e.album_id,e.artist_id].join("\0"))),t.getArtistsFromAlbum=n.CollectionIndex.fromIndex(t.albums,t.album_artists,(e=>e.album_id),(e=>e.album_id)),t.getAlbumsFromArtist=n.CollectionIndex.fromIndex(t.artists,t.album_artists,(e=>e.artist_id),(e=>e.artist_id)),t.track_artists=g("track_artists",a.TrackArtist,(e=>[e.track_id,e.artist_id].join("\0"))),t.getArtistsFromTrack=n.CollectionIndex.fromIndex(t.tracks,t.track_artists,(e=>e.track_id),(e=>e.track_id)),t.getTracksFromArtist=n.CollectionIndex.fromIndex(t.artists,t.track_artists,(e=>e.artist_id),(e=>e.artist_id)),t.shows=g("shows",a.Show,(e=>e.show_id)),t.show_files=g("show_files",a.ShowFile,(e=>[e.show_id,e.file_id].join("\0"))),t.getShowsFromFile=n.CollectionIndex.fromIndex(t.files,t.show_files,(e=>e.file_id),(e=>e.file_id)),t.getFilesFromShow=n.CollectionIndex.fromIndex(t.shows,t.show_files,(e=>e.show_id),(e=>e.show_id)),t.seasons=g("seasons",a.Season,(e=>e.season_id)),t.getSeasonsFromShow=n.CollectionIndex.fromIndex(t.shows,t.seasons,(e=>e.show_id),(e=>e.show_id)),t.episodes=g("episodes",a.Episode,(e=>e.episode_id)),t.getEpisodesFromSeason=n.CollectionIndex.fromIndex(t.seasons,t.episodes,(e=>e.season_id),(e=>e.season_id)),t.episode_files=g("episode_files",a.EpisodeFile,(e=>[e.episode_id,e.file_id].join("\0"))),t.getEpisodesFromFile=n.CollectionIndex.fromIndex(t.files,t.episode_files,(e=>e.file_id),(e=>e.file_id)),t.getFilesFromEpisode=n.CollectionIndex.fromIndex(t.episodes,t.episode_files,(e=>e.episode_id),(e=>e.episode_id)),t.movies=g("movies",a.Movie,(e=>e.movie_id)),t.movie_files=g("movie_files",a.MovieFile,(e=>[e.movie_id,e.file_id].join("\0"))),t.getMoviesFromFile=n.CollectionIndex.fromIndex(t.files,t.movie_files,(e=>e.file_id),(e=>e.file_id)),t.getFilesFromMovie=n.CollectionIndex.fromIndex(t.movies,t.movie_files,(e=>e.movie_id),(e=>e.movie_id)),t.persons=g("persons",a.Person,(e=>e.person_id)),t.movie_persons=g("movie_persons",a.MoviePerson,(e=>[e.movie_id,e.person_id].join("\0"))),t.getMoviesFromPerson=n.CollectionIndex.fromIndex(t.persons,t.movie_persons,(e=>e.person_id),(e=>e.person_id)),t.getPersonsFromMovie=n.CollectionIndex.fromIndex(t.movies,t.movie_persons,(e=>e.movie_id),(e=>e.movie_id)),t.show_persons=g("show_persons",a.ShowPerson,(e=>[e.show_id,e.person_id].join("\0"))),t.getShowsFromPerson=n.CollectionIndex.fromIndex(t.persons,t.show_persons,(e=>e.person_id),(e=>e.person_id)),t.getPersonsFromShow=n.CollectionIndex.fromIndex(t.shows,t.show_persons,(e=>e.show_id),(e=>e.show_id)),t.genres=g("genres",a.Genre,(e=>e.genre_id)),t.movie_genres=g("movie_genres",a.MovieGenre,(e=>[e.movie_id,e.genre_id].join("\0"))),t.getMoviesFromGenre=n.CollectionIndex.fromIndex(t.genres,t.movie_genres,(e=>e.genre_id),(e=>e.genre_id)),t.getGenresFromMovie=n.CollectionIndex.fromIndex(t.movies,t.movie_genres,(e=>e.movie_id),(e=>e.movie_id)),t.show_genres=g("show_genres",a.ShowGenre,(e=>[e.show_id,e.genre_id].join("\0"))),t.getShowsFromGenre=n.CollectionIndex.fromIndex(t.genres,t.show_genres,(e=>e.genre_id),(e=>e.genre_id)),t.getGenresFromShow=n.CollectionIndex.fromIndex(t.shows,t.show_genres,(e=>e.show_id),(e=>e.show_id)),t.subtitles=g("subtitles",a.Subtitle,(e=>e.subtitle_id)),t.cues=g("cues",a.Cue,(e=>e.cue_id)),t.getCuesFromSubtitle=n.CollectionIndex.fromIndex(t.subtitles,t.cues,(e=>e.subtitle_id),(e=>e.subtitle_id)),t.users=g("users",a.User,(e=>e.user_id)),t.getUsersFromUsername=n.CollectionIndex.fromIndex(t.users,t.users,(e=>e.user_id),(e=>e.username)),t.keys=g("keys",a.Key,(e=>e.key_id)),t.getKeysFromUser=n.CollectionIndex.fromIndex(t.users,t.keys,(e=>e.user_id),(e=>e.user_id)),t.tokens=g("tokens",a.Token,(e=>e.token_id)),t.getTokensFromUser=n.CollectionIndex.fromIndex(t.users,t.tokens,(e=>e.user_id),(e=>e.user_id)),t.streams=g("streams",a.Stream,(e=>e.stream_id)),t.getStreamsFromUser=n.CollectionIndex.fromIndex(t.users,t.streams,(e=>e.user_id),(e=>e.user_id)),t.getStreamsFromFile=n.CollectionIndex.fromIndex(t.files,t.streams,(e=>e.file_id),(e=>e.file_id)),t.playlists=g("playlists",a.Playlist,(e=>e.playlist_id)),t.getPlaylistsFromUser=n.CollectionIndex.fromIndex(t.users,t.playlists,(e=>e.user_id),(e=>e.user_id)),t.playlist_items=g("playlist_items",a.PlaylistItem,(e=>e.playlist_item_id)),t.getPlaylistsItemsFromPlaylist=n.CollectionIndex.fromIndex(t.playlists,t.playlist_items,(e=>e.playlist_id),(e=>e.playlist_id)),t.getPlaylistItemsFromTrack=n.CollectionIndex.fromIndex(t.tracks,t.playlist_items,(e=>e.track_id),(e=>e.track_id));{let e;t.users.on("*",(()=>{o.present(e)&&clearTimeout(e),e=setTimeout((()=>{p("users",t.users)}),1e4)}))}{let e;t.keys.on("*",(()=>{o.present(e)&&clearTimeout(e),e=setTimeout((()=>{p("keys",t.keys)}),1e4)}))}{let e;t.tokens.on("*",(()=>{o.present(e)&&clearTimeout(e),e=setTimeout((()=>{p("tokens",t.tokens)}),1e4)}))}{let e;t.streams.on("*",(()=>{o.present(e)&&clearTimeout(e),e=setTimeout((()=>{p("streams",t.streams)}),1e4)}))}{let e;t.playlists.on("*",(()=>{o.present(e)&&clearTimeout(e),e=setTimeout((()=>{p("playlists",t.playlists)}),1e4)}))}{let e;t.playlist_items.on("*",(()=>{o.present(e)&&clearTimeout(e),e=setTimeout((()=>{p("playlist_items",t.playlist_items)}),1e4)}))}function h(e){let s=new Array;for(;;){s.unshift(e.name);let r=e.parent_directory_id;if(o.absent(r))break;e=t.directories.lookup(r)}return[...c,...s]}function m(e){return h(e)}function y(e){let s=m(e).join("/");if(i.existsSync(s)){let t=i.statSync(s);if(t.isFile()&&t.mtime.valueOf()===e.index_timestamp)return}t.files.remove(e)}function b(e){let s=(r=e,h(r)).join("/");var r;if(i.existsSync(s)&&i.statSync(s).isDirectory()){for(let s of t.getDirectoriesFromDirectory.lookup(e.directory_id))b(s);for(let s of t.getFilesFromDirectory.lookup(e.directory_id))y(s)}else t.directories.remove(e)}function _(e,s){let r=i.readdirSync(e.join("/"),{withFileTypes:!0});for(let i of r){let r=i.name;if(i.isDirectory()){let a=u("directory",s,r);try{t.directories.lookup(a)}catch(e){t.directories.insert({directory_id:a,name:r,parent_directory_id:s})}_([...e,i.name],a)}else if(i.isFile()){let e=u("file",s,r);try{t.files.lookup(e)}catch(i){t.files.insert({file_id:e,name:r,parent_directory_id:s})}}}}function S(e,...s){let r=e.metadata;if(l.schema.EpisodeMetadata.is(r)){let e=u("show",r.show.title);t.shows.insert({show_id:e,name:r.show.title,summary:r.show.summary},"combine");let i=u("season",e,""+r.season);t.seasons.insert({season_id:i,show_id:e,number:r.season},"combine");let a=u("episode",i,""+r.episode);t.episodes.insert({episode_id:a,season_id:i,title:r.title,number:r.episode,year:r.year,summary:r.summary},"combine");for(let e of s)t.episode_files.insert({episode_id:a,file_id:e},"combine");for(let[s,i]of r.show.actors.entries()){let r=u("person",i);t.persons.insert({person_id:r,name:i},"combine"),t.show_persons.insert({person_id:r,show_id:e,order:s},"combine")}for(let[s,i]of r.show.genres.entries()){let r=u("genre",i);t.genres.insert({genre_id:r,name:i},"combine"),t.show_genres.insert({genre_id:r,show_id:e,order:s},"combine")}}else if(l.schema.MovieMetadata.is(r)){let e=u("movie",r.title,r.year);t.movies.insert({movie_id:e,title:r.title,year:r.year,summary:r.summary},"combine");for(let r of s)t.movie_files.insert({movie_id:e,file_id:r},"combine");for(let[s,i]of r.actors.entries()){let r=u("person",i);t.persons.insert({person_id:r,name:i},"combine"),t.movie_persons.insert({person_id:r,movie_id:e,order:s},"combine")}for(let[s,i]of r.genres.entries()){let r=u("genre",i);t.genres.insert({genre_id:r,name:i},"combine"),t.movie_genres.insert({genre_id:r,movie_id:e,order:s},"combine")}}else if(l.schema.TrackMetadata.is(r)){let e=u("album",r.album.title,r.album.year);t.albums.insert({album_id:e,title:r.album.title,year:r.album.year},"combine");for(let[s,i]of r.album.artists.entries()){let r=u("artist",i.title);t.artists.insert({artist_id:r,name:i.title},"combine"),t.album_artists.insert({album_id:e,artist_id:r,order:s},"combine")}let i=u("disc",e,""+r.disc);t.discs.insert({disc_id:i,album_id:e,number:r.disc},"combine");let a=u("track",i,""+r.track);t.tracks.insert({track_id:a,disc_id:i,title:r.title,number:r.track},"combine");for(let e of s)t.track_files.insert({track_id:a,file_id:e},"combine");for(let[e,s]of r.artists.entries()){let r=u("artist",s.title);t.artists.insert({artist_id:r,name:s.title},"combine"),t.track_artists.insert({track_id:a,artist_id:r,order:e},"combine")}}}function v(e){let s=e.file_id,r=m(e),a=i.openSync(r.join("/"),"r");try{let r={resources:[]};if(e.name.endsWith(".vtt")){r=l.vtt.probe(a);let i=r.resources.filter((e=>"subtitle"===e.type)).shift();if(o.present(i)&&(t.subtitle_files.insert({file_id:s,mime:"text/vtt",duration_ms:i.duration_ms,language:i.language}),d.default.use_cue_index)){let s=u("subtitle",e.file_id);t.subtitles.insert({subtitle_id:s,file_id:e.file_id});for(let e of i.cues){let r=u("cue",s,""+e.start_ms);t.cues.insert({cue_id:r,subtitle_id:s,start_ms:e.start_ms,duration_ms:e.duration_ms,lines:e.lines.join("\n")})}}}else if(e.name.endsWith(".json")){r=l.json.probe(a);let e=r.resources.filter((e=>"metadata"===e.type)).shift();o.present(e)&&t.metadata_files.insert({file_id:s,mime:"application/json"})}else if(e.name.endsWith(".mp3")){r=l.mp3.probe(a);let e=r.resources.filter((e=>"audio"===e.type)).shift();o.present(e)&&t.audio_files.insert({file_id:s,mime:"audio/mp3",duration_ms:e.duration_ms})}else if(e.name.endsWith(".mp4")){r=l.mp4.probe(a);let e=r.resources.filter((e=>"audio"===e.type)),i=r.resources.filter((e=>"video"===e.type)),n=e.shift(),d=i.shift();o.present(d)?t.video_files.insert({file_id:s,mime:"video/mp4",duration_ms:d.duration_ms,width:d.width,height:d.height}):o.present(n)&&t.audio_files.insert({file_id:s,mime:"audio/mp4",duration_ms:n.duration_ms})}else if(e.name.endsWith(".jpg")||e.name.endsWith(".jpeg")){r=l.jpeg.probe(a);let e=r.resources.filter((e=>"image"===e.type)).shift();o.present(e)&&t.image_files.insert({file_id:s,mime:"image/jpeg",width:e.width,height:e.height})}S(r,s)}catch(e){console.log(`Indexing failed for "${r.join("/")}"!`)}i.closeSync(a);let n=i.statSync(r.join("/"));e.index_timestamp=n.mtime.valueOf()}function k(e){let s=t.getFilesFromDirectory.lookup(e.parent_directory_id).sort(n.LexicalSort.increasing((e=>e.name))).map((e=>{try{return t.audio_files.lookup(e.file_id),e}catch(e){}try{return t.video_files.lookup(e.file_id),e}catch(e){}})).filter(o.present),r=e.name.split(".")[0],i=s.filter((e=>e.name.split(".")[0]===r));return i.length>0?i:s}function w(){console.log("Running indexer...");for(let e of t.getDirectoriesFromDirectory.lookup(void 0))b(e);for(let e of t.getFilesFromDirectory.lookup(void 0))y(e);_(c),function(){for(let e of t.files)o.absent(e.index_timestamp)&&v(e)}(),function(){for(let e of t.metadata_files){let s=t.files.lookup(e.file_id),r=m(s),a=i.openSync(r.join("/"),"r"),n=l.json.probe(a);i.closeSync(a),S(n,...k(s).map((e=>e.file_id)))}}(),function(){for(let e of t.image_files){let s=k(t.files.lookup(e.file_id));for(let r of s){let s=t.getTracksFromFile.lookup(r.file_id).filter((t=>t.file_id!==e.file_id));for(let r of s)try{let s=t.tracks.lookup(r.track_id),i=t.discs.lookup(s.disc_id),a=t.albums.lookup(i.album_id);t.album_files.insert({album_id:a.album_id,file_id:e.file_id})}catch(e){}let i=t.getMoviesFromFile.lookup(r.file_id).filter((t=>t.file_id!==e.file_id));for(let s of i)t.movie_files.insert({movie_id:s.movie_id,file_id:e.file_id});let a=t.getEpisodesFromFile.lookup(r.file_id).filter((t=>t.file_id!==e.file_id));for(let s of a)try{let r=t.episodes.lookup(s.episode_id),i=t.seasons.lookup(r.season_id),a=t.shows.lookup(i.show_id);t.show_files.insert({show_id:a.show_id,file_id:e.file_id})}catch(e){}}}}(),function(){for(let e of t.subtitle_files){let s=t.files.lookup(e.file_id),r=s.name.split(".")[0],i=k(s).filter((e=>e.name.split(".")[0]===r));for(let e of i)t.video_subtitles.insert({video_file_id:e.file_id,subtitle_file_id:s.file_id})}}();for(let e of t.tokens)e.expires_ms<=Date.now()&&t.tokens.remove(e);console.log("Indexing finished.")}0===t.users.length()&&0===t.keys.length()&&t.keys.insert({key_id:u("key",r.randomBytes(16).toString("hex"))}),t.album_search=n.SearchIndex.fromIndex(t.albums,(e=>{var t;return[e.title,null===(t=e.year)||void 0===t?void 0:t.toString()].filter(o.present)})),t.artist_search=n.SearchIndex.fromIndex(t.artists,(e=>[e.name])),t.cue_search=n.SearchIndex.fromIndex(t.cues,(e=>e.lines.split("\n"))),t.episode_search=n.SearchIndex.fromIndex(t.episodes,(e=>{var t;return[e.title,null===(t=e.year)||void 0===t?void 0:t.toString()].filter(o.present)})),t.genre_search=n.SearchIndex.fromIndex(t.genres,(e=>[e.name])),t.movie_search=n.SearchIndex.fromIndex(t.movies,(e=>{var t;return[e.title,null===(t=e.year)||void 0===t?void 0:t.toString()].filter(o.present)})),t.person_search=n.SearchIndex.fromIndex(t.persons,(e=>[e.name])),t.playlist_search=n.SearchIndex.fromIndex(t.playlists,(e=>[e.title])),t.shows_search=n.SearchIndex.fromIndex(t.shows,(e=>[e.name])),t.track_search=n.SearchIndex.fromIndex(t.tracks,(e=>[e.title])),t.user_search=n.SearchIndex.fromIndex(t.users,(e=>[e.name,e.username])),t.getPath=h,t.runIndexer=w,w(),p("files",t.files),p("directories",t.directories),p("audio_files",t.audio_files),p("image_files",t.image_files),p("metadata_files",t.metadata_files),p("subtitle_files",t.subtitle_files),p("video_files",t.video_files),p("video_subtitles",t.video_subtitles),p("artists",t.artists),p("albums",t.albums),p("album_files",t.album_files),p("discs",t.discs),p("tracks",t.tracks),p("track_files",t.track_files),p("album_artists",t.album_artists),p("track_artists",t.track_artists),p("shows",t.shows),p("show_files",t.show_files),p("seasons",t.seasons),p("episodes",t.episodes),p("episode_files",t.episode_files),p("movies",t.movies),p("movie_files",t.movie_files),p("persons",t.persons),p("movie_persons",t.movie_persons),p("show_persons",t.show_persons),p("genres",t.genres),p("movie_genres",t.movie_genres),p("show_genres",t.show_genres),p("subtitles",t.subtitles),p("cues",t.cues)},8555:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.vtt=t.schema=t.mp4=t.mp3=t.json=t.jpeg=void 0,t.jpeg=s(6101),t.json=s(5636),t.mp3=s(7357),t.mp4=s(5230),t.schema=s(4719),t.vtt=s(3729)},6101:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.probe=void 0;const r=s(2102);var i;function a(e){let t=0,s=e.readUInt8(t);t+=1;let r=e.readUInt16BE(t);t+=2;let i=e.readUInt16BE(t);t+=2;let a=e.readUInt8(t);return t+=1,{precision:s,height:r,width:i,component_count:a,components:[...Array(a).keys()].map((()=>{let s=e.readUInt8(t);t+=1;let r=e.readUInt8(t);t+=1;let i=e.readUInt8(t);return t+=1,{id:s,sampling_factors:r,quantization_table:i}}))}}!function(e){e[e.START_OF_IMAGE=65496]="START_OF_IMAGE",e[e.END_OF_IMAGE=65497]="END_OF_IMAGE",e[e.APPLICATION_0=65504]="APPLICATION_0",e[e.START_OF_SCAN=65498]="START_OF_SCAN",e[e.START_OF_FRAME_0=65472]="START_OF_FRAME_0",e[e.DEFINE_QUANTIZATION_TABLE=65499]="DEFINE_QUANTIZATION_TABLE",e[e.DEFINE_HUFFMAN_TABLE=65476]="DEFINE_HUFFMAN_TABLE"}(i||(i={})),t.probe=function(e){return new r.Binary(e).newContext(((e,t)=>{let s=Buffer.alloc(2),r=Buffer.alloc(2);if(e(s),s.readUInt16BE()!==i.START_OF_IMAGE)throw"Expected SOI marker!";if(Buffer.alloc(0),e(s),s.readUInt16BE()!==i.APPLICATION_0)throw"Expected APP0 marker!";for(e(r),function(e){let t=0,s=e.slice(t,5);if(t+=5,"JFIF\0"!==s.toString())throw"Expected a JFIF tag!";e.readUInt8(t);t+=1;e.readUInt8(t);t+=1;let r=e.readUInt8(t);if(t+=1,0!==r&&1!==r&&2!==r)throw"Expected a valid density unit!";let i=e.readUInt16BE(t);if(t+=2,0===i)throw"Expected a non-zero horisontal resolution!";let a=e.readUInt16BE(t);if(t+=2,0===a)throw"Expected a non-zero vertical resolution!";let n=e.readUInt8(t);t+=1;let o=e.readUInt8(t);t+=1;let l=e.slice(t,t+n*o*3);if(t+=n*o*3,l.length!==n*o*3)throw"Expected a valid thumbnail!"}(e(Buffer.alloc(r.readUInt16BE()-2)));;){if(e(s),e(r),s.readUInt16BE()===i.START_OF_FRAME_0){let t=a(e(Buffer.alloc(r.readUInt16BE()-2)));return{resources:[{type:"image",width:t.width,height:t.height}]}}t(r.readUInt16BE()-2)}}))}},5636:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.probe=void 0;const r=s(5747),i=s(4719);t.probe=function(e){let t={resources:[{type:"metadata"}]},s=r.readFileSync(e),a=JSON.parse(s.toString());return i.Metadata.is(a)&&(t.metadata=a),t}},7357:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.probe=void 0;const r=s(1565),i=s(2102);function a(e){return(127&e.readUInt8(0))<<21|(127&e.readUInt8(1))<<14|(127&e.readUInt8(2))<<7|(127&e.readUInt8(3))<<0}var n,o;!function(e){e[e.V2_5=0]="V2_5",e[e.RESERVED=1]="RESERVED",e[e.V2=2]="V2",e[e.V1=3]="V1"}(n||(n={})),function(e){e[e.RESERVED=0]="RESERVED",e[e.LAYER_3=1]="LAYER_3",e[e.LAYER_2=2]="LAYER_2",e[e.LAYER_1=3]="LAYER_1"}(o||(o={}));const l=[0,32,40,48,56,64,80,96,112,128,160,192,224,256,320,0],d=[44100,48e3,32e3,0];t.probe=function(e){let t=new i.Binary(e),s=function(e){return e.newContext(((e,t)=>{let s=Buffer.alloc(10);if(e(s),"ID3\0"!==s.slice(0,5).toString("binary"))throw"Expected an ID3v2 tag!";let i=a(s.slice(6,10)),n=Buffer.alloc(i);e(n);let o={},l=0;for(;l<n.length;){let e=n.slice(l,l+4).toString("binary"),t=a(n.slice(l+4,l+4+4)),s=(n.slice(l+8,l+8+2),n.slice(l+10,l+10+t));if(l+=10+t,"\0\0\0\0"===e)break;if("TIT2"===e)o.title=s.slice(1,-1).toString();else if("TALB"===e)o.album=s.slice(1,-1).toString();else if("TDRC"===e){let e=s.slice(1,-1).toString(),t=/^([0-9]+)$/.exec(e);r.present(t)&&(o.year=parseInt(t[1]))}else if("TRCK"===e){let e=s.slice(1,-1).toString(),t=/^([0-9]+)(?:\/([0-9]+))?$/.exec(e);r.present(t)&&(o.track_number=parseInt(t[1]))}else if("TPOS"===e){let e=s.slice(1,-1).toString(),t=/^([0-9]+)(?:\/([0-9]+))?$/.exec(e);r.present(t)&&(o.disc_number=parseInt(t[1]))}else if("TPE1"===e)o.artist=s.slice(1,-1).toString();else if("TPE2"===e)o.album_artist=s.slice(1,-1).toString();else if("TXXX"===e){let e=s.slice(1,-1).toString(),t=/^ALBUM ARTIST\0(.+)$/.exec(e);r.present(t)&&(o.album_artist=t[1])}}return o}))}(t);console.log(s);let u={resources:[{type:"audio",duration_ms:function(e){return e.newContext(((e,t)=>{let s=Buffer.alloc(4);e(s);let r=(255&s[0])<<3|(224&s[1])>>5,i=(24&s[1])>>3,a=(6&s[1])>>1,u=(s[1],(240&s[2])>>4),c=(12&s[2])>>2,f=(2&s[2])>>1;if(s[2],s[3],s[3],s[3],s[3],s[3],2047===r&&i===n.V1&&a===o.LAYER_3){let t=1152,s=Math.floor(t*l[u]*1e3/8/d[c]);f&&(s+=1);let r=1*s,i=Buffer.alloc(r-4);e(i),i.slice(0,32);let a=i.slice(32,36);if("Xing"===a.toString("binary")||"Info"===a.toString()){let e=i.slice(36,40),s=(8&e[3])>>3,r=(4&e[3])>>2,a=(2&e[3])>>1,n=40;if((1&e[3])>>0){let e=i.readUInt32BE(n);return n+=4,Math.ceil(e*t/d[c]*1e3)}a&&(i.readUInt32BE(n),n+=4),r&&(n+=100),s&&(i.readUInt32BE(n),n+=4)}}throw"Expected a Xing header!"}))}(t)}]};if(r.present(s.title)&&r.present(s.disc_number)&&r.present(s.track_number)&&r.present(s.album)){let e={type:"track",title:s.title,disc:s.disc_number,track:s.track_number,album:{title:s.album,year:s.year,artists:r.absent(s.album_artist)?[]:s.album_artist.split(";").map((e=>e.trim())).map((e=>({title:e})))},artists:r.absent(s.artist)?[]:s.artist.split(";").map((e=>e.trim())).map((e=>({title:e})))};u.metadata=e}return u}},5230:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.probe=void 0;const r=s(5747),i=s(1565);class a{constructor(e,t,s){this.fd=e,this.type=t,this.body=s}getAllChildren(){let e=Object.assign({},this.body),t=new Array;for(;e.length>0;){let s=a.parse(this.fd,e);"udta"===this.type&&(s.body.offset+=4,s.body.length-=4),t.push(s),e.offset=s.body.offset+s.body.length,e.length=this.body.offset+this.body.length-e.offset}return t}getChild(e){let t=this.getChildren(e);if(1!==t.length)throw"Expected exactly one child!";return t[0]}getChildren(e){return this.getAllChildren().filter((t=>t.type===e))}readBody(){let e=Buffer.alloc(this.body.length);if(r.readSync(this.fd,e,0,e.length,this.body.offset)!==e.length)throw`Expected to read exactly ${e.length} bytes!`;return e}static parse(e,t){let s=t.offset,i=Buffer.alloc(8);if(r.readSync(e,i,0,i.length,s)!==i.length)throw`Expected to read exactly ${i.length} bytes!`;s+=i.length;let n=i.readUInt32BE(0),o=i.slice(4,8).toString("binary");if(0===n)n=t.length-s;else if(1===n){if(r.readSync(e,i,0,i.length,s)!==i.length)throw`Expected to read exactly ${i.length} bytes!`;s+=i.length,n=Number(i.readBigUInt64BE(0))}if(n<8)throw`Expected a length of at least 8 bytes, got ${n}!`;if(n>t.length)throw`Expected a length of at most ${t.length} bytes, got ${n}!`;return n-=8,new a(e,o,{offset:s,length:n})}}t.probe=function(e){let t=new a(e,"root",{offset:0,length:r.fstatSync(e).size}).getChild("moov"),s=t.getChild("mvhd").readBody().readUInt32BE(12),n={resources:t.getChildren("trak").map((e=>{let t=e.getChild("tkhd").readBody(),r=t.readUInt32BE(20),i=t.readUInt16BE(76),a=t.readUInt16BE(80),n=Math.ceil(r/s*1e3);return n>0&&i>0&&a>0?{type:"video",duration_ms:n,width:i,height:a}:n>0?{type:"audio",duration_ms:n}:{type:"metadata"}}))};try{let e=t.getChild("udta").getChild("meta").getChild("ilst"),s={};try{let t=e.getChild("tvsh").getChild("data").readBody();s.show=t.slice(8).toString()}catch(e){}try{let t=e.getChild("tven").getChild("data").readBody();s.episode=t.slice(8).toString()}catch(e){}try{let t=e.getChild("tves").getChild("data").readBody();s.episode_number=t.readUInt32BE(8)}catch(e){}try{let t=e.getChild("tvsn").getChild("data").readBody();s.season_number=t.readUInt32BE(8)}catch(e){}try{let t=e.getChild("nam").getChild("data").readBody();s.title=t.slice(8).toString()}catch(e){}try{let t=e.getChild("day").getChild("data").readBody();s.year=Number.parseInt(t.slice(8).toString())}catch(e){}try{let t=e.getChild("cmt").getChild("data").readBody();s.comment=t.slice(8).toString()}catch(e){}try{let t=e.getChild("ART").getChild("data").readBody();s.artist=t.slice(8).toString()}catch(e){}try{let t=e.getChild("alb").getChild("data").readBody();s.album=t.slice(8).toString()}catch(e){}try{let t=e.getChild("aART").getChild("data").readBody();s.album_artist=t.slice(8).toString()}catch(e){}try{let t=e.getChild("trkn").getChild("data").readBody();s.track_number=t.readUInt32BE(8)}catch(e){}try{let t=e.getChild("disk").getChild("data").readBody();s.disc_number=t.readUInt32BE(8)}catch(e){}if(n.resources.find((e=>"video"===e.type))){if(i.present(s.episode)&&i.present(s.season_number)&&i.present(s.episode_number)&&i.present(s.show)){let e={type:"episode",title:s.episode,season:s.season_number,episode:s.episode_number,year:s.year,summary:s.comment,show:{title:s.show,summary:void 0,genres:[],actors:[]}};n.metadata=e}else if(i.present(s.title)){let e={type:"movie",title:s.title,year:s.year,summary:s.comment,genres:[],actors:[]};n.metadata=e}}else if(n.resources.find((e=>"audio"===e.type))&&i.present(s.title)&&i.present(s.disc_number)&&i.present(s.track_number)&&i.present(s.album)){let e={type:"track",title:s.title,disc:s.disc_number,track:s.track_number,album:{title:s.album,year:s.year,artists:i.absent(s.album_artist)?[]:s.album_artist.split(";").map((e=>e.trim())).map((e=>({title:e})))},artists:i.absent(s.artist)?[]:s.artist.split(";").map((e=>e.trim())).map((e=>({title:e})))};n.metadata=e}}catch(e){}return n}},2102:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Binary=void 0;const r=s(5747);t.Binary=class{constructor(e){this.fd=e,this.offset=0}read(e){let t=r.readSync(this.fd,e,0,e.length,this.offset);if(t!==e.length)throw`Expected to read ${e.length} bytes but read ${t}!`;return this.offset+=t,e}skip(e){this.offset+=e}newContext(e){let t=this.offset;try{return e((e=>this.read(e)),(e=>this.skip(e)))}catch(e){throw this.offset=t,e}}}},4719:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Autoguard=t.Probe=t.Resource=t.VideoResource=t.SubtitleResource=t.MetadataResource=t.ImageResource=t.AudioResource=t.Metadata=t.TrackMetadata=t.MovieMetadata=t.EpisodeMetadata=void 0;const r=s(9175);t.EpisodeMetadata=r.guards.Object.of({type:r.guards.StringLiteral.of("episode"),title:r.guards.String,season:r.guards.Number,episode:r.guards.Number,year:r.guards.Union.of(r.guards.Undefined,r.guards.Number),summary:r.guards.Union.of(r.guards.Undefined,r.guards.String),show:r.guards.Object.of({title:r.guards.String,summary:r.guards.Union.of(r.guards.Undefined,r.guards.String),genres:r.guards.Array.of(r.guards.String),actors:r.guards.Array.of(r.guards.String)})}),t.MovieMetadata=r.guards.Object.of({type:r.guards.StringLiteral.of("movie"),title:r.guards.String,year:r.guards.Union.of(r.guards.Undefined,r.guards.Number),summary:r.guards.Union.of(r.guards.Undefined,r.guards.String),genres:r.guards.Array.of(r.guards.String),actors:r.guards.Array.of(r.guards.String)}),t.TrackMetadata=r.guards.Object.of({type:r.guards.StringLiteral.of("track"),title:r.guards.String,disc:r.guards.Number,track:r.guards.Number,album:r.guards.Object.of({title:r.guards.String,year:r.guards.Union.of(r.guards.Undefined,r.guards.Number),artists:r.guards.Array.of(r.guards.Object.of({title:r.guards.String}))}),artists:r.guards.Array.of(r.guards.Object.of({title:r.guards.String}))}),t.Metadata=r.guards.Union.of(r.guards.Reference.of((()=>t.EpisodeMetadata)),r.guards.Reference.of((()=>t.MovieMetadata)),r.guards.Reference.of((()=>t.TrackMetadata))),t.AudioResource=r.guards.Object.of({type:r.guards.StringLiteral.of("audio"),duration_ms:r.guards.Number}),t.ImageResource=r.guards.Object.of({type:r.guards.StringLiteral.of("image"),width:r.guards.Number,height:r.guards.Number}),t.MetadataResource=r.guards.Object.of({type:r.guards.StringLiteral.of("metadata")}),t.SubtitleResource=r.guards.Object.of({type:r.guards.StringLiteral.of("subtitle"),duration_ms:r.guards.Number,language:r.guards.Union.of(r.guards.Undefined,r.guards.String),cues:r.guards.Array.of(r.guards.Object.of({start_ms:r.guards.Number,duration_ms:r.guards.Number,lines:r.guards.Array.of(r.guards.String)}))}),t.VideoResource=r.guards.Object.of({type:r.guards.StringLiteral.of("video"),duration_ms:r.guards.Number,width:r.guards.Number,height:r.guards.Number}),t.Resource=r.guards.Union.of(r.guards.Reference.of((()=>t.AudioResource)),r.guards.Reference.of((()=>t.ImageResource)),r.guards.Reference.of((()=>t.MetadataResource)),r.guards.Reference.of((()=>t.SubtitleResource)),r.guards.Reference.of((()=>t.VideoResource))),t.Probe=r.guards.Object.of({metadata:r.guards.Union.of(r.guards.Undefined,r.guards.Reference.of((()=>t.Metadata))),resources:r.guards.Array.of(r.guards.Reference.of((()=>t.Resource)))}),t.Autoguard={EpisodeMetadata:t.EpisodeMetadata,MovieMetadata:t.MovieMetadata,TrackMetadata:t.TrackMetadata,Metadata:t.Metadata,AudioResource:t.AudioResource,ImageResource:t.ImageResource,MetadataResource:t.MetadataResource,SubtitleResource:t.SubtitleResource,VideoResource:t.VideoResource,Resource:t.Resource,Probe:t.Probe}},3729:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.probe=void 0;const r=s(9175),i=s(5747),a=s(1565),n=s(4484);t.probe=function(e){let t,s={resources:[]},o=i.readFileSync(e),l=n.decode(o.toString()),d=l.body.cues,u=d.length>0?d[d.length-1]:void 0,c=a.present(u)?u.start_ms+u.duration_ms:0;try{let e=JSON.parse(l.head.metadata);t=r.guards.String.as(e.language)}catch(e){}return s.resources.push({type:"subtitle",duration_ms:c,language:t,cues:d}),s}},3302:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Autoguard=t.PlaylistItem=t.Playlist=t.Stream=t.Token=t.Key=t.User=t.Cue=t.Subtitle=t.ShowGenre=t.MovieGenre=t.Genre=t.ShowPerson=t.MoviePerson=t.Person=t.MovieFile=t.Movie=t.EpisodeFile=t.Episode=t.Season=t.ShowFile=t.Show=t.TrackArtist=t.AlbumArtist=t.TrackFile=t.Track=t.Disc=t.AlbumFile=t.Album=t.Artist=t.VideoSubtitle=t.VideoFile=t.SubtitleFile=t.MetadataFile=t.ImageFile=t.AudioFile=t.File=t.Directory=void 0;const r=s(9175);t.Directory=r.guards.Object.of({directory_id:r.guards.String,name:r.guards.String,parent_directory_id:r.guards.Union.of(r.guards.Undefined,r.guards.String)}),t.File=r.guards.Object.of({file_id:r.guards.String,name:r.guards.String,parent_directory_id:r.guards.Union.of(r.guards.Undefined,r.guards.String),index_timestamp:r.guards.Union.of(r.guards.Undefined,r.guards.Number)}),t.AudioFile=r.guards.Object.of({file_id:r.guards.String,mime:r.guards.Union.of(r.guards.StringLiteral.of("audio/mp4"),r.guards.StringLiteral.of("audio/mp3")),duration_ms:r.guards.Number}),t.ImageFile=r.guards.Object.of({file_id:r.guards.String,mime:r.guards.StringLiteral.of("image/jpeg"),width:r.guards.Number,height:r.guards.Number}),t.MetadataFile=r.guards.Object.of({file_id:r.guards.String,mime:r.guards.StringLiteral.of("application/json")}),t.SubtitleFile=r.guards.Object.of({file_id:r.guards.String,mime:r.guards.StringLiteral.of("text/vtt"),duration_ms:r.guards.Number,language:r.guards.Union.of(r.guards.Undefined,r.guards.String)}),t.VideoFile=r.guards.Object.of({file_id:r.guards.String,mime:r.guards.StringLiteral.of("video/mp4"),duration_ms:r.guards.Number,width:r.guards.Number,height:r.guards.Number}),t.VideoSubtitle=r.guards.Object.of({video_file_id:r.guards.String,subtitle_file_id:r.guards.String}),t.Artist=r.guards.Object.of({artist_id:r.guards.String,name:r.guards.String}),t.Album=r.guards.Object.of({album_id:r.guards.String,title:r.guards.String,year:r.guards.Union.of(r.guards.Undefined,r.guards.Number)}),t.AlbumFile=r.guards.Object.of({album_id:r.guards.String,file_id:r.guards.String}),t.Disc=r.guards.Object.of({disc_id:r.guards.String,album_id:r.guards.String,number:r.guards.Number}),t.Track=r.guards.Object.of({track_id:r.guards.String,disc_id:r.guards.String,title:r.guards.String,number:r.guards.Number}),t.TrackFile=r.guards.Object.of({track_id:r.guards.String,file_id:r.guards.String}),t.AlbumArtist=r.guards.Object.of({album_id:r.guards.String,artist_id:r.guards.String,order:r.guards.Number}),t.TrackArtist=r.guards.Object.of({track_id:r.guards.String,artist_id:r.guards.String,order:r.guards.Number}),t.Show=r.guards.Object.of({show_id:r.guards.String,name:r.guards.String,summary:r.guards.Union.of(r.guards.Undefined,r.guards.String)}),t.ShowFile=r.guards.Object.of({show_id:r.guards.String,file_id:r.guards.String}),t.Season=r.guards.Object.of({season_id:r.guards.String,show_id:r.guards.String,number:r.guards.Number}),t.Episode=r.guards.Object.of({episode_id:r.guards.String,season_id:r.guards.String,title:r.guards.String,number:r.guards.Number,year:r.guards.Union.of(r.guards.Undefined,r.guards.Number),summary:r.guards.Union.of(r.guards.Undefined,r.guards.String)}),t.EpisodeFile=r.guards.Object.of({episode_id:r.guards.String,file_id:r.guards.String}),t.Movie=r.guards.Object.of({movie_id:r.guards.String,title:r.guards.String,year:r.guards.Union.of(r.guards.Undefined,r.guards.Number),summary:r.guards.Union.of(r.guards.Undefined,r.guards.String)}),t.MovieFile=r.guards.Object.of({movie_id:r.guards.String,file_id:r.guards.String}),t.Person=r.guards.Object.of({person_id:r.guards.String,name:r.guards.String}),t.MoviePerson=r.guards.Object.of({movie_id:r.guards.String,person_id:r.guards.String,order:r.guards.Number}),t.ShowPerson=r.guards.Object.of({show_id:r.guards.String,person_id:r.guards.String,order:r.guards.Number}),t.Genre=r.guards.Object.of({genre_id:r.guards.String,name:r.guards.String}),t.MovieGenre=r.guards.Object.of({movie_id:r.guards.String,genre_id:r.guards.String,order:r.guards.Number}),t.ShowGenre=r.guards.Object.of({show_id:r.guards.String,genre_id:r.guards.String,order:r.guards.Number}),t.Subtitle=r.guards.Object.of({subtitle_id:r.guards.String,file_id:r.guards.String}),t.Cue=r.guards.Object.of({cue_id:r.guards.String,subtitle_id:r.guards.String,start_ms:r.guards.Number,duration_ms:r.guards.Number,lines:r.guards.String}),t.User=r.guards.Object.of({user_id:r.guards.String,name:r.guards.String,username:r.guards.String,password:r.guards.String}),t.Key=r.guards.Object.of({key_id:r.guards.String,user_id:r.guards.Union.of(r.guards.Undefined,r.guards.String)}),t.Token=r.guards.Object.of({token_id:r.guards.String,user_id:r.guards.String,hash:r.guards.String,expires_ms:r.guards.Number}),t.Stream=r.guards.Object.of({stream_id:r.guards.String,user_id:r.guards.String,file_id:r.guards.String,timestamp_ms:r.guards.Number}),t.Playlist=r.guards.Object.of({playlist_id:r.guards.String,title:r.guards.String,description:r.guards.String,user_id:r.guards.String}),t.PlaylistItem=r.guards.Object.of({playlist_item_id:r.guards.String,playlist_id:r.guards.String,track_id:r.guards.String,number:r.guards.Number,added_ms:r.guards.Number}),t.Autoguard={Directory:t.Directory,File:t.File,AudioFile:t.AudioFile,ImageFile:t.ImageFile,MetadataFile:t.MetadataFile,SubtitleFile:t.SubtitleFile,VideoFile:t.VideoFile,VideoSubtitle:t.VideoSubtitle,Artist:t.Artist,Album:t.Album,AlbumFile:t.AlbumFile,Disc:t.Disc,Track:t.Track,TrackFile:t.TrackFile,AlbumArtist:t.AlbumArtist,TrackArtist:t.TrackArtist,Show:t.Show,ShowFile:t.ShowFile,Season:t.Season,Episode:t.Episode,EpisodeFile:t.EpisodeFile,Movie:t.Movie,MovieFile:t.MovieFile,Person:t.Person,MoviePerson:t.MoviePerson,ShowPerson:t.ShowPerson,Genre:t.Genre,MovieGenre:t.MovieGenre,ShowGenre:t.ShowGenre,Subtitle:t.Subtitle,Cue:t.Cue,User:t.User,Key:t.Key,Token:t.Token,Stream:t.Stream,Playlist:t.Playlist,PlaylistItem:t.PlaylistItem}},9575:(e,t)=>{function s(e){return null!=e&&e.constructor===String}Object.defineProperty(t,"__esModule",{value:!0}),t.Reader=void 0,t.Reader=class{constructor(e){this.string=e,this.offset=0,this.length=e.length}done(){return this.offset===this.length}line(){let e="";for(;!this.done();){let t=this.string[this.offset];if(this.offset+=1,"\r"===t){this.done()||"\n"===this.string[this.offset]&&(this.offset+=1);break}if("\n"===t){this.done()||"\r"===this.string[this.offset]&&(this.offset+=1);break}e+=t}return e}keep(e){let t="";for(;!(this.done()||e.indexOf(this.peek(1))>=0);)t+=this.read(1);return t}peek(e){let t=s(e)?e.length:e,r=Math.min(this.offset,this.offset+t),i=Math.max(this.offset,this.offset+t);if(r<0||r>=this.length||i<0||i>this.length)throw"Unable to read between offsets "+r+" and "+i+" because length is "+this.length+"!";let a=this.string.substring(r,i);if(s(e)&&a!==e)throw'Expected "'+e+'" but read "'+a+'"!';return a}read(e){let t=this.peek(e);return this.offset+=t.length,t}seek(e){if(e<0||e>=this.length)throw"Unable to seek to offset "+e+" because length is "+this.length+"!";this.offset=e}skip(e){let t="";for(;!(this.done()||e.indexOf(this.peek(1))<0);)t+=this.read(1);return t}tell(){return this.offset}}},4484:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.encode=t.decode=void 0;const r=s(9575);function i(e,t){let s=e.read(t.length);if(s!==t)throw'Expected "'+t+'" but read "'+s+'"!'}function a(e){let t=e.line();if(""!==t)throw'Expected a blank line but read "'+t+'"!'}function n(e){let t=null;return null!=(t=/^([0-9][0-9])[:]([0-5][0-9])[:]([0-5][0-9])[.]([0-9][0-9][0-9])$/.exec(e.peek(12)))?(e.read(12),1e3*(60*(60*parseInt(t[1],10)+parseInt(t[2],10))+parseInt(t[3],10))+parseInt(t[4],10)):null!=(t=/^([0-5][0-9])[:]([0-5][0-9])[.]([0-9][0-9][0-9])$/.exec(e.peek(9)))?(e.read(9),1e3*(60*(0+parseInt(t[1],10))+parseInt(t[2],10))+parseInt(t[3],10)):(console.log("Expected a valid timecode!"),0)}function o(e){let t=Math.floor(e/1e3);e-=1e3*t;let s=Math.floor(t/60);t-=60*s;let r=Math.floor(s/60);return s-=60*r,`${("00"+r).slice(-2)}:${("00"+s).slice(-2)}:${("00"+t).slice(-2)}.${("000"+e).slice(-3)}`}function l(e){let t=n(e);i(e," --\x3e ");let s=n(e);a(e);let r=s-t;r<0&&console.log("Expected a positive duration but read "+t+" and "+s+"!");let o=new Array;for(;;){let t=e.line();if(""===t)break;o.push(t)}return{start_ms:t,duration_ms:r,lines:o}}function d(e,t){let s=new Array;return s.push(o(e.start_ms)+" --\x3e "+o(e.start_ms+e.duration_ms)),s.push(...e.lines),s.push(""),s.join(t.eol)}t.decode=function(e){return{head:function(e){i(e,"WEBVTT");let t=e.line();return a(e),{metadata:t}}(t=new r.Reader(e)),body:function(e){let t=new Array;for(;!e.done();){let s=l(e);t.push(s)}return t=t.sort(((e,t)=>e.start_ms-t.start_ms)),{cues:t}}(t)};var t},t.encode=function(e){return function(e,t){let s=new Array;return s.push(function(e,t){let s=new Array;return s.push("WEBVTT "+e.metadata),s.push(""),s.join(t.eol)}(e.head,t)),s.push(function(e,t){let s=new Array;for(let r of e.cues)s.push(d(r,t));return s.join(t.eol)}(e.body,t)),s.join(t.eol)}(e,{eol:"\r\n"})}},1565:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.present=t.absent=void 0,t.absent=function(e){return null==e},t.present=function(e){return null!=e}},298:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.NumericSort=t.LexicalSort=t.CustomSort=t.CombinedSort=t.SearchIndex=t.RecordIndex=t.CollectionIndex=t.sorters=t.indices=void 0,t.indices=s(2546),t.sorters=s(7693);var r=s(2546);Object.defineProperty(t,"CollectionIndex",{enumerable:!0,get:function(){return r.CollectionIndex}});var i=s(2546);Object.defineProperty(t,"RecordIndex",{enumerable:!0,get:function(){return i.RecordIndex}});var a=s(2546);Object.defineProperty(t,"SearchIndex",{enumerable:!0,get:function(){return a.SearchIndex}});var n=s(7693);Object.defineProperty(t,"CombinedSort",{enumerable:!0,get:function(){return n.CombinedSort}});var o=s(7693);Object.defineProperty(t,"CustomSort",{enumerable:!0,get:function(){return o.CustomSort}});var l=s(7693);Object.defineProperty(t,"LexicalSort",{enumerable:!0,get:function(){return l.LexicalSort}});var d=s(7693);Object.defineProperty(t,"NumericSort",{enumerable:!0,get:function(){return d.NumericSort}})},2546:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SearchIndex=t.getTokens=t.RecordIndex=t.CollectionIndex=void 0;const r=s(7978),i=s(1565),a=s(7693);class n{constructor(e){this.map=new Map,this.getKey=e}insert(e){let t=this.getKey(e),s=this.map.get(t);i.absent(s)&&(s=new Set,this.map.set(t,s)),s.add(e)}lookup(e){let t=this.map.get(e);return i.present(t)?Array.from(t):new Array}remove(e){let t=this.getKey(e),s=this.map.get(t);i.present(s)&&(s.delete(e),0===s.size&&this.map.delete(t))}update(e,t){this.remove(e),this.insert(t)}static from(e,t){let s=new n(t);for(let t of e)s.insert(t);return s}static fromIndex(e,t,s,r){let i=new n(r);return t.on("insert",(e=>{i.insert(e.next)})),t.on("remove",(e=>{i.remove(e.last)})),t.on("update",(e=>{i.update(e.last,e.next)})),e.on("remove",(e=>{let r=s(e.last);for(let e of i.lookup(r))t.remove(e)})),i}}t.CollectionIndex=n;class o{constructor(e){this.map=new Map,this.getKey=e,this.router=new r.routing.MessageRouter}insertOrUpdate(e,t="replace"){let s=this.getKey(e),r=this.map.get(s);if(i.present(r)){if("combine"===t)for(let t in r){let s=r[t],a=e[t];i.present(s)&&i.absent(a)&&(e[t]=r[t])}this.map.set(s,e),this.router.route("update",{last:r,next:e}),this.router.route("*",{})}else this.map.set(s,e),this.router.route("insert",{next:e}),this.router.route("*",{})}[Symbol.iterator](){return this.map.values()}insert(e,t="replace"){this.insertOrUpdate(e,t)}length(){return this.map.size}lookup(e){let t=this.map.get(e);if(i.absent(t))throw`Expected "${e}" to match a record!`;return t}on(e,t){if(this.router.addObserver(e,t),"insert"===e)for(let e of this.map.values())t({next:e})}off(e,t){this.router.addObserver(e,t)}remove(e){let t=this.getKey(e);this.map.has(t)&&(this.map.delete(t),this.router.route("remove",{last:e}),this.router.route("*",{}))}update(e,t="replace"){this.insertOrUpdate(e,t)}static from(e,t){let s=new o(t);for(let t of e)s.insert(t);return s}}function l(e){var t;let s=e;return s=s.toLowerCase(),s=s.normalize("NFKD"),s=s.replace(/[\p{M}]/gu,""),Array.from(null!==(t=s.match(/(\p{L}+|\p{N}+)/gu))&&void 0!==t?t:[]).filter((e=>e.length>=2))}t.RecordIndex=o,t.getTokens=l;class d{constructor(e){this.map=new Map,this.getFields=e}insert(e){for(let t of this.getFields(e)){let s=l(t);for(let t of s){let s=this.map.get(t);i.absent(s)&&(s=new Set,this.map.set(t,s)),s.add(e)}}}lookup(e){var t;let s=l(e),r=s.map((e=>this.map.get(e))).filter(i.present),n=new Map;for(let e of r)for(let r of e){let e=null!==(t=n.get(r))&&void 0!==t?t:0-s.length;n.set(r,e+2)}return Array.from(n.entries()).filter((e=>e[1]>=0)).sort(a.NumericSort.increasing((e=>e[1]))).map((e=>({record:e[0],rank:e[1]})))}remove(e){for(let t of this.getFields(e)){let s=l(t);for(let t of s){let s=this.map.get(t);i.present(s)&&(s.delete(e),0===s.size&&this.map.delete(t))}}}update(e,t){this.remove(e),this.insert(t)}static from(e,t){let s=new d(t);for(let t of e)s.insert(t);return s}static fromIndex(e,t){let s=new d(t);return e.on("insert",(e=>{s.insert(e.next)})),e.on("remove",(e=>{s.remove(e.last)})),e.on("update",(e=>{s.update(e.last,e.next)})),s}}t.SearchIndex=d},7693:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.NumericSort=t.LexicalSort=t.CustomSort=t.CombinedSort=void 0;const r=s(1565);t.CombinedSort={of:(...e)=>(t,s)=>{for(let r of e){let e=r(t,s);if(0!==e)return e}return 0}},t.CustomSort={decreasing:e=>(t,s)=>{let i=e(t),a=e(s);return r.absent(i)?r.absent(a)?0:-1:r.absent(a)?r.absent(i)?0:1:(a?1:0)-(i?1:0)},increasing:e=>(t,s)=>{let i=e(t),a=e(s);return r.absent(i)?r.absent(a)?0:1:r.absent(a)?r.absent(i)?0:-1:(i?1:0)-(a?1:0)}},t.LexicalSort={decreasing:e=>(t,s)=>{let i=e(t),a=e(s);return r.absent(i)?r.absent(a)?0:-1:r.absent(a)?r.absent(i)?0:1:a.localeCompare(i)},increasing:e=>(t,s)=>{let i=e(t),a=e(s);return r.absent(i)?r.absent(a)?0:1:r.absent(a)?r.absent(i)?0:-1:i.localeCompare(a)}},t.NumericSort={decreasing:e=>(t,s)=>{let i=e(t),a=e(s);return r.absent(i)?r.absent(a)?0:-1:r.absent(a)?r.absent(i)?0:1:a-i},increasing:e=>(t,s)=>{let i=e(t),a=e(s);return r.absent(i)?r.absent(a)?0:1:r.absent(a)?r.absent(i)?0:-1:i-a}}},6618:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.pref=t.db=void 0,t.db={eng:{title:"English",iso639_1:"en",iso3166_1:"US"},swe:{title:"Swedish",iso639_1:"sv",iso3166_1:"SE"},jpn:{title:"Japanese",iso639_1:"ja",iso3166_1:"JP"}},t.pref=["swe","eng","jpn"]},1687:function(e,t,s){var r=this&&this.__awaiter||function(e,t,s,r){return new(s||(s=Promise))((function(i,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.observe=t.sendDiscoveryPacket=void 0;const i=s(6200),a=s(1565),n="224.0.0.251";let o=new Map;function l(e,t){let s=new Array;for(;;){let r=e.readUInt8(t);if(0===r){t+=1;break}if(r<192){t+=1;let i=e.slice(t,t+r);t+=r,s.push(i.toString());continue}let i=l(e,16383&e.readUInt16BE(t));s.push(i.labels.join(".")),t+=2;break}return{labels:s,offset:t}}var d;function u(e,t){return r(this,void 0,void 0,(function*(){let s=yield l(e,t);t=s.offset;let r=e.readUInt16BE(t);t+=2;let i=e.readUInt16BE(t);return t+=2,{value:s.labels.join("."),type:r,kind:i,offset:t}}))}function c(e){let t=e.packet,s=e.data_offset,r=t.readUInt8(s);s+=1;let i=t.readUInt8(s);s+=1;let a=t.readUInt8(s);s+=1;let n=t.readUInt8(s);return s+=1,{ipv4:`${r}.${i}.${a}.${n}`}}function f(e){let t=e.packet,s=e.data_offset,r=l(t,s);return s=r.offset,{to:r.labels.join(".")}}function g(e){return{content:l(e.packet,e.data_offset).labels}}function p(e){let t=e.packet,s=e.data_offset,r=t.readUInt16BE(s);s+=2;let i=t.readUInt16BE(s);s+=2;let a=t.readUInt16BE(s);s+=2;let n=l(t,s);return s=n.offset,{priority:r,weight:i,port:a,to:n.labels.join(".")}}function h(e,t){let s=l(e,t);t=s.offset;let r=e.readUInt16BE(t);t+=2;let i=e.readUInt16BE(t);t+=2;let a=e.readUInt32BE(t);t+=4;let n=e.readUInt16BE(t),o=t+=2;if(o+n>e.length)throw"Invalid buffer length!";return t+=n,{name:s.labels.join("."),type:r,kind:i,ttl:a,packet:e,data_offset:o,data_length:n}}function m(e,t){for(let s of[...t.answers,...t.authorities,...t.additionals])if(s.name===e.hostname&&s.type===d.TXT)try{let t=g(s);e=Object.assign(Object.assign({},e),{service_info:t.content})}catch(e){}for(let s of[...t.answers,...t.authorities,...t.additionals])if(s.name===e.hostname){if(s.type===d.A){let t=c(s);return Object.assign(Object.assign({},e),{hostname:t.ipv4})}if(s.type===d.PTR){let r=f(s);return m(e=Object.assign(Object.assign({},e),{hostname:r.to}),t)}if(s.type===d.SRV){let r=p(s);return m(e=Object.assign(Object.assign({},e),{hostname:r.to}),t)}}}!function(e){e[e.A=1]="A",e[e.PTR=12]="PTR",e[e.TXT=16]="TXT",e[e.SRV=33]="SRV"}(d||(d={}));const y=i.createSocket({type:"udp4",reuseAddr:!0});function b(e){let t=Array(),s=Buffer.alloc(12);s.writeUInt16BE(1,4),t.push(s);for(let s of e.split(".")){if(s.length>=64)throw"Expected a label with a length less than 64!";let e=Buffer.alloc(1+s.length);e.writeUInt8(s.length,0),e.write(s,1),t.push(e)}let r=Buffer.alloc(5);r.writeUInt8(0,0),r.writeUInt16BE(12,1),r.writeUInt16BE(1,3),t.push(r),y.send(Buffer.concat(t),5353,n)}y.on("listening",(()=>{y.setMulticastLoopback(!1),y.addMembership(n,"0.0.0.0")})),y.on("message",(e=>r(void 0,void 0,void 0,(function*(){try{!function(e){for(let t of e.answers){let s=t.name,r=o.get(s);if(a.present(r)){let t=m({hostname:s},e);if(a.present(t))for(let e of r)e(t)}}}(yield function(e){return r(this,void 0,void 0,(function*(){let t=0,s=e.slice(t,t+12);t+=12,s.readUInt16BE(0),s.readUInt16BE(2);let r=s.readUInt16BE(4),i=s.readUInt16BE(6),a=s.readUInt16BE(8),n=s.readUInt16BE(10),o=new Array;for(let s=0;s<r;s++){let s=yield u(e,t);o.push(s),t=s.offset}let l=new Array;for(let s=0;s<i;s++){let s=yield h(e,t);l.push(s),t=s.data_offset+s.data_length}let d=new Array;for(let s=0;s<a;s++){let s=yield h(e,t);d.push(s),t=s.data_offset+s.data_length}let c=new Array;for(let s=0;s<n;s++){let s=yield h(e,t);c.push(s),t=s.data_offset+s.data_length}return{buffer:e,questions:o,answers:l,authorities:d,additionals:c}}))}(e))}catch(e){console.log("Expected a valid DNS packet!"),console.log(e)}})))),y.bind(5353),t.sendDiscoveryPacket=b,t.observe=function(e,t){let s=o.get(e);return a.absent(s)&&(s=new Set,o.set(e,s)),s.add(t),b(e),{cancel(){let s=o.get(e);a.present(s)&&(s.delete(t),0===s.size&&o.delete(e))}}}},6440:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ArrayObservable=t.computed=t.ObservableClass=void 0;class s{constructor(e){this.state=e,this.observers=new Array}addObserver(e){let t=new s(e(this.state));return this.observers.push((s=>{t.updateState(e(s))})),t.addObserver.bind(t)}getState(){return this.state}updateState(e){if(e!==this.state){this.state=e;for(let e of this.observers)e(this.state)}}}t.ObservableClass=s,t.computed=function(e,...t){let r=new s(e(...t.map((e=>e.getState())))),i=()=>{r.updateState(e(...t.map((e=>e.getState()))))};for(let e of t)e.addObserver(i);return r},t.ArrayObservable=class{constructor(e){this.state=e,this.observers=new Array}addObserver(e){var t;this.observers.push(e);for(let s of this.state)null===(t=e.onappend)||void 0===t||t.call(e,s)}compute(e){let t=new s(e(this.state));return this.observers.push({onappend:s=>{t.updateState(e(this.state))},onsplice:(s,r)=>{t.updateState(e(this.state))}}),t.addObserver.bind(t)}getState(){return this.state}append(e){var t;this.state.push(e);for(let s of this.observers)null===(t=s.onappend)||void 0===t||t.call(s,e)}splice(e){var t;if(e<0||e>=this.state.length)throw`Expected an index of at most ${this.state.length}, got ${e}!`;let s=this.state[e];this.state.splice(e,1);for(let r of this.observers)null===(t=r.onsplice)||void 0===t||t.call(r,s,e)}update(e){for(let e=this.state.length-1;e>=0;e--)this.splice(e);for(let t of e)this.append(t)}}},4676:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ContextClient=void 0;const r=s(1565),i=s(6440),a=s(14),n=s(7578);t.ContextClient=class{constructor(e,t=(e=>new WebSocket(e))){this.estimatedProgress=new i.ObservableClass(void 0),this.estimatedProgressTimestamp=new i.ObservableClass(void 0),this.token=new i.ObservableClass(void 0),this.localDevice=new i.ObservableClass(void 0),this.devices=new i.ArrayObservable(new Array),this.device=new i.ObservableClass(void 0),this.isDeviceLocal=new i.ObservableClass(!1),this.isDeviceRemote=new i.ObservableClass(!1),this.context=new i.ObservableClass(void 0),this.contextPath=new i.ObservableClass(void 0),this.flattenedContext=new i.ObservableClass(void 0),this.lastIndex=new i.ObservableClass(void 0),this.lastEntry=new i.ObservableClass(void 0),this.lastLocalEntry=new i.ObservableClass(void 0),this.currentIndex=new i.ObservableClass(void 0),this.currentEntry=new i.ObservableClass(void 0),this.currentLocalEntry=new i.ObservableClass(void 0),this.nextIndex=new i.ObservableClass(void 0),this.nextEntry=new i.ObservableClass(void 0),this.nextLocalEntry=new i.ObservableClass(void 0),this.playback=new i.ObservableClass(!1),this.progress=new i.ObservableClass(void 0),this.localPlayback=new i.ObservableClass(!1),this.canPlayLast=new i.ObservableClass(!1),this.canPlayCurrent=new i.ObservableClass(!1),this.canPlayNext=new i.ObservableClass(!1),this.isCurrentEntryVideo=new i.ObservableClass(!1),this.isOnline=new i.ObservableClass(!1),this.tsc=new n.TypeSocketClient(e,t,a.messages.Autoguard),this.tsc.addEventListener("sys","connect",(()=>{this.isOnline.updateState(!0)})),this.tsc.addEventListener("sys","disconnect",(()=>{this.isOnline.updateState(!1)})),this.context.addObserver((e=>{if(r.present(e))if(a.objects.ContextAlbum.is(e)){let t=[],s=e;for(let e of s.discs)t.push(...e.tracks);this.flattenedContext.updateState(t)}else if(a.objects.ContextArtist.is(e)){let t=[],s=e;for(let e of s.albums)for(let s of e.discs)t.push(...s.tracks);this.flattenedContext.updateState(t)}else if(a.objects.ContextEpisode.is(e)){let t=[],s=e;t.push(s),this.flattenedContext.updateState(t)}else if(a.objects.ContextMovie.is(e)){let t=[],s=e;t.push(s),this.flattenedContext.updateState(t)}else if(a.objects.ContextPlaylist.is(e)){let t=[],s=e;for(let e of s.items)t.push(e.track);this.flattenedContext.updateState(t)}else if(a.objects.ContextSeason.is(e)){let t=[],s=e;t.push(...s.episodes),this.flattenedContext.updateState(t)}else if(a.objects.ContextShow.is(e)){let t=[],s=e;for(let e of s.seasons)t.push(...e.episodes);this.flattenedContext.updateState(t)}else{if(!a.objects.ContextTrack.is(e))throw"Expected code to be unreachable!";{let t=[],s=e;t.push(s),this.flattenedContext.updateState(t)}}}));{let e=()=>{let e=this.context.getState(),t=this.currentIndex.getState();if(r.present(e)&&r.present(t)){if(a.objects.ContextAlbum.is(e)){let s=0,r=t,i=e.discs;for(let e=0;e<i.length;e++){let t=i[e].tracks.length;if(!(r>=t))break;s+=1,r-=t}return this.contextPath.updateState([e.album_id,e.discs[s].disc_id,e.discs[s].tracks[r].track_id])}if(a.objects.ContextArtist.is(e)){let s=0,r=0,i=t,a=e.albums;e:for(let e=0;e<a.length;e++){let t=a[e].discs;for(let e=0;e<t.length;e++){let s=t[e].tracks.length;if(!(i>=s))break e;r+=1,i-=s}s+=1,r=0}return this.contextPath.updateState([e.artist_id,e.albums[s].album_id,e.albums[s].discs[r].disc_id,e.albums[s].discs[r].tracks[i].track_id])}if(a.objects.ContextEpisode.is(e))return this.contextPath.updateState([e.episode_id]);if(a.objects.ContextMovie.is(e))return this.contextPath.updateState([e.movie_id]);if(a.objects.ContextPlaylist.is(e)){let s=t;return this.contextPath.updateState([e.playlist_id,e.items[s].track.track_id])}if(a.objects.ContextShow.is(e)){let s=0,r=t,i=e.seasons;for(let e=0;e<i.length;e++){let t=i[e].episodes.length;if(!(r>=t))break;s+=1,r-=t}return this.contextPath.updateState([e.show_id,e.seasons[s].season_id,e.seasons[s].episodes[r].episode_id])}if(a.objects.ContextSeason.is(e)){let s=t;return this.contextPath.updateState([e.season_id,e.episodes[s].episode_id])}if(a.objects.ContextTrack.is(e))return this.contextPath.updateState([e.track_id]);throw"Expected code to be unreachable!"}this.contextPath.updateState(void 0)};this.context.addObserver(e),this.currentIndex.addObserver(e)}this.lastEntry.addObserver((e=>{this.canPlayLast.updateState(r.present(e))})),this.currentEntry.addObserver((e=>{this.canPlayCurrent.updateState(r.present(e))})),this.nextEntry.addObserver((e=>{this.canPlayNext.updateState(r.present(e))})),this.progress.addObserver((e=>{this.estimatedProgress.updateState(e),this.estimatedProgressTimestamp.updateState(Date.now())})),this.playback.addObserver((e=>{let t=this.estimatedProgress.getState(),s=this.estimatedProgressTimestamp.getState(),i=Date.now();e||r.present(t)&&r.present(s)&&this.estimatedProgress.updateState(t+(i-s)/1e3),this.estimatedProgressTimestamp.updateState(i)})),this.estimatedProgress.addObserver((e=>{console.log("Estimated progress to "+(null!=e?e:0))}));{let e=()=>{let e=this.playback.getState(),t=this.isDeviceLocal.getState();this.localPlayback.updateState(t&&e)};this.playback.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.lastEntry.getState(),t=this.isDeviceLocal.getState();this.lastLocalEntry.updateState(t?e:void 0)};this.lastEntry.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.currentEntry.getState(),t=this.isDeviceLocal.getState();this.currentLocalEntry.updateState(t?e:void 0)};this.currentEntry.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.nextEntry.getState(),t=this.isDeviceLocal.getState();this.nextLocalEntry.updateState(t?e:void 0)};this.nextEntry.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.localDevice.getState(),t=this.device.getState();return r.present(e)&&r.present(t)&&e.id===t.id?this.isDeviceLocal.updateState(!0):this.isDeviceLocal.updateState(!1)};this.localDevice.addObserver(e),this.device.addObserver(e)}{let e=()=>{let e=this.localDevice.getState(),t=this.device.getState();return r.present(e)&&r.present(t)&&e.id!==t.id?this.isDeviceRemote.updateState(!0):this.isDeviceRemote.updateState(!1)};this.localDevice.addObserver(e),this.device.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.currentIndex.getState();if(r.present(e)&&r.present(t)){let s=t-1;if(s>=0&&s<e.length)return this.lastIndex.updateState(s)}return this.lastIndex.updateState(void 0)};this.flattenedContext.addObserver(e),this.currentIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.currentIndex.getState();if(r.present(e)&&r.present(t)){let s=t+1;if(s>=0&&s<e.length)return this.nextIndex.updateState(s)}return this.nextIndex.updateState(void 0)};this.flattenedContext.addObserver(e),this.currentIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.lastIndex.getState();return r.present(e)&&r.present(t)?this.lastEntry.updateState(e[t]):this.lastEntry.updateState(void 0)};this.flattenedContext.addObserver(e),this.lastIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.currentIndex.getState();return r.present(e)&&r.present(t)&&t>=0&&t+0<e.length?this.currentEntry.updateState(e[t+0]):this.currentEntry.updateState(void 0)};this.flattenedContext.addObserver(e),this.currentIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.nextIndex.getState();return r.present(e)&&r.present(t)?this.nextEntry.updateState(e[t]):this.nextEntry.updateState(void 0)};this.flattenedContext.addObserver(e),this.nextIndex.addObserver(e)}this.tsc.addEventListener("app","SetLocalDevice",(e=>{this.localDevice.updateState(e.device)})),this.tsc.addEventListener("app","SetDevices",(e=>{this.devices.update(e.devices)})),this.tsc.addEventListener("app","SetContext",(e=>{this.context.updateState(e.context)})),this.tsc.addEventListener("app","SetDevice",(e=>{this.device.updateState(e.device)})),this.tsc.addEventListener("app","SetIndex",(e=>{this.currentIndex.updateState(e.index)})),this.tsc.addEventListener("app","SetPlayback",(e=>{this.playback.updateState(e.playback)})),this.tsc.addEventListener("app","SetProgress",(e=>{this.progress.updateState(e.progress)})),this.tsc.addEventListener("app","SetToken",(e=>{this.token.updateState(e.token)})),this.isOnline.addObserver((e=>{e||(this.context.updateState(void 0),this.currentIndex.updateState(void 0),this.playback.updateState(!1),this.progress.updateState(void 0))})),i.computed(((e,t)=>{e&&this.tsc.send("SetToken",{token:t})}),this.isOnline,this.token)}play(e,t){this.isCurrentEntryVideo.updateState(!1),this.tsc.send("SetContext",{context:e}),this.tsc.send("SetIndex",{index:t}),this.tsc.send("SetPlayback",{playback:!0})}authenticate(e){this.token.updateState(e)}close(){this.tsc.close()}last(){let e=this.lastIndex.getState();r.present(e)?(this.currentIndex.updateState(e),this.tsc.send("SetIndex",{index:e})):this.pause()}next(){let e=this.nextIndex.getState();r.present(e)?(this.currentIndex.updateState(e),this.tsc.send("SetIndex",{index:e})):this.pause()}pause(){this.playback.updateState(!1),this.tsc.send("SetPlayback",{playback:!1})}playAlbum(e,t,s){let i=0;if(r.present(t)){let a=e.discs;if(t<0||t>=a.length)throw`Expected ${t} to be a number between 0 and ${a.length}!`;if(i+=a.slice(0,t).reduce(((e,t)=>e+t.tracks.length),0),r.present(s)){let e=a[t].tracks;if(s<0||s>=e.length)throw`Expected ${s} to be a number between 0 and ${e.length}!`;i+=s}}return this.play(e,i)}playArtist(e,t,s,i){let a=0;if(r.present(t)){let n=e.albums;if(t<0||t>=n.length)throw`Expected ${t} to be a number between 0 and ${n.length}!`;if(a+=n.slice(0,t).reduce(((e,t)=>e+t.discs.reduce(((e,t)=>e+t.tracks.length),0)),0),r.present(s)){let e=n[t].discs;if(s<0||s>=e.length)throw`Expected ${s} to be a number between 0 and ${e.length}!`;if(a+=e.slice(0,s).reduce(((e,t)=>e+t.tracks.length),0),r.present(i)){let t=e[s].tracks;if(i<0||i>=t.length)throw`Expected ${i} to be a number between 0 and ${t.length}!`;a+=i}}}return this.play(e,a)}playDisc(e,t){let s=0;if(r.present(t)){let r=e.tracks;if(t<0||t>=r.length)throw`Expected ${t} to be a number between 0 and ${r.length}!`;s+=t}return this.play(e,s)}playEpisode(e){this.play(e,0)}playMovie(e){this.play(e,0)}playPlaylist(e,t){let s=0;if(r.present(t)){let r=e.items;if(t<0||t>=r.length)throw`Expected ${t} to be a number between 0 and ${r.length}!`;s+=t}return this.play(e,s)}playSeason(e,t){let s=0;if(r.present(t)){let r=e.episodes;if(t<0||t>=r.length)throw`Expected ${t} to be a number between 0 and ${r.length}!`;s+=t}return this.play(e,s)}playShow(e,t,s){let i=0;if(r.present(t)){let a=e.seasons;if(t<0||t>=a.length)throw`Expected ${t} to be a number between 0 and ${a.length}!`;if(i+=a.slice(0,t).reduce(((e,t)=>e+t.episodes.length),0),r.present(s)){let e=a[t].episodes;if(s<0||s>=e.length)throw`Expected ${s} to be a number between 0 and ${e.length}!`;i+=s}}return this.play(e,i)}playTrack(e){this.play(e,0)}reconnect(){this.tsc.reconnect()}resume(){this.canPlayCurrent.getState()&&(this.playback.updateState(!0),this.tsc.send("SetPlayback",{playback:!0}))}seek(e){this.progress.updateState(e),this.tsc.send("SetProgress",{progress:e})}toggle(){this.playback.getState()?this.pause():this.resume()}transfer(e){this.tsc.send("SetDevice",{device:e})}}},4617:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.schema=t.server=t.client=void 0,t.client=s(4676),t.server=s(358),t.schema=s(14)},14:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.objects=t.messages=void 0,t.messages=s(6139),t.objects=s(7234)},6139:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Autoguard=t.SetToken=t.SetProgress=t.SetPlayback=t.SetLocalDevice=t.SetIndex=t.SetDevices=t.SetDevice=t.SetContext=void 0;const r=s(7234),i=s(7234),a=s(9175);t.SetContext=a.guards.Object.of({context:a.guards.Union.of(a.guards.Undefined,a.guards.Reference.of((()=>r.Context)))}),t.SetDevice=a.guards.Object.of({device:a.guards.Union.of(a.guards.Undefined,a.guards.Reference.of((()=>i.Device)))}),t.SetDevices=a.guards.Object.of({devices:a.guards.Array.of(a.guards.Reference.of((()=>i.Device)))}),t.SetIndex=a.guards.Object.of({index:a.guards.Union.of(a.guards.Undefined,a.guards.Number)}),t.SetLocalDevice=a.guards.Object.of({device:a.guards.Reference.of((()=>i.Device))}),t.SetPlayback=a.guards.Object.of({playback:a.guards.Boolean}),t.SetProgress=a.guards.Object.of({progress:a.guards.Union.of(a.guards.Undefined,a.guards.Number)}),t.SetToken=a.guards.Object.of({token:a.guards.Union.of(a.guards.Undefined,a.guards.String)}),t.Autoguard={SetContext:t.SetContext,SetDevice:t.SetDevice,SetDevices:t.SetDevices,SetIndex:t.SetIndex,SetLocalDevice:t.SetLocalDevice,SetPlayback:t.SetPlayback,SetProgress:t.SetProgress,SetToken:t.SetToken}},7234:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Autoguard=t.Session=t.Device=t.ContextItem=t.Context=t.ContextEpisode=t.ContextSeason=t.ContextShow=t.ContextMovie=t.ContextPlaylist=t.ContextTrack=t.ContextDisc=t.ContextArtist=t.ContextAlbum=void 0;const r=s(5447),i=s(5447),a=s(5447),n=s(5447),o=s(5447),l=s(5447),d=s(5447),u=s(5447),c=s(5447),f=s(9175);t.ContextAlbum=f.guards.Reference.of((()=>r.Album)),t.ContextArtist=f.guards.Reference.of((()=>i.Artist)),t.ContextDisc=f.guards.Reference.of((()=>a.Disc)),t.ContextTrack=f.guards.Reference.of((()=>c.Track)),t.ContextPlaylist=f.guards.Reference.of((()=>l.Playlist)),t.ContextMovie=f.guards.Reference.of((()=>o.Movie)),t.ContextShow=f.guards.Reference.of((()=>u.Show)),t.ContextSeason=f.guards.Reference.of((()=>d.Season)),t.ContextEpisode=f.guards.Reference.of((()=>n.Episode)),t.Context=f.guards.Union.of(f.guards.Reference.of((()=>t.ContextAlbum)),f.guards.Reference.of((()=>t.ContextArtist)),f.guards.Reference.of((()=>t.ContextDisc)),f.guards.Reference.of((()=>t.ContextTrack)),f.guards.Reference.of((()=>t.ContextPlaylist)),f.guards.Reference.of((()=>t.ContextMovie)),f.guards.Reference.of((()=>t.ContextShow)),f.guards.Reference.of((()=>t.ContextSeason)),f.guards.Reference.of((()=>t.ContextEpisode))),t.ContextItem=f.guards.Union.of(f.guards.Reference.of((()=>t.ContextTrack)),f.guards.Reference.of((()=>t.ContextMovie)),f.guards.Reference.of((()=>t.ContextEpisode))),t.Device=f.guards.Object.of({id:f.guards.String,protocol:f.guards.String,name:f.guards.String,type:f.guards.String}),t.Session=f.guards.Object.of({context:f.guards.Union.of(f.guards.Undefined,f.guards.Reference.of((()=>t.Context))),device:f.guards.Union.of(f.guards.Undefined,f.guards.Reference.of((()=>t.Device))),index:f.guards.Union.of(f.guards.Undefined,f.guards.Number),playback:f.guards.Boolean,progress:f.guards.Union.of(f.guards.Undefined,f.guards.Number)}),t.Autoguard={ContextAlbum:t.ContextAlbum,ContextArtist:t.ContextArtist,ContextDisc:t.ContextDisc,ContextTrack:t.ContextTrack,ContextPlaylist:t.ContextPlaylist,ContextMovie:t.ContextMovie,ContextShow:t.ContextShow,ContextSeason:t.ContextSeason,ContextEpisode:t.ContextEpisode,Context:t.Context,ContextItem:t.ContextItem,Device:t.Device,Session:t.Session}},358:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ContextServer=void 0;const r=s(8835),i=s(3601),a=s(1565),n=s(6440),o=s(14),l=s(8907);function d(e,t){var s;let r=null!==(s=e.query[t])&&void 0!==s?s:[];return Array.isArray(r)?r:[r]}function u(e,t){var s,i,a;let n=r.parse(t,!0);return{id:e,protocol:null!==(s=d(n,"protocol").pop())&&void 0!==s?s:"",name:null!==(i=d(n,"name").pop())&&void 0!==i?i:"",type:null!==(a=d(n,"type").pop())&&void 0!==a?a:""}}t.ContextServer=class{constructor(){this.tokens=new Map,this.sessions=new Map,this.chromecasts=new n.ObservableClass([]),this.tss=new l.TypeSocketServer(o.messages.Autoguard),this.tss.addEventListener("sys","connect",(e=>{console.log("connect: "+e.connection_url);let t=u(e.connection_id,e.connection_url);this.tss.send("SetLocalDevice",e.connection_id,{device:t}),"cast"!==t.protocol&&"airplay"!==t.protocol||this.chromecasts.updateState([...this.chromecasts.getState(),t])})),this.tss.addEventListener("sys","disconnect",(e=>{console.log("disconnect: "+e.connection_url);let t=u(e.connection_id,e.connection_url);this.revokeAuthentication(e.connection_id),"cast"!==t.protocol&&"airplay"!==t.protocol||this.chromecasts.updateState(this.chromecasts.getState().filter((e=>e.id!==t.id)))})),this.tss.addEventListener("app","SetToken",(e=>{this.revokeAuthentication(e.connection_id);let t=e.data.token;if(a.present(t)){let s=i.getUserId(t);this.tokens.set(e.connection_id,t);let r=this.getSession(s),a=u(e.connection_id,e.connection_url);r.devices.updateState([...r.devices.getState(),a]),this.tss.send("SetContext",e.connection_id,{context:r.context}),this.tss.send("SetDevice",e.connection_id,{device:r.device}),this.tss.send("SetIndex",e.connection_id,{index:r.index}),this.tss.send("SetPlayback",e.connection_id,{playback:r.playback}),this.tss.send("SetProgress",e.connection_id,{progress:r.progress}),this.tss.send("SetToken",e.connection_id,{token:t})}})),this.tss.addEventListener("app","SetContext",(e=>{this.getExistingSession(e.connection_id,(t=>{a.absent(t.device)&&(t.device=u(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),t.index=void 0,this.tss.send("SetIndex",t.devices.getState().map((e=>e.id)),{index:t.index}),t.context=e.data.context,this.tss.send("SetContext",t.devices.getState().map((e=>e.id)),e.data)}))})),this.tss.addEventListener("app","SetDevice",(e=>{this.getExistingSession(e.connection_id,(t=>{this.updateProgress(t),this.tss.send("SetProgress",t.devices.getState().map((e=>e.id)),{progress:t.progress}),t.device=e.data.device,this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),e.data),a.present(t.device)&&this.tss.send("SetToken",t.device.id,{token:this.tokens.get(e.connection_id)})}))})),this.tss.addEventListener("app","SetIndex",(e=>{this.getExistingSession(e.connection_id,(t=>{a.absent(t.device)&&(t.device=u(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),t.progress=a.present(e.data.index)?0:void 0,t.progressTimestamp=Date.now(),this.tss.send("SetProgress",t.devices.getState().map((e=>e.id)),{progress:t.progress}),t.index=e.data.index,this.tss.send("SetIndex",t.devices.getState().map((e=>e.id)),e.data)}))})),this.tss.addEventListener("app","SetPlayback",(e=>{this.getExistingSession(e.connection_id,(t=>{a.absent(t.device)&&(t.device=u(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),this.updateProgress(t),t.playback=e.data.playback,this.tss.send("SetPlayback",t.devices.getState().map((e=>e.id)),e.data)}))})),this.tss.addEventListener("app","SetProgress",(e=>{this.getExistingSession(e.connection_id,(t=>{a.absent(t.device)&&(t.device=u(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),t.progress=e.data.progress,t.progressTimestamp=Date.now(),this.tss.send("SetProgress",t.devices.getState().map((e=>e.id)),e.data)}))}))}getExistingSession(e,t){let s=this.tokens.get(e);if(a.present(s)){let e=i.getUserId(s),r=this.sessions.get(e);a.present(r)&&t(r)}}getSession(e){let t=this.sessions.get(e);if(a.present(t))return t;const s={playback:!1,devices:new n.ObservableClass(new Array)};let r=new n.ObservableClass([]);{let e=()=>{let e=s.devices.getState(),t=this.chromecasts.getState().filter((t=>a.absent(e.find((e=>e.id===t.id)))));r.updateState([...e,...t])};s.devices.addObserver(e),this.chromecasts.addObserver(e)}return r.addObserver((e=>{this.tss.send("SetDevices",s.devices.getState().map((e=>e.id)),{devices:e})})),s.devices.addObserver((e=>{this.updateProgress(s)})),s.devices.addObserver((e=>{a.absent(e.find((e=>{var t;return e.id===(null===(t=s.device)||void 0===t?void 0:t.id)})))&&(this.updateProgress(s),s.playback=!1,this.tss.send("SetPlayback",e.map((e=>e.id)),{playback:s.playback}),s.device=void 0,this.tss.send("SetDevice",e.map((e=>e.id)),{device:s.device}))})),this.sessions.set(e,s),s}revokeAuthentication(e){let t=this.tokens.get(e);if(this.tokens.delete(e),a.present(t)){let s=i.getUserId(t),r=this.sessions.get(s);if(a.present(r)){let t=r.devices;t.updateState(t.getState().filter((t=>t.id!==e)))}}}updateProgress(e){let t=Date.now();e.playback&&a.present(e.progress)&&a.present(e.progressTimestamp)&&(e.progress+=(t-e.progressTimestamp)/1e3),e.progressTimestamp=t}getRequestHandler(){return this.tss.getRequestHandler()}}},3756:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PlaylistsClient=void 0;const r=s(6440),i=s(298),a=s(9696),n=s(7578);t.PlaylistsClient=class{constructor(e,t=(e=>new WebSocket(e))){this.token=new r.ObservableClass(void 0),this.online=new r.ObservableClass(!1),this.playlists=new r.ArrayObservable(new Array),this.tsc=new n.TypeSocketClient(e,t,a.Autoguard),this.tsc.addEventListener("sys","connect",(()=>{this.online.updateState(!0)})),this.tsc.addEventListener("sys","disconnect",(()=>{this.online.updateState(!1)})),r.computed(((e,t)=>{e&&this.tsc.send("SetToken",{token:t})}),this.online,this.token),this.tsc.addEventListener("app","CreatePlaylist",(e=>{for(let[t,s]of this.playlists.getState().entries())s.getState().playlist_id===e.playlist.playlist_id&&this.playlists.splice(t-0);let t=Object.assign(Object.assign({},e.playlist),{items:new Array});this.playlists.append(new r.ObservableClass(t))})),this.tsc.addEventListener("app","DeletePlaylist",(e=>{for(let[t,s]of this.playlists.getState().entries())s.getState().playlist_id===e.playlist.playlist_id&&this.playlists.splice(t-0)})),this.tsc.addEventListener("app","UpdatePlaylist",(e=>{for(let[t,s]of this.playlists.getState().entries()){let t=s.getState();t.playlist_id===e.playlist.playlist_id&&s.updateState(Object.assign(Object.assign({},t),e.playlist))}})),this.tsc.addEventListener("app","CreatePlaylistItem",(e=>{for(let[t,s]of this.playlists.getState().entries()){let t=s.getState();if(t.playlist_id===e.playlist_item.playlist.playlist_id){let r=t.items.filter((t=>t.playlist_item_id!==e.playlist_item.playlist_item_id)),a=t.items.length-r.length;r.push(e.playlist_item);let n=1;r=r.map((t=>Object.assign(Object.assign({},t),{number:t.number+(t.number>e.playlist_item.number?n-a:0)}))).sort(i.NumericSort.increasing((e=>e.number))),t=Object.assign(Object.assign({},t),{items:r}),s.updateState(t)}}})),this.tsc.addEventListener("app","DeletePlaylistItem",(e=>{for(let[t,s]of this.playlists.getState().entries()){let t=s.getState();if(t.playlist_id===e.playlist_item.playlist.playlist_id){let r=t.items.filter((t=>t.playlist_item_id!==e.playlist_item.playlist_item_id)),a=t.items.length-r.length,n=0;r=r.map((t=>Object.assign(Object.assign({},t),{number:t.number+(t.number>e.playlist_item.number?n-a:0)}))).sort(i.NumericSort.increasing((e=>e.number))),t=Object.assign(Object.assign({},t),{items:r}),s.updateState(t)}}})),this.tsc.addEventListener("app","UpdatePlaylistItem",(e=>{for(let[t,s]of this.playlists.getState().entries()){let t=s.getState();if(t.playlist_id===e.playlist_item.playlist.playlist_id){let r=t.items.findIndex((t=>t.playlist_item_id===e.playlist_item.playlist_item_id));if(r>=0){let i=e.playlist_item.number-1;if(i>r){for(let e=r+1;e<i;e++)t.items[e].number-=1;t.items.splice(i,0,...t.items.splice(r,1))}else if(i<r){for(let e=i;e<r;e++)t.items[e].number+=1;t.items.splice(i,0,...t.items.splice(r,1))}t.items[i]=Object.assign(Object.assign({},t.items[i]),e.playlist_item),s.updateState(Object.assign({},t))}}}}))}authenticate(e){this.token.updateState(e)}isOnline(){return this.online.getState()}getPermissions(e){return this.tsc.request("PermissionsRequest","PermissionsResponse",e)}createPlaylist(e){return this.tsc.request("CreatePlaylistRequest","CreatePlaylistResponse",e)}deletePlaylist(e){return this.tsc.request("DeletePlaylistRequest","DeletePlaylistResponse",e)}updatePlaylist(e){return this.tsc.request("UpdatePlaylistRequest","UpdatePlaylistResponse",e)}createPlaylistItem(e){return this.tsc.request("CreatePlaylistItemRequest","CreatePlaylistItemResponse",e)}deletePlaylistItem(e){return this.tsc.request("DeletePlaylistItemRequest","DeletePlaylistItemResponse",e)}updatePlaylistItem(e){return this.tsc.request("UpdatePlaylistItemRequest","UpdatePlaylistItemResponse",e)}close(){this.tsc.close()}reconnect(){this.tsc.reconnect()}}},3188:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.schema=t.server=t.client=void 0,t.client=s(3756),t.server=s(2778),t.schema=s(4831)},4831:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.objects=t.messages=void 0,t.messages=s(9696),t.objects=s(7223)},9696:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Autoguard=t.UpdatePlaylistItem=t.UpdatePlaylistItemResponse=t.UpdatePlaylistItemRequest=t.DeletePlaylistItem=t.DeletePlaylistItemResponse=t.DeletePlaylistItemRequest=t.CreatePlaylistItem=t.CreatePlaylistItemResponse=t.CreatePlaylistItemRequest=t.UpdatePlaylist=t.UpdatePlaylistResponse=t.UpdatePlaylistRequest=t.DeletePlaylist=t.DeletePlaylistResponse=t.DeletePlaylistRequest=t.CreatePlaylist=t.CreatePlaylistResponse=t.CreatePlaylistRequest=t.PermissionsResponse=t.PermissionsRequest=t.SetToken=void 0;const r=s(5447),i=s(5447),a=s(9175);t.SetToken=a.guards.Object.of({token:a.guards.Union.of(a.guards.Undefined,a.guards.String)}),t.PermissionsRequest=a.guards.Object.of({playlist:a.guards.Object.of({playlist_id:a.guards.String})}),t.PermissionsResponse=a.guards.Object.of({permissions:a.guards.Union.of(a.guards.StringLiteral.of("read"),a.guards.StringLiteral.of("write"))}),t.CreatePlaylistRequest=a.guards.Object.of({playlist:a.guards.Object.of({title:a.guards.String,description:a.guards.String})}),t.CreatePlaylistResponse=a.guards.Object.of({errors:a.guards.Array.of(a.guards.String),playlist_id:a.guards.String}),t.CreatePlaylist=a.guards.Object.of({playlist:a.guards.Reference.of((()=>r.PlaylistBase))}),t.DeletePlaylistRequest=a.guards.Object.of({playlist:a.guards.Object.of({playlist_id:a.guards.String})}),t.DeletePlaylistResponse=a.guards.Object.of({errors:a.guards.Array.of(a.guards.String)}),t.DeletePlaylist=a.guards.Object.of({playlist:a.guards.Reference.of((()=>r.PlaylistBase))}),t.UpdatePlaylistRequest=a.guards.Object.of({playlist:a.guards.Object.of({playlist_id:a.guards.String,title:a.guards.String,description:a.guards.String})}),t.UpdatePlaylistResponse=a.guards.Object.of({errors:a.guards.Array.of(a.guards.String)}),t.UpdatePlaylist=a.guards.Object.of({playlist:a.guards.Reference.of((()=>r.PlaylistBase))}),t.CreatePlaylistItemRequest=a.guards.Object.of({playlist_item:a.guards.Object.of({playlist_id:a.guards.String,track_id:a.guards.String})}),t.CreatePlaylistItemResponse=a.guards.Object.of({errors:a.guards.Array.of(a.guards.String),playlist_item_id:a.guards.String}),t.CreatePlaylistItem=a.guards.Object.of({playlist_item:a.guards.Reference.of((()=>i.PlaylistItemBase))}),t.DeletePlaylistItemRequest=a.guards.Object.of({playlist_item:a.guards.Object.of({playlist_item_id:a.guards.String})}),t.DeletePlaylistItemResponse=a.guards.Object.of({errors:a.guards.Array.of(a.guards.String)}),t.DeletePlaylistItem=a.guards.Object.of({playlist_item:a.guards.Reference.of((()=>i.PlaylistItemBase))}),t.UpdatePlaylistItemRequest=a.guards.Object.of({playlist_item:a.guards.Object.of({playlist_item_id:a.guards.String,number:a.guards.Number})}),t.UpdatePlaylistItemResponse=a.guards.Object.of({errors:a.guards.Array.of(a.guards.String)}),t.UpdatePlaylistItem=a.guards.Object.of({playlist_item:a.guards.Reference.of((()=>i.PlaylistItemBase))}),t.Autoguard={SetToken:t.SetToken,PermissionsRequest:t.PermissionsRequest,PermissionsResponse:t.PermissionsResponse,CreatePlaylistRequest:t.CreatePlaylistRequest,CreatePlaylistResponse:t.CreatePlaylistResponse,CreatePlaylist:t.CreatePlaylist,DeletePlaylistRequest:t.DeletePlaylistRequest,DeletePlaylistResponse:t.DeletePlaylistResponse,DeletePlaylist:t.DeletePlaylist,UpdatePlaylistRequest:t.UpdatePlaylistRequest,UpdatePlaylistResponse:t.UpdatePlaylistResponse,UpdatePlaylist:t.UpdatePlaylist,CreatePlaylistItemRequest:t.CreatePlaylistItemRequest,CreatePlaylistItemResponse:t.CreatePlaylistItemResponse,CreatePlaylistItem:t.CreatePlaylistItem,DeletePlaylistItemRequest:t.DeletePlaylistItemRequest,DeletePlaylistItemResponse:t.DeletePlaylistItemResponse,DeletePlaylistItem:t.DeletePlaylistItem,UpdatePlaylistItemRequest:t.UpdatePlaylistItemRequest,UpdatePlaylistItemResponse:t.UpdatePlaylistItemResponse,UpdatePlaylistItem:t.UpdatePlaylistItem}},7223:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Autoguard=void 0,t.Autoguard={}},2778:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PlaylistsServer=void 0;const r=s(6417),i=s(3601),a=s(1565),n=s(4831),o=s(6321),l=s(8907),d=s(298),u=s(3834);t.PlaylistsServer=class{constructor(){this.tokens=new Map,this.sessions=new Map,this.tss=new l.TypeSocketServer(n.messages.Autoguard),this.tss.addEventListener("sys","connect",(e=>{})),this.tss.addEventListener("sys","disconnect",(e=>{this.revokeAuthentication(e.connection_id)})),this.tss.addEventListener("app","SetToken",(e=>{this.revokeAuthentication(e.connection_id);let t=e.data.token;if(a.present(t)){let s=i.getUserId(t);this.tokens.set(e.connection_id,t),this.getOrCreateSession(s).connections.add(e.connection_id);for(let t of o.getPlaylistsFromUser.lookup(s)){this.tss.send("CreatePlaylist",e.connection_id,{playlist:u.handler.lookupPlaylistBase(t.playlist_id,s)});for(let r of o.getPlaylistsItemsFromPlaylist.lookup(t.playlist_id))this.tss.send("CreatePlaylistItem",e.connection_id,{playlist_item:u.handler.lookupPlaylistItemBase(r.playlist_item_id,s)})}}})),this.tss.addEventListener("app","PermissionsRequest",(e=>{let t=this.tokens.get(e.connection_id);if(a.present(t)){let s=i.getUserId(t);o.playlists.lookup(e.data.playlist.playlist_id).user_id===s?this.tss.respond(e,"PermissionsResponse",{permissions:"write"}):this.tss.respond(e,"PermissionsResponse",{permissions:"read"})}})),this.tss.addEventListener("app","CreatePlaylistRequest",(e=>{let t=this.tokens.get(e.connection_id);if(a.present(t)){let s=i.getUserId(t),a=new Array,n=e.data.playlist.title;Buffer.from(n).length>=256&&a.push("The playlist title is too long!");let l=e.data.playlist.description;Buffer.from(l).length>=256&&a.push("The playlist description is too long!");let d=r.randomBytes(16).toString("hex");if(this.tss.respond(e,"CreatePlaylistResponse",{errors:a,playlist_id:d}),a.length>0)return;let c={playlist_id:d,title:n,description:l,user_id:s};o.playlists.insert(c);let f=this.getOrCreateSession(s);this.tss.send("CreatePlaylist",Array.from(f.connections),{playlist:u.handler.lookupPlaylistBase(c.playlist_id,s)})}})),this.tss.addEventListener("app","DeletePlaylistRequest",(e=>{let t=this.tokens.get(e.connection_id);if(a.present(t)){let s=i.getUserId(t),r=new Array,a=e.data.playlist.playlist_id,n=o.playlists.lookup(a);if(n.user_id!==s&&r.push("You don't have sufficient rights to alter the desired playlist!"),this.tss.respond(e,"DeletePlaylistResponse",{errors:r}),r.length>0)return;let l=this.getOrCreateSession(s);this.tss.send("DeletePlaylist",Array.from(l.connections),{playlist:u.handler.lookupPlaylistBase(n.playlist_id,s)}),o.playlists.remove(n)}})),this.tss.addEventListener("app","UpdatePlaylistRequest",(e=>{let t=this.tokens.get(e.connection_id);if(a.present(t)){let s=i.getUserId(t),r=new Array,a=e.data.playlist.playlist_id,n=o.playlists.lookup(a);n.user_id!==s&&r.push("You don't have sufficient rights to alter the desired playlist!");let l=e.data.playlist.title;Buffer.from(l).length>=256&&r.push("The playlist title is too long!");let d=e.data.playlist.description;if(Buffer.from(d).length>=256&&r.push("The playlist description is too long!"),this.tss.respond(e,"UpdatePlaylistResponse",{errors:r}),r.length>0)return;o.playlists.update(Object.assign(Object.assign({},n),e.data.playlist));let c=this.getOrCreateSession(s);this.tss.send("UpdatePlaylist",Array.from(c.connections),{playlist:u.handler.lookupPlaylistBase(n.playlist_id,s)})}})),this.tss.addEventListener("app","CreatePlaylistItemRequest",(e=>{var t,s;let n=this.tokens.get(e.connection_id);if(a.present(n)){let a=i.getUserId(n),l=new Array,c=e.data.playlist_item.playlist_id;o.playlists.lookup(c).user_id!==a&&l.push("You don't have sufficient rights to alter the desired playlist!");let f=e.data.playlist_item.track_id,g=(o.tracks.lookup(f),r.randomBytes(16).toString("hex"));if(this.tss.respond(e,"CreatePlaylistItemResponse",{errors:l,playlist_item_id:g}),l.length>0)return;let p={playlist_item_id:g,playlist_id:c,track_id:f,number:(null!==(s=null===(t=o.getPlaylistsItemsFromPlaylist.lookup(c).sort(d.NumericSort.increasing((e=>e.number))).pop())||void 0===t?void 0:t.number)&&void 0!==s?s:0)+1,added_ms:Date.now()};o.playlist_items.insert(p);let h=this.getOrCreateSession(a);this.tss.send("CreatePlaylistItem",Array.from(h.connections),{playlist_item:u.handler.lookupPlaylistItemBase(p.playlist_item_id,a)})}})),this.tss.addEventListener("app","DeletePlaylistItemRequest",(e=>{let t=this.tokens.get(e.connection_id);if(a.present(t)){let s=i.getUserId(t),r=new Array,a=e.data.playlist_item.playlist_item_id,n=o.playlist_items.lookup(a),l=o.playlists.lookup(n.playlist_id);if(l.user_id!==s&&r.push("You don't have sufficient rights to alter the desired playlist!"),this.tss.respond(e,"DeletePlaylistItemResponse",{errors:r}),r.length>0)return;let c=n.number,f=o.getPlaylistsItemsFromPlaylist.lookup(l.playlist_id).sort(d.NumericSort.increasing((e=>e.number)));for(let e of f)e.number>c&&(e.number-=1,o.playlist_items.update(e,"combine"));let g=this.getOrCreateSession(s);this.tss.send("DeletePlaylistItem",Array.from(g.connections),{playlist_item:u.handler.lookupPlaylistItemBase(n.playlist_item_id,s)}),o.playlist_items.remove(n)}})),this.tss.addEventListener("app","UpdatePlaylistItemRequest",(e=>{let t=this.tokens.get(e.connection_id);if(a.present(t)){let s=i.getUserId(t),r=new Array,a=e.data.playlist_item.playlist_item_id,n=o.playlist_items.lookup(a),l=o.playlists.lookup(n.playlist_id);l.user_id!==s&&r.push("You don't have sufficient rights to alter the desired playlist!");let c=e.data.playlist_item.number,f=o.getPlaylistsItemsFromPlaylist.lookup(l.playlist_id).sort(d.NumericSort.increasing((e=>e.number)));if((c<1||c>f.length)&&r.push(`Expected a position between 1 and ${f.length} (${c})!`),this.tss.respond(e,"UpdatePlaylistItemResponse",{errors:r}),r.length>0)return;let g=c-1,p=e.data.playlist_item.number-1;if(p>g)for(let e=g+1;e<p;e++){let t=f[e];t.number-=1,o.playlist_items.update(t,"combine")}else if(p<g)for(let e=p;e<g;e++){let t=f[e];t.number+=1,o.playlist_items.update(t,"combine")}n.number=c,o.playlist_items.update(Object.assign(Object.assign({},n),e.data.playlist_item),"combine");let h=this.getOrCreateSession(s);this.tss.send("UpdatePlaylistItem",Array.from(h.connections),{playlist_item:u.handler.lookupPlaylistItemBase(n.playlist_item_id,s)})}}))}getOrCreateSession(e){let t=this.sessions.get(e);return a.present(t)||(t={connections:new Set},this.sessions.set(e,t)),t}revokeAuthentication(e){let t=this.tokens.get(e);if(this.tokens.delete(e),a.present(t)){let s=i.getUserId(t),r=this.sessions.get(s);a.present(r)&&r.connections.delete(e)}}getRequestHandler(){return this.tss.getRequestHandler()}}},3601:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getUserId=t.createToken=void 0;const r=s(6417),i=s(6321),a=s(8575);t.createToken=function(e,t){let s=i.getUsersFromUsername.lookup(e).shift();if(!s)throw"";if(!a.verify(t,s.password))throw"Expected a valid password!";return function(e){let t=r.randomBytes(16),s=r.randomBytes(16),a=r.createHash("sha256");a.update(s);let n=a.digest("hex");return i.tokens.insert({token_id:t.toString("hex"),user_id:e,hash:n,expires_ms:Date.now()+6048e5}),`${t.toString("hex")}${s.toString("hex")}`}(s.user_id)},t.getUserId=function(e){let t=/^([0-9a-f]{32})([0-9a-f]{32})$/.exec(e);if(!t)throw new Error;let s=t[1],a=t[2],n=i.tokens.lookup(s);if(n.expires_ms<Date.now())throw"Token has expired!";let o=r.createHash("sha256");o.update(Buffer.from(a,"hex"));let l=o.digest();if(!r.timingSafeEqual(Buffer.from(n.hash,"hex"),l))throw new Error;let d=Date.now()+6048e5;return i.tokens.update(Object.assign(Object.assign({},n),{expires_ms:d})),n.user_id}},8525:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Autoguard=t.FormatResult=t.Format=t.StreamsResult=t.Stream=t.VideoStream=t.SubtitleStream=t.ImageStream=t.AudioStream=t.StreamCommon=t.FramesResult=t.VideoFrame=void 0;const r=s(9175);t.VideoFrame=r.guards.Object.of({pkt_pts_time:r.guards.String}),t.FramesResult=r.guards.Object.of({frames:r.guards.Array.of(r.guards.Reference.of((()=>t.VideoFrame)))}),t.StreamCommon=r.guards.Object.of({codec_name:r.guards.String}),t.AudioStream=r.guards.Intersection.of(r.guards.Reference.of((()=>t.StreamCommon)),r.guards.Object.of({codec_type:r.guards.StringLiteral.of("audio"),start_time:r.guards.String,duration:r.guards.String})),t.ImageStream=r.guards.Intersection.of(r.guards.Reference.of((()=>t.StreamCommon)),r.guards.Object.of({codec_type:r.guards.StringLiteral.of("video"),codec_time_base:r.guards.StringLiteral.of("0/1"),width:r.guards.Number,height:r.guards.Number})),t.SubtitleStream=r.guards.Intersection.of(r.guards.Reference.of((()=>t.StreamCommon)),r.guards.Object.of({codec_type:r.guards.StringLiteral.of("subtitle")})),t.VideoStream=r.guards.Intersection.of(r.guards.Reference.of((()=>t.StreamCommon)),r.guards.Object.of({codec_type:r.guards.StringLiteral.of("video"),start_time:r.guards.String,duration:r.guards.String,width:r.guards.Number,height:r.guards.Number})),t.Stream=r.guards.Union.of(r.guards.Reference.of((()=>t.AudioStream)),r.guards.Reference.of((()=>t.ImageStream)),r.guards.Reference.of((()=>t.SubtitleStream)),r.guards.Reference.of((()=>t.VideoStream))),t.StreamsResult=r.guards.Object.of({streams:r.guards.Array.of(r.guards.Reference.of((()=>t.Stream)))}),t.Format=r.guards.Object.of({format_name:r.guards.String,tags:r.guards.Union.of(r.guards.Undefined,r.guards.Object.of({title:r.guards.Union.of(r.guards.Undefined,r.guards.String),date:r.guards.Union.of(r.guards.Undefined,r.guards.String),comment:r.guards.Union.of(r.guards.Undefined,r.guards.String),show:r.guards.Union.of(r.guards.Undefined,r.guards.String),episode_id:r.guards.Union.of(r.guards.Undefined,r.guards.String),episode_sort:r.guards.Union.of(r.guards.Undefined,r.guards.String),season_number:r.guards.Union.of(r.guards.Undefined,r.guards.String),track:r.guards.Union.of(r.guards.Undefined,r.guards.String),artist:r.guards.Union.of(r.guards.Undefined,r.guards.String),album_artist:r.guards.Union.of(r.guards.Undefined,r.guards.String),album:r.guards.Union.of(r.guards.Undefined,r.guards.String),disc:r.guards.Union.of(r.guards.Undefined,r.guards.String)}))}),t.FormatResult=r.guards.Object.of({format:r.guards.Reference.of((()=>t.Format))}),t.Autoguard={VideoFrame:t.VideoFrame,FramesResult:t.FramesResult,StreamCommon:t.StreamCommon,AudioStream:t.AudioStream,ImageStream:t.ImageStream,SubtitleStream:t.SubtitleStream,VideoStream:t.VideoStream,Stream:t.Stream,StreamsResult:t.StreamsResult,Format:t.Format,FormatResult:t.FormatResult}},7469:function(e,t,s){var r=this&&this.__awaiter||function(e,t,s,r){return new(s||(s=Promise))((function(i,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getKeyframeSegments=t.getKeyframeOffsets=t.getStreams=t.combineOffsets=t.makeSegments=void 0;const i=s(3129),a=s(8525);function n(e){let t=new Array;for(let s=0;s+1<e.length;s++)t.push({offset_ms:e[s],duration_ms:e[s+1]-e[s]});return t}function o(e,t){let s=-1/0,r=new Array;for(let i=1;i<e.length;i++)e[i]-s>t&&(s=e[i-1],r.push(s));return r}function l(e){return r(this,void 0,void 0,(function*(){return new Promise(((t,s)=>{let r=i.spawn("ffprobe",["-hide_banner","-i",e.join("/"),"-show_streams","-show_entries","stream=start_time,duration","-of","json"]),n=new Array;r.stdout.on("data",(e=>{n.push(e)})),r.on("exit",(()=>{let e=Buffer.concat(n).toString(),s=a.StreamsResult.as(JSON.parse(e)).streams.filter((e=>a.VideoStream.is(e))).map((e=>({offset_ms:Math.round(1e3*Number.parseFloat(e.start_time)),duration_ms:Math.round(1e3*Number.parseFloat(e.duration))})));t(s)}))}))}))}function d(e,t){return r(this,void 0,void 0,(function*(){return new Promise(((s,r)=>{let n=i.spawn("ffprobe",["-hide_banner","-i",e.join("/"),"-select_streams",""+t,"-skip_frame","nokey","-show_frames","-show_entries","frame=pkt_pts_time","-of","json"]),o=new Array;n.stdout.on("data",(e=>{o.push(e)})),n.on("exit",(()=>{let e=Buffer.concat(o).toString();try{let t=a.FramesResult.as(JSON.parse(e)).frames.map((e=>Math.round(1e3*Number.parseFloat(e.pkt_pts_time))));s(t)}catch(e){r(e)}}))}))}))}t.makeSegments=n,t.combineOffsets=o,t.getStreams=l,t.getKeyframeOffsets=d,t.getKeyframeSegments=function(e,t,s){return r(this,void 0,void 0,(function*(){let r=yield l(e),i=yield d(e,t),a=r[t];return n([...o([...i,a.duration_ms],s),a.duration_ms])}))}},8575:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.verify=t.generate=void 0;const r=s(6417);t.generate=function(e){let t=r.randomBytes(16),s=r.scryptSync(e,t,32,{N:16384,r:8,p:1,maxmem:33554432}),i=Buffer.alloc(4);return i[0]=0,i[1]=14,i[2]=8,i[3]=1,`$s0$${i.toString("hex")}$${t.toString("base64")}$${s.toString("base64")}`},t.verify=function(e,t){let s=/^\$s0\$([0-9a-fA-F]{8})\$([A-Za-z0-9+/]{22}==)\$([A-Za-z0-9+/]{43}=)$/.exec(t);if(null==s)throw"Expected a valid scrypt chunk!";let i=Buffer.from(s[1],"hex"),a=Buffer.from(s[2],"base64"),n=Buffer.from(s[3],"base64"),o=i[0]<<8|i[1]<<0,l=i[2]<<0,d=i[3]<<0,u=r.scryptSync(e,a,32,{N:1<<o,r:l,p:d,maxmem:(256<<o)*l});return r.timingSafeEqual(n,u)}},7045:(e,t,s)=>{const r=s(6417),i=s(5747),a=s(8605),n=s(7211),o=s(5622),l=s(8835),d=s(4181),u=s(3601),c=s(6321),f=s(3298),g=s(4617),p=s(3188),h=s(7471),m=s(7244),y=s(1565),b=new g.server.ContextServer,_=new p.server.PlaylistsServer;let S;function v(e,t){e.headers.host;let s=e.method||"",a=e.url||"";if(/^[/]sockets[/]context[/]/.test(a))return b.getRequestHandler()(e,t);if(/^[/]sockets[/]playlists[/]/.test(a))return _.getRequestHandler()(e,t);let n,g=Date.now();if(t.on("finish",(()=>{let e=Date.now()-g;process.stderr.write(`${t.statusCode} ${s}:${a} (${e} ms)\n`),y.present(S)&&clearTimeout(S),S=setTimeout((()=>{S=void 0,c.runIndexer()}),6e5)})),"GET"===s&&"/favicon.ico"===a)return t.writeHead(404),void t.end();if("POST"===s&&"/discover"===a)return m.discover(),h.discover(),t.writeHead(200),t.end("{}");if("GET"===s&&null!==(n=/^[/]files[/]([0-9a-f]{32})[/]/.exec(a)))return((e,t,s)=>{if(void 0===t.url)throw new Error;let a="";try{var n=l.parse(t.url,!0);a=u.getUserId(n.query.token)}catch(e){return s.writeHead(401,{}),s.end()}let d=c.files.lookup(e),f=c.getPath(d),g="application/octet-stream";try{g=c.audio_files.lookup(d.file_id).mime}catch(e){}try{g=c.image_files.lookup(d.file_id).mime}catch(e){}try{g=c.metadata_files.lookup(d.file_id).mime}catch(e){}try{g=c.subtitle_files.lookup(d.file_id).mime}catch(e){}try{g=c.video_files.lookup(d.file_id).mime}catch(e){}let p,h=f.join(o.sep),m=i.openSync(h,"r"),y=i.fstatSync(m).size;i.closeSync(m);let b=t.headers.range;if(void 0!==b&&null!=(p=/^bytes\=((?:[0-9])|(?:[1-9][0-9]+))\-((?:[0-9])|(?:[1-9][0-9]+))?$/.exec(b))){let t=parseInt(p[1]),n=p[2]?parseInt(p[2]):null;if(null===n&&(n=y-1),t>=y||n>=y||n<t)return s.writeHead(416),void s.end();let o=n-t+1;s.writeHead(206,{"Access-Control-Allow-Origin":"*","Accept-Ranges":"bytes","Cache-Control":"private, max-age=86400","Content-Range":`bytes ${t}-${n}/${y}`,"Content-Type":g,"Content-Length":""+o}),(_=i.createReadStream(h,{start:t,end:n})).addListener("close",(()=>{if(t+_.bytesRead===y){let t=Date.now();c.streams.insert({stream_id:r.randomBytes(16).toString("hex"),user_id:a,file_id:e,timestamp_ms:t})}})),_.on("open",(function(){_.pipe(s)})),_.on("error",(function(e){s.end()}))}else{var _;(_=i.createReadStream(h)).on("open",(function(){s.writeHead(200,{"Access-Control-Allow-Origin":"*","Accept-Ranges":"bytes","Cache-Control":"private, max-age=86400","Content-Type":g,"Content-Length":""+y}),_.pipe(s)})),_.on("error",(function(e){s.writeHead(404),s.end()}))}})(n[1],e,t);if(/^[/]media[/]/.test(a)){if(null!=(n=/^[/]media[/]stills[/]([0-9a-f]{32})[/]/.exec(a))){let e=n[1],s=[".","private","stills",c.files.lookup(e).file_id];if(!i.existsSync(s.join("/")))return t.writeHead(404),t.end();{let e=i.createReadStream(s.join("/"));e.on("open",(()=>{t.writeHead(200,{"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=86400","Content-Type":"image/jpeg"}),e.pipe(t)}))}return}if(null!=(n=/^[/]media[/]gifs[/]([0-9a-f]{32})[/]/.exec(a))){let e=n[1],s=c.cues.lookup(e),r=[".","private","memes",s.cue_id];if(i.existsSync(r.join("/"))){let e=i.createReadStream(r.join("/"));e.on("open",(()=>{t.writeHead(200,{"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=86400","Content-Type":"image/gif"}),e.pipe(t)}))}else f.generateMeme(r,s,(()=>{if(!i.existsSync(r.join("/")))return t.writeHead(500),t.end();let e=i.createReadStream(r.join("/"));e.on("open",(()=>{t.writeHead(200,{"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=86400","Content-Type":"image/gif"}),e.pipe(t)}))}));return}}return/^[/]api[/]/.test(a)?d.handleRequest(e,t):"/manifest.json"===a?(t.writeHead(200,{"Content-Type":"application/json"}),t.end(JSON.stringify({name:"Orbit",start_url:"/",display:"standalone",theme_color:"#df4f7f",background_color:"#1f1f1f",icons:[]}))):"/logo.png"===a?(t.writeHead(200,{"Content-Type":"image/png"}),void i.createReadStream("./public/logo.png").pipe(t)):"GET"===s?(t.writeHead(200),void t.end(`<!doctype html><html><head><base href="/"/><meta charset="utf-8"/><meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0" name="viewport"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" /><link rel="apple-touch-icon" href="logo.png" /><link rel="manifest" href="/manifest.json"/><link href="https://fonts.googleapis.com/css2?family=Nunito&family=Pacifico&family=Space+Mono&display=swap" rel="stylesheet"/><title>Orbit</title></head><body><script>${i.readFileSync("./dist/client.min.js")}<\/script></body></html>`)):(console.log("unhandled",JSON.stringify(e.headers,null,"\t")),t.writeHead(400),void t.end())}function k(e){if(i.existsSync(e))return i.readFileSync(e)}i.existsSync("./private/certs/")||i.mkdirSync("./private/certs/",{recursive:!0});let w=k("./private/certs/full_chain.pem"),I=k("./private/certs/dhparam.pem"),O=k("./private/certs/certificate_key.pem");if(w&&O){let e=n.createServer({cert:w,dhparam:I,key:O},v);e.listen(443,(()=>{console.log("https://localhost:443")})),e.keepAliveTimeout=6e4,a.createServer({},((e,t)=>{let s=e.headers.host||"",r=e.url||"",i=s.split(":").shift();t.writeHead(307,{Location:"https://"+i+":443"+r}),t.end()})).listen(80,(()=>{console.log("http://localhost:80")})),m.observe(!0),h.observe(!0)}else{let e=a.createServer({},v);e.listen(80,(()=>{console.log("http://localhost:80")})),e.keepAliveTimeout=6e4,m.observe(!1),h.observe(!1)}for(let e of c.getKeysFromUser.lookup(void 0))console.log("Registration key available: "+e.key_id)},3298:function(e,t,s){var r=this&&this.__awaiter||function(e,t,s,r){return new(s||(s=Promise))((function(i,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.generateMeme=t.generateStill=void 0;const i=s(5747),a=s(3129),n=s(6417),o=s(6321),l=s(1565),d=s(3754),u=s(7469);function c(e){let t=n.randomBytes(16).toString("hex"),s=[".","private","jobs",t];return i.mkdirSync(s.join("/"),{recursive:!0}),e(s,t)}function f(e,t){i.mkdirSync(t.slice(0,-1).join("/"),{recursive:!0}),i.renameSync(e.join("/"),t.join("/"))}function g(e){let t=i.statSync(e);t.isDirectory()?(i.readdirSync(e).map((t=>e+"/"+t)).forEach(g),i.rmdirSync(e)):t.isFile()&&i.unlinkSync(e)}function p(e,t){return r(this,void 0,void 0,(function*(){let s=o.getPath(t),r=yield u.getKeyframeOffsets(s,0),i=r[Math.floor(r.length/2)];return new Promise(((t,r)=>{c(((n,o)=>{let l=[...n,"still.jpeg"],u=a.spawn("ffmpeg",["-ss",d.formatTimestamp(i),"-i",s.join("/"),"-q:v","1","-frames:v","1","-f","singlejpeg","-fflags","+bitexact","-map_metadata","-1",l.join("/"),"-y"]);u.on("error",(()=>(g(n.join("/")),r()))),u.on("exit",(()=>(f(l,e),g(n.join("/")),t())))}))}))}))}t.generateStill=p,t.generateMeme=function(e,t,s){let r=o.subtitles.lookup(t.subtitle_id),i=o.files.lookup(r.file_id);const n=function(e){let t=o.getVideoFilesFromSubtitleFile.lookup(e.file_id);return o.files.lookup(t[0].video_file_id)}(r);if(null==n)return s();c(((r,l)=>{let u=[...r,"subtitle.vtt"],c=[...r,"palette.png"],p=[...r,"meme.gif"],h=a.spawn("ffmpeg",["-ss",d.formatTimestamp(t.start_ms),"-t",d.formatTimestamp(Math.min(t.duration_ms,5e3)),"-i",o.getPath(i).join("/"),u.join("/"),"-y"]);h.on("error",(()=>(console.log("ffmpeg command failed!"),g(r.join("/")),s()))),h.on("exit",(()=>{a.spawn("ffmpeg",["-ss",d.formatTimestamp(t.start_ms),"-t",d.formatTimestamp(Math.min(t.duration_ms,5e3)),"-i",o.getPath(n).join("/"),"-vf","fps=15,scale=w=384:h=216:force_original_aspect_ratio=decrease,pad=384:216:-1:-1,subtitles="+u.join("/")+":force_style='Bold=1,Fontsize=24,Outline=2',palettegen",c.join("/"),"-y"]).on("exit",(()=>{a.spawn("ffmpeg",["-ss",d.formatTimestamp(t.start_ms),"-t",d.formatTimestamp(Math.min(t.duration_ms,5e3)),"-i",o.getPath(n).join("/"),"-i",c.join("/"),"-filter_complex","fps=15,scale=w=384:h=216:force_original_aspect_ratio=decrease,pad=384:216:-1:-1,subtitles="+u.join("/")+":force_style='Bold=1,Fontsize=24,Outline=2'[x];[x][1:v]paletteuse","-map_metadata","-1",p.join("/"),"-y"]).on("exit",(()=>(f(p,e),g(r.join("/")),s())))}))}))}))};const h=[];for(let e of o.video_files){let t=[".","private","stills",e.file_id];if(!i.existsSync(t.join("/"))){let s=o.files.lookup(e.file_id);h.push({target:t,file:s})}}setTimeout((function e(){return r(this,void 0,void 0,(function*(){let t=h.pop();if(!l.absent(t)){try{yield p(t.target,t.file)}catch(e){}setTimeout(e,1e4)}}))}))},7578:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TypeSocketClient=void 0;const r=s(7978),i=s(8611),a=s(1185),n=s(1565);t.TypeSocketClient=class{constructor(e,t,s){this.nextConnectionAttemptDelayFactor=2+Math.random(),this.nextConnectionAttemptDelay=2e3,this.router=new r.routing.NamespacedMessageRouter,this.serializer=new a.Serializer(s),this.url=e,this.factory=t,this.socket=this.makeSocket(),this.requests=new Map}makeId(){let e="";for(let t=0;t<32;t++)e+=Math.floor(16*Math.random()).toString(16);return e}makeSocket(){let e=this.factory(this.url);return e.addEventListener("close",this.onClose.bind(this)),e.addEventListener("error",this.onError.bind(this)),e.addEventListener("message",this.onMessage.bind(this)),e.addEventListener("open",this.onOpen.bind(this)),e}onClose(e){this.router.route("sys","disconnect",{})}onError(e){setTimeout((()=>{this.socket=this.makeSocket()}),this.nextConnectionAttemptDelay),this.nextConnectionAttemptDelay=Math.round(this.nextConnectionAttemptDelay*this.nextConnectionAttemptDelayFactor)}onMessage(e){try{this.serializer.deserialize(e.data,((e,t,s)=>{if(this.router.route("sys","message",{type:e,data:t}),n.present(s)){let r=this.requests.get(s);n.present(r)&&(this.requests.delete(s),r(e,t))}this.router.route("app",e,t)}))}catch(e){this.socket.close()}}onOpen(e){this.nextConnectionAttemptDelay=2e3,this.router.route("sys","connect",{})}queue(e){if(this.socket.readyState===i.ReadyState.OPEN)this.socket.send(e);else{let t=()=>{this.socket.removeEventListener("open",t),this.socket.send(e)};this.socket.addEventListener("open",t)}}addEventListener(e,t,s){this.router.addObserver(e,t,s)}close(){this.socket.close()}reconnect(){this.socket.readyState===i.ReadyState.CLOSED&&(this.socket=this.makeSocket())}removeEventListener(e,t,s){this.router.addObserver(e,t,s)}request(e,t,s){return new Promise(((r,i)=>{let a=this.makeId(),n=this.serializer.serialize(e,s,a);this.requests.set(a,((e,s)=>{e!==t?i(`Received response with type "${e}" when expecting "${t}"!`):r(s)})),this.queue(n)}))}send(e,t){let s=this.serializer.serialize(e,t);this.queue(s)}}},8907:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TypeSocketServer=t.TypeSocketClient=t.shared=t.server=t.client=void 0,t.client=s(7578),t.server=s(6887),t.shared=s(1185);var r=s(7578);Object.defineProperty(t,"TypeSocketClient",{enumerable:!0,get:function(){return r.TypeSocketClient}});var i=s(6887);Object.defineProperty(t,"TypeSocketServer",{enumerable:!0,get:function(){return i.TypeSocketServer}})},9628:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Autoguard=t.Envelope=void 0;const r=s(9175);t.Envelope=r.guards.Object.of({type:r.guards.String,data:r.guards.Any,id:r.guards.Union.of(r.guards.Undefined,r.guards.String)}),t.Autoguard={Envelope:t.Envelope}},6887:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TypeSocketServer=void 0;const r=s(7978),i=s(4545),a=s(1185);t.TypeSocketServer=class{constructor(e,t=!1){this.router=new r.routing.NamespacedMessageRouter,this.serializer=new a.Serializer(e),this.socket=new i.WebSocketServer,this.debug=t,this.socket.addEventListener("connect",(e=>{let t=e.connection_id,s=e.connection_url;this.router.route("sys","connect",{connection_id:t,connection_url:s})})),this.socket.addEventListener("disconnect",(e=>{let t=e.connection_id,s=e.connection_url;this.router.route("sys","disconnect",{connection_id:t,connection_url:s})})),this.socket.addEventListener("message",(e=>{let t=e.connection_id,s=e.connection_url,r=e.buffer.toString();try{this.serializer.deserialize(r,((e,r,i)=>{this.debug&&console.log(`${t} -> ${e}`),this.router.route("sys","message",{connection_id:t,connection_url:s,id:i,type:e,data:r}),this.router.route("app",e,{connection_id:t,connection_url:s,id:i,data:r})}))}catch(e){this.debug&&console.log(e)}}))}addEventListener(e,t,s){this.router.addObserver(e,t,s)}broadcast(e,t){let s=this.serializer.serialize(e,t);this.socket.broadcast(s)}close(e){this.socket.close(e)}getRequestHandler(){return this.socket.getRequestHandler()}removeEventListener(e,t,s){this.router.addObserver(e,t,s)}respond(e,t,s){let r=this.serializer.serialize(t,s,e.id);this.debug&&console.log(`${e.connection_id} <- ${t}`);try{this.socket.send(e.connection_id,r)}catch(e){this.debug&&console.log(e)}}send(e,t,s){let r=this.serializer.serialize(e,s);for(let s of Array.isArray(t)?t:[t]){this.debug&&console.log(`${s} <- ${e}`);try{this.socket.send(s,r)}catch(e){this.debug&&console.log(e)}}}}},1185:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Serializer=void 0;const r=s(9628),i=s(1565);t.Serializer=class{constructor(e){this.guards=e}deserialize(e,t){let s=r.Envelope.as(JSON.parse(e)),a=s.id,n=s.type,o=s.data,l=this.guards[n];if(i.absent(l))throw`Unknown message type "${n}"!`;t(n,l.as(o),a)}serialize(e,t,s){return JSON.stringify({type:e,data:t,id:s})}}},3754:(e,t)=>{function s(...e){return e.map((e=>String(e))).join("")}Object.defineProperty(t,"__esModule",{value:!0}),t.formatTimestamp=t.join=void 0,t.join=s,t.formatTimestamp=function(e){let t=Math.floor(e/1e3);e-=1e3*t;let r=Math.floor(t/60);t-=60*r;let i=Math.floor(r/60);r-=60*i;let a=s("00",i).slice(-2),n=s("00",r).slice(-2),o=s("00",t).slice(-2),l=s("000",e).slice(-3);return s(a,":",n,":",o,".",l)}},8161:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.parse=t.XMLElement=t.XMLAttribute=t.XMLText=t.XMLNode=t.expect=t.Tokenizer=void 0;const r=s(1565),i={WS:/^([\t\r\n ]+)/ius,"<":/^([<])/ius,">":/^([>])/ius,"!":/^([!])/ius,"?":/^([?])/ius,"=":/^([=])/ius,"</":/^([<][/])/ius,"/>":/^([/][>])/ius,IDENTIFIER:/^([a-z][a-z0-9_-]*)/ius,STRING_LITERAL:/^("[^"]*")/ius,TEXT_NODE:/^([^<>]+)[<]/ius};class a{constructor(e){let t=new Array,s=1,a=1;for(;e.length>0;){let n;for(let t in i){let s=t,a=i[s].exec(e);r.absent(a)||(r.absent(n)||a[1].length>n[1].length)&&(n=[s,a[1]])}if(r.absent(n))throw`Unrecognized token at row ${s}, col ${a}!`;t.push({type:n[0],value:n[1],row:s,col:a}),e=e.slice(n[1].length);let o=n[1].split(/\r?\n/);o.length>1&&(s+=o.length-1,a=1),a+=o[o.length-1].length}this.tokens=t.filter((e=>"WS"!==e.type)),this.offset=0}peek(){return this.tokens[this.offset]}read(){if(this.offset>=this.tokens.length)throw"Unexpectedly reached end of stream!";return this.tokens[this.offset++]}newContext(e){let t=this.offset;try{return e((()=>this.read()),(()=>this.peek()))}catch(e){throw this.offset=t,e}}}function n(e,t){if(!(Array.isArray(t)?t:[t]).includes(e.type))throw`Unexpected ${e.type} at row ${e.row}, col ${e.col}!`;return e}t.Tokenizer=a,t.expect=n;class o{asElement(){throw"Expected node to be an XMLElement!"}isElement(){try{return this.asElement(),!0}catch(e){}return!1}asText(){throw"Expected node to be an XMLText!"}isText(){try{return this.asText(),!0}catch(e){}return!1}}function l(e){try{return p(e)}catch(e){}try{return function(e){return e.newContext(((e,t)=>{let s=n(e(),["TEXT_NODE","IDENTIFIER"]).value;return new d(s)}))}(e)}catch(e){}return e.newContext(((e,t)=>{let s=t();throw r.present(s)?`Unexpected ${s.type} at ${s.row}, ${s.col}!`:"Unexpectedly reached end of stream!"}))}t.XMLNode=o;class d extends o{constructor(e){super(),this.$value=e}asText(){return this}value(){return this.$value}}t.XMLText=d;class u{constructor(e,t){this.$key=e,this.$value=t}key(){return this.$key}value(){return this.$value}}function c(e){return e.newContext(((e,t)=>{let s=n(e(),"IDENTIFIER").value;n(e(),"=");let r=n(e(),"STRING_LITERAL").value.slice(1,-1);return new u(s,r)}))}t.XMLAttribute=u;class f{constructor(e){this.array=Array.from(e)}get(e){if(e<0||e>=this.array.length)throw`Expected index ${e} to be between 0 and ${this.array.length}!`;return this.array[e]}length(){return this.array.length}[Symbol.iterator](){return this.array[Symbol.iterator]()}}class g extends o{constructor(e,t,s){super(),this.$tag=e,this.$attributes=new f(t),this.$children=new f(s)}asElement(){return this}tag(...e){let t=this.$tag;if(!e.includes(t))throw`Expected tag to be one of [${e.join(", ")}] but was ${t}!`;return t}attributes(){return this.$attributes}children(){return this.$children}}function p(e){return e.newContext(((t,s)=>{var r,i,a;n(t(),"<");let o=n(t(),"IDENTIFIER").value,d=new Array;for(;">"!==(null===(r=s())||void 0===r?void 0:r.type)&&"/>"!==(null===(i=s())||void 0===i?void 0:i.type);){let t=c(e);d.push(t)}let u=new Array;if(">"===n(t(),[">","/>"]).type){for(;"</"!==(null===(a=s())||void 0===a?void 0:a.type);){let t=l(e);u.push(t)}if(n(t(),"</"),n(t(),"IDENTIFIER").value!==o)throw"";n(t(),">")}return new g(o,d,u)}))}t.XMLElement=g,t.parse=function(e){return(t=new a(e.trim())).newContext(((e,s)=>(function(e){e.newContext(((e,t)=>{if(n(e(),"<"),n(e(),"?"),"xml"!==n(e(),"IDENTIFIER").value)throw"";if("version"!==n(e(),"IDENTIFIER").value)throw"";if(n(e(),"="),n(e(),"STRING_LITERAL"),"encoding"!==n(e(),"IDENTIFIER").value)throw"";n(e(),"="),n(e(),"STRING_LITERAL"),n(e(),"?"),n(e(),">")}))}(t),function(e){e.newContext(((e,t)=>{if(n(e(),"<"),n(e(),"!"),"DOCTYPE"!==n(e(),"IDENTIFIER").value)throw"";n(e(),"IDENTIFIER").value,n(e(),"IDENTIFIER").value,n(e(),"STRING_LITERAL").value,n(e(),"STRING_LITERAL").value,n(e(),">")}))}(t),{root:p(t)})));var t}},375:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Union=t.Undefined=t.Tuple=t.StringLiteral=t.String=t.Reference=t.Record=t.Object=t.NumberLiteral=t.Number=t.Null=t.Intersection=t.BooleanLiteral=t.Boolean=t.Array=t.Any=void 0,t.Any={as:(e,t="")=>e,is(e){try{this.as(e)}catch(e){return!1}return!0}},t.Array={of:e=>({as(t,s=""){if(null!=t&&t.constructor===globalThis.Array){for(let r=0;r<t.length;r++)e.as(t[r],s+"["+r+"]");return t}throw"Expected an array at "+s+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Boolean={as(e,t=""){if(null!=e&&e.constructor===globalThis.Boolean)return e;throw"Expected a boolean at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.BooleanLiteral={of:e=>({as(t,s=""){if(t===e)return t;throw"Expected "+e+" at "+s+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Intersection={of:(...e)=>({as(t,s=""){for(let r of e)r.as(t,s);return t},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Null={as(e,t=""){if(null===e)return e;throw"Expected null at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.Number={as(e,t=""){if(null!=e&&e.constructor===globalThis.Number)return e;throw"Expected a number at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.NumberLiteral={of:e=>({as(t,s=""){if(t===e)return t;throw"Expected "+e+" at "+s+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Object={of:e=>({as(t,s=""){if(null!=t&&t.constructor===globalThis.Object){for(let r in e)e[r].as(t[r],s+/^([a-z][a-z0-9_]*)$/is.test(r)?"."+r:'["'+r+'"]');return t}throw"Expected an object at "+s+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Record={of:e=>({as(t,s=""){if(null!=t&&t.constructor===globalThis.Object){for(let r of globalThis.Object.keys(t))e.as(t[r],s+'["'+r+'"]');return t}throw"Expected a record at "+s+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Reference={of:e=>({as:(t,s="")=>e().as(t,s),is:t=>e().is(t)})},t.String={as(e,t=""){if(null!=e&&e.constructor===globalThis.String)return e;throw"Expected a string at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.StringLiteral={of:e=>({as(t,s=""){if(t===e)return t;throw'Expected "'+e+'" at '+s+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Tuple={of:(...e)=>({as(t,s=""){if(null!=t&&t.constructor===globalThis.Array){for(let r=0;r<e.length;r++)e[r].as(t[r],s+"["+r+"]");return t}throw"Expected a tuple at "+s+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Undefined={as(e,t=""){if(void 0===e)return e;throw"Expected undefined at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.Union={of:(...e)=>({as(t,s=""){for(let r of e)try{return r.as(t,s)}catch(e){}throw"Expected a union at "+s+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})}},9175:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.transform=t.tokenization=t.serialization=t.language=t.guards=void 0;const r=s(375);t.guards=r;const i=s(4226);t.language=i;const a=s(4129);t.serialization=a;const n=s(3329);t.tokenization=n,t.transform=function(e,t){let s=new n.Tokenizer(e);return i.Schema.parse(s).generateModule(t)}},4226:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Schema=t.UnionType=t.UndefinedType=t.TupleType=t.StringLiteralType=t.StringType=t.ReferenceType=t.RecordType=t.ObjectType=t.NumberLiteralType=t.NumberType=t.NullType=t.IntersectionType=t.GroupType=t.BooleanLiteralType=t.BooleanType=t.ArrayType=t.AnyType=t.Type=void 0;const r=s(3329);t.Type={parse(e,...t){try{return S.parse(e,...t)}catch(e){}try{return d.parse(e,...t)}catch(e){}try{return a.parse(e,...t)}catch(e){}try{return i.parse(e)}catch(e){}try{return n.parse(e)}catch(e){}try{return o.parse(e)}catch(e){}try{return u.parse(e)}catch(e){}try{return c.parse(e)}catch(e){}try{return f.parse(e)}catch(e){}try{return m.parse(e)}catch(e){}try{return y.parse(e)}catch(e){}try{return _.parse(e)}catch(e){}try{return h.parse(e)}catch(e){}try{return b.parse(e)}catch(e){}try{return g.parse(e)}catch(e){}try{return l.parse(e)}catch(e){}try{return p.parse(e)}catch(e){}return e.newContext(((e,t)=>{let s=e();throw`Unexpected ${s.family} at row ${s.row}, col ${s.col}!`}))}};class i{constructor(){}generateType(e){return"any"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\treturn subject;"),t.push("}")):t.push("autoguard.Any"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>(r.expect(e(),"any"),i.INSTANCE)))}}t.AnyType=i,i.INSTANCE=new i;class a{constructor(e){this.type=e}generateType(e){return this.type.generateType(e)+"[]"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Array)) {"),t.push("\t\tfor (let i = 0; i < subject.length; i++) {"),t.push("\t\t\t("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t\t"}))+')(subject[i], path + "[" + i + "]");'),t.push("\t\t}"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected an array at " + path + "!";'),t.push("}")):t.push("autoguard.Array.of("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}getImports(){return this.type.getImports()}static parse(e,...s){if(s.includes("Array"))throw"Recursion prevention!";return e.newContext(((i,n)=>{let o=t.Type.parse(e,...s,"Array");r.expect(i(),"["),r.expect(i(),"]");let l=new a(o);for(;;)try{e.newContext(((e,t)=>{r.expect(e(),"["),r.expect(e(),"]"),l=new a(l)}))}catch(e){break}return l}))}}t.ArrayType=a;class n{constructor(){}generateType(e){return"boolean"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Boolean)) {"),t.push("\t\treturn subject as boolean;"),t.push("\t}"),t.push('\tthrow "Expected a boolean at " + path + "!";'),t.push("}")):t.push("autoguard.Boolean"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>(r.expect(e(),"boolean"),n.INSTANCE)))}}t.BooleanType=n,n.INSTANCE=new n;class o{constructor(e){this.value=e}generateType(e){return""+this.value}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+") {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected '+this.value+' at " + path + "!";'),t.push("}")):t.push("autoguard.BooleanLiteral.of("+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>"true"===r.expect(e(),["true","false"]).family?o.INSTANCE_TRUE:o.INSTANCE_FALSE))}}t.BooleanLiteralType=o,o.INSTANCE_TRUE=new o(!0),o.INSTANCE_FALSE=new o(!1);class l{constructor(e){this.type=e}generateType(e){return"("+this.type.generateType(e)+")"}generateTypeGuard(e){return this.type.generateTypeGuard(e)}getImports(){return this.type.getImports()}static parse(e){return e.newContext(((s,i)=>{r.expect(s(),"(");let a=t.Type.parse(e);return r.expect(s(),")"),new l(a)}))}}t.GroupType=l;class d{constructor(){this.types=new Set}add(e){return this.types.add(e),this}generateType(e){let t=new Array;for(let s of this.types)t.push(s.generateType(e));return t.join(" & ")}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {");for(let s of this.types)t.push("\t("+s.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+")(subject, path);");return t.push("\treturn subject;"),t.push("}"),t.join(e.eol)}for(let s of this.types)t.push("\t"+s.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"autoguard.Intersection.of("+e.eol+t.join(","+e.eol)+e.eol+")"}getImports(){let e=new Array;for(let t of this.types)e.push(...t.getImports());return e}static parse(e,...s){if(s.includes("Intersection"))throw"Recursion prevention!";return e.newContext(((i,a)=>{var n;let o=t.Type.parse(e,...s,"Intersection"),l=new d;for(l.add(o);"&"===(null===(n=a())||void 0===n?void 0:n.value);){r.expect(i(),"&");let a=t.Type.parse(e,...s,"Intersection");l.add(a)}return 1===l.types.size?o:l}))}}t.IntersectionType=d;class u{constructor(){}generateType(e){return"null"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === null) {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected null at " + path + "!";'),t.push("}")):t.push("autoguard.Null"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>(r.expect(e(),"null"),u.INSTANCE)))}}t.NullType=u,u.INSTANCE=new u;class c{constructor(){}generateType(e){return"number"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Number)) {"),t.push("\t\treturn subject as number;"),t.push("\t}"),t.push('\tthrow "Expected a number at " + path + "!";'),t.push("}")):t.push("autoguard.Number"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>(r.expect(e(),"number"),c.INSTANCE)))}}t.NumberType=c,c.INSTANCE=new c;class f{constructor(e){this.value=e}generateType(e){return""+this.value}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+") {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected '+this.value+' at " + path + "!";'),t.push("}")):t.push("autoguard.NumberLiteral.of("+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>{let s=r.expect(e(),"NUMBER_LITERAL").value;return new f(Number.parseInt(s))}))}}t.NumberLiteralType=f;class g{constructor(){this.members=new Map}add(e,t){return this.members.set(e,t),this}generateType(e){if(0===this.members.size)return"{}";let t=new Array;for(let[s,r]of this.members)t.push('\t"'+s+'"'+(r.optional?"?":"")+": "+r.type.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"{"+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+"}"}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Object)) {");for(let[s,r]of this.members){let i=r.type;if(r.optional){let e=new S;e.add(_.INSTANCE),e.add(i),i=e}let a=/^([a-z][a-z0-9_]*)$/is.test(s)?'".'+s+'"':'"[\\"'+s+'\\"]"';t.push("\t\t("+i.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+')(subject["'+s+'"], path + '+a+");")}return t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected an object at " + path + "!";'),t.push("}"),t.join(e.eol)}for(let[s,r]of this.members){let i=r.type;if(r.optional){let e=new S;e.add(_.INSTANCE),e.add(i),i=e}t.push('\t"'+s+'": '+i.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})))}return"autoguard.Object.of<"+(null!=this.typename?this.typename:this.generateType(e))+">({"+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+"})"}getImports(){let e=new Array;for(let[t,s]of this.members){let t=s.type;e.push(...t.getImports())}return e}setTypename(e){this.typename=e}static parse(e){return e.newContext(((s,i)=>{var a,n,o;r.expect(s(),"{");let l=new g;if("}"!==(null===(a=i())||void 0===a?void 0:a.value))for(;;){let a=!1,d=r.expect(s(),["any","boolean","false","null","number","string","true","undefined","IDENTIFIER","STRING_LITERAL"]),u="STRING_LITERAL"===d.family?d.value.slice(1,-1):d.value;"?"===(null===(n=i())||void 0===n?void 0:n.value)&&(s(),a=!0),r.expect(s(),":");let c=t.Type.parse(e);if(l.add(u,{type:c,optional:a}),","!==(null===(o=i())||void 0===o?void 0:o.value))break;r.expect(s(),",")}return r.expect(s(),"}"),l}))}}t.ObjectType=g;class p{constructor(e){this.type=e}generateType(e){return"Record<string, undefined | "+this.type.generateType(e)+">"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Object)) {"),t.push("\t\tfor (let key of globalThis.Object.keys(subject)) {"),t.push("\t\t\t("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t\t"}))+')(subject[key], path + "[\\"" + key + "\\"]");'),t.push("\t\t}"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected a record at " + path + "!";'),t.push("}")):t.push("autoguard.Record.of("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}getImports(){return this.type.getImports()}static parse(e){return e.newContext(((s,i)=>{r.expect(s(),"{");let a=t.Type.parse(e);return r.expect(s(),"}"),new p(a)}))}}t.RecordType=p;class h{constructor(e,t){this.path=e,this.typename=t}generateType(e){return this.typename}generateTypeGuard(e){return e.standalone?this.typename+".as":"autoguard.Reference.of<"+this.typename+">(() => "+this.typename+")"}getImports(){return this.path.length>0?[{path:this.path,typename:this.typename}]:[]}static parse(e){return e.newContext(((e,t)=>{var s,i;"@"===(null===(s=t())||void 0===s?void 0:s.family)&&r.expect(e(),"@");let a=new Array;for(;;){let s=e();if(r.expect(s,[".","..","IDENTIFIER"]),a.push(s),"/"!==(null===(i=t())||void 0===i?void 0:i.family))break;r.expect(e(),"/")}let n=a.pop();return r.expect(n,"IDENTIFIER"),new h(a.map((e=>e.value)),n.value)}))}}t.ReferenceType=h;class m{constructor(){}generateType(e){return"string"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.String)) {"),t.push("\t\treturn subject as string;"),t.push("\t}"),t.push('\tthrow "Expected a string at " + path + "!";'),t.push("}")):t.push("autoguard.String"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>(r.expect(e(),"string"),m.INSTANCE)))}}t.StringType=m,m.INSTANCE=new m;class y{constructor(e){this.value=e}generateType(e){return'"'+this.value+'"'}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+") {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected \\"'+this.value+'\\" at " + path + "!";'),t.push("}")):t.push('autoguard.StringLiteral.of("'+this.value+'")'),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>{let s=r.expect(e(),"STRING_LITERAL").value;return new y(s.slice(1,-1))}))}}t.StringLiteralType=y;class b{constructor(){this.types=new Array}add(e){return this.types.push(e),this}generateType(e){let t=new Array;for(let s of this.types)t.push("\t"+s.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"["+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+"]"}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Array)) {");for(let s=0;s<this.types.length;s++){let r=this.types[s];t.push("\t\t("+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+")(subject["+s+'], path + "['+s+']");')}return t.push("\t\treturn subject as "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+";"),t.push("\t}"),t.push('\tthrow "Expected a tuple at " + path + "!";'),t.push("}"),t.join(e.eol)}for(let s of this.types)t.push("\t"+s.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"autoguard.Tuple.of("+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+")"}getImports(){let e=new Array;for(let t of this.types)e.push(...t.getImports());return e}static parse(e){return e.newContext(((s,i)=>{var a,n;r.expect(s(),"[");let o=new b;if("]"!==(null===(a=i())||void 0===a?void 0:a.value))for(;;){let a=t.Type.parse(e);if(o.add(a),","!==(null===(n=i())||void 0===n?void 0:n.value))break;r.expect(s(),",")}return r.expect(s(),"]"),o}))}}t.TupleType=b;class _{constructor(){}generateType(e){return"undefined"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === undefined) {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected undefined at " + path + "!";'),t.push("}")):t.push("autoguard.Undefined"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>(r.expect(e(),"undefined"),_.INSTANCE)))}}t.UndefinedType=_,_.INSTANCE=new _;class S{constructor(){this.types=new Set}add(e){return this.types.add(e),this}generateType(e){let t=new Array;for(let s of this.types)t.push(s.generateType(e));return t.join(" | ")}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {");for(let s of this.types)t.push("\ttry {"),t.push("\t\treturn ("+s.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+")(subject, path);"),t.push("\t} catch (error) {}");return t.push('\tthrow "Expected a union at " + path + "!";'),t.push("}"),t.join(e.eol)}for(let s of this.types)t.push("\t"+s.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"autoguard.Union.of("+e.eol+t.join(","+e.eol)+e.eol+")"}getImports(){let e=new Array;for(let t of this.types)e.push(...t.getImports());return e}static parse(e,...s){if(s.includes("Union"))throw"Recursion prevention!";return e.newContext(((i,a)=>{var n;let o=t.Type.parse(e,...s,"Union"),l=new S;for(l.add(o);"|"===(null===(n=a())||void 0===n?void 0:n.value);){r.expect(i(),"|");let a=t.Type.parse(e,...s,"Union");l.add(a)}return 1===l.types.size?o:l}))}}t.UnionType=S;class v{constructor(){this.types=new Map}getImports(){let e=new Map;for(let[t,s]of this.types){let t=s.getImports();for(let s of t)e.set(s.typename,s.path)}return Array.from(e.entries()).sort(((e,t)=>e[0].localeCompare(t[0]))).map((e=>({path:e[1],typename:e[0]})))}add(e,t){return this.types.set(e,t),this}generateModule(e){let t=new Array;t.push("// This file was auto-generated by @joelek/ts-autoguard. Edit at own risk."),t.push("");let s=this.getImports();for(let e of s)t.push("import { "+e.typename+' } from "'+e.path.join("/")+'";');e.standalone||t.push('import { guards as autoguard } from "@joelek/ts-autoguard";'),t.push("");for(let[s,r]of this.types)t.push("export type "+s+" = "+r.generateType(e)+";"),t.push(""),e.standalone?(t.push("export const "+s+" = {"),t.push('\tas(subject: any, path: string = ""): '+s+" {"),t.push("\t\treturn ("+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+")(subject, path);"),t.push("\t},"),t.push("\tis(subject: any): subject is "+s+" {"),t.push("\t\ttry {"),t.push("\t\t\tthis.as(subject);"),t.push("\t\t} catch (error) {"),t.push("\t\t\treturn false;"),t.push("\t\t}"),t.push("\t\treturn true;"),t.push("\t}"),t.push("};"),t.push("")):(t.push("export const "+s+" = "+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol}))+";"),t.push(""));let r=new g;for(let[e,t]of this.types)r.add(e,{type:new h([],e),optional:!1});return t.push("export type Autoguard = "+r.generateType(e)+";"),t.push(""),t.push("export const Autoguard = "+r.generateType(e)+";"),t.push(""),t.join(e.eol)}static parse(e){return e.newContext(((s,i)=>{var a,n,o;r.expect(s(),"{");let l=new v;if("}"!==(null===(a=i())||void 0===a?void 0:a.value))for(;;){let a=r.expect(s(),"IDENTIFIER").value;r.expect(s(),":");let d=t.Type.parse(e);if(null===(n=d.setTypename)||void 0===n||n.call(d,a),l.add(a,d),","!==(null===(o=i())||void 0===o?void 0:o.value))break;r.expect(s(),",")}if(r.expect(s(),"}"),null!=i())throw"Expected end of stream!";return l}))}}t.Schema=v},4129:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MessageSerializer=void 0,t.MessageSerializer=class{constructor(e){this.guards=e}deserialize(e,t){let s=JSON.parse(e);if(null==s||s.constructor!==Object||null==s.type||s.type.constructor!==String)throw"Invalid message envelope!";{let e=s.type,r=s.data,i=this.guards[e];if(void 0===i)throw'Unknown message type "'+e+'"!';t(e,i.as(r))}}serialize(e,t){return JSON.stringify({type:e,data:t})}}},3329:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.expect=t.Tokenizer=t.Families=void 0,t.Families=["WS","(",")","[","]","{","}","?","|",".","..","/","&","@",",",":","any","boolean","false","null","number","string","true","undefined","IDENTIFIER","NUMBER_LITERAL","STRING_LITERAL"],t.Tokenizer=class{constructor(e){let t={WS:/^([\t\r\n ]+)/ius,"(":/^([\(])/ius,")":/^([\)])/ius,"[":/^([\[])/ius,"]":/^([\]])/ius,"{":/^([\{])/ius,"}":/^([\}])/ius,"?":/^([\?])/ius,"|":/^([\|])/ius,".":/^([\.])/ius,"..":/^([\.][\.])/ius,"/":/^([\/])/ius,"&":/^([&])/ius,"@":/^([@])/ius,",":/^([,])/ius,":":/^([:])/ius,any:/^(any)/ius,boolean:/^(boolean)/ius,false:/^(false)/ius,null:/^(null)/ius,number:/^(number)/ius,string:/^(string)/ius,true:/^(true)/ius,undefined:/^(undefined)/ius,IDENTIFIER:/^([a-z][a-z0-9_]*)/ius,NUMBER_LITERAL:/^(([1-9][0-9]+)|([0-9]))/ius,STRING_LITERAL:/^(["][^"]*["])/ius},s=new Array,r=1,i=1;for(;e.length>0;){let a;for(let s in t){let r=s,i=t[r].exec(e);null!=i&&(null==a||i[1].length>a[1].length)&&(a=[r,i[1]])}if(null==a)throw`Unrecognized token at row ${r}, col ${i}!`;s.push({family:a[0],value:a[1],row:r,col:i}),e=e.slice(a[1].length);let n=a[1].split(/\r?\n/);n.length>1&&(r+=n.length-1,i=1),i+=n[n.length-1].length}this.tokens=s.filter((e=>"WS"!==e.family)),this.offset=0}peek(){return this.tokens[this.offset]}read(){if(this.offset>=this.tokens.length)throw"Unexpectedly reached end of stream!";return this.tokens[this.offset++]}newContext(e){let t=this.offset;try{return e((()=>this.read()),(()=>this.peek()))}catch(e){throw this.offset=t,e}}},t.expect=function(e,t){if(!(Array.isArray(t)?t:[t]).includes(e.family))throw`Unexpected ${e.family} at row ${e.row}, col ${e.col}!`;return e}},5745:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketClient=void 0;const r=s(6417),i=s(8605),a=s(7211),n=s(8835),o=s(7978),l=s(1410),d=s(1093),u=s(8611),c=s(2302);t.WebSocketClient=class{constructor(e){var t;this.state=u.ReadyState.CONNECTING,this.listeners=new o.routing.MessageRouter,this.pending=new Array,this.socket=void 0;let s=r.randomBytes(16).toString("base64"),d={Connection:"upgrade",Host:null!==(t=n.parse(e).host)&&void 0!==t?t:"","Sec-WebSocket-Key":s,"Sec-WebSocket-Version":"13",Upgrade:"websocket"};(()=>{if(e.startsWith("wss:"))return function(e,t){return new Promise(((s,r)=>{a.get(e,t).on("upgrade",((e,t,r)=>{s({response:e,socket:t,buffer:r})})).on("error",r)}))}("https:"+e.substring(4),{headers:d,rejectUnauthorized:!1});if(e.startsWith("ws:"))return function(e,t){return new Promise(((s,r)=>{i.get(e,t).on("upgrade",((e,t,r)=>{s({response:e,socket:t,buffer:r})})).on("error",r)}))}("http:"+e.substring(3),{headers:d});throw`Expected ${e} to be a WebSocket URL!`})().then((e=>{var t,i;let a=e.response,n=e.socket,o=e.buffer;if(n.on("close",(()=>{this.state=u.ReadyState.CLOSED,this.listeners.route("close",void 0)})),n.on("error",(()=>{this.state=u.ReadyState.CLOSING,this.listeners.route("error",void 0),n.end()})),101!==a.statusCode)return n.emit("error");if("upgrade"!==(null===(t=c.getHeader(a,"Connection"))||void 0===t?void 0:t.toLowerCase()))return n.emit("error");if("websocket"!==(null===(i=c.getHeader(a,"Upgrade"))||void 0===i?void 0:i.toLowerCase()))return n.emit("error");let d=r.createHash("sha1").update(s+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11").digest("base64");if(c.getHeader(a,"Sec-WebSocket-Accept")!==d)return n.emit("error");this.socket=n;let f=()=>{for(;;)try{let e={buffer:o,offset:0},t=l.decodeFrame(e);this.onFrame(n,t),o=o.slice(e.offset)}catch(e){break}};this.socket.on("data",(e=>{o=Buffer.concat([o,e]),f()})),this.state=u.ReadyState.OPEN,this.listeners.route("open",void 0),f()}))}onFrame(e,t){if(0!==t.reserved1||0!==t.reserved2||0!==t.reserved3)return this.close(u.StatusCode.PROTOCOL_ERROR);if(t.opcode<8){if(t.opcode!==l.WebSocketFrameType.CONTINUATION&&t.opcode!==l.WebSocketFrameType.TEXT&&t.opcode!=l.WebSocketFrameType.BINARY)return this.close(u.StatusCode.PROTOCOL_ERROR);if(0===this.pending.length){if(t.opcode===l.WebSocketFrameType.CONTINUATION)return this.close(u.StatusCode.PROTOCOL_ERROR)}else if(t.opcode!==l.WebSocketFrameType.CONTINUATION)return this.close(u.StatusCode.PROTOCOL_ERROR);if(this.pending.push(t.payload),1===t.final){let e=Buffer.concat(this.pending);this.pending.splice(0),this.listeners.route("message",{data:e.toString()})}}else{if(1!==t.final)return this.close(u.StatusCode.PROTOCOL_ERROR);if(t.payload.length>125)return this.close(u.StatusCode.PROTOCOL_ERROR);if(t.opcode===l.WebSocketFrameType.CLOSE){if(this.readyState===u.ReadyState.CLOSING)return e.end();e.write(l.encodeFrame(Object.assign(Object.assign({},t),{masked:1})),(()=>e.end()))}else if(t.opcode===l.WebSocketFrameType.PING)e.write(l.encodeFrame(Object.assign(Object.assign({},t),{opcode:10,masked:1})));else if(t.opcode!==l.WebSocketFrameType.PONG)return this.close(u.StatusCode.PROTOCOL_ERROR)}}addEventListener(e,t){this.listeners.addObserver(e,t)}close(e){if(this.state!==u.ReadyState.OPEN)throw"Expected socket to be open!";const t=this.socket;if(d.absent(t))throw"Expected socket to be open!";let s=Buffer.alloc(0);d.present(e)&&(s=Buffer.concat([Buffer.alloc(2),Buffer.from("Connection closed by client.")]),s.writeUInt16BE(e,0));let r=l.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:l.WebSocketFrameType.CLOSE,masked:1,payload:s});t.write(r),this.state=u.ReadyState.CLOSING}removeEventListener(e,t){this.listeners.removeObserver(e,t)}send(e){if(this.state!==u.ReadyState.OPEN)throw"Expected socket to be open!";let t=this.socket;if(d.absent(t))throw"Expected socket to be open!";let s=l.WebSocketFrameType.BINARY;e instanceof Buffer||(e=Buffer.from(e,"utf8"),s=l.WebSocketFrameType.TEXT);let r=l.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:s,masked:1,payload:e});t.write(r)}get readyState(){return this.state}}},1410:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.encodeFrame=t.decodeFrame=t.WebSocketFrameType=void 0;const r=s(6417);var i;(i=t.WebSocketFrameType||(t.WebSocketFrameType={}))[i.CONTINUATION=0]="CONTINUATION",i[i.TEXT=1]="TEXT",i[i.BINARY=2]="BINARY",i[i.UNUSED_3=3]="UNUSED_3",i[i.UNUSED_4=4]="UNUSED_4",i[i.UNUSED_5=5]="UNUSED_5",i[i.UNUSED_6=6]="UNUSED_6",i[i.UNUSED_7=7]="UNUSED_7",i[i.CLOSE=8]="CLOSE",i[i.PING=9]="PING",i[i.PONG=10]="PONG",i[i.UNUSED_B=11]="UNUSED_B",i[i.UNUSED_C=12]="UNUSED_C",i[i.UNUSED_D=13]="UNUSED_D",i[i.UNUSED_E=14]="UNUSED_E",i[i.UNUSED_F=15]="UNUSED_F",t.decodeFrame=function(e){let t=e.buffer.readUInt8(e.offset)>>7&1,s=e.buffer.readUInt8(e.offset)>>6&1,r=e.buffer.readUInt8(e.offset)>>5&1,i=e.buffer.readUInt8(e.offset)>>4&1,a=e.buffer.readUInt8(e.offset)>>0&15;e.offset+=1;let n=e.buffer.readUInt8(e.offset)>>7&1,o=e.buffer.readUInt8(e.offset)>>0&127;if(e.offset+=1,126===o){if(o=e.buffer.readUInt16BE(e.offset),e.offset+=2,o<=125)throw"Invalid frame encoding!"}else if(127===o){if(0!==e.buffer.readUInt32BE(e.offset))throw"Invalid frame encoding!";if(e.offset+=4,o=e.buffer.readUInt32BE(e.offset),e.offset+=4,o<=65535)throw"Invalid frame encoding!"}let l=Buffer.alloc(4);if(1===n&&(l=e.buffer.slice(e.offset,e.offset+4),e.offset+=4),e.offset+o>e.buffer.length)throw"Invalid frame encoding!";let d=e.buffer.slice(e.offset,e.offset+o);if(e.offset+=o,1===n)for(let e=0;e<d.length;e++)d[e]=d[e]^l[3&e];return{final:t,reserved1:s,reserved2:r,reserved3:i,opcode:a,masked:n,payload:d}},t.encodeFrame=function(e){let t=new Array,s=e.payload.length,i=Buffer.alloc(2);t.push(i);let a=0;if(a|=(1&e.final)<<7,a|=(1&e.reserved1)<<6,a|=(1&e.reserved2)<<5,a|=(1&e.reserved3)<<4,a|=(15&e.opcode)<<0,i.writeUInt8(a,0),s<=125){let t=0;t|=(1&e.masked)<<7,t|=(127&s)<<0,i.writeUInt8(t,1)}else if(s<=65535){let r=0;r|=(1&e.masked)<<7,r|=126,i.writeUInt8(r,1);let a=Buffer.alloc(2);a.writeUInt16BE(s,0),t.push(a)}else{if(!(s<=4294967295))throw"Invalid frame size!";{let r=0;r|=(1&e.masked)<<7,r|=127,i.writeUInt8(r,1);let a=Buffer.alloc(8);a.writeUInt32BE(s,4),t.push(a)}}if(1===e.masked){let s=r.randomBytes(4),i=Buffer.concat([e.payload]);for(let e=0;e<i.length;e++)i[e]=i[e]^s[3&e];t.push(s,i)}else t.push(e.payload);return Buffer.concat(t)}},4545:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.client=s(5745),t.frames=s(1410),t.server=s(8447),t.shared=s(8611);var r=s(5745);Object.defineProperty(t,"WebSocketClient",{enumerable:!0,get:function(){return r.WebSocketClient}});var i=s(8447);Object.defineProperty(t,"WebSocketServer",{enumerable:!0,get:function(){return i.WebSocketServer}})},1093:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.present=t.absent=void 0,t.absent=function(e){return null==e},t.present=function(e){return null!=e}},8447:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketServer=void 0;const r=s(6417),i=s(4016),a=s(7978),n=s(1410),o=s(1093),l=s(8611),d=s(2302);t.WebSocketServer=class{constructor(){this.pending_chunks=new Map,this.states=new Map,this.connections=new d.BiMap,this.router=new a.routing.MessageRouter}onFrame(e,t,s,r){if(0!==r.reserved1||0!==r.reserved2||0!==r.reserved3)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(1!==r.masked)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(r.opcode<8){if(r.opcode!==n.WebSocketFrameType.CONTINUATION&&r.opcode!==n.WebSocketFrameType.TEXT&&r.opcode!=n.WebSocketFrameType.BINARY)return this.close(e,l.StatusCode.PROTOCOL_ERROR);{let s=this.pending_chunks.get(e);if(o.absent(s))s=new Array,this.pending_chunks.set(e,s);else if(r.opcode!==n.WebSocketFrameType.CONTINUATION)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(s.push(r.payload),1===r.final){let r=Buffer.concat(s);this.pending_chunks.delete(e),this.router.route("message",{connection_id:e,connection_url:t,buffer:r})}}}else{if(1!==r.final)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(r.payload.length>125)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(r.opcode===n.WebSocketFrameType.CLOSE){if(this.states.get(e)===l.ReadyState.CLOSING)return s.end();s.write(n.encodeFrame(Object.assign(Object.assign({},r),{masked:0})),(()=>s.end()))}else if(r.opcode===n.WebSocketFrameType.PING)s.write(n.encodeFrame(Object.assign(Object.assign({},r),{opcode:10,masked:0})));else if(r.opcode!==n.WebSocketFrameType.PONG)return this.close(e,l.StatusCode.PROTOCOL_ERROR)}}broadcast(e){for(let[t,s]of this.connections)this.states.get(t)===l.ReadyState.OPEN&&this.send(t,e)}addEventListener(e,t){return this.router.addObserver(e,t)}close(e,t){if(this.states.get(e)!==l.ReadyState.OPEN)throw"Expected socket to be open!";const s=this.connections.value(e);if(o.absent(s))throw'Connection with id "'+e+'" has no socket!';let r=Buffer.alloc(0);o.present(t)&&(r=Buffer.concat([Buffer.alloc(2),Buffer.from("Connection closed by server.")]),r.writeUInt16BE(t,0));let i=n.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:n.WebSocketFrameType.CLOSE,masked:0,payload:r});s.write(i),this.states.set(e,l.ReadyState.CLOSING)}getRequestHandler(){return(e,t)=>{let s=e.socket,a=this.connections.key(s);if(o.present(a))return t.writeHead(400),t.end();let u=e.httpVersionMajor,c=e.httpVersionMinor;if(u<1||1===u&&c<1)return t.writeHead(400),t.end();if("GET"!==e.method)return t.writeHead(400),t.end();let f=d.getHeader(e,"Host");if(o.absent(f))return t.writeHead(400),t.end();let g=d.getHeader(e,"Upgrade");if(o.absent(g)||"websocket"!==g.toLowerCase())return t.writeHead(400),t.end();let p=d.getHeader(e,"Connection");if(o.absent(p)||"upgrade"!==p.toLowerCase())return t.writeHead(400),t.end();let h=d.getHeader(e,"Sec-WebSocket-Key");if(o.absent(h)||16!==Buffer.from(h,"base64").length)return t.writeHead(400),t.end();if("13"!==d.getHeader(e,"Sec-WebSocket-Version"))return t.writeHead(426,{"Sec-WebSocket-Version":"13"}),t.end();let m=r.createHash("sha1").update(h+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11").digest("base64");return t.writeHead(101,{Upgrade:"websocket",Connection:"Upgrade","Sec-WebSocket-Accept":m}),t.end((()=>{let t=r.randomBytes(16).toString("hex"),a=function(e){let t=e.headers.host||"",s=e.url||"/";return`${e.socket instanceof i.TLSSocket?"wss:":"ws:"}//${t}${s}`}(e),o=Buffer.alloc(0);s.on("data",(e=>{for(o=Buffer.concat([o,e]);;)try{let e={buffer:o,offset:0},r=n.decodeFrame(e);this.onFrame(t,a,s,r),o=o.slice(e.offset)}catch(e){break}})),s.on("close",(()=>{this.connections.remove(t),this.states.delete(t),this.router.route("disconnect",{connection_id:t,connection_url:a})})),s.setTimeout(0),this.connections.add(t,s),this.states.set(t,l.ReadyState.OPEN),this.router.route("connect",{connection_id:t,connection_url:a})}))}}removeEventListener(e,t){return this.router.removeObserver(e,t)}send(e,t){if(this.states.get(e)!==l.ReadyState.OPEN)throw"Expected socket to be open!";let s=this.connections.value(e);if(o.absent(s))throw'Connection with id "'+e+'" has no socket!';let r=n.WebSocketFrameType.BINARY;t instanceof Buffer||(t=Buffer.from(t,"utf8"),r=n.WebSocketFrameType.TEXT);let i=n.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:r,masked:0,payload:t});s.write(i)}}},8611:(e,t)=>{var s,r;Object.defineProperty(t,"__esModule",{value:!0}),t.StatusCode=t.ReadyState=void 0,(r=t.ReadyState||(t.ReadyState={}))[r.CONNECTING=0]="CONNECTING",r[r.OPEN=1]="OPEN",r[r.CLOSING=2]="CLOSING",r[r.CLOSED=3]="CLOSED",(s=t.StatusCode||(t.StatusCode={}))[s.NORMAL=1e3]="NORMAL",s[s.GOING_AWAY=1001]="GOING_AWAY",s[s.PROTOCOL_ERROR=1002]="PROTOCOL_ERROR",s[s.DATA_TYPE_NOT_ACCEPTED=1003]="DATA_TYPE_NOT_ACCEPTED",s[s.RESERVED_1004=1004]="RESERVED_1004",s[s.RESERVED_1005=1005]="RESERVED_1005",s[s.RESERVED_1006=1006]="RESERVED_1006",s[s.BAD_DATA_TYPE=1007]="BAD_DATA_TYPE",s[s.POLICY_VIOLATION=1008]="POLICY_VIOLATION",s[s.MESSAGE_TOO_BIG=1009]="MESSAGE_TOO_BIG",s[s.CLIENT_EXPECTED_EXTENSION=1010]="CLIENT_EXPECTED_EXTENSION",s[s.SERVER_UNEXPECTED_CONDITION=1011]="SERVER_UNEXPECTED_CONDITION",s[s.RESERVED_1015=1015]="RESERVED_1015"},2302:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BiMap=t.getHeader=void 0;const r=s(1093);t.getHeader=function(e,t){let s=e.headers[t.toLowerCase()];if(r.present(s)){if(s.constructor===String)return s;if(s.constructor===Array&&1===s.length)return s[0]}return null};class i{constructor(){this.value_to_key=new Map,this.key_to_value=new Map}[Symbol.iterator](){return this.key_to_value[Symbol.iterator]()}add(e,t){this.value_to_key.set(t,e),this.key_to_value.set(e,t)}key(e){return this.value_to_key.get(e)||null}remove(e){let t=this.key_to_value.get(e);r.present(t)&&this.value_to_key.delete(t),this.key_to_value.delete(e)}value(e){return this.key_to_value.get(e)||null}}t.BiMap=i},7978:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.routing=s(7220)},7220:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.NamespacedMessageRouter=t.MessageRouter=void 0;class s{constructor(){this.observers=new Map}addObserver(e,t){let s=this.observers.get(e);void 0===s&&(s=new Set,this.observers.set(e,s)),s.add(t)}removeObserver(e,t){let s=this.observers.get(e);void 0!==s&&s.delete(t)}route(e,t){let s=this.observers.get(e);if(void 0!==s)for(let e of s)e(t)}}t.MessageRouter=s,t.NamespacedMessageRouter=class{constructor(){this.routers=new Map}addObserver(e,t,r){let i=this.routers.get(e);void 0===i&&(i=new s,this.routers.set(e,i)),i.addObserver(t,r)}removeObserver(e,t,s){let r=this.routers.get(e);void 0!==r&&r.removeObserver(t,s)}route(e,t,s){let r=this.routers.get(e);void 0!==r&&r.route(t,s)}}},3129:e=>{e.exports=require("child_process")},6417:e=>{e.exports=require("crypto")},6200:e=>{e.exports=require("dgram")},5747:e=>{e.exports=require("fs")},8605:e=>{e.exports=require("http")},7211:e=>{e.exports=require("https")},1631:e=>{e.exports=require("net")},5622:e=>{e.exports=require("path")},4016:e=>{e.exports=require("tls")},8835:e=>{e.exports=require("url")}},t={};!function s(r){if(t[r])return t[r].exports;var i=t[r]={exports:{}};return e[r].call(i.exports,i,i.exports,s),i.exports}(7045)})();