(()=>{"use strict";var e={375:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Union=t.Undefined=t.Tuple=t.StringLiteral=t.String=t.Reference=t.Record=t.Object=t.NumberLiteral=t.Number=t.Null=t.Intersection=t.BooleanLiteral=t.Boolean=t.Array=t.Any=void 0,t.Any={as:(e,t="")=>e,is(e){try{this.as(e)}catch(e){return!1}return!0}},t.Array={of:e=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Array){for(let i=0;i<t.length;i++)e.as(t[i],r+"["+i+"]");return t}throw"Expected an array at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Boolean={as(e,t=""){if(null!=e&&e.constructor===globalThis.Boolean)return e;throw"Expected a boolean at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.BooleanLiteral={of:e=>({as(t,r=""){if(t===e)return t;throw"Expected "+e+" at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Intersection={of:(...e)=>({as(t,r=""){for(let i of e)i.as(t,r);return t},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Null={as(e,t=""){if(null===e)return e;throw"Expected null at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.Number={as(e,t=""){if(null!=e&&e.constructor===globalThis.Number)return e;throw"Expected a number at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.NumberLiteral={of:e=>({as(t,r=""){if(t===e)return t;throw"Expected "+e+" at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Object={of:e=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Object){for(let i in e)e[i].as(t[i],r+/^([a-z][a-z0-9_]*)$/is.test(i)?"."+i:'["'+i+'"]');return t}throw"Expected an object at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Record={of:e=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Object){for(let i of globalThis.Object.keys(t))e.as(t[i],r+'["'+i+'"]');return t}throw"Expected a record at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Reference={of:e=>({as:(t,r="")=>e().as(t,r),is:t=>e().is(t)})},t.String={as(e,t=""){if(null!=e&&e.constructor===globalThis.String)return e;throw"Expected a string at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.StringLiteral={of:e=>({as(t,r=""){if(t===e)return t;throw'Expected "'+e+'" at '+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Tuple={of:(...e)=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Array){for(let i=0;i<e.length;i++)e[i].as(t[i],r+"["+i+"]");return t}throw"Expected a tuple at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Undefined={as(e,t=""){if(void 0===e)return e;throw"Expected undefined at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.Union={of:(...e)=>({as(t,r=""){for(let i of e)try{return i.as(t,r)}catch(e){}throw"Expected a union at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})}},175:(e,t,r)=>{t.m7=t.l8=void 0;const i=r(375);t.l8=i;r(226);const n=r(129);t.m7=n;r(329)},226:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Schema=t.UnionType=t.UndefinedType=t.TupleType=t.StringLiteralType=t.StringType=t.ReferenceType=t.RecordType=t.ObjectType=t.NumberLiteralType=t.NumberType=t.NullType=t.IntersectionType=t.GroupType=t.BooleanLiteralType=t.BooleanType=t.ArrayType=t.AnyType=t.Type=void 0;const i=r(329);t.Type={parse(e,...t){try{return v.parse(e,...t)}catch(e){}try{return d.parse(e,...t)}catch(e){}try{return s.parse(e,...t)}catch(e){}try{return n.parse(e)}catch(e){}try{return o.parse(e)}catch(e){}try{return l.parse(e)}catch(e){}try{return u.parse(e)}catch(e){}try{return c.parse(e)}catch(e){}try{return f.parse(e)}catch(e){}try{return g.parse(e)}catch(e){}try{return y.parse(e)}catch(e){}try{return _.parse(e)}catch(e){}try{return m.parse(e)}catch(e){}try{return b.parse(e)}catch(e){}try{return p.parse(e)}catch(e){}try{return a.parse(e)}catch(e){}try{return h.parse(e)}catch(e){}return e.newContext(((e,t)=>{let r=e();throw`Unexpected ${r.family} at row ${r.row}, col ${r.col}!`}))}};class n{constructor(){}generateType(e){return"any"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\treturn subject;"),t.push("}")):t.push("autoguard.Any"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>(i.expect(e(),"any"),n.INSTANCE)))}}t.AnyType=n,n.INSTANCE=new n;class s{constructor(e){this.type=e}generateType(e){return this.type.generateType(e)+"[]"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Array)) {"),t.push("\t\tfor (let i = 0; i < subject.length; i++) {"),t.push("\t\t\t("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t\t"}))+')(subject[i], path + "[" + i + "]");'),t.push("\t\t}"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected an array at " + path + "!";'),t.push("}")):t.push("autoguard.Array.of("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}getImports(){return this.type.getImports()}static parse(e,...r){if(r.includes("Array"))throw"Recursion prevention!";return e.newContext(((n,o)=>{let l=t.Type.parse(e,...r,"Array");i.expect(n(),"["),i.expect(n(),"]");let a=new s(l);for(;;)try{e.newContext(((e,t)=>{i.expect(e(),"["),i.expect(e(),"]"),a=new s(a)}))}catch(e){break}return a}))}}t.ArrayType=s;class o{constructor(){}generateType(e){return"boolean"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Boolean)) {"),t.push("\t\treturn subject as boolean;"),t.push("\t}"),t.push('\tthrow "Expected a boolean at " + path + "!";'),t.push("}")):t.push("autoguard.Boolean"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>(i.expect(e(),"boolean"),o.INSTANCE)))}}t.BooleanType=o,o.INSTANCE=new o;class l{constructor(e){this.value=e}generateType(e){return""+this.value}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+") {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected '+this.value+' at " + path + "!";'),t.push("}")):t.push("autoguard.BooleanLiteral.of("+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>"true"===i.expect(e(),["true","false"]).family?l.INSTANCE_TRUE:l.INSTANCE_FALSE))}}t.BooleanLiteralType=l,l.INSTANCE_TRUE=new l(!0),l.INSTANCE_FALSE=new l(!1);class a{constructor(e){this.type=e}generateType(e){return"("+this.type.generateType(e)+")"}generateTypeGuard(e){return this.type.generateTypeGuard(e)}getImports(){return this.type.getImports()}static parse(e){return e.newContext(((r,n)=>{i.expect(r(),"(");let s=t.Type.parse(e);return i.expect(r(),")"),new a(s)}))}}t.GroupType=a;class d{constructor(){this.types=new Set}add(e){return this.types.add(e),this}generateType(e){let t=new Array;for(let r of this.types)t.push(r.generateType(e));return t.join(" & ")}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {");for(let r of this.types)t.push("\t("+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+")(subject, path);");return t.push("\treturn subject;"),t.push("}"),t.join(e.eol)}for(let r of this.types)t.push("\t"+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"autoguard.Intersection.of("+e.eol+t.join(","+e.eol)+e.eol+")"}getImports(){let e=new Array;for(let t of this.types)e.push(...t.getImports());return e}static parse(e,...r){if(r.includes("Intersection"))throw"Recursion prevention!";return e.newContext(((n,s)=>{var o;let l=t.Type.parse(e,...r,"Intersection"),a=new d;for(a.add(l);"&"===(null===(o=s())||void 0===o?void 0:o.value);){i.expect(n(),"&");let s=t.Type.parse(e,...r,"Intersection");a.add(s)}return 1===a.types.size?l:a}))}}t.IntersectionType=d;class u{constructor(){}generateType(e){return"null"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === null) {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected null at " + path + "!";'),t.push("}")):t.push("autoguard.Null"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>(i.expect(e(),"null"),u.INSTANCE)))}}t.NullType=u,u.INSTANCE=new u;class c{constructor(){}generateType(e){return"number"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Number)) {"),t.push("\t\treturn subject as number;"),t.push("\t}"),t.push('\tthrow "Expected a number at " + path + "!";'),t.push("}")):t.push("autoguard.Number"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>(i.expect(e(),"number"),c.INSTANCE)))}}t.NumberType=c,c.INSTANCE=new c;class f{constructor(e){this.value=e}generateType(e){return""+this.value}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+") {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected '+this.value+' at " + path + "!";'),t.push("}")):t.push("autoguard.NumberLiteral.of("+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>{let r=i.expect(e(),"NUMBER_LITERAL").value;return new f(Number.parseInt(r))}))}}t.NumberLiteralType=f;class p{constructor(){this.members=new Map}add(e,t){return this.members.set(e,t),this}generateType(e){if(0===this.members.size)return"{}";let t=new Array;for(let[r,i]of this.members)t.push('\t"'+r+'"'+(i.optional?"?":"")+": "+i.type.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"{"+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+"}"}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Object)) {");for(let[r,i]of this.members){let n=i.type;if(i.optional){let e=new v;e.add(_.INSTANCE),e.add(n),n=e}let s=/^([a-z][a-z0-9_]*)$/is.test(r)?'".'+r+'"':'"[\\"'+r+'\\"]"';t.push("\t\t("+n.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+')(subject["'+r+'"], path + '+s+");")}return t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected an object at " + path + "!";'),t.push("}"),t.join(e.eol)}for(let[r,i]of this.members){let n=i.type;if(i.optional){let e=new v;e.add(_.INSTANCE),e.add(n),n=e}t.push('\t"'+r+'": '+n.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})))}return"autoguard.Object.of<"+(null!=this.typename?this.typename:this.generateType(e))+">({"+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+"})"}getImports(){let e=new Array;for(let[t,r]of this.members){let t=r.type;e.push(...t.getImports())}return e}setTypename(e){this.typename=e}static parse(e){return e.newContext(((r,n)=>{var s,o,l;i.expect(r(),"{");let a=new p;if("}"!==(null===(s=n())||void 0===s?void 0:s.value))for(;;){let s=!1,d=i.expect(r(),["any","boolean","false","null","number","string","true","undefined","IDENTIFIER","STRING_LITERAL"]),u="STRING_LITERAL"===d.family?d.value.slice(1,-1):d.value;"?"===(null===(o=n())||void 0===o?void 0:o.value)&&(r(),s=!0),i.expect(r(),":");let c=t.Type.parse(e);if(a.add(u,{type:c,optional:s}),","!==(null===(l=n())||void 0===l?void 0:l.value))break;i.expect(r(),",")}return i.expect(r(),"}"),a}))}}t.ObjectType=p;class h{constructor(e){this.type=e}generateType(e){return"Record<string, undefined | "+this.type.generateType(e)+">"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Object)) {"),t.push("\t\tfor (let key of globalThis.Object.keys(subject)) {"),t.push("\t\t\t("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t\t"}))+')(subject[key], path + "[\\"" + key + "\\"]");'),t.push("\t\t}"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected a record at " + path + "!";'),t.push("}")):t.push("autoguard.Record.of("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}getImports(){return this.type.getImports()}static parse(e){return e.newContext(((r,n)=>{i.expect(r(),"{");let s=t.Type.parse(e);return i.expect(r(),"}"),new h(s)}))}}t.RecordType=h;class m{constructor(e,t){this.path=e,this.typename=t}generateType(e){return this.typename}generateTypeGuard(e){return e.standalone?this.typename+".as":"autoguard.Reference.of<"+this.typename+">(() => "+this.typename+")"}getImports(){return this.path.length>0?[{path:this.path,typename:this.typename}]:[]}static parse(e){return e.newContext(((e,t)=>{var r,n;"@"===(null===(r=t())||void 0===r?void 0:r.family)&&i.expect(e(),"@");let s=new Array;for(;;){let r=e();if(i.expect(r,[".","..","IDENTIFIER"]),s.push(r),"/"!==(null===(n=t())||void 0===n?void 0:n.family))break;i.expect(e(),"/")}let o=s.pop();return i.expect(o,"IDENTIFIER"),new m(s.map((e=>e.value)),o.value)}))}}t.ReferenceType=m;class g{constructor(){}generateType(e){return"string"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.String)) {"),t.push("\t\treturn subject as string;"),t.push("\t}"),t.push('\tthrow "Expected a string at " + path + "!";'),t.push("}")):t.push("autoguard.String"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>(i.expect(e(),"string"),g.INSTANCE)))}}t.StringType=g,g.INSTANCE=new g;class y{constructor(e){this.value=e}generateType(e){return'"'+this.value+'"'}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+") {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected \\"'+this.value+'\\" at " + path + "!";'),t.push("}")):t.push('autoguard.StringLiteral.of("'+this.value+'")'),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>{let r=i.expect(e(),"STRING_LITERAL").value;return new y(r.slice(1,-1))}))}}t.StringLiteralType=y;class b{constructor(){this.types=new Array}add(e){return this.types.push(e),this}generateType(e){let t=new Array;for(let r of this.types)t.push("\t"+r.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"["+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+"]"}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Array)) {");for(let r=0;r<this.types.length;r++){let i=this.types[r];t.push("\t\t("+i.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+")(subject["+r+'], path + "['+r+']");')}return t.push("\t\treturn subject as "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+";"),t.push("\t}"),t.push('\tthrow "Expected a tuple at " + path + "!";'),t.push("}"),t.join(e.eol)}for(let r of this.types)t.push("\t"+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"autoguard.Tuple.of("+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+")"}getImports(){let e=new Array;for(let t of this.types)e.push(...t.getImports());return e}static parse(e){return e.newContext(((r,n)=>{var s,o;i.expect(r(),"[");let l=new b;if("]"!==(null===(s=n())||void 0===s?void 0:s.value))for(;;){let s=t.Type.parse(e);if(l.add(s),","!==(null===(o=n())||void 0===o?void 0:o.value))break;i.expect(r(),",")}return i.expect(r(),"]"),l}))}}t.TupleType=b;class _{constructor(){}generateType(e){return"undefined"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === undefined) {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected undefined at " + path + "!";'),t.push("}")):t.push("autoguard.Undefined"),t.join(e.eol)}getImports(){return[]}static parse(e){return e.newContext(((e,t)=>(i.expect(e(),"undefined"),_.INSTANCE)))}}t.UndefinedType=_,_.INSTANCE=new _;class v{constructor(){this.types=new Set}add(e){return this.types.add(e),this}generateType(e){let t=new Array;for(let r of this.types)t.push(r.generateType(e));return t.join(" | ")}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {");for(let r of this.types)t.push("\ttry {"),t.push("\t\treturn ("+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+")(subject, path);"),t.push("\t} catch (error) {}");return t.push('\tthrow "Expected a union at " + path + "!";'),t.push("}"),t.join(e.eol)}for(let r of this.types)t.push("\t"+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"autoguard.Union.of("+e.eol+t.join(","+e.eol)+e.eol+")"}getImports(){let e=new Array;for(let t of this.types)e.push(...t.getImports());return e}static parse(e,...r){if(r.includes("Union"))throw"Recursion prevention!";return e.newContext(((n,s)=>{var o;let l=t.Type.parse(e,...r,"Union"),a=new v;for(a.add(l);"|"===(null===(o=s())||void 0===o?void 0:o.value);){i.expect(n(),"|");let s=t.Type.parse(e,...r,"Union");a.add(s)}return 1===a.types.size?l:a}))}}t.UnionType=v;class S{constructor(){this.types=new Map}getImports(){let e=new Map;for(let[t,r]of this.types){let t=r.getImports();for(let r of t)e.set(r.typename,r.path)}return Array.from(e.entries()).sort(((e,t)=>e[0].localeCompare(t[0]))).map((e=>({path:e[1],typename:e[0]})))}add(e,t){return this.types.set(e,t),this}generateModule(e){let t=new Array;t.push("// This file was auto-generated by @joelek/ts-autoguard. Edit at own risk."),t.push("");let r=this.getImports();for(let e of r)t.push("import { "+e.typename+' } from "'+e.path.join("/")+'";');e.standalone||t.push('import { guards as autoguard } from "@joelek/ts-autoguard";'),t.push("");for(let[r,i]of this.types)t.push("export type "+r+" = "+i.generateType(e)+";"),t.push(""),e.standalone?(t.push("export const "+r+" = {"),t.push('\tas(subject: any, path: string = ""): '+r+" {"),t.push("\t\treturn ("+i.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+")(subject, path);"),t.push("\t},"),t.push("\tis(subject: any): subject is "+r+" {"),t.push("\t\ttry {"),t.push("\t\t\tthis.as(subject);"),t.push("\t\t} catch (error) {"),t.push("\t\t\treturn false;"),t.push("\t\t}"),t.push("\t\treturn true;"),t.push("\t}"),t.push("};"),t.push("")):(t.push("export const "+r+" = "+i.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol}))+";"),t.push(""));let i=new p;for(let[e,t]of this.types)i.add(e,{type:new m([],e),optional:!1});return t.push("export type Autoguard = "+i.generateType(e)+";"),t.push(""),t.push("export const Autoguard = "+i.generateType(e)+";"),t.push(""),t.join(e.eol)}static parse(e){return e.newContext(((r,n)=>{var s,o,l;i.expect(r(),"{");let a=new S;if("}"!==(null===(s=n())||void 0===s?void 0:s.value))for(;;){let s=i.expect(r(),"IDENTIFIER").value;i.expect(r(),":");let d=t.Type.parse(e);if(null===(o=d.setTypename)||void 0===o||o.call(d,s),a.add(s,d),","!==(null===(l=n())||void 0===l?void 0:l.value))break;i.expect(r(),",")}if(i.expect(r(),"}"),null!=n())throw"Expected end of stream!";return a}))}}t.Schema=S},129:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MessageSerializer=void 0,t.MessageSerializer=class{constructor(e){this.guards=e}deserialize(e,t){let r=JSON.parse(e);if(null==r||r.constructor!==Object||null==r.type||r.type.constructor!==String)throw"Invalid message envelope!";{let e=r.type,i=r.data,n=this.guards[e];if(void 0===n)throw'Unknown message type "'+e+'"!';t(e,n.as(i))}}serialize(e,t){return JSON.stringify({type:e,data:t})}}},329:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.expect=t.Tokenizer=t.Families=void 0,t.Families=["WS","(",")","[","]","{","}","?","|",".","..","/","&","@",",",":","any","boolean","false","null","number","string","true","undefined","IDENTIFIER","NUMBER_LITERAL","STRING_LITERAL"],t.Tokenizer=class{constructor(e){let t={WS:/^([\t\r\n ]+)/ius,"(":/^([\(])/ius,")":/^([\)])/ius,"[":/^([\[])/ius,"]":/^([\]])/ius,"{":/^([\{])/ius,"}":/^([\}])/ius,"?":/^([\?])/ius,"|":/^([\|])/ius,".":/^([\.])/ius,"..":/^([\.][\.])/ius,"/":/^([\/])/ius,"&":/^([&])/ius,"@":/^([@])/ius,",":/^([,])/ius,":":/^([:])/ius,any:/^(any)/ius,boolean:/^(boolean)/ius,false:/^(false)/ius,null:/^(null)/ius,number:/^(number)/ius,string:/^(string)/ius,true:/^(true)/ius,undefined:/^(undefined)/ius,IDENTIFIER:/^([a-z][a-z0-9_]*)/ius,NUMBER_LITERAL:/^(([1-9][0-9]+)|([0-9]))/ius,STRING_LITERAL:/^(["][^"]*["])/ius},r=new Array,i=1,n=1;for(;e.length>0;){let s;for(let r in t){let i=r,n=t[i].exec(e);null!=n&&(null==s||n[1].length>s[1].length)&&(s=[i,n[1]])}if(null==s)throw`Unrecognized token at row ${i}, col ${n}!`;r.push({family:s[0],value:s[1],row:i,col:n}),e=e.slice(s[1].length);let o=s[1].split(/\r?\n/);o.length>1&&(i+=o.length-1,n=1),n+=o[o.length-1].length}this.tokens=r.filter((e=>"WS"!==e.family)),this.offset=0}peek(){return this.tokens[this.offset]}read(){if(this.offset>=this.tokens.length)throw"Unexpectedly reached end of stream!";return this.tokens[this.offset++]}newContext(e){let t=this.offset;try{return e((()=>this.read()),(()=>this.peek()))}catch(e){throw this.offset=t,e}}},t.expect=function(e,t){if(!(Array.isArray(t)?t:[t]).includes(e.family))throw`Unexpected ${e.family} at row ${e.row}, col ${e.col}!`;return e}},745:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketClient=void 0;const i=r(417),n=r(605),s=r(211),o=r(835),l=r(978),a=r(410),d=r(93),u=r(611),c=r(302);t.WebSocketClient=class{constructor(e){var t;this.state=u.ReadyState.CONNECTING,this.listeners=new l.routing.MessageRouter,this.pending=new Array,this.socket=void 0;let r=i.randomBytes(16).toString("base64"),d={Connection:"upgrade",Host:null!==(t=o.parse(e).host)&&void 0!==t?t:"","Sec-WebSocket-Key":r,"Sec-WebSocket-Version":"13",Upgrade:"websocket"};(()=>{if(e.startsWith("wss:"))return function(e,t){return new Promise(((r,i)=>{s.get(e,t).on("upgrade",((e,t,i)=>{r({response:e,socket:t,buffer:i})})).on("error",i)}))}("https:"+e.substring(4),{headers:d,rejectUnauthorized:!1});if(e.startsWith("ws:"))return function(e,t){return new Promise(((r,i)=>{n.get(e,t).on("upgrade",((e,t,i)=>{r({response:e,socket:t,buffer:i})})).on("error",i)}))}("http:"+e.substring(3),{headers:d});throw`Expected ${e} to be a WebSocket URL!`})().then((e=>{var t,n;let s=e.response,o=e.socket,l=e.buffer;if(o.on("close",(()=>{this.state=u.ReadyState.CLOSED,this.listeners.route("close",void 0)})),o.on("error",(()=>{this.state=u.ReadyState.CLOSING,this.listeners.route("error",void 0),o.end()})),101!==s.statusCode)return o.emit("error");if("upgrade"!==(null===(t=c.getHeader(s,"Connection"))||void 0===t?void 0:t.toLowerCase()))return o.emit("error");if("websocket"!==(null===(n=c.getHeader(s,"Upgrade"))||void 0===n?void 0:n.toLowerCase()))return o.emit("error");let d=i.createHash("sha1").update(r+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11").digest("base64");if(c.getHeader(s,"Sec-WebSocket-Accept")!==d)return o.emit("error");this.socket=o;let f=()=>{for(;;)try{let e={buffer:l,offset:0},t=a.decodeFrame(e);this.onFrame(o,t),l=l.slice(e.offset)}catch(e){break}};this.socket.on("data",(e=>{l=Buffer.concat([l,e]),f()})),this.state=u.ReadyState.OPEN,this.listeners.route("open",void 0),f()}))}onFrame(e,t){if(0!==t.reserved1||0!==t.reserved2||0!==t.reserved3)return this.close(u.StatusCode.PROTOCOL_ERROR);if(t.opcode<8){if(t.opcode!==a.WebSocketFrameType.CONTINUATION&&t.opcode!==a.WebSocketFrameType.TEXT&&t.opcode!=a.WebSocketFrameType.BINARY)return this.close(u.StatusCode.PROTOCOL_ERROR);if(0===this.pending.length){if(t.opcode===a.WebSocketFrameType.CONTINUATION)return this.close(u.StatusCode.PROTOCOL_ERROR)}else if(t.opcode!==a.WebSocketFrameType.CONTINUATION)return this.close(u.StatusCode.PROTOCOL_ERROR);if(this.pending.push(t.payload),1===t.final){let e=Buffer.concat(this.pending);this.pending.splice(0),this.listeners.route("message",{data:e.toString()})}}else{if(1!==t.final)return this.close(u.StatusCode.PROTOCOL_ERROR);if(t.payload.length>125)return this.close(u.StatusCode.PROTOCOL_ERROR);if(t.opcode===a.WebSocketFrameType.CLOSE){if(this.readyState===u.ReadyState.CLOSING)return e.end();e.write(a.encodeFrame(Object.assign(Object.assign({},t),{masked:1})),(()=>e.end()))}else if(t.opcode===a.WebSocketFrameType.PING)e.write(a.encodeFrame(Object.assign(Object.assign({},t),{opcode:10,masked:1})));else if(t.opcode!==a.WebSocketFrameType.PONG)return this.close(u.StatusCode.PROTOCOL_ERROR)}}addEventListener(e,t){this.listeners.addObserver(e,t)}close(e){if(this.state!==u.ReadyState.OPEN)throw"Expected socket to be open!";const t=this.socket;if(d.absent(t))throw"Expected socket to be open!";let r=Buffer.alloc(0);d.present(e)&&(r=Buffer.concat([Buffer.alloc(2),Buffer.from("Connection closed by client.")]),r.writeUInt16BE(e,0));let i=a.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:a.WebSocketFrameType.CLOSE,masked:1,payload:r});t.write(i),this.state=u.ReadyState.CLOSING}removeEventListener(e,t){this.listeners.removeObserver(e,t)}send(e){if(this.state!==u.ReadyState.OPEN)throw"Expected socket to be open!";let t=this.socket;if(d.absent(t))throw"Expected socket to be open!";let r=a.WebSocketFrameType.BINARY;e instanceof Buffer||(e=Buffer.from(e,"utf8"),r=a.WebSocketFrameType.TEXT);let i=a.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:r,masked:1,payload:e});t.write(i)}get readyState(){return this.state}}},410:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.encodeFrame=t.decodeFrame=t.WebSocketFrameType=void 0;const i=r(417);var n;(n=t.WebSocketFrameType||(t.WebSocketFrameType={}))[n.CONTINUATION=0]="CONTINUATION",n[n.TEXT=1]="TEXT",n[n.BINARY=2]="BINARY",n[n.UNUSED_3=3]="UNUSED_3",n[n.UNUSED_4=4]="UNUSED_4",n[n.UNUSED_5=5]="UNUSED_5",n[n.UNUSED_6=6]="UNUSED_6",n[n.UNUSED_7=7]="UNUSED_7",n[n.CLOSE=8]="CLOSE",n[n.PING=9]="PING",n[n.PONG=10]="PONG",n[n.UNUSED_B=11]="UNUSED_B",n[n.UNUSED_C=12]="UNUSED_C",n[n.UNUSED_D=13]="UNUSED_D",n[n.UNUSED_E=14]="UNUSED_E",n[n.UNUSED_F=15]="UNUSED_F",t.decodeFrame=function(e){let t=e.buffer.readUInt8(e.offset)>>7&1,r=e.buffer.readUInt8(e.offset)>>6&1,i=e.buffer.readUInt8(e.offset)>>5&1,n=e.buffer.readUInt8(e.offset)>>4&1,s=e.buffer.readUInt8(e.offset)>>0&15;e.offset+=1;let o=e.buffer.readUInt8(e.offset)>>7&1,l=e.buffer.readUInt8(e.offset)>>0&127;if(e.offset+=1,126===l){if(l=e.buffer.readUInt16BE(e.offset),e.offset+=2,l<=125)throw"Invalid frame encoding!"}else if(127===l){if(0!==e.buffer.readUInt32BE(e.offset))throw"Invalid frame encoding!";if(e.offset+=4,l=e.buffer.readUInt32BE(e.offset),e.offset+=4,l<=65535)throw"Invalid frame encoding!"}let a=Buffer.alloc(4);if(1===o&&(a=e.buffer.slice(e.offset,e.offset+4),e.offset+=4),e.offset+l>e.buffer.length)throw"Invalid frame encoding!";let d=e.buffer.slice(e.offset,e.offset+l);if(e.offset+=l,1===o)for(let e=0;e<d.length;e++)d[e]=d[e]^a[3&e];return{final:t,reserved1:r,reserved2:i,reserved3:n,opcode:s,masked:o,payload:d}},t.encodeFrame=function(e){let t=new Array,r=e.payload.length,n=Buffer.alloc(2);t.push(n);let s=0;if(s|=(1&e.final)<<7,s|=(1&e.reserved1)<<6,s|=(1&e.reserved2)<<5,s|=(1&e.reserved3)<<4,s|=(15&e.opcode)<<0,n.writeUInt8(s,0),r<=125){let t=0;t|=(1&e.masked)<<7,t|=(127&r)<<0,n.writeUInt8(t,1)}else if(r<=65535){let i=0;i|=(1&e.masked)<<7,i|=126,n.writeUInt8(i,1);let s=Buffer.alloc(2);s.writeUInt16BE(r,0),t.push(s)}else{if(!(r<=4294967295))throw"Invalid frame size!";{let i=0;i|=(1&e.masked)<<7,i|=127,n.writeUInt8(i,1);let s=Buffer.alloc(8);s.writeUInt32BE(r,4),t.push(s)}}if(1===e.masked){let r=i.randomBytes(4),n=Buffer.concat([e.payload]);for(let e=0;e<n.length;e++)n[e]=n[e]^r[3&e];t.push(r,n)}else t.push(e.payload);return Buffer.concat(t)}},545:(e,t,r)=>{r(745),r(410),r(447),r(611);var i=r(745);Object.defineProperty(t,"yU",{enumerable:!0,get:function(){return i.WebSocketClient}});var n=r(447);Object.defineProperty(t,"u9",{enumerable:!0,get:function(){return n.WebSocketServer}})},93:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.present=t.absent=void 0,t.absent=function(e){return null==e},t.present=function(e){return null!=e}},447:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketServer=void 0;const i=r(417),n=r(16),s=r(978),o=r(410),l=r(93),a=r(611),d=r(302);t.WebSocketServer=class{constructor(){this.pending_chunks=new Map,this.states=new Map,this.connections=new d.BiMap,this.router=new s.routing.MessageRouter}onFrame(e,t,r,i){if(0!==i.reserved1||0!==i.reserved2||0!==i.reserved3)return this.close(e,a.StatusCode.PROTOCOL_ERROR);if(1!==i.masked)return this.close(e,a.StatusCode.PROTOCOL_ERROR);if(i.opcode<8){if(i.opcode!==o.WebSocketFrameType.CONTINUATION&&i.opcode!==o.WebSocketFrameType.TEXT&&i.opcode!=o.WebSocketFrameType.BINARY)return this.close(e,a.StatusCode.PROTOCOL_ERROR);{let r=this.pending_chunks.get(e);if(l.absent(r))r=new Array,this.pending_chunks.set(e,r);else if(i.opcode!==o.WebSocketFrameType.CONTINUATION)return this.close(e,a.StatusCode.PROTOCOL_ERROR);if(r.push(i.payload),1===i.final){let i=Buffer.concat(r);this.pending_chunks.delete(e),this.router.route("message",{connection_id:e,connection_url:t,buffer:i})}}}else{if(1!==i.final)return this.close(e,a.StatusCode.PROTOCOL_ERROR);if(i.payload.length>125)return this.close(e,a.StatusCode.PROTOCOL_ERROR);if(i.opcode===o.WebSocketFrameType.CLOSE){if(this.states.get(e)===a.ReadyState.CLOSING)return r.end();r.write(o.encodeFrame(Object.assign(Object.assign({},i),{masked:0})),(()=>r.end()))}else if(i.opcode===o.WebSocketFrameType.PING)r.write(o.encodeFrame(Object.assign(Object.assign({},i),{opcode:10,masked:0})));else if(i.opcode!==o.WebSocketFrameType.PONG)return this.close(e,a.StatusCode.PROTOCOL_ERROR)}}broadcast(e){for(let[t,r]of this.connections)this.states.get(t)===a.ReadyState.OPEN&&this.send(t,e)}addEventListener(e,t){return this.router.addObserver(e,t)}close(e,t){if(this.states.get(e)!==a.ReadyState.OPEN)throw"Expected socket to be open!";const r=this.connections.value(e);if(l.absent(r))throw'Connection with id "'+e+'" has no socket!';let i=Buffer.alloc(0);l.present(t)&&(i=Buffer.concat([Buffer.alloc(2),Buffer.from("Connection closed by server.")]),i.writeUInt16BE(t,0));let n=o.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:o.WebSocketFrameType.CLOSE,masked:0,payload:i});r.write(n),this.states.set(e,a.ReadyState.CLOSING)}getRequestHandler(){return(e,t)=>{let r=e.socket,s=this.connections.key(r);if(l.present(s))return t.writeHead(400),t.end();let u=e.httpVersionMajor,c=e.httpVersionMinor;if(u<1||1===u&&c<1)return t.writeHead(400),t.end();if("GET"!==e.method)return t.writeHead(400),t.end();let f=d.getHeader(e,"Host");if(l.absent(f))return t.writeHead(400),t.end();let p=d.getHeader(e,"Upgrade");if(l.absent(p)||"websocket"!==p.toLowerCase())return t.writeHead(400),t.end();let h=d.getHeader(e,"Connection");if(l.absent(h)||"upgrade"!==h.toLowerCase())return t.writeHead(400),t.end();let m=d.getHeader(e,"Sec-WebSocket-Key");if(l.absent(m)||16!==Buffer.from(m,"base64").length)return t.writeHead(400),t.end();if("13"!==d.getHeader(e,"Sec-WebSocket-Version"))return t.writeHead(426,{"Sec-WebSocket-Version":"13"}),t.end();let g=i.createHash("sha1").update(m+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11").digest("base64");return t.writeHead(101,{Upgrade:"websocket",Connection:"Upgrade","Sec-WebSocket-Accept":g}),t.end((()=>{let t=i.randomBytes(16).toString("hex"),s=function(e){let t=e.headers.host||"",r=e.url||"/";return`${e.socket instanceof n.TLSSocket?"wss:":"ws:"}//${t}${r}`}(e),l=Buffer.alloc(0);r.on("data",(e=>{for(l=Buffer.concat([l,e]);;)try{let e={buffer:l,offset:0},i=o.decodeFrame(e);this.onFrame(t,s,r,i),l=l.slice(e.offset)}catch(e){break}})),r.on("close",(()=>{this.connections.remove(t),this.states.delete(t),this.router.route("disconnect",{connection_id:t,connection_url:s})})),r.setTimeout(0),this.connections.add(t,r),this.states.set(t,a.ReadyState.OPEN),this.router.route("connect",{connection_id:t,connection_url:s})}))}}removeEventListener(e,t){return this.router.removeObserver(e,t)}send(e,t){if(this.states.get(e)!==a.ReadyState.OPEN)throw"Expected socket to be open!";let r=this.connections.value(e);if(l.absent(r))throw'Connection with id "'+e+'" has no socket!';let i=o.WebSocketFrameType.BINARY;t instanceof Buffer||(t=Buffer.from(t,"utf8"),i=o.WebSocketFrameType.TEXT);let n=o.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:i,masked:0,payload:t});r.write(n)}}},611:(e,t)=>{var r,i;Object.defineProperty(t,"__esModule",{value:!0}),t.StatusCode=t.ReadyState=void 0,(i=t.ReadyState||(t.ReadyState={}))[i.CONNECTING=0]="CONNECTING",i[i.OPEN=1]="OPEN",i[i.CLOSING=2]="CLOSING",i[i.CLOSED=3]="CLOSED",(r=t.StatusCode||(t.StatusCode={}))[r.NORMAL=1e3]="NORMAL",r[r.GOING_AWAY=1001]="GOING_AWAY",r[r.PROTOCOL_ERROR=1002]="PROTOCOL_ERROR",r[r.DATA_TYPE_NOT_ACCEPTED=1003]="DATA_TYPE_NOT_ACCEPTED",r[r.RESERVED_1004=1004]="RESERVED_1004",r[r.RESERVED_1005=1005]="RESERVED_1005",r[r.RESERVED_1006=1006]="RESERVED_1006",r[r.BAD_DATA_TYPE=1007]="BAD_DATA_TYPE",r[r.POLICY_VIOLATION=1008]="POLICY_VIOLATION",r[r.MESSAGE_TOO_BIG=1009]="MESSAGE_TOO_BIG",r[r.CLIENT_EXPECTED_EXTENSION=1010]="CLIENT_EXPECTED_EXTENSION",r[r.SERVER_UNEXPECTED_CONDITION=1011]="SERVER_UNEXPECTED_CONDITION",r[r.RESERVED_1015=1015]="RESERVED_1015"},302:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BiMap=t.getHeader=void 0;const i=r(93);t.getHeader=function(e,t){let r=e.headers[t.toLowerCase()];if(i.present(r)){if(r.constructor===String)return r;if(r.constructor===Array&&1===r.length)return r[0]}return null};class n{constructor(){this.value_to_key=new Map,this.key_to_value=new Map}[Symbol.iterator](){return this.key_to_value[Symbol.iterator]()}add(e,t){this.value_to_key.set(t,e),this.key_to_value.set(e,t)}key(e){return this.value_to_key.get(e)||null}remove(e){let t=this.key_to_value.get(e);i.present(t)&&this.value_to_key.delete(t),this.key_to_value.delete(e)}value(e){return this.key_to_value.get(e)||null}}t.BiMap=n},978:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.routing=r(220)},220:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.NamespacedMessageRouter=t.MessageRouter=void 0;class r{constructor(){this.observers=new Map}addObserver(e,t){let r=this.observers.get(e);void 0===r&&(r=new Set,this.observers.set(e,r)),r.add(t)}removeObserver(e,t){let r=this.observers.get(e);void 0!==r&&r.delete(t)}route(e,t){let r=this.observers.get(e);if(void 0!==r)for(let e of r)e(t)}}t.MessageRouter=r,t.NamespacedMessageRouter=class{constructor(){this.routers=new Map}addObserver(e,t,i){let n=this.routers.get(e);void 0===n&&(n=new r,this.routers.set(e,n)),n.addObserver(t,i)}removeObserver(e,t,r){let i=this.routers.get(e);void 0!==i&&i.removeObserver(t,r)}route(e,t,r){let i=this.routers.get(e);void 0!==i&&i.route(t,r)}}},417:e=>{e.exports=require("crypto")},605:e=>{e.exports=require("http")},211:e=>{e.exports=require("https")},16:e=>{e.exports=require("tls")},835:e=>{e.exports=require("url")}},t={};function r(i){if(t[i])return t[i].exports;var n=t[i]={exports:{}};return e[i](n,n.exports,r),n.exports}(()=>{var e=r(417);const t=require("fs");var i=r(605),n=r(211);const s=require("path");var o=r(835),l=r(175);const a=l.l8.Object.of({directory_id:l.l8.String,name:l.l8.String,parent_directory_id:l.l8.Union.of(l.l8.Undefined,l.l8.String)}),d=l.l8.Object.of({file_id:l.l8.String,name:l.l8.String,parent_directory_id:l.l8.Union.of(l.l8.Undefined,l.l8.String),index_timestamp:l.l8.Union.of(l.l8.Undefined,l.l8.Number)}),u=l.l8.Object.of({file_id:l.l8.String,mime:l.l8.StringLiteral.of("audio/mp4"),duration_ms:l.l8.Number}),c=l.l8.Object.of({file_id:l.l8.String,mime:l.l8.StringLiteral.of("image/jpeg"),width:l.l8.Number,height:l.l8.Number}),f=l.l8.Object.of({file_id:l.l8.String,mime:l.l8.StringLiteral.of("application/json")}),p=l.l8.Object.of({file_id:l.l8.String,mime:l.l8.StringLiteral.of("text/vtt"),duration_ms:l.l8.Number,language:l.l8.Union.of(l.l8.Undefined,l.l8.String)}),h=l.l8.Object.of({file_id:l.l8.String,mime:l.l8.StringLiteral.of("video/mp4"),duration_ms:l.l8.Number,width:l.l8.Number,height:l.l8.Number}),m=l.l8.Object.of({video_file_id:l.l8.String,subtitle_file_id:l.l8.String}),g=l.l8.Object.of({artist_id:l.l8.String,name:l.l8.String}),y=l.l8.Object.of({album_id:l.l8.String,title:l.l8.String,year:l.l8.Union.of(l.l8.Undefined,l.l8.Number)}),b=l.l8.Object.of({album_id:l.l8.String,file_id:l.l8.String}),_=l.l8.Object.of({disc_id:l.l8.String,album_id:l.l8.String,number:l.l8.Number}),v=l.l8.Object.of({track_id:l.l8.String,disc_id:l.l8.String,title:l.l8.String,number:l.l8.Number}),S=l.l8.Object.of({track_id:l.l8.String,file_id:l.l8.String}),w=l.l8.Object.of({album_id:l.l8.String,artist_id:l.l8.String,order:l.l8.Number}),O=l.l8.Object.of({track_id:l.l8.String,artist_id:l.l8.String,order:l.l8.Number}),E=l.l8.Object.of({show_id:l.l8.String,name:l.l8.String,summary:l.l8.Union.of(l.l8.Undefined,l.l8.String)}),k=l.l8.Object.of({show_id:l.l8.String,file_id:l.l8.String}),I=l.l8.Object.of({season_id:l.l8.String,show_id:l.l8.String,number:l.l8.Number}),R=l.l8.Object.of({episode_id:l.l8.String,season_id:l.l8.String,title:l.l8.String,number:l.l8.Number,year:l.l8.Union.of(l.l8.Undefined,l.l8.Number),summary:l.l8.Union.of(l.l8.Undefined,l.l8.String)}),T=l.l8.Object.of({episode_id:l.l8.String,file_id:l.l8.String}),x=l.l8.Object.of({movie_id:l.l8.String,title:l.l8.String,year:l.l8.Union.of(l.l8.Undefined,l.l8.Number),summary:l.l8.Union.of(l.l8.Undefined,l.l8.String)}),U=l.l8.Object.of({movie_id:l.l8.String,file_id:l.l8.String}),N=l.l8.Object.of({person_id:l.l8.String,name:l.l8.String}),j=l.l8.Object.of({movie_id:l.l8.String,person_id:l.l8.String,order:l.l8.Number}),A=l.l8.Object.of({show_id:l.l8.String,person_id:l.l8.String,order:l.l8.Number}),C=l.l8.Object.of({genre_id:l.l8.String,name:l.l8.String}),L=l.l8.Object.of({movie_id:l.l8.String,genre_id:l.l8.String,order:l.l8.Number}),B=l.l8.Object.of({show_id:l.l8.String,genre_id:l.l8.String,order:l.l8.Number}),D=l.l8.Object.of({subtitle_id:l.l8.String,file_id:l.l8.String}),P=l.l8.Object.of({cue_id:l.l8.String,subtitle_id:l.l8.String,start_ms:l.l8.Number,duration_ms:l.l8.Number,lines:l.l8.Array.of(l.l8.String)}),H=l.l8.Object.of({user_id:l.l8.String,name:l.l8.String,username:l.l8.String,password:l.l8.String}),q=l.l8.Object.of({key_id:l.l8.String,user_id:l.l8.Union.of(l.l8.Undefined,l.l8.String)}),F=l.l8.Object.of({token_id:l.l8.String,user_id:l.l8.String,hash:l.l8.String,expires_ms:l.l8.Number}),M=l.l8.Object.of({stream_id:l.l8.String,user_id:l.l8.String,file_id:l.l8.String,timestamp_ms:l.l8.Number}),$=l.l8.Object.of({playlist_id:l.l8.String,title:l.l8.String,description:l.l8.String,user_id:l.l8.String}),G=l.l8.Object.of({playlist_item_id:l.l8.String,playlist_id:l.l8.String,track_id:l.l8.String,number:l.l8.Number});var z=r(978);function J(e){return null==e}function W(e){return null!=e}const V=(...e)=>(t,r)=>{for(let i of e){let e=i(t,r);if(0!==e)return e}return 0},X=e=>(t,r)=>{let i=e(t),n=e(r);return J(i)?J(n)?0:1:J(n)?J(i)?0:-1:i.localeCompare(n)},Y=e=>(t,r)=>{let i=e(t),n=e(r);return J(i)?J(n)?0:-1:J(n)?J(i)?0:1:n-i},K=e=>(t,r)=>{let i=e(t),n=e(r);return J(i)?J(n)?0:1:J(n)?J(i)?0:-1:i-n};class Q{constructor(e){this.map=new Map,this.getKey=e}insert(e){let t=this.getKey(e),r=this.map.get(t);J(r)&&(r=new Set,this.map.set(t,r)),r.add(e)}lookup(e){let t=this.map.get(e);return W(t)?Array.from(t):new Array}remove(e){let t=this.getKey(e),r=this.map.get(t);W(r)&&(r.delete(e),0===r.size&&this.map.delete(t))}update(e){this.remove(e),this.insert(e)}static from(e,t){let r=new Q(t);for(let t of e)r.insert(t);return r}static fromIndex(e,t,r,i){let n=new Q(i);return t.on("insert",(e=>{n.insert(e)})),t.on("remove",(e=>{n.remove(e)})),t.on("update",(e=>{n.update(e)})),e.on("remove",(e=>{let i=r(e);for(let e of n.lookup(i))t.remove(e)})),n}}class Z{constructor(e){this.map=new Map,this.getKey=e,this.router=new z.routing.MessageRouter}insertOrUpdate(e,t="replace"){let r=this.getKey(e),i=this.map.get(r);if(W(i)){if("combine"===t)for(let t in e)W(e[t])&&(i[t]=e[t]);else if("replace"===t){for(let e in i)delete i[e];for(let t in e)i[t]=e[t]}this.router.route("update",i),this.router.route("*",{action:"update",record:i})}else this.map.set(r,e),this.router.route("insert",e),this.router.route("*",{action:"insert",record:e})}[Symbol.iterator](){return this.map.values()}insert(e,t="replace"){this.insertOrUpdate(e,t)}length(){return this.map.size}lookup(e){let t=this.map.get(e);if(J(t))throw`Expected "${e}" to match a record!`;return t}on(e,t){if(this.router.addObserver(e,t),"insert"===e)for(let e of this.map.values())t(e)}off(e,t){this.router.addObserver(e,t)}remove(e){let t=this.getKey(e);this.map.has(t)&&(this.map.delete(t),this.router.route("remove",e),this.router.route("*",{action:"remove",record:e}))}update(e,t="replace"){this.insertOrUpdate(e,t)}static from(e,t){let r=new Z(t);for(let t of e)r.insert(t);return r}}function ee(e){var t;let r=e;return r=r.toLowerCase(),r=r.normalize("NFC"),Array.from(null!==(t=r.match(/(\p{L}+|\p{N}+)/gu))&&void 0!==t?t:[]).filter((e=>e.length>=2))}class te{constructor(e){this.map=new Map,this.getFields=e}insert(e){for(let t of this.getFields(e)){let r=ee(t);for(let t of r){let r=this.map.get(t);J(r)&&(r=new Set,this.map.set(t,r)),r.add(e)}}}lookup(e){var t;let r=ee(e),i=r.map((e=>this.map.get(e))).filter(W),n=new Map;for(let e of i)for(let i of e){let e=null!==(t=n.get(i))&&void 0!==t?t:0-r.length;n.set(i,e+2)}return Array.from(n.entries()).filter((e=>e[1]>=0)).sort(K((e=>e[1]))).map((e=>({record:e[0],rank:e[1]})))}remove(e){for(let t of this.getFields(e)){let r=ee(t);for(let t of r){let r=this.map.get(t);W(r)&&(r.delete(e),0===r.size&&this.map.delete(t))}}}update(e){this.remove(e),this.insert(e)}static from(e,t){let r=new te(t);for(let t of e)r.insert(t);return r}static fromIndex(e,t){let r=new te(t);return e.on("insert",(e=>{r.insert(e)})),e.on("remove",(e=>{r.remove(e)})),e.on("update",(e=>{r.update(e)})),r}}class re{constructor(e){this.fd=e,this.offset=0}read(e){let r=t.readSync(this.fd,e,0,e.length,this.offset);if(r!==e.length)throw`Expected to read ${e.length} bytes but read ${r}!`;return this.offset+=r,e}skip(e){this.offset+=e}newContext(e){let t=this.offset;try{return e((e=>this.read(e)),(e=>this.skip(e)))}catch(e){throw this.offset=t,e}}}var ie;function ne(e){let t=0,r=e.readUInt8(t);t+=1;let i=e.readUInt16BE(t);t+=2;let n=e.readUInt16BE(t);t+=2;let s=e.readUInt8(t);return t+=1,{precision:r,height:i,width:n,component_count:s,components:[...Array(s).keys()].map((()=>{let r=e.readUInt8(t);t+=1;let i=e.readUInt8(t);t+=1;let n=e.readUInt8(t);return t+=1,{id:r,sampling_factors:i,quantization_table:n}}))}}!function(e){e[e.START_OF_IMAGE=65496]="START_OF_IMAGE",e[e.END_OF_IMAGE=65497]="END_OF_IMAGE",e[e.APPLICATION_0=65504]="APPLICATION_0",e[e.START_OF_SCAN=65498]="START_OF_SCAN",e[e.START_OF_FRAME_0=65472]="START_OF_FRAME_0",e[e.DEFINE_QUANTIZATION_TABLE=65499]="DEFINE_QUANTIZATION_TABLE",e[e.DEFINE_HUFFMAN_TABLE=65476]="DEFINE_HUFFMAN_TABLE"}(ie||(ie={}));const se=l.l8.Object.of({type:l.l8.StringLiteral.of("episode"),title:l.l8.String,season:l.l8.Number,episode:l.l8.Number,year:l.l8.Union.of(l.l8.Undefined,l.l8.Number),summary:l.l8.Union.of(l.l8.Undefined,l.l8.String),show:l.l8.Object.of({title:l.l8.String,summary:l.l8.Union.of(l.l8.Undefined,l.l8.String),genres:l.l8.Array.of(l.l8.String),actors:l.l8.Array.of(l.l8.String)})}),oe=l.l8.Object.of({type:l.l8.StringLiteral.of("movie"),title:l.l8.String,year:l.l8.Union.of(l.l8.Undefined,l.l8.Number),summary:l.l8.Union.of(l.l8.Undefined,l.l8.String),genres:l.l8.Array.of(l.l8.String),actors:l.l8.Array.of(l.l8.String)}),le=l.l8.Object.of({type:l.l8.StringLiteral.of("track"),title:l.l8.String,disc:l.l8.Number,track:l.l8.Number,album:l.l8.Object.of({title:l.l8.String,year:l.l8.Union.of(l.l8.Undefined,l.l8.Number),artists:l.l8.Array.of(l.l8.Object.of({title:l.l8.String}))}),artists:l.l8.Array.of(l.l8.Object.of({title:l.l8.String}))}),ae=l.l8.Union.of(l.l8.Reference.of((()=>se)),l.l8.Reference.of((()=>oe)),l.l8.Reference.of((()=>le))),de=l.l8.Object.of({type:l.l8.StringLiteral.of("audio"),duration_ms:l.l8.Number}),ue=l.l8.Object.of({type:l.l8.StringLiteral.of("image"),width:l.l8.Number,height:l.l8.Number}),ce=l.l8.Object.of({type:l.l8.StringLiteral.of("metadata")}),fe=l.l8.Object.of({type:l.l8.StringLiteral.of("subtitle"),duration_ms:l.l8.Number,language:l.l8.Union.of(l.l8.Undefined,l.l8.String)}),pe=l.l8.Object.of({type:l.l8.StringLiteral.of("video"),duration_ms:l.l8.Number,width:l.l8.Number,height:l.l8.Number}),he=l.l8.Union.of(l.l8.Reference.of((()=>de)),l.l8.Reference.of((()=>ue)),l.l8.Reference.of((()=>ce)),l.l8.Reference.of((()=>fe)),l.l8.Reference.of((()=>pe)));function me(e){let r={resources:[{type:"metadata"}]},i=t.readFileSync(e),n=JSON.parse(i.toString());return ae.is(n)&&(r.metadata=n),r}l.l8.Object.of({metadata:l.l8.Union.of(l.l8.Undefined,l.l8.Reference.of((()=>ae))),resources:l.l8.Array.of(l.l8.Reference.of((()=>he)))});class ge{constructor(e,t,r){this.fd=e,this.type=t,this.body=r}getAllChildren(){let e=Object.assign({},this.body),t=new Array;for(;e.length>0;){let r=ge.parse(this.fd,e);"udta"===this.type&&(r.body.offset+=4,r.body.length-=4),t.push(r),e.offset=r.body.offset+r.body.length,e.length=this.body.offset+this.body.length-e.offset}return t}getChild(e){let t=this.getChildren(e);if(1!==t.length)throw"Expected exactly one child!";return t[0]}getChildren(e){return this.getAllChildren().filter((t=>t.type===e))}readBody(){let e=Buffer.alloc(this.body.length);if(t.readSync(this.fd,e,0,e.length,this.body.offset)!==e.length)throw`Expected to read exactly ${e.length} bytes!`;return e}static parse(e,r){let i=r.offset,n=Buffer.alloc(8);if(t.readSync(e,n,0,n.length,i)!==n.length)throw`Expected to read exactly ${n.length} bytes!`;i+=n.length;let s=n.readUInt32BE(0),o=n.slice(4,8).toString("binary");if(0===s)s=r.length-i;else if(1===s){if(t.readSync(e,n,0,n.length,i)!==n.length)throw`Expected to read exactly ${n.length} bytes!`;i+=n.length,s=Number(n.readBigUInt64BE(0))}if(s<8)throw`Expected a length of at least 8 bytes, got ${s}!`;if(s>r.length)throw`Expected a length of at most ${r.length} bytes, got ${s}!`;return s-=8,new ge(e,o,{offset:i,length:s})}}function ye(e){return null!=e&&e.constructor===String}class be{constructor(e){this.string=e,this.offset=0,this.length=e.length}done(){return this.offset===this.length}line(){let e="";for(;!this.done();){let t=this.string[this.offset];if(this.offset+=1,"\r"===t){this.done()||"\n"===this.string[this.offset]&&(this.offset+=1);break}if("\n"===t){this.done()||"\r"===this.string[this.offset]&&(this.offset+=1);break}e+=t}return e}keep(e){let t="";for(;!(this.done()||e.indexOf(this.peek(1))>=0);)t+=this.read(1);return t}peek(e){let t=ye(e)?e.length:e,r=Math.min(this.offset,this.offset+t),i=Math.max(this.offset,this.offset+t);if(r<0||r>=this.length||i<0||i>this.length)throw"Unable to read between offsets "+r+" and "+i+" because length is "+this.length+"!";let n=this.string.substring(r,i);if(ye(e)&&n!==e)throw'Expected "'+e+'" but read "'+n+'"!';return n}read(e){let t=this.peek(e);return this.offset+=t.length,t}seek(e){if(e<0||e>=this.length)throw"Unable to seek to offset "+e+" because length is "+this.length+"!";this.offset=e}skip(e){let t="";for(;!(this.done()||e.indexOf(this.peek(1))<0);)t+=this.read(1);return t}tell(){return this.offset}}function _e(e,t){let r=e.read(t.length);if(r!==t)throw'Expected "'+t+'" but read "'+r+'"!'}function ve(e){let t=e.line();if(""!==t)throw'Expected a blank line but read "'+t+'"!'}function Se(e){let t=null;return null!=(t=/^([0-9][0-9])[:]([0-5][0-9])[:]([0-5][0-9])[.]([0-9][0-9][0-9])$/.exec(e.peek(12)))?(e.read(12),1e3*(60*(60*parseInt(t[1],10)+parseInt(t[2],10))+parseInt(t[3],10))+parseInt(t[4],10)):null!=(t=/^([0-5][0-9])[:]([0-5][0-9])[.]([0-9][0-9][0-9])$/.exec(e.peek(9)))?(e.read(9),1e3*(60*(0+parseInt(t[1],10))+parseInt(t[2],10))+parseInt(t[3],10)):(console.log("Expected a valid timecode!"),0)}function we(e){let t=Se(e);_e(e," --\x3e ");let r=Se(e);ve(e);let i=r-t;i<0&&console.log("Expected a positive duration but read "+t+" and "+r+"!");let n=new Array;for(;;){let t=e.line();if(""===t)break;n.push(t)}return{start_ms:t,duration_ms:i,lines:n}}function Oe(e){let r={resources:[]},i=(s=t.readFileSync(e).toString(),{head:function(e){_e(e,"WEBVTT");let t=e.line();return ve(e),{metadata:t}}(n=new be(s)),body:function(e){let t=new Array;for(;!e.done();){let r=we(e);t.push(r)}return t=t.sort(((e,t)=>e.start_ms-t.start_ms)),{cues:t}}(n)});var n,s;let o,a=i.body.cues.pop(),d=W(a)?a.start_ms+a.duration_ms:0;try{let e=JSON.parse(i.head.metadata);o=l.l8.String.as(e.language)}catch(e){}return r.resources.push({type:"subtitle",duration_ms:d,language:o}),r}function Ee(...t){return t=t.map((e=>(null!=e?e:"").toLowerCase().normalize("NFKD").replace(/[\|\/\\\_\-]/g," ").replace(/[^a-z0-9 ]/g,"").trim().split(/[ ]+/g))).map((e=>e.join(" "))),e.createHash("sha256").update(t.join("\0")).digest("hex").slice(0,32)}const ke=[".","private","media"];t.existsSync(ke.join("/"))||t.mkdirSync(ke.join("/"));const Ie=[".","private","tables"];function Re(e,r,i){let n=[...Ie,e+".json"].join("/");t.existsSync(n)||t.writeFileSync(n,JSON.stringify([],null,"\t")+"\n");let s=JSON.parse(t.readFileSync(n,"utf-8")),o=l.l8.Array.of(r).as(s);return Z.from(o,i)}function Te(e,r){let i=Array.from(r),n=[...Ie,e+".json"].join("/");t.writeFileSync(n,JSON.stringify(i,null,"\t")+"\n")}t.existsSync(Ie.join("/"))||t.mkdirSync(Ie.join("/"));const xe=Re("directories",a,(e=>e.directory_id)),Ue=Q.fromIndex(xe,xe,(e=>e.directory_id),(e=>e.parent_directory_id)),Ne=Re("files",d,(e=>e.file_id)),je=Q.fromIndex(xe,Ne,(e=>e.directory_id),(e=>e.parent_directory_id)),Ae=Re("audio_files",u,(e=>e.file_id)),Ce=(Q.fromIndex(Ne,Ae,(e=>e.file_id),(e=>e.file_id)),Re("image_files",c,(e=>e.file_id))),Le=(Q.fromIndex(Ne,Ce,(e=>e.file_id),(e=>e.file_id)),Re("metadata_files",f,(e=>e.file_id))),Be=(Q.fromIndex(Ne,Le,(e=>e.file_id),(e=>e.file_id)),Re("subtitle_files",p,(e=>e.file_id))),De=(Q.fromIndex(Ne,Be,(e=>e.file_id),(e=>e.file_id)),Re("video_files",h,(e=>e.file_id))),Pe=(Q.fromIndex(Ne,De,(e=>e.file_id),(e=>e.file_id)),Re("video_subtitles",m,(e=>[e.video_file_id,e.subtitle_file_id].join("\0")))),He=Q.fromIndex(De,Pe,(e=>e.file_id),(e=>e.video_file_id)),qe=Q.fromIndex(Be,Pe,(e=>e.file_id),(e=>e.subtitle_file_id)),Fe=Re("artists",g,(e=>e.artist_id)),Me=Re("albums",y,(e=>e.album_id)),$e=Re("album_files",b,(e=>[e.album_id,e.file_id].join("\0"))),Ge=(Q.fromIndex(Ne,$e,(e=>e.file_id),(e=>e.file_id)),Q.fromIndex(Me,$e,(e=>e.album_id),(e=>e.album_id))),ze=Re("discs",_,(e=>e.disc_id)),Je=Q.fromIndex(Me,ze,(e=>e.album_id),(e=>e.album_id)),We=Re("tracks",v,(e=>e.track_id)),Ve=Q.fromIndex(ze,We,(e=>e.disc_id),(e=>e.disc_id)),Xe=Re("track_files",S,(e=>[e.track_id,e.file_id].join("\0"))),Ye=Q.fromIndex(Ne,Xe,(e=>e.file_id),(e=>e.file_id)),Ke=Q.fromIndex(We,Xe,(e=>e.track_id),(e=>e.track_id)),Qe=Re("album_artists",w,(e=>[e.album_id,e.artist_id].join("\0"))),Ze=Q.fromIndex(Me,Qe,(e=>e.album_id),(e=>e.album_id)),et=Q.fromIndex(Fe,Qe,(e=>e.artist_id),(e=>e.artist_id)),tt=Re("track_artists",O,(e=>[e.track_id,e.artist_id].join("\0"))),rt=Q.fromIndex(We,tt,(e=>e.track_id),(e=>e.track_id)),it=Q.fromIndex(Fe,tt,(e=>e.artist_id),(e=>e.artist_id)),nt=Re("shows",E,(e=>e.show_id)),st=Re("show_files",k,(e=>[e.show_id,e.file_id].join("\0"))),ot=(Q.fromIndex(Ne,st,(e=>e.file_id),(e=>e.file_id)),Q.fromIndex(nt,st,(e=>e.show_id),(e=>e.show_id))),lt=Re("seasons",I,(e=>e.season_id)),at=Q.fromIndex(nt,lt,(e=>e.show_id),(e=>e.show_id)),dt=Re("episodes",R,(e=>e.episode_id)),ut=Q.fromIndex(lt,dt,(e=>e.season_id),(e=>e.season_id)),ct=Re("episode_files",T,(e=>[e.episode_id,e.file_id].join("\0"))),ft=Q.fromIndex(Ne,ct,(e=>e.file_id),(e=>e.file_id)),pt=Q.fromIndex(dt,ct,(e=>e.episode_id),(e=>e.episode_id)),ht=Re("movies",x,(e=>e.movie_id)),mt=Re("movie_files",U,(e=>[e.movie_id,e.file_id].join("\0"))),gt=Q.fromIndex(Ne,mt,(e=>e.file_id),(e=>e.file_id)),yt=Q.fromIndex(ht,mt,(e=>e.movie_id),(e=>e.movie_id)),bt=Re("persons",N,(e=>e.person_id)),_t=Re("movie_persons",j,(e=>[e.movie_id,e.person_id].join("\0"))),vt=Q.fromIndex(bt,_t,(e=>e.person_id),(e=>e.person_id)),St=Q.fromIndex(ht,_t,(e=>e.movie_id),(e=>e.movie_id)),wt=Re("show_persons",A,(e=>[e.show_id,e.person_id].join("\0"))),Ot=Q.fromIndex(bt,wt,(e=>e.person_id),(e=>e.person_id)),Et=Q.fromIndex(nt,wt,(e=>e.show_id),(e=>e.show_id)),kt=Re("genres",C,(e=>e.genre_id)),It=Re("movie_genres",L,(e=>[e.movie_id,e.genre_id].join("\0"))),Rt=Q.fromIndex(kt,It,(e=>e.genre_id),(e=>e.genre_id)),Tt=Q.fromIndex(ht,It,(e=>e.movie_id),(e=>e.movie_id)),xt=Re("show_genres",B,(e=>[e.show_id,e.genre_id].join("\0"))),Ut=Q.fromIndex(kt,xt,(e=>e.genre_id),(e=>e.genre_id)),Nt=Q.fromIndex(nt,xt,(e=>e.show_id),(e=>e.show_id)),jt=Re("subtitles",D,(e=>e.subtitle_id)),At=Re("cues",P,(e=>e.cue_id)),Ct=(Q.fromIndex(jt,At,(e=>e.subtitle_id),(e=>e.subtitle_id)),Re("users",H,(e=>e.user_id))),Lt=Q.fromIndex(Ct,Ct,(e=>e.user_id),(e=>e.username)),Bt=Re("keys",q,(e=>e.key_id)),Dt=(Q.fromIndex(Ct,Bt,(e=>e.user_id),(e=>e.user_id)),Re("tokens",F,(e=>e.token_id))),Pt=(Q.fromIndex(Ct,Dt,(e=>e.user_id),(e=>e.user_id)),Re("streams",M,(e=>e.stream_id))),Ht=(Q.fromIndex(Ct,Pt,(e=>e.user_id),(e=>e.user_id)),Q.fromIndex(Ne,Pt,(e=>e.file_id),(e=>e.file_id))),qt=Re("playlists",$,(e=>e.playlist_id)),Ft=Q.fromIndex(Ct,qt,(e=>e.user_id),(e=>e.user_id)),Mt=Re("playlist_items",G,(e=>e.playlist_item_id)),$t=Q.fromIndex(qt,Mt,(e=>e.playlist_id),(e=>e.playlist_id));Q.fromIndex(We,Mt,(e=>e.track_id),(e=>e.track_id)),Ct.on("*",(()=>{Te("users",Ct)})),Bt.on("*",(()=>{Te("keys",Bt)})),Dt.on("*",(()=>{Te("tokens",Dt)})),Pt.on("*",(()=>{Te("streams",Pt)})),qt.on("*",(()=>{Te("playlists",qt)})),Mt.on("*",(()=>{Te("playlist_items",Mt)})),0===Ct.length()&&0===Bt.length()&&Bt.insert({key_id:Ee("key",e.randomBytes(16).toString("hex"))});const Gt=te.fromIndex(Me,(e=>[e.title])),zt=te.fromIndex(Fe,(e=>[e.name])),Jt=te.fromIndex(At,(e=>e.lines)),Wt=te.fromIndex(dt,(e=>[e.title])),Vt=te.fromIndex(kt,(e=>[e.name])),Xt=te.fromIndex(ht,(e=>[e.title])),Yt=te.fromIndex(bt,(e=>[e.name])),Kt=te.fromIndex(qt,(e=>[e.title])),Qt=te.fromIndex(nt,(e=>[e.name])),Zt=te.fromIndex(We,(e=>[e.title])),er=te.fromIndex(Ct,(e=>[e.name,e.username]));function tr(e){let t=new Array;for(;;){t.unshift(e.name);let r=e.parent_directory_id;if(J(r))break;e=xe.lookup(r)}return[...ke,...t]}function rr(e){return tr(e)}function ir(e){let r=rr(e).join("/");if(t.existsSync(r)){let i=t.statSync(r);if(i.isFile()&&i.mtime.valueOf()===e.index_timestamp)return}Ne.remove(e)}function nr(e){let r=(i=e,tr(i)).join("/");var i;if(t.existsSync(r)&&t.statSync(r).isDirectory()){for(let t of Ue.lookup(e.directory_id))nr(t);for(let t of je.lookup(e.directory_id))ir(t)}else xe.remove(e)}function sr(e,r){let i=t.readdirSync(e.join("/"),{withFileTypes:!0});for(let t of i){let i=t.name;if(t.isDirectory()){let n=Ee("directory",r,i);try{xe.lookup(n)}catch(e){xe.insert({directory_id:n,name:i,parent_directory_id:r})}sr([...e,t.name],n)}else if(t.isFile()){let e=Ee("file",r,i);try{Ne.lookup(e)}catch(t){Ne.insert({file_id:e,name:i,parent_directory_id:r})}}}}function or(e,...t){let r=e.metadata;if(se.is(r)){let e=Ee("show",r.show.title);nt.insert({show_id:e,name:r.show.title,summary:r.show.summary},"combine");let i=Ee("season",e,""+r.season);lt.insert({season_id:i,show_id:e,number:r.season},"combine");let n=Ee("episode",i,""+r.episode);dt.insert({episode_id:n,season_id:i,title:r.title,number:r.episode,year:r.year,summary:r.summary},"combine");for(let e of t)ct.insert({episode_id:n,file_id:e},"combine");for(let[t,i]of r.show.actors.entries()){let r=Ee("person",i);bt.insert({person_id:r,name:i},"combine"),wt.insert({person_id:r,show_id:e,order:t},"combine")}for(let[t,i]of r.show.genres.entries()){let r=Ee("genre",i);kt.insert({genre_id:r,name:i},"combine"),xt.insert({genre_id:r,show_id:e,order:t},"combine")}}else if(oe.is(r)){let e=Ee("movie",r.title);ht.insert({movie_id:e,title:r.title,year:r.year,summary:r.summary},"combine");for(let r of t)mt.insert({movie_id:e,file_id:r},"combine");for(let[t,i]of r.actors.entries()){let r=Ee("person",i);bt.insert({person_id:r,name:i},"combine"),_t.insert({person_id:r,movie_id:e,order:t},"combine")}for(let[t,i]of r.genres.entries()){let r=Ee("genre",i);kt.insert({genre_id:r,name:i},"combine"),It.insert({genre_id:r,movie_id:e,order:t},"combine")}}else if(le.is(r)){let e=Ee("album",r.album.title);Me.insert({album_id:e,title:r.album.title,year:r.album.year},"combine");for(let[t,i]of r.album.artists.entries()){let r=Ee("artist",i.title);Fe.insert({artist_id:r,name:i.title},"combine"),Qe.insert({album_id:e,artist_id:r,order:t},"combine")}let i=Ee("disc",e,""+r.disc);ze.insert({disc_id:i,album_id:e,number:r.disc},"combine");let n=Ee("track",i,""+r.track);We.insert({track_id:n,disc_id:i,title:r.title,number:r.track},"combine");for(let e of t)Xe.insert({track_id:n,file_id:e},"combine");for(let[e,t]of r.artists.entries()){let r=Ee("artist",t.title);Fe.insert({artist_id:r,name:t.title},"combine"),tt.insert({track_id:n,artist_id:r,order:e},"combine")}}}function lr(e){let r=e.file_id,i=rr(e),n=t.openSync(i.join("/"),"r");try{let i={resources:[]};if(e.name.endsWith(".vtt")){i=Oe(n);let e=i.resources.filter((e=>"subtitle"===e.type)).shift();W(e)&&Be.insert(Object.assign({file_id:r,mime:"text/vtt"},e))}else if(e.name.endsWith(".json")){i=me(n);let e=i.resources.filter((e=>"metadata"===e.type)).shift();W(e)&&Le.insert(Object.assign({file_id:r,mime:"application/json"},e))}else if(e.name.endsWith(".mp4")){i=function(e){let r=new ge(e,"root",{offset:0,length:t.fstatSync(e).size}).getChild("moov"),i=r.getChild("mvhd").readBody().readUInt32BE(12),n={resources:r.getChildren("trak").map((e=>{let t=e.getChild("tkhd").readBody(),r=t.readUInt32BE(20),n=t.readUInt16BE(76),s=t.readUInt16BE(80),o=Math.ceil(r/i*1e3);return o>0&&n>0&&s>0?{type:"video",duration_ms:o,width:n,height:s}:o>0?{type:"audio",duration_ms:o}:{type:"metadata"}}))};try{let e=r.getChild("udta").getChild("meta").getChild("ilst"),t={};try{let r=e.getChild("tvsh").getChild("data").readBody();t.show=r.slice(8).toString()}catch(e){}try{let r=e.getChild("tven").getChild("data").readBody();t.episode=r.slice(8).toString()}catch(e){}try{let r=e.getChild("tves").getChild("data").readBody();t.episode_number=r.readUInt32BE(8)}catch(e){}try{let r=e.getChild("tvsn").getChild("data").readBody();t.season_number=r.readUInt32BE(8)}catch(e){}try{let r=e.getChild("nam").getChild("data").readBody();t.title=r.slice(8).toString()}catch(e){}try{let r=e.getChild("day").getChild("data").readBody();t.year=Number.parseInt(r.slice(8).toString())}catch(e){}try{let r=e.getChild("cmt").getChild("data").readBody();t.comment=r.slice(8).toString()}catch(e){}try{let r=e.getChild("ART").getChild("data").readBody();t.artist=r.slice(8).toString()}catch(e){}try{let r=e.getChild("alb").getChild("data").readBody();t.album=r.slice(8).toString()}catch(e){}try{let r=e.getChild("aART").getChild("data").readBody();t.album_artist=r.slice(8).toString()}catch(e){}try{let r=e.getChild("trkn").getChild("data").readBody();t.track_number=r.readUInt32BE(8)}catch(e){}try{let r=e.getChild("disk").getChild("data").readBody();t.disc_number=r.readUInt32BE(8)}catch(e){}if(n.resources.find((e=>"video"===e.type))){if(W(t.episode)&&W(t.season_number)&&W(t.episode_number)&&W(t.show)){let e={type:"episode",title:t.episode,season:t.season_number,episode:t.episode_number,year:t.year,summary:t.comment,show:{title:t.show,summary:void 0,genres:[],actors:[]}};n.metadata=e}else if(W(t.title)){let e={type:"movie",title:t.title,year:t.year,summary:t.comment,genres:[],actors:[]};n.metadata=e}}else if(n.resources.find((e=>"audio"===e.type))&&W(t.title)&&W(t.disc_number)&&W(t.track_number)&&W(t.album)){let e={type:"track",title:t.title,disc:t.disc_number,track:t.track_number,album:{title:t.album,year:t.year,artists:J(t.album_artist)?[]:t.album_artist.split(";").map((e=>e.trim())).map((e=>({title:e})))},artists:J(t.artist)?[]:t.artist.split(";").map((e=>e.trim())).map((e=>({title:e})))};n.metadata=e}}catch(e){}return n}(n);let e=i.resources.filter((e=>"audio"===e.type)),s=i.resources.filter((e=>"video"===e.type)),o=e.shift(),l=s.shift();W(l)?De.insert(Object.assign({file_id:r,mime:"video/mp4"},l)):W(o)&&Ae.insert(Object.assign({file_id:r,mime:"audio/mp4"},o))}else if(e.name.endsWith(".jpg")||e.name.endsWith(".jpeg")){i=function(e){return new re(e).newContext(((e,t)=>{let r=Buffer.alloc(2),i=Buffer.alloc(2);if(e(r),r.readUInt16BE()!==ie.START_OF_IMAGE)throw"Expected SOI marker!";if(Buffer.alloc(0),e(r),r.readUInt16BE()!==ie.APPLICATION_0)throw"Expected APP0 marker!";for(e(i),function(e){let t=0,r=e.slice(t,5);if(t+=5,"JFIF\0"!==r.toString())throw"Expected a JFIF tag!";e.readUInt8(t),t+=1,e.readUInt8(t),t+=1;let i=e.readUInt8(t);if(t+=1,0!==i&&1!==i&&2!==i)throw"Expected a valid density unit!";let n=e.readUInt16BE(t);if(t+=2,0===n)throw"Expected a non-zero horisontal resolution!";let s=e.readUInt16BE(t);if(t+=2,0===s)throw"Expected a non-zero vertical resolution!";let o=e.readUInt8(t);t+=1;let l=e.readUInt8(t);t+=1;let a=e.slice(t,t+o*l*3);if(t+=o*l*3,a.length!==o*l*3)throw"Expected a valid thumbnail!"}(e(Buffer.alloc(i.readUInt16BE()-2)));;){if(e(r),e(i),r.readUInt16BE()===ie.START_OF_FRAME_0){let t=ne(e(Buffer.alloc(i.readUInt16BE()-2)));return{resources:[{type:"image",width:t.width,height:t.height}]}}t(i.readUInt16BE()-2)}}))}(n);let e=i.resources.filter((e=>"image"===e.type)).shift();W(e)&&Ce.insert(Object.assign({file_id:r,mime:"image/jpeg"},e))}or(i,r)}catch(e){console.log(`Indexing failed for "${i.join("/")}"!`)}t.closeSync(n);let s=t.statSync(i.join("/"));e.index_timestamp=s.mtime.valueOf()}function ar(e){let t=je.lookup(e.parent_directory_id).sort(X((e=>e.name))).map((e=>{try{return Ae.lookup(e.file_id),e}catch(e){}try{return De.lookup(e.file_id),e}catch(e){}})).filter(W),r=e.name.split(".")[0],i=t.filter((e=>e.name.split(".")[0]===r));return i.length>0?i:t}function dr(t){let r=e.randomBytes(16),i=e.scryptSync(t,r,32,{N:16384,r:8,p:1,maxmem:33554432}),n=Buffer.alloc(4);return n[0]=0,n[1]=14,n[2]=8,n[3]=1,`$s0$${n.toString("hex")}$${r.toString("base64")}$${i.toString("base64")}`}function ur(t,r){let i=Lt.lookup(t).shift();if(!i)throw"";if(!function(t,r){let i=/^\$s0\$([0-9a-fA-F]{8})\$([A-Za-z0-9+/]{22}==)\$([A-Za-z0-9+/]{43}=)$/.exec(r);if(null==i)throw"Expected a valid scrypt chunk!";let n=Buffer.from(i[1],"hex"),s=Buffer.from(i[2],"base64"),o=Buffer.from(i[3],"base64"),l=n[0]<<8|n[1]<<0,a=n[2]<<0,d=n[3]<<0,u=e.scryptSync(t,s,32,{N:1<<l,r:a,p:d,maxmem:(256<<l)*a});return e.timingSafeEqual(o,u)}(r,i.password))throw"Expected a valid password!";return function(t){let r=e.randomBytes(16),i=e.randomBytes(16),n=e.createHash("sha256");n.update(i);let s=n.digest("hex");return Dt.insert({token_id:r.toString("hex"),user_id:t,hash:s,expires_ms:Date.now()+6048e5}),`${r.toString("hex")}${i.toString("hex")}`}(i.user_id)}function cr(t){let r=/^([0-9a-f]{32})([0-9a-f]{32})$/.exec(t);if(!r)throw new Error;let i=r[1],n=r[2],s=Dt.lookup(i);if(s.expires_ms<Date.now())throw"Token has expired!";let o=e.createHash("sha256");o.update(Buffer.from(n,"hex"));let l=o.digest();if(!e.timingSafeEqual(Buffer.from(s.hash,"hex"),l))throw new Error;let a=Date.now()+6048e5;return Dt.update(Object.assign(Object.assign({},s),{expires_ms:a})),s.user_id}function fr(e,t){let r=Me.lookup(e);return{album_id:r.album_id,title:r.title,artwork:Ge.lookup(e).map((e=>{try{return Ce.lookup(e.file_id)}catch(e){}})).filter(W)}}function pr(e,t){let r=Me.lookup(e),i=fr(e);return Object.assign(Object.assign({},i),{artists:Ze.lookup(e).sort(K((e=>e.order))).map((e=>hr(e.artist_id))),year:r.year,discs:Je.lookup(e).sort(K((e=>e.number))).map((e=>yr(e.disc_id,t,i)))})}function hr(e,t){let r=Fe.lookup(e);return{artist_id:r.artist_id,title:r.name}}function mr(e,t){let r=hr(e);return Object.assign(Object.assign({},r),{albums:et.lookup(e).map((e=>Me.lookup(e.album_id))).sort(Y((e=>e.year))).map((e=>pr(e.album_id,t)))})}function gr(e,t,r){let i=ze.lookup(e);return{disc_id:i.disc_id,album:W(r)?r:fr(i.album_id),number:i.number}}function yr(e,t,r){let i=gr(e,0,r);return Object.assign(Object.assign({},i),{tracks:Ve.lookup(e).sort(K((e=>e.number))).map((e=>Ur(e.track_id,t,i)))})}function br(e,t,r){var i;let n=function(e,t,r){let i=dt.lookup(e);return{episode_id:i.episode_id,title:i.title,number:i.number,season:W(r)?r:kr(i.season_id,t)}}(e,t,r),s=dt.lookup(e),o=pt.lookup(e).map((e=>{try{return De.lookup(e.file_id)}catch(e){}})).filter(W).sort(Y((e=>e.height))).shift();if(J(o))throw"Expected a valid video file!";let l=He.lookup(o.file_id).map((e=>Be.lookup(e.subtitle_file_id))),a=Ht.lookup(o.file_id).filter((e=>e.user_id===t)).sort(K((e=>e.timestamp_ms)));return Object.assign(Object.assign({},n),{year:s.year,summary:s.summary,last_stream_date:null===(i=a.pop())||void 0===i?void 0:i.timestamp_ms,media:o,subtitles:l})}function _r(e,t){let r=kt.lookup(e);return{genre_id:r.genre_id,title:r.name}}function vr(e,t){let r=_r(e);return Object.assign({},r)}function Sr(e,t){var r;let i=function(e,t){let r=ht.lookup(e);return{movie_id:r.movie_id,title:r.title,artwork:yt.lookup(e).map((e=>{try{return Ce.lookup(e.file_id)}catch(e){}})).filter(W)}}(e),n=ht.lookup(e),s=yt.lookup(e).map((e=>{try{return De.lookup(e.file_id)}catch(e){}})).filter(W).sort(Y((e=>e.height))).shift();if(J(s))throw"Expected a valid video file!";let o=He.lookup(s.file_id).map((e=>Be.lookup(e.subtitle_file_id))),l=Ht.lookup(s.file_id).filter((e=>e.user_id===t)).sort(K((e=>e.timestamp_ms)));return Object.assign(Object.assign({},i),{year:n.year,summary:n.summary,genres:Tt.lookup(e).sort(K((e=>e.order))).map((e=>_r(e.genre_id))),actors:St.lookup(e).sort(K((e=>e.order))).map((e=>Or(e.person_id))),last_stream_date:null===(r=l.pop())||void 0===r?void 0:r.timestamp_ms,media:s,subtitles:o})}function wr(e,t){let r=bt.lookup(e);return{person_id:r.person_id,name:r.name}}function Or(e,t){let r=wr(e);return Object.assign({},r)}function Er(e,t,r){let i=function(e,t,r){let i=qt.lookup(e);return{playlist_id:i.playlist_id,title:i.title,description:i.description,user:W(r)?r:Nr(i.user_id)}}(e,0,r);return Object.assign(Object.assign({},i),{items:$t.lookup(e).sort(K((e=>e.number))).map((e=>({playlist:i,number:e.number,track:Ur(e.track_id,t)})))})}function kr(e,t,r){let i=lt.lookup(e);return{season_id:i.season_id,number:i.number,show:W(r)?r:Rr(i.show_id)}}function Ir(e,t,r){let i=kr(e,0,r);return Object.assign(Object.assign({},i),{episodes:ut.lookup(e).sort(K((e=>e.number))).map((e=>br(e.episode_id,t,i)))})}function Rr(e,t){let r=nt.lookup(e);return{show_id:r.show_id,title:r.name,artwork:ot.lookup(e).map((e=>{try{return Ce.lookup(e.file_id)}catch(e){}})).filter(W).slice(0,1)}}function Tr(e,t){let r=Rr(e),i=nt.lookup(e);return Object.assign(Object.assign({},r),{summary:i.summary,genres:Nt.lookup(e).sort(K((e=>e.order))).map((e=>_r(e.genre_id))),actors:Et.lookup(e).sort(K((e=>e.order))).map((e=>wr(e.person_id))),seasons:at.lookup(e).sort(K((e=>e.number))).map((e=>Ir(e.season_id,t,r)))})}function xr(e,t){let r=jt.lookup(e);return{subtitle_id:r.subtitle_id,subtitle:Be.lookup(r.file_id)}}function Ur(e,t,r){var i;let n=function(e,t,r){let i=We.lookup(e);return{track_id:i.track_id,title:i.title,disc:W(r)?r:gr(i.disc_id),number:i.number}}(e,0,r),s=Ke.lookup(e).map((e=>{try{return Ae.lookup(e.file_id)}catch(e){}})).filter(W).shift();if(J(s))throw"Expected a valid audio file!";let o=Ht.lookup(s.file_id).filter((e=>e.user_id===t)).sort(K((e=>e.timestamp_ms)));return Object.assign(Object.assign({},n),{artists:rt.lookup(e).sort(K((e=>e.order))).map((e=>hr(e.artist_id))),last_stream_date:null===(i=o.pop())||void 0===i?void 0:i.timestamp_ms,media:s})}function Nr(e){let t=Ct.lookup(e);return{user_id:t.user_id,name:t.name,username:t.username}}function jr(e){let t=Nr(e);return Object.assign({},t)}function Ar(e,t,r,i){return""===e?Array.from(Me).sort(X((e=>e.title))).slice(t,t+r).map((e=>pr(e.album_id,i))):Gt.lookup(e).map((e=>e.record)).slice(t,t+r).map((e=>pr(e.album_id,i)))}function Cr(e,t,r,i){return""===e?Array.from(Fe).sort(X((e=>e.name))).slice(t,t+r).map((e=>mr(e.artist_id,i))):zt.lookup(e).map((e=>e.record)).slice(t,t+r).map((e=>mr(e.artist_id,i)))}function Lr(e,t,r,i){return""===e?Array.from(dt).sort(X((e=>e.title))).slice(t,t+r).map((e=>br(e.episode_id,i))):Wt.lookup(e).map((e=>e.record)).slice(t,t+r).map((e=>br(e.episode_id,i)))}function Br(e,t,r,i){return""===e?Array.from(kt).sort(X((e=>e.name))).map((e=>vr(e.genre_id))):Vt.lookup(e).map((e=>e.record)).slice(t,t+r).map((e=>vr(e.genre_id)))}function Dr(e,t,r,i){return""===e?Array.from(ht).sort(X((e=>e.title))).slice(t,t+r).map((e=>Sr(e.movie_id,i))):Xt.lookup(e).map((e=>e.record)).slice(t,t+r).map((e=>Sr(e.movie_id,i)))}function Pr(e,t,r,i){return""===e?Array.from(bt).sort(X((e=>e.name))).slice(t,t+r).map((e=>Or(e.person_id))):Yt.lookup(e).map((e=>e.record)).slice(t,t+r).map((e=>Or(e.person_id)))}function Hr(e,t,r,i){return Array.from(lt).sort(X((e=>e.season_id))).slice(t,t+r).map((e=>Ir(e.season_id,i)))}function qr(e,t,r,i){return""===e?Array.from(nt).sort(X((e=>e.name))).slice(t,t+r).map((e=>Tr(e.show_id,i))):Qt.lookup(e).map((e=>e.record)).slice(t,t+r).map((e=>Tr(e.show_id,i)))}function Fr(e,t,r,i){return""===e?Array.from(Ct).sort(X((e=>e.name))).slice(t,t+r).map((e=>jr(e.user_id))):er.lookup(e).map((e=>e.record)).slice(t,t+r).map((e=>jr(e.user_id)))}function Mr(e,t,r,i){return Rt.lookup(e).map((e=>ht.lookup(e.movie_id))).sort(X((e=>e.title))).slice(r,r+i).map((e=>Sr(e.movie_id,t)))}function $r(e,t,r,i){return vt.lookup(e).map((e=>ht.lookup(e.movie_id))).sort(X((e=>e.title))).slice(r,r+i).map((e=>Sr(e.movie_id,t)))}function Gr(e,t,r,i){return Ut.lookup(e).map((e=>nt.lookup(e.show_id))).sort(X((e=>e.name))).slice(r,r+i).map((e=>Tr(e.show_id,t)))}function zr(e,t,r,i){return Ot.lookup(e).map((e=>nt.lookup(e.show_id))).sort(X((e=>e.name))).slice(r,r+i).map((e=>Tr(e.show_id,t)))}!function(){for(let e of Ue.lookup(void 0))nr(e);for(let e of je.lookup(void 0))ir(e);sr(ke),function(){for(let e of Ne)J(e.index_timestamp)&&lr(e)}(),function(){for(let e of Le){let r=Ne.lookup(e.file_id),i=rr(r),n=t.openSync(i.join("/"),"r"),s=me(n);t.closeSync(n),or(s,...ar(r).map((e=>e.file_id)))}}(),function(){for(let e of Ce){let t=ar(Ne.lookup(e.file_id));for(let r of t){let t=Ye.lookup(r.file_id).filter((t=>t.file_id!==e.file_id));for(let r of t)try{let t=We.lookup(r.track_id),i=ze.lookup(t.disc_id),n=Me.lookup(i.album_id);$e.insert({album_id:n.album_id,file_id:e.file_id})}catch(e){}let i=gt.lookup(r.file_id).filter((t=>t.file_id!==e.file_id));for(let t of i)mt.insert({movie_id:t.movie_id,file_id:e.file_id});let n=ft.lookup(r.file_id).filter((t=>t.file_id!==e.file_id));for(let t of n)try{let r=dt.lookup(t.episode_id),i=lt.lookup(r.season_id),n=nt.lookup(i.show_id);st.insert({show_id:n.show_id,file_id:e.file_id})}catch(e){}}}}(),function(){for(let e of Be){let t=Ne.lookup(e.file_id),r=t.name.split(".")[0],i=ar(t).filter((e=>e.name.split(".")[0]===r));for(let e of i)Pe.insert({video_file_id:e.file_id,subtitle_file_id:t.file_id})}}();for(let e of Dt)e.expires_ms<=Date.now()&&Dt.remove(e)}(),Te("files",Ne),Te("directories",xe),Te("audio_files",Ae),Te("image_files",Ce),Te("metadata_files",Le),Te("subtitle_files",Be),Te("video_files",De),Te("video_subtitles",Pe),Te("artists",Fe),Te("albums",Me),Te("album_files",$e),Te("discs",ze),Te("tracks",We),Te("track_files",Xe),Te("album_artists",Qe),Te("track_artists",tt),Te("shows",nt),Te("show_files",st),Te("seasons",lt),Te("episodes",dt),Te("episode_files",ct),Te("movies",ht),Te("movie_files",mt),Te("persons",bt),Te("movie_persons",_t),Te("show_persons",wt),Te("genres",kt),Te("movie_genres",It),Te("show_genres",xt),Te("subtitles",jt),Te("cues",At),l.l8.Object.of({errors:l.l8.Array.of(l.l8.String)});const Jr=l.l8.Object.of({username:l.l8.String,password:l.l8.String,name:l.l8.String,key_id:l.l8.String}),Wr=(l.l8.Object.of({token:l.l8.String}),l.l8.Object.of({person_id:l.l8.String,name:l.l8.String})),Vr=l.l8.Intersection.of(l.l8.Reference.of((()=>Wr)),l.l8.Object.of({})),Xr=l.l8.Object.of({artist_id:l.l8.String,title:l.l8.String}),Yr=l.l8.Intersection.of(l.l8.Reference.of((()=>Xr)),l.l8.Object.of({albums:l.l8.Array.of(l.l8.Reference.of((()=>Qr)))})),Kr=l.l8.Object.of({album_id:l.l8.String,title:l.l8.String,artwork:l.l8.Array.of(l.l8.Reference.of((()=>c)))}),Qr=l.l8.Intersection.of(l.l8.Reference.of((()=>Kr)),l.l8.Object.of({artists:l.l8.Array.of(l.l8.Reference.of((()=>Xr))),discs:l.l8.Array.of(l.l8.Reference.of((()=>ei))),year:l.l8.Union.of(l.l8.Undefined,l.l8.Number)})),Zr=l.l8.Object.of({disc_id:l.l8.String,album:l.l8.Reference.of((()=>Kr)),number:l.l8.Number}),ei=l.l8.Intersection.of(l.l8.Reference.of((()=>Zr)),l.l8.Object.of({tracks:l.l8.Array.of(l.l8.Reference.of((()=>ri)))})),ti=l.l8.Object.of({track_id:l.l8.String,title:l.l8.String,disc:l.l8.Reference.of((()=>Zr)),number:l.l8.Number}),ri=l.l8.Intersection.of(l.l8.Reference.of((()=>ti)),l.l8.Object.of({artists:l.l8.Array.of(l.l8.Reference.of((()=>Xr))),last_stream_date:l.l8.Union.of(l.l8.Undefined,l.l8.Number),media:l.l8.Reference.of((()=>u))})),ii=l.l8.Object.of({user_id:l.l8.String,name:l.l8.String,username:l.l8.String}),ni=l.l8.Intersection.of(l.l8.Reference.of((()=>ii)),l.l8.Object.of({})),si=l.l8.Object.of({playlist_id:l.l8.String,title:l.l8.String,description:l.l8.String,user:l.l8.Reference.of((()=>ii))}),oi=l.l8.Intersection.of(l.l8.Reference.of((()=>si)),l.l8.Object.of({items:l.l8.Array.of(l.l8.Reference.of((()=>ai)))})),li=l.l8.Object.of({number:l.l8.Number,playlist:l.l8.Reference.of((()=>si)),track:l.l8.Reference.of((()=>ri))}),ai=l.l8.Intersection.of(l.l8.Reference.of((()=>li)),l.l8.Object.of({})),di=l.l8.Object.of({genre_id:l.l8.String,title:l.l8.String}),ui=l.l8.Intersection.of(l.l8.Reference.of((()=>di)),l.l8.Object.of({})),ci=l.l8.Object.of({movie_id:l.l8.String,title:l.l8.String,artwork:l.l8.Array.of(l.l8.Reference.of((()=>c)))}),fi=l.l8.Intersection.of(l.l8.Reference.of((()=>ci)),l.l8.Object.of({year:l.l8.Union.of(l.l8.Undefined,l.l8.Number),summary:l.l8.Union.of(l.l8.Undefined,l.l8.String),genres:l.l8.Array.of(l.l8.Reference.of((()=>ui))),actors:l.l8.Array.of(l.l8.Reference.of((()=>Vr))),last_stream_date:l.l8.Union.of(l.l8.Undefined,l.l8.Number),media:l.l8.Reference.of((()=>h)),subtitles:l.l8.Array.of(l.l8.Reference.of((()=>p)))})),pi=l.l8.Object.of({show_id:l.l8.String,title:l.l8.String,artwork:l.l8.Array.of(l.l8.Reference.of((()=>c)))}),hi=l.l8.Intersection.of(l.l8.Reference.of((()=>pi)),l.l8.Object.of({summary:l.l8.Union.of(l.l8.Undefined,l.l8.String),genres:l.l8.Array.of(l.l8.Reference.of((()=>ui))),actors:l.l8.Array.of(l.l8.Reference.of((()=>Vr))),seasons:l.l8.Array.of(l.l8.Reference.of((()=>gi)))})),mi=l.l8.Object.of({season_id:l.l8.String,number:l.l8.Number,show:l.l8.Reference.of((()=>pi))}),gi=l.l8.Intersection.of(l.l8.Reference.of((()=>mi)),l.l8.Object.of({episodes:l.l8.Array.of(l.l8.Reference.of((()=>bi)))})),yi=l.l8.Object.of({episode_id:l.l8.String,title:l.l8.String,number:l.l8.Number,season:l.l8.Reference.of((()=>mi))}),bi=l.l8.Intersection.of(l.l8.Reference.of((()=>yi)),l.l8.Object.of({year:l.l8.Union.of(l.l8.Undefined,l.l8.Number),summary:l.l8.Union.of(l.l8.Undefined,l.l8.String),last_stream_date:l.l8.Union.of(l.l8.Undefined,l.l8.Number),media:l.l8.Reference.of((()=>h)),subtitles:l.l8.Array.of(l.l8.Reference.of((()=>p)))})),_i=l.l8.Object.of({subtitle_id:l.l8.String,subtitle:l.l8.Reference.of((()=>p))}),vi=(l.l8.Intersection.of(l.l8.Reference.of((()=>_i)),l.l8.Object.of({cues:l.l8.Array.of(l.l8.Reference.of((()=>Si)))})),l.l8.Object.of({cue_id:l.l8.String,subtitle:l.l8.Reference.of((()=>_i)),start_ms:l.l8.Number,duration_ms:l.l8.Number,lines:l.l8.Array.of(l.l8.String)})),Si=l.l8.Intersection.of(l.l8.Reference.of((()=>vi)),l.l8.Object.of({}));l.l8.Union.of(l.l8.Reference.of((()=>Qr)),l.l8.Reference.of((()=>Yr)),l.l8.Reference.of((()=>ei)),l.l8.Reference.of((()=>bi)),l.l8.Reference.of((()=>ui)),l.l8.Reference.of((()=>fi)),l.l8.Reference.of((()=>Vr)),l.l8.Reference.of((()=>oi)),l.l8.Reference.of((()=>gi)),l.l8.Reference.of((()=>hi)),l.l8.Reference.of((()=>ri)),l.l8.Reference.of((()=>ni)));function wi(e,t){try{return function(e,t){let r=Number.parseInt(function(e,t){let r=function(e,t){var r;let i=null!==(r=e.query[t])&&void 0!==r?r:[];return Array.isArray(i)?i:[i]}(e,t).pop();if(J(r))throw`Expected parameter ${t}!`;return r}(e,t),10);if(!Number.isInteger(r))throw`Expected integer ${t}!`;return r}(e,t)}catch(e){}}function Oi(e){return cr(o.parse(e.url||"/",!0).query.token)}let Ei=(new class{constructor(){this.routes=new Array}registerRoute(e){return this.routes.push(e),this}route(e,t){for(let r of this.routes)if(r.handlesRequest(e))return r.handleRequest(e,t);t.writeHead(400),t.end("{}")}}).registerRoute(new class{constructor(){}handleRequest(e,t){if(void 0===e.url)throw new Error;let r=/^[/]api[/]auth[/][?]token[=]([0-9a-f]{64})/.exec(e.url);if(null===r)throw new Error;let i=r[1],n={};try{return cr(i),t.writeHead(200),t.end(JSON.stringify(n))}catch(e){}return t.writeHead(401),t.end(JSON.stringify(n))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^[/]api[/]auth[/][?]token[=]([0-9a-f]{64})/.test(e.url)}}).registerRoute(new class{constructor(){}handleRequest(e,t){if(void 0===e.url)throw new Error;let r="";e.on("data",(e=>{r+=e})).on("end",(()=>{try{let e=JSON.parse(r);if(null==e||e.constructor!==Object)throw new Error;if(null==e.username||e.username.constructor!==String)throw new Error;if(null==e.password||e.password.constructor!==String)throw new Error;let i=e,n={token:ur(i.username,i.password)};t.writeHead(200),t.end(JSON.stringify(n))}catch(e){console.log(e),t.writeHead(400),t.end(JSON.stringify({error:e.message}))}}))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^[/]api[/]auth[/]/.test(e.url)}}).registerRoute(new class{handleRequest(e,t){(function(e){return new Promise(((t,r)=>{let i=new Array;e.on("data",(e=>{i.push(e)})),e.on("end",(()=>{let e=Buffer.concat(i);t(e)})),e.on("error",(e=>{r(e)}))}))})(e).then((e=>{let r=Jr.as(JSON.parse(e.toString()));this.handleAsyncRequest(r).then((e=>{t.writeHead(200),t.end(JSON.stringify(e))}))}))}handleAsyncRequest(t){return r=this,i=void 0,s=function*(){return function(t){let{username:r,password:i,name:n,key_id:s}=Object.assign({},t),o=new Array;Lt.lookup(r).length>0&&o.push("The requested username is not available.");try{W(Bt.lookup(s).user_id)&&o.push("The registration key has already been used.")}catch(e){o.push("The registration key is not valid.")}if(o.length>0)return{errors:o};let l=e.randomBytes(16).toString("hex");Ct.insert({user_id:l,username:r,name:n,password:dr(i)});let a=Bt.lookup(s);return Bt.update(Object.assign(Object.assign({},a),{user_id:l})),{token:ur(r,i)}}(t)},new((n=void 0)||(n=Promise))((function(e,t){function o(e){try{a(s.next(e))}catch(e){t(e)}}function l(e){try{a(s.throw(e))}catch(e){t(e)}}function a(t){var r;t.done?e(t.value):(r=t.value,r instanceof n?r:new n((function(e){e(r)}))).then(o,l)}a((s=s.apply(r,i||[])).next())}));var r,i,n,s}handlesRequest(e){var t;return/^[/]api[/]register[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,i,n,s;let l=Oi(e),a=/^[/]api[/]video[/]movies[/]([0-9a-f]{32})[/]suggestions[/]movies[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=o.parse(null!==(i=e.url)&&void 0!==i?i:"/",!0),u=null!==(n=wi(d,"offset"))&&void 0!==n?n:0,c=null!==(s=wi(d,"length"))&&void 0!==s?s:24,f={movies:function(e,t,r,i){var n;let s=Tt.lookup(e),o=new Map;for(let e of s){let t=Rt.lookup(e.genre_id);for(let e of t){let t=null!==(n=o.get(e.movie_id))&&void 0!==n?n:0;o.set(e.movie_id,t+2)}}for(let e of o){let t=Tt.lookup(e[0]);o.set(e[0],e[1]-t.length)}return o.delete(e),Array.from(o.entries()).sort(Y((e=>e[1]))).slice(t,t+r).map((e=>e[0])).map((e=>Sr(e,i)))}(a[1],u,c,l)};t.writeHead(200),t.end(JSON.stringify(f))}handlesRequest(e){var t;return/^[/]api[/]video[/]movies[/]([0-9a-f]{32})[/]suggestions[/]movies[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let i=Oi(e),n={movie:Sr(/^[/]api[/]video[/]movies[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],i)};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]video[/]movies[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,i,n,s;let l=Oi(e),a=/^[/]api[/]video[/]movies[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=decodeURIComponent(a[1]),u=o.parse(null!==(i=e.url)&&void 0!==i?i:"/",!0),c={movies:Dr(d,null!==(n=wi(u,"offset"))&&void 0!==n?n:0,null!==(s=wi(u,"length"))&&void 0!==s?s:24,l)};t.writeHead(200),t.end(JSON.stringify(c))}handlesRequest(e){var t;return/^[/]api[/]video[/]movies[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let i=Oi(e),n=/^[/]api[/]audio[/]artists[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],s={artist:mr(n,i),appearances:function(e,t){let r=it.lookup(e).map((e=>We.lookup(e.track_id))).map((e=>e.disc_id));r=Array.from(new Set(r));let i=r.map((e=>ze.lookup(e))).map((e=>e.album_id));i=Array.from(new Set(i));let n=new Array;for(let t of i)null==Ze.lookup(t).find((t=>t.artist_id===e))&&n.push(t);return n.map((e=>Me.lookup(e))).sort(X((e=>e.title))).map((e=>pr(e.album_id,t)))}(n,i)};t.writeHead(200),t.end(JSON.stringify(s))}handlesRequest(e){var t;return/^[/]api[/]audio[/]artists[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,i,n,s;let l=Oi(e),a=/^[/]api[/]audio[/]artists[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=decodeURIComponent(a[1]),u=o.parse(null!==(i=e.url)&&void 0!==i?i:"/",!0),c={artists:Cr(d,null!==(n=wi(u,"offset"))&&void 0!==n?n:0,null!==(s=wi(u,"length"))&&void 0!==s?s:24,l)};t.writeHead(200),t.end(JSON.stringify(c))}handlesRequest(e){var t;return/^[/]api[/]audio[/]artists[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let i=Oi(e),n={album:pr(/^[/]api[/]audio[/]albums[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],i)};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]audio[/]albums[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,i,n,s;let l=Oi(e),a=/^[/]api[/]audio[/]albums[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],d=o.parse(null!==(i=e.url)&&void 0!==i?i:"/",!0),u={albums:Ar(a,null!==(n=wi(d,"offset"))&&void 0!==n?n:0,null!==(s=wi(d,"length"))&&void 0!==s?s:24,l)};t.writeHead(200),t.end(JSON.stringify(u))}handlesRequest(e){var t;return/^[/]api[/]audio[/]albums[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let i=Oi(e),n={episode:br(/^[/]api[/]video[/]episodes[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],i)};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]video[/]episodes[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,i,n,s;let l=Oi(e),a=/^[/]api[/]video[/]episodes[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=decodeURIComponent(a[1]),u=o.parse(null!==(i=e.url)&&void 0!==i?i:"/",!0),c={episodes:Lr(d,null!==(n=wi(u,"offset"))&&void 0!==n?n:0,null!==(s=wi(u,"length"))&&void 0!==s?s:24,l)};t.writeHead(200),t.end(JSON.stringify(c))}handlesRequest(e){var t;return/^[/]api[/]video[/]episodes[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let i=Oi(e),n={show:Tr(/^[/]api[/]video[/]shows[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],i)};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]video[/]shows[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,i,n,s;let l=Oi(e),a=/^[/]api[/]video[/]shows[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=decodeURIComponent(a[1]),u=o.parse(null!==(i=e.url)&&void 0!==i?i:"/",!0),c={shows:qr(d,null!==(n=wi(u,"offset"))&&void 0!==n?n:0,null!==(s=wi(u,"length"))&&void 0!==s?s:24,l)};t.writeHead(200),t.end(JSON.stringify(c))}handlesRequest(e){var t;return/^[/]api[/]video[/]shows[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,i,n,s;let l=Oi(e),a=/^[/]api[/]persons[/]([0-9a-f]{32})[/]shows[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],d=o.parse(null!==(i=e.url)&&void 0!==i?i:"/",!0),u={shows:zr(a,l,null!==(n=wi(d,"offset"))&&void 0!==n?n:0,null!==(s=wi(d,"length"))&&void 0!==s?s:24)};t.writeHead(200),t.end(JSON.stringify(u))}handlesRequest(e){var t;return/^[/]api[/]persons[/]([0-9a-f]{32})[/]shows[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,i,n,s;let l=Oi(e),a=/^[/]api[/]persons[/]([0-9a-f]{32})[/]movies[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],d=o.parse(null!==(i=e.url)&&void 0!==i?i:"/",!0),u={movies:$r(a,l,null!==(n=wi(d,"offset"))&&void 0!==n?n:0,null!==(s=wi(d,"length"))&&void 0!==s?s:24)};t.writeHead(200),t.end(JSON.stringify(u))}handlesRequest(e){var t;return/^[/]api[/]persons[/]([0-9a-f]{32})[/]movies[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;Oi(e);let i={person:Or(/^[/]api[/]persons[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1])};t.writeHead(200),t.end(JSON.stringify(i))}handlesRequest(e){var t;return/^[/]api[/]persons[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,i,n,s;Oi(e);let l=/^[/]api[/]persons[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),a=decodeURIComponent(l[1]),d=o.parse(null!==(i=e.url)&&void 0!==i?i:"/",!0),u={persons:Pr(a,null!==(n=wi(d,"offset"))&&void 0!==n?n:0,null!==(s=wi(d,"length"))&&void 0!==s?s:24)};t.writeHead(200),t.end(JSON.stringify(u))}handlesRequest(e){var t;return/^[/]api[/]persons[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let i=Oi(e),n={playlist:Er(/^[/]api[/]audio[/]playlists[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],i)};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]audio[/]playlists[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,i,n,s;let l=Oi(e),a=/^[/]api[/]audio[/]playlists[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=decodeURIComponent(a[1]),u=o.parse(null!==(i=e.url)&&void 0!==i?i:"/",!0),c={playlists:function(e,t,r,i){return""===e?Array.from(qt).sort(X((e=>e.title))).slice(t,t+r).map((e=>Er(e.playlist_id,i))):Kt.lookup(e).map((e=>e.record)).slice(t,t+r).map((e=>Er(e.playlist_id,i)))}(d,null!==(n=wi(u,"offset"))&&void 0!==n?n:0,null!==(s=wi(u,"length"))&&void 0!==s?s:24,l)};t.writeHead(200),t.end(JSON.stringify(c))}handlesRequest(e){var t;return/^[/]api[/]audio[/]playlists[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let i=Oi(e),n={track:Ur(/^[/]api[/]audio[/]tracks[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],i)};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]audio[/]tracks[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,i,n,s;let l=Oi(e),a=/^[/]api[/]audio[/]tracks[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=decodeURIComponent(a[1]),u=o.parse(null!==(i=e.url)&&void 0!==i?i:"/",!0),c={tracks:function(e,t,r,i){return""===e?Array.from(We).sort(X((e=>e.title))).slice(t,t+r).map((e=>Ur(e.track_id,i))):Zt.lookup(e).map((e=>e.record)).slice(t,t+r).map((e=>Ur(e.track_id,i)))}(d,null!==(n=wi(u,"offset"))&&void 0!==n?n:0,null!==(s=wi(u,"length"))&&void 0!==s?s:24,l)};t.writeHead(200),t.end(JSON.stringify(c))}handlesRequest(e){var t;return/^[/]api[/]audio[/]tracks[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let i=Oi(e),n={season:Ir(/^[/]api[/]video[/]seasons[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],i)};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]video[/]seasons[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,i,n,s;let l=Oi(e),a=/^[/]api[/]video[/]seasons[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=(decodeURIComponent(a[1]),o.parse(null!==(i=e.url)&&void 0!==i?i:"/",!0)),u={seasons:Hr(0,null!==(n=wi(d,"offset"))&&void 0!==n?n:0,null!==(s=wi(d,"length"))&&void 0!==s?s:24,l)};t.writeHead(200),t.end(JSON.stringify(u))}handlesRequest(e){var t;return/^[/]api[/]video[/]seasons[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let i=Oi(e),n={disc:yr(/^[/]api[/]audio[/]discs[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1],i)};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){var t;return/^[/]api[/]audio[/]discs[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,i,n,s;let l=Oi(e),a=/^[/]api[/]audio[/]discs[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=(decodeURIComponent(a[1]),o.parse(null!==(i=e.url)&&void 0!==i?i:"/",!0)),u={discs:function(e,t,r,i){return Array.from(ze).sort(X((e=>e.disc_id))).slice(t,t+r).map((e=>yr(e.disc_id,i)))}(0,null!==(n=wi(d,"offset"))&&void 0!==n?n:0,null!==(s=wi(d,"length"))&&void 0!==s?s:24,l)};t.writeHead(200),t.end(JSON.stringify(u))}handlesRequest(e){var t;return/^[/]api[/]audio[/]discs[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;let i=Oi(e),n=jr(/^[/]api[/]users[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1]),s={user:n,playlists:function(e,t){return Ft.lookup(e).sort(X((e=>e.title))).map((e=>Er(e.playlist_id,t)))}(n.user_id,i)};t.writeHead(200),t.end(JSON.stringify(s))}handlesRequest(e){var t;return/^[/]api[/]users[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,i,n,s;Oi(e);let l=/^[/]api[/]users[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),a=decodeURIComponent(l[1]),d=o.parse(null!==(i=e.url)&&void 0!==i?i:"/",!0),u={users:Fr(a,null!==(n=wi(d,"offset"))&&void 0!==n?n:0,null!==(s=wi(d,"length"))&&void 0!==s?s:24)};t.writeHead(200),t.end(JSON.stringify(u))}handlesRequest(e){var t;return/^[/]api[/]users[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,i,n,s;let l=Oi(e),a=/^[/]api[/]video[/]cues[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=decodeURIComponent(a[1]),u=o.parse(null!==(i=e.url)&&void 0!==i?i:"/",!0),c={cues:function(e,t,r,i){return Jt.lookup(e).sort(Y((e=>e.rank))).slice(t,t+r).map((e=>function(e,t,r){let i=function(e,t,r){let i=At.lookup(e);return{cue_id:i.cue_id,subtitle:W(r)?r:xr(i.subtitle_id),start_ms:i.start_ms,duration_ms:i.duration_ms,lines:i.lines}}(e,0,r);return Object.assign({},i)}(e.record.cue_id))).map((e=>{let t=qe.lookup(e.subtitle.subtitle.file_id);for(let r of t){try{let t=ct.lookup(r.video_file_id);return Object.assign(Object.assign({},e),{media:br(t.episode_id,i)})}catch(e){}try{let t=mt.lookup(r.video_file_id);return Object.assign(Object.assign({},e),{media:Sr(t.movie_id,i)})}catch(e){}}})).filter(W)}(d,null!==(n=wi(u,"offset"))&&void 0!==n?n:0,null!==(s=wi(u,"length"))&&void 0!==s?s:24,l)};t.writeHead(200),t.end(JSON.stringify(c))}handlesRequest(e){var t;return/^[/]api[/]video[/]cues[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,i,n,s;let l=Oi(e),a=/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]shows[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=o.parse(null!==(i=e.url)&&void 0!==i?i:"/",!0),u=null!==(n=wi(d,"offset"))&&void 0!==n?n:0,c=null!==(s=wi(d,"length"))&&void 0!==s?s:24,f={shows:Gr(a[1],l,u,c)};t.writeHead(200),t.end(JSON.stringify(f))}handlesRequest(e){var t;return/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]shows[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,i,n,s;let l=Oi(e),a=/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]movies[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=o.parse(null!==(i=e.url)&&void 0!==i?i:"/",!0),u=null!==(n=wi(d,"offset"))&&void 0!==n?n:0,c=null!==(s=wi(d,"length"))&&void 0!==s?s:24,f={movies:Mr(a[1],l,u,c)};t.writeHead(200),t.end(JSON.stringify(f))}handlesRequest(e){var t;return/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]movies[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r;Oi(e);let i={genre:vr(/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]/.exec(null!==(r=e.url)&&void 0!==r?r:"/")[1])};t.writeHead(200),t.end(JSON.stringify(i))}handlesRequest(e){var t;return/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,i,n,s;Oi(e);let l=/^[/]api[/]video[/]genres[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),a=decodeURIComponent(l[1]),d=o.parse(null!==(i=e.url)&&void 0!==i?i:"/",!0),u={genres:Br(a,null!==(n=wi(d,"offset"))&&void 0!==n?n:0,null!==(s=wi(d,"length"))&&void 0!==s?s:24)};t.writeHead(200),t.end(JSON.stringify(u))}handlesRequest(e){var t;return/^[/]api[/]video[/]genres[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}}).registerRoute(new class{handleRequest(e,t){var r,i,n,s;let l=Oi(e),a=/^[/]api[/]search[/]([^/?]*)/.exec(null!==(r=e.url)&&void 0!==r?r:"/"),d=decodeURIComponent(a[1]),u=o.parse(null!==(i=e.url)&&void 0!==i?i:"/",!0),c={entities:function(e,t,r,i){return[...Gt.lookup(e).map((e=>Object.assign(Object.assign({},e),{type_rank:9}))),...zt.lookup(e).map((e=>Object.assign(Object.assign({},e),{type_rank:6}))),...Wt.lookup(e).map((e=>Object.assign(Object.assign({},e),{type_rank:4}))),...Vt.lookup(e).map((e=>Object.assign(Object.assign({},e),{type_rank:2}))),...Xt.lookup(e).map((e=>Object.assign(Object.assign({},e),{type_rank:8}))),...Yt.lookup(e).map((e=>Object.assign(Object.assign({},e),{type_rank:1}))),...Kt.lookup(e).map((e=>Object.assign(Object.assign({},e),{type_rank:3}))),...Qt.lookup(e).map((e=>Object.assign(Object.assign({},e),{type_rank:7}))),...Zt.lookup(e).map((e=>Object.assign(Object.assign({},e),{type_rank:5}))),...er.lookup(e).map((e=>Object.assign(Object.assign({},e),{type_rank:0})))].sort(V(Y((e=>e.rank)),Y((e=>e.type_rank)))).slice(r,r+i).map((e=>{let r=e.record;if(y.is(r))return pr(r.album_id,t);if(g.is(r))return mr(r.artist_id,t);if(R.is(r))return br(r.episode_id,t);if(C.is(r))return vr(r.genre_id);if(x.is(r))return Sr(r.movie_id,t);if(N.is(r))return Or(r.person_id);if($.is(r))return Er(r.playlist_id,t);if(E.is(r))return Tr(r.show_id,t);if(v.is(r))return Ur(r.track_id,t);if(H.is(r))return jr(r.user_id);throw"Expected code to be unreachable!"}))}(d,l,null!==(n=wi(u,"offset"))&&void 0!==n?n:0,null!==(s=wi(u,"length"))&&void 0!==s?s:24)};t.writeHead(200),t.end(JSON.stringify(c))}handlesRequest(e){var t;return/^[/]api[/]search[/]([^/?]*)/.test(null!==(t=e.url)&&void 0!==t?t:"/")}});const ki=require("child_process");function Ii(...e){return e.map((e=>String(e))).join("")}function Ri(e){let t=Math.floor(e/1e3);e-=1e3*t;let r=Math.floor(t/60);t-=60*r;let i=Math.floor(r/60);r-=60*i;let n=Ii("00",i).slice(-2),s=Ii("00",r).slice(-2),o=Ii("00",t).slice(-2),l=Ii("000",e).slice(-3);return Ii(n,":",s,":",o,".",l)}const Ti=l.l8.Object.of({pkt_pts_time:l.l8.String}),xi=l.l8.Object.of({frames:l.l8.Array.of(l.l8.Reference.of((()=>Ti)))}),Ui=l.l8.Object.of({codec_name:l.l8.String}),Ni=l.l8.Intersection.of(l.l8.Reference.of((()=>Ui)),l.l8.Object.of({codec_type:l.l8.StringLiteral.of("audio"),start_time:l.l8.String,duration:l.l8.String})),ji=l.l8.Intersection.of(l.l8.Reference.of((()=>Ui)),l.l8.Object.of({codec_type:l.l8.StringLiteral.of("video"),codec_time_base:l.l8.StringLiteral.of("0/1"),width:l.l8.Number,height:l.l8.Number})),Ai=l.l8.Intersection.of(l.l8.Reference.of((()=>Ui)),l.l8.Object.of({codec_type:l.l8.StringLiteral.of("subtitle")})),Ci=l.l8.Intersection.of(l.l8.Reference.of((()=>Ui)),l.l8.Object.of({codec_type:l.l8.StringLiteral.of("video"),start_time:l.l8.String,duration:l.l8.String,width:l.l8.Number,height:l.l8.Number})),Li=l.l8.Union.of(l.l8.Reference.of((()=>Ni)),l.l8.Reference.of((()=>ji)),l.l8.Reference.of((()=>Ai)),l.l8.Reference.of((()=>Ci))),Bi=(l.l8.Object.of({streams:l.l8.Array.of(l.l8.Reference.of((()=>Li)))}),l.l8.Object.of({format_name:l.l8.String,tags:l.l8.Union.of(l.l8.Undefined,l.l8.Object.of({title:l.l8.Union.of(l.l8.Undefined,l.l8.String),date:l.l8.Union.of(l.l8.Undefined,l.l8.String),comment:l.l8.Union.of(l.l8.Undefined,l.l8.String),show:l.l8.Union.of(l.l8.Undefined,l.l8.String),episode_id:l.l8.Union.of(l.l8.Undefined,l.l8.String),episode_sort:l.l8.Union.of(l.l8.Undefined,l.l8.String),season_number:l.l8.Union.of(l.l8.Undefined,l.l8.String),track:l.l8.Union.of(l.l8.Undefined,l.l8.String),artist:l.l8.Union.of(l.l8.Undefined,l.l8.String),album_artist:l.l8.Union.of(l.l8.Undefined,l.l8.String),album:l.l8.Union.of(l.l8.Undefined,l.l8.String),disc:l.l8.Union.of(l.l8.Undefined,l.l8.String)}))}));l.l8.Object.of({format:l.l8.Reference.of((()=>Bi))});function Di(e,t){return r=this,i=void 0,s=function*(){return new Promise(((r,i)=>{let n=ki.spawn("ffprobe",["-hide_banner","-i",e.join("/"),"-select_streams",""+t,"-skip_frame","nokey","-show_frames","-show_entries","frame=pkt_pts_time","-of","json"]),s=new Array;n.stdout.on("data",(e=>{s.push(e)})),n.on("exit",(()=>{let t=Buffer.concat(s).toString();try{let e=xi.as(JSON.parse(t)).frames.map((e=>Math.round(1e3*Number.parseFloat(e.pkt_pts_time))));r(e)}catch(t){console.log(`Keyframes failed for ${e.join("/")}!`),i(t)}}))}))},new((n=void 0)||(n=Promise))((function(e,t){function o(e){try{a(s.next(e))}catch(e){t(e)}}function l(e){try{a(s.throw(e))}catch(e){t(e)}}function a(t){var r;t.done?e(t.value):(r=t.value,r instanceof n?r:new n((function(e){e(r)}))).then(o,l)}a((s=s.apply(r,i||[])).next())}));var r,i,n,s}var Pi=function(e,t,r,i){return new(r||(r=Promise))((function(n,s){function o(e){try{a(i.next(e))}catch(e){s(e)}}function l(e){try{a(i.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,l)}a((i=i.apply(e,t||[])).next())}))};function Hi(r){let i=e.randomBytes(16).toString("hex"),n=[".","private","jobs",i];return t.mkdirSync(n.join("/"),{recursive:!0}),r(n,i)}function qi(e,r){t.mkdirSync(r.slice(0,-1).join("/"),{recursive:!0}),t.renameSync(e.join("/"),r.join("/"))}function Fi(e){let r=t.statSync(e);r.isDirectory()?(t.readdirSync(e).map((t=>e+"/"+t)).forEach(Fi),t.rmdirSync(e)):r.isFile()&&t.unlinkSync(e)}const Mi=[];for(let e of De){let r=[".","private","stills",e.file_id];if(!t.existsSync(r.join("/"))){let t=Ne.lookup(e.file_id);Mi.push({target:r,file:t})}}setTimeout((function e(){return Pi(this,void 0,void 0,(function*(){let t=Mi.pop();if(!J(t)){try{yield function(e,t){return Pi(this,void 0,void 0,(function*(){let r=tr(t),i=yield Di(r,0),n=i[Math.floor(i.length/2)];return new Promise(((t,i)=>{Hi(((s,o)=>{let l=[...s,"still.jpeg"],a=ki.spawn("ffmpeg",["-ss",Ri(n),"-i",r.join("/"),"-q:v","1","-frames:v","1","-f","singlejpeg","-fflags","+bitexact","-map_metadata","-1",l.join("/"),"-y"]);a.on("error",(()=>(Fi(s.join("/")),i()))),a.on("exit",(()=>(qi(l,e),Fi(s.join("/")),t())))}))}))}))}(t.target,t.file)}catch(e){}setTimeout(e,1e4)}}))}));class $i{constructor(e){this.state=e,this.observers=new Array}addObserver(e){let t=new $i(e(this.state));return this.observers.push((r=>{t.updateState(e(r))})),t.addObserver.bind(t)}getState(){return this.state}updateState(e){if(e!==this.state){this.state=e;for(let e of this.observers)e(this.state)}}}class Gi{constructor(e){this.state=e,this.observers=new Array}addObserver(e){var t;this.observers.push(e),null===(t=e.onupdate)||void 0===t||t.call(e,this.state)}compute(e){let t=new $i(e(this.state));return this.observers.push({onupdate(r){t.updateState(e(r))}}),t.addObserver.bind(t)}getState(){return this.state}append(e){var t,r;this.state.push(e);for(let i of this.observers)null===(t=i.onappend)||void 0===t||t.call(i,e),null===(r=i.onupdate)||void 0===r||r.call(i,this.state)}splice(e){var t,r;if(e<0||e>=this.state.length)throw`Expected an index of at most ${this.state.length}, got ${e}!`;let i=this.state[e];this.state.splice(e,1);for(let n of this.observers)null===(t=n.onsplice)||void 0===t||t.call(n,i,e),null===(r=n.onupdate)||void 0===r||r.call(n,this.state)}update(e){for(let e=this.state.length-1;e>=0;e--)this.splice(e);for(let t of e)this.append(t)}}const zi=l.l8.Reference.of((()=>Qr)),Ji=l.l8.Reference.of((()=>Yr)),Wi=l.l8.Reference.of((()=>ei)),Vi=l.l8.Reference.of((()=>ri)),Xi=l.l8.Reference.of((()=>oi)),Yi=l.l8.Reference.of((()=>fi)),Ki=l.l8.Reference.of((()=>hi)),Qi=l.l8.Reference.of((()=>gi)),Zi=l.l8.Reference.of((()=>bi)),en=l.l8.Union.of(l.l8.Reference.of((()=>zi)),l.l8.Reference.of((()=>Ji)),l.l8.Reference.of((()=>Wi)),l.l8.Reference.of((()=>Vi)),l.l8.Reference.of((()=>Xi)),l.l8.Reference.of((()=>Yi)),l.l8.Reference.of((()=>Ki)),l.l8.Reference.of((()=>Qi)),l.l8.Reference.of((()=>Zi))),tn=(l.l8.Union.of(l.l8.Reference.of((()=>Vi)),l.l8.Reference.of((()=>Yi)),l.l8.Reference.of((()=>Zi))),l.l8.Object.of({id:l.l8.String,type:l.l8.String,name:l.l8.String})),rn=(l.l8.Object.of({context:l.l8.Union.of(l.l8.Undefined,l.l8.Reference.of((()=>en))),device:l.l8.Union.of(l.l8.Undefined,l.l8.Reference.of((()=>tn))),index:l.l8.Union.of(l.l8.Undefined,l.l8.Number),playback:l.l8.Boolean,progress:l.l8.Union.of(l.l8.Undefined,l.l8.Number)}),{SetContext:l.l8.Object.of({context:l.l8.Union.of(l.l8.Undefined,l.l8.Reference.of((()=>en)))}),SetDevice:l.l8.Object.of({device:l.l8.Union.of(l.l8.Undefined,l.l8.Reference.of((()=>tn)))}),SetDevices:l.l8.Object.of({devices:l.l8.Array.of(l.l8.Reference.of((()=>tn)))}),SetIndex:l.l8.Object.of({index:l.l8.Union.of(l.l8.Undefined,l.l8.Number)}),SetLocalDevice:l.l8.Object.of({device:l.l8.Reference.of((()=>tn))}),SetPlayback:l.l8.Object.of({playback:l.l8.Boolean}),SetProgress:l.l8.Object.of({progress:l.l8.Union.of(l.l8.Undefined,l.l8.Number)}),SetToken:l.l8.Object.of({token:l.l8.Union.of(l.l8.Undefined,l.l8.String)})});var nn=r(611);class sn{constructor(e,t,r){this.nextConnectionAttemptDelayFactor=2+Math.random(),this.nextConnectionAttemptDelay=2e3,this.router=new z.routing.NamespacedMessageRouter,this.serializer=new l.m7.MessageSerializer(r),this.url=e,this.factory=t,this.socket=this.makeSocket()}makeSocket(){let e=this.factory(this.url);return e.addEventListener("close",this.onClose.bind(this)),e.addEventListener("error",this.onError.bind(this)),e.addEventListener("message",this.onMessage.bind(this)),e.addEventListener("open",this.onOpen.bind(this)),e}onClose(e){this.router.route("sys","disconnect",{})}onError(e){setTimeout((()=>{this.socket=this.makeSocket()}),this.nextConnectionAttemptDelay),this.nextConnectionAttemptDelay=Math.round(this.nextConnectionAttemptDelay*this.nextConnectionAttemptDelayFactor)}onMessage(e){let t=e.data;this.serializer.deserialize(t,((e,t)=>{this.router.route("sys","message",{type:e,data:t}),this.router.route("app",e,t)}))}onOpen(e){this.nextConnectionAttemptDelay=2e3,this.router.route("sys","connect",{})}addEventListener(e,t,r){this.router.addObserver(e,t,r)}close(){this.socket.close()}reconnect(){this.socket.readyState===nn.ReadyState.CLOSED&&(this.socket=this.makeSocket())}removeEventListener(e,t,r){this.router.addObserver(e,t,r)}send(e,t){if(this.socket.readyState===nn.ReadyState.OPEN)this.socket.send(this.serializer.serialize(e,t));else{let r=()=>{this.socket.removeEventListener("open",r),this.socket.send(this.serializer.serialize(e,t))};this.socket.addEventListener("open",r)}}}class on{constructor(e,t=(e=>new WebSocket(e))){this.estimatedProgress=new $i(void 0),this.estimatedProgressTimestamp=new $i(void 0),this.token=new $i(void 0),this.localDevice=new $i(void 0),this.devices=new Gi(new Array),this.device=new $i(void 0),this.isDeviceLocal=new $i(!1),this.isDeviceRemote=new $i(!1),this.context=new $i(void 0),this.contextPath=new $i(void 0),this.flattenedContext=new $i(void 0),this.lastIndex=new $i(void 0),this.lastEntry=new $i(void 0),this.lastLocalEntry=new $i(void 0),this.currentIndex=new $i(void 0),this.currentEntry=new $i(void 0),this.currentLocalEntry=new $i(void 0),this.nextIndex=new $i(void 0),this.nextEntry=new $i(void 0),this.nextLocalEntry=new $i(void 0),this.playback=new $i(!1),this.progress=new $i(void 0),this.localPlayback=new $i(!1),this.canPlayLast=new $i(!1),this.canPlayCurrent=new $i(!1),this.canPlayNext=new $i(!1),this.isCurrentEntryVideo=new $i(!1),this.isOnline=new $i(!1),this.tsc=new sn(e,t,rn),this.tsc.addEventListener("sys","connect",(()=>{this.isOnline.updateState(!0)})),this.tsc.addEventListener("sys","disconnect",(()=>{this.isOnline.updateState(!1)})),this.context.addObserver((e=>{if(W(e))if(zi.is(e)){let t=[],r=e;for(let e of r.discs)t.push(...e.tracks);this.flattenedContext.updateState(t)}else if(Ji.is(e)){let t=[],r=e;for(let e of r.albums)for(let r of e.discs)t.push(...r.tracks);this.flattenedContext.updateState(t)}else if(Zi.is(e)){let t=[],r=e;t.push(r),this.flattenedContext.updateState(t)}else if(Yi.is(e)){let t=[],r=e;t.push(r),this.flattenedContext.updateState(t)}else if(Xi.is(e)){let t=[],r=e;for(let e of r.items)t.push(e.track);this.flattenedContext.updateState(t)}else if(Qi.is(e)){let t=[],r=e;t.push(...r.episodes),this.flattenedContext.updateState(t)}else if(Ki.is(e)){let t=[],r=e;for(let e of r.seasons)t.push(...e.episodes);this.flattenedContext.updateState(t)}else{if(!Vi.is(e))throw"Expected code to be unreachable!";{let t=[],r=e;t.push(r),this.flattenedContext.updateState(t)}}}));{let e=()=>{let e=this.context.getState(),t=this.currentIndex.getState();if(W(e)&&W(t)){if(zi.is(e)){let r=0,i=t,n=e.discs;for(let e=0;e<n.length;e++){let t=n[e].tracks.length;if(!(i>=t))break;r+=1,i-=t}return this.contextPath.updateState([e.album_id,e.discs[r].disc_id,e.discs[r].tracks[i].track_id])}if(Ji.is(e)){let r=0,i=0,n=t,s=e.albums;e:for(let e=0;e<s.length;e++){let t=s[e].discs;for(let e=0;e<t.length;e++){let r=t[e].tracks.length;if(!(n>=r))break e;i+=1,n-=r}r+=1,i=0}return this.contextPath.updateState([e.artist_id,e.albums[r].album_id,e.albums[r].discs[i].disc_id,e.albums[r].discs[i].tracks[n].track_id])}if(Zi.is(e))return this.contextPath.updateState([e.episode_id]);if(Yi.is(e))return this.contextPath.updateState([e.movie_id]);if(Xi.is(e)){let r=t;return this.contextPath.updateState([e.playlist_id,e.items[r].track.track_id])}if(Ki.is(e)){let r=0,i=t,n=e.seasons;for(let e=0;e<n.length;e++){let t=n[e].episodes.length;if(!(i>=t))break;r+=1,i-=t}return this.contextPath.updateState([e.show_id,e.seasons[r].season_id,e.seasons[r].episodes[i].episode_id])}if(Qi.is(e)){let r=t;return this.contextPath.updateState([e.season_id,e.episodes[r].episode_id])}if(Vi.is(e))return this.contextPath.updateState([e.track_id]);throw"Expected code to be unreachable!"}this.contextPath.updateState(void 0)};this.context.addObserver(e),this.currentIndex.addObserver(e)}this.lastEntry.addObserver((e=>{this.canPlayLast.updateState(W(e))})),this.currentEntry.addObserver((e=>{this.canPlayCurrent.updateState(W(e))})),this.nextEntry.addObserver((e=>{this.canPlayNext.updateState(W(e))})),this.progress.addObserver((e=>{this.estimatedProgress.updateState(e),this.estimatedProgressTimestamp.updateState(Date.now())})),this.playback.addObserver((e=>{let t=this.estimatedProgress.getState(),r=this.estimatedProgressTimestamp.getState(),i=Date.now();e||W(t)&&W(r)&&this.estimatedProgress.updateState(t+(i-r)/1e3),this.estimatedProgressTimestamp.updateState(i)})),this.estimatedProgress.addObserver((e=>{console.log("Estimated progress to "+(null!=e?e:0))}));{let e=()=>{let e=this.playback.getState(),t=this.isDeviceLocal.getState();this.localPlayback.updateState(t&&e)};this.playback.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.lastEntry.getState(),t=this.isDeviceLocal.getState();this.lastLocalEntry.updateState(t?e:void 0)};this.lastEntry.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.currentEntry.getState(),t=this.isDeviceLocal.getState();this.currentLocalEntry.updateState(t?e:void 0)};this.currentEntry.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.nextEntry.getState(),t=this.isDeviceLocal.getState();this.nextLocalEntry.updateState(t?e:void 0)};this.nextEntry.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.localDevice.getState(),t=this.device.getState();return W(e)&&W(t)&&e.id===t.id?this.isDeviceLocal.updateState(!0):this.isDeviceLocal.updateState(!1)};this.localDevice.addObserver(e),this.device.addObserver(e)}{let e=()=>{let e=this.localDevice.getState(),t=this.device.getState();return W(e)&&W(t)&&e.id!==t.id?this.isDeviceRemote.updateState(!0):this.isDeviceRemote.updateState(!1)};this.localDevice.addObserver(e),this.device.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.currentIndex.getState();if(W(e)&&W(t)){let r=t-1;if(r>=0&&r<e.length)return this.lastIndex.updateState(r)}return this.lastIndex.updateState(void 0)};this.flattenedContext.addObserver(e),this.currentIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.currentIndex.getState();if(W(e)&&W(t)){let r=t+1;if(r>=0&&r<e.length)return this.nextIndex.updateState(r)}return this.nextIndex.updateState(void 0)};this.flattenedContext.addObserver(e),this.currentIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.lastIndex.getState();return W(e)&&W(t)?this.lastEntry.updateState(e[t]):this.lastEntry.updateState(void 0)};this.flattenedContext.addObserver(e),this.lastIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.currentIndex.getState();return W(e)&&W(t)&&t>=0&&t+0<e.length?this.currentEntry.updateState(e[t+0]):this.currentEntry.updateState(void 0)};this.flattenedContext.addObserver(e),this.currentIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.nextIndex.getState();return W(e)&&W(t)?this.nextEntry.updateState(e[t]):this.nextEntry.updateState(void 0)};this.flattenedContext.addObserver(e),this.nextIndex.addObserver(e)}this.token.addObserver((e=>{this.tsc.send("SetToken",{token:e})})),this.tsc.addEventListener("app","SetLocalDevice",(e=>{this.localDevice.updateState(e.device)})),this.tsc.addEventListener("app","SetDevices",(e=>{this.devices.update(e.devices)})),this.tsc.addEventListener("app","SetContext",(e=>{this.context.updateState(e.context)})),this.tsc.addEventListener("app","SetDevice",(e=>{this.device.updateState(e.device)})),this.tsc.addEventListener("app","SetIndex",(e=>{this.currentIndex.updateState(e.index)})),this.tsc.addEventListener("app","SetPlayback",(e=>{this.playback.updateState(e.playback)})),this.tsc.addEventListener("app","SetProgress",(e=>{this.progress.updateState(e.progress)})),this.tsc.addEventListener("app","SetToken",(e=>{this.token.updateState(e.token)})),this.isOnline.addObserver((e=>{e||(this.context.updateState(void 0),this.currentIndex.updateState(void 0),this.playback.updateState(!1),this.progress.updateState(void 0))})),function(e,...t){let r=new $i(e(...t.map((e=>e.getState())))),i=()=>{r.updateState(e(...t.map((e=>e.getState()))))};for(let e of t)e.addObserver(i)}(((e,t)=>{e&&this.tsc.send("SetToken",{token:t})}),this.isOnline,this.token)}play(e,t){this.tsc.send("SetContext",{context:e}),this.tsc.send("SetIndex",{index:t}),this.tsc.send("SetPlayback",{playback:!0})}authenticate(e){this.token.updateState(e)}close(){this.tsc.close()}last(){let e=this.lastIndex.getState();W(e)?(this.currentIndex.updateState(e),this.tsc.send("SetIndex",{index:e})):this.pause()}next(){let e=this.nextIndex.getState();W(e)?(this.currentIndex.updateState(e),this.tsc.send("SetIndex",{index:e})):this.pause()}pause(){this.playback.updateState(!1),this.tsc.send("SetPlayback",{playback:!1})}playAlbum(e,t,r){let i=0;if(W(t)){let n=e.discs;if(t<0||t>=n.length)throw`Expected ${t} to be a number between 0 and ${n.length}!`;if(i+=n.slice(0,t).reduce(((e,t)=>e+t.tracks.length),0),W(r)){let e=n[t].tracks;if(r<0||r>=e.length)throw`Expected ${r} to be a number between 0 and ${e.length}!`;i+=r}}return this.play(e,i)}playArtist(e,t,r,i){let n=0;if(W(t)){let s=e.albums;if(t<0||t>=s.length)throw`Expected ${t} to be a number between 0 and ${s.length}!`;if(n+=s.slice(0,t).reduce(((e,t)=>e+t.discs.reduce(((e,t)=>e+t.tracks.length),0)),0),W(r)){let e=s[t].discs;if(r<0||r>=e.length)throw`Expected ${r} to be a number between 0 and ${e.length}!`;if(n+=e.slice(0,r).reduce(((e,t)=>e+t.tracks.length),0),W(i)){let t=e[r].tracks;if(i<0||i>=t.length)throw`Expected ${i} to be a number between 0 and ${t.length}!`;n+=i}}}return this.play(e,n)}playDisc(e,t){let r=0;if(W(t)){let i=e.tracks;if(t<0||t>=i.length)throw`Expected ${t} to be a number between 0 and ${i.length}!`;r+=t}return this.play(e,r)}playEpisode(e){this.play(e,0)}playMovie(e){this.play(e,0)}playPlaylist(e,t){let r=0;if(W(t)){let i=e.items;if(t<0||t>=i.length)throw`Expected ${t} to be a number between 0 and ${i.length}!`;r+=t}return this.play(e,r)}playSeason(e,t){let r=0;if(W(t)){let i=e.episodes;if(t<0||t>=i.length)throw`Expected ${t} to be a number between 0 and ${i.length}!`;r+=t}return this.play(e,r)}playShow(e,t,r){let i=0;if(W(t)){let n=e.seasons;if(t<0||t>=n.length)throw`Expected ${t} to be a number between 0 and ${n.length}!`;if(i+=n.slice(0,t).reduce(((e,t)=>e+t.episodes.length),0),W(r)){let e=n[t].episodes;if(r<0||r>=e.length)throw`Expected ${r} to be a number between 0 and ${e.length}!`;i+=r}}return this.play(e,i)}playTrack(e){this.play(e,0)}reconnect(){this.tsc.reconnect()}resume(){this.canPlayCurrent.getState()&&(this.playback.updateState(!0),this.tsc.send("SetPlayback",{playback:!0}))}seek(e){this.tsc.send("SetProgress",{progress:e})}toggle(){this.playback.getState()?this.pause():this.resume()}transfer(e){this.tsc.send("SetDevice",{device:e})}}var ln=r(545);class an{constructor(e,t=!1){this.router=new z.routing.NamespacedMessageRouter,this.serializer=new l.m7.MessageSerializer(e),this.socket=new ln.u9,this.debug=t,this.socket.addEventListener("connect",(e=>{let t=e.connection_id,r=e.connection_url;this.router.route("sys","connect",{connection_id:t,connection_url:r})})),this.socket.addEventListener("disconnect",(e=>{let t=e.connection_id,r=e.connection_url;this.router.route("sys","disconnect",{connection_id:t,connection_url:r})})),this.socket.addEventListener("message",(e=>{let t=e.connection_id,r=e.connection_url,i=e.buffer.toString();this.serializer.deserialize(i,((e,i)=>{this.debug&&console.log(`${t} -> ${e}`),this.router.route("sys","message",{connection_id:t,connection_url:r,type:e,data:i}),this.router.route("app",e,{connection_id:t,connection_url:r,data:i})}))}))}addEventListener(e,t,r){this.router.addObserver(e,t,r)}broadcast(e,t){let r=this.serializer.serialize(e,t);this.socket.broadcast(r)}close(e){this.socket.close(e)}getRequestHandler(){return this.socket.getRequestHandler()}removeEventListener(e,t,r){this.router.addObserver(e,t,r)}send(e,t,r){let i=this.serializer.serialize(e,r);for(let r of Array.isArray(t)?t:[t]){this.debug&&console.log(`${r} <- ${e}`);try{this.socket.send(r,i)}catch(e){}}}}function dn(e,t){var r;let i=null!==(r=e.query[t])&&void 0!==r?r:[];return Array.isArray(i)?i:[i]}function un(e,t){var r,i;let n=o.parse(t,!0);return{id:e,name:null!==(r=dn(n,"name").pop())&&void 0!==r?r:"",type:null!==(i=dn(n,"type").pop())&&void 0!==i?i:""}}var cn,fn,pn,hn=r(16);function mn(e){if(e>Number.MAX_SAFE_INTEGER||e<Number.MIN_SAFE_INTEGER)throw`Expected a safe integer but got ${e}!`;return Number(e)}function gn(e,t){let r=e.buffer.length-e.offset;if(t>r)throw`Expected to read at most ${r} bytes but attempted to read ${t} bytes!`;let i=e.buffer.slice(e.offset,e.offset+t);return e.offset+=t,i}function yn(e){let t=Buffer.alloc(10);for(let r=0;r<10;r++){let i=e.buffer.readUInt8(e.offset);if(e.offset+=1,t[r]=i,0==(128&i)){if(r+1===10&&0!=(126&i))throw"Expected a varint of at most 64 bits!";let e=BigInt(0);for(let i=r;i>=0;i--)e=e<<BigInt(7)|BigInt(127&t[i]);let n=Buffer.alloc(8);return n.writeBigUInt64LE(e,0),n}}throw"Expected a varint of at most 10 bytes!"}function bn(e){let t=e.readBigUInt64LE(0),r=Buffer.alloc(10);for(let e=0;e<10;e++){let i=t&BigInt(127);if(t>>=BigInt(7),!(t>0))return r.writeUInt8(0|mn(i),e),r.slice(0,e+1);r.writeUInt8(128|mn(i),e)}throw"Expected to serialize at most 10 bytes!"}function _n(e){let t=BigInt(e.field_number)<<BigInt(3)|BigInt(e.wire_type)&BigInt(7),r=Buffer.alloc(8);return r.writeBigUInt64LE(t,0),bn(r)}function vn(e){let t=function(e){let t=yn(e).readBigUInt64LE(0);return{field_number:mn(t>>BigInt(3)),wire_type:mn(t&BigInt(7))}}(e);if(t.wire_type===cn.VARINT)return{key:t,data:yn(e)};if(t.wire_type===cn.FIXED_64_BIT)return{key:t,data:gn(e,8)};if(t.wire_type===cn.LENGTH_DELIMITED)return{key:t,data:gn(e,mn(yn(e).readBigUInt64LE(0)))};if(t.wire_type===cn.START_GROUP)return{key:t,data:Buffer.alloc(0)};if(t.wire_type===cn.END_GROUP)return{key:t,data:Buffer.alloc(0)};if(t.wire_type===cn.FIXED_32_BIT)return{key:t,data:gn(e,4)};throw"Expected a recognized wire type!"}function Sn(e){if(e.key.wire_type===cn.VARINT)return Buffer.concat([_n(e.key),bn(e.data)]);if(e.key.wire_type===cn.FIXED_64_BIT){if(8!==e.data.length)throw"Expected to serialize exactly 8 bytes!";return Buffer.concat([_n(e.key),e.data])}if(e.key.wire_type===cn.LENGTH_DELIMITED){let t=Buffer.alloc(8);return t.writeBigUInt64LE(BigInt(e.data.length)),Buffer.concat([_n(e.key),bn(t),e.data])}if(e.key.wire_type===cn.START_GROUP){if(0!==e.data.length)throw"Expected to serialize exactly 0 bytes!";return Buffer.concat([_n(e.key),e.data])}if(e.key.wire_type===cn.END_GROUP){if(0!==e.data.length)throw"Expected to serialize exactly 0 bytes!";return Buffer.concat([_n(e.key),e.data])}if(e.key.wire_type===cn.FIXED_32_BIT){if(4!==e.data.length)throw"Expected to serialize exactly 4 bytes!";return Buffer.concat([_n(e.key),e.data])}throw"Expected a recognized wire type!"}function wn(e,t){let r=t.filter((t=>t.key.field_number===e));if(0===r.length)throw"Expected required field to be present!";return mn(r[r.length-1].data.readBigUInt64LE(0))}function On(e,t){return Sn({key:{field_number:e,wire_type:cn.VARINT},data:function(e){let t=Buffer.alloc(8);return t.writeBigUInt64LE(BigInt(e)),t}(t)})}function En(e,t){let r=t.filter((t=>t.key.field_number===e));if(0===r.length)throw"Expected required field to be present!";return r[r.length-1].data.toString()}function kn(e,t){return Sn({key:{field_number:e,wire_type:cn.LENGTH_DELIMITED},data:Buffer.from(t)})}function In(e,t){return null==t?Buffer.alloc(0):function(e,t){return Sn({key:{field_number:e,wire_type:cn.LENGTH_DELIMITED},data:t})}(e,t)}!function(e){e[e.VARINT=0]="VARINT",e[e.FIXED_64_BIT=1]="FIXED_64_BIT",e[e.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",e[e.START_GROUP=3]="START_GROUP",e[e.END_GROUP=4]="END_GROUP",e[e.FIXED_32_BIT=5]="FIXED_32_BIT"}(cn||(cn={})),function(e){e[e.CASTV2_1_0=0]="CASTV2_1_0"}(fn||(fn={})),function(e){e[e.STRING=0]="STRING",e[e.BINARY=1]="BINARY"}(pn||(pn={}));const Rn=require("dgram");var Tn=function(e,t,r,i){return new(r||(r=Promise))((function(n,s){function o(e){try{a(i.next(e))}catch(e){s(e)}}function l(e){try{a(i.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,l)}a((i=i.apply(e,t||[])).next())}))};let xn={},Un={},Nn=(e,t)=>{let r=Un[e];if(void 0!==r)for(let e of r)e(t);let i=xn[e];void 0!==i&&Nn(i,t)},jn=(e,t,r)=>{xn[t]=e,"A"===r&&Nn(e,t)},An=(e,t)=>Tn(void 0,void 0,void 0,(function*(){let r=new Array;for(;;){let i=e.readUInt8(t);if(0===i){t+=1;break}if(i<64){t+=1;let n=e.slice(t,t+i);t+=i,r.push(n.toString("binary"));continue}if(i<192)throw new Error;let n=yield An(e,16383&e.readUInt16BE(t));r.push(n.value),t+=2;break}return{value:r.join("."),offset:t}})),Cn=(e,t)=>Tn(void 0,void 0,void 0,(function*(){let r=yield An(e,t);return t=r.offset,e.readUInt16BE(t),t+=2,e.readUInt16BE(t),t+=2,{value:r.value,offset:t}})),Ln=(e,t)=>Tn(void 0,void 0,void 0,(function*(){let r=yield An(e,t);t=r.offset;let i=e.readUInt16BE(t);t+=2,e.readUInt16BE(t),t+=2,e.readUInt32BE(t),t+=4;let n=e.readUInt16BE(t);t+=2;let s="";if(1===i&&(s=`${e[t+0]}.${e[t+1]}.${e[t+2]}.${e[t+3]}`,t+=4,jn(r.value,s,"A")),12===i){let i=yield An(e,t);t=i.offset,s=i.value,jn(r.value,s,"PTR")}if(16===i){let r=e.slice(t,t+n);t+=n,s=r.toString("binary")}if(33===i){e.readUInt16BE(t),t+=2,e.readUInt16BE(t),t+=2,e.readUInt16BE(t),t+=2;let i=yield An(e,t);t=i.offset,s=i.value,jn(r.value,s,"SRV")}return{name:r.value,data:s,offset:t}}));const Bn="224.0.0.251";let Dn=Rn.createSocket({type:"udp4",reuseAddr:!0});Dn.on("listening",(()=>{Dn.setMulticastLoopback(!1),Dn.addMembership(Bn,"0.0.0.0")})),Dn.on("message",((e,t)=>Tn(void 0,void 0,void 0,(function*(){try{yield(e=>Tn(void 0,void 0,void 0,(function*(){let t=0,r=e.slice(t,t+12);t+=12,r.readUInt16BE(0),r.readUInt16BE(2);let i=r.readUInt16BE(4),n=r.readUInt16BE(6),s=r.readUInt16BE(8),o=r.readUInt16BE(10),l=new Array;for(let r=0;r<i;r++){let r=yield Cn(e,t);l.push(r),t=r.offset}let a=new Array;for(let r=0;r<n;r++){let r=yield Ln(e,t);a.push(r),t=r.offset}let d=new Array;for(let r=0;r<s;r++){let r=yield Ln(e,t);d.push(r),t=r.offset}let u=new Array;for(let r=0;r<o;r++){let r=yield Ln(e,t);u.push(r),t=r.offset}})))(e)}catch(e){}})))),Dn.bind(5353);const Pn={CONNECT:l.l8.Object.of({type:l.l8.StringLiteral.of("CONNECT")}),CLOSE:l.l8.Object.of({type:l.l8.StringLiteral.of("CLOSE")})},Hn={PING:l.l8.Object.of({type:l.l8.StringLiteral.of("PING")}),PONG:l.l8.Object.of({type:l.l8.StringLiteral.of("PONG")})},qn=l.l8.Object.of({url:l.l8.String,height:l.l8.Union.of(l.l8.Undefined,l.l8.Number),width:l.l8.Union.of(l.l8.Undefined,l.l8.Number)}),Fn=l.l8.Object.of({level:l.l8.Union.of(l.l8.Undefined,l.l8.Number),muted:l.l8.Union.of(l.l8.Undefined,l.l8.Boolean)}),Mn=l.l8.Object.of({contentId:l.l8.String,streamType:l.l8.Union.of(l.l8.StringLiteral.of("NONE"),l.l8.StringLiteral.of("BUFFERED"),l.l8.StringLiteral.of("LIVE")),contentType:l.l8.String,metadata:l.l8.Union.of(l.l8.Undefined,l.l8.Union.of(l.l8.Reference.of((()=>$n)),l.l8.Reference.of((()=>Gn)),l.l8.Reference.of((()=>zn)),l.l8.Reference.of((()=>Jn)),l.l8.Reference.of((()=>Wn)))),duration:l.l8.Union.of(l.l8.Undefined,l.l8.Number),customData:l.l8.Union.of(l.l8.Undefined,l.l8.Record.of(l.l8.Any)),tracks:l.l8.Union.of(l.l8.Undefined,l.l8.Array.of(l.l8.Union.of(l.l8.Object.of({trackId:l.l8.Number,type:l.l8.String}),l.l8.Object.of({trackId:l.l8.Number,type:l.l8.StringLiteral.of("TEXT"),trackType:l.l8.StringLiteral.of("TEXT"),trackContentId:l.l8.String,trackContentType:l.l8.String,subtype:l.l8.StringLiteral.of("SUBTITLES"),language:l.l8.String,name:l.l8.Union.of(l.l8.Undefined,l.l8.String),customData:l.l8.Union.of(l.l8.Undefined,l.l8.Record.of(l.l8.Any))}))))}),$n=l.l8.Object.of({metadataType:l.l8.NumberLiteral.of(0),title:l.l8.Union.of(l.l8.Undefined,l.l8.String),subtitle:l.l8.Union.of(l.l8.Undefined,l.l8.String),images:l.l8.Union.of(l.l8.Undefined,l.l8.Array.of(l.l8.Reference.of((()=>qn)))),releaseDate:l.l8.Union.of(l.l8.Undefined,l.l8.String)}),Gn=l.l8.Object.of({metadataType:l.l8.NumberLiteral.of(1),title:l.l8.Union.of(l.l8.Undefined,l.l8.String),subtitle:l.l8.Union.of(l.l8.Undefined,l.l8.String),studio:l.l8.Union.of(l.l8.Undefined,l.l8.String),images:l.l8.Union.of(l.l8.Undefined,l.l8.Array.of(l.l8.Reference.of((()=>qn)))),releaseDate:l.l8.Union.of(l.l8.Undefined,l.l8.String)}),zn=l.l8.Object.of({metadataType:l.l8.NumberLiteral.of(2),seriesTitle:l.l8.Union.of(l.l8.Undefined,l.l8.String),subtitle:l.l8.Union.of(l.l8.Undefined,l.l8.String),season:l.l8.Union.of(l.l8.Undefined,l.l8.Number),episode:l.l8.Union.of(l.l8.Undefined,l.l8.Number),images:l.l8.Union.of(l.l8.Undefined,l.l8.Array.of(l.l8.Reference.of((()=>qn)))),originalAirDate:l.l8.Union.of(l.l8.Undefined,l.l8.String)}),Jn=l.l8.Object.of({metadataType:l.l8.NumberLiteral.of(3),albumName:l.l8.Union.of(l.l8.Undefined,l.l8.String),title:l.l8.Union.of(l.l8.Undefined,l.l8.String),albumArtist:l.l8.Union.of(l.l8.Undefined,l.l8.String),artist:l.l8.Union.of(l.l8.Undefined,l.l8.String),composer:l.l8.Union.of(l.l8.Undefined,l.l8.String),trackNumber:l.l8.Union.of(l.l8.Undefined,l.l8.Number),discNumber:l.l8.Union.of(l.l8.Undefined,l.l8.Number),images:l.l8.Union.of(l.l8.Undefined,l.l8.Array.of(l.l8.Reference.of((()=>qn)))),releaseDate:l.l8.Union.of(l.l8.Undefined,l.l8.String)}),Wn=l.l8.Object.of({metadataType:l.l8.NumberLiteral.of(4),title:l.l8.Union.of(l.l8.Undefined,l.l8.String),artist:l.l8.Union.of(l.l8.Undefined,l.l8.String),location:l.l8.Union.of(l.l8.Undefined,l.l8.String),latitude:l.l8.Union.of(l.l8.Undefined,l.l8.Number),longitude:l.l8.Union.of(l.l8.Undefined,l.l8.Number),width:l.l8.Union.of(l.l8.Undefined,l.l8.Number),height:l.l8.Union.of(l.l8.Undefined,l.l8.Number),creationDateTime:l.l8.Union.of(l.l8.Undefined,l.l8.String)}),Vn=l.l8.Object.of({mediaSessionId:l.l8.Number,media:l.l8.Union.of(l.l8.Undefined,l.l8.Union.of(l.l8.Reference.of((()=>Mn)),l.l8.Object.of({}))),playbackRate:l.l8.Number,playerState:l.l8.Union.of(l.l8.StringLiteral.of("IDLE"),l.l8.StringLiteral.of("PLAYING"),l.l8.StringLiteral.of("BUFFERING"),l.l8.StringLiteral.of("PAUSED")),idleReason:l.l8.Union.of(l.l8.Undefined,l.l8.Union.of(l.l8.StringLiteral.of("CANCELLED"),l.l8.StringLiteral.of("INTERRUPTED"),l.l8.StringLiteral.of("FINISHED"),l.l8.StringLiteral.of("ERROR"))),currentTime:l.l8.Number,supportedMediaCommands:l.l8.Number,volume:l.l8.Reference.of((()=>Fn)),customData:l.l8.Union.of(l.l8.Undefined,l.l8.Record.of(l.l8.Any))}),Xn=l.l8.Object.of({requestId:l.l8.Number,type:l.l8.StringLiteral.of("LOAD"),media:l.l8.Reference.of((()=>Mn)),autoplay:l.l8.Union.of(l.l8.Undefined,l.l8.Boolean),currentTime:l.l8.Union.of(l.l8.Undefined,l.l8.Number),customData:l.l8.Union.of(l.l8.Undefined,l.l8.Record.of(l.l8.Any)),activeTrackIds:l.l8.Union.of(l.l8.Undefined,l.l8.Array.of(l.l8.Number))}),Yn=l.l8.Object.of({mediaSessionId:l.l8.Number,requestId:l.l8.Number,type:l.l8.StringLiteral.of("PAUSE"),customData:l.l8.Union.of(l.l8.Undefined,l.l8.Record.of(l.l8.Any))}),Kn=l.l8.Object.of({mediaSessionId:l.l8.Number,requestId:l.l8.Number,type:l.l8.StringLiteral.of("SEEK"),resumeState:l.l8.Union.of(l.l8.Undefined,l.l8.Union.of(l.l8.StringLiteral.of("PLAYBACK_START"),l.l8.StringLiteral.of("PLAYBACK_PAUSE"))),currentTime:l.l8.Union.of(l.l8.Undefined,l.l8.Number),customData:l.l8.Union.of(l.l8.Undefined,l.l8.Record.of(l.l8.Any))}),Qn=l.l8.Object.of({mediaSessionId:l.l8.Number,requestId:l.l8.Number,type:l.l8.StringLiteral.of("STOP"),customData:l.l8.Union.of(l.l8.Undefined,l.l8.Record.of(l.l8.Any))}),Zn=l.l8.Object.of({mediaSessionId:l.l8.Number,requestId:l.l8.Number,type:l.l8.StringLiteral.of("PLAY"),customData:l.l8.Union.of(l.l8.Undefined,l.l8.Record.of(l.l8.Any))}),es=l.l8.Object.of({mediaSessionId:l.l8.Union.of(l.l8.Undefined,l.l8.Number),requestId:l.l8.Number,type:l.l8.StringLiteral.of("GET_STATUS"),customData:l.l8.Union.of(l.l8.Undefined,l.l8.Record.of(l.l8.Any))}),ts=l.l8.Object.of({mediaSessionId:l.l8.Number,requestId:l.l8.Number,type:l.l8.StringLiteral.of("VOLUME"),volume:l.l8.Reference.of((()=>Fn)),customData:l.l8.Union.of(l.l8.Undefined,l.l8.Record.of(l.l8.Any))}),rs=l.l8.Object.of({requestId:l.l8.Number,type:l.l8.StringLiteral.of("INVALID_PLAYER_STATE"),customData:l.l8.Union.of(l.l8.Undefined,l.l8.Record.of(l.l8.Any))}),is=l.l8.Object.of({requestId:l.l8.Number,type:l.l8.StringLiteral.of("LOAD_FAILED"),customData:l.l8.Union.of(l.l8.Undefined,l.l8.Record.of(l.l8.Any))}),ns=l.l8.Object.of({requestId:l.l8.Number,type:l.l8.StringLiteral.of("LOAD_CANCELLED"),customData:l.l8.Union.of(l.l8.Undefined,l.l8.Record.of(l.l8.Any))}),ss=l.l8.Object.of({requestId:l.l8.Number,type:l.l8.StringLiteral.of("INVALID_REQUEST"),reason:l.l8.Union.of(l.l8.StringLiteral.of("INVALID_COMMAND"),l.l8.StringLiteral.of("DUPLICATE_REQUESTID")),customData:l.l8.Union.of(l.l8.Undefined,l.l8.Record.of(l.l8.Any))}),os=l.l8.Object.of({requestId:l.l8.Number,type:l.l8.StringLiteral.of("MEDIA_STATUS"),status:l.l8.Array.of(l.l8.Reference.of((()=>Vn))),customData:l.l8.Union.of(l.l8.Undefined,l.l8.Record.of(l.l8.Any))}),ls={LOAD:Xn,PAUSE:Yn,SEEK:Kn,STOP:Qn,PLAY:Zn,GET_STATUS:es,VOLUME:ts,INVALID_PLAYER_STATE:rs,LOAD_FAILED:is,LOAD_CANCELLED:ns,INVALID_REQUEST:ss,MEDIA_STATUS:os},as={LAUNCH:l.l8.Object.of({type:l.l8.StringLiteral.of("LAUNCH"),requestId:l.l8.Number,appId:l.l8.String}),STOP:l.l8.Object.of({type:l.l8.StringLiteral.of("STOP"),requestId:l.l8.Number,sessionId:l.l8.String}),GET_STATUS:l.l8.Object.of({type:l.l8.StringLiteral.of("GET_STATUS"),requestId:l.l8.Number}),GET_APP_AVAILABILITY:l.l8.Object.of({type:l.l8.StringLiteral.of("GET_APP_AVAILABILITY"),requestId:l.l8.Number,appId:l.l8.Array.of(l.l8.String)}),SET_VOLUME:l.l8.Object.of({type:l.l8.StringLiteral.of("SET_VOLUME"),requestId:l.l8.Number,volume:l.l8.Union.of(l.l8.Object.of({level:l.l8.Number}),l.l8.Object.of({muted:l.l8.Boolean}))}),RECEIVER_STATUS:l.l8.Object.of({type:l.l8.StringLiteral.of("RECEIVER_STATUS"),requestId:l.l8.Number,status:l.l8.Object.of({applications:l.l8.Union.of(l.l8.Undefined,l.l8.Array.of(l.l8.Object.of({appId:l.l8.String,displayName:l.l8.String,iconUrl:l.l8.String,isIdleScreen:l.l8.Boolean,launchedFromCloud:l.l8.Boolean,namespaces:l.l8.Array.of(l.l8.Object.of({name:l.l8.String})),sessionId:l.l8.String,statusText:l.l8.String,transportId:l.l8.String}))),userEq:l.l8.Object.of({}),volume:l.l8.Object.of({controlType:l.l8.String,level:l.l8.Number,muted:l.l8.Boolean,stepInterval:l.l8.Number})})})},ds={eng:{title:"English",iso639_1:"en",iso3166_1:"US"},swe:{title:"Swedish",iso639_1:"sv",iso3166_1:"SE"},jpn:{title:"Japanese",iso639_1:"ja",iso3166_1:"JP"}};const us="https://ap.joelek.se";function cs(e){var t;let r=null!==(t=ds[null!=e?e:"eng"])&&void 0!==t?t:ds.eng;return{language:[r.iso639_1,r.iso3166_1].join("-"),name:r.title}}const fs=new Set,ps=new Set;function hs(e){!function(e){if(!ps.has(e)){ps.add(e);for(let t of fs)try{e(t)}catch(e){}}}((t=>{return r=this,n=void 0,o=function*(){let r=yield function(e){return new Promise(((t,r)=>{let i=hn.connect({host:e,port:8009,rejectUnauthorized:!1});i.on("secureConnect",(()=>{console.log(`Connected to chromecast at ${e}.`),t(i)})),i.on("close",(()=>{console.log(`Disconnected from chromecast at ${e}.`)})),i.on("error",(e=>{i.end()}))}))}(t);r.on("close",(()=>{fs.delete(t)}));let n=yield function(e){return new Promise(((t,r)=>{i.get(`http://${e}:8008/ssdp/device-desc.xml`,(e=>{let i=[];e.on("data",(e=>{i.push(e)})),e.on("end",(()=>{let e=Buffer.concat(i).toString(),r=/<friendlyName>([^<]+)<\/friendlyName>/.exec(e);W(r)?t(r[1]):t(void 0)})),e.on("error",(()=>{r()}))}))}))}(t);new Ss(r,null!=n?n:"Chromecast",e)},new((s=void 0)||(s=Promise))((function(e,t){function i(e){try{a(o.next(e))}catch(e){t(e)}}function l(e){try{a(o.throw(e))}catch(e){t(e)}}function a(t){var r;t.done?e(t.value):(r=t.value,r instanceof s?r:new s((function(e){e(r)}))).then(i,l)}a((o=o.apply(r,n||[])).next())}));var r,n,s,o}))}((e,t)=>{let r=Un[e];void 0===r&&(r=new Array,Un[e]=r),r.push((e=>{if(!fs.has(e)){fs.add(e);for(let t of ps)try{t(e)}catch(e){}}})),(e=>{let t=Buffer.alloc(12);t.writeUInt16BE(1,4);let r=Buffer.alloc(1e3),i=0;e.split(".").forEach((e=>{if(e.length>=64)throw new Error;r.writeUInt8(e.length,i),i+=1,r.write(e,i),i+=e.length})),r.writeUInt8(0,i),i+=1,r.writeUInt16BE(12,i),i+=2,r.writeUInt16BE(1,i),i+=2,r=r.slice(0,0+i),Dn.send(Buffer.concat([t,r]),5353,Bn)})(e)})("_googlecast._tcp.local");class ms{constructor(e,t){this.socket=e,function(e,t){let r=Buffer.alloc(0),i=!0,n=4;e.on("data",(e=>{for(r=Buffer.concat([r,e]);r.length>=n;){let e=r.slice(0,n);r=r.slice(n),i?(i=!1,n=e.readUInt32BE(0)):(i=!0,n=4,t(e))}}))}(e,(e=>{try{let r=function(e){let t=function(e){let t=new Array;for(;e.offset<e.buffer.length;){let r=vn(e);t.push(r)}return t}({buffer:e,offset:0});return{protocol_version:wn(1,t),source_id:En(2,t),destination_id:En(3,t),namespace:En(4,t),payload_type:wn(5,t),payload_utf8:function(e,t){try{return En(6,t)}catch(e){return}}(0,t),payload_binary:function(e,t){try{return function(e,t){let r=t.filter((e=>7===e.key.field_number));if(0===r.length)throw"Expected required field to be present!";return r[r.length-1].data}(0,t)}catch(e){return}}(0,t)}}(e);t(r)}catch(e){console.log(e)}}))}getRequestId(){return Math.floor(65536*Math.random())}send(e){var t,r,i,n;let s=function(e){return Buffer.concat([On(1,e.protocol_version),kn(2,e.source_id),kn(3,e.destination_id),kn(4,e.namespace),On(5,e.payload_type),(6,t=e.payload_utf8,null==t?Buffer.alloc(0):kn(6,t)),In(7,e.payload_binary)]);var t}({protocol_version:null!==(t=e.protocol_version)&&void 0!==t?t:fn.CASTV2_1_0,source_id:null!==(r=e.source_id)&&void 0!==r?r:"sender-0",destination_id:null!==(i=e.destination_id)&&void 0!==i?i:"receiver-0",namespace:e.namespace,payload_type:null!==(n=e.payload_type)&&void 0!==n?n:pn.STRING,payload_utf8:e.payload_utf8,payload_binary:e.payload_binary}),o=Buffer.alloc(4);o.writeUInt32BE(s.length,0),this.socket.write(o),this.socket.write(s)}}class gs{constructor(e){this.messageHandler=e,this.serializer=new l.m7.MessageSerializer(Pn),this.listeners=new z.routing.MessageRouter}handle(e){var t;let r=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),i=l.l8.String.as(r.type);this.serializer.deserialize(JSON.stringify({type:i,data:r}),((e,t)=>{this.listeners.route(e,t)}))}send(e,t,r){this.messageHandler.send({namespace:gs.NAMESPACE,destination_id:r,payload_utf8:JSON.stringify(t)})}}gs.NAMESPACE="urn:x-cast:com.google.cast.tp.connection";class ys{constructor(e){this.messageHandler=e,this.serializer=new l.m7.MessageSerializer(Hn),this.listeners=new z.routing.MessageRouter}handle(e){var t;let r=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),i=l.l8.String.as(r.type);this.serializer.deserialize(JSON.stringify({type:i,data:r}),((e,t)=>{this.listeners.route(e,t)}))}send(e,t){this.messageHandler.send({namespace:ys.NAMESPACE,payload_utf8:JSON.stringify(t)})}}ys.NAMESPACE="urn:x-cast:com.google.cast.tp.heartbeat";class bs{constructor(e){this.transportId=new $i(void 0),this.mediaSessionId=new $i(void 0),this.messageHandler=e,this.serializer=new l.m7.MessageSerializer(ls),this.callbacks=new Map,this.listeners=new z.routing.MessageRouter}handle(e){var t;let r=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),i=l.l8.String.as(r.type);try{this.serializer.deserialize(JSON.stringify({type:i,data:r}),((e,t)=>{let r=this.callbacks.get(t.requestId);W(r)&&(this.callbacks.delete(t.requestId),r(t)),this.listeners.route(e,t)}))}catch(e){console.log(JSON.stringify(r,null,2))}}send(e,t,r){t.requestId=this.messageHandler.getRequestId(),W(r)&&this.callbacks.set(t.requestId,r),this.messageHandler.send({namespace:bs.NAMESPACE,destination_id:this.transportId.getState(),payload_utf8:JSON.stringify(t)})}}bs.NAMESPACE="urn:x-cast:com.google.cast.media";class _s{constructor(e){this.messageHandler=e,this.serializer=new l.m7.MessageSerializer(as),this.callbacks=new Map,this.listeners=new z.routing.MessageRouter}handle(e){var t;let r=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),i=l.l8.String.as(r.type);this.serializer.deserialize(JSON.stringify({type:i,data:r}),((e,t)=>{let r=this.callbacks.get(t.requestId);W(r)&&(this.callbacks.delete(t.requestId),r(t)),this.listeners.route(e,t)}))}send(e,t,r){t.requestId=this.messageHandler.getRequestId(),W(r)&&this.callbacks.set(t.requestId,r),this.messageHandler.send({namespace:_s.NAMESPACE,payload_utf8:JSON.stringify(t)})}}_s.NAMESPACE="urn:x-cast:com.google.cast.receiver";const vs="CC1AD845";class Ss{constructor(e,t,r){let i=new ms(e,(e=>{let t=e.namespace;t===gs.NAMESPACE?this.connectionHandler.handle(e):t===ys.NAMESPACE?this.heartbeatHandler.handle(e):t===bs.NAMESPACE?this.mediaHandler.handle(e):t===_s.NAMESPACE&&this.receiverHandler.handle(e)}));this.socket=e,this.heartbeatHandler=new ys(i),this.connectionHandler=new gs(i),this.mediaHandler=new bs(i),this.receiverHandler=new _s(i);let n=`${r?"wss:":"ws:"}//127.0.0.1/sockets/context/?type=chromecast&name=${t}`;this.context=new on(n,(e=>new ln.yU(e))),this.timer=void 0,e.on("close",(()=>{W(this.timer)&&clearTimeout(this.timer),this.context.close()})),this.connectionHandler.send("CONNECT",{type:"CONNECT"}),this.connectionHandler.listeners.addObserver("CLOSE",(e=>{this.mediaHandler.transportId.updateState(void 0)})),this.heartbeatHandler.listeners.addObserver("PING",(e=>{this.heartbeatHandler.send("PONG",{type:"PONG"})})),this.heartbeatHandler.listeners.addObserver("PONG",(e=>{this.setTimer()})),this.receiverHandler.listeners.addObserver("RECEIVER_STATUS",(e=>{var t;let r=(null!==(t=e.status.applications)&&void 0!==t?t:[]).find((e=>e.appId===vs));W(r)?this.mediaHandler.transportId.updateState(r.transportId):this.mediaHandler.transportId.updateState(void 0)})),this.mediaHandler.listeners.addObserver("MEDIA_STATUS",(e=>{let t=e.status[e.status.length-1];if(W(t)){let e=this.mediaHandler.mediaSessionId.getState();W(e)&&(t.mediaSessionId===e?this.context.isDeviceLocal.getState()&&"IDLE"===t.playerState&&"FINISHED"===t.idleReason&&this.context.next():this.mediaHandler.mediaSessionId.updateState(void 0))}})),this.setTimer(),this.mediaHandler.transportId.addObserver((e=>{W(e)&&this.connectionHandler.send("CONNECT",{type:"CONNECT"},e)})),this.context.isDeviceLocal.addObserver((e=>{if(e)J(this.mediaHandler.transportId.getState())&&this.receiverHandler.send("LAUNCH",{type:"LAUNCH",requestId:-1,appId:vs});else{let e=this.mediaHandler.mediaSessionId.getState();W(e)&&this.mediaHandler.send("STOP",{type:"STOP",requestId:-1,mediaSessionId:e})}}));{let e=()=>{let e=this.mediaHandler.transportId.getState(),t=this.context.currentLocalEntry.getState(),r=this.context.token.getState();if(W(e)&&W(t)&&W(r)){let e,i=function(e,t){if(bi.is(e)){let r=e,i=r.season.show;return{contentId:`${us}/files/${e.media.file_id}/?token=${t}`,contentType:r.media.mime,streamType:"BUFFERED",metadata:{metadataType:0,title:r.title,subtitle:i.title},tracks:r.subtitles.map(((e,r)=>Object.assign(Object.assign({},cs(e.language)),{trackId:r,type:"TEXT",trackType:"TEXT",trackContentId:`${us}/files/${e.file_id}/?token=${t}`,trackContentType:e.mime,subtype:"SUBTITLES"})))}}if(fi.is(e)){let r=e;return{contentId:`${us}/files/${e.media.file_id}/?token=${t}`,contentType:r.media.mime,streamType:"BUFFERED",metadata:{metadataType:0,title:r.title,images:r.artwork.map((e=>({url:`${us}/files/${e.file_id}/?token=${t}`})))},tracks:r.subtitles.map(((e,r)=>Object.assign(Object.assign({},cs(e.language)),{trackId:r,type:"TEXT",trackType:"TEXT",trackContentId:`${us}/files/${e.file_id}/?token=${t}`,trackContentType:e.mime,subtype:"SUBTITLES"})))}}if(ri.is(e)){let r=e,i=r.disc.album;return{contentId:`${us}/files/${e.media.file_id}/?token=${t}`,contentType:e.media.mime,streamType:"BUFFERED",metadata:{metadataType:0,title:r.title,subtitle:r.artists.map((e=>e.title)).join("  "),images:i.artwork.map((e=>({url:`${us}/files/${e.file_id}/?token=${t}`})))}}}throw"Expected code to be unreachable!"}(t,r);if(W(i.tracks)){let t=i.tracks.find((e=>"sv-SE"===e.language));if(W(t))e=[t.trackId];else{let t=i.tracks.find((e=>"en-US"===e.language));if(W(t))e=[t.trackId];else{let t=i.tracks.find((e=>"ja-JP"===e.language));W(t)?e=[t.trackId]:i.tracks.length>0&&(e=[0])}}}this.mediaHandler.send("LOAD",{type:"LOAD",requestId:-1,media:i,autoplay:!1,activeTrackIds:e},(e=>{if(os.is(e)){let t=e.status[e.status.length-1];W(t)&&this.mediaHandler.mediaSessionId.updateState(t.mediaSessionId)}}))}};this.mediaHandler.transportId.addObserver(e),this.context.currentLocalEntry.addObserver(e),this.context.token.addObserver(e)}this.mediaHandler.transportId.addObserver((e=>{J(e)&&this.context.isDeviceLocal.getState()&&this.context.transfer(void 0)})),this.mediaHandler.transportId.addObserver((e=>{J(e)&&this.mediaHandler.mediaSessionId.updateState(void 0)}));{let e=()=>{let e=this.mediaHandler.mediaSessionId.getState();W(e)&&(this.context.playback.getState()?this.mediaHandler.send("PLAY",{type:"PLAY",requestId:-1,mediaSessionId:e}):this.mediaHandler.send("PAUSE",{type:"PAUSE",requestId:-1,mediaSessionId:e}))};this.mediaHandler.mediaSessionId.addObserver(e),this.context.playback.addObserver(e)}{let e=()=>{var e;let t=this.mediaHandler.mediaSessionId.getState();if(W(t)){let r=null!==(e=this.context.progress.getState())&&void 0!==e?e:0;this.mediaHandler.send("SEEK",{type:"SEEK",requestId:-1,mediaSessionId:t,currentTime:r})}};this.mediaHandler.mediaSessionId.addObserver(e),this.context.progress.addObserver(e)}}setTimer(){W(this.timer)&&(clearTimeout(this.timer),this.timer=void 0),this.timer=setTimeout((()=>{this.timer=void 0,this.heartbeatHandler.send("PING",{type:"PING"}),this.timer=setTimeout((()=>{this.socket.destroy()}),5e3)}),5e3)}}const ws=new class{constructor(){this.tokens=new Map,this.sessions=new Map,this.chromecasts=new $i([]),this.tss=new an(rn),this.tss.addEventListener("sys","connect",(e=>{console.log("connect: "+e.connection_url);let t=un(e.connection_id,e.connection_url);this.tss.send("SetLocalDevice",e.connection_id,{device:t}),"chromecast"===t.type&&this.chromecasts.updateState([...this.chromecasts.getState(),t])})),this.tss.addEventListener("sys","disconnect",(e=>{console.log("disconnect: "+e.connection_url);let t=un(e.connection_id,e.connection_url);this.revokeAuthentication(e.connection_id),"chromecast"===t.type&&this.chromecasts.updateState(this.chromecasts.getState().filter((e=>e.id!==t.id)))})),this.tss.addEventListener("app","SetToken",(e=>{this.revokeAuthentication(e.connection_id);let t=e.data.token;if(W(t)){let r=cr(t);this.tokens.set(e.connection_id,t);let i=this.getSession(r),n=un(e.connection_id,e.connection_url);i.devices.updateState([...i.devices.getState(),n]),this.tss.send("SetContext",e.connection_id,{context:i.context}),this.tss.send("SetDevice",e.connection_id,{device:i.device}),this.tss.send("SetIndex",e.connection_id,{index:i.index}),this.tss.send("SetPlayback",e.connection_id,{playback:i.playback}),this.tss.send("SetProgress",e.connection_id,{progress:i.progress}),this.tss.send("SetToken",e.connection_id,{token:t})}})),this.tss.addEventListener("app","SetContext",(e=>{this.getExistingSession(e.connection_id,(t=>{J(t.device)&&(t.device=un(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),t.index=void 0,this.tss.send("SetIndex",t.devices.getState().map((e=>e.id)),{index:t.index}),t.context=e.data.context,this.tss.send("SetContext",t.devices.getState().map((e=>e.id)),e.data)}))})),this.tss.addEventListener("app","SetDevice",(e=>{this.getExistingSession(e.connection_id,(t=>{this.updateProgress(t),this.tss.send("SetProgress",t.devices.getState().map((e=>e.id)),{progress:t.progress}),t.device=e.data.device,this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),e.data),W(t.device)&&this.tss.send("SetToken",t.device.id,{token:this.tokens.get(e.connection_id)})}))})),this.tss.addEventListener("app","SetIndex",(e=>{this.getExistingSession(e.connection_id,(t=>{J(t.device)&&(t.device=un(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),t.progress=W(e.data.index)?0:void 0,t.progressTimestamp=Date.now(),this.tss.send("SetProgress",t.devices.getState().map((e=>e.id)),{progress:t.progress}),t.index=e.data.index,this.tss.send("SetIndex",t.devices.getState().map((e=>e.id)),e.data)}))})),this.tss.addEventListener("app","SetPlayback",(e=>{this.getExistingSession(e.connection_id,(t=>{J(t.device)&&(t.device=un(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),this.updateProgress(t),t.playback=e.data.playback,this.tss.send("SetPlayback",t.devices.getState().map((e=>e.id)),e.data)}))})),this.tss.addEventListener("app","SetProgress",(e=>{this.getExistingSession(e.connection_id,(t=>{J(t.device)&&(t.device=un(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),t.progress=e.data.progress,t.progressTimestamp=Date.now(),this.tss.send("SetProgress",t.devices.getState().map((e=>e.id)),e.data)}))}))}getExistingSession(e,t){let r=this.tokens.get(e);if(W(r)){let e=cr(r),i=this.sessions.get(e);W(i)&&t(i)}}getSession(e){let t=this.sessions.get(e);if(W(t))return t;const r={playback:!1,devices:new $i(new Array)};let i=new $i([]);{let e=()=>{let e=r.devices.getState(),t=this.chromecasts.getState().filter((t=>J(e.find((e=>e.id===t.id)))));i.updateState([...e,...t])};r.devices.addObserver(e),this.chromecasts.addObserver(e)}return i.addObserver((e=>{this.tss.send("SetDevices",r.devices.getState().map((e=>e.id)),{devices:e})})),r.devices.addObserver((e=>{this.updateProgress(r)})),r.devices.addObserver((e=>{J(e.find((e=>{var t;return e.id===(null===(t=r.device)||void 0===t?void 0:t.id)})))&&(this.updateProgress(r),r.playback=!1,this.tss.send("SetPlayback",e.map((e=>e.id)),{playback:r.playback}),r.device=void 0,this.tss.send("SetDevice",e.map((e=>e.id)),{device:r.device}))})),this.sessions.set(e,r),r}revokeAuthentication(e){let t=this.tokens.get(e);if(this.tokens.delete(e),W(t)){let r=cr(t),i=this.sessions.get(r);if(W(i)){let t=i.devices;t.updateState(t.getState().filter((t=>t.id!==e)))}}}updateProgress(e){let t=Date.now();e.playback&&W(e.progress)&&W(e.progressTimestamp)&&(e.progress+=(t-e.progressTimestamp)/1e3),e.progressTimestamp=t}getRequestHandler(){return this.tss.getRequestHandler()}};function Os(r,i){r.headers.host;let n=r.method||"",l=r.url||"";if(/^[/]sockets[/]/.test(l))return ws.getRequestHandler()(r,i);let a,d=Date.now();if(i.on("finish",(()=>{let e=Date.now()-d;process.stderr.write(`${i.statusCode} ${n}:${l} (${e} ms)\n`)})),"GET"===n&&"/favicon.ico"===l)return i.writeHead(404),void i.end();if("GET"===n&&null!==(a=/^[/]files[/]([0-9a-f]{32})[/]/.exec(l)))return((r,i,n)=>{if(void 0===i.url)throw new Error;let l="";try{var a=o.parse(i.url,!0);l=cr(a.query.token)}catch(e){return n.writeHead(401,{}),n.end()}let d=Ne.lookup(r),u=tr(d),c="application/octet-stream";try{c=Ae.lookup(d.file_id).mime}catch(e){}try{c=De.lookup(d.file_id).mime}catch(e){}let f,p=u.join(s.sep),h=t.openSync(p,"r"),m=t.fstatSync(h).size;t.closeSync(h);let g=i.headers.range;if(void 0!==g&&null!=(f=/^bytes\=((?:[0-9])|(?:[1-9][0-9]+))\-((?:[0-9])|(?:[1-9][0-9]+))?$/.exec(g))){let i=parseInt(f[1]),s=f[2]?parseInt(f[2]):null;if(null===s&&(s=m-1),i>=m||s>=m||s<i)return n.writeHead(416),void n.end();let o=s-i+1;n.writeHead(206,{"Access-Control-Allow-Origin":"*","Accept-Ranges":"bytes","Cache-Control":"private, max-age=86400","Content-Range":`bytes ${i}-${s}/${m}`,"Content-Type":c,"Content-Length":""+o}),(y=t.createReadStream(p,{start:i,end:s})).addListener("close",(()=>{if(i+y.bytesRead===m){let t=Date.now();Pt.insert({stream_id:e.randomBytes(16).toString("hex"),user_id:l,file_id:r,timestamp_ms:t})}})),y.on("open",(function(){y.pipe(n)})),y.on("error",(function(e){n.end()}))}else{var y;(y=t.createReadStream(p)).on("open",(function(){n.writeHead(200,{"Access-Control-Allow-Origin":"*","Accept-Ranges":"bytes","Cache-Control":"private, max-age=86400","Content-Type":c,"Content-Length":""+m}),y.pipe(n)})),y.on("error",(function(e){n.writeHead(404),n.end()}))}})(a[1],r,i);if(/^[/]media[/]/.test(l)){if(null!=(a=/^[/]media[/]stills[/]([0-9a-f]{32})[/]/.exec(l))){let e=a[1],r=[".","private","stills",Ne.lookup(e).file_id];if(!t.existsSync(r.join("/")))return i.writeHead(404),i.end();{let e=t.createReadStream(r.join("/"));e.on("open",(()=>{i.writeHead(200,{"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=86400","Content-Type":"image/jpeg"}),e.pipe(i)}))}return}if(null!=(a=/^[/]media[/]gifs[/]([0-9a-f]{32})[/]/.exec(l))){let e=a[1],r=At.lookup(e),n=[".","private","memes",r.cue_id];if(t.existsSync(n.join("/"))){let e=t.createReadStream(n.join("/"));e.on("open",(()=>{i.writeHead(200,{"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=86400","Content-Type":"image/gif"}),e.pipe(i)}))}else!function(e,t,r){let i=jt.lookup(t.subtitle_id),n=Ne.lookup(i.file_id);const s=function(e){let t=qe.lookup(e.file_id);return Ne.lookup(t[0].video_file_id)}(i);if(null==s)return r();Hi(((i,o)=>{let l=[...i,"subtitle.vtt"],a=[...i,"palette.png"],d=[...i,"meme.gif"],u=ki.spawn("ffmpeg",["-ss",Ri(t.start_ms),"-t",Ri(Math.min(t.duration_ms,5e3)),"-i",tr(n).join("/"),l.join("/"),"-y"]);u.on("error",(()=>(console.log("ffmpeg command failed!"),Fi(i.join("/")),r()))),u.on("exit",(()=>{ki.spawn("ffmpeg",["-ss",Ri(t.start_ms),"-t",Ri(Math.min(t.duration_ms,5e3)),"-i",tr(s).join("/"),"-vf","fps=15,scale=w=384:h=216:force_original_aspect_ratio=decrease,pad=384:216:-1:-1,subtitles="+l.join("/")+":force_style='Bold=1,Fontsize=24,Outline=2',palettegen",a.join("/"),"-y"]).on("exit",(()=>{ki.spawn("ffmpeg",["-ss",Ri(t.start_ms),"-t",Ri(Math.min(t.duration_ms,5e3)),"-i",tr(s).join("/"),"-i",a.join("/"),"-filter_complex","fps=15,scale=w=384:h=216:force_original_aspect_ratio=decrease,pad=384:216:-1:-1,subtitles="+l.join("/")+":force_style='Bold=1,Fontsize=24,Outline=2'[x];[x][1:v]paletteuse","-map_metadata","-1",d.join("/"),"-y"]).on("exit",(()=>(qi(d,e),Fi(i.join("/")),r())))}))}))}))}(n,r,(()=>{if(!t.existsSync(n.join("/")))return i.writeHead(500),i.end();let e=t.createReadStream(n.join("/"));e.on("open",(()=>{i.writeHead(200,{"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=86400","Content-Type":"image/gif"}),e.pipe(i)}))}));return}}return/^[/]api[/]/.test(l)?((e,t)=>{try{Ei.route(e,t)}catch(e){t.writeHead(500),t.end(JSON.stringify({error:""+e}))}})(r,i):"/manifest.json"===l?(i.writeHead(200,{"Content-Type":"application/json; charset=utf-8"}),i.end(JSON.stringify({name:"Orbit",start_url:"/",display:"standalone",theme_color:"#df4f7f",background_color:"#1f1f1f",icons:[]}))):"/logo.png"===l?(i.writeHead(200,{"Content-Type":"image/png"}),void t.createReadStream("./public/logo.png").pipe(i)):"GET"===n?(i.writeHead(200),void i.end(`<!doctype html><html><head><base href="/"/><meta charset="utf-8"/><meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0" name="viewport"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" /><link rel="apple-touch-icon" href="logo.png" /><link rel="manifest" href="/manifest.json"/><link href="https://fonts.googleapis.com/css2?family=Nunito&family=Pacifico&family=Space+Mono&display=swap" rel="stylesheet"/><title>Orbit</title></head><body><script>${t.readFileSync("./dist/client.min.js")}<\/script></body></html>`)):(console.log("unhandled",JSON.stringify(r.headers,null,"\t")),i.writeHead(400),void i.end())}function Es(e){if(t.existsSync(e))return t.readFileSync(e)}t.existsSync("./private/certs/")||t.mkdirSync("./private/certs/",{recursive:!0});let ks=Es("./private/certs/full_chain.pem"),Is=Es("./private/certs/dhparam.pem"),Rs=Es("./private/certs/certificate_key.pem");if(ks&&Rs){let e=n.createServer({cert:ks,dhparam:Is,key:Rs},Os);e.listen(443,(()=>{console.log("https://localhost:443")})),e.keepAliveTimeout=6e4,i.createServer({},((e,t)=>{let r=e.headers.host||"",i=e.url||"",n=r.split(":").shift();t.writeHead(307,{Location:"https://"+n+":443"+i}),t.end()})).listen(80,(()=>{console.log("http://localhost:80")})),hs(!0)}else{let e=i.createServer({},Os);e.listen(80,(()=>{console.log("http://localhost:80")})),e.keepAliveTimeout=6e4,hs(!1)}for(let e of Bt)console.log("Registration key available: "+e.key_id)})()})();